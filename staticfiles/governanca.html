{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Governan√ßa - Record PAP</title>
    <link rel="shortcut icon" href="{% static 'logo.png' %}" type="image/x-icon">
    <link rel="icon" type="image/png" href="{% static 'logo.png' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{% static 'css/custom_styles.css' %}?v=13.1">
    <style>
        /* Layout de Administra√ß√£o */
        body { overflow-x: hidden; background-color: var(--cor-fundo); }
        /* Header Fixo no Topo */
        .main-header {
            position: fixed; top: 0; left: 0; width: 100%; z-index: 1000;
            background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); height: 80px;
        }
        .admin-wrapper { display: flex; min-height: 100vh; padding-top: 80px; }
        /* Sidebar Melhorada */
        .admin-sidebar {
            width: 280px; background: #fff; border-right: 1px solid var(--cor-borda);
            padding: 1.5rem; display: flex; flex-direction: column; 
            position: fixed; top: 80px; left: 0; bottom: 0; 
            overflow-y: auto; z-index: 900; box-shadow: 2px 0 5px rgba(0,0,0,0.02);
        }
        .admin-sidebar::-webkit-scrollbar { width: 6px; }
        .admin-sidebar::-webkit-scrollbar-track { background: #f1f1f1; }
        .admin-sidebar::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
        .admin-content {
            flex: 1; margin-left: 280px; padding: 2rem; max-width: 1600px; width: calc(100% - 280px); 
        }

        .nav-section-title {
            font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px;
            color: var(--cor-texto-suave); margin-top: 1.5rem; margin-bottom: 0.5rem; font-weight: 700;
        }
        
        .admin-nav-link {
            display: flex; align-items: center; padding: 10px 15px;
            color: var(--cor-texto); text-decoration: none; border-radius: 8px;
            margin-bottom: 5px; font-weight: 500; transition: all 0.2s;
        }
        .admin-nav-link i { margin-right: 12px; font-size: 1.1rem; color: var(--cor-secundaria); }
        .admin-nav-link:hover { background-color: #f0f4ff; color: var(--cor-primaria); }
        .admin-nav-link.active { background-color: var(--cor-primaria); color: #fff; box-shadow: var(--sombra-suave); }
        .admin-nav-link.active i { color: #fff; }

        .content-section { display: none; animation: fadeIn 0.3s ease-out; }
        .content-section.active { display: block; }

        .card { border: none; border-radius: 12px; box-shadow: var(--sombra-suave); margin-bottom: 1.5rem; }
        .card-header { background-color: #fff; border-bottom: 1px solid var(--cor-borda); padding: 1.5rem; border-radius: 12px 12px 0 0 !important; }
        .card-body { padding: 1.5rem; }
        .table-responsive { border-radius: 8px; }
        
        .perm-list { max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 6px; padding: 10px; background: #f8f9fa; }
        .perm-item { display: flex; align-items: center; padding: 6px 0; border-bottom: 1px solid #e9ecef; }
        .btn-xs { padding: 0.25rem 0.5rem; font-size: 0.75rem; line-height: 1.5; border-radius: 0.2rem; }
        #iframe-calendario { width: 100%; height: 750px; border: none; display: block; }
        .input-meta, .input-premio { border: 1px solid #ced4da !important; padding: 0.2rem 0.5rem !important; }

        @media (max-width: 992px) {
            .admin-sidebar { transform: translateX(-100%); transition: transform 0.3s; top: 80px; height: calc(100vh - 80px); }
            .admin-sidebar.show { transform: translateX(0); }
            .admin-content { margin-left: 0; padding: 1rem; width: 100%; }
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <header class="main-header">
        <div class="header-container">
            <a href="/"><img src="{% static 'logo.png' %}" alt="Record PAP Logo" class="logo"></a>
            <button class="menu-toggle" id="menu-toggle"><div class="bar"></div><div class="bar"></div><div class="bar"></div></button>
            <nav class="main-nav" id="main-nav">
                <ul>
                    <li><a href="/area-interna/">Voltar</a></li>
                    <li><button onclick="logout()" class="nav-button logout-button">Sair</button></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="admin-wrapper">
        <nav class="admin-sidebar">
            <div class="nav-section-title">Administra√ß√£o</div>
            <a href="#" class="admin-nav-link active" onclick="mostrarSecao(event, 'usuarios', this)"><i class="bi bi-people"></i> Gest√£o de Usu√°rios</a>
            <a href="#" class="admin-nav-link" onclick="mostrarSecao(event, 'perfis', this)"><i class="bi bi-shield-lock"></i> Perfis de Acesso</a>

            <div class="nav-section-title">Configura√ß√µes CRM</div>
            <a href="#" class="admin-nav-link" onclick="mostrarSecao(event, 'comissionamento', this)"><i class="bi bi-cash-stack"></i> Comissionamento</a>
            <a href="#" class="admin-nav-link" onclick="mostrarSecao(event, 'cadastros_gerais', this)"><i class="bi bi-sliders"></i> Cadastros Gerais</a>
            <a href="#" class="admin-nav-link" onclick="mostrarSecao(event, 'motivos', this)"><i class="bi bi-list-check"></i> Motivos de Aus√™ncia</a>
            <a href="#" class="admin-nav-link" onclick="mostrarSecao(event, 'feriados', this)"><i class="bi bi-calendar-event"></i> Feriados / Sazonalidade</a>

            <div class="nav-section-title">Automa√ß√£o</div>
            <a href="#" class="admin-nav-link" onclick="mostrarSecao(event, 'automacao', this)"><i class="bi bi-whatsapp"></i> Automa√ß√£o WhatsApp</a>

            <div class="nav-section-title">Financeiro</div>
            <a href="#" class="admin-nav-link" onclick="mostrarSecao(event, 'relatorios', this)"><i class="bi bi-file-earmark-bar-graph"></i> Relat√≥rios</a>
            <a href="/painel-performance/" class="admin-nav-link"><i class="bi bi-speedometer2"></i> Painel de Performance</a>

            <div class="mt-auto pt-4 border-top">
                <div class="nav-section-title mt-0">Acesso R√°pido</div>
                <a href="/presenca/" class="admin-nav-link"><i class="bi bi-clock-history"></i> Presen√ßa</a>
                <a href="/crm-vendas/" class="admin-nav-link"><i class="bi bi-cart-plus"></i> Nova Venda</a>
            </div>
        </nav>

        <main class="admin-content">
            
            <section id="usuarios-section" class="content-section active">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3>Gest√£o de Usu√°rios</h3>
                    <button class="btn btn-primary" onclick="abrirModalUsuario()"><i class="bi bi-person-plus-fill"></i> Novo Usu√°rio</button>
                </div>
                <div class="card mt-4">
                    <div class="card-header bg-white py-3">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                            <div>
                                <h5 class="mb-0">Lista de Usu√°rios <span id="lista-status-titulo" class="badge bg-success">Ativos</span></h5>
                                <small id="contador-usuarios" class="text-muted">Carregando...</small>
                            </div>
                            <div class="d-flex gap-2">
                                <input type="text" id="busca-usuario" class="form-control form-control-sm" placeholder="Pesquisar usu√°rio..." style="width: 200px;">
                                <div class="btn-group">
                                    <button onclick="mostrarListaUsuarios('ativos', this)" class="btn btn-sm btn-outline-primary active">Ativos</button>
                                    <button onclick="mostrarListaUsuarios('inativos', this)" class="btn btn-sm btn-outline-secondary">Inativos</button>
                                </div>
                            </div>
                        </div>
                        <div id="acoes-massa" class="mt-3 p-2 bg-light rounded border d-none align-items-center justify-content-between">
                            <span class="small fw-bold text-muted"><span id="count-selecionados">0</span> selecionados</span>
                            <div class="d-flex gap-2">
                                <select id="novo-perfil-massa" class="form-select form-select-sm" style="width: 200px;"><option value="">Alterar Perfil para...</option></select>
                                <button onclick="aplicarMudancaPerfilEmMassa()" class="btn btn-sm btn-primary">Aplicar</button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0" id="tabela-usuarios">
                                <thead class="table-light"><tr id="user-list-header"><th style="width: 40px;"><input type="checkbox" id="check-all" onclick="toggleTodos(this)"></th><th>Nome</th><th>E-mail</th><th>Perfil</th><th>Canal</th> <th>L√≠der</th><th class="text-end">A√ß√µes</th></tr></thead>
                                <tbody id="user-list-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <section id="perfis-section" class="content-section">
                <div class="d-flex justify-content-between align-items-center mb-4"><h3>Gest√£o de Perfis de Acesso</h3><button class="btn btn-primary" id="btn-adicionar-perfil"><i class="bi bi-plus-lg"></i> Novo Perfil</button></div>
                <div class="alert alert-info py-2 small"><i class="bi bi-info-circle"></i> Defina aqui quais m√≥dulos cada cargo pode acessar.</div>
                <div class="card"><div class="card-body p-0"><div class="table-responsive"><table class="table table-hover align-middle mb-0"><thead class="table-light"><tr><th>Nome do Perfil</th><th>Permiss√µes Habilitadas</th><th class="text-center" style="width: 180px;">A√ß√µes</th></tr></thead><tbody id="perfis-tabela-corpo"></tbody></table></div></div></div>
            </section>
            
            <section id="comissionamento-section" class="content-section">
                <h3 class="mb-4">Gest√£o de Comissionamento</h3>
                <div class="card">
                    <div class="card-header"><ul class="nav nav-tabs card-header-tabs"><li class="nav-item"><button class="nav-link active" onclick="openTab(event, 'regras_comissao_tab')">Regras de Comiss√£o</button></li><li class="nav-item"><button class="nav-link" onclick="openTab(event, 'recebimento_operadora_tab')">Recebimento Operadora</button></li><li class="nav-item"><button class="nav-link" onclick="openTab(event, 'config_mensal_tab')">Configura√ß√µes do M√™s</button></li><li class="nav-item"><button class="nav-link" onclick="openTab(event, 'campanhas_tab')">Campanhas</button></li><li class="nav-item"><button class="nav-link" onclick="openTab(event, 'adiantamentos_descontos_tab')">Adiantamentos e Descontos</button></li></ul></div>
                    <div class="card-body">
                        <div id="regras_comissao_tab" class="tab-content active">
                            <div class="bg-light p-4 rounded border mb-4"><h5 class="text-primary mb-3">Nova Regra (Pagamento ao Vendedor)</h5><form id="form-regra-comissao"><input type="hidden" id="regra_comissao_id"><div class="row g-3"><div class="col-md-4"><label class="form-label fw-bold">Consultor</label><select id="regra_consultor_id" class="form-select" required></select></div><div class="col-md-4"><label class="form-label fw-bold">Plano</label><select id="regra_plano_id" class="form-select" required></select></div><div class="col-md-2"><label class="form-label fw-bold">Tipo Venda</label><select id="regra_tipo_venda" class="form-select" required><option value="PAP">PAP</option><option value="TELAG">TELAG</option></select></div><div class="col-md-2"><label class="form-label fw-bold">Cliente</label><select id="regra_tipo_cliente" class="form-select" required><option value="CPF">CPF</option><option value="CNPJ">CNPJ</option></select></div><div class="col-md-3"><label class="form-label fw-bold">Base (R$)</label><input type="number" class="form-control" id="regra_valor_base" step="0.01" required></div><div class="col-md-3"><label class="form-label fw-bold">Acelerado (R$)</label><input type="number" class="form-control" id="regra_valor_acelerado" step="0.01" required></div><div class="col-md-6 d-flex align-items-end"><button type="submit" class="btn btn-primary w-100 me-2">Salvar Regra</button><button type="button" class="btn btn-outline-secondary w-50" onclick="resetFormRegraComissao()">Limpar</button></div></div></form></div>
                            <div class="table-responsive"><table class="table table-hover align-middle mb-0"><thead class="table-light"><tr><th>Consultor</th><th>Plano</th><th>Tipo</th><th>Cliente</th><th>Base</th><th>Acelerado</th><th>A√ß√µes</th></tr></thead><tbody id="lista-regras-comissao"></tbody></table></div>
                        </div>
                        <div id="recebimento_operadora_tab" class="tab-content" style="display:none;">
                            <div class="bg-light p-4 rounded border mb-4"><h5 class="text-success mb-3"><i class="bi bi-bank"></i> Configura√ß√£o de Recebimento (Operadora -> Empresa)</h5><form id="form-comissao-operadora"><input type="hidden" id="co_id"><div class="row g-3 align-items-end"><div class="col-md-4"><label class="form-label fw-bold">Plano Vendido</label><select id="co_plano_id" class="form-select" required></select></div><div class="col-md-2"><label class="form-label fw-bold">Comiss√£o Base (R$)</label><input type="number" class="form-control" id="co_valor_base" step="0.01" required placeholder="0,00"></div><div class="col-md-2"><label class="form-label fw-bold text-success">B√¥nus Transi√ß√£o (R$)</label><input type="number" class="form-control border-success" id="co_bonus" step="0.01" value="0" placeholder="0,00"></div><div class="col-md-2"><label class="form-label small text-muted">Validade B√¥nus (Fim)</label><input type="date" class="form-control" id="co_data_fim"></div><div class="col-md-2"><button type="submit" class="btn btn-success w-100">Salvar Config</button></div></div></form></div>
                            <div class="table-responsive"><table class="table table-hover align-middle mb-0"><thead class="table-light"><tr><th>Plano</th><th>Recebimento Base</th><th class="text-success">B√¥nus Transi√ß√£o</th><th>Validade B√¥nus</th><th class="fw-bold">Total Recebido</th><th class="text-end">A√ß√µes</th></tr></thead><tbody id="lista-comissoes-operadora"></tbody></table></div>
                        </div>
                        <div id="config_mensal_tab" class="tab-content" style="display:none;"><h5>Configura√ß√µes Vari√°veis do M√™s</h5><div class="d-flex align-items-center mb-4"><label for="select_mes_config" class="form-label me-2 fw-bold">M√™s de Refer√™ncia:</label><input type="month" id="select_mes_config" class="form-control" style="width: auto;" onchange="carregarConfigMensal()"></div><div id="form-container-config-mensal" class="p-4 border rounded bg-light text-center text-muted">Selecione um m√™s para ver as op√ß√µes.</div></div>
                        <div id="campanhas_tab" class="tab-content" style="display:none;">
                            <div class="bg-light p-4 rounded border mb-4"><h5 class="text-primary mb-3"><i class="bi bi-cash-coin"></i> Nova Campanha (Financeira)</h5><form id="form-campanha"><input type="hidden" id="campanha_id"><div class="row g-3"><div class="col-md-6"><label class="form-label fw-bold">Nome da Campanha</label><input type="text" class="form-control" id="campanha_nome" required placeholder="Ex: Arrancada Fibra 1GB"></div><div class="col-md-3"><label class="form-label fw-bold">In√≠cio</label><input type="date" class="form-control" id="campanha_data_inicio" required></div><div class="col-md-3"><label class="form-label fw-bold">Fim</label><input type="date" class="form-control" id="campanha_data_fim" required></div><div class="col-12 mt-2"><div class="card bg-white border p-3"><div class="d-flex justify-content-between align-items-center mb-2"><label class="form-label fw-bold text-primary mb-0"><i class="bi bi-list-ol"></i> Faixas de Premia√ß√£o (Escalonamento)</label><button type="button" class="btn btn-sm btn-outline-primary" onclick="adicionarFaixaCampanha()"><i class="bi bi-plus-lg"></i> Adicionar Faixa</button></div><div class="table-responsive" style="max-height: 200px; overflow-y: auto;"><table class="table table-sm table-bordered mb-0"><thead class="table-light small"><tr><th style="width: 40%;">Meta (Qtd Vendas)</th><th style="width: 40%;">Pr√™mio (R$)</th><th style="width: 20%;">A√ß√£o</th></tr></thead><tbody id="tbody-faixas-campanha"></tbody></table></div><div class="form-text small text-muted mt-1">* O sistema pagar√° o pr√™mio da <strong>maior meta</strong> atingida pelo vendedor.</div></div></div><div class="col-md-3"><label class="form-label fw-bold">Crit√©rio</label><select class="form-select" id="campanha_tipo_meta"><option value="LIQUIDA" selected>Vendas Instaladas (L√≠quida)</option><option value="BRUTA">Vendas Abertas (Bruta)</option></select></div><div class="col-md-3"><label class="form-label fw-bold">Status</label><select class="form-select" id="campanha_ativo"><option value="true">Ativa</option><option value="false">Inativa</option></select></div><div class="col-12"><div class="card p-3 border-warning bg-white"><h6 class="text-warning fw-bold mb-3"><i class="bi bi-filter-circle"></i> Regras de Elegibilidade (Segure Ctrl)</h6><div class="row g-3"><div class="col-md-4"><label class="form-label small fw-bold">1. Planos V√°lidos</label><select class="form-select" id="campanha_planos" multiple style="height: 120px;"></select></div><div class="col-md-4"><label class="form-label small fw-bold">2. Formas de Pagamento V√°lidas</label><select class="form-select" id="campanha_pagamentos" multiple style="height: 120px;"></select></div><div class="col-md-4"><label class="form-label small fw-bold">3. Canal Permitido</label><select class="form-select" id="campanha_canal_alvo"><option value="TODOS">Todos os Canais</option><option value="PAP">Apenas PAP</option><option value="DIGITAL">Apenas Digital</option><option value="RECEPTIVO">Apenas Receptivo</option><option value="PARCEIRO">Apenas Parceiro</option></select><label class="form-label small fw-bold mt-2">Obs.</label><input type="text" class="form-control form-control-sm" id="campanha_regras" placeholder="Opcional"></div></div></div></div><div class="col-12 d-flex justify-content-end gap-2 pt-2"><button type="button" class="btn btn-outline-secondary" onclick="resetFormCampanha()">Cancelar</button><button type="submit" class="btn btn-success px-4">Salvar Campanha</button></div></div></form></div>
                            <div class="card border-0 shadow-sm"><div class="card-body p-0 table-responsive"><table class="table table-hover align-middle mb-0"><thead class="table-light"><tr><th>Nome</th><th>Per√≠odo</th><th>Faixas de Premia√ß√£o</th><th>Regras</th><th>Status</th><th class="text-end">A√ß√µes</th></tr></thead><tbody id="lista-campanhas"></tbody></table></div></div>
                        </div>
                        <div id="adiantamentos_descontos_tab" class="tab-content" style="display:none;">
                            <div class="row"><div class="col-md-4"><div class="card border-primary mb-3 shadow-sm"><div class="card-header bg-primary text-white py-2"><h6 class="mb-0"><i class="bi bi-cash-stack"></i> Novo Adiantamento</h6></div><div class="card-body"><form id="form-adiantamento"><div class="mb-2"><label class="form-label small fw-bold">Colaborador</label><select id="ad_usuario" class="form-select form-select-sm" required></select></div><div class="mb-2"><label class="form-label small fw-bold">Tipo</label><select id="ad_tipo" class="form-select form-select-sm" onchange="toggleCamposAdiantamento()"><option value="ADIANTAMENTO_CNPJ">Adiantamento CNPJ</option><option value="ADIANTAMENTO_COMISSAO">Adiantamento de Comiss√£o</option></select></div><div class="row g-2 mb-2"><div class="col-6"><label class="form-label small fw-bold">Data</label><input type="date" id="ad_data" class="form-control form-control-sm" required></div><div class="col-6"><label class="form-label small fw-bold">Valor (R$)</label><input type="number" class="form-control form-control-sm" id="ad_valor" step="0.01" required></div></div><div id="box-qtd-vendas" class="mb-2 bg-light p-2 rounded border"><label class="form-label small fw-bold text-primary">Qtd. Vendas Adiantadas</label><input type="number" id="ad_qtd" class="form-control form-control-sm"></div><div class="mb-3"><label class="form-label small fw-bold">Observa√ß√£o</label><textarea id="ad_obs" class="form-control form-control-sm" rows="2"></textarea></div><button type="submit" class="btn btn-primary btn-sm w-100">Registrar</button></form></div></div><div class="card border-danger shadow-sm"><div class="card-header bg-danger text-white py-2"><h6 class="mb-0"><i class="bi bi-dash-circle"></i> Novo Desconto</h6></div><div class="card-body"><form id="form-desconto"><div class="mb-2"><label class="form-label small fw-bold">Colaborador</label><select id="desc_usuario" class="form-select form-select-sm" required></select></div><div class="mb-2"><label class="form-label small fw-bold">Motivo</label><input type="text" id="desc_motivo" class="form-control form-control-sm" placeholder="Ex: Equipamento perdido" required></div><div class="row g-2 mb-3"><div class="col-6"><label class="form-label small fw-bold">Data</label><input type="date" id="desc_data" class="form-control form-control-sm" required></div><div class="col-6"><label class="form-label small fw-bold">Valor (R$)</label><input type="number" class="form-control form-control-sm" id="desc_valor" step="0.01" required></div></div><button type="submit" class="btn btn-danger btn-sm w-100">Registrar</button></form></div></div></div><div class="col-md-8"><div class="card h-100 shadow-sm"><div class="card-header bg-white d-flex justify-content-between align-items-center"><h6 class="mb-0 fw-bold">Hist√≥rico de Lan√ßamentos</h6><div class="input-group input-group-sm" style="width: 200px;"><input type="month" id="filtro-mes-lancamentos" class="form-control" onchange="carregarLancamentosFinanceiros()"></div></div><div class="card-body p-0 table-responsive"><table class="table table-hover table-striped mb-0 small align-middle"><thead class="table-light"><tr><th>Data</th><th>Colaborador</th><th>Tipo / Descri√ß√£o</th><th class="text-end">Valor</th><th class="text-end">A√ß√µes</th></tr></thead><tbody id="lista-lancamentos-fin"></tbody></table></div></div></div></div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="cadastros_gerais-section" class="content-section">
                <h3 class="mb-4">Cadastros Gerais do CRM</h3>
                <div class="card"><div class="card-header"><ul class="nav nav-tabs card-header-tabs"><li class="nav-item"><button class="nav-link active" onclick="openTab(event, 'operadoras')">Operadoras</button></li><li class="nav-item"><button class="nav-link" onclick="openTab(event, 'planos')">Planos</button></li><li class="nav-item"><button class="nav-link" onclick="openTab(event, 'formasPagamento')">Pagamentos</button></li><li class="nav-item"><button class="nav-link" onclick="openTab(event, 'status')">Status</button></li><li class="nav-item"><button class="nav-link" onclick="openTab(event, 'pendencias')">Pend√™ncias</button></li></ul></div>
                    <div class="card-body">
                        <div id="operadoras" class="tab-content active"><form id="form-operadora" class="row g-3 mb-4 align-items-end bg-light p-3 rounded border"><input type="hidden" id="operadora_id"><div class="col-md-4"><label class="form-label fw-bold">Nome</label><input type="text" class="form-control" id="operadora_nome" required></div><div class="col-md-3"><label class="form-label fw-bold">CNPJ</label><input type="text" class="form-control" id="operadora_cnpj"></div><div class="col-md-3"><label class="form-label fw-bold">Status</label><select id="operadora_status" class="form-select" required><option value="1">Ativo</option><option value="0">Inativo</option></select></div><div class="col-md-2"><button type="submit" class="btn btn-primary w-100">Salvar</button></div></form><table class="table table-hover align-middle"><thead class="table-light"><tr><th>Nome</th><th>CNPJ</th><th>Status</th><th>A√ß√µes</th></tr></thead><tbody id="lista-operadoras"></tbody></table></div>
                        <div id="planos" class="tab-content" style="display:none;"><form id="form-plano" class="row g-3 mb-4 align-items-end bg-light p-3 rounded border"><input type="hidden" id="plano_id"><div class="col-md-3"><label class="form-label fw-bold">Nome</label><input type="text" class="form-control" id="plano_nome" required></div><div class="col-md-2"><label class="form-label fw-bold">Valor</label><input type="number" class="form-control" id="plano_valor" step="0.01" required></div><div class="col-md-2"><label class="form-label fw-bold">Comiss√£o</label><input type="number" class="form-control" id="plano_comissao" step="0.01"></div><div class="col-md-3"><label class="form-label fw-bold">Operadora</label><select id="plano_operadora_id" class="form-select" required></select></div><div class="col-md-2"><button type="submit" class="btn btn-primary w-100">Salvar</button></div></form><table class="table table-hover align-middle"><thead class="table-light"><tr><th>Nome</th><th>Operadora</th><th>Valor</th><th>Comiss√£o</th><th>A√ß√µes</th></tr></thead><tbody id="lista-planos"></tbody></table></div>
                        <div id="formasPagamento" class="tab-content" style="display:none;"><div class="input-group mb-3"><input type="text" id="nova-forma-pagamento-nome" placeholder="Nova Forma (Ex: PIX)" class="form-control"><button id="btn-salvar-forma-pagamento" class="btn btn-primary">Adicionar</button></div><ul id="lista-formas-pagamento" class="list-group"></ul></div>
                        <div id="status" class="tab-content" style="display:none;"><form id="form-status" class="row g-3 mb-4 align-items-end bg-light p-3 rounded border"><input type="hidden" id="status_id"><div class="col-md-3"><label class="form-label fw-bold">Nome</label><input type="text" class="form-control" id="status_nome" required></div><div class="col-md-3"><label class="form-label fw-bold">Tipo</label><select id="status_tipo" class="form-select" required><option value="Tratamento">Tratamento</option><option value="Esteira">Esteira</option><option value="Comissionamento">Comissionamento</option></select></div><div class="col-md-3"><label class="form-label fw-bold">Estado</label><input type="text" class="form-control" id="status_estado" placeholder="Ex: Fechado"></div><div class="col-md-1"><label class="form-label fw-bold">Cor</label><input type="color" class="form-control form-control-color w-100" id="status_cor" value="#FFFFFF"></div><div class="col-md-2"><button type="submit" class="btn btn-primary w-100">Salvar</button></div></form><table class="table table-hover align-middle"><thead class="table-light"><tr><th>Nome</th><th>Tipo</th><th>Estado</th><th>Cor</th><th>A√ß√µes</th></tr></thead><tbody id="lista-status"></tbody></table></div>
                        <div id="pendencias" class="tab-content" style="display:none;"><form id="form-pendencia" class="row g-3 mb-4 align-items-end bg-light p-3 rounded border"><input type="hidden" id="pendencia_id"><div class="col-md-6"><label class="form-label fw-bold">Motivo</label><input type="text" class="form-control" id="pendencia_nome" required></div><div class="col-md-4"><label class="form-label fw-bold">Tipo</label><input type="text" class="form-control" id="pendencia_tipo" placeholder="Ex: Documenta√ß√£o" required></div><div class="col-md-2"><button type="submit" class="btn btn-primary w-100">Salvar</button></div></form><table class="table table-hover align-middle"><thead class="table-light"><tr><th>Nome</th><th>Tipo</th><th>A√ß√µes</th></tr></thead><tbody id="lista-pendencias"></tbody></table></div>
                    </div>
                </div>
            </section>

            <section id="motivos-section" class="content-section">
                <h3 class="mb-4">Gest√£o de Motivos de Aus√™ncia</h3>
                <div class="card"><div class="card-body"><div class="input-group mb-3"><input type="text" id="novo-motivo-nome" placeholder="Nome do novo motivo" class="form-control"><div class="input-group-text bg-light"><input class="form-check-input mt-0" type="checkbox" id="novo-motivo-desconto" checked><label class="form-check-label ms-2" for="novo-motivo-desconto">Gera Desconto</label></div><button id="btn-salvar-motivo" class="btn btn-primary">Adicionar</button></div><ul id="lista-motivos" class="list-group"></ul></div></div>
            </section>

            <section id="feriados-section" class="content-section">
                <h3 class="mb-4">Sazonalidade e Feriados</h3>
                <div class="card">
                    <div class="card-header"><ul class="nav nav-tabs card-header-tabs"><li class="nav-item"><button class="nav-link active" onclick="openTab(event, 'tab-lista-feriados')">Lista de Feriados</button></li><li class="nav-item"><button class="nav-link" onclick="openTab(event, 'tab-calendario-fiscal')">Calend√°rio de Pesos</button></li></ul></div>
                    <div class="card-body"><div id="tab-lista-feriados" class="tab-content active"><div class="input-group mb-4"><input type="date" id="novo-feriado-data" class="form-control"><input type="text" id="novo-feriado-descricao" placeholder="Descri√ß√£o (Ex: Natal)" class="form-control"><button id="btn-salvar-feriado" class="btn btn-primary">Adicionar</button></div><table class="table table-hover align-middle"><thead class="table-light"><tr><th>Data</th><th>Descri√ß√£o</th><th>A√ß√µes</th></tr></thead><tbody id="lista-feriados"></tbody></table></div><div id="tab-calendario-fiscal" class="tab-content" style="display:none;"><iframe src="/calendario/?modo=iframe" id="iframe-calendario"></iframe></div></div>
                </div>
            </section>

            <section id="automacao-section" class="content-section">
                <h3 class="mb-4">Automa√ß√£o de Mensagens (WhatsApp)</h3>
                <div class="row">
                    <div class="col-lg-5">
                        <div class="card border-success shadow-sm">
                            <div class="card-header bg-success text-white"><h5 class="mb-0"><i class="bi bi-robot"></i> Nova Regra de Evento</h5></div>
                            <div class="card-body">
                                <form id="form-regra-automacao">
                                    <input type="hidden" id="regra_auto_id">
                                    <div class="mb-3"><label class="form-label fw-bold">Nome da Regra</label><input type="text" class="form-control" id="regra_nome" placeholder="Ex: Aviso Backoffice - Novo CDOI" required></div>
                                    <div class="row g-2 mb-3">
                                        <div class="col-md-8"><label class="form-label fw-bold">Evento Gatilho</label><select id="regra_evento" class="form-select" required><option value="NOVO_CDOI">Novo CDOI Cadastrado (Record Vertical)</option></select></div>
                                        <div class="col-md-4"><label class="form-label fw-bold">Status</label><select id="regra_ativo" class="form-select"><option value="true">Ativo</option><option value="false">Inativo</option></select></div>
                                    </div>
                                    <div class="mb-3"><label class="form-label fw-bold d-flex justify-content-between">Grupos de Destino (WhatsApp) <button type="button" class="btn btn-xs btn-outline-secondary" onclick="carregarGruposExternos()"><i class="bi bi-arrow-clockwise"></i> Atualizar Lista</button></label><select id="regra_grupos" class="form-select" multiple style="height: 120px;"><option value="" disabled>Clique em atualizar para buscar...</option></select><div class="form-text small">Segure Ctrl para selecionar v√°rios.</div></div>
                                    <div class="mb-3"><label class="form-label fw-bold">N√∫meros Individuais (Opcional)</label><input type="text" class="form-control" id="regra_numeros" placeholder="Ex: 553199999999, 551188888888"><div class="form-text small">Separe por v√≠rgula. Use DDI (55).</div></div>
                                    <div class="mb-3"><label class="form-label fw-bold">Mensagem Personalizada</label><div class="bg-light p-2 border rounded mb-2 small text-secondary"><strong>Vari√°veis Dispon√≠veis:</strong><br><code>{id}</code>, <code>{cliente}</code>, <code>{sindico}</code>, <code>{contato}</code>, <code>{total_hps}</code>, <code>{usuario}</code>, <code>{cidade}</code>, <code>{link}</code></div><textarea id="regra_msg" class="form-control" rows="5" required>üîî *NOVO CDOI*&#13;&#10;Cliente: {cliente}&#13;&#10;Resp: {usuario}&#13;&#10;Link: {link}</textarea></div>
                                    <div class="d-grid gap-2"><button type="submit" class="btn btn-success">Salvar Regra</button><button type="button" class="btn btn-outline-secondary" onclick="resetFormRegraAuto()">Limpar</button></div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-7">
                        <div class="card"><div class="card-header bg-white fw-bold">Regras Ativas</div><div class="card-body p-0 table-responsive"><table class="table table-hover align-middle mb-0"><thead class="table-light"><tr><th>Nome / Evento</th><th>Destinos</th><th>Status</th><th class="text-end">A√ß√µes</th></tr></thead><tbody id="lista-regras-auto"></tbody></table></div></div>
                    </div>
                </div>
            </section>

            <section id="relatorios-section" class="content-section">
                <h3 class="mb-4">Relat√≥rios Gerenciais</h3>
                <div class="card">
                    <div class="card-header"><ul class="nav nav-tabs card-header-tabs" id="relatoriosTabs" role="tablist"><li class="nav-item"><button class="nav-link active" id="tab-rel-financeiro" data-bs-toggle="tab" data-bs-target="#content-rel-financeiro" type="button"><i class="bi bi-cash-coin"></i> Financeiro (Presen√ßa)</button></li><li class="nav-item"><button class="nav-link" id="tab-rel-campanhas" data-bs-toggle="tab" data-bs-target="#content-rel-campanhas" type="button" onclick="carregarOpcoesCampanhasRelatorio()"><i class="bi bi-trophy"></i> Resultado de Campanhas</button></li></ul></div>
                    <div class="card-body">
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="content-rel-financeiro">
                                <div class="card p-3 mb-4 bg-light border"><div class="row g-3 align-items-end"><div class="col-md-3"><label class="form-label fw-bold">Data In√≠cio</label><input type="date" id="finDataInicio" class="form-control"></div><div class="col-md-3"><label class="form-label fw-bold">Data Fim</label><input type="date" id="finDataFim" class="form-control"></div><div class="col-md-3"><button class="btn btn-primary w-100" onclick="carregarRelatorioFinanceiro()"><i class="bi bi-search"></i> Pesquisar</button></div><div class="col-md-3"><button class="btn btn-success w-100" onclick="baixarExcelFinanceiro()"><i class="bi bi-file-earmark-excel"></i> Baixar Excel</button></div></div></div>
                                <div class="card mb-4" id="cardPrevisao" style="display:none;"><div class="card-header bg-info text-white"><h5 class="mb-0">Previs√£o</h5></div><div class="card-body p-0 table-responsive"><table class="table table-hover mb-0"><thead class="table-light"><tr><th>Nome</th><th>Dias √öteis</th><th>Valor Di√°rio</th><th>Valor Total Previsto</th></tr></thead><tbody id="tbodyPrevisao"></tbody></table></div></div>
                                <div class="card mb-4" id="cardDescontos" style="display:none;"><div class="card-header bg-danger text-white"><h5 class="mb-0">Pagamento Final</h5></div><div class="card-body p-0 table-responsive"><table class="table table-hover mb-0"><thead class="table-light"><tr><th>Nome</th><th>Dias √öteis</th><th>Qtd Faltas</th><th>Valor Di√°rio</th><th>Valor Desconto</th><th>Total a Receber</th></tr></thead><tbody id="tbodyDescontos"></tbody></table></div></div>
                            </div>
                            <div class="tab-pane fade" id="content-rel-campanhas">
                                <div class="row mb-4 align-items-end"><div class="col-md-6"><label class="form-label fw-bold">Selecione a Campanha:</label><div class="input-group"><select class="form-select" id="select-rel-campanha" required><option value="">Carregando...</option></select><button class="btn btn-primary" onclick="carregarResultadoCampanha()"><i class="bi bi-search"></i> Ver Resultado</button></div></div></div>
                                <div id="resultado-campanha-container" style="display:none;"><div class="alert alert-info d-flex justify-content-between align-items-center mb-3"><div><strong id="campanha-titulo-resumo">Nome</strong><br><span class="small" id="campanha-periodo-resumo"></span></div><div class="text-end"><h3 class="m-0 text-success fw-bold" id="campanha-total-premios">R$ 0,00</h3></div></div><div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-white rounded shadow-sm border"><div class="form-check"><input class="form-check-input" type="checkbox" id="check-all-relatorio" onclick="toggleSelecaoRelatorio(this)"><label class="form-check-label small fw-bold" for="check-all-relatorio">SELECIONAR TODOS</label></div><div><button class="btn btn-success btn-sm" onclick="enviarResultadoWhatsappSelecionados()"><i class="bi bi-whatsapp"></i> Enviar Resultado para <span id="count-wpp">0</span> Vendedores</button></div></div><div class="table-responsive border rounded"><table class="table table-hover align-middle mb-0"><thead class="table-light"><tr><th style="width: 40px;">#</th><th class="text-center" style="width: 50px;">Rank</th><th>Vendedor</th><th class="text-center">Vendas V√°lidas</th><th class="text-center">Meta</th><th>Progresso</th><th class="text-end">Pr√™mio (R$)</th></tr></thead><tbody id="tbody-resultado-campanha"></tbody></table></div></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable" style="max-width: 90%;">
            <div class="modal-content">
                <div class="modal-header bg-light border-bottom">
                    <h5 class="modal-title fw-bold" id="userModalTitle">Novo Usu√°rio</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <ul class="nav nav-tabs nav-fill" id="userModalTabs" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active fw-bold" id="dados-tab" data-bs-toggle="tab" data-bs-target="#dados-content" type="button">Dados Pessoais</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link fw-bold" id="financeiro-tab" data-bs-toggle="tab" data-bs-target="#financeiro-content" type="button">Financeiro</button>
                        </li>
                    </ul>
                    <form id="user-form">
                        <input type="hidden" id="user_id">
                        <div class="tab-content p-4">
                            <!-- TAB: DADOS PESSOAIS -->
                            <div class="tab-pane fade show active" id="dados-content">
                                <div class="row g-3">
                                    <div class="col-12">
                                        <label class="form-label fw-bold">Nome Completo</label>
                                        <input type="text" class="form-control" id="nome_completo" required>
                                    </div>
                                    <div class="col-lg-3 col-md-6">
                                        <label class="form-label fw-bold">CPF</label>
                                        <input type="text" class="form-control" id="cpf">
                                    </div>
                                    <div class="col-lg-3 col-md-6">
                                        <label class="form-label fw-bold">E-mail</label>
                                        <input type="email" class="form-control" id="email" required>
                                    </div>
                                    <div class="col-lg-3 col-md-6">
                                        <label class="form-label fw-bold">WhatsApp</label>
                                        <input type="text" class="form-control" id="tel_whatsapp">
                                    </div>
                                    <div class="col-lg-3 col-md-6">
                                        <label class="form-label fw-bold">Username</label>
                                        <input type="text" class="form-control" id="usuario_login" required>
                                    </div>
                                    <div class="col-lg-2 col-md-4">
                                        <label class="form-label fw-bold">Senha</label>
                                        <input type="password" class="form-control" id="senha" placeholder="Deixe vazio se n√£o alterar">
                                    </div>
                                    <div class="col-lg-2 col-md-4">
                                        <label class="form-label fw-bold">Perfil</label>
                                        <select class="form-select" id="perfil_id" required></select>
                                    </div>
                                    <div class="col-lg-2 col-md-4">
                                        <label class="form-label fw-bold">L√≠der</label>
                                        <select class="form-select" id="supervisor_id">
                                            <option value="">Nenhum</option>
                                        </select>
                                    </div>
                                    <div class="col-lg-2 col-md-4">
                                        <label class="form-label fw-bold">Canal</label>
                                        <select class="form-select" id="user_canal">
                                            <option value="PAP">PAP</option>
                                            <option value="DIGITAL">Digital</option>
                                            <option value="RECEPTIVO">Receptivo</option>
                                            <option value="PARCEIRO">Parceiro</option>
                                        </select>
                                    </div>
                                    <div class="col-lg-2 col-md-4">
                                        <label class="form-label fw-bold">Cluster</label>
                                        <select class="form-select" id="user_cluster">
                                            <option value="">Nenhum</option>
                                            <option value="CLUSTER_1">CLUSTER 1</option>
                                            <option value="CLUSTER_2">CLUSTER 2</option>
                                            <option value="CLUSTER_3">CLUSTER 3</option>
                                        </select>
                                    </div>
                                    <div class="col-12 mt-3 pt-3 border-top">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="participa_controle_presenca">
                                            <label class="form-check-label fw-bold" for="participa_controle_presenca">Participa Controle Presen√ßa?</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- TAB: FINANCEIRO -->
                            <div class="tab-pane fade" id="financeiro-content">
                                <div class="row g-3">
                                    <div class="col-lg-3 col-md-4">
                                        <label class="form-label small fw-bold">Meta</label>
                                        <input type="number" class="form-control" id="meta_comissao">
                                    </div>
                                    <div class="col-lg-3 col-md-4">
                                        <label class="form-label small fw-bold">Chave PIX</label>
                                        <input type="text" class="form-control" id="chave_pix">
                                    </div>
                                    <div class="col-lg-3 col-md-4">
                                        <label class="form-label small fw-bold">Titular</label>
                                        <input type="text" class="form-control" id="nome_da_conta">
                                    </div>
                                    <div class="col-lg-3 col-md-6">
                                        <label class="form-label small fw-bold">Almo√ßo</label>
                                        <input type="number" class="form-control" id="valor_almoco" step="0.01">
                                    </div>
                                    <div class="col-lg-3 col-md-6">
                                        <label class="form-label small fw-bold">Passagem</label>
                                        <input type="number" class="form-control" id="valor_passagem" step="0.01">
                                    </div>

                                    <div class="col-12">
                                        <hr class="text-muted">
                                        <h6 class="text-secondary small text-uppercase fw-bold">Descontos</h6>
                                    </div>

                                    <div class="col-lg-2 col-md-4">
                                        <label class="form-label small">Desc. Boleto</label>
                                        <input type="number" class="form-control" id="desconto_boleto" step="0.01">
                                    </div>
                                    <div class="col-lg-2 col-md-4">
                                        <label class="form-label small">Desc. Viab.</label>
                                        <input type="number" class="form-control" id="desconto_inclusao_viabilidade" step="0.01">
                                    </div>
                                    <div class="col-lg-2 col-md-4">
                                        <label class="form-label small">Desc. Antecip.</label>
                                        <input type="number" class="form-control" id="desconto_instalacao_antecipada" step="0.01">
                                    </div>
                                    <div class="col-lg-2 col-md-4">
                                        <label class="form-label small">Adiant. CNPJ</label>
                                        <input type="number" class="form-control" id="adiantamento_cnpj" step="0.01">
                                    </div>
                                    <div class="col-lg-2 col-md-4">
                                        <label class="form-label small">Desc. INSS</label>
                                        <input type="number" class="form-control" id="desconto_inss_fixo" step="0.01">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" form="user-form" class="btn btn-primary px-4">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="perfilModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="modal-perfil-titulo">Perfil</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="perfilForm"><input type="hidden" id="modal_perfil_id"><div class="mb-3"><label class="form-label fw-bold">Nome</label><input type="text" class="form-control" id="modal_perfil_nome" required></div><div class="mb-3"><label class="form-label fw-bold text-primary">Permiss√µes</label><input type="text" id="filtro-permissoes" class="form-control form-control-sm mb-2" placeholder="Buscar..."><div id="lista-permissoes" class="perm-list"></div></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn btn-primary" onclick="salvarPerfil()">Salvar</button></div></div></div></div>
    <div class="modal fade" id="excluirPerfilModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Confirmar Exclus√£o</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>Excluir o perfil "<strong id="nome-perfil-excluir"></strong>"?</p><input type="hidden" id="id-perfil-excluir"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn btn-danger" id="btn-confirmar-exclusao-perfil">Excluir</button></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
    <script src="{% static 'js/auth.js' %}?v=7.0"></script>
    <script src="{% static 'js/menu.js' %}?v=7.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <script>
    const apiUrl = '';

    function fmtMoeda(valor) {
        if (valor === null || valor === undefined || valor === '') return 'R$ 0,00';
        return parseFloat(valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }
    
    function openTab(evt, tabName) {
        evt.preventDefault();
        const parent = evt.currentTarget.closest('.card');
        parent.querySelectorAll('.tab-content').forEach(t => { t.classList.remove("active"); t.style.display = "none"; });
        parent.querySelectorAll('.nav-link').forEach(l => l.classList.remove("active"));
        const target = document.getElementById(tabName);
        if(target){ target.style.display = "block"; target.classList.add("active"); }
        evt.currentTarget.classList.add("active");
        
        // Carregar dados das abas
        if(tabName === 'formasPagamento') carregarFormasPagamento();
        if(tabName === 'status') carregarStatus();
        if(tabName === 'pendencias') carregarMotivosPendencia();
    }

    function mostrarSecao(event, idSecao, menuItem) {
        if (event) event.preventDefault();
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
        const secaoAlvo = document.getElementById(`${idSecao}-section`);
        if (secaoAlvo) secaoAlvo.classList.add('active');
        document.querySelectorAll('.admin-nav-link').forEach(l => l.classList.remove('active'));
        if (menuItem) menuItem.classList.add('active');
    }

    async function apiFetch(endpoint, options = {}) {
        const headers = { 'Content-Type': 'application/json', ...options.headers };
        const token = localStorage.getItem('accessToken');
        if (token) headers['Authorization'] = `Bearer ${token}`;
        try {
            let finalEndpoint = endpoint;
            if (!endpoint.startsWith('/api')) {
                const cleanEndpoint = endpoint.startsWith('/') ? endpoint : `/${endpoint}`;
                finalEndpoint = `/api${cleanEndpoint}`;
            }
            const fetchUrl = `${apiUrl}${finalEndpoint}`; 
            const response = await fetch(fetchUrl, { ...options, headers });
            if (options.isBlob) {
                if (!response.ok) throw new Error('Erro no download.');
                return await response.blob();
            }
            if (options.body instanceof FormData) delete headers['Content-Type'];
            let responseData = {};
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") !== -1) {
                try { responseData = await response.clone().json(); } catch (e) { }
            }
            if (response.status === 401) { alert('Sess√£o expirada.'); logout(); throw new Error('N√£o autorizado'); }
            if (!response.ok) {
                const errorData = responseData || await response.text();
                throw new Error(errorData.detail || errorData.error || (typeof errorData === 'string' ? errorData : JSON.stringify(errorData)));
            }
            if (response.status === 204) return null;
            return responseData;
        } catch (e) { throw e; }
    }
    
    const token = localStorage.getItem('accessToken');
    if (!token) window.location.href = '/';
    const decodedToken = jwt_decode(token);
    const userProfile = decodedToken ? decodedToken.perfil : null;
    const isSuperuser = decodedToken ? decodedToken.is_superuser : false;
    
    if (decodedToken && decodedToken.username) { 
         const wel = document.getElementById('welcome-user');
         if(wel) wel.textContent = `Ol√°, ${decodedToken.username}`; 
    }

    if (!userProfile || !['Diretoria', 'Admin'].includes(userProfile) && !isSuperuser) {
        alert('Acesso negado.'); window.location.href = '/area-interna/';
    }

    // Vari√°veis Globais
    const API_GRUPOS = '/grupos/';
    const API_PERMISSOES = '/permissoes/';
    let todosUsuariosCache = [];
    let usuariosSelectCache = { data: [], timestamp: 0 };
    let gruposCache = { data: [], timestamp: 0 };
    let lideresCache = { data: [], timestamp: 0 }; // Cache para l√≠deres/supervisores
    let paginacaoAtual = { page: 1, total: 0, pages: 0 };
    const CACHE_DURATION = 5 * 60 * 1000; // 5 minutos
    const ITEMS_PER_PAGE = 20; // Corrigido: corresponde ao PAGE_SIZE da API (settings.py linha 183)
    let todasPermissoes = [];

    // Fun√ß√£o para enriquecer dados dos usu√°rios com nomes de perfis e usernames
    async function enriquecerDadosUsuarios(usuarios) {
        console.log('=== ENRIQUECENDO DADOS ===');
        console.log('Usu√°rios recebidos:', usuarios.length);

        // Carregar grupos se necess√°rio
        if (gruposCache.data.length === 0) {
            try {
                console.log('Carregando grupos da API...');
                const res = await apiFetch(API_GRUPOS);
                const grupos = Array.isArray(res) ? res : (res?.results || []);
                gruposCache.data = grupos;
                gruposCache.timestamp = Date.now();
                console.log('Grupos carregados:', grupos.length, 'grupos');
                console.log('Primeiro grupo:', grupos[0]);
            } catch (e) {
                console.error('Erro ao carregar grupos:', e);
            }
        } else {
            console.log('Usando grupos do cache:', gruposCache.data.length, 'grupos');
        }

        // Enriquecer cada usu√°rio com dados dos grupos
        return usuarios.map((user, index) => {
            const enrichedUser = { ...user };

            console.log(`\n--- Processando usu√°rio ${index + 1}: ${user.username || user.id} ---`);
            console.log('Groups original:', user.groups);

            // FOR√áAR perfil - tentar todas as possibilidades
            if (user.groups && user.groups.length > 0) {
                const groupId = typeof user.groups[0] === 'object' ? user.groups[0].id : user.groups[0];
                console.log('Procurando grupo com ID:', groupId);
                console.log('Grupos dispon√≠veis:', gruposCache.data.map(g => ({id: g.id, name: g.name})));

                const grupo = gruposCache.data.find(g => g.id == groupId);
                if (grupo && grupo.name) {
                    enrichedUser.perfil_nome = grupo.name;
                    console.log(`‚úÖ Perfil encontrado: ${grupo.name}`);
                } else {
                    console.log(`‚ùå Grupo n√£o encontrado para ID ${groupId}`);
                }
            } else {
                console.log('‚ö†Ô∏è Usu√°rio sem groups definido');
            }

            // Garantir que pelo menos algo apare√ßa como perfil
            if (!enrichedUser.perfil_nome) {
                enrichedUser.perfil_nome = 'Sem Perfil';
                console.log(`‚ö†Ô∏è Usando perfil padr√£o: Sem Perfil`);
            }

            console.log('Perfil final:', enrichedUser.perfil_nome);
            return enrichedUser;
        });
    }
    const perfilModal = new bootstrap.Modal(document.getElementById('perfilModal'));
    const excluirPerfilModal = new bootstrap.Modal(document.getElementById('excluirPerfilModal'));
    const userModal = new bootstrap.Modal(document.getElementById('userModal'));
    const userForm = document.getElementById('user-form');

    // --- FUN√á√ïES DE PERFIS ---
    async function carregarPerfis() {
        const tbody = document.getElementById('perfis-tabela-corpo');
        tbody.innerHTML = '<tr><td colspan="3" class="text-center py-3">Carregando...</td></tr>';
        try {
            const res = await apiFetch(API_GRUPOS);
            const grupos = Array.isArray(res) ? res : (res?.results || []);
            tbody.innerHTML = '';
            const selectMassa = document.getElementById('novo-perfil-massa');
            selectMassa.innerHTML = '<option value="">Alterar Perfil para...</option>';
            if(grupos.length === 0) { tbody.innerHTML = '<tr><td colspan="3">Nenhum perfil.</td></tr>'; return; }
            grupos.forEach(grupo => {
                const badges = grupo.permissions_details.map(p => `<span class=\"badge bg-info text-dark badge-perm\">${formatarNomePermissao(p.name)}</span>`).join('');
                selectMassa.add(new Option(grupo.name, grupo.id));
                tbody.innerHTML += `<tr><td class=\"fw-bold text-primary\">${grupo.name}</td><td>${badges || 'Sem permiss√µes'}</td><td class=\"text-end\"><button class=\"btn btn-xs btn-editar me-1\" onclick='editarPerfil(${JSON.stringify(grupo)})'><i class=\"bi bi-pencil\"></i></button><button class=\"btn btn-xs btn-excluir\" onclick=\"confirmarExclusaoPerfil(${grupo.id}, '${grupo.name}')\"><i class=\"bi bi-trash\"></i></button></td></tr>`;
            });
        } catch (e) { tbody.innerHTML = '<tr><td colspan="3">Erro ao carregar perfis.</td></tr>'; }
    }

    async function abrirModalPerfil(grupo = null) {
        document.getElementById('modal-perfil-titulo').textContent = grupo ? 'Editar Perfil' : 'Novo Perfil';
        document.getElementById('modal_perfil_id').value = grupo ? grupo.id : '';
        document.getElementById('modal_perfil_nome').value = grupo ? grupo.name : '';
        document.getElementById('filtro-permissoes').value = '';
        const container = document.getElementById('lista-permissoes');
        container.innerHTML = 'Carregando...';
        perfilModal.show();
        if (todasPermissoes.length === 0) { try { todasPermissoes = await apiFetch(API_PERMISSOES); } catch(e) { container.innerHTML = 'Erro'; return; } }
        renderizarListaPermissoes(grupo ? grupo.permissions : []);
    }
    
    function renderizarListaPermissoes(permsAtuais) {
        const container = document.getElementById('lista-permissoes');
        container.innerHTML = '';
        todasPermissoes.forEach(p => {
            const isChecked = permsAtuais.includes(p.id) ? 'checked' : '';
            container.innerHTML += `<div class="perm-item form-check"><input class="form-check-input" type="checkbox" value="${p.id}" id="perm-${p.id}" ${isChecked}><label class="form-check-label perm-label" for="perm-${p.id}">${formatarNomePermissao(p.name)}</label></div>`;
        });
    }

    window.editarPerfil = (grupo) => abrirModalPerfil(grupo);
    document.getElementById('btn-adicionar-perfil').onclick = () => abrirModalPerfil(null);

    async function salvarPerfil() {
        const id = document.getElementById('modal_perfil_id').value;
        const nome = document.getElementById('modal_perfil_nome').value;
        const perms = Array.from(document.querySelectorAll('#lista-permissoes input:checked')).map(el => parseInt(el.value));
        if (!nome) return alert('Nome obrigat√≥rio.');
        try {
            const method = id ? 'PATCH' : 'POST';
            const url = id ? `${API_GRUPOS}${id}/` : API_GRUPOS;
            await apiFetch(url, { method, body: JSON.stringify({ name: nome, permissions: perms }) });
            perfilModal.hide(); carregarPerfis();
        } catch (e) { alert('Erro ao salvar perfil.'); }
    }

    window.confirmarExclusaoPerfil = (id, nome) => { document.getElementById('id-perfil-excluir').value = id; document.getElementById('nome-perfil-excluir').textContent = nome; excluirPerfilModal.show(); };
    document.getElementById('btn-confirmar-exclusao-perfil').onclick = async () => { const id = document.getElementById('id-perfil-excluir').value; try { await apiFetch(`${API_GRUPOS}${id}/`, { method: 'DELETE' }); excluirPerfilModal.hide(); carregarPerfis(); } catch(e){ alert(e.message); } };
    function formatarNomePermissao(nome) { return nome.replace('Can view', 'Visualizar').replace('Can add', 'Adicionar').replace('Can change', 'Editar').replace('Can delete', 'Excluir').replace('Pode visualizar', 'Acesso a'); }

    // --- FUN√á√ïES DE USU√ÅRIOS ---
    
    // Fun√ß√£o para carregar cache de l√≠deres (supervisores)
    async function carregarCacheLideres() {
        const agora = Date.now();
        const CACHE_DURATION = 5 * 60 * 1000; // 5 minutos
        
        // Verificar se o cache ainda √© v√°lido
        if (lideresCache.data.length > 0 && (agora - lideresCache.timestamp) < CACHE_DURATION) {
            console.log('Usando cache de l√≠deres:', lideresCache.data.length, 'l√≠deres');
            return lideresCache.data;
        }
        
        try {
            console.log('Carregando l√≠deres do endpoint /usuarios/lideres...');
            const resLideres = await apiFetch('/usuarios/lideres/');
            const lideres = Array.isArray(resLideres) ? resLideres : [];
            
            // Criar um mapa para busca r√°pida por ID
            lideresCache.data = lideres;
            lideresCache.timestamp = agora;
            
            console.log('Cache de l√≠deres atualizado:', lideres.length, 'l√≠deres');
            return lideres;
        } catch (e) {
            console.warn('Erro ao carregar l√≠deres:', e);
            return lideresCache.data; // Retornar cache antigo se houver erro
        }
    }
    
    // Fun√ß√£o auxiliar para buscar username do supervisor (apenas username, n√£o nome completo)
    function buscarNomeSupervisor(supervisorId, userData = null) {
        if (!supervisorId) return '-';
        
        // Primeiro: verificar se o supervisor est√° nos dados do usu√°rio atual (mais r√°pido)
        if (userData && userData.supervisor_detalhe) {
            if (userData.supervisor_detalhe.username) {
                return userData.supervisor_detalhe.username;
            }
        }
        
        // Segundo: buscar no cache de l√≠deres (eficiente e sempre completo)
        const lider = lideresCache.data.find(l => l.id == supervisorId);
        if (lider) {
            // Priorizar username direto se dispon√≠vel
            if (lider.username) return lider.username;
            // Fallback: extrair username do nome_exibicao (formato: "Nome (username)" ou apenas "username")
            if (lider.nome_exibicao) {
                const match = lider.nome_exibicao.match(/\(([^)]+)\)$/);
                return match ? match[1] : lider.nome_exibicao;
            }
        }
        
        // Terceiro: buscar no cache completo de usu√°rios (fallback)
        const supervisorUser = todosUsuariosCache.find(u => u.id == supervisorId);
        if (supervisorUser && supervisorUser.username) {
            return supervisorUser.username;
        }
        
        return '-';
    }
    
    function mostrarListaUsuarios(status, btn) {
        document.getElementById('lista-status-titulo').textContent = status === 'ativos' ? 'Ativos' : 'Inativos';
        if(btn) { btn.parentElement.querySelectorAll('.btn').forEach(b => b.classList.remove('active', 'btn-outline-primary')); btn.classList.add('active', 'btn-outline-primary'); }
        // Limpar campo de busca ao trocar de aba
        const campoBusca = document.getElementById('busca-usuario');
        if (campoBusca) campoBusca.value = '';
        // Resetar para p√°gina 1 ao trocar de status
        paginacaoAtual.page = 1;
        carregarUsuarios(status, 1);
    }

    async function carregarUsuarios(status = 'ativos', page = 1) {
        try {
            // Tentar com pagina√ß√£o da API primeiro
            console.log('Tentando carregar com pagina√ß√£o da API, p√°gina:', page, 'status:', status);
            let res, dados, total;

            let todosUsuariosParaCache = [];

            try {
                res = await apiFetch(`/usuarios/?is_active=${status === 'ativos'}&page=${page}&page_size=${ITEMS_PER_PAGE}`);
                console.log('Resposta da API com pagina√ß√£o:', res);

                dados = Array.isArray(res) ? res : (res?.results || []);
                // IMPORTANTE: Usar o count da resposta paginada para calcular p√°ginas corretamente
                total = res?.count || (Array.isArray(res) ? res.length : dados.length);
                console.log('Total de usu√°rios (count):', total, 'Dados na p√°gina:', dados.length);

                // Se a API suporta pagina√ß√£o, precisamos carregar TODAS as p√°ginas para o cache
                // para poder buscar supervisores de qualquer p√°gina e fazer busca completa
                if (total > dados.length) {
                    console.log(`Carregando todas as p√°ginas para cache (total: ${total}, por p√°gina: ${dados.length})...`);
                    todosUsuariosParaCache = [...dados]; // Come√ßar com os dados da primeira p√°gina
                    
                    // Calcular quantas p√°ginas existem baseado no tamanho padr√£o da p√°gina (20)
                    const tamanhoPagina = dados.length || ITEMS_PER_PAGE;
                    const totalPages = Math.ceil(total / tamanhoPagina);
                    console.log(`Total de p√°ginas a carregar: ${totalPages} (${total} usu√°rios √∑ ${tamanhoPagina} por p√°gina)`);
                    
                    // Carregar todas as p√°ginas restantes
                    for (let p = 2; p <= totalPages; p++) {
                        try {
                            // Usar o mesmo page_size da primeira requisi√ß√£o para manter consist√™ncia
                            const resPage = await apiFetch(`/usuarios/?is_active=${status === 'ativos'}&page=${p}&page_size=${ITEMS_PER_PAGE}`);
                            const dadosPage = Array.isArray(resPage) ? resPage : (resPage?.results || []);
                            todosUsuariosParaCache = todosUsuariosParaCache.concat(dadosPage);
                            console.log(`P√°gina ${p} carregada: ${dadosPage.length} usu√°rios`);
                        } catch (e) {
                            console.warn(`Erro ao carregar p√°gina ${p}:`, e);
                        }
                    }
                    console.log(`Todos os usu√°rios carregados para cache: ${todosUsuariosParaCache.length} de ${total} esperados`);
                } else {
                    todosUsuariosParaCache = dados;
                }
            } catch (apiError) {
                console.warn('API n√£o suporta pagina√ß√£o, tentando carregar todos os usu√°rios com page_size grande:', apiError);
                // Fallback: tentar carregar todos de uma vez com page_size muito grande
                try {
                    res = await apiFetch(`/usuarios/?is_active=${status === 'ativos'}&page_size=1000`);
                    todosUsuariosParaCache = Array.isArray(res) ? res : (res?.results || []);
                    total = res?.count || todosUsuariosParaCache.length;
                    
                    // Simular pagina√ß√£o no frontend
                    const startIndex = (page - 1) * ITEMS_PER_PAGE;
                    const endIndex = startIndex + ITEMS_PER_PAGE;
                    dados = todosUsuariosParaCache.slice(startIndex, endIndex);
                    console.log(`Simulando pagina√ß√£o: mostrando ${dados.length} de ${total} usu√°rios (p√°gina ${page})`);
                } catch (e) {
                    console.error('Erro ao carregar usu√°rios:', e);
                    dados = [];
                    todosUsuariosParaCache = [];
                    total = 0;
                }
            }

            // ATUALIZAR CACHE COM TODOS OS USU√ÅRIOS (n√£o apenas da p√°gina atual)
            todosUsuariosCache = todosUsuariosParaCache;
            console.log('Cache atualizado com', todosUsuariosCache.length, 'usu√°rios');

            // Carregar cache de l√≠deres se necess√°rio (para garantir que todos os supervisores estejam dispon√≠veis)
            await carregarCacheLideres();

            console.log('Dados processados:', dados.length, 'usu√°rios mostrados, total:', total);

            // DEBUG: Mostrar estrutura real dos dados
            if (dados.length > 0) {
                console.log('=== ESTRUTURA DO PRIMEIRO USU√ÅRIO ===');
                console.log('Usu√°rio completo:', dados[0]);
                console.log('Campos dispon√≠veis:', Object.keys(dados[0]));
                console.log('Groups:', dados[0].groups);
                console.log('Supervisor:', dados[0].supervisor);
                console.log('Supervisor_username:', dados[0].supervisor_username);
                console.log('Supervisor_nome:', dados[0].supervisor_nome);
                console.log('=====================================');
            }

            if (dados.length === 0) {
                console.warn('Nenhum dado encontrado para /usuarios/?is_active=' + (status === 'ativos'));
            }

            // Atualizar informa√ß√µes de pagina√ß√£o
            paginacaoAtual = {
                page: page,
                total: total,
                pages: Math.ceil(total / ITEMS_PER_PAGE)
            };

            console.log('Pagina√ß√£o calculada:', paginacaoAtual);
            
            // Atualizar contador de usu√°rios
            const startItem = ((page - 1) * ITEMS_PER_PAGE) + 1;
            const endItem = Math.min(page * ITEMS_PER_PAGE, total);
            const contadorEl = document.getElementById('contador-usuarios');
            if (contadorEl) {
                contadorEl.textContent = `Mostrando ${startItem}-${endItem} de ${total} usu√°rio(s)`;
            }

            // Enriquecer dados com nomes de perfis
            const usuariosEnriquecidos = await enriquecerDadosUsuarios(dados);

            // DEBUG: Verificar se enriquecimento funcionou
            if (usuariosEnriquecidos.length > 0) {
                console.log('=== AP√ìS ENRIQUECIMENTO ===');
                console.log('Primeiro usu√°rio enriquecido:', usuariosEnriquecidos[0]);
                console.log('Perfil_nome:', usuariosEnriquecidos[0].perfil_nome);
                console.log('==========================');
            }

            renderizarTabelaUsuarios(usuariosEnriquecidos, status);

            // For√ßar cria√ß√£o da pagina√ß√£o ap√≥s um pequeno delay
            setTimeout(() => {
                console.log('=== TENTANDO RENDERIZAR PAGINA√á√ÉO ===');
                console.log('P√°ginas dispon√≠veis:', paginacaoAtual.pages);
                console.log('Total de usu√°rios:', paginacaoAtual.total);
                renderizarControlesPaginacao(status);
            }, 200);
        } catch (e) {
            document.getElementById('user-list-body').innerHTML = `<tr><td colspan="7">Erro: ${e.message}</td></tr>`;
        }
    }

    function renderizarControlesPaginacao(status) {
        console.log('=== RENDERIZANDO PAGINA√á√ÉO ===');
        console.log('Status:', status);
        console.log('P√°ginas:', paginacaoAtual.pages);
        console.log('Total:', paginacaoAtual.total);
        console.log('P√°gina atual:', paginacaoAtual.page);

        // FOR√áAR cria√ß√£o do container
        let container = document.getElementById('pagination-container');
        if (!container) {
            console.log('Container n√£o existe, criando...');
            const tabela = document.getElementById('tabela-usuarios');
            if (!tabela) {
                console.error('Tabela n√£o encontrada!');
                return;
            }

            // Procurar o card-body
            let cardBody = tabela.closest('.card-body');
            if (!cardBody) {
                // Tentar encontrar o table-responsive
                const tableWrapper = tabela.closest('.table-responsive');
                if (tableWrapper && tableWrapper.parentNode) {
                    cardBody = tableWrapper.parentNode;
                }
            }

            if (cardBody) {
                container = document.createElement('div');
                container.id = 'pagination-container';
                container.className = 'd-flex justify-content-center mt-3 mb-3';
                container.style.marginTop = '20px';
                container.style.padding = '15px';
                container.style.borderTop = '2px solid #dee2e6';
                container.style.backgroundColor = '#f8f9fa';

                // Inserir ap√≥s a tabela ou table-responsive
                const tableWrapper = tabela.closest('.table-responsive') || tabela;
                if (tableWrapper.nextSibling) {
                    cardBody.insertBefore(container, tableWrapper.nextSibling);
                } else {
                    cardBody.appendChild(container);
                }
                console.log('‚úÖ Container criado e inserido no DOM');
            } else {
                console.error('‚ùå N√£o foi poss√≠vel encontrar o card-body');
                return;
            }
        }

        // Calcular quantos usu√°rios est√£o sendo mostrados nesta p√°gina
        const startItem = ((paginacaoAtual.page - 1) * ITEMS_PER_PAGE) + 1;
        const endItem = Math.min(paginacaoAtual.page * ITEMS_PER_PAGE, paginacaoAtual.total);
        const showingText = `Mostrando ${startItem}-${endItem} de ${paginacaoAtual.total} usu√°rio(s)`;
        
        // SEMPRE mostrar informa√ß√£o de pagina√ß√£o
        if (paginacaoAtual.pages <= 1) {
            console.log('Apenas uma p√°gina, mostrando informa√ß√£o');
            container.innerHTML = `<div class="text-center text-muted small p-2">üìÑ P√°gina 1 de 1 - ${showingText}</div>`;
            container.style.display = 'block';
            container.style.visibility = 'visible';
            return;
        }

        console.log('‚úÖ Renderizando pagina√ß√£o com', paginacaoAtual.pages, 'p√°ginas');

        // PAGINA√á√ÉO SIMPLIFICADA E DIRETA
        let paginationHTML = '<nav><ul class="pagination justify-content-center">';

        // Bot√£o Anterior
        if (paginacaoAtual.page > 1) {
            paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="event.preventDefault(); carregarUsuarios('${status}', ${paginacaoAtual.page - 1});">‚óÄ Anterior</a></li>`;
        } else {
            paginationHTML += '<li class="page-item disabled"><span class="page-link">‚óÄ Anterior</span></li>';
        }

        // Mostrar p√°ginas pr√≥ximas (m√°ximo 7 p√°ginas)
        const total = paginacaoAtual.pages;
        const current = paginacaoAtual.page;
        const start = Math.max(1, current - 3);
        const end = Math.min(total, current + 3);

        // P√°gina 1 se necess√°rio
        if (start > 1) {
            paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="event.preventDefault(); carregarUsuarios('${status}', 1);">1</a></li>`;
            if (start > 2) paginationHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }

        // P√°ginas do meio
        for (let i = start; i <= end; i++) {
            if (i === current) {
                paginationHTML += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
            } else {
                paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="event.preventDefault(); carregarUsuarios('${status}', ${i});">${i}</a></li>`;
            }
        }

        // √öltima p√°gina se necess√°rio
        if (end < total) {
            if (end < total - 1) paginationHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="event.preventDefault(); carregarUsuarios('${status}', ${total});">${total}</a></li>`;
        }

        // Bot√£o Pr√≥ximo
        if (current < total) {
            paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="event.preventDefault(); carregarUsuarios('${status}', ${current + 1});">Pr√≥ximo ‚ñ∂</a></li>`;
        } else {
            paginationHTML += '<li class="page-item disabled"><span class="page-link">Pr√≥ximo ‚ñ∂</span></li>';
        }

        paginationHTML += '</ul></nav>';

        // Adicionar informa√ß√µes com contador
        const startItem = ((current - 1) * ITEMS_PER_PAGE) + 1;
        const endItem = Math.min(current * ITEMS_PER_PAGE, paginacaoAtual.total);
        paginationHTML += `<div class="text-center mt-2 text-muted small">P√°gina ${current} de ${total} - Mostrando ${startItem}-${endItem} de ${paginacaoAtual.total} usu√°rio(s)</div>`;

        container.innerHTML = paginationHTML;
        container.style.display = 'block';
        container.style.visibility = 'visible';
        container.style.opacity = '1';
        console.log('‚úÖ Pagina√ß√£o renderizada com sucesso');
        console.log('Container vis√≠vel:', container.style.display);
        console.log('Container HTML:', container.innerHTML.substring(0, 200));
    }

    // Fun√ß√£o global para debug - for√ßar renderiza√ß√£o da pagina√ß√£o
    window.debugPaginacao = function() {
        console.log('=== DEBUG PAGINA√á√ÉO ===');
        console.log('P√°ginas:', paginacaoAtual);
        console.log('Container existe?', !!document.getElementById('pagination-container'));
        renderizarControlesPaginacao('ativos');
    };

    // Fun√ß√£o global para debug - mostrar estrutura dos dados
    window.debugUsuarios = function() {
        console.log('=== DEBUG USU√ÅRIOS ===');
        console.log('Cache de usu√°rios:', todosUsuariosCache.length);
        if (todosUsuariosCache.length > 0) {
            console.log('Primeiro usu√°rio:', todosUsuariosCache[0]);
            console.log('Campos:', Object.keys(todosUsuariosCache[0]));
        }
        console.log('Cache de grupos:', gruposCache.data.length);
        if (gruposCache.data.length > 0) {
            console.log('Primeiro grupo:', gruposCache.data[0]);
        }
    };

    function renderizarTabelaUsuarios(lista, status) {
        const userListBody = document.getElementById('user-list-body');
        const isAtivos = status === 'ativos';
        const headerRow = document.getElementById('user-list-header');

        // Otimizar renderiza√ß√£o do header
        headerRow.innerHTML = isAtivos
            ? `<th style="width: 40px;"><input type="checkbox" id="check-all" onclick="toggleTodos(this)"></th><th>Nome</th><th>E-mail</th><th>Perfil</th><th>Canal</th><th>L√≠der</th><th class="text-end">A√ß√µes</th>`
            : `<th>Nome</th><th>E-mail</th><th>Perfil</th><th>Canal</th><th class="text-end">A√ß√µes</th>`;

        if (!lista.length) {
            userListBody.innerHTML = '<tr><td colspan="7">Nenhum usu√°rio.</td></tr>';
            return;
        }

        // Otimizar renderiza√ß√£o usando documentFragment
        const fragment = document.createDocumentFragment();
        const colunas = isAtivos ? 7 : 5;

        lista.forEach(user => {
            const row = document.createElement('tr');

            if (isAtivos) {
                const checkCell = document.createElement('td');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'user-check';
                checkbox.value = user.id;
                checkCell.appendChild(checkbox);
                row.appendChild(checkCell);
            }

            // Nome completo
            const nomeCell = document.createElement('td');
            nomeCell.textContent = user.nome_completo;
            row.appendChild(nomeCell);

            // Email
            const emailCell = document.createElement('td');
            emailCell.textContent = user.email;
            row.appendChild(emailCell);

            // PERFIL - SIMPLIFICADO
            const perfilCell = document.createElement('td');

            let perfilNome = user.perfil_nome || 'Usu√°rio';

            if (!user.perfil_nome && user.groups && user.groups.length > 0) {
                const groupId = user.groups[0]?.id || user.groups[0];
                const grupo = gruposCache.data.find(g => g.id == groupId);
                if (grupo && grupo.name) {
                    perfilNome = grupo.name;
                    user.perfil_nome = grupo.name; // Cache no usu√°rio
                }
            }

            perfilCell.textContent = perfilNome;
            row.appendChild(perfilCell);

            // Canal
            const canalCell = document.createElement('td');
            canalCell.textContent = user.canal || '-';
            row.appendChild(canalCell);

            if (isAtivos) {
                // SUPERVISOR/USERNAME - BUSCAR NO CACHE DE L√çDERES
                const liderCell = document.createElement('td');
                let supervisorNome = '-';

                if (user.supervisor) {
                    // Extrair ID do supervisor (pode ser objeto ou n√∫mero)
                    let supervisorId = null;
                    if (typeof user.supervisor === 'object' && user.supervisor !== null) {
                        supervisorId = user.supervisor.id || user.supervisor.pk;
                    } else {
                        supervisorId = user.supervisor;
                    }

                    if (supervisorId) {
                        // Usar fun√ß√£o auxiliar que busca no cache de l√≠deres, passando tamb√©m os dados do usu√°rio
                        supervisorNome = buscarNomeSupervisor(supervisorId, user);
                    }
                }

                liderCell.textContent = supervisorNome;
                row.appendChild(liderCell);
            }

            // A√ß√µes
            const acoesCell = document.createElement('td');
            acoesCell.className = 'text-end';

            if (isAtivos) {
                const btnEditar = document.createElement('button');
                btnEditar.className = 'btn btn-xs btn-editar me-1';
                btnEditar.innerHTML = '<i class="bi bi-pencil"></i>';
                btnEditar.onclick = () => editarUsuarioPeloId(user.id);

                const btnExcluir = document.createElement('button');
                btnExcluir.className = 'btn btn-xs btn-excluir';
                btnExcluir.innerHTML = '<i class="bi bi-trash"></i>';
                btnExcluir.onclick = () => inativarUsuario(user.id);

                acoesCell.appendChild(btnEditar);
                acoesCell.appendChild(btnExcluir);
            } else {
                const btnReativar = document.createElement('button');
                btnReativar.className = 'btn btn-xs btn-outline-success';
                btnReativar.innerHTML = '<i class="bi bi-check-circle"></i>';
                btnReativar.onclick = () => reativarUsuario(user.id);
                acoesCell.appendChild(btnReativar);
            }

            row.appendChild(acoesCell);
            fragment.appendChild(row);
        });

        userListBody.innerHTML = '';
        userListBody.appendChild(fragment);
    }

    async function filtrarUsuarios() {
        const termoBusca = document.getElementById('busca-usuario').value.toLowerCase().trim();
        const statusAtual = document.getElementById('lista-status-titulo').textContent.includes('Ativos') ? 'ativos' : 'inativos';
        const isAtivos = statusAtual === 'ativos';

        if (!termoBusca) {
            // Se n√£o h√° busca, recarregar a p√°gina atual
            carregarUsuarios(statusAtual, paginacaoAtual.page);
            return;
        }

        // Verificar se o cache est√° carregado
        if (todosUsuariosCache.length === 0) {
            console.log('Cache vazio, carregando usu√°rios primeiro...');
            await carregarUsuarios(statusAtual, 1);
            // Aguardar um pouco para garantir que o cache foi atualizado
            await new Promise(resolve => setTimeout(resolve, 500));
        }

        // Filtrar usando o cache local (mais r√°pido e eficiente)
        let usuariosFiltrados = todosUsuariosCache.filter(user => {
            // Verificar se o usu√°rio corresponde ao status atual
            if (user.is_active !== isAtivos) {
                return false;
            }

            // Buscar em m√∫ltiplos campos
            const nomeCompleto = (user.nome_completo || '').toLowerCase();
            const username = (user.username || '').toLowerCase();
            const email = (user.email || '').toLowerCase();
            const cpf = (user.cpf || '').toLowerCase();
            const perfilNome = (user.perfil_nome || '').toLowerCase();
            
            // Buscar nome do supervisor
            let supervisorNome = '';
            if (user.supervisor) {
                const supervisorId = typeof user.supervisor === 'object' && user.supervisor !== null 
                    ? (user.supervisor.id || user.supervisor.pk) 
                    : user.supervisor;
                if (supervisorId) {
                    supervisorNome = buscarNomeSupervisor(supervisorId, user).toLowerCase();
                }
            }

            // Verificar se o termo de busca est√° em algum campo
            return nomeCompleto.includes(termoBusca) ||
                   username.includes(termoBusca) ||
                   email.includes(termoBusca) ||
                   cpf.includes(termoBusca) ||
                   perfilNome.includes(termoBusca) ||
                   supervisorNome.includes(termoBusca);
        });

        // Enriquecer dados com nomes de perfis e supervisores
        try {
            const usuariosEnriquecidos = await enriquecerDadosUsuarios(usuariosFiltrados);
            
            // Renderizar apenas os resultados filtrados (sem pagina√ß√£o na busca)
            renderizarTabelaUsuarios(usuariosEnriquecidos, statusAtual);
            
            // Atualizar informa√ß√µes de pagina√ß√£o para mostrar que est√° em modo busca
            const totalFiltrados = usuariosFiltrados.length;
            paginacaoAtual = {
                page: 1,
                total: totalFiltrados,
                pages: 1
            };
            
            // Atualizar contador de usu√°rios (modo busca)
            const contadorEl = document.getElementById('contador-usuarios');
            if (contadorEl) {
                contadorEl.textContent = `Busca: ${totalFiltrados} resultado(s) encontrado(s)`;
            }
            
            // Atualizar controles de pagina√ß√£o
            renderizarControlesPaginacao(statusAtual);
            
            console.log(`Busca realizada: ${totalFiltrados} usu√°rio(s) encontrado(s) para "${termoBusca}"`);
        } catch (e) {
            console.error('Erro ao filtrar usu√°rios:', e);
            document.getElementById('user-list-body').innerHTML = `<tr><td colspan="7">Erro ao filtrar: ${e.message}</td></tr>`;
        }
    }

    function editarUsuarioPeloId(id) { const user = todosUsuariosCache.find(u => u.id === id); if (user) abrirModalUsuario(user); }
    window.toggleTodos = (s) => document.querySelectorAll('.user-check').forEach(c => c.checked = s.checked);
    window.aplicarMudancaPerfilEmMassa = async () => { 
        const novoPerfil = document.getElementById('novo-perfil-massa').value;
        const ids = Array.from(document.querySelectorAll('.user-check:checked')).map(c => c.value);
        if (!novoPerfil || !ids.length) return alert('Selecione perfil e usu√°rios.');
        for (const uid of ids) await apiFetch(`/usuarios/${uid}/`, { method: 'PATCH', body: JSON.stringify({ groups: [parseInt(novoPerfil)] }) });
        // Invalidar cache de usu√°rios ap√≥s mudan√ßa de perfil
        todosUsuariosCache = [];
        lideresCache = { data: [], timestamp: 0 }; // Limpar cache de l√≠deres tamb√©m
        alert('Atualizado.');
        const statusAtual = document.getElementById('lista-status-titulo').textContent.includes('Ativos') ? 'ativos' : 'inativos';
        carregarUsuarios(statusAtual, paginacaoAtual.page); 
    };

    async function abrirModalUsuario(user = null) {
        console.log('Abrindo modal de usu√°rio...');
        document.getElementById('user-form').reset();
        document.getElementById('user_id').value = user ? user.id : '';
        document.getElementById('userModalTitle').textContent = user ? 'Editar Usu√°rio' : 'Novo Usu√°rio';
        
        // Carregar dados ANTES de mostrar o modal
        try {
            await carregarDadosParaFormulario();
            console.log('Dados do formul√°rio carregados');
        } catch (e) {
            console.error('Erro ao carregar dados:', e);
        }
        
        if (user) {
            document.getElementById('nome_completo').value = user.nome_completo || '';
            document.getElementById('cpf').value = user.cpf || '';
            document.getElementById('email').value = user.email || '';
            document.getElementById('tel_whatsapp').value = user.tel_whatsapp || '';
            document.getElementById('usuario_login').value = user.username || '';
            if (user.groups && user.groups.length > 0) {
                const groupId = typeof user.groups[0] === 'object' ? user.groups[0].id : user.groups[0];
                document.getElementById('perfil_id').value = groupId || '';
            }
            // Extrair ID do supervisor (pode ser objeto ou n√∫mero)
            let supervisorId = '';
            if (user.supervisor) {
                if (typeof user.supervisor === 'object' && user.supervisor !== null) {
                    supervisorId = user.supervisor.id || user.supervisor.pk || '';
                } else {
                    supervisorId = user.supervisor;
                }
            }
            document.getElementById('supervisor_id').value = supervisorId;
            document.getElementById('user_canal').value = user.canal || 'PAP';
            document.getElementById('user_cluster').value = user.cluster || '';
            document.getElementById('participa_controle_presenca').checked = user.participa_controle_presenca;
            ['valor_almoco', 'valor_passagem', 'chave_pix', 'nome_da_conta', 'meta_comissao', 'desconto_boleto', 'desconto_inclusao_viabilidade', 'desconto_instalacao_antecipada', 'adiantamento_cnpj', 'desconto_inss_fixo'].forEach(id => { document.getElementById(id).value = user[id] || ''; });
        }
        
        // Pequeno delay para garantir que os selects foram populados
        setTimeout(() => {
            userModal.show();
            console.log('Modal exibido');
        }, 100);
    }

    async function carregarDadosParaFormulario() {
        const pSelect = document.getElementById('perfil_id');
        const sSelect = document.getElementById('supervisor_id');
        
        if (!pSelect || !sSelect) {
            console.error('Selects n√£o encontrados!');
            return;
        }

        pSelect.innerHTML = '<option value="">Carregando...</option>';
        sSelect.innerHTML = '<option value="">Carregando...</option>';

        try {
            const agora = Date.now();

            // Cache para grupos (perfis)
            let grupos;
            if (!pSelect._gruposCache || (agora - (pSelect._gruposTimestamp || 0)) > CACHE_DURATION) {
                console.log('Carregando grupos para o formul√°rio...');
                const resGrupos = await apiFetch(API_GRUPOS);
                grupos = Array.isArray(resGrupos) ? resGrupos : (resGrupos?.results || []);
                pSelect._gruposCache = grupos;
                pSelect._gruposTimestamp = agora;
                console.log('Grupos carregados:', grupos.length);
            } else {
                grupos = pSelect._gruposCache;
                console.log('Usando grupos do cache:', grupos.length);
            }

            pSelect.innerHTML = '<option value="">Selecione um perfil</option>';
            if (grupos && grupos.length > 0) {
                grupos.forEach(g => {
                    if (g && g.name && g.id) {
                        pSelect.add(new Option(g.name, g.id));
                    }
                });
            } else {
                pSelect.innerHTML = '<option value="">Nenhum perfil dispon√≠vel</option>';
            }

            // Carregar cache de l√≠deres se necess√°rio
            await carregarCacheLideres();
            
            // Usar cache de l√≠deres para o dropdown (mais eficiente e sempre completo)
            sSelect.innerHTML = '<option value="">Nenhum</option>';
            if (lideresCache.data && lideresCache.data.length > 0) {
                lideresCache.data.forEach(l => {
                    if (l && l.id) {
                        const nomeExibicao = l.nome_exibicao || l.username || '-';
                        sSelect.add(new Option(nomeExibicao, l.id));
                    }
                });
                console.log('Dropdown de supervisores populado com', lideresCache.data.length, 'l√≠deres');
            } else {
                // Fallback: usar cache de usu√°rios se l√≠deres n√£o estiver dispon√≠vel
                let usuarios;
                if (todosUsuariosCache.length > 0 && (agora - (todosUsuariosCache._timestamp || 0)) < CACHE_DURATION) {
                    usuarios = todosUsuariosCache.filter(u => u.is_active !== false);
                    console.log('Usando usu√°rios do cache para select (fallback):', usuarios.length);
                } else {
                    console.log('Carregando usu√°rios para o select (fallback)...');
                    const resUsuarios = await apiFetch('/usuarios/?is_active=true');
                    usuarios = Array.isArray(resUsuarios) ? resUsuarios : (resUsuarios?.results || []);
                    console.log('Usu√°rios carregados:', usuarios.length);
                }
                
                if (usuarios && usuarios.length > 0) {
                    usuarios.forEach(u => {
                        if (u && u.username && u.id) {
                            sSelect.add(new Option(u.username, u.id));
                        }
                    });
                } else {
                    sSelect.innerHTML = '<option value="">Nenhum usu√°rio dispon√≠vel</option>';
                }
            }

            console.log('‚úÖ Dropdowns carregados com sucesso');
        } catch (e) {
            console.error('Erro ao carregar dados do formul√°rio:', e);
            pSelect.innerHTML = '<option value="">Erro ao carregar</option>';
            sSelect.innerHTML = '<option value="">Erro ao carregar</option>';
        }
    }

    userForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const id = document.getElementById('user_id').value;
        const nomeCompleto = document.getElementById('nome_completo').value.trim();
        const parts = nomeCompleto.split(' ');
        
        // Fun√ß√£o auxiliar para converter string vazia em null ou n√∫mero
        const cleanValue = (val, isNumber = false) => {
            if (!val || val === '') return null;
            if (isNumber) {
                const num = parseFloat(val);
                return isNaN(num) ? null : num;
            }
            return val;
        };
        
        const supervisorValue = document.getElementById('supervisor_id').value;
        const body = {
            first_name: parts.shift() || '',
            last_name: parts.join(' ') || '',
            cpf: cleanValue(document.getElementById('cpf').value),
            email: document.getElementById('email').value,
            tel_whatsapp: cleanValue(document.getElementById('tel_whatsapp').value),
            username: document.getElementById('usuario_login').value,
            supervisor: supervisorValue ? parseInt(supervisorValue) : null,
            canal: document.getElementById('user_canal').value,
            cluster: cleanValue(document.getElementById('user_cluster').value),
            groups: document.getElementById('perfil_id').value ? [parseInt(document.getElementById('perfil_id').value)] : [],
            valor_almoco: cleanValue(document.getElementById('valor_almoco').value, true),
            valor_passagem: cleanValue(document.getElementById('valor_passagem').value, true),
            chave_pix: cleanValue(document.getElementById('chave_pix').value),
            nome_da_conta: cleanValue(document.getElementById('nome_da_conta').value),
            meta_comissao: cleanValue(document.getElementById('meta_comissao').value, true),
            desconto_boleto: cleanValue(document.getElementById('desconto_boleto').value, true),
            desconto_inclusao_viabilidade: cleanValue(document.getElementById('desconto_inclusao_viabilidade').value, true),
            desconto_instalacao_antecipada: cleanValue(document.getElementById('desconto_instalacao_antecipada').value, true),
            adiantamento_cnpj: cleanValue(document.getElementById('adiantamento_cnpj').value, true),
            desconto_inss_fixo: cleanValue(document.getElementById('desconto_inss_fixo').value, true),
            participa_controle_presenca: document.getElementById('participa_controle_presenca').checked
        };
        
        const senha = document.getElementById('senha').value;
        if (senha && senha.trim()) {
            body.password = senha.trim();
        }
        
        try { 
            await apiFetch(id ? `/usuarios/${id}/` : '/usuarios/', { method: id ? 'PUT' : 'POST', body: JSON.stringify(body) });
            // Invalidar cache ap√≥s salvar usu√°rio
            todosUsuariosCache = [];
            lideresCache = { data: [], timestamp: 0 }; // Limpar cache de l√≠deres tamb√©m
            userModal.hide();
            const statusAtual = document.getElementById('lista-status-titulo').textContent.includes('Ativos') ? 'ativos' : 'inativos';
            carregarUsuarios(statusAtual, paginacaoAtual.page);
        } catch (e) { 
            console.error('Erro ao salvar usu√°rio:', e);
            alert(`Erro: ${e.message}`); 
        }
    });

    async function inativarUsuario(id) {
        if(confirm('Inativar?')) {
            await apiFetch(`/usuarios/${id}/`, { method: 'DELETE' });
            const statusAtual = document.getElementById('lista-status-titulo').textContent.includes('Ativos') ? 'ativos' : 'inativos';
            carregarUsuarios(statusAtual, paginacaoAtual.page);
        }
    }
    async function reativarUsuario(id) {
        if(confirm('Reativar?')) {
            await apiFetch(`/usuarios/${id}/reativar/`, { method: 'PUT' });
            const statusAtual = document.getElementById('lista-status-titulo').textContent.includes('Ativos') ? 'ativos' : 'inativos';
            carregarUsuarios(statusAtual, paginacaoAtual.page);
        }
    }

    // --- CADASTROS GERAIS ---
    async function carregarOperadoras() {
        const res = await apiFetch('/crm/operadoras/');
        const lista = Array.isArray(res) ? res : (res?.results || []);
        const tbody = document.getElementById('lista-operadoras'); tbody.innerHTML = '';
        const selPlanos = document.getElementById('plano_operadora_id'); selPlanos.innerHTML = '<option value="">Selecione...</option>';
        lista.forEach(o => {
            tbody.innerHTML += `<tr><td>${o.nome}</td><td>${o.cnpj || '-'}</td><td>${o.ativo?'Ativo':'Inativo'}</td><td><button class="btn btn-sm btn-editar me-1" onclick='editarOperadora(${JSON.stringify(o)})'>‚úèÔ∏è</button><button class="btn btn-sm btn-excluir" onclick="excluirOperadora(${o.id})">üóëÔ∏è</button></td></tr>`;
            if(o.ativo) selPlanos.add(new Option(o.nome, o.id));
        });
    }
    document.getElementById('form-operadora').onsubmit = async(e) => {
        e.preventDefault();
        const id = document.getElementById('operadora_id').value;
        const body = { nome: document.getElementById('operadora_nome').value, cnpj: document.getElementById('operadora_cnpj').value, ativo: document.getElementById('operadora_status').value == '1' };
        await apiFetch(id ? `/crm/operadoras/${id}/` : '/crm/operadoras/', {method: id?'PUT':'POST', body: JSON.stringify(body)});
        document.getElementById('form-operadora').reset(); document.getElementById('operadora_id').value=''; carregarOperadoras();
    };
    window.editarOperadora = (o) => { document.getElementById('operadora_id').value=o.id; document.getElementById('operadora_nome').value=o.nome; document.getElementById('operadora_cnpj').value=o.cnpj; document.getElementById('operadora_status').value = o.ativo ? '1' : '0'; };
    window.excluirOperadora = async (id) => { if(confirm('Excluir?')) { await apiFetch(`/crm/operadoras/${id}/`, {method:'DELETE'}); carregarOperadoras(); } };

    async function carregarPlanos() {
        const res = await apiFetch('/crm/planos/');
        const lista = Array.isArray(res) ? res : (res?.results || []);
        const tbody = document.getElementById('lista-planos'); tbody.innerHTML = '';
        lista.forEach(p => {
            tbody.innerHTML += `<tr><td>${p.nome}</td><td>${p.operadora_nome || '-'}</td><td>${fmtMoeda(p.valor)}</td><td>${fmtMoeda(p.comissao)}</td><td><button class="btn btn-sm btn-editar me-1" onclick='editarPlano(${JSON.stringify(p)})'>‚úèÔ∏è</button><button class="btn btn-sm btn-excluir" onclick="excluirPlano(${p.id})">üóëÔ∏è</button></td></tr>`;
        });
    }
    document.getElementById('form-plano').onsubmit = async(e) => {
        e.preventDefault();
        const id = document.getElementById('plano_id').value;
        const body = { nome: document.getElementById('plano_nome').value, valor: document.getElementById('plano_valor').value, comissao: document.getElementById('plano_comissao').value, operadora: document.getElementById('plano_operadora_id').value, ativo: true };
        await apiFetch(id ? `/crm/planos/${id}/` : '/crm/planos/', {method: id?'PUT':'POST', body: JSON.stringify(body)});
        document.getElementById('form-plano').reset(); document.getElementById('plano_id').value=''; carregarPlanos();
    };
    window.editarPlano = (p) => { document.getElementById('plano_id').value = p.id; document.getElementById('plano_nome').value = p.nome; document.getElementById('plano_valor').value = p.valor; document.getElementById('plano_comissao').value = p.comissao; document.getElementById('plano_operadora_id').value = p.operadora; };
    window.excluirPlano = async (id) => { if(confirm('Excluir?')) { await apiFetch(`/crm/planos/${id}/`, {method:'DELETE'}); carregarPlanos(); } };

    async function carregarFormasPagamento() {
        const res = await apiFetch('/crm/formas-pagamento/');
        const lista = Array.isArray(res) ? res : (res?.results || []);
        const ul = document.getElementById('lista-formas-pagamento'); ul.innerHTML = '';
        lista.forEach(f => ul.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center">${f.nome} <div class="d-flex gap-2"><button class="btn btn-sm btn-editar" onclick="editarFormaPagamento(${f.id}, '${f.nome}')"><i class="bi bi-pencil"></i></button><button class="btn btn-sm btn-excluir" onclick="excluirFormaPagamento(${f.id})"><i class="bi bi-trash"></i></button></div></li>`);
    }
    window.editarFormaPagamento = async(id, nome) => {
        const novoNome = prompt('Novo nome:', nome);
        if(novoNome && novoNome !== nome) {
            await apiFetch(`/crm/formas-pagamento/${id}/`, {method:'PATCH', body:JSON.stringify({nome: novoNome})});
            carregarFormasPagamento();
        }
    };
    document.getElementById('btn-salvar-forma-pagamento').onclick = async () => {
        const nome = document.getElementById('nova-forma-pagamento-nome').value;
        if(nome) await apiFetch('/crm/formas-pagamento/', {method:'POST', body:JSON.stringify({nome, ativo:true})});
        document.getElementById('nova-forma-pagamento-nome').value=''; carregarFormasPagamento();
    };
    window.excluirFormaPagamento = async(id)=>{ if(confirm('Excluir?')) { await apiFetch(`/crm/formas-pagamento/${id}/`, {method:'DELETE'}); carregarFormasPagamento(); } };

    let listaStatusGlobal = [];
    async function carregarStatus() {
        const res = await apiFetch('/crm/status/');
        const lista = Array.isArray(res) ? res : (res?.results || []);
        listaStatusGlobal = lista;
        const tbody = document.getElementById('lista-status'); tbody.innerHTML = '';
        lista.forEach(s => tbody.innerHTML += `<tr><td>${s.nome}</td><td>${s.tipo}</td><td>${s.estado||'-'}</td><td><span class="badge" style="background:${s.cor};color:#000">${s.cor}</span></td><td class="text-end"><button class="btn btn-sm btn-editar me-1" onclick="editarStatus(${s.id})"><i class="bi bi-pencil"></i></button><button class="btn btn-sm btn-excluir" onclick="excluirStatus(${s.id})"><i class="bi bi-trash"></i></button></td></tr>`);
    }
    window.editarStatus = (id) => {
        const s = listaStatusGlobal.find(item => item.id === id);
        if(!s) return;
        document.getElementById('status_id').value = s.id;
        document.getElementById('status_nome').value = s.nome;
        document.getElementById('status_tipo').value = s.tipo;
        document.getElementById('status_estado').value = s.estado || '';
        document.getElementById('status_cor').value = s.cor;
        document.getElementById('status').scrollIntoView({behavior:'smooth'});
    };
    document.getElementById('form-status').onsubmit = async(e) => {
        e.preventDefault();
        const id = document.getElementById('status_id').value;
        const body = { nome: document.getElementById('status_nome').value, tipo: document.getElementById('status_tipo').value, estado: document.getElementById('status_estado').value, cor: document.getElementById('status_cor').value };
        if(id) {
            await apiFetch(`/crm/status/${id}/`, {method:'PATCH', body: JSON.stringify(body)});
        } else {
            await apiFetch('/crm/status/', {method:'POST', body: JSON.stringify(body)});
        }
        document.getElementById('form-status').reset(); carregarStatus();
    };
    window.excluirStatus = async(id)=>{ if(confirm('Excluir?')) { await apiFetch(`/crm/status/${id}/`, {method:'DELETE'}); carregarStatus(); } };

    let listaPendenciasGlobal = [];
    async function carregarMotivosPendencia() {
        const res = await apiFetch('/crm/motivos-pendencia/');
        const lista = Array.isArray(res) ? res : (res?.results || []);
        listaPendenciasGlobal = lista;
        const tbody = document.getElementById('lista-pendencias'); tbody.innerHTML = '';
        lista.forEach(p => tbody.innerHTML += `<tr><td>${p.nome}</td><td>${p.tipo_pendencia}</td><td class="text-end"><button class="btn btn-sm btn-editar me-1" onclick="editarPendencia(${p.id})"><i class="bi bi-pencil"></i></button><button class="btn btn-sm btn-excluir" onclick="excluirPendencia(${p.id})"><i class="bi bi-trash"></i></button></td></tr>`);
    }
    window.editarPendencia = (id) => {
        const p = listaPendenciasGlobal.find(item => item.id === id);
        if(!p) return;
        document.getElementById('pendencia_id').value = p.id;
        document.getElementById('pendencia_nome').value = p.nome;
        document.getElementById('pendencia_tipo').value = p.tipo_pendencia;
        document.getElementById('pendencias').scrollIntoView({behavior:'smooth'});
    };
    document.getElementById('form-pendencia').onsubmit = async(e) => {
        e.preventDefault();
        const id = document.getElementById('pendencia_id').value;
        const body = { nome: document.getElementById('pendencia_nome').value, tipo_pendencia: document.getElementById('pendencia_tipo').value };
        if(id) {
            await apiFetch(`/crm/motivos-pendencia/${id}/`, {method:'PATCH', body: JSON.stringify(body)});
        } else {
            await apiFetch('/crm/motivos-pendencia/', {method:'POST', body: JSON.stringify(body)});
        }
        document.getElementById('form-pendencia').reset(); carregarMotivosPendencia();
    };
    window.excluirPendencia = async(id)=>{ if(confirm('Excluir?')) { await apiFetch(`/crm/motivos-pendencia/${id}/`, {method:'DELETE'}); carregarMotivosPendencia(); } };

    async function carregarRegrasComissao() {
        const [resRegras, resPlanos, resUsers] = await Promise.all([apiFetch('/crm/regras-comissao/'), apiFetch('/crm/planos/'), apiFetch('/usuarios/?is_active=true')]);
        const regras = Array.isArray(resRegras) ? resRegras : (resRegras?.results || []);
        const planos = Array.isArray(resPlanos) ? resPlanos : (resPlanos?.results || []);
        const users = Array.isArray(resUsers) ? resUsers : (resUsers?.results || []);
        const selPlanos = document.getElementById('regra_plano_id'); selPlanos.innerHTML = '<option value="">Selecione...</option>';
        const selUsers = document.getElementById('regra_consultor_id'); selUsers.innerHTML = '<option value="">Todos</option>';
        planos.forEach(p => selPlanos.add(new Option(p.nome, p.id)));
        users.forEach(u => selUsers.add(new Option(u.nome_completo, u.id)));
        const tbody = document.getElementById('lista-regras-comissao'); tbody.innerHTML = '';
        regras.forEach(r => tbody.innerHTML += `<tr><td>${r.consultor_nome||'TODOS'}</td><td>${r.plano_nome}</td><td>${r.tipo_venda}</td><td>${r.tipo_cliente}</td><td>${r.valor_base}</td><td>${r.valor_acelerado}</td><td><button class="btn btn-sm btn-warning me-1" onclick='editarRegra(${JSON.stringify(r)})'>‚úèÔ∏è</button><button class="btn btn-sm btn-danger" onclick="excluirRegra(${r.id})">üóëÔ∏è</button></td></tr>`);
    }
    document.getElementById('form-regra-comissao').onsubmit = async(e) => {
        e.preventDefault();
        const id = document.getElementById('regra_comissao_id').value;
        const body = { consultor: document.getElementById('regra_consultor_id').value || null, plano: document.getElementById('regra_plano_id').value, tipo_venda: document.getElementById('regra_tipo_venda').value, tipo_cliente: document.getElementById('regra_tipo_cliente').value, valor_base: document.getElementById('regra_valor_base').value, valor_acelerado: document.getElementById('regra_valor_acelerado').value };
        await apiFetch(id ? `/crm/regras-comissao/${id}/` : '/crm/regras-comissao/', {method: id?'PUT':'POST', body: JSON.stringify(body)});
        carregarRegrasComissao(); resetFormRegraComissao();
    };
    function resetFormRegraComissao() { document.getElementById('form-regra-comissao').reset(); document.getElementById('regra_comissao_id').value = ''; }
    window.editarRegra = (r) => { document.getElementById('regra_comissao_id').value = r.id; document.getElementById('regra_consultor_id').value = r.consultor || ""; document.getElementById('regra_plano_id').value = r.plano; document.getElementById('regra_tipo_venda').value = r.tipo_venda; document.getElementById('regra_tipo_cliente').value = r.tipo_cliente; document.getElementById('regra_valor_base').value = r.valor_base; document.getElementById('regra_valor_acelerado').value = r.valor_acelerado; document.getElementById('form-regra-comissao').scrollIntoView({ behavior: 'smooth' }); };
    window.excluirRegra = async(id) => { if(confirm('Excluir?')) { await apiFetch(`/crm/regras-comissao/${id}/`, {method:'DELETE'}); carregarRegrasComissao(); } };

    async function carregarConfigMensal() {
        const inputMes = document.getElementById('select_mes_config').value;
        if(!inputMes) return;
        const [ano, mes] = inputMes.split('-');
        const container = document.getElementById('form-container-config-mensal');
        container.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Carregando status...';
        try {
            const dados = await apiFetch(`/crm/comissionamento/?ano=${ano}&mes=${mes}`);
            const statusMes = dados.status || 'Aberto';
            const totalPago = dados.total_pagar || 0;
            let html = `<div class="d-flex justify-content-between align-items-center"><div>Status: <strong>${statusMes.toUpperCase()}</strong></div><div>Total Pago/Previsto: <strong>${fmtMoeda(totalPago)}</strong></div></div><hr>`;
            if (statusMes === 'Fechado') {
                html += `<button class="btn btn-warning w-100" onclick="acaoConfigMensal('reabrir', ${ano}, ${mes})">Reabrir M√™s (Permite Edi√ß√£o)</button>`;
            } else {
                html += `<p class="small text-muted">Ao fechar o m√™s, as comiss√µes s√£o congeladas e marcadas como pagas.</p><button class="btn btn-success w-100" onclick="acaoConfigMensal('fechar', ${ano}, ${mes}, ${totalPago})">Fechar M√™s e Congelar Valores</button>`;
            }
            container.innerHTML = html;
        } catch(e) { container.innerHTML = `<div class="text-danger">Erro ao carregar: ${e.message}</div>`; }
    }

    async function acaoConfigMensal(acao, ano, mes, valor=0) {
        if(!confirm(`Confirma ${acao} o m√™s ${mes}/${ano}?`)) return;
        try {
            const endpoint = acao === 'fechar' ? '/crm/fechar-pagamento/' : '/crm/reabrir-pagamento/';
            await apiFetch(endpoint, { method: 'POST', body: JSON.stringify({ ano, mes, total_pago: valor }) });
            alert('Sucesso!'); carregarConfigMensal();
        } catch(e) { alert('Erro: ' + e.message); }
    }

    // --- CAMPANHAS ---
    function adicionarFaixaCampanha(meta = '', valor = '') {
        const tbody = document.getElementById('tbody-faixas-campanha');
        tbody.insertAdjacentHTML('beforeend', `<tr><td><input type="number" class="form-control form-control-sm input-meta" value="${meta}" placeholder="Ex: 15" required min="1"></td><td><input type="number" class="form-control form-control-sm input-premio" value="${valor}" placeholder="Ex: 150.00" required step="0.01"></td><td class="text-center"><button type="button" class="btn btn-xs btn-outline-danger" onclick="this.closest('tr').remove()"><i class="bi bi-trash"></i></button></td></tr>`);
    }
    async function carregarDadosAuxiliaresCampanha() {
        const [resPlanos, resPagamentos] = await Promise.all([apiFetch('/crm/planos/'), apiFetch('/crm/formas-pagamento/')]);
        const planos = Array.isArray(resPlanos) ? resPlanos : (resPlanos?.results || []);
        const pagamentos = Array.isArray(resPagamentos) ? resPagamentos : (resPagamentos?.results || []);
        const selPlanos = document.getElementById('campanha_planos'), selPags = document.getElementById('campanha_pagamentos');
        selPlanos.innerHTML = ''; selPags.innerHTML = '';
        planos.filter(p=>p.ativo).forEach(p => selPlanos.add(new Option(p.nome, p.id)));
        pagamentos.filter(fp=>fp.ativo).forEach(fp => selPags.add(new Option(fp.nome, fp.id)));
    }
    async function carregarCampanhas() {
        const lista = await apiFetch('/crm/campanhas/');
        const tbody = document.getElementById('lista-campanhas'); tbody.innerHTML = '';
        if(!lista.length) return tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhuma campanha.</td></tr>';
        lista.forEach(c => {
            let resumoMetas = '';
            if (c.regras_meta && c.regras_meta.length) c.regras_meta.sort((a,b)=>b.meta-a.meta).forEach(r => resumoMetas += `<div class="small">Meta <b>${r.meta}</b>: <span class="text-success">${fmtMoeda(r.valor_premio)}</span></div>`);
            else resumoMetas = `<div class="fw-bold">Meta: ${c.meta_vendas}</div><div class="text-success small">${fmtMoeda(c.valor_premio)}</div>`;
            tbody.innerHTML += `<tr><td class="fw-bold">${c.nome}</td><td class="small">${c.data_inicio} <br> ${c.data_fim}</td><td>${resumoMetas}</td><td>Canal: ${c.canal_alvo}</td><td>${c.ativo?'<span class="badge bg-success">Ativa</span>':'Encerrada'}</td><td class="text-end"><button class="btn btn-sm btn-editar me-1" onclick='editarCampanha(${JSON.stringify(c)})'>‚úèÔ∏è</button><button class="btn btn-sm btn-excluir" onclick="excluirCampanha(${c.id})">üóëÔ∏è</button></td></tr>`;
        });
    }
    document.getElementById('form-campanha').onsubmit = async(e) => {
        e.preventDefault();
        const faixas = [];
        document.querySelectorAll('#tbody-faixas-campanha tr').forEach(tr => {
            const m = tr.querySelector('.input-meta').value, p = tr.querySelector('.input-premio').value;
            if(m && p) faixas.push({ meta: parseInt(m), valor_premio: parseFloat(p) });
        });
        if(!faixas.length) return alert("Adicione ao menos uma faixa.");
        const id = document.getElementById('campanha_id').value;
        const body = {
            nome: document.getElementById('campanha_nome').value,
            data_inicio: document.getElementById('campanha_data_inicio').value,
            data_fim: document.getElementById('campanha_data_fim').value,
            tipo_meta: document.getElementById('campanha_tipo_meta').value,
            canal_alvo: document.getElementById('campanha_canal_alvo').value,
            regras: document.getElementById('campanha_regras').value,
            ativo: document.getElementById('campanha_ativo').value === 'true',
            regras_meta: faixas,
            planos_elegiveis: Array.from(document.getElementById('campanha_planos').selectedOptions).map(o=>parseInt(o.value)),
            formas_pagamento_elegiveis: Array.from(document.getElementById('campanha_pagamentos').selectedOptions).map(o=>parseInt(o.value))
        };
        await apiFetch(id ? `/crm/campanhas/${id}/` : '/crm/campanhas/', {method: id?'PUT':'POST', body: JSON.stringify(body)});
        alert('Salvo!'); resetFormCampanha(); carregarCampanhas();
    };
    window.editarCampanha = (c) => {
        document.getElementById('campanha_id').value = c.id;
        document.getElementById('campanha_nome').value = c.nome;
        document.getElementById('campanha_data_inicio').value = c.data_inicio;
        document.getElementById('campanha_data_fim').value = c.data_fim;
        document.getElementById('campanha_tipo_meta').value = c.tipo_meta || 'LIQUIDA';
        document.getElementById('campanha_canal_alvo').value = c.canal_alvo || 'TODOS';
        document.getElementById('campanha_regras').value = c.regras || '';
        document.getElementById('campanha_ativo').value = c.ativo ? 'true' : 'false';
        Array.from(document.getElementById('campanha_planos').options).forEach(o => o.selected = (c.planos_elegiveis||[]).includes(parseInt(o.value)));
        Array.from(document.getElementById('campanha_pagamentos').options).forEach(o => o.selected = (c.formas_pagamento_elegiveis||[]).includes(parseInt(o.value)));
        document.getElementById('tbody-faixas-campanha').innerHTML = '';
        if(c.regras_meta && c.regras_meta.length) c.regras_meta.forEach(r => adicionarFaixaCampanha(r.meta, r.valor_premio));
        else adicionarFaixaCampanha(c.meta_vendas, c.valor_premio);
        document.getElementById('form-campanha').scrollIntoView({ behavior: 'smooth' });
    };
    window.resetFormCampanha = () => { document.getElementById('form-campanha').reset(); document.getElementById('campanha_id').value=''; document.getElementById('tbody-faixas-campanha').innerHTML=''; adicionarFaixaCampanha(); };
    window.excluirCampanha = async(id) => { if(confirm('Excluir?')) { await apiFetch(`/crm/campanhas/${id}/`, {method:'DELETE'}); carregarCampanhas(); } };

    // --- COMISS√ÉO OPERADORA ---
    async function carregarComissoesOperadora() {
        const res = await apiFetch('/crm/comissoes-operadora/');
        const lista = Array.isArray(res) ? res : (res?.results || []);
        const tbody = document.getElementById('lista-comissoes-operadora'); tbody.innerHTML = '';
        const selPlano = document.getElementById('co_plano_id'); selPlano.innerHTML = '<option value="">Selecione...</option>';
        const resPlanos = await apiFetch('/crm/planos/');
        const planos = Array.isArray(resPlanos) ? resPlanos : (resPlanos?.results || []);
        planos.forEach(p => selPlano.add(new Option(p.nome, p.id)));
        lista.forEach(co => {
            const total = parseFloat(co.valor_base || 0) + parseFloat(co.bonus_transicao || 0);
            tbody.innerHTML += `<tr><td>${co.plano_nome || co.plano}</td><td>${fmtMoeda(co.valor_base)}</td><td class="text-success">${fmtMoeda(co.bonus_transicao)}</td><td>${co.data_fim_bonus||'-'}</td><td class="fw-bold">${fmtMoeda(total)}</td><td><button class="btn btn-warning btn-sm" onclick='editarComissaoOp(${JSON.stringify(co)})'>‚úèÔ∏è</button></td></tr>`;
        });
    }
    document.getElementById('form-comissao-operadora').onsubmit = async(e) => {
        e.preventDefault();
        const id = document.getElementById('co_id').value;
        const body = { plano: document.getElementById('co_plano_id').value, valor_base: document.getElementById('co_valor_base').value, bonus_transicao: document.getElementById('co_bonus').value, data_fim_bonus: document.getElementById('co_data_fim').value || null };
        await apiFetch(id ? `/crm/comissoes-operadora/${id}/` : '/crm/comissoes-operadora/', {method: id?'PUT':'POST', body: JSON.stringify(body)});
        document.getElementById('form-comissao-operadora').reset(); document.getElementById('co_id').value=''; carregarComissoesOperadora();
    };
    window.editarComissaoOp = (co) => { document.getElementById('co_id').value = co.id; document.getElementById('co_plano_id').value = co.plano; document.getElementById('co_valor_base').value = co.valor_base; document.getElementById('co_bonus').value = co.bonus_transicao; document.getElementById('co_data_fim').value = co.data_fim_bonus || ''; };

    // --- ADIANTAMENTOS E DESCONTOS ---
    async function carregarUsuariosSelectsFinanceiro() {
        const res = await apiFetch('/usuarios/?is_active=true');
        const users = Array.isArray(res) ? res : (res?.results || []);
        if (!users) return;
        const selAd = document.getElementById('ad_usuario'), selDesc = document.getElementById('desc_usuario');
        selAd.innerHTML = '<option value="">Selecione...</option>'; selDesc.innerHTML = '<option value="">Selecione...</option>';
        users.forEach(u => { const opt = new Option(u.username, u.id); selAd.add(opt.cloneNode(true)); selDesc.add(opt); });
    }
    window.toggleCamposAdiantamento = () => { document.getElementById('box-qtd-vendas').style.display = document.getElementById('ad_tipo').value === 'ADIANTAMENTO_CNPJ' ? 'block' : 'none'; };
    document.getElementById('form-adiantamento').onsubmit = async (e) => {
        e.preventDefault();
        await apiFetch('/crm/lancamentos-financeiros/', {method:'POST', body:JSON.stringify({usuario: document.getElementById('ad_usuario').value, tipo: document.getElementById('ad_tipo').value, data: document.getElementById('ad_data').value, valor: document.getElementById('ad_valor').value, quantidade_vendas: document.getElementById('ad_qtd').value || 0, descricao: document.getElementById('ad_obs').value})});
        alert('Salvo!'); document.getElementById('form-adiantamento').reset(); carregarLancamentosFinanceiros();
    };
    document.getElementById('form-desconto').onsubmit = async (e) => {
        e.preventDefault();
        await apiFetch('/crm/lancamentos-financeiros/', {method:'POST', body:JSON.stringify({usuario: document.getElementById('desc_usuario').value, tipo: 'DESCONTO', data: document.getElementById('desc_data').value, valor: document.getElementById('desc_valor').value, descricao: document.getElementById('desc_motivo').value})});
        alert('Salvo!'); document.getElementById('form-desconto').reset(); carregarLancamentosFinanceiros();
    };
    async function carregarLancamentosFinanceiros() {
        let mes = document.getElementById('filtro-mes-lancamentos').value;
        if (!mes) { const h = new Date(); mes = `${h.getFullYear()}-${String(h.getMonth()+1).padStart(2, '0')}`; document.getElementById('filtro-mes-lancamentos').value = mes; }
        const res = await apiFetch('/crm/lancamentos-financeiros/');
        const lista = Array.isArray(res) ? res : (res?.results || []);
        const tbody = document.getElementById('lista-lancamentos-fin'); tbody.innerHTML = '';
        lista.filter(l => l.data && l.data.startsWith(mes)).forEach(l => {
            tbody.innerHTML += `<tr><td>${new Date(l.data).toLocaleDateString('pt-BR',{timeZone:'UTC'})}</td><td>${l.usuario_nome || 'N/A'}</td><td>${l.tipo} - ${l.descricao}</td><td class="text-end fw-bold ${l.tipo==='DESCONTO'?'text-danger':'text-primary'}">${fmtMoeda(l.valor)}</td><td class="text-end"><button class="btn btn-xs btn-outline-danger" onclick="excluirLancamento(${l.id})">üóëÔ∏è</button></td></tr>`;
        });
    }
    window.excluirLancamento = async (id) => { if(confirm('Excluir?')) { await apiFetch(`/crm/lancamentos-financeiros/${id}/`, {method:'DELETE'}); carregarLancamentosFinanceiros(); } };

    // ====================================================================
    // 4. AUTOMA√á√ÉO DE EVENTOS (NOVA L√ìGICA ROBUSTA)
    // ====================================================================
    async function carregarGruposExternos() {
        const select = document.getElementById('regra_grupos');
        select.innerHTML = '<option disabled>Buscando na API...</option>';
        try {
            const res = await apiFetch('/whatsapp/groups/');
            const grupos = Array.isArray(res) ? res : (res?.results || []);
            select.innerHTML = '';
            if (grupos && grupos.length > 0) {
                grupos.forEach(g => { select.add(new Option(g.name || g.subject, g.id || g.jid)); });
            } else { throw new Error("Lista vazia"); }
        } catch (e) {
            console.warn("API de grupos n√£o encontrada ou erro. Usando modo manual.", e);
            select.innerHTML = '<option value="" disabled>N√£o foi poss√≠vel carregar autom√°tico.</option>';
            const manualId = prompt("A API de grupos n√£o retornou. Digite o ID do grupo (JID) se souber, ou cancele:");
            if(manualId) select.add(new Option("Grupo Manual ("+manualId+")", manualId, true, true));
        }
    }

    async function carregarRegrasAutomacao() {
        const tbody = document.getElementById('lista-regras-auto');
        tbody.innerHTML = '<tr><td colspan="4" class="text-center">Carregando...</td></tr>';
        try {
            const lista = await apiFetch('/regras-automacao/');
            tbody.innerHTML = '';
            if(lista.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Nenhuma regra ativa.</td></tr>'; return; }
            lista.forEach(r => {
                const statusBadge = r.ativo ? '<span class="badge bg-success">Ativo</span>' : '<span class="badge bg-secondary">Inativo</span>';
                tbody.innerHTML += `<tr><td><strong class="text-primary">${r.nome}</strong><br><small class="text-muted">${r.evento_gatilho}</small></td><td><span class="badge bg-light text-dark border">Grupos: ${r.destinos_grupos?r.destinos_grupos.length:0}</span> <span class="badge bg-light text-dark border">Nums: ${r.destinos_numeros?r.destinos_numeros.length:0}</span></td><td>${statusBadge}</td><td class="text-end"><button class="btn btn-sm btn-editar me-1" onclick='editarRegraAuto(${JSON.stringify(r)})'><i class="bi bi-pencil"></i></button> <button class="btn btn-sm btn-excluir" onclick="excluirRegraAuto(${r.id})"><i class="bi bi-trash"></i></button></td></tr>`;
            });
        } catch (e) { tbody.innerHTML = '<tr><td colspan="4" class="text-danger text-center">Erro ao carregar regras.</td></tr>'; }
    }

    document.getElementById('form-regra-automacao').onsubmit = async (e) => {
        e.preventDefault();
        const id = document.getElementById('regra_auto_id').value;
        const gruposIds = Array.from(document.getElementById('regra_grupos').selectedOptions).map(opt => opt.value);
        const numsList = document.getElementById('regra_numeros').value.split(',').map(n => n.trim()).filter(n => n.length > 0);
        const payload = {
            nome: document.getElementById('regra_nome').value,
            ativo: document.getElementById('regra_ativo').value === 'true',
            evento_gatilho: document.getElementById('regra_evento').value,
            destinos_grupos: gruposIds,
            destinos_numeros: numsList,
            template_mensagem: document.getElementById('regra_msg').value
        };
        try {
            if(id) await apiFetch(`/regras-automacao/${id}/`, { method: 'PUT', body: JSON.stringify(payload) });
            else await apiFetch('/regras-automacao/', { method: 'POST', body: JSON.stringify(payload) });
            alert('Regra salva com sucesso!'); resetFormRegraAuto(); carregarRegrasAutomacao();
        } catch(err) { alert('Erro ao salvar: ' + err.message); }
    };

    window.editarRegraAuto = (r) => {
        document.getElementById('regra_auto_id').value = r.id;
        document.getElementById('regra_nome').value = r.nome;
        document.getElementById('regra_evento').value = r.evento_gatilho;
        document.getElementById('regra_ativo').value = r.ativo ? 'true' : 'false';
        document.getElementById('regra_numeros').value = r.destinos_numeros.join(', ');
        document.getElementById('regra_msg').value = r.template_mensagem;
        const select = document.getElementById('regra_grupos');
        if (select.options.length <= 1) r.destinos_grupos.forEach(gid => select.add(new Option(gid, gid, true, true)));
        else Array.from(select.options).forEach(opt => opt.selected = r.destinos_grupos.includes(opt.value));
    };

    window.excluirRegraAuto = async (id) => { if(confirm('Excluir esta regra de automa√ß√£o?')) { try { await apiFetch(`/regras-automacao/${id}/`, { method: 'DELETE' }); carregarRegrasAutomacao(); } catch(e) { alert('Erro ao excluir.'); } } };
    window.resetFormRegraAuto = () => { document.getElementById('form-regra-automacao').reset(); document.getElementById('regra_auto_id').value = ''; Array.from(document.getElementById('regra_grupos').options).forEach(opt => opt.selected = false); };

    // --- MOTIVOS (FUN√á√ÉO RESTAURADA) ---
    async function carregarMotivos() {
        const ul = document.getElementById('lista-motivos');
        ul.innerHTML = 'Carregando...';
        try {
            const resposta = await apiFetch('/presenca/motivos/');
            const lista = Array.isArray(resposta) ? resposta : (resposta.results || []);
            ul.innerHTML = '';
            lista.forEach(m => {
                ul.innerHTML += `<li class="list-group-item d-flex justify-content-between"><span><strong>${m.nome||m.motivo}</strong> ${m.gera_desconto?'(Desc)':'(Abona)'}</span><button class="btn btn-sm btn-excluir" onclick="excluirMotivo(${m.id})">üóëÔ∏è</button></li>`;
            });
        } catch(e) { ul.innerHTML = 'Erro ao carregar.'; }
    }
    
    // --- BOT√ÉO SALVAR MOTIVO RESTAURADO ---
    const btnSalvarMotivo = document.getElementById('btn-salvar-motivo');
    if(btnSalvarMotivo) {
        btnSalvarMotivo.onclick = async () => {
            const nome = document.getElementById('novo-motivo-nome').value;
            if(!nome) return;
            await apiFetch('/presenca/motivos/', {method:'POST', body: JSON.stringify({ nome, gera_desconto: document.getElementById('novo-motivo-desconto').checked })});
            document.getElementById('novo-motivo-nome').value=''; carregarMotivos();
        };
    }
    window.excluirMotivo = async(id) => { if(confirm('Excluir?')) { await apiFetch(`/presenca/motivos/${id}/`, {method:'DELETE'}); carregarMotivos(); } };

    async function carregarFeriados() {
        const res = await apiFetch('/presenca/dias-nao-uteis/');
        const lista = Array.isArray(res) ? res : (res?.results || []);
        const tbody = document.getElementById('lista-feriados'); tbody.innerHTML = '';
        lista.forEach(f => tbody.innerHTML += `<tr><td>${f.data.split('-').reverse().join('/')}</td><td>${f.descricao||'-'}</td><td><button class="btn btn-sm btn-danger" onclick="excluirFeriado(${f.id})">üóëÔ∏è</button></td></tr>`);
    }
    const btnSalvarFeriado = document.getElementById('btn-salvar-feriado');
    if(btnSalvarFeriado) {
        btnSalvarFeriado.onclick = async () => {
            const dt = document.getElementById('novo-feriado-data').value;
            if(!dt) return;
            await apiFetch('/presenca/dias-nao-uteis/', {method:'POST', body: JSON.stringify({ data: dt, descricao: document.getElementById('novo-feriado-descricao').value })});
            carregarFeriados();
        };
    }
    window.excluirFeriado = async(id) => { if(confirm('Excluir?')) { await apiFetch(`/presenca/dias-nao-uteis/${id}/`, {method:'DELETE'}); carregarFeriados(); } };

    // --- RELAT√ìRIOS ---
    async function carregarRelatorioFinanceiro() {
        let ini = document.getElementById('finDataInicio').value;
        let fim = document.getElementById('finDataFim').value;
        if(!ini || !fim) { const h = new Date(); ini = new Date(h.getFullYear(), h.getMonth(), 1).toISOString().split('T')[0]; fim = new Date(h.getFullYear(), h.getMonth()+1, 0).toISOString().split('T')[0]; document.getElementById('finDataInicio').value=ini; document.getElementById('finDataFim').value=fim; }
        document.getElementById('cardPrevisao').style.display='block';
        document.getElementById('cardDescontos').style.display='block';
        try {
            const dados = await apiFetch(`/presenca/relatorio-financeiro/?inicio=${ini}&fim=${fim}`);
            const tPrev = document.getElementById('tbodyPrevisao'), tDesc = document.getElementById('tbodyDescontos');
            tPrev.innerHTML = ''; tDesc.innerHTML = '';
            (dados.previsao||[]).forEach(p => tPrev.innerHTML += `<tr><td>${p.colaborador_username||p.colaborador}</td><td>${p.dias_uteis}</td><td>${fmtMoeda(p.valor_diario)}</td><td class="fw-bold">${fmtMoeda(p.total_receber||p.total_previsto)}</td></tr>`);
            (dados.descontos||[]).forEach(d => tDesc.innerHTML += `<tr><td>${d.colaborador_username||d.colaborador}</td><td>${d.dias_uteis}</td><td>${d.qtd_faltas}</td><td>${fmtMoeda(d.valor_diario)}</td><td class="text-danger">${fmtMoeda(d.valor_desconto)}</td><td class="fw-bold">${fmtMoeda(d.total_receber)}</td></tr>`);
        } catch(e) { alert(e.message); }
    }
    
    async function baixarExcelFinanceiro() {
        const ini = document.getElementById('finDataInicio').value, fim = document.getElementById('finDataFim').value;
        if(!ini) return;
        const blob = await apiFetch(`/presenca/relatorio-financeiro/excel/?inicio=${ini}&fim=${fim}`, { isBlob: true });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'Relatorio.xlsx'; document.body.appendChild(a); a.click(); a.remove();
    }

    async function carregarOpcoesCampanhasRelatorio() {
        const select = document.getElementById('select-rel-campanha');
        if (select.options.length > 1) return;
        const campanhas = await apiFetch('/crm/campanhas/');
        select.innerHTML = '<option value="">Selecione...</option>';
        campanhas.forEach(c => select.add(new Option(`${c.ativo?'[Ativa]':'[Fim]'} ${c.nome}`, c.id)));
    }

    let resultadoCampanhaCache = [];
    async function carregarResultadoCampanha() {
        const id = document.getElementById('select-rel-campanha').value;
        if(!id) return;
        document.getElementById('resultado-campanha-container').style.display = 'block';
        const tbody = document.getElementById('tbody-resultado-campanha'); tbody.innerHTML = '<tr><td colspan="7">Calculando...</td></tr>';
        try {
            const dados = await apiFetch(`/crm/campanhas/${id}/resultado/`);
            resultadoCampanhaCache = dados.ranking;
            document.getElementById('campanha-titulo-resumo').innerText = dados.campanha;
            document.getElementById('campanha-total-premios').innerText = fmtMoeda(dados.ranking.reduce((acc, r) => acc + parseFloat(r.premio_receber), 0));
            tbody.innerHTML = '';
            dados.ranking.forEach(r => {
                const premio = parseFloat(r.premio_receber);
                tbody.innerHTML += `<tr><td><input type="checkbox" class="form-check-input check-vendedor-rel" value="${r.vendedor_id}"></td><td class="text-center">${r.ranking}¬∫</td><td>${r.vendedor}</td><td class="text-center">${r.vendas_validas}</td><td class="text-center">${r.meta_atingida_para_premio||r.meta}</td><td>${r.percentual}%</td><td class="text-end ${premio>0?'text-success fw-bold':''}">${fmtMoeda(premio)}</td></tr>`;
            });
        } catch(e) { tbody.innerHTML = `<tr><td colspan="7">${e.message}</td></tr>`; }
    }

    function toggleSelecaoRelatorio(s) { document.querySelectorAll('.check-vendedor-rel').forEach(c => c.checked = s.checked); atualizarContadorWpp(); }
    document.addEventListener('change', (e) => { if(e.target.classList.contains('check-vendedor-rel')) atualizarContadorWpp(); });
    function atualizarContadorWpp() { document.getElementById('count-wpp').innerText = document.querySelectorAll('.check-vendedor-rel:checked').length; }
    
    async function enviarResultadoWhatsappSelecionados() {
        const ids = Array.from(document.querySelectorAll('.check-vendedor-rel:checked')).map(c => parseInt(c.value));
        if(!ids.length) return alert("Selecione vendedores.");
        const campId = document.getElementById('select-rel-campanha').value;
        if(!confirm(`Enviar para ${ids.length} pessoas?`)) return;
        
        const dadosEnvio = resultadoCampanhaCache.filter(r => ids.includes(r.vendedor_id)).map(r => ({
            vendedor_id: r.vendedor_id, vendas_validas: r.vendas_validas, premio_receber: String(r.premio_receber),
            meta_alcancada: r.meta_atingida_para_premio || r.meta, meta_atingida: r.meta, proxima_faixa: r.proxima_faixa || null
        }));
        
        const res = await apiFetch(`/crm/campanhas/enviar-resultado-whatsapp/`, { method: 'POST', body: JSON.stringify({ campanha_id: parseInt(campId), vendedores_dados: dadosEnvio }) });
        alert(res.mensagem);
    }

    // --- INICIALIZA√á√ÉO (MOVIDO PARA O FINAL) ---
    document.addEventListener('DOMContentLoaded', () => {
        carregarDadosParaFormulario();
        carregarPerfis();
        carregarUsuarios('ativos'); 
        
        carregarMotivos();
        carregarFeriados();
        
        carregarOperadoras();
        carregarPlanos();
        carregarFormasPagamento();
        carregarStatus();
        carregarMotivosPendencia();
        carregarRegrasComissao();
        
        carregarDadosAuxiliaresCampanha();
        carregarCampanhas();
        adicionarFaixaCampanha(); 
        
        carregarComissoesOperadora(); 
        carregarUsuariosSelectsFinanceiro();
        carregarLancamentosFinanceiros();
        
        // --- NOVAS FUN√á√ïES DA ABA AUTOMA√á√ÉO (SUBSTITU√çRAM AS ANTIGAS) ---
        carregarRegrasAutomacao();
        carregarGruposExternos();

        // Adicionar event listener para busca de usu√°rios com debounce
        const campoBuscaUsuario = document.getElementById('busca-usuario');
        if (campoBuscaUsuario) {
            let debounceTimer;
            const debouncedFiltrar = () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    filtrarUsuarios();
                }, 300); // Aguardar 300ms ap√≥s parar de digitar
            };
            
            campoBuscaUsuario.addEventListener('input', debouncedFiltrar);
            campoBuscaUsuario.addEventListener('keyup', (e) => {
                // Se pressionar Enter, buscar imediatamente
                if (e.key === 'Enter') {
                    clearTimeout(debounceTimer);
                    filtrarUsuarios();
                }
            });
        }

        const link = document.querySelector('.admin-nav-link');
        if(link) mostrarSecao(null, 'usuarios', link);

        // Carregar usu√°rios iniciais com pagina√ß√£o
        carregarUsuarios('ativos', 1).then(() => {
            // For√ßar renderiza√ß√£o da pagina√ß√£o ap√≥s carregamento
            setTimeout(() => {
                console.log('üîß For√ßando renderiza√ß√£o da pagina√ß√£o ap√≥s carregamento...');
                renderizarControlesPaginacao('ativos');
            }, 500);
        });

        // Pr√©-carregar dados para melhorar performance do modal de usu√°rios
        setTimeout(() => {
            carregarDadosParaFormulario().catch(() => {});
        }, 1000);
    });
    </script>
</body>
</html>