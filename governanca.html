<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Governança - Record PAP</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f4; margin: 0; }
        header { background-color: #fff; padding: 1rem 2rem; box-shadow: 0 2px 5px rgba(0,0,0,0.2); position: sticky; top: 0; z-index: 1000; }
        .header-container { max-width: 95%; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo { max-width: 150px; height: auto; cursor: pointer; }
        header nav ul { list-style: none; display: flex; gap: 1.5rem; align-items: center; margin:0; padding:0; }
        header nav ul li a { text-decoration: none; color: #1a1a1a; font-weight: 500; }
        .action-button { background-color: #1a1a1a; color: #fff; padding: 0.5rem 1rem; border-radius: 0.25rem; text-decoration: none; font-size: 0.9rem; font-weight: 600; cursor: pointer; border: 1px solid transparent;}
        .logout-button { background-color: #dc3545; }
        .main-container { display: flex; min-height: 100vh; }
        .side-nav {
            width: 250px;
            background-color: #1a1a1a;
            color: white;
            padding: 1.5rem 0;
            flex-shrink: 0;
        }
        .side-nav h1 {
            text-align: center;
            padding: 0 1rem 1.5rem 1rem;
            font-size: 1.5rem;
            border-bottom: 1px solid #444;
            margin: 0;
        }
        .nav-menu { list-style: none; padding: 0; margin: 0; }
        .nav-menu li { padding: 1rem 1.5rem; cursor: pointer; border-bottom: 1px solid #444; transition: background-color: 0.3s; }
        .nav-menu li:hover, .nav-menu li.active { background-color: #007bff; }
        .content-area { flex-grow: 1; padding: 2rem; }
        .content-section {
            display: none;
            background: #fff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .content-section.active { display: block; }
        h2, h3 { text-align: center; color: #333; margin-bottom: 2rem; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; }
        .form-container { margin-bottom: 2rem; }
        .form-group { display: flex; flex-direction: column; margin-bottom: 1rem; }
        .form-group label { margin-bottom: 0.5rem; font-weight: bold; }
        .form-group input, .form-group select { padding: 0.75rem; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; }
        input[type="color"] { padding: 0.25rem; height: 40px; }
        .btn { display: inline-block; width: auto; padding: 0.75rem 1.5rem; border: none; background-color: #28a745; color: #fff; font-size: 1rem; border-radius: 4px; cursor: pointer; margin-top: 1rem; text-align: center;}
        .btn:hover { background-color: #218838; }
        .btn-cancel { background-color: #6c757d; }
        table { width: 100%; border-collapse: collapse; margin-top: 2rem; }
        th, td { border: 1px solid #ddd; padding: 0.75rem; text-align: left; vertical-align: middle;}
        th { background-color: #f2f2f2; }
        .actions-cell button { margin-right: 5px; padding: 0.5rem; border-radius: 4px; border: none; cursor: pointer;}
        .btn-edit { background-color: #ffc107; }
        .btn-delete { background-color: #dc3545; color: white; }
        .btn-reactivate { background-color: #17a2b8; color: white; }
        .tab-nav { border-bottom: 2px solid #ccc; margin-bottom: 1.5rem; display: flex; flex-wrap: wrap;}
        .tab-nav button { padding: 0.75rem 1.5rem; border: none; background-color: transparent; cursor: pointer; font-size: 1.1rem; border-bottom: 3px solid transparent; margin-bottom: -2px; }
        .tab-nav button.active { border-bottom-color: #007bff; font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .generic-list { list-style: none; padding: 0; margin-bottom: 1.5rem;}
        .generic-list li { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-bottom: 1px solid #ddd; }
        .generic-list-actions button { margin-left: 0.5rem; padding: 0.3rem 0.6rem; }
        .form-inline { display: flex; gap: 1rem; margin-top: 1rem; align-items: center; }
        .form-inline input[type="text"], .form-inline input[type="date"] { flex-grow: 1; }
        .form-inline label { display: flex; align-items: center; gap: 0.5rem; }
        footer { background-color: #1a1a1a; color: #fff; padding: 2rem 1rem; text-align: center; }
        footer p { font-size: 0.9rem; margin-bottom: 0.5rem; }
        footer a { color: #b3b3b3; text-decoration: none; }
        .color-box { display: inline-block; width: 20px; height: 20px; border: 1px solid #ccc; vertical-align: middle; margin-right: 10px; }
    </style>
</head>
<body>

    <header>
    <div class="header-container">
        <img src="/static/logo.png" alt="Record PAP Logo" class="logo" onclick="window.location.href='/'">
        <nav>
            <ul>
                <li><a href="/area-interna/">Área Interna</a></li>
                <li><button onclick="logout()" class="action-button logout-button">Sair</button></li>
            </ul>
        </nav>
    </div>
    </header>

<div class="main-container">
    <nav class="side-nav">
        <h1>Governança</h1>
        <ul class="nav-menu">
            <li onclick="mostrarSecao('usuarios', this)">Gestão de Usuários</li>
            <li onclick="mostrarSecao('perfis', this)">Gestão de Perfis</li>
            <li onclick="mostrarSecao('comissionamento', this)">Gestão de Comissionamento</li>
            <li onclick="mostrarSecao('cadastros_gerais', this)">Cadastros Gerais</li> 
            <li onclick="mostrarSecao('motivos', this)">Gestão de Motivos</li>
            <li onclick="mostrarSecao('feriados', this)">Gestão de Feriados</li>
            <li onclick="mostrarSecao('relatorios', this)">Relatórios</li>
        </ul>
    </nav>

    <main class="content-area">
        <section id="usuarios-section" class="content-section">
            <h2>Gestão de Usuários</h2>
            <div id="form-container">
                <h3 id="form-title">Cadastrar Novo Usuário</h3>
                <form id="user-form">
                    <input type="hidden" id="user_id">
                    <div class="form-grid">
                        <div class="form-group"><label for="nome_completo">Nome Completo</label><input type="text" id="nome_completo" required></div>
                        <div class="form-group"><label for="cpf">CPF</label><input type="text" id="cpf"></div>
                        <div class="form-group"><label for="email">E-mail</label><input type="email" id="email" required></div>
                        <div class="form-group"><label for="username">Username</label><input type="text" id="username" required></div>
                        <div class="form-group" id="senha-group"><label for="senha">Senha</label><input type="password" id="senha"></div>
                        <div class="form-group"><label for="perfil_id">Perfil</label><select id="perfil_id" required></select></div>
                        <div class="form-group"><label for="supervisor_id">Líder Imediato</label><select id="supervisor_id"><option value="">Nenhum</option></select></div>
                        <div class="form-group"><label for="valor_almoco">Auxílio Almoço (diário)</label><input type="number" id="valor_almoco" step="0.01" placeholder="Ex: 18.00"></div>
                        <div class="form-group"><label for="valor_passagem">Auxílio Passagem (diário)</label><input type="number" id="valor_passagem" step="0.01" placeholder="Ex: 9.60"></div>
                        <div class="form-group"><label for="chave_pix">Chave PIX</label><input type="text" id="chave_pix" placeholder="Chave PIX do usuário"></div>
                        <div class="form-group"><label for="nome_da_conta">Nome da Conta (PIX)</label><input type="text" id="nome_da_conta" placeholder="Nome do titular da conta PIX"></div>
                        
                        <div class="form-group"><label for="meta_comissao">Meta de Comissão (Vendas/Mês)</label><input type="number" id="meta_comissao" placeholder="Ex: 20"></div>
                        <div class="form-group"><label for="desconto_boleto">Desconto por Boleto (R$)</label><input type="number" id="desconto_boleto" step="0.01" placeholder="Ex: 5.00"></div>
                        <div class="form-group"><label for="desconto_inclusao_viabilidade">Desconto Inclusão Viab. (R$)</label><input type="number" id="desconto_inclusao_viabilidade" step="0.01"></div>
                        <div class="form-group"><label for="desconto_instalacao_antecipada">Desconto Inst. Antecipada (R$)</label><input type="number" id="desconto_instalacao_antecipada" step="0.01"></div>
                        <div class="form-group"><label for="adiantamento_cnpj">Adiantamento por Venda CNPJ (R$)</label><input type="number" id="adiantamento_cnpj" step="0.01"></div>
                        <div class="form-group"><label for="desconto_inss_fixo">Desconto Fixo INSS (R$)</label><input type="number" id="desconto_inss_fixo" step="0.01"></div>
                    </div>
                    <button type="submit" class="btn">Salvar</button>
                    <button type="button" class="btn btn-cancel" onclick="resetForm()">Cancelar</button>
                </form>
            </div>
            <div id="list-container" style="margin-top: 2rem; border-top: 1px solid #ccc; padding-top: 2rem;">
                <div class="tab-nav">
                    <button onclick="mostrarListaUsuarios('ativos', this)" class="active">Ativos</button>
                    <button onclick="mostrarListaUsuarios('inativos', this)">Inativos</button>
                </div>
                <h3>Usuários <span id="lista-status-titulo">Ativos</span></h3>
                <table>
                    <thead><tr id="user-list-header"></tr></thead>
                    <tbody id="user-list-body"></tbody>
                </table>
            </div>
        </section>

        <section id="perfis-section" class="content-section">
            <h2>Gestão de Perfis</h2>
            <ul id="lista-perfis" class="generic-list"></ul>
            <div class="form-inline">
                <input type="text" id="novo-perfil-nome" placeholder="Nome do novo perfil" class="form-group input">
                <button id="btn-salvar-perfil" class="btn">Adicionar Perfil</button>
            </div>
        </section>

        <section id="comissionamento-section" class="content-section">
            <h2>Gestão de Comissionamento</h2>
            <nav class="tab-nav">
                <button onclick="openTab(event, 'regras_comissao_tab')" class="active">Regras de Comissão</button>
                <button onclick="openTab(event, 'config_mensal_tab')">Configurações do Mês</button>
                <button onclick="openTab(event, 'campanhas_tab')">Campanhas e Prêmios</button>
            </nav>

            <div id="regras_comissao_tab" class="tab-content active">
                <h3>Regras de Comissão por Plano</h3>
                <div class="form-container">
                    <form id="form-regra-comissao">
                        <input type="hidden" id="regra_comissao_id">
                        <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                            <div class="form-group"><label for="regra_consultor_id">Consultor</label><select id="regra_consultor_id" required></select></div>
                            <div class="form-group"><label for="regra_plano_id">Plano</label><select id="regra_plano_id" required></select></div>
                            <div class="form-group"><label for="regra_tipo_venda">Tipo de Venda</label><select id="regra_tipo_venda" required><option value="PAP">PAP</option><option value="TELAG">TELAG</option></select></div>
                            <div class="form-group"><label for="regra_tipo_cliente">Tipo de Cliente</label><select id="regra_tipo_cliente" required><option value="CPF">CPF</option><option value="CNPJ">CNPJ</option></select></div>
                            <div class="form-group"><label for="regra_valor_base">Valor Base (R$)</label><input type="number" id="regra_valor_base" step="0.01" required></div>
                            <div class="form-group"><label for="regra_valor_acelerado">Valor Acelerado (R$)</label><input type="number" id="regra_valor_acelerado" step="0.01" required></div>
                        </div>
                        <button type="submit" class="btn">Salvar Regra</button>
                        <button type="button" class="btn btn-cancel" onclick="resetFormRegraComissao()">Cancelar</button>
                    </form>
                </div>
                <h3>Regras Cadastradas</h3>
                <table>
                    <thead><tr><th>Consultor</th><th>Plano</th><th>Tipo Venda</th><th>Tipo Cliente</th><th>Valor Base</th><th>Valor Acelerado</th><th>Ações</th></tr></thead>
                    <tbody id="lista-regras-comissao"></tbody>
                </table>
            </div>

            <div id="config_mensal_tab" class="tab-content">
                <h3>Configurações Variáveis do Mês</h3>
                <div class="form-inline" style="margin-bottom: 2rem;">
                    <label for="select_mes_config">Selecione o Mês:</label>
                    <input type="month" id="select_mes_config" class="form-group input">
                </div>
                <div id="form-container-config-mensal" class="form-container">
                </div>
            </div>

            <div id="campanhas_tab" class="tab-content">
                <h3>Campanhas de Premiação</h3>
                <div class="form-container">
                    <form id="form-campanha">
                        <input type="hidden" id="campanha_id">
                        <div class="form-grid">
                            <div class="form-group"><label for="campanha_nome">Nome da Campanha</label><input type="text" id="campanha_nome" required></div>
                            <div class="form-group"><label for="campanha_data_inicio">Data de Início</label><input type="date" id="campanha_data_inicio" required></div>
                            <div class="form-group"><label for="campanha_data_fim">Data de Fim</label><input type="date" id="campanha_data_fim" required></div>
                            <div class="form-group" style="grid-column: 1 / -1;"><label for="campanha_regras">Regras (Descrição)</label><input type="text" id="campanha_regras"></div>
                        </div>
                        <button type="submit" class="btn">Salvar Campanha</button>
                        <button type="button" class="btn btn-cancel" onclick="resetFormCampanha()">Cancelar</button>
                    </form>
                </div>
                <h3>Campanhas Ativas</h3>
                <table>
                    <thead><tr><th>Campanha</th><th>Período</th><th>Status</th><th>Ações</th></tr></thead>
                    <tbody id="lista-campanhas"></tbody>
                </table>
            </div>
        </section>
        
        <section id="cadastros_gerais-section" class="content-section">
            <h2>Cadastros Gerais do CRM</h2>
            <nav class="tab-nav">
                <button onclick="openTab(event, 'operadoras')" class="active">Operadoras</button>
                <button onclick="openTab(event, 'planos')">Planos</button>
                <button onclick="openTab(event, 'formasPagamento')">Formas de Pagamento</button>
                <button onclick="openTab(event, 'status')">Status</button>
                <button onclick="openTab(event, 'pendencias')">Motivos de Pendência</button>
            </nav>
        
            <div id="operadoras" class="tab-content active">
                <h2>Gestão de Operadoras</h2>
                <div class="form-container">
                    <form id="form-operadora">
                        <input type="hidden" id="operadora_id">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="operadora_nome">Nome da Operadora</label>
                                <input type="text" id="operadora_nome" required>
                            </div>
                            <div class="form-group">
                                <label for="operadora_cnpj">CNPJ</label>
                                <input type="text" id="operadora_cnpj">
                            </div>
                            <div class="form-group">
                                <label for="operadora_status">Status</label>
                                <select id="operadora_status" required>
                                    <option value="1">Ativo</option>
                                    <option value="0">Inativo</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <button type="submit" class="btn">Salvar Operadora</button>
                            <button type="button" class="btn btn-cancel" onclick="resetFormOperadora()">Cancelar</button>
                        </div>
                    </form>
                </div>
                <div class="list-container">
                    <h3>Operadoras Cadastradas</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>CNPJ</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="lista-operadoras"></tbody>
                    </table>
                </div>
            </div>
        
            <div id="planos" class="tab-content">
                <h2>Gestão de Planos</h2>
                <div class="form-container">
                    <form id="form-plano">
                        <input type="hidden" id="plano_id">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="plano_nome">Nome do Plano</label>
                                <input type="text" id="plano_nome" required>
                            </div>
                            <div class="form-group">
                                <label for="plano_valor">Valor (R$)</label>
                                <input type="number" id="plano_valor" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label for="plano_comissao">Comissão Base (R$)</label>
                                <input type="number" id="plano_comissao" step="0.01">
                            </div>
                            <div class="form-group">
                                <label for="plano_operadora_id">Operadora</label>
                                <select id="plano_operadora_id" required>
                                    <option value="">Selecione...</option>
                                </select>
                            </div>
                             <div class="form-group" style="grid-column: 1 / -1;">
                                <label for="plano_beneficios">Benefícios (opcional)</label>
                                <input type="text" id="plano_beneficios">
                            </div>
                        </div>
                        <div>
                            <button type="submit" class="btn">Salvar Plano</button>
                            <button type="button" class="btn btn-cancel" onclick="resetFormPlano()">Cancelar</button>
                        </div>
                    </form>
                </div>
                <div class="list-container">
                    <h3>Planos Cadastrados</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Operadora</th>
                                <th>Valor</th>
                                <th>Comissão</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="lista-planos"></tbody>
                    </table>
                </div>
            </div>

            <div id="formasPagamento" class="tab-content">
                <h2>Gestão de Formas de Pagamento</h2>
                <ul id="lista-formas-pagamento" class="generic-list"></ul>
                <div class="form-inline">
                    <input type="text" id="nova-forma-pagamento-nome" placeholder="Nome (Ex: PIX, Boleto)" class="form-group input">
                    <button id="btn-salvar-forma-pagamento" class="btn">Adicionar Forma de Pagamento</button>
                </div>
            </div>
            
            <div id="status" class="tab-content">
                <h2>Gestão de Status do CRM</h2>
                <div class="form-container">
                     <form id="form-status">
                        <input type="hidden" id="status_id">
                        <div class="form-grid">
                            <div class="form-group"><label for="status_nome">Nome do Status</label><input type="text" id="status_nome" required></div>
                            <div class="form-group"><label for="status_tipo">Tipo de Status</label><select id="status_tipo" required><option value="Tratamento">Tratamento</option><option value="Esteira">Esteira</option><option value="Comissionamento">Comissionamento</option></select></div>
                            <div class="form-group" id="status_estado_group"><label for="status_estado">Estado</label><input type="text" id="status_estado" placeholder="Ex: Na fila de tratamento"></div>
                            <div class="form-group"><label for="status_cor">Cor</label><input type="color" id="status_cor" value="#FFFFFF" style="width: 100%; height: 45px;"></div>
                        </div>
                        <button type="submit" class="btn">Salvar Status</button>
                        <button type="button" class="btn btn-cancel" onclick="resetFormStatus()">Cancelar</button>
                    </form>
                </div>
                <h3>Status Cadastrados</h3>
                <table>
                    <thead><tr><th>Nome</th><th>Tipo</th><th>Estado</th><th>Cor</th><th>Ações</th></tr></thead>
                    <tbody id="lista-status"></tbody>
                </table>
            </div>

            <div id="pendencias" class="tab-content">
                <h2>Gestão de Motivos de Pendência</h2>
                 <div class="form-container">
                     <form id="form-pendencia">
                        <input type="hidden" id="pendencia_id">
                        <div class="form-grid">
                            <div class="form-group"><label for="pendencia_nome">Nome da Pendência</label><input type="text" id="pendencia_nome" required></div>
                            <div class="form-group"><label for="pendencia_tipo">Tipo de Pendência</label><input type="text" id="pendencia_tipo" placeholder="Ex: Documentação, Financeiro" required></div>
                        </div>
                        <button type="submit" class="btn">Salvar Motivo</button>
                        <button type="button" class="btn btn-cancel" onclick="resetFormPendencia()">Cancelar</button>
                    </form>
                </div>
                <h3>Motivos Cadastrados</h3>
                <table>
                    <thead><tr><th>Nome</th><th>Tipo</th><th>Ações</th></tr></thead>
                    <tbody id="lista-pendencias"></tbody>
                </table>
            </div>
        </section>

        <section id="motivos-section" class="content-section">
            <h2>Gestão de Motivos de Ausência</h2>
            <ul id="lista-motivos" class="generic-list"></ul>
            <div class="form-inline">
                <input type="text" id="novo-motivo-nome" placeholder="Nome do novo motivo" class="form-group input">
                <label>
                    <input type="checkbox" id="novo-motivo-desconto" checked>
                    Gera Desconto
                </label>
                <button id="btn-salvar-motivo" class="btn">Adicionar Motivo</button>
            </div>
        </section>
        
        <section id="feriados-section" class="content-section">
            <h2>Gestão de Feriados e Dias Não Úteis</h2>
            <div class="form-inline">
                <input type="date" id="novo-feriado-data" class="form-group input">
                <input type="text" id="novo-feriado-descricao" placeholder="Descrição (Ex: Natal)" class="form-group input">
                <button id="btn-salvar-feriado" class="btn">Adicionar</button>
            </div>
            <table style="margin-top: 2rem;">
                <thead><tr><th>Data</th><th>Descrição</th><th>Ações</th></tr></thead>
                <tbody id="lista-feriados"></tbody>
            </table>
        </section>
        
        <section id="relatorios-section" class="content-section">
            <h2>Relatórios Financeiros</h2>
            <div class="form-grid">
                 <div class="form-group">
                    <label for="data-inicio-relatorio">Data Inicial:</label>
                    <input type="date" id="data-inicio-relatorio">
                </div>
                <div class="form-group">
                    <label for="data-fim-relatorio">Data Final:</label>
                    <input type="date" id="data-fim-relatorio">
                </div>
            </div>
            <div style="margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 1rem;">
                <button onclick="gerarRelatorio('previsao')" class="btn" style="background-color:#17a2b8;">Gerar Previsão</button>
                <button onclick="gerarRelatorio('descontos')" class="btn" style="background-color:#dc3545;">Gerar Descontos</button>
                <button onclick="gerarRelatorio('final')" class="btn">Gerar Relatório Final</button>
            </div>
            <div id="resultado-relatorio" style="margin-top: 2rem;">
                <p>Selecione um período e um tipo de relatório para começar.</p>
            </div>
        </section>

        <div id="modal-permissoes" style="display:none; position:fixed; z-index:2000; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.6);">
            <div style="background-color:#fff; margin:10% auto; padding:2rem; border-radius:8px; width:80%; max-width:800px;">
                <h2 id="modal-permissoes-titulo">Permissões do Perfil</h2>
                <div id="permissoes-container"></div>
                <div style="text-align:right; margin-top:2rem;">
                    <button class="btn" id="btn-salvar-permissoes">Salvar</button>
                    <button class="btn btn-cancel" onclick="document.getElementById('modal-permissoes').style.display='none'">Cancelar</button>
                </div>
            </div>
        </div>
    </main>
</div>

<footer>
    <p>Record PAP - Internet Fibra Ótica</p>
    <p>Contato: (31) 99458-8810 | E-mail: <a href="mailto:suporte@recordpap.com.br">suporte@recordpap.com.br</a></p>
    <p><a href="politica-de-privacidade.html">Política de Privacidade</a> | <a href="#">Termos de Uso</a></p>
</footer>

<script>
    const apiUrl = 'http://127.0.0.1:8000/api';
const token = localStorage.getItem('accessToken'); // Usa o novo nome do token
const userProfile = localStorage.getItem('userProfile');

// Função universal para fazer requisições à API com o token
async function apiFetch(endpoint, options = {}) {
    const headers = {
        'Content-Type': 'application/json',
        ...options.headers,
    };
    if (token) {
        headers['Authorization'] = `Bearer ${token}`;
    }

    const response = await fetch(`${apiUrl}${endpoint}`, { ...options, headers });

    if (response.status === 401) {
        alert('Sua sessão expirou ou o token é inválido. Por favor, faça login novamente.');
        logout();
        throw new Error('Não autorizado');
    }
    if (!response.ok) {
        const errorData = await response.json();
        // Tenta extrair a mensagem de erro da forma mais detalhada possível
        const errorMessage = errorData.detail || JSON.stringify(errorData).replace(/["{}[\]]/g, ' ');
        throw new Error(errorMessage);
    }
    if (response.status === 204) { // Para requisições DELETE que não retornam corpo
        return null;
    }
    return response.json();
}

    if (!token) {
         alert('Acesso negado. Faça o login para continuar.');
         window.location.href = '/';
         
    }
    if (userProfile !== 'Diretoria' && userProfile !== 'Admin') { // Aceita Admin para o superuser
        alert('Acesso negado. Você não tem permissão para ver esta página.');
        window.location.href = '/area-interna/';
        
    }

    // --- LÓGICA GERAL DA PÁGINA ---
    function mostrarSecao(idSecao, menuItem) {
        document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
        document.getElementById(`${idSecao}-section`).classList.add('active');
        if (menuItem) {
            document.querySelectorAll('.nav-menu li').forEach(li => li.classList.remove('active'));
            menuItem.classList.add('active');
        }
    }
    
    function openTab(evt, tabName) {
        const parentSection = evt.currentTarget.closest('.content-section');
        parentSection.querySelectorAll('.tab-content').forEach(tabcontent => {
            tabcontent.style.display = "none";
        });
        parentSection.querySelectorAll('.tab-nav button').forEach(tablink => {
            tablink.classList.remove("active");
        });
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.classList.add("active");
    }

    // --- LÓGICA DE GESTÃO DE USUÁRIOS ---
    const userForm = document.getElementById('user-form');
    const formTitle = document.getElementById('form-title');
    const userIdInput = document.getElementById('user_id');
    const userListBody = document.getElementById('user-list-body');
    const userListHeader = document.getElementById('user-list-header');
    const listaStatusTitulo = document.getElementById('lista-status-titulo');
    const selectPerfil = document.getElementById('perfil_id');
    const selectSupervisor = document.getElementById('supervisor_id');

    function resetForm() {
        userForm.reset();
        userIdInput.value = '';
        formTitle.textContent = 'Cadastrar Novo Usuário';
        document.getElementById('senha').placeholder = 'Senha Provisória';
        document.getElementById('senha').required = true;
    }

    function mostrarListaUsuarios(status, tabElement) {
        if (tabElement) {
            document.querySelectorAll('#usuarios-section .tab-nav button').forEach(btn => btn.classList.remove('active'));
            tabElement.classList.add('active');
        }
        listaStatusTitulo.textContent = status === 'ativos' ? 'Ativos' : 'Inativos';
        carregarUsuarios(status);
    }

    async function carregarUsuarios(status = 'ativos') {
    try {
        const usuarios = await apiFetch(`/usuarios/?is_active=${status === 'ativos'}`);
        userListBody.innerHTML = ''; 
        if (status === 'ativos') {
            userListHeader.innerHTML = '<th>Nome</th><th>E-mail</th><th>Perfil</th><th>Líder Imediato</th><th>Ações</th>';
            usuarios.forEach(user => {
                // --- CORREÇÃO ABAIXO ---
                // Trocamos 'user.supervisor' por 'user.supervisor_nome' para exibir o nome.
                const supervisorDisplay = user.supervisor_nome || 'N/A';
                userListBody.innerHTML += `<tr><td>${user.nome_completo}</td><td>${user.email}</td><td>${user.perfil}</td><td>${supervisorDisplay}</td><td class="actions-cell"><button class="btn-edit" title="Editar" onclick='iniciarEdicao(${JSON.stringify(user)})'>Editar</button><button class="btn-delete" title="Inativar" onclick="inativarUsuario(${user.id})">Inativar</button></td></tr>`;
            });
        } else { 
            userListHeader.innerHTML = '<th>Nome</th><th>E-mail</th><th>Perfil</th><th>Ações</th>';
            usuarios.forEach(user => {
                userListBody.innerHTML += `<tr><td>${user.nome_completo}</td><td>${user.email}</td><td>${user.perfil}</td><td class="actions-cell"><button class="btn-reactivate" title="Reativar" onclick="reativarUsuario(${user.id})">Reativar</button></td></tr>`;
            });
        }
    } catch (error) { console.error("Erro ao carregar usuários:", error); }
}

    async function carregarDadosParaFormulario() {
        selectPerfil.innerHTML = '';
        selectSupervisor.innerHTML = '<option value="">Nenhum</option>';
        try {
            const perfis = await apiFetch('/perfis/');
            perfis.forEach(perfil => selectPerfil.add(new Option(perfil.nome, perfil.id)));
        } catch (error) { console.error('Erro ao carregar perfis no form:', error); }
        try {
            const supervisores = await apiFetch('/supervisores/');
            supervisores.forEach(sup => selectSupervisor.add(new Option(sup.nome_completo, sup.id)));
        } catch (error) { console.error('Erro ao carregar supervisores:', error); }
    }

    function iniciarEdicao(user) {
        resetForm();
        formTitle.textContent = 'Editando Usuário';
        userIdInput.value = user.id;
        document.getElementById('nome_completo').value = user.nome_completo;
        document.getElementById('cpf').value = user.cpf;
        document.getElementById('email').value = user.email;
        document.getElementById('username').value = user.username; // Popula o novo campo username
        selectPerfil.value = user.perfil_id;
        selectSupervisor.value = user.supervisor_id || '';
        document.getElementById('valor_almoco').value = user.valor_almoco;
        document.getElementById('valor_passagem').value = user.valor_passagem;
        document.getElementById('chave_pix').value = user.chave_pix || '';
        document.getElementById('nome_da_conta').value = user.nome_da_conta || '';
        
        document.getElementById('meta_comissao').value = user.meta_comissao;
        document.getElementById('desconto_boleto').value = user.desconto_boleto;
        document.getElementById('desconto_inclusao_viabilidade').value = user.desconto_inclusao_viabilidade;
        document.getElementById('desconto_instalacao_antecipada').value = user.desconto_instalacao_antecipada;
        document.getElementById('adiantamento_cnpj').value = user.adiantamento_cnpj;
        document.getElementById('desconto_inss_fixo').value = user.desconto_inss_fixo;

        document.getElementById('senha').placeholder = 'Deixe em branco para não alterar';
        document.getElementById('senha').required = false;
        window.scrollTo(0, 0);
    }
    
    userForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const id = userIdInput.value;
        const isEditing = !!id;
        const url = isEditing ? `/usuarios/${id}/` : '/usuarios/';
        const method = isEditing ? 'PUT' : 'POST';
        const nomeCompleto = document.getElementById('nome_completo').value.trim();
        const nomeParts = nomeCompleto.split(' ');
        const firstName = nomeParts.shift();      // A primeira palavra é o nome
        const lastName = nomeParts.join(' ');     // O resto é o sobrenome
        
        const body = {
            first_name: firstName,
            last_name: lastName,
            cpf: document.getElementById('cpf').value,
            email: document.getElementById('email').value, // Mantém o email
            perfil_id: selectPerfil.value,
            username: document.getElementById('username').value, // Usa o novo campo username
            supervisor: selectSupervisor.value || null, // Alterado para enviar null se vazio
            valor_almoco: document.getElementById('valor_almoco').value,
            valor_passagem: document.getElementById('valor_passagem').value,
            chave_pix: document.getElementById('chave_pix').value,
            nome_da_conta: document.getElementById('nome_da_conta').value,
            meta_comissao: document.getElementById('meta_comissao').value,
            desconto_boleto: document.getElementById('desconto_boleto').value,
            desconto_inclusao_viabilidade: document.getElementById('desconto_inclusao_viabilidade').value,
            desconto_instalacao_antecipada: document.getElementById('desconto_instalacao_antecipada').value,
            adiantamento_cnpj: document.getElementById('adiantamento_cnpj').value,
            desconto_inss_fixo: document.getElementById('desconto_inss_fixo').value
        };

        const senha = document.getElementById('senha').value;
        if (isEditing) {
            if (senha && senha.trim() !== '') {
                body.password = senha; // Alterado para 'password'
            }
        } else {
            body.senha = senha;
            if (!body.senha) { return alert('A senha é obrigatória para novos usuários.'); }
        }
        try {
            const result = await apiFetch(url, {
                method: method,
                body: JSON.stringify(body)
            });
            alert(`Usuário ${isEditing ? 'atualizado' : 'cadastrado'} com sucesso!`);
            resetForm();
            mostrarListaUsuarios('ativos', document.querySelector('#usuarios-section .tab-nav button.active'));
            carregarDadosParaFormulario();
        } catch (error) { 
            console.error('Detalhes do erro ao salvar usuário:', error);
            alert(`Erro: ${error.message}`);
        }
    });

    async function inativarUsuario(id) {
        if (!confirm('Tem certeza que deseja INATIVAR este usuário?')) return;
        try {
            await apiFetch(`/usuarios/${id}/`, { method: 'DELETE' });
            alert('Usuário inativado com sucesso.');
            mostrarListaUsuarios('ativos', document.querySelector('#usuarios-section .tab-nav button.active'));
        } catch(error) { 
            console.error('Detalhes do erro ao inativar usuário:', error);
            alert(`Erro: ${error.message}`);
        }
    }

    async function reativarUsuario(id) {
        if (!confirm('Tem certeza que deseja REATIVAR este usuário?')) return;
        try {
            await apiFetch(`/usuarios/${id}/reativar/`, { method: 'PUT' });
            alert('Usuário reativado com sucesso.');
            carregarUsuarios('inativos');
        } catch(error) { 
            console.error('Detalhes do erro ao reativar usuário:', error);
            alert(`Erro: ${error.message}`);
        }
    }

    // --- LÓGICA DE GESTÃO DE PERFIS ---
    const listaPerfisUl = document.getElementById('lista-perfis');
    async function carregarPerfis() {
        try {
            const perfis = await apiFetch('/perfis/');
            listaPerfisUl.innerHTML = '';
            perfis.forEach(perfil => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${perfil.nome}</span>
                    <div class="generic-list-actions">
                        <button class="btn" style="background-color: #17a2b8;" onclick="abrirModalPermissoes(${perfil.id}, '${perfil.nome}')">Permissões</button>
                        <button class="btn-edit" onclick="editarPerfil(${perfil.id}, '${perfil.nome}')">Editar</button>
                        <button class="btn-delete" onclick="excluirPerfil(${perfil.id})">Excluir</button>
                    </div>
                `;
                listaPerfisUl.appendChild(li);
            });
        } catch (error) { console.error('Erro ao carregar perfis:', error); }
    }

    document.getElementById('btn-salvar-perfil').addEventListener('click', async () => {
        const nome = document.getElementById('novo-perfil-nome').value.trim();
        if (!nome) return alert('Por favor, digite um nome para o perfil.');
        try {
            await apiFetch('/perfis/', { method: 'POST', body: JSON.stringify({ nome }) });
            document.getElementById('novo-perfil-nome').value = '';
            await carregarPerfis();
            await carregarDadosParaFormulario();
        } catch (error) { 
            console.error('Detalhes do erro ao salvar perfil:', error);
            alert(`Erro: ${error.message}`);
        }
    });

    async function editarPerfil(id, nomeAtual) {
        const novoNome = prompt('Digite o novo nome para o perfil:', nomeAtual);
        if (!novoNome || novoNome.trim() === '') return;
        try {
            await apiFetch(`/perfis/${id}/`, { method: 'PUT', body: JSON.stringify({ nome: novoNome.trim() }) });
            await carregarPerfis();
            await carregarDadosParaFormulario();
        } catch (error) { 
            console.error('Detalhes do erro ao editar perfil:', error);
            alert(`Erro: ${error.message}`);
        }
    }

    async function excluirPerfil(id) {
        if (!confirm('Tem certeza que deseja excluir este perfil? Esta ação não pode ser desfeita.')) return;
        try {
            await apiFetch(`/perfis/${id}/`, { method: 'DELETE' });
            await carregarPerfis();
            await carregarDadosParaFormulario();
        } catch (error) { 
            console.error('Detalhes do erro ao excluir perfil:', error);
            alert(`Erro: ${error.message}`);
        }
    }

    // --- LÓGICA DE GESTÃO DE MOTIVOS DE AUSÊNCIA ---
    const listaMotivosUl = document.getElementById('lista-motivos');
    async function carregarMotivos() {
        try {
            const motivos = await apiFetch('/motivos/');
            listaMotivosUl.innerHTML = '';
            motivos.forEach(motivo => {
                const statusDesconto = motivo.gera_desconto ? '<span style="color:red;">(Gera Desconto)</span>' : '<span style="color:green;">(Não Gera Desconto)</span>';
                const li = document.createElement('li');
                li.innerHTML = `<span>${motivo.motivo} ${statusDesconto}</span>
                    <div class="generic-list-actions">
                        <button class="btn-edit" onclick="editarMotivo(${motivo.id}, '${motivo.motivo}')">Editar</button>
                        <button class="btn-delete" onclick="excluirMotivo(${motivo.id})">Excluir</button>
                    </div>`;
                listaMotivosUl.appendChild(li);
            });
        } catch (error) { console.error('Erro ao carregar motivos:', error); }
    }

    document.getElementById('btn-salvar-motivo').addEventListener('click', async () => {
        const motivo = document.getElementById('novo-motivo-nome').value.trim();
        const gera_desconto = document.getElementById('novo-motivo-desconto').checked;
        if (!motivo) return alert('Por favor, digite um nome para o motivo.');
        try {
            await apiFetch('/motivos/', {
                method: 'POST',
                body: JSON.stringify({ motivo, gera_desconto })
            });
            document.getElementById('novo-motivo-nome').value = '';
            document.getElementById('novo-motivo-desconto').checked = true;
            carregarMotivos();
        } catch (error) { 
            console.error('Detalhes do erro ao salvar motivo:', error);
            alert(`Erro: ${error.message}`);
        }
    });

    async function editarMotivo(id, nomeAtual) {
        const novoNome = prompt('Digite o novo nome para o motivo:', nomeAtual);
        if (!novoNome || novoNome.trim() === '') return;
        const gera_desconto = confirm('Este motivo deve gerar desconto no pagamento? \n\nClique em "OK" para SIM, ou "Cancelar" para NÃO.');
        try {
            await apiFetch(`/motivos/${id}/`, {
                method: 'PUT',
                body: JSON.stringify({ motivo: novoNome.trim(), gera_desconto })
            });
            carregarMotivos();
        } catch (error) { 
            console.error('Detalhes do erro ao editar motivo:', error);
            alert(`Erro: ${error.message}`);
        }
    }

    async function excluirMotivo(id) {
        if (!confirm('Tem certeza que deseja excluir este motivo?')) return;
        try {
            await apiFetch(`/motivos/${id}/`, { method: 'DELETE' });
            carregarMotivos();
        } catch (error) { 
            console.error('Detalhes do erro ao excluir motivo:', error);
            alert(`Erro: ${error.message}`);
        }
    }
    
    // --- LÓGICA DE GESTÃO DE FERIADOS ---
    const listaFeriadosTbody = document.getElementById('lista-feriados');
    async function carregarFeriados() {
        try {
            const feriados = await apiFetch('/dias-nao-uteis/');
            listaFeriadosTbody.innerHTML = '';
            feriados.forEach(feriado => {
                const dataFormatada = new Date(feriado.data).toLocaleDateString('pt-BR', { timeZone: 'UTC' });
                const row = `<tr><td>${dataFormatada}</td><td>${feriado.descricao}</td><td><button class="btn-delete" onclick="excluirFeriado(${feriado.id})">Excluir</button></td></tr>`;
                listaFeriadosTbody.innerHTML += row;
            });
        } catch (error) { console.error('Erro ao carregar feriados:', error); }
    }

    document.getElementById('btn-salvar-feriado').addEventListener('click', async () => {
        const data = document.getElementById('novo-feriado-data').value;
        const descricao = document.getElementById('novo-feriado-descricao').value.trim();
        if (!data || !descricao) return alert('A data e a descrição são obrigatórias.');
        try {
            await apiFetch('/dias-nao-uteis/', {
                method: 'POST',
                body: JSON.stringify({ data, descricao })
            });
            document.getElementById('novo-feriado-data').value = '';
            document.getElementById('novo-feriado-descricao').value = '';
            carregarFeriados();
        } catch (error) { 
            console.error('Detalhes do erro ao salvar feriado:', error);
            alert(`Erro: ${error.message}`);
        }
    });

    async function excluirFeriado(id) {
        if (!confirm('Tem certeza que deseja excluir este dia?')) return;
        try {
            await apiFetch(`/dias-nao-uteis/${id}/`, { method: 'DELETE' });
            carregarFeriados();
        } catch (error) { 
            console.error('Detalhes do erro ao excluir feriado:', error);
            alert(`Erro: ${error.message}`);
        }
    }
    
    // --- LÓGICA DE RELATÓRIOS ---
    async function gerarRelatorio(tipo) {
        const dataInicio = document.getElementById('data-inicio-relatorio').value;
        const dataFim = document.getElementById('data-fim-relatorio').value;
        if (!dataInicio || !dataFim) { return alert('Por favor, selecione a data inicial e final.'); }

        const container = document.getElementById('resultado-relatorio');
        container.innerHTML = '<p>Gerando relatório, aguarde...</p>';
        
        let url = '';
        switch (tipo) {
            case 'previsao':
                url = `/relatorios/previsao?dataInicio=${dataInicio}&dataFim=${dataFim}`;
                break;
            case 'descontos':
                url = `/relatorios/descontos?dataInicio=${dataInicio}&dataFim=${dataFim}`;
                break;
            case 'final':
                url = `/relatorios/semanal?dataInicio=${dataInicio}&dataFim=${dataFim}`;
                break;
            default:
                container.innerHTML = '<p style="color:red;">Tipo de relatório inválido.</p>';
                return;
        }

        try {
            const relatorio = await apiFetch(url);
            renderizarTabelaRelatorio(tipo, relatorio);
        }
        catch(error) {
            container.innerHTML = `<p style="color:red;">${error.message}</p>`;
        }
    }

    function renderizarTabelaRelatorio(tipo, relatorio) {
        const container = document.getElementById('resultado-relatorio');
        const inicioFormatado = new Date(relatorio.periodo.inicio + 'T03:00:00Z').toLocaleDateString('pt-BR');
        const fimFormatado = new Date(relatorio.periodo.fim + 'T03:00:00Z').toLocaleDateString('pt-BR');
        const periodoFormatado = `<h3>Relatório do Período de ${inicioFormatado} a ${fimFormatado}</h3>`;
        let html = '';

        if (!relatorio.dados || relatorio.dados.length === 0) {
            container.innerHTML = `${periodoFormatado}<p style="text-align:center;">Nenhum dado encontrado para este período.</p>`;
            return;
        }

        switch (tipo) {
            case 'previsao':
                html = `${periodoFormatado}<h4>Dias úteis no período: ${relatorio.periodo.dias_uteis}</h4><table><thead><tr><th>Vendedor</th><th>Auxílio Diário</th><th>Previsão para o Período</th></tr></thead><tbody>`;
                relatorio.dados.forEach(item => {
                    html += `<tr><td>${item.nome_completo}</td><td>R$ ${Number(item.auxilio_diario).toFixed(2).replace('.',',')}</td><td><strong>R$ ${Number(item.previsao_periodo).toFixed(2).replace('.',',')}</strong></td></tr>`;
                });
                break;
            case 'descontos':
                html = `${periodoFormatado}<table><thead><tr><th>Vendedor</th><th>Data da Falta</th><th>Motivo</th><th>Valor a Descontar</th></tr></thead><tbody>`;
                relatorio.dados.forEach(item => {
                    const dataFalta = new Date(item.data).toLocaleDateString('pt-BR', { timeZone: 'UTC' });
                    html += `<tr><td>${item.nome_completo}</td><td>${dataFalta}</td><td>${item.motivo}</td><td style="color:red;">R$ ${Number(item.valor_desconto).toFixed(2).replace('.',',')}</td></tr>`;
                });
                break;
            case 'final':
                html = `${periodoFormatado}<table><thead><tr><th>Vendedor</th><th>Dias Trabalhados</th><th>Faltas c/ Desconto</th><th>A Receber</th><th>A Descontar</th><th>Valor Final</th></tr></thead><tbody>`;
                relatorio.dados.forEach(item => {
                    html += `<tr><td>${item.nome_completo}</td><td>${item.dias_trabalhados}</td><td>${item.dias_falta_com_desconto}</td><td>R$ ${Number(item.total_a_receber).toFixed(2).replace('.',',')}</td><td style="color:red;">R$ ${Number(item.total_a_descontar).toFixed(2).replace('.',',')}</td><td><strong>R$ ${Number(item.valor_final).toFixed(2).replace('.',',')}</strong></td></tr>`;
                });
                break;
        }
        html += `</tbody></table>`;
        container.innerHTML = html;
    }

    // --- LÓGICA DE PERMISSÕES ---
    const modalPermissoes = document.getElementById('modal-permissoes');
    const permissoesContainer = document.getElementById('permissoes-container');
    const modalPermissoesTitulo = document.getElementById('modal-permissoes-titulo');
    const btnSalvarPermissoes = document.getElementById('btn-salvar-permissoes');
    let perfilIdAtual = null;

    const recursosDisponiveis = [
        'operadoras', 'planos', 'formas_pagamento', 
        'status_tratamento', 'status_esteira', 'status_comissionamento'
    ];

    async function abrirModalPermissoes(perfilId, perfilNome) {
        perfilIdAtual = perfilId;
        modalPermissoesTitulo.textContent = `Permissões do Perfil: ${perfilNome}`;

        try {
            const permissoesSalvas = await apiFetch(`/perfis/${perfilId}/permissoes/`);

            const permissoesMap = permissoesSalvas.reduce((acc, p) => {
                acc[p.recurso] = p;
                return acc;
            }, {});

            permissoesContainer.innerHTML = `
                <table style="width:100%">
                    <thead>
                        <tr>
                            <th>Recurso</th>
                            <th>Ver</th>
                            <th>Criar</th>
                            <th>Editar</th>
                            <th>Excluir</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${recursosDisponiveis.map(recurso => {
                            const p = permissoesMap[recurso] || {};
                            return `
                            <tr>
                                <td>${recurso.replace(/_/g, ' ')}</td>
                                <td><input type="checkbox" data-recurso="${recurso}" data-acao="pode_ver" ${p.pode_ver ? 'checked' : ''}></td>
                                <td><input type="checkbox" data-recurso="${recurso}" data-acao="pode_criar" ${p.pode_criar ? 'checked' : ''}></td>
                                <td><input type="checkbox" data-recurso="${recurso}" data-acao="pode_editar" ${p.pode_editar ? 'checked' : ''}></td>
                                <td><input type="checkbox" data-recurso="${recurso}" data-acao="pode_excluir" ${p.pode_excluir ? 'checked' : ''}></td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
            `;

            modalPermissoes.style.display = 'block';
        } catch (error) {
            console.error("Erro ao buscar permissões:", error);
            alert("Não foi possível carregar as permissões.");
        }
    }

    btnSalvarPermissoes.addEventListener('click', async () => {
        const checkboxes = permissoesContainer.querySelectorAll('input[type="checkbox"]');
        const permissoesParaEnviar = [];

        // Estrutura para facilitar a busca e atualização das permissões
        const permissoesMap = {};

        checkboxes.forEach(cb => {
            const recurso = cb.dataset.recurso;
            const acao = cb.dataset.acao;

            // Encontra ou cria o objeto de permissão para o recurso
            if (!permissoesMap[recurso]) {
                permissoesMap[recurso] = {
                    // Use 'perfil_id' em vez de 'perfil' para enviar o ID do perfil
                    perfil_id: perfilIdAtual,
                    recurso: recurso,
                    pode_ver: false,
                    pode_criar: false,
                    pode_editar: false,
                    pode_excluir: false
                };
                permissoesParaEnviar.push(permissoesMap[recurso]);
            }

            // Define o estado do checkbox na permissão
            permissoesMap[recurso][acao] = cb.checked;
        });

        try {
            // Confirme que estamos enviando a lista de objetos com perfil_id
            console.log("Dados de permissões enviados:", permissoesParaEnviar);

            await apiFetch(`/perfis/${perfilIdAtual}/permissoes/`, {
                method: 'PUT',
                body: JSON.stringify(permissoesParaEnviar)
            });
            alert('Permissões salvas com sucesso!');
            modalPermissoes.style.display = 'none';
        } catch (error) {
            console.error("Erro ao salvar permissões:", error);
            alert(`Erro: ${error.message}`);
        }
    });


    // --- LÓGICA PARA CADASTROS GERAIS (CRM) ---
    
    // ** LÓGICA DE GESTÃO DE OPERADORAS **
    const formOperadora = document.getElementById('form-operadora');
    const listaOperadoras = document.getElementById('lista-operadoras');
    const operadoraIdInput = document.getElementById('operadora_id');
    const operadoraNomeInput = document.getElementById('operadora_nome');
    const operadoraCnpjInput = document.getElementById('operadora_cnpj');
    const operadoraStatusSelect = document.getElementById('operadora_status');

    async function carregarOperadoras() {
        try {
            const operadoras = await apiFetch('/crm-cadastros/operadoras/');
            
            listaOperadoras.innerHTML = '';
            operadoras.forEach(op => {
                const tr = document.createElement('tr');
                const statusTexto = op.status ? 'Ativo' : 'Inativo';
                const statusCor = op.status ? 'green' : 'red';
                tr.innerHTML = `
                    <td>${op.nome}</td>
                    <td>${op.cnpj || 'N/A'}</td>
                    <td style="color: ${statusCor};">${statusTexto}</td>
                    <td class="actions-cell">
                        <button class="btn-edit" onclick='editarOperadora(${JSON.stringify(op)})'>Editar</button>
                        <button class="btn-delete" onclick="deletarOperadora(${op.id})">Excluir</button>
                    </td>
                `;
                listaOperadoras.appendChild(tr);
            });
        } catch (error) {
            console.error('Erro ao carregar operadoras:', error);
        }
    }

    function resetFormOperadora() {
        formOperadora.reset();
        operadoraIdInput.value = '';
    }

    formOperadora.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = operadoraIdInput.value;
        const url = id ? `/crm-cadastros/operadoras/${id}/` : '/crm-cadastros/operadoras/';
        const method = id ? 'PUT' : 'POST';

        const body = JSON.stringify({
            nome: operadoraNomeInput.value,
            cnpj: operadoraCnpjInput.value,
            status: operadoraStatusSelect.value === '1'
        });

        try {
            await apiFetch(url, { method, body });
            alert(`Operadora ${id ? 'atualizada' : 'criada'} com sucesso!`);
            resetFormOperadora();
            carregarOperadoras();
        } catch (error) {
            console.error('Detalhes do erro:', error);
            alert(`Erro: ${error.message}`);
        }
    });

    function editarOperadora(operadora) {
        operadoraIdInput.value = operadora.id;
        operadoraNomeInput.value = operadora.nome;
        operadoraCnpjInput.value = operadora.cnpj;
        operadoraStatusSelect.value = operadora.status ? '1' : '0';
        window.scrollTo(0, 0);
    }

    async function deletarOperadora(id) {
        if (!confirm('Tem certeza que deseja excluir esta operadora?')) return;
        try {
            await apiFetch(`/crm-cadastros/operadoras/${id}/`, { method: 'DELETE' });
            alert('Operadora excluída com sucesso!');
            carregarOperadoras();
        } catch (error) {
            console.error('Detalhes do erro ao deletar:', error);
            alert(`Erro: ${error.message}`);
        }
    }

    // ** LÓGICA DE GESTÃO DE PLANOS **
    const formPlano = document.getElementById('form-plano');
    const listaPlanos = document.getElementById('lista-planos');
    const planoIdInput = document.getElementById('plano_id');
    const planoNomeInput = document.getElementById('plano_nome');
    const planoValorInput = document.getElementById('plano_valor');
    const planoComissaoInput = document.getElementById('plano_comissao');
    const planoOperadoraSelect = document.getElementById('plano_operadora_id');
    const planoBeneficiosInput = document.getElementById('plano_beneficios');

    async function carregarPlanos() {
        try {
            const [planos, operadoras] = await Promise.all([
                apiFetch('/crm-cadastros/planos/'),
                apiFetch('/crm-cadastros/operadoras/')
            ]);

            listaPlanos.innerHTML = '';
            planos.forEach(plano => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${plano.nome}</td>
                    <td>${plano.operadora_nome}</td>
                    <td>R$ ${Number(plano.valor).toFixed(2)}</td>
                    <td>R$ ${Number(plano.comissao_base).toFixed(2)}</td>
                    <td class="actions-cell">
                        <button class="btn-edit" onclick='editarPlano(${JSON.stringify(plano)})'>Editar</button>
                        <button class="btn-delete" onclick="deletarPlano(${plano.id})">Excluir</button>
                    </td>
                `;
                listaPlanos.appendChild(tr);
            });

            planoOperadoraSelect.innerHTML = '<option value="">Selecione...</option>';
            operadoras.forEach(op => {
                planoOperadoraSelect.add(new Option(op.nome, op.id));
            });
        } catch (error) {
            console.error('Erro ao carregar planos:', error);
        }
    }

    function resetFormPlano() {
        formPlano.reset();
        planoIdInput.value = '';
    }

    formPlano.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = planoIdInput.value;
        const url = id ? `/crm-cadastros/planos/${id}/` : '/crm-cadastros/planos/';
        const method = id ? 'PUT' : 'POST';

        const body = JSON.stringify({
            nome: planoNomeInput.value,
            valor: parseFloat(planoValorInput.value),
            comissao_base: parseFloat(planoComissaoInput.value) || 0,
            operadora: planoOperadoraSelect.value,
            beneficios: planoBeneficiosInput.value,
            status: true
        });

        try {
            await apiFetch(url, { method, body });
            alert(`Plano ${id ? 'atualizado' : 'criado'} com sucesso!`);
            resetFormPlano();
            carregarPlanos();
        } catch (error) {
            console.error('Detalhes do erro ao salvar plano:', error);
            alert(`Erro: ${error.message}`);
        }
    });

    function editarPlano(plano) {
        planoIdInput.value = plano.id;
        planoNomeInput.value = plano.nome;
        planoValorInput.value = plano.valor;
        planoComissaoInput.value = plano.comissao_base;
        planoOperadoraSelect.value = plano.operadora;
        planoBeneficiosInput.value = plano.beneficios || '';
        document.querySelector('button[onclick*="planos"]').click();
        window.scrollTo(0, 0);
    }

    async function deletarPlano(id) {
        if (!confirm('Tem certeza que deseja excluir este plano?')) return;
        try {
            await apiFetch(`/crm-cadastros/planos/${id}/`, { method: 'DELETE' });
            alert('Plano excluído com sucesso!');
            carregarPlanos();
        } catch (error) {
            console.error('Detalhes do erro ao deletar plano:', error);
            alert(`Erro: ${error.message}`);
        }
    }
    
    // --- LÓGICA DE GESTÃO DE FORMAS DE PAGAMENTO ---
    const listaFormasPagamentoUl = document.getElementById('lista-formas-pagamento');
    async function carregarFormasPagamento() {
        try {
            const formas = await apiFetch('/crm-cadastros/formas-pagamento/');
            listaFormasPagamentoUl.innerHTML = '';
            formas.forEach(forma => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${forma.nome}</span>
                    <div class="generic-list-actions">
                        <button class="btn-edit" onclick="editarFormaPagamento(${forma.id}, '${forma.nome.replace(/'/g, "\\'")}')">Editar</button>
                        <button class="btn-delete" onclick="excluirFormaPagamento(${forma.id})">Excluir</button>
                    </div>`;
                listaFormasPagamentoUl.appendChild(li);
            });
        } catch (error) { console.error('Erro ao carregar formas de pagamento:', error); }
    }
    document.getElementById('btn-salvar-forma-pagamento').addEventListener('click', async () => {
        const nome = document.getElementById('nova-forma-pagamento-nome').value.trim();
        if (!nome) return alert('Por favor, digite um nome.');
        try {
            await apiFetch('/crm-cadastros/formas-pagamento/', {
                method: 'POST',
                body: JSON.stringify({ nome: nome, status: true })
            });
            document.getElementById('nova-forma-pagamento-nome').value = '';
            carregarFormasPagamento();
        } catch (error) { 
            alert(`Erro: ${error.message}`);
        }
    });
    async function editarFormaPagamento(id, nomeAtual) {
        const novoNome = prompt('Digite o novo nome:', nomeAtual);
        if (novoNome && novoNome.trim() !== '') {
            try {
                await apiFetch(`/crm-cadastros/formas-pagamento/${id}/`, {
                    method: 'PUT',
                    body: JSON.stringify({ nome: novoNome.trim(), status: true })
                });
                carregarFormasPagamento();
            } catch (error) { 
                alert(`Erro: ${error.message}`);
            }
        }
    }
    async function excluirFormaPagamento(id) {
        if (!confirm('Tem certeza que deseja excluir?')) return;
        try {
            await apiFetch(`/crm-cadastros/formas-pagamento/${id}/`, { method: 'DELETE' });
            carregarFormasPagamento();
        } catch (error) { 
            alert(`Erro: ${error.message}`);
        }
    }

    // --- LÓGICA DE GESTÃO DE STATUS CRM ---
    const formStatus = document.getElementById('form-status');
    const listaStatusBody = document.getElementById('lista-status');
    const statusIdInput = document.getElementById('status_id');
    const statusNomeInput = document.getElementById('status_nome');
    const statusTipoSelect = document.getElementById('status_tipo');
    const statusEstadoInput = document.getElementById('status_estado');
    const statusCorInput = document.getElementById('status_cor');
    const statusEstadoGroup = document.getElementById('status_estado_group');

    statusTipoSelect.addEventListener('change', () => {
        if (statusTipoSelect.value === 'Comissionamento') {
            statusEstadoGroup.style.display = 'none';
        } else {
            statusEstadoGroup.style.display = 'block';
        }
    });

    function resetFormStatus() {
        formStatus.reset();
        statusIdInput.value = '';
        statusEstadoGroup.style.display = 'block';
    }

    async function carregarStatus() {
        try {
            const statusList = await apiFetch('/crm-cadastros/status/');
            listaStatusBody.innerHTML = '';
            statusList.forEach(s => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><span class="color-box" style="background-color: ${s.cor};"></span> ${s.nome}</td>
                    <td>${s.tipo}</td>
                    <td>${s.estado || 'N/A'}</td>
                    <td>${s.cor}</td>
                    <td class="actions-cell">
                        <button class="btn-edit" onclick='editarStatus(${JSON.stringify(s)})'>Editar</button>
                        <button class="btn-delete" onclick="excluirStatus(${s.id})">Excluir</button>
                    </td>
                `;
                listaStatusBody.appendChild(tr);
            });
        } catch (error) {
            console.error('Erro ao carregar status:', error);
        }
    }

    formStatus.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = statusIdInput.value;
        const url = id ? `/crm-cadastros/status/${id}/` : '/crm-cadastros/status/';
        const method = id ? 'PUT' : 'POST';

        const body = {
            nome: statusNomeInput.value,
            tipo: statusTipoSelect.value,
            estado: statusTipoSelect.value === 'Comissionamento' ? null : statusEstadoInput.value,
            cor: statusCorInput.value
        };

        try {
            await apiFetch(url, {
                method,
                body: JSON.stringify(body)
            });
            alert(`Status ${id ? 'atualizado' : 'criado'} com sucesso!`);
            resetFormStatus();
            carregarStatus();
        } catch (error) {
            alert(`Erro: ${error.message}`);
        }
    });

    function editarStatus(status) {
        statusIdInput.value = status.id;
        statusNomeInput.value = status.nome;
        statusTipoSelect.value = status.tipo;
        statusEstadoInput.value = status.estado || '';
        statusCorInput.value = status.cor;
        statusTipoSelect.dispatchEvent(new Event('change'));
        window.scrollTo(0, 0);
    }

    async function excluirStatus(id) {
        if (!confirm('Tem certeza que deseja excluir este status?')) return;
        try {
            await apiFetch(`/crm-cadastros/status/${id}/`, { method: 'DELETE' });
            alert('Status excluído com sucesso!');
            carregarStatus();
        } catch (error) {
            alert(`Erro: ${error.message}`);
        }
    }

    // --- LÓGICA DE GESTÃO DE MOTIVOS DE PENDÊNCIA ---
    const formPendencia = document.getElementById('form-pendencia');
    const listaPendenciasBody = document.getElementById('lista-pendencias');
    const pendenciaIdInput = document.getElementById('pendencia_id');
    const pendenciaNomeInput = document.getElementById('pendencia_nome');
    const pendenciaTipoInput = document.getElementById('pendencia_tipo');

    function resetFormPendencia() {
        formPendencia.reset();
        pendenciaIdInput.value = '';
    }
    
    async function carregarMotivosPendencia() {
        try {
            const pendencias = await apiFetch('/crm-cadastros/motivos-pendencia/');
            listaPendenciasBody.innerHTML = '';
            pendencias.forEach(p => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${p.nome}</td>
                    <td>${p.tipo_pendencia}</td>
                    <td class="actions-cell">
                        <button class="btn-edit" onclick='editarMotivoPendencia(${JSON.stringify(p)})'>Editar</button>
                        <button class="btn-delete" onclick="excluirMotivoPendencia(${p.id})">Excluir</button>
                    </td>
                `;
                listaPendenciasBody.appendChild(tr);
            });
        } catch (error) {
            console.error('Erro ao carregar motivos de pendência:', error);
        }
    }

    formPendencia.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = pendenciaIdInput.value;
        const url = id ? `/crm-cadastros/motivos-pendencia/${id}/` : '/crm-cadastros/motivos-pendencia/';
        const method = id ? 'PUT' : 'POST';

        const body = {
            nome: pendenciaNomeInput.value,
            tipo_pendencia: pendenciaTipoInput.value
        };

        try {
            await apiFetch(url, {
                method,
                body: JSON.stringify(body)
            });
            alert(`Motivo de pendência ${id ? 'atualizado' : 'criado'} com sucesso!`);
            resetFormPendencia();
            carregarMotivosPendencia();
        } catch (error) {
            alert(`Erro: ${error.message}`);
        }
    });

    function editarMotivoPendencia(pendencia) {
        pendenciaIdInput.value = pendencia.id;
        pendenciaNomeInput.value = pendencia.nome;
        pendenciaTipoInput.value = pendencia.tipo_pendencia;
        window.scrollTo(0, 0);
    }

    async function excluirMotivoPendencia(id) {
        if (!confirm('Tem certeza que deseja excluir este motivo?')) return;
        try {
            await apiFetch(`/crm-cadastros/motivos-pendencia/${id}/`, { method: 'DELETE' });
            alert('Motivo de pendência excluído com sucesso!');
            carregarMotivosPendencia();
        } catch (error) {
            alert(`Erro: ${error.message}`);
        }
    }
    
    // --- LÓGICA DE GESTÃO DE COMISSIONAMENTO ---
    const formRegraComissao = document.getElementById('form-regra-comissao');
    const regraComissaoIdInput = document.getElementById('regra_comissao_id');
    const regraConsultorSelect = document.getElementById('regra_consultor_id');
    const regraPlanoSelect = document.getElementById('regra_plano_id');
    const listaRegrasComissaoBody = document.getElementById('lista-regras-comissao');
    
    async function carregarDadosParaRegrasComissao() {
        try {
            const [planos, consultores] = await Promise.all([
                apiFetch('/crm-cadastros/planos/'),
                apiFetch('/usuarios/?is_active=true') // Requisição para obter usuários ativos
            ]);

            // ADICIONE ESTA LINHA PARA DEBUG
            console.log("Dados de consultores recebidos:", consultores);

            regraPlanoSelect.innerHTML = '<option value="">Selecione...</option>';
            planos.forEach(plano => regraPlanoSelect.add(new Option(plano.nome, plano.id)));

            regraConsultorSelect.innerHTML = '<option value="">Selecione...</option>';
            // Verifique se 'consultores' é um array e se contém os dados esperados
            if (Array.isArray(consultores)) {
                consultores.forEach(user => {
                    // Certifique-se de que user.id e user.nome_completo existem
                    if (user.id && user.nome_completo) {
                         regraConsultorSelect.add(new Option(user.nome_completo, user.id));
                    } else {
                         console.warn("Item de consultor inválido:", user);
                    }
                });
            } else {
                 console.error("Resposta de consultores não é um array:", consultores);
            }


        } catch (error) {
            console.error('Erro ao carregar dados para as regras de comissão:', error);
        }
    }


    // --- FUNÇÃO DE LOGOUT ---
    function logout() {
    localStorage.removeItem('accessToken');
    localStorage.removeItem('refreshToken');
    localStorage.removeItem('userProfile');
    window.location.href = '/'; // Redireciona para a página inicial
}

    // --- INICIALIZAÇÃO DA PÁGINA ---
    document.addEventListener('DOMContentLoaded', () => {
        carregarDadosParaFormulario();
        carregarPerfis();
        carregarMotivos();
        carregarFeriados();
        carregarOperadoras();
        carregarPlanos();
        carregarFormasPagamento();
        carregarStatus();
        carregarMotivosPendencia();
        carregarDadosParaRegrasComissao();
        
        document.querySelector('.nav-menu li').click();
    });

</script>

</body>
</html>