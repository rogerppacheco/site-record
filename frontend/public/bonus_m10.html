{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Record Vertical - Bônus M-10 & FPD</title>
    <link rel="shortcut icon" href="{% static 'logo.png' %}" type="image/x-icon">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{% static 'css/custom_styles.css' %}?v=13.2">
    
    <style>
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: transform 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card.blue { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .stat-card.green { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .stat-card.orange { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .stat-card.red { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="header-container">
            <a href="/"><img src="{% static 'logo.png' %}" alt="Record PAP Logo" class="logo"></a>
            <button class="menu-toggle" id="menu-toggle"><div class="bar"></div><div class="bar"></div><div class="bar"></div></button>
            <nav class="main-nav" id="main-nav">
                <ul>
                    <li><a href="/area-interna/">Voltar</a></li>
                    <li><button onclick="logout()" class="nav-button logout-button">Sair</button></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="area-interna-section">
        <div class="system-container" style="max-width: 95% !important;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 style="font-size: 1.8rem; margin: 0;"><i class="bi bi-piggy-bank-fill text-success"></i> Bônus M-10 & FPD</h1>
                    <p class="text-muted mb-0">Controle de pagamentos e elegibilidade para bônus</p>
                </div>
                <div>
                    <button class="btn btn-success" onclick="exportarDados()"><i class="bi bi-download"></i> Exportar Excel</button>
                </div>
            </div>

            <ul class="nav nav-tabs mb-4" id="bonusTabs" role="tablist">
                <li class="nav-item"><button class="nav-link active" id="m10-tab" data-bs-toggle="tab" data-bs-target="#m10-content" type="button"><i class="bi bi-cash-coin"></i> Bônus M-10</button></li>
                <li class="nav-item"><button class="nav-link" id="fpd-tab" data-bs-toggle="tab" data-bs-target="#fpd-content" type="button"><i class="bi bi-calendar-check"></i> FPD (Primeira Fatura)</button></li>
            </ul>

            <div class="tab-content">
                <!-- TAB: BÔNUS M-10 -->
                <div class="tab-pane fade show active" id="m10-content">
                    <!-- Dashboard M-10 -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <div class="stat-card blue">
                                <div class="stat-label"><i class="bi bi-bar-chart-fill"></i> Total de Contratos</div>
                                <div class="stat-value" id="m10-total">0</div>
                                <small>na safra selecionada</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card green">
                                <div class="stat-label"><i class="bi bi-check-circle-fill"></i> Ativos</div>
                                <div class="stat-value" id="m10-ativos">0</div>
                                <small id="m10-taxa-ativos">0% de permanência</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card orange">
                                <div class="stat-label"><i class="bi bi-trophy-fill"></i> Elegíveis</div>
                                <div class="stat-value" id="m10-elegiveis">0</div>
                                <small>para receber bônus</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card red" id="card-valor-bonus">
                                <div class="stat-label"><i class="bi bi-cash-stack"></i> Valor Total</div>
                                <div class="stat-value" id="m10-valor">R$ 0,00</div>
                                <small>bônus a pagar</small>
                            </div>
                        </div>
                    </div>

                    <!-- Filtros -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">Safra (Mês/Ano)</label>
                                    <div class="input-group">
                                        <select id="filtro-safra" class="form-select" onchange="carregarDadosM10()">
                                            <option value="">Selecione...</option>
                                        </select>
                                        <button class="btn btn-primary" onclick="abrirModalCriarSafra()" title="Criar nova safra"><i class="bi bi-plus-circle"></i></button>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">Vendedor</label>
                                    <select id="filtro-vendedor-m10" class="form-select" onchange="carregarDadosM10()">
                                        <option value="">Todos</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">Status</label>
                                    <select id="filtro-status-m10" class="form-select" onchange="carregarDadosM10()">
                                        <option value="">Todos</option>
                                        <option value="ATIVO">Ativo</option>
                                        <option value="CANCELADO">Cancelado</option>
                                        <option value="DOWNGRADE">Downgrade</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">Elegibilidade</label>
                                    <select id="filtro-elegivel" class="form-select" onchange="carregarDadosM10()">
                                        <option value="">Todos</option>
                                        <option value="true">Elegíveis</option>
                                        <option value="false">Não Elegíveis</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Alerta sobre Importações -->\n                    <div class="alert alert-info d-flex align-items-center mb-4" role="alert">
                        <i class="bi bi-info-circle fs-4 me-3"></i>
                        <div>
                            <strong>Importações:</strong> Para importar bases FPD ou Churn, acesse a 
                            <a href="/importacoes/" class="alert-link fw-bold">Central de Importações</a>.
                        </div>
                    </div>

                    <!-- Tabela de Contratos -->
                    <div class="card">
                        <div class="card-header bg-white d-flex justify-content-between">
                            <h5 class="m-0 text-primary">Contratos da Safra</h5>
                            <button class="btn btn-sm btn-outline-primary" onclick="carregarDadosM10()"><i class="bi bi-arrow-clockwise"></i> Atualizar</button>
                        </div>
                        <div class="card-body p-0 table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Contrato</th>
                                        <th>Cliente</th>
                                        <th>Vendedor</th>
                                        <th>Instalação</th>
                                        <th>Plano</th>
                                        <th>Status</th>
                                        <th>Faturas Pagas</th>
                                        <th>Elegível</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-contratos-m10"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- TAB: FPD -->
                <div class="tab-pane fade" id="fpd-content">
                    <!-- Dashboard FPD -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <div class="stat-card blue">
                                <div class="stat-label"><i class="bi bi-file-text-fill"></i> Faturas Geradas</div>
                                <div class="stat-value" id="fpd-geradas">0</div>
                                <small>no mês selecionado</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card green">
                                <div class="stat-label"><i class="bi bi-check-circle-fill"></i> Pagas</div>
                                <div class="stat-value" id="fpd-pagas">0</div>
                                <small>primeira fatura quitada</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card orange">
                                <div class="stat-label"><i class="bi bi-hourglass-split"></i> Em Aberto</div>
                                <div class="stat-value" id="fpd-aberto">0</div>
                                <small>aguardando pagamento</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card red">
                                <div class="stat-label"><i class="bi bi-percent"></i> Taxa FPD</div>
                                <div class="stat-value" id="fpd-taxa">0%</div>
                                <small>pagas / geradas</small>
                            </div>
                        </div>
                    </div>

                    <!-- Filtros FPD -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Mês de Vencimento</label>
                                    <input type="month" id="filtro-mes-fpd" class="form-control" onchange="carregarDadosFPD()">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Status</label>
                                    <select id="filtro-status-fpd" class="form-select" onchange="carregarDadosFPD()">
                                        <option value="">Todos</option>
                                        <option value="PAGO">Pago</option>
                                        <option value="NAO_PAGO">Não Pago</option>
                                        <option value="AGUARDANDO">Aguardando</option>
                                        <option value="ATRASADO">Atrasado</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Vendedor</label>
                                    <select id="filtro-vendedor-fpd" class="form-select" onchange="carregarDadosFPD()">
                                        <option value="">Todos</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabela FPD -->
                    <div class="card">
                        <div class="card-header bg-white d-flex justify-content-between">
                            <h5 class="m-0 text-primary">Primeira Fatura (FPD)</h5>
                            <button class="btn btn-sm btn-outline-primary" onclick="carregarDadosFPD()"><i class="bi bi-arrow-clockwise"></i> Atualizar</button>
                        </div>
                        <div class="card-body p-0 table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Contrato</th>
                                        <th>Cliente</th>
                                        <th>Vendedor</th>
                                        <th>Vencimento</th>
                                        <th>Valor</th>
                                        <th>Pagamento</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-fpd"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal: Editar Faturas -->
    <div class="modal fade" id="modalFaturas" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Faturas - <span id="modal-contrato-nome"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="modal-contrato-id">
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>Fatura</th>
                                    <th>Número Fatura</th>
                                    <th>Valor</th>
                                    <th>Vencimento</th>
                                    <th>Pagamento</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-editar-faturas"></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button class="btn btn-primary" onclick="salvarFaturas()">Salvar Alterações</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Criar Nova Safra M-10 -->
    <div class="modal fade" id="modalCriarSafra" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Criar Nova Safra M-10</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">A safra será preenchida com contratos do CRM que possuem data_instalacao no mês informado.</p>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Mês da Safra (YYYY-MM)</label>
                        <input type="month" id="input-mes-safra" class="form-control" required>
                        <small class="text-muted">Ex: 2025-07</small>
                    </div>
                    <div id="safra-loading" class="spinner-border spinner-border-sm d-none" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <div id="safra-resultado" class="mt-3"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="criarNovaSafra()">Criar Safra</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'js/auth.js' %}?v=7.0"></script>
    <script src="{% static 'js/menu.js' %}?v=7.0"></script>
    <script>
        const token = localStorage.getItem('accessToken');

        // Verifica permissão para ver valor total
        async function verificarPermissao() {
            const res = await fetch('/api/usuarios/me/', { headers: {'Authorization': `Bearer ${token}`} });
            const user = await res.json();
            
            // Se não for Diretoria, bloqueia acesso
            if (!user.grupos.includes('Diretoria')) {
                document.body.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100vh; background: #f8f9fa;">
                        <div style="text-align: center; background: white; padding: 40px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <i class="bi bi-lock-fill" style="font-size: 3rem; color: #dc3545;"></i>
                            <h2 style="margin-top: 20px; color: #333;">Acesso Restrito</h2>
                            <p style="color: #666; margin: 20px 0;">Esta ferramenta é restrita para usuários da Diretoria.</p>
                            <a href="/area-interna/" class="btn btn-primary" style="text-decoration: none; background: #0d6efd; color: white; padding: 10px 30px; border-radius: 5px; display: inline-block;">Voltar</a>
                        </div>
                    </div>
                `;
                return false;
            }
            
            // Se for Diretoria, mostra o valor de bônus
            document.getElementById('card-valor-bonus').style.display = 'block';
            return true;
        }

        // Carregar safras disponíveis
        async function carregarSafras() {
            const res = await fetch('/api/bonus-m10/safras/', { headers: {'Authorization': `Bearer ${token}`} });
            const safras = await res.json();
            const select = document.getElementById('filtro-safra');
            safras.forEach(s => {
                select.innerHTML += `<option value="${s.id}">${s.mes_referencia_formatado}</option>`;
            });
            if (safras.length > 0) {
                select.value = safras[0].id;
                carregarDadosM10();
            }
        }

        // Abrir modal para criar nova safra
        function abrirModalCriarSafra() {
            document.getElementById('input-mes-safra').value = '';
            document.getElementById('safra-resultado').innerHTML = '';
            document.getElementById('safra-loading').classList.add('d-none');
            new bootstrap.Modal(document.getElementById('modalCriarSafra')).show();
        }

        // Criar nova safra a partir do Venda (CRM)
        async function criarNovaSafra() {
            const mes = document.getElementById('input-mes-safra').value;
            if (!mes) {
                alert('Informe o mês da safra (YYYY-MM)');
                return;
            }

            const loading = document.getElementById('safra-loading');
            const resultado = document.getElementById('safra-resultado');
            
            loading.classList.remove('d-none');
            resultado.innerHTML = '';

            try {
                const response = await fetch('/api/bonus-m10/safras/criar/', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ mes_referencia: mes })
                });

                const data = await response.json();

                loading.classList.add('d-none');

                if (response.ok) {
                    resultado.innerHTML = `
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle"></i> Safra criada com sucesso!
                            <ul class="mt-2 mb-0">
                                <li><strong>Contratos criados:</strong> ${data.contratos_criados}</li>
                                <li><strong>Duplicados (não criados):</strong> ${data.contratos_duplicados}</li>
                                <li><strong>Total na safra:</strong> ${data.total_contratos_safra}</li>
                            </ul>
                        </div>
                    `;
                    
                    // Recarrega as safras e fecha modal após 2 segundos
                    setTimeout(() => {
                        carregarSafras();
                        bootstrap.Modal.getInstance(document.getElementById('modalCriarSafra')).hide();
                    }, 2000);
                } else {
                    resultado.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-circle"></i> Erro ao criar safra: ${data.error || 'Erro desconhecido'}
                        </div>
                    `;
                }
            } catch (error) {
                loading.classList.add('d-none');
                resultado.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-circle"></i> Erro de conexão: ${error.message}
                    </div>
                `;
            }
        }

        // Carregar dados M-10
        async function carregarDadosM10(page = 1) {
            const safra = document.getElementById('filtro-safra').value;
            if (!safra) return;

            const vendedor = document.getElementById('filtro-vendedor-m10').value;
            const status = document.getElementById('filtro-status-m10').value;
            const elegivel = document.getElementById('filtro-elegivel').value;

            const params = new URLSearchParams({ safra, vendedor, status, elegivel, page });
            const res = await fetch(`/api/bonus-m10/dashboard-m10/?${params}`, { headers: {'Authorization': `Bearer ${token}`} });
            const data = await res.json();

            // Atualiza dashboard
            document.getElementById('m10-total').textContent = data.total;
            document.getElementById('m10-ativos').textContent = data.ativos;
            document.getElementById('m10-taxa-ativos').textContent = `${data.taxa_permanencia}% de permanência`;
            document.getElementById('m10-elegiveis').textContent = data.elegiveis;
            document.getElementById('m10-valor').textContent = `R$ ${data.valor_total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;

            // Atualiza tabela
            const tbody = document.getElementById('tbody-contratos-m10');
            tbody.innerHTML = data.contratos.length ? '' : '<tr><td colspan="9" class="text-center">Nenhum contrato encontrado</td></tr>';
            data.contratos.forEach(c => {
                const statusBadge = c.status === 'ATIVO' ? 'success' : c.status === 'CANCELADO' ? 'danger' : 'warning';
                const elegivel = c.elegivel ? '<span class="badge bg-success">Sim</span>' : '<span class="badge bg-secondary">Não</span>';
                tbody.innerHTML += `
                    <tr>
                        <td>${c.numero_contrato}</td>
                        <td>${c.cliente_nome}</td>
                        <td>${c.vendedor_nome}</td>
                        <td>${c.data_instalacao}</td>
                        <td>${c.plano_atual}</td>
                        <td><span class="badge bg-${statusBadge}">${c.status_display}</span></td>
                        <td><span class="badge bg-primary">${c.faturas_pagas}/10</span></td>
                        <td>${elegivel}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="abrirModalFaturas(${c.id})"><i class="bi bi-pencil"></i></button>
                        </td>
                    </tr>
                `;
            });

            // Adiciona paginação se houver múltiplas páginas
            if (data.total_pages > 1) {
                let paginationHtml = '<nav aria-label="Page navigation"><ul class="pagination">';
                for (let i = 1; i <= data.total_pages; i++) {
                    const active = i === data.page ? 'active' : '';
                    paginationHtml += `<li class="page-item ${active}"><a class="page-link" href="#" onclick="carregarDadosM10(${i}); return false;">${i}</a></li>`;
                }
                paginationHtml += '</ul></nav>';
                if (!document.getElementById('pagination-m10')) {
                    tbody.parentElement.parentElement.insertAdjacentHTML('afterend', '<div id="pagination-m10"></div>');
                }
                document.getElementById('pagination-m10').innerHTML = paginationHtml;
            }
        }

        // Carregar dados FPD
        async function carregarDadosFPD() {
            const mes = document.getElementById('filtro-mes-fpd').value;
            const status = document.getElementById('filtro-status-fpd').value;
            const vendedor = document.getElementById('filtro-vendedor-fpd').value;

            const params = new URLSearchParams({ mes, status, vendedor });
            const res = await fetch(`/api/bonus-m10/dashboard-fpd/?${params}`, { headers: {'Authorization': `Bearer ${token}`} });
            const data = await res.json();

            document.getElementById('fpd-geradas').textContent = data.total_geradas;
            document.getElementById('fpd-pagas').textContent = data.total_pagas;
            document.getElementById('fpd-aberto').textContent = data.total_aberto;
            document.getElementById('fpd-taxa').textContent = `${data.taxa_fpd}%`;

            const tbody = document.getElementById('tbody-fpd');
            tbody.innerHTML = data.faturas.length ? '' : '<tr><td colspan="8" class="text-center">Nenhuma fatura encontrada</td></tr>';
            data.faturas.forEach(f => {
                const statusClass = f.status === 'PAGO' ? 'success' : f.status === 'NAO_PAGO' ? 'danger' : 'warning';
                tbody.innerHTML += `
                    <tr>
                        <td>${f.numero_contrato}</td>
                        <td>${f.cliente_nome}</td>
                        <td>${f.vendedor_nome}</td>
                        <td>${f.data_vencimento}</td>
                        <td>R$ ${f.valor.toFixed(2)}</td>
                        <td>${f.data_pagamento || '-'}</td>
                        <td><span class="badge bg-${statusClass}">${f.status_display}</span></td>
                        <td><button class="btn btn-sm btn-primary" onclick="abrirModalFaturas(${f.contrato_id})"><i class="bi bi-pencil"></i></button></td>
                    </tr>
                `;
            });
        }

        async function abrirModalFaturas(contratoId) {
            const res = await fetch(`/api/bonus-m10/contratos/${contratoId}/`, { headers: {'Authorization': `Bearer ${token}`} });
            const contrato = await res.json();
            
            document.getElementById('modal-contrato-id').value = contratoId;
            document.getElementById('modal-contrato-nome').textContent = contrato.numero_contrato;
            
            const tbody = document.getElementById('tbody-editar-faturas');
            tbody.innerHTML = '';
            contrato.faturas.forEach((f, i) => {
                tbody.innerHTML += `
                    <tr>
                        <td>Fatura ${i + 1}</td>
                        <td><input type="text" class="form-control form-control-sm" value="${f.numero_fatura_operadora || ''}" data-id="${f.id}" data-field="numero_fatura_operadora"></td>
                        <td><input type="number" step="0.01" class="form-control form-control-sm" value="${f.valor}" data-id="${f.id}" data-field="valor"></td>
                        <td><input type="date" class="form-control form-control-sm" value="${f.data_vencimento}" data-id="${f.id}" data-field="data_vencimento"></td>
                        <td><input type="date" class="form-control form-control-sm" value="${f.data_pagamento || ''}" data-id="${f.id}" data-field="data_pagamento"></td>
                        <td>
                            <select class="form-select form-select-sm" data-id="${f.id}" data-field="status">
                                <option value="PAGO" ${f.status === 'PAGO' ? 'selected' : ''}>Pago</option>
                                <option value="NAO_PAGO" ${f.status === 'NAO_PAGO' ? 'selected' : ''}>Não Pago</option>
                                <option value="AGUARDANDO" ${f.status === 'AGUARDANDO' ? 'selected' : ''}>Aguardando</option>
                                <option value="ATRASADO" ${f.status === 'ATRASADO' ? 'selected' : ''}>Atrasado</option>
                            </select>
                        </td>
                    </tr>
                `;
            });
            
            new bootstrap.Modal(document.getElementById('modalFaturas')).show();
        }

        async function salvarFaturas() {
            const inputs = document.querySelectorAll('#tbody-editar-faturas input, #tbody-editar-faturas select');
            const updates = [];
            
            inputs.forEach(input => {
                updates.push({
                    id: input.dataset.id,
                    field: input.dataset.field,
                    value: input.value
                });
            });

            await fetch('/api/bonus-m10/faturas/atualizar/', {
                method: 'POST',
                headers: {'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json'},
                body: JSON.stringify({ updates })
            });

            bootstrap.Modal.getInstance(document.getElementById('modalFaturas')).hide();
            carregarDadosM10();
            carregarDadosFPD();
        }

        async function exportarDados() {
            try {
                const token = localStorage.getItem('accessToken');
                const response = await fetch('/api/bonus-m10/exportar/', {
                    method: 'GET',
                    headers: {'Authorization': `Bearer ${token}`}
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // Baixa o arquivo
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `bonus_m10_${new Date().toISOString().split('T')[0]}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            } catch (error) {
                alert('Erro ao exportar: ' + error.message);
            }
        }

        // Inicialização
        verificarPermissao();
        carregarSafras();
    </script>
</body>
</html>
