{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Comissionamento</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{% static 'css/custom_styles.css' %}?v=2.1">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        /* Estilo Limpo e Profissional */
        .table thead th { 
            font-size: 0.8rem; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            vertical-align: middle;
            background-color: #f8f9fa; 
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }
        .money-col { 
            font-family: 'Consolas', 'Monaco', monospace; 
            font-weight: 600; 
            white-space: nowrap;
        }
        .border-left-strong { border-left: 2px solid #e9ecef !important; }
        
        .btn-filter { background-color: #0d6efd; color: white; }
        .btn-filter:hover { background-color: #0b5ed7; color: white; }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="header-container">
            <a href="/"><img src="{% static 'logo.png' %}" class="logo"></a>
            <nav class="main-nav">
                <ul><li><a href="/area-interna/">Voltar</a></li></ul>
            </nav>
        </div>
    </header>

    <main class="area-interna-section">
        <div class="system-container" style="max-width: 1600px;"> 
            
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="fw-bold text-dark"><i class="bi bi-wallet2"></i> Gestão de Comissionamento</h2>
                    <p class="text-muted mb-0">Fechamento mensal e histórico financeiro.</p>
                </div>
                <div class="d-flex gap-2 bg-white p-2 rounded shadow-sm border">
                    <select class="form-select border-0 bg-light" id="filtro-mes">
                        <option value="1">Janeiro</option><option value="2">Fevereiro</option><option value="3">Março</option>
                        <option value="4">Abril</option><option value="5">Maio</option><option value="6">Junho</option>
                        <option value="7">Julho</option><option value="8">Agosto</option><option value="9">Setembro</option>
                        <option value="10">Outubro</option><option value="11">Novembro</option><option value="12">Dezembro</option>
                    </select>
                    <select class="form-select border-0 bg-light" id="filtro-ano">
                        <option value="2024">2024</option><option value="2025">2025</option>
                    </select>
                    <button class="btn btn-filter px-4" onclick="carregarDados()">Filtrar</button>
                </div>
            </div>

            <ul class="nav nav-tabs mb-4" id="comissaoTabs">
                <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-consultor">Visão por Consultor</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-historico">Histórico de Pagamentos</a></li>
            </ul>

            <div class="tab-content">
                <div class="tab-pane fade show active" id="tab-consultor">
                    <div class="d-flex justify-content-between mb-2">
                        <div class="form-check ms-2 pt-2">
                            <input class="form-check-input" type="checkbox" id="check-todos" onclick="toggleTodos(this)">
                            <label class="form-check-label text-muted small fw-bold" for="check-todos">SELECIONAR TODOS</label>
                        </div>
                        <div>
                            <button class="btn btn-outline-danger btn-sm" onclick="gerarPDFSelecionados()">
                                <i class="bi bi-file-earmark-pdf"></i> Gerar PDF Extrato
                            </button>
                            <button class="btn btn-outline-primary btn-sm ms-2" onclick="abrirModalEmail()">
                                <i class="bi bi-envelope-at"></i> Enviar E-mail
                            </button>
                        </div>
                    </div>

                    <div class="card border-0 shadow-sm">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0" style="font-size: 0.9rem;">
                                    <thead>
                                        <tr>
                                            <th style="width: 40px;">#</th>
                                            <th rowspan="2" style="width: 200px;">CONSULTOR</th>
                                            <th colspan="3" class="text-center border-left-strong">PRODUÇÃO</th>
                                            <th rowspan="2" class="text-end border-left-strong text-primary">COMISSÃO<br>BRUTA</th>
                                            <th colspan="4" class="text-center border-left-strong text-danger">DESCONTOS</th>
                                            <th rowspan="2" class="text-end border-left-strong text-success bg-light">LÍQUIDO<br>A PAGAR</th>
                                        </tr>
                                        <tr>
                                            <th></th>
                                            <th class="text-center border-left-strong">Inst.</th>
                                            <th class="text-center">Meta</th>
                                            <th class="text-center">%</th>
                                            <th class="text-end border-left-strong fw-normal">Boleto</th>
                                            <th class="text-end fw-normal">Inclusão</th>
                                            <th class="text-end fw-normal">Antecip.</th>
                                            <th class="text-end fw-normal">CNPJ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbody-consultores"></tbody>
                                    <tfoot id="tfoot-totais" class="table-light fw-bold" style="border-top: 2px solid #dee2e6;"></tfoot>
                                </table>
                            </div>
                        </div>
                        <div class="card-footer bg-white d-flex justify-content-between py-3 align-items-center">
                            <span class="text-muted small" id="status-fechamento-msg"></span>
                            <div id="botoes-acao-fechamento"></div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="tab-historico">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Mês/Ano</th>
                                        <th>Total Pago (Equipe)</th>
                                        <th>Total Recebido (Ciclo)</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-historico"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="modal fade" id="modalEmail" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Enviar Extrato por E-mail</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p>O sistema enviará o <strong>PDF em anexo</strong> e um <strong>Resumo por Velocidade</strong> no corpo do e-mail.</p>
            
            <div class="mb-3">
                <label class="form-label">Consultor Selecionado</label>
                <input type="text" class="form-control" id="email-consultor-nome" readonly>
                <input type="hidden" id="email-consultor-id">
            </div>
            
            <div class="mb-3">
                <label class="form-label">E-mail de Destino</label>
                <input type="email" class="form-control" id="email-destino-input" placeholder="nome@exemplo.com">
                <small class="text-muted">Se deixar vazio, usará o e-mail do cadastro do consultor (se houver).</small>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary" onclick="confirmarEnvioEmail()">
                <span id="btn-email-text">Enviar Agora</span>
                <span id="btn-email-spinner" class="spinner-border spinner-border-sm d-none"></span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="{% static 'js/auth.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const apiUrl = '/api/crm/comissionamento/'; 
        const token = localStorage.getItem('accessToken');
        if(!token) window.location.href = '/';

        axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;

        document.addEventListener('DOMContentLoaded', () => {
            const hoje = new Date();
            document.getElementById('filtro-mes').value = hoje.getMonth() + 1;
            document.getElementById('filtro-ano').value = hoje.getFullYear();
            carregarDados();
        });

        async function carregarDados() {
            const mes = document.getElementById('filtro-mes').value;
            const ano = document.getElementById('filtro-ano').value;
            const tbody = document.getElementById('tbody-consultores');
            
            tbody.innerHTML = '<tr><td colspan="12" class="text-center py-5"><div class="spinner-border text-primary"></div></td></tr>';

            try {
                const res = await axios.get(`${apiUrl}?ano=${ano}&mes=${mes}`);
                const dados = res.data;

                renderizarTabela(dados.relatorio_consultores);
                renderizarHistorico(dados.historico_pagamentos);
                
                const mesAtualStr = `${mes}/${ano}`;
                const historicoAtual = dados.historico_pagamentos.find(h => h.ano_mes === mesAtualStr);
                atualizarBotoesAcao(historicoAtual ? historicoAtual.status : 'Aberto', dados.relatorio_consultores);

            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="12" class="text-center text-danger p-4">Erro ao carregar dados: ${error.message}</td></tr>`;
            }
        }

        function renderizarTabela(lista) {
            const tbody = document.getElementById('tbody-consultores');
            tbody.innerHTML = '';
            let totBruta = 0, totLiq = 0;

            if (lista.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="text-center py-4 text-muted">Nenhum dado encontrado.</td></tr>';
                return;
            }

            lista.forEach(c => {
                totBruta += c.comissao_bruta;
                totLiq += c.valor_liquido;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="text-center"><input type="checkbox" class="form-check-input check-consultor" value="${c.consultor_id}"></td>
                    <td class="fw-bold text-dark">${c.consultor_nome}</td>
                    <td class="text-center border-left-strong">${c.qtd_instaladas}</td>
                    <td class="text-center text-muted">${c.meta}</td>
                    <td class="text-center"><span class="badge ${c.atingimento_pct >= 100 ? 'bg-success' : 'bg-secondary'}">${c.atingimento_pct}%</span></td>
                    <td class="money-col text-end text-primary border-left-strong">${fmtMoney(c.comissao_bruta)}</td>
                    <td class="money-col text-end text-danger border-left-strong">${c.desc_boleto > 0 ? '-'+fmtMoney(c.desc_boleto) : '-'}</td>
                    <td class="money-col text-end text-danger">${c.desc_inclusao > 0 ? '-'+fmtMoney(c.desc_inclusao) : '-'}</td>
                    <td class="money-col text-end text-danger">${c.desc_antecipacao > 0 ? '-'+fmtMoney(c.desc_antecipacao) : '-'}</td>
                    <td class="money-col text-end text-danger">${c.desc_cnpj > 0 ? '-'+fmtMoney(c.desc_cnpj) : '-'}</td>
                    <td class="money-col text-end text-success border-left-strong bg-light fw-bold">${fmtMoney(c.valor_liquido)}</td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('tfoot-totais').innerHTML = `
                <tr>
                    <td colspan="5" class="text-end text-uppercase text-muted small">Totais do Mês:</td>
                    <td class="text-end text-primary border-left-strong">${fmtMoney(totBruta)}</td>
                    <td colspan="4" class="border-left-strong"></td>
                    <td class="text-end text-success border-left-strong bg-light">${fmtMoney(totLiq)}</td>
                </tr>`;
        }

        function renderizarHistorico(lista) {
            const tbody = document.getElementById('tbody-historico');
            tbody.innerHTML = '';
            lista.forEach(h => {
                tbody.innerHTML += `<tr><td class="fw-bold">${h.ano_mes}</td><td class="text-success fw-bold">${fmtMoney(h.total_pago_equipe)}</td><td class="text-primary">${fmtMoney(h.total_recebido_ciclo)}</td><td><span class="badge ${h.status === 'Fechado' ? 'bg-success' : 'bg-warning'}">${h.status}</span></td><td><button class="btn btn-sm btn-light border">Ver</button></td></tr>`;
            });
        }

        function atualizarBotoesAcao(status, dados) {
            const div = document.getElementById('botoes-acao-fechamento');
            const msg = document.getElementById('status-fechamento-msg');
            const totalLiq = dados.reduce((acc, cur) => acc + cur.valor_liquido, 0);

            if (status === 'Fechado') {
                msg.innerHTML = '<i class="bi bi-lock-fill text-success"></i> Mês Fechado e Pago.';
                div.innerHTML = `<button class="btn btn-outline-secondary btn-lg" onclick="reabrirMes()"><i class="bi bi-unlock"></i> Reabrir Mês (Correção)</button>`;
            } else {
                msg.innerHTML = '<i class="bi bi-unlock text-warning"></i> Mês Aberto (Em andamento).';
                div.innerHTML = `<button class="btn btn-success btn-lg" onclick="fecharPagamentoMes(${totalLiq})"><i class="bi bi-check-circle-fill"></i> Fechar Pagamento do Mês</button>`;
            }
        }

        async function fecharPagamentoMes(total) {
            if(!confirm("ATENÇÃO: Ao fechar o pagamento, todas as vendas instaladas serão marcadas como PAGO. Continuar?")) return;
            const ano = document.getElementById('filtro-ano').value;
            const mes = document.getElementById('filtro-mes').value;
            
            try {
                await axios.post(`${apiUrl}fechar/`, { ano, mes, total_pago: total });
                alert("Mês fechado com sucesso!");
                carregarDados();
            } catch(e) { alert("Erro ao fechar: " + (e.response?.data?.error || e.message)); }
        }

        async function reabrirMes() {
            if(!confirm("Deseja reabrir este mês para correções? As vendas voltarão para PENDENTE.")) return;
            const ano = document.getElementById('filtro-ano').value;
            const mes = document.getElementById('filtro-mes').value;
            
            try {
                await axios.post(`${apiUrl}reabrir/`, { ano, mes });
                alert("Mês reaberto!");
                carregarDados();
            } catch(e) { alert("Erro ao reabrir: " + (e.response?.data?.error || e.message)); }
        }

        async function gerarPDFSelecionados() {
            const checks = document.querySelectorAll('.check-consultor:checked');
            if(checks.length === 0) { alert("Selecione pelo menos um consultor."); return; }
            
            const ids = Array.from(checks).map(c => c.value);
            const ano = document.getElementById('filtro-ano').value;
            const mes = document.getElementById('filtro-mes').value;

            try {
                const res = await axios.post(`${apiUrl}pdf/`, { ano, mes, consultores: ids }, { responseType: 'blob' });
                const url = window.URL.createObjectURL(new Blob([res.data]));
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', `Extrato_Comissao_${mes}_${ano}.pdf`);
                document.body.appendChild(link);
                link.click();
            } catch(e) { alert("Erro ao gerar PDF."); }
        }

        // --- FUNÇÕES DE E-MAIL ADICIONADAS ---
        function abrirModalEmail() {
            const checks = document.querySelectorAll('.check-consultor:checked');
            if(checks.length !== 1) { 
                alert("Por favor, selecione EXATAMENTE UM consultor para enviar o e-mail individual."); 
                return; 
            }
            
            const id = checks[0].value;
            // Pega o nome da linha da tabela (coluna 2, index 1)
            const nome = checks[0].closest('tr').cells[1].innerText; 
            
            document.getElementById('email-consultor-id').value = id;
            document.getElementById('email-consultor-nome').value = nome;
            document.getElementById('email-destino-input').value = "";
            
            new bootstrap.Modal(document.getElementById('modalEmail')).show();
        }

        async function confirmarEnvioEmail() {
            const id = document.getElementById('email-consultor-id').value;
            const email = document.getElementById('email-destino-input').value;
            const ano = document.getElementById('filtro-ano').value;
            const mes = document.getElementById('filtro-mes').value;
            
            // Validação simples
            // Se o email estiver vazio, o backend tentará usar o do cadastro.
            
            const btnText = document.getElementById('btn-email-text');
            const spinner = document.getElementById('btn-email-spinner');
            
            btnText.classList.add('d-none');
            spinner.classList.remove('d-none');
            
            try {
                await axios.post(`${apiUrl}email/`, { 
                    ano, mes, 
                    consultor_id: id, 
                    email_destino: email 
                });
                alert("E-mail enviado com sucesso!");
                bootstrap.Modal.getInstance(document.getElementById('modalEmail')).hide();
            } catch(e) { 
                alert("Erro ao enviar: " + (e.response?.data?.error || e.message)); 
            } finally {
                btnText.classList.remove('d-none');
                spinner.classList.add('d-none');
            }
        }
        // -------------------------------------

        function toggleTodos(source) {
            document.querySelectorAll('.check-consultor').forEach(c => c.checked = source.checked);
        }

        function fmtMoney(val) { return val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
        function logout() { localStorage.removeItem('accessToken'); window.location.href = '/'; }
    </script>
</body>
</html>