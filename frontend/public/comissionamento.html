{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Comissionamento</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{% static 'css/custom_styles.css' %}?v=2.1">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        /* Estilo Limpo e Profissional */
        .table thead th { 
            font-size: 0.8rem; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            vertical-align: middle;
            background-color: #f8f9fa; 
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }
        .money-col { 
            font-family: 'Consolas', 'Monaco', monospace; 
            font-weight: 600; 
            white-space: nowrap;
        }
        .border-left-strong { border-left: 2px solid #e9ecef !important; }
        
        .btn-filter { background-color: #0d6efd; color: white; }
        .btn-filter:hover { background-color: #0b5ed7; color: white; }

        .btn-toggle-detalhe {
            width: 24px; height: 24px; 
            padding: 0; 
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .btn-toggle-detalhe:hover { background-color: #e9ecef; }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="header-container">
            <a href="/"><img src="{% static 'logo.png' %}" class="logo"></a>
            <nav class="main-nav">
                <ul><li><a href="/area-interna/">Voltar</a></li></ul>
            </nav>
        </div>
    </header>

    <main class="area-interna-section">
        <div class="system-container" style="max-width: 1600px;"> 
            
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="fw-bold text-dark"><i class="bi bi-wallet2"></i> Gestão de Comissionamento</h2>
                    <p class="text-muted mb-0">Fechamento mensal e histórico financeiro.</p>
                </div>
                <div class="d-flex gap-2 bg-white p-2 rounded shadow-sm border">
                    <select class="form-select border-0 bg-light" id="filtro-mes">
                        <option value="1">Janeiro</option><option value="2">Fevereiro</option><option value="3">Março</option>
                        <option value="4">Abril</option><option value="5">Maio</option><option value="6">Junho</option>
                        <option value="7">Julho</option><option value="8">Agosto</option><option value="9">Setembro</option>
                        <option value="10">Outubro</option><option value="11">Novembro</option><option value="12">Dezembro</option>
                    </select>
                    <select class="form-select border-0 bg-light" id="filtro-ano">
                        <option value="2024">2024</option><option value="2025">2025</option>
                    </select>
                    <button class="btn btn-filter px-4" onclick="carregarDados()">Filtrar</button>
                </div>
            </div>

            <ul class="nav nav-tabs mb-4" id="comissaoTabs">
                <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-consultor">Visão por Consultor</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-historico">Histórico de Pagamentos</a></li>
            </ul>

            <div class="tab-content">
                <div class="tab-pane fade show active" id="tab-consultor">
                    <div class="d-flex justify-content-between mb-2">
                        <div class="form-check ms-2 pt-2">
                            <input class="form-check-input" type="checkbox" id="check-todos" onclick="toggleTodos(this)">
                            <label class="form-check-label text-muted small fw-bold" for="check-todos">SELECIONAR TODOS</label>
                        </div>
                        <div>
                            <button class="btn btn-outline-danger btn-sm" onclick="gerarPDFSelecionados()">
                                <i class="bi bi-file-earmark-pdf"></i> Gerar PDF Extrato
                            </button>
                            <button class="btn btn-outline-primary btn-sm ms-2" onclick="abrirModalEmail()">
                                <i class="bi bi-envelope-at"></i> Enviar E-mail
                            </button>
                        </div>
                    </div>

                    <div class="card border-0 shadow-sm">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0" style="font-size: 0.9rem;">
                                    <thead>
                                        <tr>
                                            <th style="width: 40px;">#</th>
                                            <th>CONSULTOR</th>
                                            <th class="text-center">QTD</th>
                                            <th class="text-center">META</th>
                                            <th class="text-center">%</th>
                                            <th class="text-end text-primary">COMISSÃO BRUTA</th>
                                            <th class="text-end text-danger">TOTAL DESCONTOS</th>
                                            <th class="text-end text-success bg-light border-start">LÍQUIDO A PAGAR</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbody-consultores"></tbody>
                                    <tfoot id="tfoot-totais" class="table-light fw-bold" style="border-top: 2px solid #dee2e6;"></tfoot>
                                </table>
                            </div>
                        </div>
                        <div class="card-footer bg-white d-flex justify-content-between py-3 align-items-center">
                            <span class="text-muted small" id="status-fechamento-msg"></span>
                            <div id="botoes-acao-fechamento"></div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="tab-historico">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Mês/Ano</th>
                                        <th>Total Pago (Equipe)</th>
                                        <th>Total Recebido (Ciclo)</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-historico"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="modal fade" id="modalEmail" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Enviar Extrato por E-mail</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p>O sistema enviará o extrato individual (PDF e Tabela) para cada consultor selecionado.</p>
            
            <div class="mb-3">
                <label class="form-label">Destinatários</label>
                <input type="text" class="form-control bg-light" id="email-consultor-nome" readonly>
                <input type="hidden" id="email-consultores-ids">
            </div>
            
            <div class="mb-3" id="div-email-destino">
                <label class="form-label">E-mail de Destino (Opcional)</label>
                <input type="email" class="form-control" id="email-destino-input" placeholder="nome@exemplo.com">
                <small class="text-muted">Se vazio, usa o e-mail do cadastro do consultor.</small>
            </div>
            
            <div id="div-aviso-massa" class="alert alert-info d-none">
                <small><i class="bi bi-info-circle"></i> Como você selecionou múltiplos consultores, o sistema usará <b>obrigatoriamente</b> o e-mail cadastrado no perfil de cada um.</small>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary" onclick="confirmarEnvioEmail()">
                <span id="btn-email-text">Enviar Agora</span>
                <span id="btn-email-spinner" class="spinner-border spinner-border-sm d-none"></span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="{% static 'js/auth.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const apiUrl = '/api/crm/comissionamento/'; 
        const token = localStorage.getItem('accessToken');
        if(!token) window.location.href = '/';

        axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;

        document.addEventListener('DOMContentLoaded', () => {
            const hoje = new Date();
            document.getElementById('filtro-mes').value = hoje.getMonth() + 1;
            document.getElementById('filtro-ano').value = hoje.getFullYear();
            carregarDados();
        });

        async function carregarDados() {
            const mes = document.getElementById('filtro-mes').value;
            const ano = document.getElementById('filtro-ano').value;
            const tbody = document.getElementById('tbody-consultores');
            
            tbody.innerHTML = '<tr><td colspan="8" class="text-center py-5"><div class="spinner-border text-primary"></div></td></tr>';

            try {
                const res = await axios.get(`${apiUrl}?ano=${ano}&mes=${mes}`);
                const dados = res.data;

                renderizarTabela(dados.relatorio_consultores);
                renderizarHistorico(dados.historico_pagamentos);
                
                const mesAtualStr = `${mes}/${ano}`;
                const historicoAtual = dados.historico_pagamentos.find(h => h.ano_mes === mesAtualStr);
                atualizarBotoesAcao(historicoAtual ? historicoAtual.status : 'Aberto', dados.relatorio_consultores);

            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="8" class="text-center text-danger p-4">Erro ao carregar dados: ${error.message}</td></tr>`;
            }
        }

        // --- FUNÇÃO DE RENDERIZAÇÃO ATUALIZADA (Accordion) ---
        function renderizarTabela(lista) {
            const tbody = document.getElementById('tbody-consultores');
            tbody.innerHTML = '';
            let totBruta = 0, totLiq = 0;

            if (lista.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-muted">Nenhum dado encontrado.</td></tr>';
                return;
            }

            lista.forEach(c => {
                totBruta += c.comissao_bruta;
                totLiq += c.valor_liquido;

                // 1. Linha MESTRE (Resumo)
                const trMaster = document.createElement('tr');
                trMaster.className = 'border-bottom';
                trMaster.innerHTML = `
                    <td class="text-center"><input type="checkbox" class="form-check-input check-consultor" value="${c.consultor_id}"></td>
                    <td>
                        <div class="d-flex align-items-center">
                            <button class="btn btn-sm btn-light border me-2 rounded-circle shadow-sm btn-toggle-detalhe" 
                                    type="button" 
                                    data-bs-toggle="collapse" 
                                    data-bs-target="#collapse-${c.consultor_id}"
                                    onclick="this.querySelector('i').classList.toggle('bi-plus-lg'); this.querySelector('i').classList.toggle('bi-dash-lg');">
                                <i class="bi bi-plus-lg text-primary small"></i>
                            </button>
                            <span class="fw-bold text-dark">${c.consultor_nome}</span>
                        </div>
                    </td>
                    <td class="text-center">${c.qtd_instaladas}</td>
                    <td class="text-center text-muted">${c.meta}</td>
                    <td class="text-center">
                        <span class="badge ${c.atingimento_pct >= 100 ? 'bg-success' : 'bg-secondary'}">${c.atingimento_pct}%</span>
                    </td>
                    <td class="money-col text-end text-primary">${fmtMoney(c.comissao_bruta)}</td>
                    <td class="money-col text-end text-danger small">
                        ${c.total_descontos > 0 ? '- '+fmtMoney(c.total_descontos) : '-'}
                    </td>
                    <td class="money-col text-end text-success bg-light border-start fw-bold">${fmtMoney(c.valor_liquido)}</td>
                `;
                tbody.appendChild(trMaster);

                // 2. Linha DETALHE (Accordion)
                const trDetail = document.createElement('tr');
                trDetail.className = 'bg-light';
                
                // Gera linhas dos planos
                let htmlPlanos = c.detalhes_planos.map(p => `
                    <tr>
                        <td class="ps-3 text-secondary fw-bold" style="font-size: 0.85rem;">${p.plano}</td>
                        <td class="text-center text-dark">${p.qtd}</td>
                        <td class="text-end text-muted small">${fmtMoney(p.unitario)}</td>
                        <td class="text-end fw-bold text-dark pe-3">${fmtMoney(p.total)}</td>
                    </tr>
                `).join('');
                if (c.detalhes_planos.length === 0) htmlPlanos = '<tr><td colspan="4" class="text-center small text-muted py-2">Nenhuma venda instalada.</td></tr>';

                // Gera lista de descontos
                let htmlDescontos = c.detalhes_descontos.map(d => `
                    <div class="d-flex justify-content-between small mb-1 text-danger">
                        <span>${d.motivo}</span>
                        <span>- ${fmtMoney(d.valor)}</span>
                    </div>
                `).join('');
                if (c.detalhes_descontos.length === 0) htmlDescontos = '<div class="text-muted small fst-italic">Sem descontos aplicados.</div>';

                trDetail.innerHTML = `
                    <td colspan="8" class="p-0 border-0">
                        <div class="collapse" id="collapse-${c.consultor_id}">
                            <div class="row g-0">
                                <div class="col-md-8 border-end">
                                    <div class="p-3">
                                        <h6 class="text-uppercase text-muted small fw-bold mb-2"><i class="bi bi-cart-check"></i> Detalhamento por Plano</h6>
                                        <table class="table table-sm table-borderless mb-0 rounded bg-white shadow-sm overflow-hidden">
                                            <thead class="table-light border-bottom small text-secondary">
                                                <tr>
                                                    <th class="ps-3">Plano</th>
                                                    <th class="text-center">Qtd</th>
                                                    <th class="text-end">Unit.</th>
                                                    <th class="text-end pe-3">Total</th>
                                                </tr>
                                            </thead>
                                            <tbody>${htmlPlanos}</tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="col-md-4 bg-white">
                                    <div class="p-3 h-100">
                                        <h6 class="text-uppercase text-muted small fw-bold mb-3"><i class="bi bi-calculator"></i> Fechamento</h6>
                                        <div class="d-flex justify-content-between small mb-2">
                                            <span class="text-secondary">Comissão Bruta</span>
                                            <span class="fw-bold text-primary">${fmtMoney(c.comissao_bruta)}</span>
                                        </div>
                                        <div class="border-top border-bottom py-2 my-2 bg-light px-2 rounded">
                                            ${htmlDescontos}
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mt-3 pt-2 border-top">
                                            <span class="fw-bold text-uppercase text-success small">Total a Receber</span>
                                            <span class="fs-5 fw-bold text-success">${fmtMoney(c.valor_liquido)}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(trDetail);
            });

            document.getElementById('tfoot-totais').innerHTML = `
                <tr>
                    <td colspan="5" class="text-end text-uppercase text-muted small">Totais do Mês:</td>
                    <td class="text-end text-primary">${fmtMoney(totBruta)}</td>
                    <td></td>
                    <td class="text-end text-success bg-light border-start">${fmtMoney(totLiq)}</td>
                </tr>`;
        }
        // -----------------------------------------------------

        function renderizarHistorico(lista) {
            const tbody = document.getElementById('tbody-historico');
            tbody.innerHTML = '';
            lista.forEach(h => {
                tbody.innerHTML += `<tr><td class="fw-bold">${h.ano_mes}</td><td class="text-success fw-bold">${fmtMoney(h.total_pago_equipe)}</td><td class="text-primary">${fmtMoney(h.total_recebido_ciclo)}</td><td><span class="badge ${h.status === 'Fechado' ? 'bg-success' : 'bg-warning'}">${h.status}</span></td><td><button class="btn btn-sm btn-light border">Ver</button></td></tr>`;
            });
        }

        function atualizarBotoesAcao(status, dados) {
            const div = document.getElementById('botoes-acao-fechamento');
            const msg = document.getElementById('status-fechamento-msg');
            const totalLiq = dados.reduce((acc, cur) => acc + cur.valor_liquido, 0);

            if (status === 'Fechado') {
                msg.innerHTML = '<i class="bi bi-lock-fill text-success"></i> Mês Fechado e Pago.';
                div.innerHTML = `<button class="btn btn-outline-secondary btn-lg" onclick="reabrirMes()"><i class="bi bi-unlock"></i> Reabrir Mês (Correção)</button>`;
            } else {
                msg.innerHTML = '<i class="bi bi-unlock text-warning"></i> Mês Aberto (Em andamento).';
                div.innerHTML = `<button class="btn btn-success btn-lg" onclick="fecharPagamentoMes(${totalLiq})"><i class="bi bi-check-circle-fill"></i> Fechar Pagamento do Mês</button>`;
            }
        }

        async function fecharPagamentoMes(total) {
            if(!confirm("ATENÇÃO: Ao fechar o pagamento, todas as vendas instaladas serão marcadas como PAGO. Continuar?")) return;
            const ano = document.getElementById('filtro-ano').value;
            const mes = document.getElementById('filtro-mes').value;
            
            try {
                await axios.post(`${apiUrl}fechar/`, { ano, mes, total_pago: total });
                alert("Mês fechado com sucesso!");
                carregarDados();
            } catch(e) { alert("Erro ao fechar: " + (e.response?.data?.error || e.message)); }
        }

        async function reabrirMes() {
            if(!confirm("Deseja reabrir este mês para correções? As vendas voltarão para PENDENTE.")) return;
            const ano = document.getElementById('filtro-ano').value;
            const mes = document.getElementById('filtro-mes').value;
            
            try {
                await axios.post(`${apiUrl}reabrir/`, { ano, mes });
                alert("Mês reaberto!");
                carregarDados();
            } catch(e) { alert("Erro ao reabrir: " + (e.response?.data?.error || e.message)); }
        }

        async function gerarPDFSelecionados() {
            const checks = document.querySelectorAll('.check-consultor:checked');
            if(checks.length === 0) { alert("Selecione pelo menos um consultor."); return; }
            
            const ids = Array.from(checks).map(c => c.value);
            const ano = document.getElementById('filtro-ano').value;
            const mes = document.getElementById('filtro-mes').value;

            try {
                const res = await axios.post(`${apiUrl}pdf/`, { ano, mes, consultores: ids }, { responseType: 'blob' });
                const url = window.URL.createObjectURL(new Blob([res.data]));
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', `Extrato_Comissao_${mes}_${ano}.pdf`);
                document.body.appendChild(link);
                link.click();
            } catch(e) { alert("Erro ao gerar PDF."); }
        }

        function abrirModalEmail() {
            const checks = document.querySelectorAll('.check-consultor:checked');
            if(checks.length === 0) { 
                alert("Selecione pelo menos um consultor."); 
                return; 
            }
            
            const ids = Array.from(checks).map(c => c.value);
            document.getElementById('email-consultores-ids').value = JSON.stringify(ids);
            
            const nomeField = document.getElementById('email-consultor-nome');
            const emailDiv = document.getElementById('div-email-destino');
            const avisoMassa = document.getElementById('div-aviso-massa');
            
            if (ids.length === 1) {
                // Pega nome da coluna ao lado do checkbox
                const nome = checks[0].closest('tr').cells[1].innerText.trim(); 
                nomeField.value = nome;
                emailDiv.classList.remove('d-none');
                avisoMassa.classList.add('d-none');
            } else {
                nomeField.value = `${ids.length} consultores selecionados`;
                emailDiv.classList.add('d-none'); 
                avisoMassa.classList.remove('d-none'); 
            }
            
            document.getElementById('email-destino-input').value = ""; 
            new bootstrap.Modal(document.getElementById('modalEmail')).show();
        }

        async function confirmarEnvioEmail() {
            const idsStr = document.getElementById('email-consultores-ids').value;
            if(!idsStr) return;
            const ids = JSON.parse(idsStr); 
            
            const email = document.getElementById('email-destino-input').value;
            const ano = document.getElementById('filtro-ano').value;
            const mes = document.getElementById('filtro-mes').value;
            
            const btnText = document.getElementById('btn-email-text');
            const spinner = document.getElementById('btn-email-spinner');
            
            btnText.classList.add('d-none');
            spinner.classList.remove('d-none');
            
            try {
                const res = await axios.post(`${apiUrl}email/`, { 
                    ano, mes, 
                    consultores: ids, 
                    email_destino: email 
                });
                
                alert(res.data.mensagem); 
                bootstrap.Modal.getInstance(document.getElementById('modalEmail')).hide();
                
            } catch(e) { 
                alert("Erro ao enviar: " + (e.response?.data?.error || e.message)); 
            } finally {
                btnText.classList.remove('d-none');
                spinner.classList.add('d-none');
            }
        }

        function toggleTodos(source) {
            document.querySelectorAll('.check-consultor').forEach(c => c.checked = source.checked);
        }

        function fmtMoney(val) { return val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
        function logout() { localStorage.removeItem('accessToken'); window.location.href = '/'; }
    </script>
</body>
</html>