{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Comissionamento</title>
    <link rel="shortcut icon" href="{% static 'logo.png' %}" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{% static 'css/custom_styles.css' %}?v=5.0">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        /* Estilo Limpo e Profissional */
        .table thead th { 
            font-size: 0.8rem; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            vertical-align: middle;
            background-color: #f8f9fa; 
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }
        .money-col { 
            font-family: 'Consolas', 'Monaco', monospace; 
            font-weight: 600; 
            white-space: nowrap;
        }
        .border-left-strong { border-left: 2px solid #e9ecef !important; }
        
        .btn-filter { background-color: #0d6efd; color: white; }
        .btn-filter:hover { background-color: #0b5ed7; color: white; }

        .btn-toggle-detalhe {
            width: 24px; height: 24px; 
            padding: 0; 
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .btn-toggle-detalhe:hover { background-color: #e9ecef; }

        /* Estilo dos Filtros na Tabela */
        .filter-row th { background-color: #e9ecef !important; padding: 5px !important; }
        .filter-input { font-size: 0.75rem; border: 1px solid #ced4da; border-radius: 2px; padding: 4px; width: 100%; }
        .filter-input:focus { outline: none; border-color: #86b7fe; box-shadow: 0 0 0 0.2rem rgba(13,110,253,.25); }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="header-container">
            <a href="/"><img src="{% static 'logo.png' %}" alt="Record PAP Logo" class="logo"></a>
            <button class="menu-toggle" id="menu-toggle"><div class="bar"></div><div class="bar"></div><div class="bar"></div></button>
            <nav class="main-nav" id="main-nav">
                <ul>
                    <li><a href="/area-interna/">Voltar</a></li>
                    <li><button onclick="logout()" class="nav-button logout-button">Sair</button></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="area-interna-section">
        <div class="system-container" style="max-width: 1600px;"> 
            
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="fw-bold text-dark"><i class="bi bi-wallet2"></i> Gestão de Comissionamento</h2>
                    <p class="text-muted mb-0">Fechamento mensal e histórico financeiro.</p>
                </div>
                <div class="d-flex gap-2 bg-white p-2 rounded shadow-sm border">
                    <select class="form-select border-0 bg-light" id="filtro-mes">
                        <option value="1">Janeiro</option><option value="2">Fevereiro</option><option value="3">Março</option>
                        <option value="4">Abril</option><option value="5">Maio</option><option value="6">Junho</option>
                        <option value="7">Julho</option><option value="8">Agosto</option><option value="9">Setembro</option>
                        <option value="10">Outubro</option><option value="11">Novembro</option><option value="12">Dezembro</option>
                    </select>
                    <select class="form-select border-0 bg-light" id="filtro-ano">
                        <option value="2024">2024</option><option value="2025">2025</option>
                    </select>
                    <button class="btn btn-filter px-4" onclick="carregarDados()">Filtrar</button>
                </div>
            </div>

            <ul class="nav nav-tabs mb-4" id="comissaoTabs">
                <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-consultor">Visão por Consultor</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-pendencias" onclick="carregarPendencias()">Confirmar Descontos</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-historico">Histórico de Pagamentos</a></li>
            </ul>

            <div class="tab-content">
                
                <div class="tab-pane fade show active" id="tab-consultor">
                    <div class="d-flex justify-content-between mb-2">
                        <div class="form-check ms-2 pt-2">
                            <input class="form-check-input" type="checkbox" id="check-todos" onclick="toggleTodos(this)">
                            <label class="form-check-label text-muted small fw-bold" for="check-todos">SELECIONAR TODOS</label>
                        </div>
                        <div>
                            <button class="btn btn-outline-danger btn-sm" onclick="gerarPDFSelecionados()">
                                <i class="bi bi-file-earmark-pdf"></i> Gerar PDF Extrato
                            </button>
                            <button class="btn btn-outline-primary btn-sm ms-2" onclick="abrirModalEmail()">
                                <i class="bi bi-envelope-at"></i> Enviar E-mail
                            </button>
                            <button class="btn btn-success btn-sm ms-2 text-white" onclick="enviarComissaoWhatsapp()">
                                <i class="bi bi-whatsapp"></i> Enviar via WhatsApp
                            </button>
                        </div>
                    </div>

                    <div class="card border-0 shadow-sm">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0" style="font-size: 0.9rem;">
                                    <thead>
                                        <tr>
                                            <th style="width: 40px;">#</th>
                                            <th>CONSULTOR</th>
                                            <th class="text-center">QTD</th>
                                            <th class="text-center">META</th>
                                            <th class="text-center">%</th>
                                            <th class="text-end text-primary">COMISSÃO BRUTA</th>
                                            <th class="text-end text-danger">TOTAL DESCONTOS</th>
                                            <th class="text-end text-success bg-light border-start">LÍQUIDO A PAGAR</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbody-consultores"></tbody>
                                    <tfoot id="tfoot-totais" class="table-light fw-bold" style="border-top: 2px solid #dee2e6;"></tfoot>
                                </table>
                            </div>
                        </div>
                        <div class="card-footer bg-white d-flex justify-content-between py-3 align-items-center">
                            <span class="text-muted small" id="status-fechamento-msg"></span>
                            <div id="botoes-acao-fechamento"></div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="tab-pendencias">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0 text-primary fw-bold"><i class="bi bi-list-check"></i> Pendências de Desconto/Adiantamento</h6>
                                <div class="d-flex gap-2 align-items-center">
                                    <label class="small text-muted me-2">Data do Lançamento:</label>
                                    <input type="date" id="data-confirmacao-desc" class="form-control form-control-sm" style="width: 150px;">
                                    <button class="btn btn-success btn-sm" onclick="confirmarDescontosSelecionados()">
                                        <i class="bi bi-check-lg"></i> Confirmar Selecionados
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                                <table class="table table-hover align-middle mb-0 small">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th width="30"><input type="checkbox" onchange="togglePendencias(this)"></th>
                                            <th>Vendedor</th>
                                            <th>Cliente / Dados</th>
                                            <th>Tipo de Desconto</th>
                                            <th>Data Inst.</th>
                                            <th class="text-end">Valor (R$)</th>
                                        </tr>
                                        <tr class="filter-row">
                                            <th></th>
                                            <th>
                                                <select id="filtro-pend-vendedor" class="filter-input" onchange="filtrarTabelaPendencias()">
                                                    <option value="">Todos</option>
                                                </select>
                                            </th>
                                            <th>
                                                <input type="text" id="filtro-pend-cliente" class="filter-input" placeholder="Buscar Nome, CPF ou OS..." onkeyup="filtrarTabelaPendencias()">
                                            </th>
                                            <th>
                                                <select id="filtro-pend-tipo" class="filter-input" onchange="filtrarTabelaPendencias()">
                                                    <option value="">Todos</option>
                                                    <option value="CNPJ">Adiantamento CNPJ</option>
                                                    <option value="BOLETO">Desconto Boleto</option>
                                                    <option value="VIABILIDADE">Inclusão/Viabilidade</option>
                                                    <option value="ANTECIPACAO">Antecipação</option>
                                                </select>
                                            </th>
                                            <th></th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbody-pendencias"></tbody>
                                </table>
                            </div>
                            <div class="p-2 text-center small text-muted border-top">
                                Exibindo <span id="count-exibidos">0</span> de <span id="count-total">0</span> pendências.
                            </div>
                        </div>
                    </div>

                    <div class="card border-0 shadow-sm mt-4">
                        <div class="card-header bg-light py-2">
                            <h6 class="mb-0 text-secondary small fw-bold"><i class="bi bi-clock-history"></i> Histórico de Processamentos (Últimos 50)</h6>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive px-3 py-2" style="max-height: 300px; overflow-y: auto;">
                                <table class="table table-sm table-bordered table-hover small mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Data Lançamento</th>
                                            <th>Vendedor</th>
                                            <th>Descrição / Tipos</th>
                                            <th class="text-end">Valor</th>
                                            <th>Processado Por</th>
                                            <th class="text-center">Ação</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbody-historico-auto"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="tab-historico">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Mês/Ano</th>
                                        <th>Total Pago (Equipe)</th>
                                        <th>Total Recebido (Ciclo)</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-historico"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="modal fade" id="modalEmail" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Enviar Extrato por E-mail</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p>O sistema enviará o extrato individual (PDF e Tabela) para cada consultor selecionado.</p>
            <div class="mb-3">
                <label class="form-label">Destinatários</label>
                <input type="text" class="form-control bg-light" id="email-consultor-nome" readonly>
                <input type="hidden" id="email-consultores-ids">
            </div>
            <div class="mb-3" id="div-email-destino">
                <label class="form-label">E-mail de Destino (Opcional)</label>
                <input type="email" class="form-control" id="email-destino-input" placeholder="nome@exemplo.com">
                <small class="text-muted">Se vazio, usa o e-mail do cadastro do consultor.</small>
            </div>
            <div id="div-aviso-massa" class="alert alert-info d-none">
                <small><i class="bi bi-info-circle"></i> Como você selecionou múltiplos consultores, o sistema usará <b>obrigatoriamente</b> o e-mail cadastrado no perfil de cada um.</small>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary" onclick="confirmarEnvioEmail()">
                <span id="btn-email-text">Enviar Agora</span>
                <span id="btn-email-spinner" class="spinner-border spinner-border-sm d-none"></span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="{% static 'js/auth.js' %}?v=5.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const apiUrl = '/api/crm/comissionamento/'; 
        const token = localStorage.getItem('accessToken');
        if(!token) window.location.href = '/';

        axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
        
        // Cache Global para Filtros
        let pendenciasCache = [];

        document.addEventListener('DOMContentLoaded', () => {
            const hoje = new Date();
            document.getElementById('filtro-mes').value = hoje.getMonth() + 1;
            document.getElementById('filtro-ano').value = hoje.getFullYear();
            
            // Define data de hoje para a confirmação
            document.getElementById('data-confirmacao-desc').value = hoje.toISOString().split('T')[0];
            
            carregarDados();
        });

        // --- ABA 1: CARREGAR DADOS ---
        async function carregarDados() {
            const mes = document.getElementById('filtro-mes').value;
            const ano = document.getElementById('filtro-ano').value;
            const tbody = document.getElementById('tbody-consultores');
            
            tbody.innerHTML = '<tr><td colspan="8" class="text-center py-5"><div class="spinner-border text-primary"></div></td></tr>';

            try {
                const res = await axios.get(`${apiUrl}?ano=${ano}&mes=${mes}`);
                const dados = res.data;

                renderizarTabela(dados.relatorio_consultores);
                renderizarHistorico(dados.historico_pagamentos);
                
                const mesAtualStr = `${mes}/${ano}`;
                const historicoAtual = dados.historico_pagamentos.find(h => h.ano_mes === mesAtualStr);
                atualizarBotoesAcao(historicoAtual ? historicoAtual.status : 'Aberto', dados.relatorio_consultores);

            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="8" class="text-center text-danger p-4">Erro ao carregar dados: ${error.message}</td></tr>`;
            }
        }

        // --- ABA 2: PENDÊNCIAS COM FILTROS ---
        async function carregarPendencias() {
            const tbody = document.getElementById('tbody-pendencias');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-3">Carregando...</td></tr>';
            
            try {
                const res = await axios.get(`${apiUrl}pendencias-desconto/`);
                pendenciasCache = res.data; // Guarda no cache
                
                atualizarFiltrosVendedor(pendenciasCache); // Popula o select de vendedores
                renderizarTabelaPendencias(pendenciasCache); // Renderiza tudo
                carregarHistoricoAuto(); // <--- CHAMA A FUNÇÃO DE HISTÓRICO

            } catch(e) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Erro ao carregar pendências.</td></tr>';
                console.error(e);
            }
        }

        function atualizarFiltrosVendedor(lista) {
            const select = document.getElementById('filtro-pend-vendedor');
            const vendedoresUnicos = [...new Set(lista.map(item => item.vendedor_nome))].sort();
            
            // Mantém "Todos" e adiciona os vendedores
            select.innerHTML = '<option value="">Todos</option>';
            vendedoresUnicos.forEach(v => {
                select.add(new Option(v, v));
            });
        }

        function renderizarTabelaPendencias(lista) {
            const tbody = document.getElementById('tbody-pendencias');
            tbody.innerHTML = '';
            
            document.getElementById('count-exibidos').textContent = lista.length;
            document.getElementById('count-total').textContent = pendenciasCache.length;

            if(lista.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-3 text-muted">Nenhuma pendência encontrada com esses filtros.</td></tr>';
                return;
            }

            lista.forEach((item) => {
                const jsonDados = JSON.stringify({
                    venda_id: item.venda_id,
                    vendedor_id: item.vendedor_id,
                    tipo_codigo: item.tipo_codigo,
                    valor: item.valor
                });
                
                // Formata dados extras
                const cpf = item.cliente_cpf || "";
                const os = item.os || "S/ OS";
                const infoExtra = `<div class="small text-muted" style="font-size: 0.75rem;">CPF: ${cpf} | OS: ${os}</div>`;

                tbody.innerHTML += `
                    <tr>
                        <td><input type="checkbox" class="check-pendencia" value='${jsonDados}'></td>
                        <td class="fw-bold">${item.vendedor_nome}</td>
                        <td>
                            <div>${item.cliente}</div>
                            ${infoExtra}
                        </td>
                        <td><span class="badge bg-warning text-dark border">${item.titulo}</span></td>
                        <td>${new Date(item.data_instalacao).toLocaleDateString('pt-BR')}</td>
                        <td class="text-end text-danger fw-bold">R$ ${parseFloat(item.valor).toFixed(2)}</td>
                    </tr>
                `;
            });
        }

        function filtrarTabelaPendencias() {
            const termoBusca = document.getElementById('filtro-pend-cliente').value.toLowerCase();
            const tipoSelecionado = document.getElementById('filtro-pend-tipo').value;
            const vendedorSelecionado = document.getElementById('filtro-pend-vendedor').value;

            const filtrados = pendenciasCache.filter(item => {
                // Filtro Texto (Nome, CPF, OS)
                const textoCompleto = `${item.cliente} ${item.cliente_cpf || ''} ${item.os || ''}`.toLowerCase();
                const matchTexto = textoCompleto.includes(termoBusca);

                // Filtro Tipo
                const matchTipo = tipoSelecionado ? item.tipo_codigo === tipoSelecionado : true;

                // Filtro Vendedor
                const matchVendedor = vendedorSelecionado ? item.vendedor_nome === vendedorSelecionado : true;

                return matchTexto && matchTipo && matchVendedor;
            });

            renderizarTabelaPendencias(filtrados);
        }

        function togglePendencias(source) {
            document.querySelectorAll('.check-pendencia').forEach(c => c.checked = source.checked);
        }

        async function confirmarDescontosSelecionados() {
            const checks = document.querySelectorAll('.check-pendencia:checked');
            if(checks.length === 0) return alert("Selecione pelo menos um item.");
            
            const dataLanc = document.getElementById('data-confirmacao-desc').value;
            if(!dataLanc) return alert("Selecione a data para o lançamento financeiro.");

            if(!confirm(`Confirma o lançamento financeiro de ${checks.length} descontos na data ${dataLanc}?`)) return;

            const itensParaEnviar = Array.from(checks).map(c => JSON.parse(c.value));

            try {
                const res = await axios.post(`${apiUrl}confirmar-descontos/`, {
                    data: dataLanc,
                    itens: itensParaEnviar
                });
                alert(res.data.mensagem);
                carregarPendencias(); // Recarrega a lista do servidor
            } catch(e) {
                alert("Erro: " + (e.response?.data?.error || e.message));
            }
        }

        // --- FUNÇÕES DE HISTÓRICO E REVERSÃO ---
        async function carregarHistoricoAuto() {
            const tbody = document.getElementById('tbody-historico-auto');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Carregando histórico...</td></tr>';

            try {
                const res = await axios.get(`${apiUrl}historico-auto/`);
                const lista = res.data;

                tbody.innerHTML = '';
                if (lista.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhum processamento recente.</td></tr>';
                    return;
                }

                lista.forEach(l => {
                    // Tratar datas corretamente
                    let dataFmt = l.data_lancamento;
                    // Se vier no formato YYYY-MM-DD
                    if (dataFmt.includes('-')) {
                        const parts = dataFmt.split('-');
                        dataFmt = `${parts[2]}/${parts[1]}/${parts[0]}`;
                    }
                    
                    const criadoEm = new Date(l.criado_em).toLocaleString('pt-BR');
                    
                    tbody.innerHTML += `
                        <tr>
                            <td>${dataFmt}</td>
                            <td class="fw-bold">${l.vendedor}</td>
                            <td>${l.descricao}</td>
                            <td class="text-end text-danger fw-bold">R$ ${parseFloat(l.valor).toFixed(2)}</td>
                            <td class="text-center"><small class="text-muted" title="Em ${criadoEm}">${l.criado_por}</small></td>
                            <td class="text-center">
                                <button class="btn btn-xs btn-outline-danger py-0" onclick="reverterProcessamento(${l.id})" title="Desfazer lançamento e voltar vendas para pendência">
                                    <i class="bi bi-arrow-counterclockwise"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
            } catch(e) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-danger text-center">Erro ao carregar histórico.</td></tr>';
            }
        }

        async function reverterProcessamento(id) {
            if(!confirm("ATENÇÃO: Isso irá EXCLUIR este lançamento financeiro e as vendas voltarão a aparecer como PENDÊNCIA DE DESCONTO. Deseja continuar?")) return;

            try {
                const res = await axios.post(`${apiUrl}reverter-auto/`, { id: id });
                alert(res.data.mensagem);
                carregarPendencias(); // Recarrega tudo
            } catch(e) {
                alert("Erro ao reverter: " + (e.response?.data?.error || e.message));
            }
        }

        // --- FUNÇÕES GERAIS (HISTÓRICO, PDF, ZAP) ---
        function renderizarTabela(lista) {
            const tbody = document.getElementById('tbody-consultores');
            tbody.innerHTML = '';
            let totBruta = 0, totLiq = 0;

            if (lista.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-muted">Nenhum dado encontrado.</td></tr>';
                return;
            }

            lista.forEach(c => {
                totBruta += c.comissao_bruta;
                totLiq += c.valor_liquido;

                const trMaster = document.createElement('tr');
                trMaster.className = 'border-bottom';
                trMaster.innerHTML = `
                    <td class="text-center"><input type="checkbox" class="form-check-input check-consultor" value="${c.consultor_id}"></td>
                    <td>
                        <div class="d-flex align-items-center">
                            <button class="btn btn-sm btn-light border me-2 rounded-circle shadow-sm btn-toggle-detalhe" 
                                    type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${c.consultor_id}"
                                    onclick="this.querySelector('i').classList.toggle('bi-plus-lg'); this.querySelector('i').classList.toggle('bi-dash-lg');">
                                <i class="bi bi-plus-lg text-primary small"></i>
                            </button>
                            <span class="fw-bold text-dark">${c.consultor_nome}</span>
                        </div>
                    </td>
                    <td class="text-center">${c.qtd_instaladas}</td>
                    <td class="text-center text-muted">${c.meta}</td>
                    <td class="text-center"><span class="badge ${c.atingimento_pct >= 100 ? 'bg-success' : 'bg-secondary'}">${c.atingimento_pct}%</span></td>
                    <td class="money-col text-end text-primary">${fmtMoney(c.comissao_bruta)}</td>
                    <td class="money-col text-end text-danger small">${c.total_descontos > 0 ? '- '+fmtMoney(c.total_descontos) : '-'}</td>
                    <td class="money-col text-end text-success bg-light border-start fw-bold">${fmtMoney(c.valor_liquido)}</td>
                `;
                tbody.appendChild(trMaster);

                const trDetail = document.createElement('tr');
                trDetail.className = 'bg-light';
                
                let htmlPlanos = c.detalhes_planos.map(p => `<tr><td class="ps-3 small fw-bold">${p.plano}</td><td class="text-center">${p.qtd}</td><td class="text-end small">${fmtMoney(p.unitario)}</td><td class="text-end fw-bold pe-3">${fmtMoney(p.total)}</td></tr>`).join('');
                if (c.detalhes_planos.length === 0) htmlPlanos = '<tr><td colspan="4" class="text-center small text-muted">Nenhuma venda.</td></tr>';

                let htmlDescontos = c.detalhes_descontos.map(d => `<div class="d-flex justify-content-between small mb-1 text-danger"><span>${d.motivo}</span><span>- ${fmtMoney(d.valor)}</span></div>`).join('');
                if (c.detalhes_descontos.length === 0) htmlDescontos = '<div class="text-muted small fst-italic">Sem descontos.</div>';

                let htmlBonus = (c.detalhes_bonus || []).map(b => `<div class="d-flex justify-content-between small mb-1 text-success fw-bold"><span><i class="bi bi-trophy-fill"></i> ${b.motivo}</span><span>+ ${fmtMoney(b.valor)}</span></div>`).join('');

                trDetail.innerHTML = `
                    <td colspan="8" class="p-0 border-0">
                        <div class="collapse" id="collapse-${c.consultor_id}">
                            <div class="row g-0">
                                <div class="col-md-8 border-end">
                                    <div class="p-3">
                                        <h6 class="text-uppercase text-muted small fw-bold mb-2">Detalhamento</h6>
                                        <table class="table table-sm table-borderless mb-0 bg-white shadow-sm"><tbody>${htmlPlanos}</tbody></table>
                                    </div>
                                </div>
                                <div class="col-md-4 bg-white">
                                    <div class="p-3 h-100">
                                        <h6 class="text-uppercase text-muted small fw-bold mb-3">Fechamento</h6>
                                        <div class="d-flex justify-content-between small mb-2"><span class="text-secondary">Bruto</span><span class="fw-bold text-primary">${fmtMoney(c.comissao_bruta)}</span></div>
                                        <div class="my-2">${htmlBonus}</div>
                                        <div class="border-top border-bottom py-2 my-2 bg-light px-2 rounded">${htmlDescontos}</div>
                                        <div class="d-flex justify-content-between align-items-center mt-3 pt-2 border-top"><span class="fw-bold text-success small">A RECEBER</span><span class="fs-5 fw-bold text-success">${fmtMoney(c.valor_liquido)}</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>`;
                tbody.appendChild(trDetail);
            });
            document.getElementById('tfoot-totais').innerHTML = `<tr><td colspan="5" class="text-end small">TOTAIS:</td><td class="text-end text-primary">${fmtMoney(totBruta)}</td><td></td><td class="text-end text-success">${fmtMoney(totLiq)}</td></tr>`;
        }

        function renderizarHistorico(lista) {
            const tbody = document.getElementById('tbody-historico');
            tbody.innerHTML = '';
            lista.forEach(h => {
                tbody.innerHTML += `<tr><td class="fw-bold">${h.ano_mes}</td><td class="text-success fw-bold">${fmtMoney(h.total_pago_equipe)}</td><td class="text-primary">${fmtMoney(h.total_recebido_ciclo)}</td><td><span class="badge ${h.status === 'Fechado' ? 'bg-success' : 'bg-warning'}">${h.status}</span></td><td><button class="btn btn-sm btn-light border">Ver</button></td></tr>`;
            });
        }

        function atualizarBotoesAcao(status, dados) {
            const div = document.getElementById('botoes-acao-fechamento');
            const msg = document.getElementById('status-fechamento-msg');
            const totalLiq = dados.reduce((acc, cur) => acc + cur.valor_liquido, 0);

            if (status === 'Fechado') {
                msg.innerHTML = '<i class="bi bi-lock-fill text-success"></i> Mês Fechado e Pago.';
                div.innerHTML = `<button class="btn btn-outline-secondary btn-lg" onclick="reabrirMes()"><i class="bi bi-unlock"></i> Reabrir Mês</button>`;
            } else {
                msg.innerHTML = '<i class="bi bi-unlock text-warning"></i> Mês Aberto.';
                div.innerHTML = `<button class="btn btn-success btn-lg" onclick="fecharPagamentoMes(${totalLiq})"><i class="bi bi-check-circle-fill"></i> Fechar Pagamento</button>`;
            }
        }

        async function fecharPagamentoMes(total) {
            if(!confirm("Fechar pagamento do mês?")) return;
            try { await axios.post(`${apiUrl}fechar/`, { ano: document.getElementById('filtro-ano').value, mes: document.getElementById('filtro-mes').value, total_pago: total }); alert("Fechado!"); carregarDados(); } catch(e) { alert("Erro: " + e.message); }
        }

        async function reabrirMes() {
            if(!confirm("Reabrir mês?")) return;
            try { await axios.post(`${apiUrl}reabrir/`, { ano: document.getElementById('filtro-ano').value, mes: document.getElementById('filtro-mes').value }); alert("Reaberto!"); carregarDados(); } catch(e) { alert("Erro: " + e.message); }
        }

        // Funções PDF/Email/Zap mantidas (abreviadas aqui, mas completas no arquivo original anterior se necessário)
        async function gerarPDFSelecionados() {
            const checks = document.querySelectorAll('.check-consultor:checked');
            if(checks.length === 0) return alert("Selecione alguém.");
            const ids = Array.from(checks).map(c => c.value);
            try {
                const res = await axios.post(`${apiUrl}pdf/`, { ano: document.getElementById('filtro-ano').value, mes: document.getElementById('filtro-mes').value, consultores: ids }, { responseType: 'blob' });
                const url = window.URL.createObjectURL(new Blob([res.data]));
                const link = document.createElement('a'); link.href = url; link.download = `Extrato.pdf`; document.body.appendChild(link); link.click();
            } catch(e) { alert("Erro PDF."); }
        }

        async function enviarComissaoWhatsapp() {
            const checks = document.querySelectorAll('.check-consultor:checked');
            if(checks.length === 0) return alert("Selecione alguém.");
            if(!confirm("Enviar Zap?")) return;
            const ids = Array.from(checks).map(c => c.value);
            try { alert("Enviando..."); await axios.post(`${apiUrl}whatsapp/`, { ano: document.getElementById('filtro-ano').value, mes: document.getElementById('filtro-mes').value, consultores: ids }); alert("Enviado."); } catch(e) { alert("Erro Zap."); }
        }

        function abrirModalEmail() {
            const checks = document.querySelectorAll('.check-consultor:checked');
            if(checks.length === 0) return alert("Selecione alguém.");
            document.getElementById('email-consultores-ids').value = JSON.stringify(Array.from(checks).map(c => c.value));
            document.getElementById('email-consultor-nome').value = `${checks.length} selecionados`;
            new bootstrap.Modal(document.getElementById('modalEmail')).show();
        }

        async function confirmarEnvioEmail() {
            try {
                await axios.post(`${apiUrl}email/`, { 
                    ano: document.getElementById('filtro-ano').value, mes: document.getElementById('filtro-mes').value, 
                    consultores: JSON.parse(document.getElementById('email-consultores-ids').value), 
                    email_destino: document.getElementById('email-destino-input').value 
                });
                alert("E-mail enviado!");
                bootstrap.Modal.getInstance(document.getElementById('modalEmail')).hide();
            } catch(e) { alert("Erro email: " + e.message); }
        }

        function toggleTodos(source) { document.querySelectorAll('.check-consultor').forEach(c => c.checked = source.checked); }
        function fmtMoney(val) { return val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
    </script>
    <script src="{% static 'js/menu.js' %}?v=5.0"></script>
</body>
</html>