{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Record Vertical - CDOI</title>
    <link rel="shortcut icon" href="{% static 'logo.png' %}" type="image/x-icon">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { background-color: #f8f9fc; }
        .card { border: none; border-radius: 10px; }
        .card-header { border-top-left-radius: 10px; border-top-right-radius: 10px; }
        .btn-success { background-color: #1cc88a; border-color: #1cc88a; }
        .btn-success:hover { background-color: #17a673; border-color: #169b6b; }
        .main-header { background: white; padding: 10px 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .logo { height: 40px; }
        .nav-button { background: none; border: none; color: #5a5c69; font-weight: 600; text-decoration: none; cursor: pointer; }
    </style>
</head>
<body>

    <header class="main-header">
        <a href="/area-interna/"><img src="{% static 'logo.png' %}" alt="Logo" class="logo"></a>
        <a href="/area-interna/" class="nav-button"><i class="fas fa-arrow-left"></i> Voltar</a>
    </header>

    <div class="container mt-4 mb-5">
        <div class="card shadow-lg">
            <div class="card-header bg-primary text-white d-flex align-items-center">
                <i class="fas fa-building fa-2x me-3"></i>
                <h3 class="mb-0">Record Vertical (CDOI)</h3>
            </div>
            <div class="card-body">
                
                <div id="msg-area"></div>

                <form id="formCDOI" onsubmit="enviarViaAjax(event)">
                    
                    <h5 class="text-secondary border-bottom pb-2 mb-3">1. Dados do Condomínio</h5>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Nome do Condomínio</label>
                            <input type="text" name="nome_condominio" class="form-control" required placeholder="Ex: Residencial Record">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Nome do Síndico</label>
                            <input type="text" name="nome_sindico" class="form-control" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Contato (Zap/Tel)</label>
                            <input type="text" name="contato_sindico" class="form-control" required>
                        </div>
                    </div>

                    <h5 class="text-secondary border-bottom pb-2 mt-4 mb-3">2. Localização</h5>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">CEP</label>
                            <div class="input-group">
                                <input type="text" name="cep" id="cep" class="form-control" required placeholder="00000-000">
                                <button class="btn btn-outline-secondary" type="button" onclick="buscarCep()"><i class="fas fa-search"></i></button>
                            </div>
                        </div>
                        <div class="col-md-7">
                            <label class="form-label">Logradouro</label>
                            <input type="text" name="logradouro" id="logradouro" class="form-control" required readonly>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Número</label>
                            <input type="text" name="numero" class="form-control" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Bairro</label>
                            <input type="text" name="bairro" id="bairro" class="form-control" required readonly>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Cidade</label>
                            <input type="text" name="cidade" id="cidade" class="form-control" required readonly>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">UF</label>
                            <input type="text" name="uf" id="uf" class="form-control" required readonly>
                        </div>
                    </div>
                    
                    <div class="row g-3 mt-3 p-3 bg-light rounded border">
                        <div class="col-md-12">
                            <small class="text-muted"><i class="fas fa-satellite"></i> Clique abaixo para buscar as coordenadas automaticamente.</small>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Latitude</label>
                            <input type="text" name="latitude" id="latitude" class="form-control" readonly>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Longitude</label>
                            <input type="text" name="longitude" id="longitude" class="form-control" readonly>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="button" class="btn btn-primary w-100" onclick="tentarGeo()">
                                <i class="fas fa-map-marker-alt"></i> Localizar GPS
                            </button>
                        </div>
                    </div>

                    <h5 class="text-secondary border-bottom pb-2 mt-4 mb-3">3. Estrutura Técnica</h5>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Tipo de Infraestrutura</label>
                            <select name="infraestrutura" class="form-select">
                                <option value="INTERNA">Interna</option>
                                <option value="FACHADA">Pela Fachada</option>
                            </select>
                        </div>
                        <div class="col-md-6 d-flex align-items-center mt-4">
                            <div class="form-check form-switch fs-5">
                                <input class="form-check-input" type="checkbox" name="possui_shaft" id="possuiShaft">
                                <label class="form-check-label" for="possuiShaft">Possui Shaft ou Coluna em DG?</label>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-4 border-info">
                        <div class="card-header bg-info text-white fw-bold">
                            <i class="fas fa-calculator"></i> Calculadora de HPs
                        </div>
                        <div class="card-body">
                            <div class="row mb-3 align-items-end">
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Quantos Blocos/Torres?</label>
                                    <input type="number" id="qtd_blocos_input" class="form-control" min="1" max="20" value="1" onchange="gerarCamposBlocos()">
                                </div>
                                <div class="col-md-8 text-end text-muted">
                                    <small>Preencha os andares e aptos para calcular o total.</small>
                                </div>
                            </div>
                            
                            <div id="container_blocos" class="bg-light p-2 rounded"></div>

                            <hr>
                            <div class="row text-center">
                                <div class="col-md-6 border-end">
                                    <h4 class="text-muted">Total HPs</h4>
                                    <h2 class="text-primary fw-bold" id="display_total_hps">0</h2>
                                    <input type="hidden" name="total_hps_final" id="total_hps_final">
                                </div>
                                <div class="col-md-6">
                                    <h4 class="text-muted">Pré-Venda (10%)</h4>
                                    <h2 class="text-success fw-bold" id="display_prevenda">0</h2>
                                    <input type="hidden" name="prevenda_final" id="prevenda_final">
                                </div>
                            </div>
                        </div>
                    </div>

                    <h5 class="text-secondary border-bottom pb-2 mt-4 mb-3">4. Documentação (Upload OneDrive)</h5>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Carta de Autorização (Síndico)</label>
                            <input type="file" name="arquivo_carta" class="form-control" accept="image/*,.pdf" required>
                            <div class="form-text">Foto assinada e carimbada.</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Foto da Fachada</label>
                            <input type="file" name="arquivo_fachada" class="form-control" accept="image/*,.pdf" required>
                            <div class="form-text">Foto clara da entrada do prédio.</div>
                        </div>
                    </div>

                    <input type="hidden" name="dados_blocos_json" id="dados_blocos_json">

                    <div class="d-grid gap-2 mt-5">
                        <button type="submit" class="btn btn-success btn-lg py-3">
                            <i class="fas fa-paper-plane me-2"></i> ENVIAR SOLICITAÇÃO
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- 1. LÓGICA DE CÁLCULO DE BLOCOS ---
        function gerarCamposBlocos() {
            const qtd = document.getElementById('qtd_blocos_input').value;
            const container = document.getElementById('container_blocos');
            container.innerHTML = '';

            for (let i = 1; i <= qtd; i++) {
                const html = `
                    <div class="row g-2 align-items-end mb-2 border-bottom pb-2 bloco-row" id="bloco_${i}">
                        <div class="col-md-4">
                            <label class="small fw-bold">Nome Bloco ${i}</label>
                            <input type="text" class="form-control form-control-sm nome-bloco" value="Bloco ${i}">
                        </div>
                        <div class="col-md-3">
                            <label class="small">Andares</label>
                            <input type="number" class="form-control form-control-sm andares" oninput="calcularTotal()" min="1" value="0">
                        </div>
                        <div class="col-md-3">
                            <label class="small">Aptos/Andar</label>
                            <input type="number" class="form-control form-control-sm aptos" oninput="calcularTotal()" min="1" value="0">
                        </div>
                        <div class="col-md-2 text-end">
                            <span class="badge bg-secondary p-2 mt-3 w-100">HPs: <span class="total-bloco">0</span></span>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            }
            calcularTotal();
        }

        function calcularTotal() {
            let grandTotal = 0;
            document.querySelectorAll('.bloco-row').forEach(row => {
                const andares = row.querySelector('.andares').value || 0;
                const aptos = row.querySelector('.aptos').value || 0;
                const total = andares * aptos;
                row.querySelector('.total-bloco').innerText = total;
                grandTotal += total;
            });

            document.getElementById('display_total_hps').innerText = grandTotal;
            document.getElementById('total_hps_final').value = grandTotal;
            
            const prevenda = Math.ceil(grandTotal * 0.10);
            document.getElementById('display_prevenda').innerText = prevenda;
            document.getElementById('prevenda_final').value = prevenda;
        }

        // --- 2. LÓGICA DE CEP E GEO ---
        function buscarCep() {
            const cep = document.getElementById('cep').value.replace(/\D/g, '');
            if (cep.length === 8) {
                fetch(`https://viacep.com.br/ws/${cep}/json/`)
                    .then(res => res.json())
                    .then(data => {
                        if (!data.erro) {
                            document.getElementById('logradouro').value = data.logradouro;
                            document.getElementById('bairro').value = data.bairro;
                            document.getElementById('cidade').value = data.localidade;
                            document.getElementById('uf').value = data.uf;
                            tentarGeo();
                        } else { alert("CEP não encontrado!"); }
                    })
                    .catch(() => alert("Erro ao buscar CEP."));
            }
        }

        function tentarGeo() {
            const log = document.getElementById('logradouro').value;
            const num = document.getElementsByName('numero')[0].value || '';
            const cid = document.getElementById('cidade').value;
            const uf = document.getElementById('uf').value;
            
            if(log && cid) {
                const query = `${log}, ${num}, ${cid} - ${uf}, Brazil`;
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}&limit=1`)
                    .then(r => r.json())
                    .then(d => {
                        if(d.length > 0) {
                            document.getElementById('latitude').value = d[0].lat;
                            document.getElementById('longitude').value = d[0].lon;
                        } else { alert("GPS não localizado. Tente colocar o número da rua."); }
                    });
            } else { alert("Preencha o endereço primeiro."); }
        }

        // --- 3. LÓGICA DE ENVIO AJAX (CRUCIAL) ---
        async function enviarViaAjax(e) {
            e.preventDefault(); 
            
            // Validação de HPs
            const dadosBlocos = [];
            let temZero = false;
            document.querySelectorAll('.bloco-row').forEach(row => {
                const total = parseInt(row.querySelector('.total-bloco').innerText);
                if(total === 0) temZero = true;
                dadosBlocos.push({
                    nome: row.querySelector('.nome-bloco').value,
                    andares: row.querySelector('.andares').value,
                    aptos: row.querySelector('.aptos').value,
                    total: total
                });
            });

            if(temZero) {
                alert("Atenção: Existem blocos com 0 HPs. Preencha os andares e apartamentos.");
                return;
            }
            document.getElementById('dados_blocos_json').value = JSON.stringify(dadosBlocos);

            // UI Loading
            const btn = document.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ENVIANDO PARA NUVEM...';
            btn.disabled = true;

            // Recuperar Token
            const token = localStorage.getItem('accessToken');
            if (!token) {
                alert("Sessão expirada. Faça login novamente.");
                window.location.href = '/';
                return;
            }

            // Preparar FormData
            const form = document.getElementById('formCDOI');
            const formData = new FormData(form);

            try {
                // Envia para a API (Rota Protegida)
                const response = await fetch('/api/crm/cdoi/novo/', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}` 
                    },
                    body: formData
                });

                if (response.ok) {
                    // Sucesso
                    const htmlSucesso = `
                        <div class="alert alert-success text-center">
                            <i class="fas fa-check-circle fa-4x mb-3"></i>
                            <h4>Solicitação Enviada com Sucesso!</h4>
                            <p>Documentos salvos no OneDrive e registro criado.</p>
                            <a href="/area-interna/" class="btn btn-primary mt-3">Voltar ao Menu</a>
                            <button onclick="location.reload()" class="btn btn-outline-success mt-3 ms-2">Novo Cadastro</button>
                        </div>
                    `;
                    document.querySelector('.card-body').innerHTML = htmlSucesso;
                    window.scrollTo(0, 0);
                } else {
                    const errData = await response.json();
                    console.error("Erro API:", errData);
                    alert("Erro ao enviar: " + (errData.detail || "Erro no servidor. Verifique os campos."));
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }

            } catch (error) {
                alert("Erro de conexão: " + error.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // Inicializa
        window.onload = gerarCamposBlocos;
    </script>
</body>
</html>