{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Record Vertical - CDOI</title>
    <link rel="shortcut icon" href="{% static 'logo.png' %}" type="image/x-icon">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="{% static 'css/custom_styles.css' %}?v=13.1">
    <style>
        /* Estilos espec√≠ficos para a p√°gina CDOI */
        .card { 
            border: none; 
            border-radius: 12px; 
            box-shadow: var(--sombra-suave); 
        }
        
        .card-header { 
            background-color: var(--cor-surface); 
            border-bottom: 1px solid var(--cor-borda); 
            padding: 1rem; 
            font-weight: 600; 
            color: var(--cor-primaria); 
            border-radius: 12px 12px 0 0;
        }
        
        .status-badge { 
            font-size: 0.85rem; 
            padding: 5px 10px; 
            border-radius: 15px; 
        }
        
        .status-SEM_TRATAMENTO { 
            background-color: #e2e6ea; 
            color: #5a5c69; 
        }
        
        .status-EM_CADASTRO { 
            background-color: #fff3cd; 
            color: #856404; 
        }
        
        .status-EM_PROJETO { 
            background-color: #d1ecf1; 
            color: #0c5460; 
        }
        
        .status-EM_EXECUCAO { 
            background-color: #cce5ff; 
            color: #004085; 
        }
        
        .status-CONCLUIDA { 
            background-color: #d4edda; 
            color: #155724; 
        }
        
        .status-CANCELADA {
            background-color: #f8d7da; /* vermelho claro */
            color: #842029;
        }
        
        .status-ARQUIVADA {
            background-color: #e2e3e5; /* cinza claro */
            color: #41464b;
        }
        
        /* Tooltip de imagem ao passar o mouse */
        .image-preview-icon {
            cursor: pointer;
            font-size: 1.5rem;
            color: var(--cor-primaria);
            position: relative;
            display: inline-block;
        }
        
        .image-preview-icon:hover {
            transform: scale(1.1);
            transition: transform 0.2s;
        }
        
        .image-tooltip {
            display: none;
            position: absolute;
            z-index: 1000;
            left: 50%;
            top: -210px;
            transform: translateX(-50%);
            background: white;
            border: 3px solid var(--cor-primaria);
            border-radius: 8px;
            padding: 5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .image-preview-icon:hover .image-tooltip {
            display: block;
        }
        
        .image-tooltip img {
            width: 200px;
            height: 200px;
            object-fit: cover;
            border-radius: 4px;
        }
        
        .no-image-icon {
            color: #ccc;
            cursor: not-allowed;
        }
        
        /* Personaliza√ß√£o das abas */
        .nav-tabs .nav-link {
            color: var(--cor-texto-suave);
            font-weight: 600;
            border: none;
            border-bottom: 3px solid transparent;
        }
        
        .nav-tabs .nav-link.active {
            color: var(--cor-primaria);
            border-bottom: 3px solid var(--cor-primaria);
            background: transparent;
        }
        
        /* Ajustes para usar melhor o espa√ßo da tela */
        .system-container {
            max-width: 1400px !important;
            transition: max-width 0.3s ease;
        }

        /* Quando a aba lista est√° ativa, expande ainda mais */
        .tab-pane#lista-content.active ~ * .system-container,
        body:has(#lista-content.active) .system-container {
            max-width: 95% !important;
        }

        /* Aba Meus Acionamentos - Expans√£o correta */
        #lista-content {
            width: 100%;
            padding: 0;
        }

        #lista-content .card {
            width: 100%;
            margin: 0;
            border-radius: 12px;
        }
        
        /* For√ßa largura m√≠nima da tabela em telas grandes */
        @media (min-width: 1200px) {
            #lista-content .table {
                min-width: auto;
                font-size: 0.9rem;
            }
            
            #lista-content .card {
                box-shadow: var(--sombra-media);
            }
        }
        
        /* CORRE√á√ÉO ESPEC√çFICA PARA TABELA CDOI - For√ßa comportamento desktop sempre */
        #lista-content .table-responsive {
            overflow-x: visible;
            width: 100%;
        }
        
        #lista-content .table-responsive thead {
            display: table-header-group !important;
        }

        #lista-content .table {
            width: 100%;
            min-width: auto;
            margin-bottom: 0;
            font-size: 0.9rem;
        }

        #lista-content .table th,
        #lista-content .table td {
            padding: 8px 10px;
            vertical-align: middle;
            white-space: nowrap;
        }
        
        /* Colunas espec√≠ficas podem quebrar linha e s√£o mais largas */
        #lista-content .table td:nth-child(2),
        #lista-content .table td:nth-child(3) {
            white-space: normal;
            max-width: 200px;
            min-width: 150px;
        }
        
        /* Colunas de badges e √≠cones mais estreitas */
        #lista-content .table th:nth-child(6),
        #lista-content .table th:nth-child(7),
        #lista-content .table th:nth-child(8),
        #lista-content .table td:nth-child(6),
        #lista-content .table td:nth-child(7),
        #lista-content .table td:nth-child(8) {
            width: 80px;
            text-align: center;
        }
        
        /* Coluna de telefone pode ser mais estreita */
        #lista-content .table th:nth-child(5),
        #lista-content .table td:nth-child(5) {
            width: 120px;
        }
        
        /* Coluna ID mais estreita */
        #lista-content .table th:nth-child(1),
        #lista-content .table td:nth-child(1) {
            width: 50px;
        }

        #lista-content .table th {
            background-color: var(--cor-surface);
            font-weight: 600;
            color: var(--cor-primaria);
            border-bottom: 2px solid var(--cor-borda);
        }

        #lista-content .table tbody tr {
            border-bottom: 1px solid var(--cor-borda);
            transition: background-color 0.2s;
        }

        #lista-content .table tbody tr:hover {
            background-color: var(--cor-surface);
        }

        #lista-content .card {
            width: 100%;
        }

        #lista-content .card-body {
            padding: 0 !important;
            overflow-x: visible;
            overflow-y: visible;
            display: block;
            width: 100%;
        }

        #lista-content .card-body.table-responsive {
            display: block;
            width: 100%;
            padding: 0 !important;
            overflow: visible;
        }

        /* Garante expans√£o adequada em telas grandes */
        @media (min-width: 1200px) {
            #lista-content .table {
                font-size: 0.95rem;
            }

            #lista-content .card-body {
                overflow-x: auto;
            }
            
            .system-container {
                max-width: 95% !important;
            }
        }
        
        #lista-content .table-responsive tbody tr {
            display: table-row !important;
            margin-bottom: 0 !important;
            background-color: transparent !important;
            border: none !important;
            border-radius: 0 !important;
            box-shadow: none !important;
            padding: 0 !important;
        }
        
        #lista-content .table-responsive tbody td {
            display: table-cell !important;
            border-bottom: 1px solid var(--cor-borda) !important;
            padding: 1rem 0.75rem !important;
            text-align: left !important;
            justify-content: flex-start !important;
            align-items: center !important;
        }
        
        #lista-content .table-responsive tbody td::before {
            display: none !important;
            content: none !important;
        }
        
        #lista-content .table-responsive tbody td:last-child {
            border-bottom: 1px solid var(--cor-borda) !important;
            text-align: right !important;
        }

        /* Extra: for√ßa tabela cl√°ssica tamb√©m para .table dentro de #lista-content */
        #lista-content .table thead { display: table-header-group !important; }
        #lista-content .table tbody tr {
            display: table-row !important;
            margin-bottom: 0 !important;
            background-color: transparent !important;
            border: none !important;
            border-radius: 0 !important;
            box-shadow: none !important;
            padding: 0 !important;
        }
        #lista-content .table tbody td {
            display: table-cell !important;
            border-bottom: 1px solid var(--cor-borda) !important;
            padding: 1rem 0.75rem !important;
            text-align: left !important;
            justify-content: flex-start !important;
            align-items: center !important;
        }
        #lista-content .table tbody td::before { display: none !important; }
        
        /* Garante que a tabela n√£o vire cards em desktop */
        @media (min-width: 769px) {
            .table-responsive {
                font-size: 0.95rem;
            }
            
            .table-responsive th,
            .table-responsive td {
                padding: 1rem 0.75rem;
                vertical-align: middle;
            }
            
            /* For√ßa comportamento de tabela normal em desktop */
            .table-responsive thead { display: table-header-group !important; }
            .table-responsive tbody tr { display: table-row !important; }
            .table-responsive tbody td { 
                display: table-cell !important; 
                border-bottom: 1px solid var(--cor-borda) !important;
                padding: 1rem 0.75rem !important;
            }
            .table-responsive tbody td::before { display: none !important; }
        }
        
        /* Melhora a apar√™ncia da tabela */
        .table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: var(--cor-texto);
            border-bottom: 2px solid var(--cor-borda);
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(13, 110, 253, 0.05);
        }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="header-container">
            <a href="/"><img src="{% static 'logo.png' %}" alt="Record PAP Logo" class="logo"></a>
            <button class="menu-toggle" id="menu-toggle"><div class="bar"></div><div class="bar"></div><div class="bar"></div></button>
            <nav class="main-nav" id="main-nav">
                <ul>
                    <li><a href="/area-interna/">Voltar</a></li>
                    <li><button onclick="logout()" class="nav-button logout-button">Sair</button></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="area-interna-section">
        <div class="system-container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 style="font-size: 1.8rem; margin: 0;"><i class="fa-solid fa-building text-primary"></i> Gest√£o CDOI</h1>
                    <p class="text-muted mb-0">Solicita√ß√µes e acionamentos para condom√≠nios.</p>
                </div>
            </div>

            <ul class="nav nav-tabs mb-4" id="cdoiTabs" role="tablist">
                <li class="nav-item"><button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard-content" type="button" onclick="carregarDashboardCdoi()"><i class="bi bi-speedometer2"></i> Dashboard</button></li>
                <li class="nav-item"><button class="nav-link" id="nova-tab" data-bs-toggle="tab" data-bs-target="#nova-content" type="button"><i class="bi bi-plus-circle"></i> <span id="tab-titulo">Nova Solicita√ß√£o</span></button></li>
                {% if can_config %}
                <li class="nav-item"><button class="nav-link" id="config-tab" data-bs-toggle="tab" data-bs-target="#config-content" type="button" onclick="carregarConfiguracaoCdoi()"><i class="bi bi-gear"></i> Configura√ß√£o</button></li>
                {% endif %}
                <li class="nav-item"><button class="nav-link" id="lista-tab" data-bs-toggle="tab" data-bs-target="#lista-content" type="button" onclick="carregarMeusAcionamentos()"><i class="bi bi-list-ul"></i> Meus Acionamentos</button></li>
            </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="dashboard-content">
            <div class="card">
                <div class="card-header d-flex justify-content-between">
                    <span>Dashboard CDOI</span>
                    <button class="btn btn-sm btn-outline-primary" onclick="carregarDashboardCdoi()">
                        <i class="bi bi-arrow-clockwise"></i> Atualizar
                    </button>
                </div>
                <div class="card-body">
                    <div class="row g-3" id="dashboard-cards">
                        <!-- Cards ser√£o preenchidos via JS -->
                    </div>
                    <hr>
                    <div id="dashboard-status" class="table-responsive"></div>
                </div>
            </div>
        </div>
        {% if can_config %}
        <div class="tab-pane fade" id="config-content">
            <div class="card">
                <div class="card-header d-flex justify-content-between">
                    <span>Configura√ß√£o de Resumo (WhatsApp)</span>
                    <button class="btn btn-sm btn-outline-primary" onclick="carregarConfiguracaoCdoi()">
                        <i class="bi bi-arrow-clockwise"></i> Atualizar
                    </button>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="inp_config_destinatarios" class="form-label">Destinat√°rios padr√£o do resumo</label>
                        <input type="text" id="inp_config_destinatarios" class="form-control" placeholder="Ex: 31999999999, 31988888888">
                        <small class="text-muted">Informe n√∫meros com DDD, separados por v√≠rgula.</small>
                    </div>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="inp_config_ativo" checked>
                        <label class="form-check-label" for="inp_config_ativo">Ativar envio para destinat√°rios padr√£o</label>
                    </div>
                    <button class="btn btn-primary" type="button" onclick="salvarConfiguracaoCdoi()">
                        <i class="bi bi-save"></i> Salvar configura√ß√£o
                    </button>
                    <div id="config-feedback" class="form-text mt-2"></div>
                </div>
            </div>
        </div>
        {% endif %}
        <div class="tab-pane fade" id="nova-content">
            <div class="card">
                <div class="card-header d-flex justify-content-between">
                    <span>Dados do Condom√≠nio</span>
                    <button id="btn-cancelar-edicao" class="btn btn-sm btn-outline-danger d-none" onclick="cancelarEdicao()">Cancelar Edi√ß√£o</button>
                </div>
                <div class="card-body">
                    <form id="form-cdoi">
                        <input type="hidden" id="edit_mode_id" value="">
                        <div id="div-criado-por" class="row g-3 mb-4" style="display: none;">
                            <div class="col-md-12">
                                <label>Acionado por (Quem criou) *</label>
                                <select name="criado_por_id" id="inp_criado_por" class="form-select" required>
                                    <option value="">Carregando usu√°rios...</option>
                                </select>
                                <small class="text-muted">Selecione quem acionou esta solicita√ß√£o</small>
                            </div>
                        </div>
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label>Nome do Condom√≠nio *</label>
                                <div class="input-group">
                                    <input type="text" name="nome_condominio" id="inp_nome" class="form-control" required>
                                    <button type="button" class="btn btn-outline-secondary" onclick="copiarCampo('inp_nome')" title="Copiar nome do condom√≠nio">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label>CEP *</label>
                                <div class="input-group">
                                    <input type="text" name="cep" id="inp_cep" class="form-control" required onblur="buscarCep(this.value)">
                                    <button type="button" class="btn btn-outline-secondary" onclick="copiarCampo('inp_cep')" title="Copiar CEP">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label>Cidade/UF</label>
                                <div class="input-group">
                                    <input type="text" id="cidade_uf" class="form-control bg-light" readonly>
                                    <button type="button" class="btn btn-outline-secondary" onclick="copiarCampo('cidade_uf')" title="Copiar cidade/UF">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                                <input type="hidden" name="cidade" id="cidade">
                                <input type="hidden" name="uf" id="uf">
                            </div>
                            <div class="col-md-5">
                                <label>Logradouro</label>
                                <div class="input-group">
                                    <input type="text" name="logradouro" id="logradouro" class="form-control bg-light" readonly>
                                    <button type="button" class="btn btn-outline-secondary" onclick="copiarCampo('logradouro')" title="Copiar logradouro">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <label>N√∫mero *</label>
                                <div class="input-group">
                                    <input type="text" name="numero" id="inp_numero" class="form-control" required onblur="buscarCoordenadas()" oninput="debounceBuscarCoordenadas()">
                                    <button type="button" class="btn btn-outline-secondary" onclick="copiarCampo('inp_numero')" title="Copiar n√∫mero">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-5">
                                <label>Bairro</label>
                                <div class="input-group">
                                    <input type="text" name="bairro" id="bairro" class="form-control bg-light" readonly>
                                    <button type="button" class="btn btn-outline-secondary" onclick="copiarCampo('bairro')" title="Copiar bairro">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label>Latitude</label>
                                <div class="input-group">
                                    <input type="text" name="latitude" id="inp_lat" class="form-control" readonly>
                                    <button type="button" class="btn btn-outline-secondary" onclick="copiarCoordenada('lat')" title="Copiar latitude">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                                <small class="text-muted">Preenchido automaticamente</small>
                            </div>
                            <div class="col-md-3">
                                <label>Longitude</label>
                                <div class="input-group">
                                    <input type="text" name="longitude" id="inp_long" class="form-control" readonly>
                                    <button type="button" class="btn btn-outline-secondary" onclick="copiarCoordenada('long')" title="Copiar longitude">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                                <small class="text-muted">Preenchido automaticamente</small>
                            </div>
                        </div>

                        <h6 class="text-primary fw-bold mb-3 border-bottom pb-2 d-flex justify-content-between align-items-center">
                            <span>Contato e S√≠ndico</span>
                        </h6>
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label>Nome do S√≠ndico *</label>
                                <div class="input-group">
                                    <input type="text" name="nome_sindico" id="inp_sindico" class="form-control" required>
                                    <button type="button" class="btn btn-outline-secondary" onclick="copiarCampo('inp_sindico')" title="Copiar nome do s√≠ndico">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label>Contato (WhatsApp) *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-whatsapp"></i></span>
                                    <input type="text" name="contato" id="inp_contato" class="form-control" required onblur="validarWhatsapp(this)">
                                    <button type="button" class="btn btn-outline-secondary" onclick="copiarCampo('inp_contato')" title="Copiar contato">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                                <div id="zap-feedback" class="form-text"></div>
                            </div>
                            <div class="col-md-6 file-input-group"><label>Carta S√≠ndico *</label><input type="file" name="arquivo_carta" class="form-control" accept=".pdf,.jpg" required></div>
                            <div class="col-md-6 file-input-group"><label>Fotos Fachada *</label><input type="file" name="arquivo_fachada" class="form-control" accept="image/*" multiple required></div>
                            
                        </div>

                        <h6 class="text-primary fw-bold mb-3 border-bottom pb-2">Dados T√©cnicos</h6>
                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <label>Infraestrutura</label>
                                <select name="infraestrutura" id="inp_infra" class="form-select">
                                    <option value="SUBTERRANEA">Subterr√¢nea</option>
                                    <option value="AEREA">A√©rea (Poste)</option>
                                    <option value="MISTA">Mista</option>
                                </select>
                            </div>
                            <div class="col-md-4 pt-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="possui_shaft" id="inp_shaft">
                                    <label class="form-check-label fw-bold" for="inp_shaft">Possui Shaft / DG?</label>
                                </div>
                            </div>
                        </div>

                        <!-- Blocos Cadastrados (apenas em modo edi√ß√£o) -->
                        <div id="resumo-blocos-cadastrados" class="card bg-info bg-opacity-10 border-info mb-4" style="display: none;">
                            <div class="card-body">
                                <h6 class="fw-bold text-info mb-3">
                                    <i class="bi bi-building"></i> Blocos Cadastrados
                                </h6>
                                <div class="row g-2 align-items-end mb-2">
                                    <div class="col-md-3"><input type="text" id="edit_bloco_nome" class="form-control form-control-sm" placeholder="Nome Bloco"></div>
                                    <div class="col-md-3"><input type="number" id="edit_bloco_andares" class="form-control form-control-sm" placeholder="Andares"></div>
                                    <div class="col-md-3"><input type="number" id="edit_bloco_aptos" class="form-control form-control-sm" placeholder="Aptos/Andar"></div>
                                    <div class="col-md-3"><button type="button" id="btn-bloco-salvar" class="btn btn-secondary btn-sm w-100" onclick="salvarBlocoEditado()">Adicionar</button></div>
                                </div>
                                <table class="table table-sm mb-0 bg-white text-center rounded border">
                                    <thead class="table-info"><tr><th>Bloco</th><th>Andares</th><th>Aptos/Andar</th><th>Total HPs</th><th>A√ß√µes</th></tr></thead>
                                    <tbody id="lista-blocos-cadastrados"></tbody>
                                    <tfoot class="table-light">
                                        <tr><td colspan="3" class="text-end fw-bold">Total Geral:</td><td id="total-hps-geral-edit" class="fw-bold">0</td><td></td></tr>
                                        <tr><td colspan="3" class="text-end text-primary fw-bold">Pr√©-venda (10%):</td><td id="prevenda-calc-edit" class="text-primary fw-bold">0</td><td></td></tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>

                        <div id="estrutura-blocos-novo" class="card bg-light border-0 mb-4">
                            <div class="card-body">
                                <h6 class="fw-bold">Estrutura de Blocos</h6>
                                <div class="row g-2 align-items-end mb-2">
                                    <div class="col-md-3"><input type="text" id="temp_bloco" class="form-control form-control-sm" placeholder="Nome Bloco"></div>
                                    <div class="col-md-3"><input type="number" id="temp_andares" class="form-control form-control-sm" placeholder="Andares"></div>
                                    <div class="col-md-3"><input type="number" id="temp_aptos" class="form-control form-control-sm" placeholder="Aptos/Andar"></div>
                                    <div class="col-md-3"><button type="button" class="btn btn-secondary btn-sm w-100" onclick="addBloco()">Adicionar</button></div>
                                </div>
                                <table class="table table-sm mb-0 bg-white text-center rounded border">
                                    <thead class="table-light"><tr><th>Bloco</th><th>Andares</th><th>Aptos/Andar</th><th>Total HPs</th><th>A√ß√£o</th></tr></thead>
                                    <tbody id="lista-blocos"></tbody>
                                    <tfoot class="table-light">
                                        <tr><td colspan="3" class="text-end fw-bold">Total Geral:</td><td id="total-hps-geral" class="fw-bold">0</td><td></td></tr>
                                        <tr><td colspan="3" class="text-end text-primary fw-bold">Pr√©-venda (10%):</td><td id="prevenda-calc" class="text-primary fw-bold">0</td><td></td></tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>

                        <input type="hidden" name="total_hps_final" id="input_total_hps">
                        <input type="hidden" name="prevenda_final" id="input_prevenda">
                        <input type="hidden" name="dados_blocos_json" id="input_blocos_json">

                        <div id="resumoEnvio" class="alert alert-info d-none">
                            <strong>Resumo enviado:</strong>
                            <pre id="resumoEnvioTexto" class="mb-0" style="white-space: pre-wrap;"></pre>
                        </div>
                        <div class="d-grid">
                            <button type="button" id="btn-submit" class="btn btn-success btn-lg" onclick="enviarFormulario(this)">
                                <i class="bi bi-send-fill"></i> Enviar Solicita√ß√£o
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="lista-content">
            <div class="card">
                <div class="card-header bg-white d-flex justify-content-between">
                    <h5 class="m-0 text-primary">Hist√≥rico</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="carregarMeusAcionamentos()"><i class="bi bi-arrow-clockwise"></i> Atualizar</button>
                </div>
                <div class="card-body p-0 table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light"><tr><th>ID</th><th>Condom√≠nio</th><th>Endere√ßo</th><th>S√≠ndico</th><th>Telefone</th><th>Total HPs</th><th>Pr√©-vendas</th><th>Foto Fachada</th><th>Foto Autoriza√ß√£o</th><th>Status</th><th>Acionado por</th><th>A√ß√µes</th></tr></thead>
                        <tbody id="tbody-acionamentos"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalStatus" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Atualizar Status</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="st-id"><label>Novo Status</label><select id="st-val" class="form-select mb-2"><option value="SEM_TRATAMENTO">Sem tratamento</option><option value="EM_CADASTRO">Em cadastro</option><option value="EM_PROJETO">Em Projeto</option><option value="EM_EXECUCAO">Em Execu√ß√£o</option><option value="CONCLUIDA">Conclu√≠da</option><option value="CANCELADA">Cancelada</option><option value="ARQUIVADA">Arquivada</option></select><label>Obs</label><textarea id="st-obs" class="form-control"></textarea></div><div class="modal-footer"><button onclick="salvarStatus()" class="btn btn-primary">Salvar</button></div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="{% static 'js/auth.js' %}?v=7.0"></script>
<script src="{% static 'js/menu.js' %}?v=7.0"></script>
<script>
    let blocos = [];
    let blocoEditIndex = null;
    let regraCdoiConfig = null;

    // --- BLOCOS E PR√â-VENDA ---
    function addBloco() {
        const nome = document.getElementById('temp_bloco').value;
        const andares = parseInt(document.getElementById('temp_andares').value) || 0;
        const aptos = parseInt(document.getElementById('temp_aptos').value) || 0;
        if(!nome || andares <= 0) return;
        
        blocos.push({ nome, andares, aptos, total: andares * aptos });
        atualizarTabelaBlocos();
        document.getElementById('temp_bloco').value = '';
        document.getElementById('temp_andares').value = '';
        document.getElementById('temp_aptos').value = '';
    }

    function atualizarTabelaBlocos() {
        const tbody = document.getElementById('lista-blocos');
        const tbodyEdit = document.getElementById('lista-blocos-cadastrados');
        if (tbody) tbody.innerHTML = '';
        if (tbodyEdit) tbodyEdit.innerHTML = '';
        let total = 0;
        blocos.forEach((b, i) => {
            total += b.total;
            if (tbody) {
                tbody.innerHTML += `<tr><td>${b.nome}</td><td>${b.andares}</td><td>${b.aptos}</td><td>${b.total}</td><td><i class="bi bi-trash text-danger" onclick="removerBloco(${i})"></i></td></tr>`;
            }
            if (tbodyEdit) {
                tbodyEdit.innerHTML += `<tr><td>${b.nome}</td><td>${b.andares}</td><td>${b.aptos}</td><td>${b.total}</td><td><i class="bi bi-pencil-square text-primary me-2" onclick="editarBloco(${i})"></i><i class="bi bi-trash text-danger" onclick="removerBloco(${i})"></i></td></tr>`;
            }
        });
        
        // C√ÅLCULO DE PR√â-VENDA (30%)
        const prevenda = Math.ceil(total * 0.1);
        
        const totalHpsEl = document.getElementById('total-hps-geral');
        const prevendaEl = document.getElementById('prevenda-calc');
        const totalHpsEditEl = document.getElementById('total-hps-geral-edit');
        const prevendaEditEl = document.getElementById('prevenda-calc-edit');
        if (totalHpsEl) totalHpsEl.innerText = total;
        if (prevendaEl) prevendaEl.innerText = prevenda;
        if (totalHpsEditEl) totalHpsEditEl.innerText = total;
        if (prevendaEditEl) prevendaEditEl.innerText = prevenda;
        document.getElementById('input_total_hps').value = total;
        document.getElementById('input_prevenda').value = prevenda;
        document.getElementById('input_blocos_json').value = JSON.stringify(blocos);
    }

    function setModoEdicaoBlocos(isEdit) {
        const resumo = document.getElementById('resumo-blocos-cadastrados');
        const estrutura = document.getElementById('estrutura-blocos-novo');
        if (resumo) resumo.style.display = isEdit ? 'block' : 'none';
        if (estrutura) estrutura.style.display = isEdit ? 'none' : 'block';
        if (!isEdit) {
            blocoEditIndex = null;
            limparInputsEdicaoBloco();
            const btnSalvar = document.getElementById('btn-bloco-salvar');
            if (btnSalvar) btnSalvar.innerText = 'Adicionar';
        }
    }

    function limparInputsEdicaoBloco() {
        const nome = document.getElementById('edit_bloco_nome');
        const andares = document.getElementById('edit_bloco_andares');
        const aptos = document.getElementById('edit_bloco_aptos');
        if (nome) nome.value = '';
        if (andares) andares.value = '';
        if (aptos) aptos.value = '';
    }

    function salvarBlocoEditado() {
        const nome = (document.getElementById('edit_bloco_nome').value || '').trim();
        const andares = parseInt(document.getElementById('edit_bloco_andares').value) || 0;
        const aptos = parseInt(document.getElementById('edit_bloco_aptos').value) || 0;
        if (!nome || andares <= 0) return;

        const total = andares * aptos;
        if (blocoEditIndex !== null && blocos[blocoEditIndex]) {
            blocos[blocoEditIndex] = { nome, andares, aptos, total };
        } else {
            blocos.push({ nome, andares, aptos, total });
        }
        blocoEditIndex = null;
        limparInputsEdicaoBloco();
        const btnSalvar = document.getElementById('btn-bloco-salvar');
        if (btnSalvar) btnSalvar.innerText = 'Adicionar';
        atualizarTabelaBlocos();
    }

    function editarBloco(index) {
        const bloco = blocos[index];
        if (!bloco) return;
        blocoEditIndex = index;
        document.getElementById('edit_bloco_nome').value = bloco.nome;
        document.getElementById('edit_bloco_andares').value = bloco.andares;
        document.getElementById('edit_bloco_aptos').value = bloco.aptos;
        const btnSalvar = document.getElementById('btn-bloco-salvar');
        if (btnSalvar) btnSalvar.innerText = 'Salvar edi√ß√£o';
    }

    function removerBloco(index) {
        blocos.splice(index, 1);
        atualizarTabelaBlocos();
    }

    // --- VALIDA√á√ÉO WHATSAPP ---
    async function validarWhatsapp(input) {
        const feedback = document.getElementById('zap-feedback');
        const num = input.value.replace(/\D/g, '');
        if (num.length < 10) return;
        
        feedback.innerText = "Verificando...";
        try {
            const token = localStorage.getItem('accessToken');
            const res = await fetch(`/api/crm/whatsapp/verificar/?numero=${num}`, { headers: {'Authorization': `Bearer ${token}`} });
            const data = await res.json();
            if (data.exists) {
                input.classList.add('is-valid'); input.classList.remove('is-invalid');
                feedback.innerText = "WhatsApp V√°lido ‚úÖ"; feedback.className = "form-text text-success fw-bold";
            } else {
                input.classList.add('is-invalid'); input.classList.remove('is-valid');
                feedback.innerText = "Sem WhatsApp ‚ùå"; feedback.className = "form-text text-danger fw-bold";
            }
        } catch(e) { feedback.innerText = "Erro ao validar."; }
    }

    // --- CRUD ---
    async function carregarMeusAcionamentos() {
        const tbody = document.getElementById('tbody-acionamentos');
        tbody.innerHTML = '<tr><td colspan="12">Carregando...</td></tr>';
        const res = await fetch('/api/crm/cdoi/listar/', { headers: {'Authorization': `Bearer ${localStorage.getItem('accessToken')}`} });
        const lista = await res.json();
        tbody.innerHTML = '';
        lista.forEach(i => {
            let btns = '';
            btns += `<button class="btn btn-sm btn-editar me-1" onclick='editarTudo(${i.id})'>‚úèÔ∏è Editar</button>`;
            if (i.can_edit) btns += `<button class="btn btn-sm btn-outline-info me-1" onclick='modalStatus(${i.id}, "${i.status_cod}", "${i.observacao}")'>üîÑ Status</button>`;
            btns += `<button class="btn btn-sm btn-excluir" onclick='excluir(${i.id})'>üóëÔ∏è</button>`;
            
            const endereco = `${i.logradouro || ''}, ${i.numero || ''} - ${i.bairro || ''}`;
            const telefone = i.contato || '-';
            const sindico = i.nome_sindico || '-';
            const totalHps = i.total_hps || 0;
            const prevenda = i.prevenda || 0;
            
            // Fun√ß√£o helper para criar HTML de imagem
            function criarImagemHtml(link, alt) {
                if (link) {
                    return `
                        <span class="image-preview-icon" onclick="window.open('${link}', '_blank')">
                            <i class="bi bi-image"></i>
                            <div class="image-tooltip">
                                <img src="${link}" alt="${alt}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'200\'%3E%3Crect fill=\'%23ddd\' width=\'200\' height=\'200\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' dominant-baseline=\'middle\' text-anchor=\'middle\' font-family=\'sans-serif\' font-size=\'16\' fill=\'%23999\'%3ESem imagem%3C/text%3E%3C/svg%3E'">
                            </div>
                        </span>
                    `;
                } else {
                    return '<i class="bi bi-image no-image-icon"></i>';
                }
            }
            
            const fotoFachadaHtml = criarImagemHtml(i.link_fotos_fachada, 'Foto Fachada');
            const fotoAutorizacaoHtml = criarImagemHtml(i.link_carta_sindico, 'Foto Autoriza√ß√£o');
            const acionadoPor = i.criado_por_nome || '-';
            
            tbody.innerHTML += `<tr>
                <td>#${i.id}</td>
                <td><strong>${i.nome}</strong><br><small class="text-muted">${i.cidade}</small></td>
                <td><small>${endereco}</small></td>
                <td>${sindico}</td>
                <td>${telefone}</td>
                <td class="text-center"><span class="badge bg-primary">${totalHps}</span></td>
                <td class="text-center"><span class="badge bg-success">${prevenda}</span></td>
                <td class="text-center">${fotoFachadaHtml}</td>
                <td class="text-center">${fotoAutorizacaoHtml}</td>
                <td><span class="badge status-badge status-${i.status_cod}">${i.status}</span></td>
                <td><small>${acionadoPor}</small></td>
                <td class="text-end">${btns}</td>
            </tr>`;
        });
    }

    async function carregarUsuariosParaSelect() {
        const select = document.getElementById('inp_criado_por');
        if (!select) return;
        
        // Verifica se j√° foi carregado
        if (select.options.length > 1 && select.options[0].value !== '') {
            return; // J√° carregado
        }
        
        try {
            const token = localStorage.getItem('accessToken');
            let todosUsuarios = [];
            let totalEsperado = null;
            
            // Primeiro, tentar carregar todos de uma vez (API pode n√£o paginar)
            try {
                const resGrande = await fetch('/api/usuarios/?is_active=true&page_size=50000', {
                    headers: {'Authorization': `Bearer ${token}`}
                });
                
                if (resGrande.ok) {
                    const dataGrande = await resGrande.json();
                    
                    // Verificar se √© array direto ou objeto paginado
                    if (Array.isArray(dataGrande)) {
                        todosUsuarios = dataGrande;
                        totalEsperado = dataGrande.length;
                        console.log(`[CDOI] API retornou array direto: ${todosUsuarios.length} usu√°rios`);
                    } else if (dataGrande.results) {
                        // √â objeto paginado
                        todosUsuarios = dataGrande.results;
                        totalEsperado = dataGrande.count || dataGrande.results.length;
                        console.log(`[CDOI] API retornou objeto paginado: ${todosUsuarios.length} de ${totalEsperado} usu√°rios`);
                        
                        // Se h√° mais p√°ginas, continuar carregando
                        if (dataGrande.next && todosUsuarios.length < totalEsperado) {
                            console.log(`[CDOI] H√° mais p√°ginas, continuando carregamento...`);
                        }
                    }
                }
            } catch (e) {
                console.warn('[CDOI] Erro ao carregar com page_size grande:', e);
            }
            
            // Se a API usa pagina√ß√£o ou se n√£o carregou todos, tentar com pagina√ß√£o expl√≠cita
            if (totalEsperado && todosUsuarios.length < totalEsperado) {
                console.log(`[CDOI] Carregando p√°ginas restantes via pagina√ß√£o...`);
                let page = 2; // Come√ßar da p√°gina 2 (j√° carregamos a 1)
                let hasMore = true;
                
                while (hasMore && todosUsuarios.length < totalEsperado) {
                    try {
                        const res = await fetch(`/api/usuarios/?is_active=true&page=${page}&page_size=100`, {
                            headers: {'Authorization': `Bearer ${token}`}
                        });
                        
                        if (!res.ok) {
                            console.warn(`[CDOI] Erro HTTP ${res.status} na p√°gina ${page}`);
                            hasMore = false;
                            break;
                        }
                        
                        const data = await res.json();
                        const usuarios = Array.isArray(data) ? data : (data.results || []);
                        
                        if (usuarios.length === 0) {
                            hasMore = false;
                            break;
                        }
                        
                        todosUsuarios = todosUsuarios.concat(usuarios);
                        console.log(`[CDOI] P√°gina ${page}: ${usuarios.length} usu√°rios (total: ${todosUsuarios.length})`);
                        
                        // Verificar se h√° pr√≥xima p√°gina
                        if (Array.isArray(data)) {
                            hasMore = false;
                        } else if (data.next) {
                            hasMore = data.next !== null && data.next !== undefined;
                            page++;
                        } else {
                            hasMore = false;
                        }
                        
                        // Limite de seguran√ßa
                        if (page > 200) {
                            console.warn('[CDOI] Limite de p√°ginas atingido');
                            hasMore = false;
                        }
                    } catch (e) {
                        console.error(`[CDOI] Erro ao carregar p√°gina ${page}:`, e);
                        hasMore = false;
                    }
                }
            } else if (todosUsuarios.length === 0) {
                // Se n√£o conseguiu carregar nada, tentar sem filtro is_active
                console.log('[CDOI] Tentando carregar sem filtro is_active...');
                try {
                    const resSemFiltro = await fetch('/api/usuarios/?page_size=50000', {
                        headers: {'Authorization': `Bearer ${token}`}
                    });
                    
                    if (resSemFiltro.ok) {
                        const dataSemFiltro = await resSemFiltro.json();
                        const usuariosSemFiltro = Array.isArray(dataSemFiltro) ? dataSemFiltro : (dataSemFiltro.results || []);
                        
                        // Filtrar apenas ativos no frontend
                        todosUsuarios = usuariosSemFiltro.filter(u => u.is_active === true);
                        console.log(`[CDOI] Carregados ${todosUsuarios.length} usu√°rios ativos (de ${usuariosSemFiltro.length} total)`);
                    }
                } catch (e) {
                    console.error('[CDOI] Erro ao carregar sem filtro:', e);
                }
            }
            
            // Remover duplicatas (caso tenha carregado o mesmo usu√°rio mais de uma vez)
            const usuariosUnicos = [];
            const idsVistos = new Set();
            todosUsuarios.forEach(u => {
                if (u.id && !idsVistos.has(u.id)) {
                    idsVistos.add(u.id);
                    usuariosUnicos.push(u);
                }
            });
            todosUsuarios = usuariosUnicos;
            
            console.log(`[CDOI] Total de usu√°rios √∫nicos carregados: ${todosUsuarios.length}`);
            
            if (todosUsuarios.length === 0) {
                console.error('[CDOI] NENHUM usu√°rio foi carregado! Verifique a API.');
                select.innerHTML = '<option value="">Erro: Nenhum usu√°rio encontrado</option>';
                return;
            }
            
            // Ordenar por username
            todosUsuarios.sort((a, b) => {
                const usernameA = (a.username || '').toLowerCase();
                const usernameB = (b.username || '').toLowerCase();
                return usernameA.localeCompare(usernameB);
            });
            
            select.innerHTML = '<option value="">Selecione quem acionou...</option>';
            todosUsuarios.forEach(u => {
                // Mostrar apenas o username
                const username = u.username || `ID: ${u.id}`;
                select.add(new Option(username, u.id));
            });
            
            console.log(`[CDOI] ${todosUsuarios.length} usu√°rios adicionados ao select com sucesso`);
        } catch (e) {
            console.error('[CDOI] Erro ao carregar usu√°rios:', e);
            select.innerHTML = '<option value="">Erro ao carregar usu√°rios</option>';
        }
    }
    
    function editarTudo(item) {
        const id = item; // Agora 'item' √© apenas o ID
        
        // Mostra o campo "Acionado por" no modo edi√ß√£o
        document.getElementById('div-criado-por').style.display = 'block';
        
        // Carrega usu√°rios para o select
        carregarUsuariosParaSelect();
        
        fetch(`/api/crm/cdoi/editar/${id}/`, { headers: {'Authorization': `Bearer ${localStorage.getItem('accessToken')}`} })
            .then(res => {
                if (!res.ok) throw new Error('N√£o foi poss√≠vel carregar os dados para edi√ß√£o.');
                return res.json();
            })
            .then(async d => {
                document.getElementById('edit_mode_id').value = d.id;
                document.getElementById('tab-titulo').innerText = `Editando #${d.id}`;
                document.getElementById('btn-submit').innerHTML = 'Salvar Altera√ß√µes';
                document.getElementById('btn-submit').classList.replace('btn-success', 'btn-warning');
                document.getElementById('btn-cancelar-edicao').classList.remove('d-none');
                
                // Mostra campos de arquivo no modo edi√ß√£o (mas torn√°-los opcionais)
                document.querySelectorAll('.file-input-group').forEach(el => el.style.display = 'block');
                document.querySelectorAll('.file-input-group input').forEach(el => el.required = false);
                
                // Atualiza labels para indicar que √© opcional em edi√ß√£o
                document.querySelectorAll('.file-input-group label').forEach(label => {
                    const text = label.textContent;
                    if (!text.includes('(Opcional)')) {
                        label.textContent = text.replace('*', '') + ' (Opcional)';
                    }
                });

                document.getElementById('inp_nome').value = d.nome_condominio;
                document.getElementById('inp_cep').value = d.cep;
                document.getElementById('inp_numero').value = d.numero;
                document.getElementById('inp_sindico').value = d.nome_sindico;
                document.getElementById('inp_contato').value = d.contato;
                document.getElementById('inp_infra').value = d.infraestrutura;
                document.getElementById('inp_shaft').checked = d.possui_shaft;
                document.getElementById('inp_lat').value = d.latitude || '';
                document.getElementById('inp_long').value = d.longitude || '';
                
                // Aguarda o select ser populado antes de definir o valor
                await carregarUsuariosParaSelect();
                if (d.criado_por_id) {
                    document.getElementById('inp_criado_por').value = d.criado_por_id;
                }
                
                buscarCep(d.cep);

                // Debug: verificar blocos retornados
                console.log('[CDOI] Blocos retornados pela API:', d.blocos);
                
                blocos = d.blocos.map(b => ({ nome: b.nome, andares: b.andares, aptos: b.aptos, total: b.total }));
                setModoEdicaoBlocos(true);
                atualizarTabelaBlocos();
                
                new bootstrap.Tab(document.querySelector('#nova-tab')).show();
            })
            .catch(error => {
                alert(error.message);
                console.error("Erro ao editar:", error);
            });
    }

    function cancelarEdicao() {
        document.getElementById('form-cdoi').reset();
        document.getElementById('edit_mode_id').value = '';
        document.getElementById('tab-titulo').innerText = 'Nova Solicita√ß√£o';
        document.getElementById('btn-submit').innerHTML = '<i class="bi bi-send-fill"></i> Enviar Solicita√ß√£o';
        document.getElementById('btn-submit').classList.replace('btn-warning', 'btn-success');
        document.getElementById('btn-cancelar-edicao').classList.add('d-none');
        document.querySelectorAll('.file-input-group').forEach(el => el.style.display = 'block');
        document.querySelectorAll('.file-input-group input').forEach(el => el.required = true);
        // Restaura labels originais
        document.querySelectorAll('.file-input-group label').forEach(label => {
            const text = label.textContent;
            if (text.includes('(Opcional)')) {
                label.textContent = text.replace(' (Opcional)', ' *');
            }
        });
        // Esconde o campo "Acionado por" no modo novo
        document.getElementById('div-criado-por').style.display = 'none';
        // Esconde o resumo de blocos e mostra estrutura padr√£o
        setModoEdicaoBlocos(false);
        blocos = []; atualizarTabelaBlocos();
    }

    // Fun√ß√£o mantida por compatibilidade
    function mostrarResumoBlocos() {
        setModoEdicaoBlocos(true);
        atualizarTabelaBlocos();
    }

    // Fun√ß√£o para copiar coordenadas
    function copiarCoordenada(tipo) {
        const input = tipo === 'lat' ? document.getElementById('inp_lat') : document.getElementById('inp_long');
        const valor = input.value.trim();
        
        if (!valor || valor === 'Buscando...') {
            alert('N√£o h√° coordenada para copiar.');
            return;
        }
        
        navigator.clipboard.writeText(valor).then(() => {
            // Feedback visual
            const btn = input.nextElementSibling;
            const iconOriginal = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-check"></i>';
            btn.classList.add('btn-success');
            btn.classList.remove('btn-outline-secondary');
            
            setTimeout(() => {
                btn.innerHTML = iconOriginal;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-secondary');
            }, 2000);
        }).catch(err => {
            console.error('Erro ao copiar:', err);
            alert('Erro ao copiar. Tente selecionar e copiar manualmente.');
        });
    }

    async function excluir(id) {
        if(!confirm('Excluir solicita√ß√£o?')) return;
        try {
            const res = await fetch(`/api/crm/cdoi/editar/${id}/`, { 
                method: 'DELETE', 
                headers: {'Authorization': `Bearer ${localStorage.getItem('accessToken')}`} 
            });

            if (res.ok) {
                alert('Solicita√ß√£o exclu√≠da com sucesso.');
                carregarMeusAcionamentos();
            } else {
                const errorData = await res.json().catch(() => ({ detail: 'Erro desconhecido.' }));
                const errorMessage = res.status === 403 ? 'Acesso negado. Voc√™ n√£o tem permiss√£o.' : (errorData.detail || 'N√£o foi poss√≠vel excluir.');
                alert(`Erro: ${errorMessage}`);
            }
        } catch (error) {
            alert('Ocorreu um erro de conex√£o ao tentar excluir.');
        }
    }

    async function enviarFormulario(btn) {
        const form = document.getElementById('form-cdoi');
        const criadoPorDiv = document.getElementById('div-criado-por');
        const criadoPorInput = document.getElementById('inp_criado_por');
        const criadoPorVisible = criadoPorDiv && criadoPorDiv.offsetParent !== null;
        if (criadoPorInput) {
            criadoPorInput.required = !!criadoPorVisible;
            criadoPorInput.disabled = !criadoPorVisible;
        }
        if(!form.checkValidity()) { form.reportValidity(); return; }
        
        const id = document.getElementById('edit_mode_id').value;
        const isEdit = !!id;
        
        const formData = new FormData(form);
        const dataJson = Object.fromEntries(formData.entries());
        
        // Converte criado_por_id para inteiro se existir
        if (dataJson.criado_por_id) {
            dataJson.criado_por_id = parseInt(dataJson.criado_por_id);
        }
        
        const url = isEdit ? `/api/crm/cdoi/editar/${id}/` : '/api/crm/cdoi/novo/';
        const method = isEdit ? 'PATCH' : 'POST'; // Usa PATCH para edi√ß√£o conforme a view
        const headers = {'Authorization': `Bearer ${localStorage.getItem('accessToken')}`};
        
        // Verifica se h√° arquivos para upload em modo edi√ß√£o
        const temArquivos = isEdit && (formData.get('arquivo_carta') || formData.get('arquivo_fachada'));
        if(isEdit && !temArquivos) {
            // Se n√£o h√° arquivos, envia como JSON
            headers['Content-Type'] = 'application/json';
        }

        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Enviando...';
        try {
            const res = await fetch(url, {
                method: method,
                headers: headers,
                body: (isEdit && !temArquivos) ? JSON.stringify(dataJson) : formData
            });
            const data = await res.json().catch(() => ({}));
            if(res.ok) { 
                const resumoDiv = document.getElementById('resumoEnvio');
                const resumoTexto = document.getElementById('resumoEnvioTexto');
                if (data.resumo && resumoDiv && resumoTexto) {
                    resumoTexto.textContent = data.resumo;
                    resumoDiv.classList.remove('d-none');
                }
                alert('Salvo!');
                cancelarEdicao(); 
                if(isEdit) carregarMeusAcionamentos(); 
                else window.location.reload(); 
            }
            else { alert(data.error || 'Erro ao salvar.'); }
        } catch(e) { alert('Erro de conex√£o.'); }
        finally {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    }

    // Modal Status
    const mStatus = new bootstrap.Modal(document.getElementById('modalStatus'));
    function modalStatus(id, st, obs) {
        document.getElementById('st-id').value = id;
        document.getElementById('st-val').value = st;
        document.getElementById('st-obs').value = obs;
        mStatus.show();
    }
    async function salvarStatus() {
        const id = document.getElementById('st-id').value;
        await fetch(`/api/crm/cdoi/editar/${id}/`, {
            method: 'PATCH',
            headers: {'Authorization': `Bearer ${localStorage.getItem('accessToken')}`, 'Content-Type': 'application/json'},
            body: JSON.stringify({ status: document.getElementById('st-val').value, observacao: document.getElementById('st-obs').value })
        });
        mStatus.hide(); carregarMeusAcionamentos();
    }
    async function buscarCep(cep) { 
        try { 
            const cepLimpo = (cep || '').replace(/\D/g,'');
            if (cepLimpo.length !== 8) return;
            const token = localStorage.getItem('accessToken');
            const r = await fetch(`/api/crm/cdoi/viacep/${cepLimpo}/`, { 
                headers: {'Authorization': `Bearer ${token}`} 
            }); 
            const d = await r.json(); 
            if(!r.ok) {
                console.error('Erro ao buscar CEP:', d);
                return;
            }
            if(!d.erro){ 
                document.getElementById('logradouro').value=d.logradouro; 
                document.getElementById('bairro').value=d.bairro; 
                document.getElementById('cidade_uf').value=`${d.localidade}-${d.uf}`; 
                document.getElementById('cidade').value=d.localidade; 
                document.getElementById('uf').value=d.uf; 
                // Ap√≥s buscar CEP, tenta buscar coordenadas se o n√∫mero j√° estiver preenchido
                setTimeout(() => buscarCoordenadas(), 500);
            } 
        } catch(e){ 
            console.error('Erro ao buscar CEP:', e);
        } 
    }
    
    // Debounce para evitar muitas chamadas durante digita√ß√£o
    let timeoutCoordenadas = null;
    function debounceBuscarCoordenadas() {
        clearTimeout(timeoutCoordenadas);
        timeoutCoordenadas = setTimeout(() => buscarCoordenadas(), 1000);
    }
    
    // Fun√ß√£o para buscar coordenadas (latitude/longitude) via geocodifica√ß√£o
    async function buscarCoordenadas() {
        const logradouro = document.getElementById('logradouro').value;
        const numero = document.getElementById('inp_numero').value;
        const bairro = document.getElementById('bairro').value;
        const cidade = document.getElementById('cidade').value;
        const uf = document.getElementById('uf').value;
        const cep = document.getElementById('inp_cep').value.replace(/\D/g, '');
        
        // Verifica se temos dados suficientes para geocodificar
        if (!logradouro || !numero || !cidade || !uf) {
            return; // N√£o tem dados suficientes ainda
        }
        
        // Monta o endere√ßo completo para geocodifica√ß√£o
        const enderecoCompleto = `${logradouro}, ${numero}, ${bairro || ''}, ${cidade}, ${uf}, Brasil`.replace(/,\s*,/g, ',').replace(/,\s*$/, '');
        
        const latInput = document.getElementById('inp_lat');
        const lngInput = document.getElementById('inp_long');
        
        // Mostra indicador de carregamento
        latInput.value = 'Buscando...';
        lngInput.value = 'Buscando...';
        
        try {
            const token = localStorage.getItem('accessToken');
            // Usa proxy no backend para evitar CORS
            const url = `/api/crm/cdoi/nominatim/?q=${encodeURIComponent(enderecoCompleto)}`;
            const response = await fetch(url, { 
                headers: {'Authorization': `Bearer ${token}`} 
            });
            
            if (!response.ok) {
                throw new Error('Erro ao buscar coordenadas');
            }
            
            const data = await response.json();
            
            if (data && data.length > 0 && data[0].lat && data[0].lon) {
                latInput.value = parseFloat(data[0].lat).toFixed(6);
                lngInput.value = parseFloat(data[0].lon).toFixed(6);
                console.log('Coordenadas encontradas:', latInput.value, lngInput.value);
            } else {
                // Tenta buscar apenas com CEP se n√£o encontrou com endere√ßo completo
                if (cep && cep.length === 8) {
                    const urlCep = `/api/crm/cdoi/nominatim/?postalcode=${cep}`;
                    const responseCep = await fetch(urlCep, { 
                        headers: {'Authorization': `Bearer ${token}`} 
                    });
                    
                    if (responseCep.ok) {
                        const dataCep = await responseCep.json();
                        if (dataCep && dataCep.length > 0 && dataCep[0].lat && dataCep[0].lon) {
                            latInput.value = parseFloat(dataCep[0].lat).toFixed(6);
                            lngInput.value = parseFloat(dataCep[0].lon).toFixed(6);
                            console.log('Coordenadas encontradas pelo CEP:', latInput.value, lngInput.value);
                            return;
                        }
                    }
                }
                
                // Se n√£o encontrou, limpa os campos
                latInput.value = '';
                lngInput.value = '';
                console.warn('Coordenadas n√£o encontradas para:', enderecoCompleto);
            }
        } catch (error) {
            console.error('Erro ao buscar coordenadas:', error);
            latInput.value = '';
            lngInput.value = '';
        }
    }

    function copiarCampo(inputId) {
        const input = document.getElementById(inputId);
        if (!input) return;
        const valor = (input.value || '').trim();
        if (!valor) {
            if (typeof showAlert === 'function') {
                showAlert('Campo vazio. Nada para copiar.', 'warning');
            } else {
                alert('Campo vazio. Nada para copiar.');
            }
            return;
        }
        navigator.clipboard.writeText(valor).then(() => {
            if (typeof showAlert === 'function') {
                showAlert('Copiado!', 'success');
            } else {
                alert('Copiado!');
            }
        }).catch(() => {
            alert('Erro ao copiar.');
        });
    }

    function parseDestinatarios(texto) {
        return (texto || '')
            .split(',')
            .map(item => item.trim())
            .filter(item => item.length > 0);
    }

    async function carregarConfiguracaoCdoi() {
        const feedback = document.getElementById('config-feedback');
        try {
            if (feedback) feedback.textContent = 'Carregando configura√ß√£o...';
            const token = localStorage.getItem('accessToken');
            const res = await fetch('/api/regras-automacao/', { headers: {'Authorization': `Bearer ${token}`} });
            const data = await res.json();
            const regras = Array.isArray(data) ? data : (data.results || []);
            regraCdoiConfig = regras.find(r => r.evento_gatilho === 'NOVO_CDOI') || null;

            const inputDest = document.getElementById('inp_config_destinatarios');
            const inputAtivo = document.getElementById('inp_config_ativo');
            if (regraCdoiConfig) {
                const numeros = (regraCdoiConfig.destinos_numeros || []).join(', ');
                if (inputDest) inputDest.value = numeros;
                if (inputAtivo) inputAtivo.checked = !!regraCdoiConfig.ativo;
                if (feedback) feedback.textContent = 'Configura√ß√£o carregada.';
            } else {
                if (inputDest) inputDest.value = '';
                if (inputAtivo) inputAtivo.checked = true;
                if (feedback) feedback.textContent = 'Nenhuma configura√ß√£o encontrada. Voc√™ pode criar uma nova.';
            }
        } catch (e) {
            console.error('Erro ao carregar configura√ß√£o CDOI:', e);
            if (feedback) feedback.textContent = 'Erro ao carregar configura√ß√£o.';
        }
    }

    async function salvarConfiguracaoCdoi() {
        const feedback = document.getElementById('config-feedback');
        const inputDest = document.getElementById('inp_config_destinatarios');
        const inputAtivo = document.getElementById('inp_config_ativo');
        const numeros = parseDestinatarios(inputDest ? inputDest.value : '');
        const ativo = inputAtivo ? inputAtivo.checked : true;

        const payload = {
            nome: regraCdoiConfig?.nome || 'CDOI - Resumo',
            ativo: ativo,
            evento_gatilho: 'NOVO_CDOI',
            destinos_grupos: regraCdoiConfig?.destinos_grupos || [],
            destinos_numeros: numeros,
            template_mensagem: regraCdoiConfig?.template_mensagem || 'üîî *NOVO CDOI*\\nCliente: {cliente}\\nResp: {usuario}'
        };

        try {
            if (feedback) feedback.textContent = 'Salvando...';
            const token = localStorage.getItem('accessToken');
            const url = regraCdoiConfig?.id ? `/api/regras-automacao/${regraCdoiConfig.id}/` : '/api/regras-automacao/';
            const method = regraCdoiConfig?.id ? 'PATCH' : 'POST';
            const res = await fetch(url, {
                method,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });
            const data = await res.json().catch(() => ({}));
            if (!res.ok) throw new Error(data.detail || 'Erro ao salvar configura√ß√£o');
            regraCdoiConfig = data;
            if (feedback) feedback.textContent = 'Configura√ß√£o salva com sucesso.';
        } catch (e) {
            console.error('Erro ao salvar configura√ß√£o CDOI:', e);
            if (feedback) feedback.textContent = 'Erro ao salvar configura√ß√£o.';
        }
    }

    async function carregarDashboardCdoi() {
        try {
            const token = localStorage.getItem('accessToken');
            const res = await fetch('/api/crm/cdoi/dashboard/', { headers: {'Authorization': `Bearer ${token}`} });
            const data = await res.json();
            if (!res.ok || !data.success) throw new Error(data.error || 'Erro ao carregar dashboard');

            const cards = document.getElementById('dashboard-cards');
            cards.innerHTML = `
                <div class="col-md-3">
                    <div class="card border-0 bg-light">
                        <div class="card-body">
                            <div class="fw-bold text-muted">Acionamentos</div>
                            <div class="fs-4">${data.total_acionamentos}</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-0 bg-light">
                        <div class="card-body">
                            <div class="fw-bold text-muted">HPs Total</div>
                            <div class="fs-4">${data.total_hps}</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-0 bg-light">
                        <div class="card-body">
                            <div class="fw-bold text-muted">Pr√©-venda</div>
                            <div class="fs-4">${data.total_prevenda}</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-0 bg-light">
                        <div class="card-body">
                            <div class="fw-bold text-muted">Vendas (CEP+Fachada)</div>
                            <div class="fs-4">${data.vendas_realizadas}</div>
                        </div>
                    </div>
                </div>
            `;

            const statusDiv = document.getElementById('dashboard-status');
            let statusHtml = `
                <table class="table table-sm">
                    <thead><tr><th>Status</th><th>Quantidade</th></tr></thead><tbody>
            `;
            (data.por_status || []).forEach(s => {
                statusHtml += `<tr><td>${s.status}</td><td>${s.qtd}</td></tr>`;
            });
            statusHtml += '</tbody></table>';
            statusDiv.innerHTML = statusHtml;
        } catch (e) {
            console.error('Erro dashboard CDOI:', e);
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        carregarDashboardCdoi();
        setModoEdicaoBlocos(false);
    });
    
    // Expande o container quando a aba Meus Acionamentos est√° ativa
    document.getElementById('lista-tab').addEventListener('click', function() {
        setTimeout(() => {
            document.querySelector('.system-container').style.maxWidth = '95%';
        }, 50);
    });
    
    document.getElementById('nova-tab').addEventListener('click', function() {
        setTimeout(() => {
            document.querySelector('.system-container').style.maxWidth = '1400px';
        }, 50);
    });
</script>
        </div>
    </main>
</body>
</html>

