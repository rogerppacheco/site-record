{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM de Vendas - Record PAP</title>
    <link rel="shortcut icon" href="{% static 'logo.png' %}" type="image/x-icon">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/fixedheader/3.3.2/css/fixedHeader.bootstrap5.min.css" rel="stylesheet">

    <link rel="stylesheet" href="{% static 'css/custom_styles.css' %}?v=13.1">
    
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

    <style>
        input[type="text"]:not(#input-email), textarea { text-transform: uppercase; }
        #input-email { text-transform: none; }
        .filter-bar { background: #fff; padding: 15px; border-radius: 12px; border: 1px solid var(--cor-borda); display: flex; gap: 10px; flex-wrap: wrap; align-items: end; }
        .filter-item { flex: 1; min-width: 140px; }
        .status-badge { font-size: 0.75rem; padding: 4px 8px; border-radius: 12px; font-weight: 600; letter-spacing: 0.5px; display: inline-block; min-width: 80px; text-align: center; }
        
        .btn-origem { height: 140px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 1.3rem; font-weight: bold; transition: all 0.3s ease; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-width: 2px; }
        .btn-origem:hover { transform: translateY(-5px); box-shadow: 0 8px 12px rgba(0,0,0,0.15); }
        .btn-origem i { font-size: 3.5rem; margin-bottom: 15px; }

        .nav-tabs .nav-link { color: var(--cor-texto-suave); font-weight: 600; border: none; border-bottom: 3px solid transparent; }
        .nav-tabs .nav-link.active { color: var(--cor-primaria); border-bottom: 3px solid var(--cor-primaria); background: transparent; }
        
        .nav-pills .nav-link { color: #555; background-color: #f8f9fa; border: 1px solid #ddd; margin-right: 5px; font-size: 0.9rem; display: flex; align-items: center; gap: 6px; }
        .nav-pills .nav-link.active { background-color: var(--cor-primaria); color: white; border-color: var(--cor-primaria); }
        .nav-pills .nav-link:hover:not(.active) { background-color: #e9ecef; }
        .badge-contador { font-size: 0.75rem; background-color: rgba(0,0,0,0.1); color: inherit; padding: 2px 6px; border-radius: 10px; min-width: 25px; text-align: center; }

        .dash-card { border-radius: 12px; border: none; color: white; padding: 20px; height: 100%; position: relative; overflow: hidden; transition: transform 0.2s; cursor: pointer; }
        .dash-card:hover { transform: translateY(-3px); }
        .dash-card h3 { font-size: 2.5rem; font-weight: bold; margin: 0; }
        .dash-card p { font-size: 0.9rem; opacity: 0.9; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .dash-card .icon-bg { position: absolute; right: -10px; bottom: -10px; font-size: 5rem; opacity: 0.2; transform: rotate(-15deg); }
        .bg-gradient-primary { background: linear-gradient(45deg, #4e73df, #224abe); }
        .bg-gradient-success { background: linear-gradient(45deg, #1cc88a, #13855c); }
        .bg-gradient-info { background: linear-gradient(45deg, #36b9cc, #258391); }
        .bg-gradient-warning { background: linear-gradient(45deg, #f6c23e, #dda20a); color: #fff; }
        
        thead input { width: 100%; padding: 3px; box-sizing: border-box; font-size: 0.85rem; border: 1px solid #ccc; border-radius: 4px; }
        
        .input-loading { background: url('https://i.gifer.com/ZZ5H.gif') no-repeat right 10px center; background-size: 20px; }

        @media (max-width: 576px) { .header-controls { flex-direction: column; align-items: flex-start; gap: 10px; } .header-controls button { width: 100%; } }
        
        /* Correção para modal não aparecer */
        #modal-origem-venda {
            z-index: 1055 !important;
        }
        
        #modal-origem-venda.show {
            display: block !important;
        }
        
        #modal-origem-venda .modal-dialog {
            z-index: 1056 !important;
        }
        
        .modal-backdrop {
            z-index: 1050 !important;
        }
    </style>
</head>
<body>

    <header class="main-header">
        <div class="header-container">
            <a href="/"><img src="{% static 'logo.png' %}" alt="Record PAP Logo" class="logo"></a>
            <button class="menu-toggle" id="menu-toggle"><div class="bar"></div><div class="bar"></div><div class="bar"></div></button>
            <nav class="main-nav" id="main-nav">
                <ul>
                    <li><a href="/area-interna/">Voltar</a></li>
                    <li><button onclick="logout()" class="nav-button logout-button">Sair</button></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="area-interna-section">
        <div class="system-container" style="max-width: 1700px;"> 
            <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3 header-controls">
                <div>
                    <h1 style="font-size: 1.8rem; margin: 0;">Vendas</h1>
                    <p class="text-muted mb-0">Gerencie vendas e acompanhe o status.</p>
                </div>
                <div class="d-flex gap-2">
                    <button id="btn-exportar-excel" class="btn btn-success shadow-sm fw-bold d-none" onclick="exportarExcelDiretoria()">
                        <i class="bi bi-file-earmark-excel-fill"></i> Baixar Base
                    </button>
                    
                    <button class="btn btn-primary shadow-sm fw-bold" onclick="abrirModalOrigem()">
                        <i class="bi bi-plus-lg"></i> Nova Venda
                    </button>
                </div>
            </div>

            <ul class="nav nav-tabs mb-3" id="abas-navegacao">
                <li class="nav-item"><a class="nav-link active" onclick="alterarAba('minhas_vendas', this)">Minhas Vendas</a></li>
                <li class="nav-item d-none" id="aba-equipe"><a class="nav-link" onclick="alterarAba('equipe', this)">Visão de Equipe</a></li>
                <li class="nav-item"><a class="nav-link" onclick="alterarAba('dashboard', this)">Dashboard</a></li>
            </ul>

            <div id="conteudo-lista">
                <div class="mb-3">
                    <ul class="nav nav-pills" id="abas-status">
                        <li class="nav-item"><a class="nav-link active" href="#" onclick="filtrarPorStatus('', this)"><i class="bi bi-collection"></i> Todos <span id="count-todos" class="badge-contador">0</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="#" onclick="filtrarPorStatus('PENDENC', this)"><i class="bi bi-hourglass-split"></i> Pendentes <span id="count-pendentes" class="badge-contador">0</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="#" onclick="filtrarPorStatus('AGENDADO', this)"><i class="bi bi-calendar-event"></i> Agendados <span id="count-agendados" class="badge-contador">0</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="#" onclick="filtrarPorStatus('INSTALADA', this)"><i class="bi bi-check-circle-fill"></i> Instalados <span id="count-instalados" class="badge-contador">0</span></a></li>
                        <li class="nav-item"><a class="nav-link" href="#" onclick="filtrarPorStatus('CANCELAD', this)"><i class="bi bi-x-circle-fill"></i> Cancelados <span id="count-cancelados" class="badge-contador">0</span></a></li>
                    </ul>
                </div>

                <div class="filter-bar mb-4 shadow-sm" id="barra-filtros">
                    <div class="filter-item">
                        <label class="form-label small fw-bold text-muted">Buscar Global</label>
                        <div class="input-group">
                            <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                            <input type="text" id="filtro-busca" class="form-control form-control-sm" placeholder="CPF, Nome ou OS...">
                        </div>
                    </div>

                    <div class="filter-item"><label class="form-label small fw-bold text-muted">Início</label><input type="date" id="filtro-inicio" class="form-control form-control-sm"></div>
                    <div class="filter-item"><label class="form-label small fw-bold text-muted">Fim</label><input type="date" id="filtro-fim" class="form-control form-control-sm"></div>
                    <div class="filter-item d-none" id="container-filtro-vendedor">
                        <label class="form-label small fw-bold text-muted">Vendedor</label>
                        <select id="filtro-vendedor" class="form-select form-select-sm"><option value="">Todos</option></select>
                    </div>
                    <div class="filter-item" style="flex: 0 0 auto;"><button onclick="aplicarFiltros()" class="btn btn-sm btn-primary w-100"><i class="bi bi-filter"></i> Filtrar</button></div>
                </div>

                <div id="aviso-filtro-bloqueado" class="alert alert-light border mb-3 d-none text-center text-muted">
                    <i class="bi bi-calendar-check"></i> Exibindo vendas do mês atual.
                </div>

                <div class="card border-0 shadow-none">
                    <div class="table-responsive">
                        <table id="tabela-vendas" class="table table-hover align-middle mb-0" style="width:100%">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-3">ID</th><th>Data</th><th>Cliente</th><th>Vendedor</th><th>Plano</th><th>O.S.</th><th>Agendamento</th><th>Auditoria</th><th>Status Esteira</th><th>Motivo Pendência</th><th class="text-end pe-3">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="tabela-vendas-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="conteudo-dashboard" style="display: none;">
                <div class="alert alert-info py-2 small mb-4"><i class="bi bi-info-circle"></i> Os dados abaixo refletem o período selecionado no filtro acima.</div>
                <div class="row mb-4" id="row-diretoria" style="display:none;">
                    <div class="col-12">
                        <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; cursor: pointer;" onclick="abrirModalMix()">
                            <div class="card-body d-flex justify-content-between align-items-center">
                                <div><h6 class="text-uppercase mb-1" style="font-size: 0.8rem; opacity: 0.9;">Receita Operadora (Instaladas)</h6><div class="d-flex align-items-baseline"><h2 class="mb-0 fw-bold me-3" id="dir-fat-real">R$ 0,00</h2><small class="text-info bg-white bg-opacity-10 px-2 py-1 rounded">Proj: <span id="dir-fat-proj">R$ 0,00</span></small></div></div>
                                <div class="text-end"><i class="bi bi-pie-chart-fill fs-1 opacity-50"></i><div class="small mt-1 opacity-75">Clique para ver Mix</div></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="dash-card bg-gradient-primary" onclick="abrirDetalheDashboard('TOTAL_REGISTRADAS', 'Vendas Registradas')">
                            <div class="icon-bg"><i class="bi bi-cart-check"></i></div><p>Vendas Registradas (Mês)</p><h3 id="dash-total">0</h3><small id="dash-meta-info" class="text-white-50"></small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="dash-card bg-gradient-info" onclick="abrirDetalheDashboard('TOTAL_INSTALADAS', 'Vendas Instaladas')">
                            <div class="icon-bg"><i class="bi bi-check-circle"></i></div><p>Vendas Instaladas (Mês)</p><h3 id="dash-instaladas">0</h3><small id="dash-aproveitamento" class="text-white-50 fw-bold"></small>
                        </div>
                    </div>
                    <div class="col-md-4" id="card-comissao-wrapper">
                        <div class="dash-card bg-gradient-success" style="cursor: default; transform: none;">
                            <div class="icon-bg"><i class="bi bi-cash-coin"></i></div><p>Comissão Estimada</p><h3 id="dash-comissao">R$ 0,00</h3><small class="text-white-50" id="resumo-projecao-comissao">Baseada nas instalações</small>
                        </div>
                    </div>
                </div>
                <h5 class="mt-5 mb-3 text-muted">Detalhe por Status</h5>
                <div class="row g-3" id="dash-status-container"></div>
            </div>
        </div>
    </main>

    <div class="modal fade" id="modalDetalheDashboard" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title fw-bold" id="tituloDetalheDashboard">Detalhes</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-0"><div class="list-group list-group-flush" id="listaDetalheDashboard"></div></div></div></div></div>
    <div class="modal fade" id="modalMix" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title fw-bold"><i class="bi bi-graph-up"></i> Detalhamento de Vendas (Mix)</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="row"><div class="col-md-6 border-end"><h6 class="text-center fw-bold mb-3 text-primary">Mix de Velocidade/Plano</h6><div class="table-responsive"><table class="table table-sm table-striped"><thead class="table-light"><tr><th>Plano</th><th class="text-end">Qtd</th><th class="text-end">%</th></tr></thead><tbody id="tbody-mix-velocidade"></tbody></table></div></div><div class="col-md-6"><h6 class="text-center fw-bold mb-3 text-success">Mix Forma de Pagamento</h6><div class="table-responsive"><table class="table table-sm table-striped"><thead class="table-light"><tr><th>Forma Pagto</th><th class="text-end">Qtd</th><th class="text-end">%</th></tr></thead><tbody id="tbody-mix-pagamento"></tbody></table></div></div></div></div></div></div></div>

    <div class="modal fade" id="modal-origem-venda" tabindex="-1" style="z-index: 1055;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 bg-transparent">
                <div class="modal-body p-0">
                    <div class="card border-0 shadow-lg" style="border-radius: 20px; overflow: hidden;">
                        <div class="card-header bg-white border-0 pt-4 pb-2 text-center">
                            <h4 class="fw-bold text-dark mb-1">Nova Venda</h4>
                            <p class="text-muted small mb-0">Selecione a origem do cadastro</p>
                            <button type="button" class="btn-close position-absolute top-0 end-0 m-3" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="card-body p-5">
                            <div id="opcoes-origem">
                                <div class="row g-4">
                                    <div class="col-6">
                                        <button onclick="selecionarOrigem('APP')" class="btn btn-outline-primary w-100 btn-origem">
                                            <i class="bi bi-phone"></i>
                                            <span>Via APP</span>
                                        </button>
                                    </div>
                                    <div class="col-6">
                                        <button onclick="selecionarOrigem('SEM_APP')" class="btn btn-outline-secondary w-100 btn-origem">
                                            <i class="bi bi-journal-x"></i>
                                            <span>Sem APP</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div id="opcoes-fixo" style="display: none;">
                                <p class="text-muted small mb-3 text-center">A venda terá telefone fixo?</p>
                                <div class="row g-4">
                                    <div class="col-6">
                                        <button onclick="selecionarFixo(true)" class="btn btn-outline-success w-100">
                                            <i class="bi bi-check-circle"></i>
                                            <span>Sim, tem fixo</span>
                                        </button>
                                    </div>
                                    <div class="col-6">
                                        <button onclick="selecionarFixo(false)" class="btn btn-outline-danger w-100">
                                            <i class="bi bi-x-circle"></i>
                                            <span>Não tem fixo</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div id="opcoes-gerada-os" style="display: none;">
                                <p class="text-muted small mb-3 text-center">Gerada O.S automática?</p>
                                <div class="row g-4">
                                    <div class="col-6">
                                        <button onclick="selecionarGeradaOs(true)" class="btn btn-outline-success w-100">
                                            <i class="bi bi-check-circle"></i>
                                            <span>Sim</span>
                                        </button>
                                    </div>
                                    <div class="col-6">
                                        <button onclick="selecionarGeradaOs(false)" class="btn btn-outline-danger w-100">
                                            <i class="bi bi-x-circle"></i>
                                            <span>Não</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="modal-aviso-cliente" tabindex="-1" style="z-index: 1060;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-warning">
                <div class="modal-header bg-warning text-dark"><h5 class="modal-title fw-bold"><i class="bi bi-exclamation-triangle-fill"></i> Atenção: Cliente Recorrente</h5><button type="button" class="btn-close" onclick="fecharModalAviso()"></button></div>
                <div class="modal-body"><div class="alert alert-light border text-center mb-3"><h4 class="fw-bold text-warning" id="aviso-qtd-vendas" style="font-size: 2.5rem;">0</h4><span class="text-muted text-uppercase small fw-bold">Vendas Ativas Encontradas</span></div><p class="text-center mb-3">O cliente <strong id="aviso-nome-cliente"></strong> já possui histórico em nossa base.</p><div class="alert alert-danger" role="alert"><div class="d-flex align-items-center mb-2"><i class="bi bi-shield-lock-fill fs-3 me-3"></i><div><strong>Aviso de Segurança:</strong><br>Esta venda passará por uma <u>auditoria mais apurada</u> devido à duplicidade de CPF/CNPJ.</div></div><hr><p class="mb-0 fw-bold text-center small text-uppercase"><i class="bi bi-exclamation-circle"></i> Essa venda poderá gerar uma recompra ou uma venda indevida!</p></div><p class="small text-muted text-center mt-3">Deseja continuar com este CPF ou informar um novo?</p></div>
                <div class="modal-footer justify-content-center"><button type="button" class="btn btn-outline-secondary px-4" onclick="fecharModalAviso()">Informar Outro CPF</button><button type="button" class="btn btn-warning px-4 fw-bold" onclick="confirmarClienteExistente()">Sim, Continuar Venda</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal-reemissao" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content border-warning">
                <div class="modal-header bg-warning text-dark"><h5 class="modal-title"><i class="bi bi-arrow-repeat"></i> Reemissão de Venda</h5><button type="button" class="btn-close btn-close-white" onclick="cancelarReemissao()"></button></div>
                <div class="modal-body">
                    <div class="alert alert-warning small">
                        Ao confirmar, a venda será marcada como <strong>Reemissão</strong>, o status será alterado para <strong>AGENDADO</strong> e aparecerá na esteira.
                    </div>
                    <form id="form-reemissao">
                        <div class="mb-3"><label class="form-label fw-bold">Número da O.S. *</label><input type="text" class="form-control" id="reemissao-os" required><div id="reemissao-os-feedback" class="invalid-feedback">O.S. já existe!</div></div>
                        <div class="row">
                            <div class="col-md-6 mb-3"><label class="form-label fw-bold">Data Agendada *</label><input type="date" class="form-control" id="reemissao-data" required></div>
                            <div class="col-md-6 mb-3"><label class="form-label fw-bold">Turno *</label><select class="form-select" id="reemissao-turno" required><option value="">Selecione...</option><option value="MANHA">Manhã</option><option value="TARDE">Tarde</option></select></div>
                        </div>
                        <div class="mb-3"><label class="form-label">Observação</label><textarea class="form-control" id="reemissao-observacao" rows="2" oninput="this.value = this.value.toUpperCase()" placeholder="Digite a observação..."></textarea></div>
                    </form>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" onclick="cancelarReemissao()">Cancelar</button><button type="button" class="btn btn-warning" onclick="salvarReemissao()">Confirmar Reemissão</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal-cep-nao-encontrado" tabindex="-1" style="z-index: 2000;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title fw-bold text-danger"><i class="bi bi-geo-alt-fill"></i> CEP Não Encontrado</h5>
                    <button type="button" class="btn-close" onclick="acaoCepManual(false)"></button>
                </div>
                <div class="modal-body text-center">
                    <p class="mb-3">O CEP informado não retornou nenhum endereço na base dos Correios.</p>
                    <p class="text-muted small">Deseja preencher o endereço manualmente?</p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-outline-secondary" onclick="acaoCepManual(false)">Não, corrigir CEP</button>
                    <button type="button" class="btn btn-primary fw-bold" onclick="acaoCepManual(true)">Sim, preencher manual</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal-nova-venda" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title fw-bold" id="titulo-modal-venda">Registrar Venda</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="form-nova-venda">
                        <input type="hidden" name="forma_entrada" id="input-forma-entrada"><input type="hidden" id="id-venda-edicao">
                        <input type="hidden" name="tem_fixo" id="input-tem-fixo" value="false">
                        <input type="hidden" name="gerada_os_automatica" id="input-gerada-os-automatica" value="false"> 
                        <h6 class="text-primary border-bottom pb-2 mb-3">Dados do Cliente</h6>
                        <div class="row g-3">
                            <div class="col-12 col-md-6 position-relative">
                                <label>CPF/CNPJ <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="input-cpf" name="cliente_cpf_cnpj" required placeholder="Apenas números" autocomplete="off" onblur="validarCpfCnpjInput(this)" oninput="this.value = this.value.replace(/\D/g, '')">
                                <div id="feedback-cpf" class="form-text mt-1" style="font-size: 0.85rem; min-height: 1.2em;"></div>
                                <div class="invalid-feedback">CPF/CNPJ Inválido.</div>
                            </div>
                            <div class="col-12 col-md-6"><label>Nome Completo <span class="text-danger">*</span></label><input type="text" class="form-control" id="input-nome" name="cliente_nome_razao_social" required oninput="this.value = this.value.toUpperCase()"></div>
                            
                            <div class="col-12 col-md-6" id="div-nome-mae"><label>Nome da Mãe</label><input type="text" class="form-control" id="input-nome-mae" name="nome_mae" oninput="this.value = this.value.toUpperCase()"></div>
                            <div class="col-12 col-md-6" id="div-data-nascimento">
                                <label>Data Nascimento</label>
                                <input type="date" class="form-control date-paste-enabled" id="input-data-nascimento" name="data_nascimento">
                            </div>
                            <div class="col-12 col-md-6" id="div-email">
                                <label>Email <span class="text-danger">*</span></label>
                                <input type="email" class="form-control" id="input-email" name="cliente_email" 
                                       required onblur="verificarEmail(this)">
                                <div id="feedback-email" class="form-text mt-1" style="font-size: 0.8rem; min-height: 1.2em;"></div>
                            </div>
                            
                            <div class="col-12 col-md-6">
                                <div class="row g-2">
                                    <div class="col-6"><label>Telefone 1 (WhatsApp) <span class="text-danger">*</span></label><input type="text" class="form-control" id="input-telefone" name="telefone1" required onblur="validarTelefone(this, 'feedback-whatsapp', true)" oninput="validarTelefonesDiferentes()" placeholder="(00) 00000-0000" maxlength="15"><div id="feedback-whatsapp" class="form-text mt-1" style="font-size: 0.8rem; min-height: 1.2em;"></div></div>
                                    <div class="col-6"><label>Telefone 2 <span class="text-danger">*</span></label><input type="text" class="form-control" id="input-telefone2" name="telefone2" required onblur="validarTelefone(this, 'feedback-telefone2', false)" oninput="validarTelefonesDiferentes()" placeholder="(00) 00000-0000" maxlength="15"><div id="feedback-telefone2" class="form-text mt-1" style="font-size: 0.8rem; min-height: 1.2em;"></div></div>
                                </div>
                            </div>
                        </div>
                        <div id="area-representante" class="row g-3 mt-2" style="display: none; background-color: #f8f9fa; padding: 10px; border-radius: 8px; border: 1px solid #e9ecef;"><div class="col-12"><h6 class="text-secondary border-bottom pb-2 mb-0" style="font-size: 0.9rem;">Representante Legal (Obrigatório para CNPJ)</h6></div><div class="col-12 col-md-6"><label>CPF do Representante <span class="text-danger">*</span></label><input type="text" class="form-control" id="input-cpf-rep" name="cpf_representante_legal" oninput="this.value = this.value.replace(/\D/g, '')" onblur="validarCpfInput(this)"><div id="feedback-cpf-rep" class="form-text mt-1" style="font-size: 0.85rem; min-height: 1.2em;"></div></div><div class="col-12 col-md-6"><label>Nome do Representante</label><input type="text" class="form-control" id="input-nome-rep" name="nome_representante_legal" readonly style="background-color: #e9ecef;" oninput="this.value = this.value.toUpperCase()"></div></div>
                        
                        <h6 class="text-primary border-bottom pb-2 mb-3 mt-4">Dados da Venda</h6>
                        <div class="row g-3">
                            <div class="col-12 col-md-6"><label>Plano <span class="text-danger">*</span></label><select class="form-select" name="plano" id="select-plano" required></select></div>
                            <div class="col-12 col-md-6"><label>Forma de Pagamento <span class="text-danger">*</span></label><select class="form-select" name="forma_pagamento" id="select-pagamento" required></select></div>
                            <div class="col-12 col-md-6 d-none" id="container-status-gestao"><label class="fw-bold text-secondary">Status Tratamento</label><select class="form-select" name="status_tratamento" id="select-status-tratamento"></select></div>
                            <div class="col-12 col-md-6 d-none" id="container-status-esteira"><label class="fw-bold text-success">Status Esteira</label><select class="form-select border-success" name="status_esteira" id="select-status-esteira"></select></div>
                            <div class="col-12 col-md-6 d-none" id="container-vendedor-modal"><label class="fw-bold text-secondary">Vendedor (Responsável)</label><select class="form-select" name="vendedor" id="select-vendedor-modal"></select></div>
                            <div class="col-12 d-none" id="container-gerada-os-auto">
                                <label class="fw-bold text-secondary">Gerada O.S automática?</label>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" id="gerada-os-sim" value="true" onchange="document.getElementById('input-gerada-os-automatica').value='true'">
                                    <label class="form-check-label" for="gerada-os-sim">Sim</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" id="gerada-os-nao" value="false" checked onchange="document.getElementById('input-gerada-os-automatica').value='false'">
                                    <label class="form-check-label" for="gerada-os-nao">Não</label>
                                </div>
                            </div>
                            <div class="col-12"><label>Observações</label><textarea class="form-control" name="observacoes" id="input-observacoes" rows="2" oninput="this.value = this.value.toUpperCase()"></textarea></div>
                        </div>
                        
                        <h6 class="text-primary border-bottom pb-2 mb-3 mt-4">Endereço de Instalação</h6>
                        <div class="row g-3">
                            <div class="col-12 col-md-4"><label>CEP <span class="text-danger">*</span></label><input type="text" class="form-control" name="cep" id="nova-cep" required></div>
                            <div class="col-12 col-md-8"><label>Logradouro <span class="text-danger">*</span></label><input type="text" class="form-control" name="logradouro" id="nova-logradouro" oninput="this.value = this.value.toUpperCase()" required></div>
                            <div class="col-6 col-md-2"><label>Número <span class="text-danger">*</span></label><input type="text" class="form-control" name="numero_residencia" id="nova-numero" oninput="this.value = this.value.toUpperCase()" required></div>
                            <div class="col-6 col-md-3"><label>Complemento</label><input type="text" class="form-control" name="complemento" id="nova-complemento" oninput="this.value = this.value.toUpperCase()"></div>
                            <div class="col-6 col-md-3"><label>Bairro <span class="text-danger">*</span></label><input type="text" class="form-control" name="bairro" id="nova-bairro" oninput="this.value = this.value.toUpperCase()" required></div>
                            <div class="col-6 col-md-2"><label>Cidade <span class="text-danger">*</span></label><input type="text" class="form-control" name="cidade" id="nova-cidade" oninput="this.value = this.value.toUpperCase()" required></div>
                            <div class="col-6 col-md-2"><label>UF <span class="text-danger">*</span></label><input type="text" class="form-control" name="estado" id="nova-estado" maxlength="2" style="text-transform: uppercase;" required></div>
                            <div class="col-12"><label>Ponto de Referência <span class="text-danger">*</span></label><input type="text" class="form-control" name="ponto_referencia" id="nova-referencia" required oninput="this.value = this.value.toUpperCase()"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" form="form-nova-venda" id="btn-salvar-venda" class="btn btn-primary">Salvar</button></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/fixedheader/3.3.2/js/dataTables.fixedHeader.min.js"></script>

    <script src="{% static 'js/auth.js' %}?v=7.0"></script>
    <script src="{% static 'js/menu.js' %}?v=7.0"></script>
    <script src="{% static 'js/validators.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const apiUrl = '';
        async function apiFetch(endpoint, options = {}) {
            const headers = { 'Content-Type': 'application/json', ...options.headers };
            const token = localStorage.getItem('accessToken');
            if (token) headers['Authorization'] = `Bearer ${token}`;
            try {
                const response = await fetch(`${apiUrl}/api${endpoint}`, { ...options, headers });
                if (response.status === 401) { logout(); return null; }
                if (!response.ok) { const errorText = await response.text(); try { return Promise.reject(JSON.parse(errorText)); } catch(e) { throw new Error(errorText); } }
                return response.status === 204 ? null : await response.json();
            } catch (e) { throw e; }
        }

        const token = localStorage.getItem('accessToken');
        if(!token) window.location.href = '/';

        let modalOrigem, modalNovaVenda, modalAviso, modalDetalhe, modalMix, modalCep, modalReemissao;
        let vendaReemissaoId = null;
        let clienteTemp = null, debounceTimer, debounceRepTimer, viewAtual = 'minhas_vendas', userProfile = null;
        let dadosMixCache = null;
        let vendedoresCache = [];
        let dashboardDataCache = {}; 
        let statusEsteiraAtual = ''; 
        let origemCadastroAtual = ''; 

        document.addEventListener('DOMContentLoaded', async () => {
            const modalOrigemEl = document.getElementById('modal-origem-venda');
            if (modalOrigemEl) {
                modalOrigem = new bootstrap.Modal(modalOrigemEl);
                
                // Event listeners para limpar backdrop quando o modal for fechado
                modalOrigemEl.addEventListener('hidden.bs.modal', function () {
                    document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
                    document.body.classList.remove('modal-open');
                    document.body.style.paddingRight = '';
                    document.body.style.overflow = '';
                    // Reset do modal de origem
                    document.getElementById('opcoes-origem').style.display = 'block';
                    document.getElementById('opcoes-fixo').style.display = 'none';
                });
                
                // Reset ao abrir o modal
                modalOrigemEl.addEventListener('show.bs.modal', function () {
                    document.getElementById('opcoes-origem').style.display = 'block';
                    document.getElementById('opcoes-fixo').style.display = 'none';
                    document.getElementById('opcoes-gerada-os').style.display = 'none';
                    origemCadastroAtual = '';
                    document.getElementById('input-forma-entrada').value = '';
                    document.getElementById('input-tem-fixo').value = 'false';
                    document.getElementById('input-gerada-os-automatica').value = 'false';
                });
            }
            
            modalNovaVenda = new bootstrap.Modal(document.getElementById('modal-nova-venda'));
            modalAviso = new bootstrap.Modal(document.getElementById('modal-aviso-cliente'));
            modalDetalhe = new bootstrap.Modal(document.getElementById('modalDetalheDashboard'));
            modalMix = new bootstrap.Modal(document.getElementById('modalMix'));
            modalCep = new bootstrap.Modal(document.getElementById('modal-cep-nao-encontrado'));
            modalReemissao = new bootstrap.Modal(document.getElementById('modal-reemissao'));
            
            document.getElementById('modal-nova-venda')?.addEventListener('show.bs.modal', atualizarVisibilidadeGeradaOs);
            document.getElementById('select-vendedor-modal')?.addEventListener('change', atualizarVisibilidadeGeradaOs);
            
            const hoje = new Date();
            document.getElementById('filtro-inicio').valueAsDate = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
            document.getElementById('filtro-fim').valueAsDate = hoje;

            configurarPerfil();
            await carregarAuxiliares();
            
            if(['Supervisor', 'Diretoria', 'BackOffice', 'Admin'].includes(userProfile)) { carregarVendedores(); }
            
            aplicarFiltros(); 

            document.getElementById('form-nova-venda').addEventListener('submit', salvarVenda);
            document.getElementById('nova-cep').addEventListener('blur', buscarCepNovaVenda);
            
            const inputCpf = document.getElementById('input-cpf');
            inputCpf.addEventListener('input', function(e) { 
                e.target.value = e.target.value.replace(/\D/g, ''); 
                e.target.classList.remove('is-invalid'); 
            });
            inputCpf.addEventListener('blur', validarCpfCnpjInput);
            
            // Máscara para telefones
            const inputTelefone1 = document.getElementById('input-telefone');
            const inputTelefone2 = document.getElementById('input-telefone2');
            
            function aplicarMascaraTelefone(input) {
                input.addEventListener('input', function(e) {
                    let valor = e.target.value.replace(/\D/g, '');
                    if (valor.length <= 11) {
                        if (valor.length <= 2) {
                            e.target.value = valor ? `(${valor}` : '';
                        } else if (valor.length <= 7) {
                            e.target.value = `(${valor.substring(0, 2)}) ${valor.substring(2)}`;
                        } else {
                            e.target.value = `(${valor.substring(0, 2)}) ${valor.substring(2, 7)}-${valor.substring(7, 11)}`;
                        }
                    }
                });
            }
            
            if (inputTelefone1) aplicarMascaraTelefone(inputTelefone1);
            if (inputTelefone2) aplicarMascaraTelefone(inputTelefone2);

            document.getElementById('input-cpf-rep').addEventListener('input', function(e) { 
                clearTimeout(debounceRepTimer); 
                if(e.target.value.replace(/\D/g, '').length >= 11) 
                    debounceRepTimer = setTimeout(() => buscarRepresentante(e.target.value.replace(/\D/g, '')), 600); 
            });
            
            document.querySelectorAll('.uppercase-input, input[type="text"]:not(#input-email)').forEach(input => { 
                input.addEventListener('input', function() { this.value = this.value.toUpperCase(); }); 
            });

            document.querySelectorAll('.date-paste-enabled').forEach(input => {
                input.addEventListener('paste', (event) => {
                    const paste = (event.clipboardData || window.clipboardData).getData('text');
                    if (paste) {
                        let clean = paste.replace(/\D/g, '');
                        if (clean.length === 8) {
                            event.preventDefault();
                            const dia = clean.substring(0, 2);
                            const mes = clean.substring(2, 4);
                            const ano = clean.substring(4, 8);
                            if (parseInt(mes) <= 12 && parseInt(dia) <= 31) {
                                input.value = `${ano}-${mes}-${dia}`;
                            }
                        }
                    }
                });
            });
        });

        // ===== VALIDAÇÃO DE CPF/CNPJ =====
        function validarCpfInput(input) {
            if (!input || !input.classList) return;
            const resultado = validarCPF(input.value);
            const feedback = document.getElementById('feedback-cpf-rep');
            if (!input.value) {
                input.classList.remove('is-valid', 'is-invalid');
                feedback && (feedback.textContent = '');
            } else if (resultado.valido) {
                input.classList.add('is-valid');
                input.classList.remove('is-invalid');
                feedback && (feedback.textContent = 'CPF válido ✓', feedback.className = 'form-text text-success mt-1');
            } else {
                input.classList.add('is-invalid');
                input.classList.remove('is-valid');
                feedback && (feedback.textContent = resultado.erro, feedback.className = 'form-text text-danger mt-1');
            }
        }

        function validarCpfCnpjInput(input) {
            if (!input || !input.classList) return;
            const resultado = validarCPFouCNPJ(input.value);
            const feedback = document.getElementById('feedback-cpf');
            if (!input.value) {
                input.classList.remove('is-valid', 'is-invalid');
                feedback && (feedback.textContent = '');
                return;
            }
            if (resultado.valido) {
                input.classList.add('is-valid');
                input.classList.remove('is-invalid');
                feedback && (feedback.textContent = `${resultado.tipo} válido ✓`, feedback.className = 'form-text text-success mt-1');
                // Prosseguir com a busca de cliente
                verificarCpfOnBlur(input);
            } else {
                input.classList.add('is-invalid');
                input.classList.remove('is-valid');
                feedback && (feedback.textContent = resultado.erro, feedback.className = 'form-text text-danger mt-1');
            }
        }

        async function verificarCpfOnBlur(input) {
            const cpf = input.value.replace(/\D/g, '');
            input.classList.remove('is-invalid', 'is-valid');
            if (cpf.length === 0) return; 
            verificarRegraCNPJ(cpf);
            if (cpf.length === 11) { 
                let valido = true;
                if (/^(\d)\1{10}$/.test(cpf)) valido = false;
                else {
                    let soma = 0, resto;
                    for (let i = 1; i <= 9; i++) soma += parseInt(cpf.substring(i-1, i)) * (11 - i);
                    resto = (soma * 10) % 11;
                    if (resto === 10 || resto === 11) resto = 0;
                    if (resto !== parseInt(cpf.substring(9, 10))) valido = false;
                    soma = 0;
                    for (let i = 1; i <= 10; i++) soma += parseInt(cpf.substring(i-1, i)) * (12 - i);
                    resto = (soma * 10) % 11;
                    if (resto === 10 || resto === 11) resto = 0;
                    if (resto !== parseInt(cpf.substring(10, 11))) valido = false;
                }
                if (!valido) { input.classList.add('is-invalid'); return; } 
                else { input.classList.add('is-valid'); }
            }
            if (cpf.length >= 11) {
                input.classList.add('input-loading'); 
                try {
                    const res = await apiFetch(`/crm/clientes/?search=${cpf}`);
                    let cliente = null;
                    if (Array.isArray(res)) {
                        cliente = res.find(c => c.cpf_cnpj && c.cpf_cnpj.replace(/\D/g, '') === cpf);
                    } else if (res && Array.isArray(res.results)) {
                        cliente = res.results.find(c => c.cpf_cnpj && c.cpf_cnpj.replace(/\D/g, '') === cpf);
                    }
                    if (cliente) {
                        preencherFormularioCliente(cliente, true); 
                        if (cliente.vendas_count > 0) { abrirModalAvisoCliente(cliente); }
                    } else {
                        alternarBloqueioCampos(false); limparCamposCliente();
                    }
                } catch(e) { console.error(e); alternarBloqueioCampos(false); 
                } finally { input.classList.remove('input-loading'); }
            }
        }

        function abrirModalAvisoCliente(cliente) {
            document.getElementById('aviso-nome-cliente').textContent = cliente.nome_razao_social;
            document.getElementById('aviso-qtd-vendas').textContent = cliente.vendas_count;
            clienteTemp = cliente; 
            modalAviso.show();
        }

        function fecharModalAviso() {
            modalAviso.hide();
            document.getElementById('input-cpf').value = '';
            document.getElementById('input-cpf').focus();
            limparCamposCliente();
        }

        function confirmarClienteExistente() { modalAviso.hide(); }


        // Bloqueia apenas CPF e Nome, mantendo telefones editáveis
        function alternarBloqueioCampos(bloquear) {
            const idsBloquear = ['input-nome', 'input-cpf'];
            idsBloquear.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.readOnly = bloquear;
            });
            // Telefones continuam editáveis
        }

        function limparCamposCliente() {
            const ids = ['input-nome', 'input-email', 'input-telefone', 'input-telefone2', 'input-nome-mae', 'input-data-nascimento'];
            ids.forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        }

        async function buscarCepNovaVenda(e) { 
            if(origemCadastroAtual === 'APP') return;
            const cep = e.target.value.replace(/\D/g, ''); 
            if (cep.length !== 8) return; 
            const fields = ['nova-logradouro', 'nova-bairro', 'nova-cidade', 'nova-estado'];
            fields.forEach(id => document.getElementById(id).value = '...');
            try { 
                const res = await fetch(`https://viacep.com.br/ws/${cep}/json/`); 
                const d = await res.json(); 
                if(!d.erro) { 
                    document.getElementById('nova-logradouro').value = d.logradouro.toUpperCase(); 
                    document.getElementById('nova-bairro').value = d.bairro.toUpperCase(); 
                    document.getElementById('nova-cidade').value = d.localidade.toUpperCase(); 
                    document.getElementById('nova-estado').value = d.uf.toUpperCase(); 
                    document.getElementById('nova-numero').focus();
                } else { modalCep.show(); }
            } catch(err) { modalCep.show(); } 
        }

        function acaoCepManual(manual) {
            modalCep.hide();
            const ids = ['nova-logradouro', 'nova-bairro', 'nova-cidade', 'nova-estado'];
            if (manual) {
                ids.forEach(id => document.getElementById(id).value = '');
                setTimeout(() => document.getElementById('nova-logradouro').focus(), 300);
            } else {
                ids.forEach(id => document.getElementById(id).value = '');
                document.getElementById('nova-cep').value = '';
                setTimeout(() => document.getElementById('nova-cep').focus(), 300);
            }
        }

        function aplicarFiltros() {
            const abaAtiva = document.querySelector('.nav-tabs .nav-link.active').innerText;
            if(abaAtiva === 'Dashboard') { carregarDashboard(); } else { carregarVendas(); }
        }

        function filtrarPorStatus(status, element) {
            document.querySelectorAll('#abas-status .nav-link').forEach(l => l.classList.remove('active'));
            element.classList.add('active'); 
            statusEsteiraAtual = status; 
            
            // FILTRAGEM VIA CLIENTE (SEM RECARREGAR API)
            if ($.fn.DataTable.isDataTable('#tabela-vendas')) {
                const table = $('#tabela-vendas').DataTable();
                if(status === '') {
                    table.column(8).search('').draw(); // Limpa filtro
                } else {
                    // Regex para buscar o status na coluna 8 (Status Esteira)
                    table.column(8).search(status, true, false).draw();
                }
            } else {
                carregarVendas();
            }
        }

        async function carregarVendedores() {
            try {
                const vendedores = await apiFetch('/crm/lista-vendedores/');
                vendedoresCache = vendedores || [];
                const selectFiltro = document.getElementById('filtro-vendedor');
                const selectModal = document.getElementById('select-vendedor-modal'); 
                selectFiltro.innerHTML = '<option value="">Todos</option>';
                selectModal.innerHTML = '<option value="">Selecione...</option>';
                if(vendedores) {
                    vendedores.forEach(v => {
                        const opt = `<option value="${v.id}">${v.username}</option>`;
                        selectFiltro.innerHTML += opt; selectModal.innerHTML += opt; 
                    });
                }
            } catch(e) { console.error('Erro ao carregar vendedores', e); }
        }

        function atualizarVisibilidadeGeradaOs() {
            const container = document.getElementById('container-gerada-os-auto');
            if (!container) return;
            const idEdicao = document.getElementById('id-venda-edicao')?.value;
            // No create, o valor vem do modal-origem; no edit, mostramos o container se o vendedor tiver permissão
            if (!idEdicao) {
                container.classList.add('d-none');
                return;
            }
            let mostrar = false;
            try {
                const selVend = document.getElementById('select-vendedor-modal');
                const vid = selVend ? selVend.value : '';
                const v = vendedoresCache.find(x => String(x.id) === String(vid));
                mostrar = !!(v && v.autorizar_venda_automatica);
                if (!mostrar && selVend && !vid) {
                    const payload = jwt_decode(localStorage.getItem('accessToken') || '');
                    mostrar = !!payload.autorizar_venda_automatica;
                }
            } catch(e) {}
            container.classList.toggle('d-none', !mostrar);
            if (!mostrar) {
                const radioNao = document.getElementById('gerada-os-nao');
                if (radioNao) radioNao.checked = true;
                document.getElementById('input-gerada-os-automatica').value = 'false';
            }
        }

        // =========================================================================
        // FUNÇÃO CARREGAR VENDAS (CORRIGIDA: Lógica de Status Fechado)
        // =========================================================================
        async function carregarVendas(silent = false) {
            // Destruição segura do DataTable
            if ($.fn.DataTable.isDataTable('#tabela-vendas')) {
                $('#tabela-vendas').DataTable().destroy();
            }

            const tbody = document.getElementById('tabela-vendas-body');
            tbody.innerHTML = '<tr><td colspan="11" class="text-center">Carregando...</td></tr>';
            $('#tabela-vendas thead tr.filters').remove();

            // Parâmetros
            const inicio = document.getElementById('filtro-inicio').value;
            const fim = document.getElementById('filtro-fim').value;
            const vendedor = document.getElementById('filtro-vendedor').value;
            const busca = document.getElementById('filtro-busca').value;
            const viewAtual = document.querySelector('.nav-tabs .nav-link.active').innerText === 'Minhas Vendas' ? 'minhas_vendas' : 'geral';
            
            let url = `/crm/vendas/?view=${viewAtual}`;
            if(inicio) url += `&data_inicio=${inicio}`;
            if(fim) url += `&data_fim=${fim}`;
            if(busca) url += `&search=${busca}`; 
            if(viewAtual === 'geral' && vendedor) url += `&consultor_id=${vendedor}`;

            try {
                // Busca todas as páginas de vendas automaticamente
                let vendas = [];
                let nextUrl = url + '&page_size=1000';
                let primeiraResposta = null;
                while (nextUrl) {
                    const res = await apiFetch(nextUrl);
                    if (!primeiraResposta) primeiraResposta = res;
                    if (res && res.results) {
                        vendas = vendas.concat(res.results);
                        // Extrai apenas o endpoint relativo para próxima página
                        if (res.next) {
                            const next = res.next;
                            const idx = next.indexOf('/api/');
                            nextUrl = idx !== -1 ? next.substring(idx + 4) : null;
                        } else {
                            nextUrl = null;
                        }
                    } else if (Array.isArray(res)) {
                        vendas = vendas.concat(res);
                        nextUrl = null;
                    } else {
                        nextUrl = null;
                    }
                }

                // Carrega listas de status
                const [statusEsteiraRes, statusTratRes] = await Promise.all([
                    apiFetch('/crm/status/?tipo=Esteira&page_size=1000'),
                    apiFetch('/crm/status/?tipo=Tratamento&page_size=1000')
                ]);

                const listaStatusEsteira = Array.isArray(statusEsteiraRes) ? statusEsteiraRes : (statusEsteiraRes?.results || []);
                const listaStatusTrat = Array.isArray(statusTratRes) ? statusTratRes : (statusTratRes?.results || []);

                // === CÁLCULO DE CONTADORES ===
                let counts = { total: 0, pendente: 0, agendado: 0, instalada: 0, cancelado: 0 };
                if (vendas.length > 0) {
                    counts.total = vendas.length;
                    vendas.forEach(v => {
                        let stNome = v.status_esteira_nome || '';
                        if (!stNome && v.status_esteira) {
                             const s = listaStatusEsteira.find(x => x.id == v.status_esteira || x.id == v.status_esteira.id);
                             if(s) stNome = s.nome;
                        }
                        const stUpper = String(stNome).toUpperCase();

                        if (stUpper.includes('INSTALADA')) counts.instalada++;
                        else if (stUpper.includes('CANCELAD')) counts.cancelado++;
                        else if (stUpper.includes('AGENDADO')) counts.agendado++;
                        else if (stUpper.includes('PENDEN') || stUpper.includes('PENDÊN')) counts.pendente++;
                    });
                }

                // Atualiza Badges
                document.getElementById('count-todos').textContent = `${counts.total}`;
                document.getElementById('count-pendentes').textContent = `${counts.pendente}`;
                document.getElementById('count-agendados').textContent = `${counts.agendado}`;
                document.getElementById('count-instalados').textContent = `${counts.instalada}`;
                document.getElementById('count-cancelados').textContent = `${counts.cancelado}`;

                if (vendas.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="11" class="text-center text-muted">Nenhuma venda encontrada.</td></tr>';
                    return;
                }

                const dadosFormatados = vendas.map(v => {
                    // --- 1. RESOLUÇÃO STATUS TRATAMENTO E ESTADO (CRÍTICO) ---
                    let statusTratamentoNome = '-';
                    let statusTratamentoEstado = ''; // Vazio, Aberto ou Fechado
                    
                    // Tenta encontrar o objeto na lista completa para pegar o .estado
                    let objTrat = null;

                    // Busca por ID
                    if (v.status_tratamento) {
                        const idBusca = (typeof v.status_tratamento === 'object') ? v.status_tratamento.id : v.status_tratamento;
                        objTrat = listaStatusTrat.find(s => s.id == idBusca);
                    }
                    
                    // Se não achou por ID, tenta pelo Nome (caso o backend mande o nome)
                    if (!objTrat && v.status_tratamento_nome) {
                        objTrat = listaStatusTrat.find(s => s.nome.toUpperCase() === v.status_tratamento_nome.toUpperCase());
                    }

                    if (objTrat) {
                        statusTratamentoNome = objTrat.nome;
                        statusTratamentoEstado = objTrat.estado || ''; 
                    } else {
                        // Fallback se não achar na lista
                        statusTratamentoNome = v.status_tratamento_nome || v.status_tratamento || v.status_comissionamento || '-';
                    }

                    // --- 2. RESOLUÇÃO STATUS ESTEIRA ---
                    let statusNome = 'Aguardando';
                    let badgeClass = 'bg-secondary text-white';
                    
                    // Tenta achar o nome da esteira
                    if (v.status_esteira_nome) {
                        statusNome = v.status_esteira_nome;
                    } else if (v.status_esteira) {
                        const idBusca = (typeof v.status_esteira === 'object') ? v.status_esteira.id : v.status_esteira;
                        const sEncontrado = listaStatusEsteira.find(s => s.id == idBusca);
                        if (sEncontrado) statusNome = sEncontrado.nome;
                    }

                    // --- 3. REGRA DE NEGÓCIO DA AUDITORIA (CORRIGIDA) ---
                    const stTratUpper = String(statusTratamentoNome).toUpperCase();
                    const estadoTratUpper = String(statusTratamentoEstado).toUpperCase();

                    if (statusNome === 'Aguardando') {
                        // REGRA MESTRA: Se o tratamento está FECHADO (Duplicidade, Cancelado, Reprovado Final), a esteira morre.
                        if (estadoTratUpper === 'FECHADO') {
                            statusNome = '-';
                            badgeClass = 'bg-light text-muted border';
                        } 
                        // REGRA SECUNDÁRIA: Se Reprovado mas Aberto -> Pendência
                        else if (stTratUpper.includes('REPROVAD')) {
                            statusNome = 'Pendência Auditoria';
                            badgeClass = 'bg-danger text-white';
                        } 
                        // REGRA TERCIÁRIA: Pendente
                        else if (stTratUpper.includes('PENDENTE')) {
                            statusNome = 'Em Análise';
                            badgeClass = 'bg-warning text-dark';
                        }
                    }

                    // --- 4. CORES DA ESTEIRA ---
                    const statusNomeStr = String(statusNome);
                    const stEsteiraUpper = statusNomeStr.toUpperCase();
                    
                    // Só aplica cores padrão se não foi alterado pela regra de auditoria (exceto se virou "-")
                    if (statusNome !== '-' && statusNome !== 'Pendência Auditoria' && statusNome !== 'Em Análise') { 
                        if (stEsteiraUpper === 'INSTALADA') badgeClass = 'bg-success text-white';
                        else if (stEsteiraUpper.includes('CANCELADA')) badgeClass = 'bg-danger text-white';
                        else if (stEsteiraUpper.includes('AGENDADO')) badgeClass = 'bg-info text-dark';
                        else if (stEsteiraUpper.includes('PENDÊNCIA') || stEsteiraUpper.includes('PENDENCIA')) badgeClass = 'bg-warning text-dark';
                    }
                    
                    const badgeEsteira = `<span class="status-badge ${badgeClass}">${statusNomeStr}</span>`;

                    // Cores Tratamento
                    let badgeTratamentoClass = 'bg-light text-muted border';
                    if (stTratUpper.includes('APROVAD') || stTratUpper.includes('OK')) badgeTratamentoClass = 'bg-success text-white';
                    else if (stTratUpper.includes('REPROVAD') || stTratUpper.includes('DUPLICIDADE')) badgeTratamentoClass = 'bg-danger text-white';
                    else if (stTratUpper.includes('PENDENTE')) badgeTratamentoClass = 'bg-warning text-dark';
                    else if (stTratUpper.includes('AUDITADA')) badgeTratamentoClass = 'bg-primary text-white';
                    const badgeTratamento = `<span class="status-badge ${badgeTratamentoClass}">${statusTratamentoNome}</span>`;

                    // Demais dados
                    const dataFormatada = v.data_criacao ? new Date(v.data_criacao).toLocaleDateString('pt-BR') : '-';
                    const clienteNome = v.cliente ? (v.cliente.nome_razao_social || v.cliente.nome || v.cliente_nome) : (v.cliente_nome_razao_social || 'N/A');
                    const clienteDisplay = `<div class="fw-bold">${clienteNome}</div><div class="small text-muted">${v.cliente_cpf_cnpj || ''}</div>`;
                    
                    let nomeVendedor = 'N/A';
                    if (v.vendedor_nome) nomeVendedor = v.vendedor_nome;
                    else if (v.vendedor) nomeVendedor = (v.vendedor.username || v.vendedor.first_name || v.vendedor);

                    const planoNome = v.plano ? (v.plano.nome || v.plano_nome) : (v.plano_nome || 'N/A');
                    
                    let motivoPendencia = '-';
                    if (v.motivo_pendencia_nome) motivoPendencia = v.motivo_pendencia_nome;
                    else if (v.motivo_pendencia) {
                         motivoPendencia = (typeof v.motivo_pendencia === 'object') ? v.motivo_pendencia.nome : v.motivo_pendencia;
                    }

                    const osDisplay = v.ordem_servico ? `<span class="fw-bold text-dark">#${v.ordem_servico}</span>` : '<span class="text-muted">-</span>';
                    
                    let agendamentoDisplay = '<span class="text-muted">-</span>';
                    if(v.data_agendamento) {
                        const parts = v.data_agendamento.split('-');
                        const turno = v.periodo_agendamento || '';
                        agendamentoDisplay = `<span>${parts[2]}/${parts[1]}</span> <span class="badge bg-light text-dark border ms-1">${turno}</span>`;
                    }

                    // Verificar se é cancelada ou pendênciada (para mostrar botão de reemissão)
                    const isCancelada = stEsteiraUpper.includes('CANCELAD') || stTratUpper.includes('CANCELAD');
                    const isPendenciada = stEsteiraUpper.includes('PENDEN') || stEsteiraUpper.includes('PENDÊN') || stTratUpper.includes('PENDENTE');
                    
                    // Botão de reemissão só aparece para canceladas ou pendênciadas
                    const btnReemissao = (isCancelada || isPendenciada) ? 
                        `<button onclick="abrirModalReemissao(${v.id})" class="btn btn-sm btn-outline-warning me-1" title="Reemissão"><i class="bi bi-arrow-repeat"></i></button>` : '';
                    
                    const botoes = `
                        ${btnReemissao}
                        <button onclick="reenviarWhatsApp(${v.id})" class="btn btn-sm btn-outline-success me-1" title="Reenviar Aprovação"><i class="bi bi-whatsapp"></i></button>
                        <button onclick="editarVenda(${v.id})" class="btn btn-sm btn-editar me-1" title="Editar"><i class="bi bi-pencil"></i></button>
                        <button onclick="excluirVenda(${v.id})" class="btn btn-sm btn-excluir" title="Excluir"><i class="bi bi-trash"></i></button>
                    `;

                    return [
                        `<span class="ps-3 fw-bold">#${v.id}</span>`,
                        dataFormatada,
                        clienteDisplay,
                        nomeVendedor,
                        planoNome,
                        osDisplay,
                        agendamentoDisplay,
                        badgeTratamento,
                        badgeEsteira,
                        `<span class="text-danger small fw-bold">${motivoPendencia}</span>`,
                        `<div class="text-end pe-3">${botoes}</div>`
                    ];
                });

                iniciarDataTable(dadosFormatados);

                if(statusEsteiraAtual) {
                    const table = $('#tabela-vendas').DataTable();
                    table.column(8).search(statusEsteiraAtual, true, false).draw();
                }

            } catch (error) { 
                console.error(error); 
                tbody.innerHTML = '<tr><td colspan="11" class="text-center text-danger">Erro ao carregar vendas.</td></tr>'; 
            }
        }

        function iniciarDataTable(dataSet) {
            $('#tabela-vendas thead tr.filters').remove();
            $('#tabela-vendas thead tr').clone(true).addClass('filters').appendTo('#tabela-vendas thead');
            
            const table = $('#tabela-vendas').DataTable({
                destroy: true, 
                data: dataSet, 
                deferRender: true,
                orderCellsTop: true,
                fixedHeader: true,
                paging: true,
                pageLength: 25,
                language: { url: "https://cdn.datatables.net/plug-ins/1.13.4/i18n/pt-BR.json" },
                columnDefs: [
                    { orderable: false, targets: 10 }, 
                    { className: "align-middle", targets: "_all" }
                ],
                initComplete: function () {
                    var api = this.api();
                    api.columns().eq(0).each(function (colIdx) {
                        if (colIdx == 10) { $('.filters th').eq($(api.column(colIdx).header()).index()).html(''); return; }
                        var cell = $('.filters th').eq($(api.column(colIdx).header()).index());
                        var title = $(cell).text();
                        $(cell).html('<input type="text" placeholder="🔍 ' + title + '" />');
                        $('input', $('.filters th').eq($(api.column(colIdx).header()).index())).off('keyup change').on('keyup change', function (e) { 
                            e.stopPropagation(); 
                            var regexr = '({search})'; 
                            api.column(colIdx).search(this.value != '' ? regexr.replace('{search}', '(((' + this.value + ')))') : '', this.value != '', this.value == '').draw(); 
                        });
                    });
                }
            });
        }

        async function reenviarWhatsApp(id) {
            if(!confirm("Deseja reenviar a mensagem de aprovação para o vendedor responsável?")) return;
            try { const res = await apiFetch(`/crm/vendas/${id}/reenviar-whatsapp-aprovacao/`, { method: 'POST' }); alert(res.detail || "Enviado!"); } catch(e) { alert("Erro ao enviar: " + (e.detail || e)); }
        }

        function verificarRegraCNPJ(valor) {
            if(!valor) return;
            const clean = valor.replace(/\D/g, '');
            const area = document.getElementById('area-representante');
            const input = document.getElementById('input-cpf-rep');
            
            // LÓGICA DE EXIBIÇÃO:
            // O estilo 'display: flex' aqui se sobrepõe ao container pai ser ocultado
            // caso o elemento esteja em um container visível, ou se for manipulado diretamente.
            if (clean.length > 11) { 
                area.style.display = 'flex'; 
                input.setAttribute('required', 'required'); 
            } else { 
                area.style.display = 'none'; 
                input.removeAttribute('required'); 
            }
        }

        function abrirModalOrigem() {
            console.log('[DEBUG] abrirModalOrigem chamado');
            
            // Limpar qualquer backdrop preso
            document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
            document.body.classList.remove('modal-open');
            document.body.style.paddingRight = '';
            document.body.style.overflow = '';
            
            // Resetar formulário
            const formNovaVenda = document.getElementById('form-nova-venda');
            if (formNovaVenda) formNovaVenda.reset();
            
            const idVendaEdicao = document.getElementById('id-venda-edicao');
            if (idVendaEdicao) idVendaEdicao.value = '';
            
            const tituloModal = document.getElementById('titulo-modal-venda');
            if (tituloModal) tituloModal.innerHTML = 'Registrar Venda';
            
            const feedbackWhatsapp = document.getElementById('feedback-whatsapp');
            if (feedbackWhatsapp) feedbackWhatsapp.innerHTML = '';
            
            const inputTelefone = document.getElementById('input-telefone');
            if (inputTelefone) inputTelefone.classList.remove('is-valid', 'is-invalid');
            
            const btnSalvar = document.getElementById('btn-salvar-venda');
            if (btnSalvar) btnSalvar.disabled = false;
            
            const containerEsteira = document.getElementById('container-status-esteira');
            if (containerEsteira) containerEsteira.classList.add('d-none');
            
            const containerVendedor = document.getElementById('container-vendedor-modal');
            if (containerVendedor) containerVendedor.classList.add('d-none');
            
            const containerGestao = document.getElementById('container-status-gestao');
            if (containerGestao) containerGestao.classList.add('d-none');
            
            ['input-nome', 'input-email', 'input-telefone', 'input-telefone2', 'input-nome-mae', 'input-data-nascimento'].forEach(id => {
                const el = document.getElementById(id);
                if(el) { el.readOnly = false; el.value = ''; }
            });
            
            const areaRep = document.getElementById('area-representante');
            if(areaRep) areaRep.style.display = 'none';
            
            // Verificar se o modal existe e está inicializado
            const modalElement = document.getElementById('modal-origem-venda');
            if (!modalElement) {
                console.error('[ERRO] Modal modal-origem-venda não encontrado no DOM');
                alert('Erro: Modal não encontrado. Recarregue a página.');
                return;
            }
            
            // Verificar se modalOrigem foi inicializado
            if (!modalOrigem) {
                console.warn('[AVISO] modalOrigem não inicializado, tentando criar agora...');
                try {
                    modalOrigem = new bootstrap.Modal(modalElement);
                } catch (e) {
                    console.error('[ERRO] Não foi possível criar instância do modal:', e);
                    alert('Erro ao abrir modal. Recarregue a página.');
                    return;
                }
            }
            
            console.log('[DEBUG] Tentando abrir modal...');
            try {
                modalOrigem.show();
                console.log('[DEBUG] modalOrigem.show() executado');
            } catch (e) {
                console.error('[ERRO] Erro ao abrir modal:', e);
                // Fallback: tentar abrir manualmente
                modalElement.classList.add('show');
                modalElement.style.display = 'block';
                document.body.classList.add('modal-open');
                const backdrop = document.createElement('div');
                backdrop.className = 'modal-backdrop fade show';
                backdrop.style.zIndex = '1050';
                document.body.appendChild(backdrop);
            }
        }

        function selecionarOrigem(tipo) {
            origemCadastroAtual = tipo; 
            document.getElementById('input-forma-entrada').value = tipo;
            
            // Mostra pergunta sobre fixo
            document.getElementById('opcoes-origem').style.display = 'none';
            document.getElementById('opcoes-fixo').style.display = 'block';
        }
        
        function selecionarFixo(temFixo) {
            document.getElementById('input-tem-fixo').value = temFixo ? 'true' : 'false';
            
            const badge = document.getElementById('badge-origem');
            if(badge) {
                const tipo = origemCadastroAtual;
                badge.textContent = (tipo === 'APP') ? 'Via APP' : 'Sem APP';
                badge.className = (tipo === 'APP') ? 'badge bg-primary ms-2' : 'badge bg-secondary ms-2';
            }

            let mostrarGeradaOs = false;
            try {
                const payload = jwt_decode(localStorage.getItem('accessToken') || '');
                mostrarGeradaOs = !!payload.autorizar_venda_automatica;
            } catch(e) {}

            if (mostrarGeradaOs) {
                document.getElementById('opcoes-fixo').style.display = 'none';
                document.getElementById('opcoes-gerada-os').style.display = 'block';
            } else {
                document.getElementById('input-gerada-os-automatica').value = 'false';
                abrirFormularioVenda();
            }
        }

        function selecionarGeradaOs(valor) {
            document.getElementById('input-gerada-os-automatica').value = valor ? 'true' : 'false';
            abrirFormularioVenda();
        }

        function abrirFormularioVenda() {
            const containerDadosVenda = document.querySelector('form h6:nth-of-type(2)').nextElementSibling; 
            const containerEndereco = document.querySelector('form h6:nth-of-type(3)').nextElementSibling; 
            const headerDadosVenda = document.querySelector('form h6:nth-of-type(2)');
            const headerEndereco = document.querySelector('form h6:nth-of-type(3)');

            const divNomeMae = document.getElementById('div-nome-mae');
            const divDataNasc = document.getElementById('div-data-nascimento');
            const divEmail = document.getElementById('div-email');

            const camposOpcionaisNoApp = [
                'select-plano', 'select-pagamento', 
                'nova-cep', 'nova-logradouro', 'nova-numero', 'nova-bairro', 'nova-cidade', 'nova-estado', 'nova-referencia',
                'input-nome-mae', 'input-data-nascimento', 'input-email' 
            ];

            if (origemCadastroAtual === 'APP') {
                if(containerDadosVenda) containerDadosVenda.style.display = 'none';
                if(containerEndereco) containerEndereco.style.display = 'none';
                if(headerDadosVenda) headerDadosVenda.style.display = 'none';
                if(headerEndereco) headerEndereco.style.display = 'none';
                
                if(divNomeMae) divNomeMae.style.display = 'none';
                if(divDataNasc) divDataNasc.style.display = 'none';
                if(divEmail) divEmail.style.display = 'none';

                camposOpcionaisNoApp.forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.removeAttribute('required');
                });

            } else {
                if(containerDadosVenda) containerDadosVenda.style.display = 'flex';
                if(containerEndereco) containerEndereco.style.display = 'flex';
                if(headerDadosVenda) headerDadosVenda.style.display = 'block';
                if(headerEndereco) headerEndereco.style.display = 'block';

                if(divNomeMae) divNomeMae.style.display = 'block';
                if(divDataNasc) divDataNasc.style.display = 'block';
                if(divEmail) divEmail.style.display = 'block';

                camposOpcionaisNoApp.forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.setAttribute('required', 'required');
                });
            }

            modalOrigem.hide();
            modalNovaVenda.show();
        }

        function configurarPerfil() {
            try {
                const payload = jwt_decode(token);
                userProfile = payload.user_role || payload.perfil || 'Vendedor'; 
                const perfisGestao = ['Supervisor', 'Diretoria', 'BackOffice', 'Admin'];
                if (perfisGestao.includes(userProfile)) { document.getElementById('aba-equipe').classList.remove('d-none'); }
                if (!['Diretoria', 'Admin', 'BackOffice'].includes(userProfile)) { 
                    document.getElementById('barra-filtros').style.display = 'none'; 
                    document.getElementById('aviso-filtro-bloqueado').classList.remove('d-none'); 
                }
                if (['Diretoria', 'Admin', 'BackOffice'].includes(userProfile)) {
                    document.getElementById('btn-exportar-excel').classList.remove('d-none');
                }
            } catch(e) {}
        }

        function alterarAba(tipo, elemento) {
            document.querySelectorAll('#abas-navegacao .nav-link').forEach(l => l.classList.remove('active'));
            elemento.classList.add('active');
            const divLista = document.getElementById('conteudo-lista');
            const divDash = document.getElementById('conteudo-dashboard');
            if (tipo === 'dashboard') { divLista.style.display = 'none'; divDash.style.display = 'block'; carregarDashboard(); } else {
                divDash.style.display = 'none'; divLista.style.display = 'block';
                viewAtual = (tipo === 'minhas_vendas') ? 'minhas_vendas' : 'geral';
                document.getElementById('container-filtro-vendedor').classList.toggle('d-none', viewAtual === 'minhas_vendas');
                if (viewAtual === 'geral') carregarVendedores();
                carregarVendas();
            }
        }

        async function carregarDashboard() {
            const inicio = document.getElementById('filtro-inicio').value;
            const fim = document.getElementById('filtro-fim').value;
            const consultorId = document.getElementById('filtro-vendedor').value;
            let url = `/crm/dashboard-resumo/?data_inicio=${inicio}&data_fim=${fim}`;
            if (consultorId) url += `&consultor_id=${consultorId}`;
            try {
                const d = await apiFetch(url);
                dashboardDataCache = d.detalhes_listas || {};
                let htmlVendas = d.total_vendas;
                if (d.projecao_vendas > 0) { htmlVendas += `<div style="font-size: 1rem; opacity: 0.8; font-weight: normal; margin-top: 5px;"><i class="bi bi-graph-up-arrow"></i> Proj: ${Math.round(d.projecao_vendas)}</div>`; }
                document.getElementById('dash-total').innerHTML = htmlVendas;
                document.getElementById('dash-meta-info').innerHTML = `Meta: ${d.meta} | Atingido: <strong>${d.percentual_meta}%</strong>`;
                let htmlInstaladas = d.total_instaladas || 0;
                if (d.projecao_instaladas > 0) { htmlInstaladas += `<div style="font-size: 1rem; opacity: 0.8; font-weight: normal; margin-top: 5px;"><i class="bi bi-graph-up-arrow"></i> Proj: ${Math.round(d.projecao_instaladas)}</div>`; }
                document.getElementById('dash-instaladas').innerHTML = htmlInstaladas;
                document.getElementById('dash-aproveitamento').textContent = `Aproveitamento: ${d.percentual_aproveitamento}%`;
                const cardComissao = document.getElementById('card-comissao-wrapper');
                if (d.exibir_comissao && cardComissao) {
                    cardComissao.style.display = 'block';
                    let htmlComissao = d.comissao_estimada.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
                    if (d.projecao_comissao > 0) { htmlComissao += `<div style="font-size: 1rem; opacity: 0.8; font-weight: normal; margin-top: 5px;"><i class="bi bi-graph-up-arrow"></i> Proj: ${d.projecao_comissao.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</div>`; }
                    document.getElementById('dash-comissao').innerHTML = htmlComissao;
                } else if(cardComissao) { cardComissao.style.display = 'none'; }
                const container = document.getElementById('dash-status-container');
                container.innerHTML = '';
                for (const [status, count] of Object.entries(d.status_detalhado)) { container.innerHTML += `<div class="col-6 col-md-3"><div class="p-3 border rounded bg-white shadow-sm text-center" onclick="abrirDetalheDashboard('${status}', '${status}')" style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'"><h5 class="fw-bold text-secondary">${count}</h5><small class="text-muted fw-bold text-uppercase">${status}</small></div></div>`; }
                const rowDiretoria = document.getElementById('row-diretoria');
                if (d.diretoria_data) {
                    rowDiretoria.style.display = 'flex';
                    document.getElementById('dir-fat-real').textContent = d.diretoria_data.faturamento_real.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                    document.getElementById('dir-fat-proj').textContent = d.diretoria_data.faturamento_projetado.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                    dadosMixCache = d.diretoria_data;
                } else { rowDiretoria.style.display = 'none'; }
            } catch(e) {}
        }

        function abrirModalMix() {
            if (!dadosMixCache) return;
            const preencherTabela = (tbodyId, dadosObj) => {
                const tbody = document.getElementById(tbodyId);
                tbody.innerHTML = '';
                const lista = Object.entries(dadosObj).sort((a, b) => b[1] - a[1]);
                const total = lista.reduce((acc, curr) => acc + curr[1], 0);
                lista.forEach(([nome, qtd]) => { const pct = total > 0 ? ((qtd / total) * 100).toFixed(1) : 0; tbody.innerHTML += `<tr><td>${nome}</td><td class="text-end fw-bold">${qtd}</td><td class="text-end text-muted small">${pct}%</td></tr>`; });
                tbody.innerHTML += `<tr class="table-active fw-bold"><td>TOTAL</td><td class="text-end">${total}</td><td class="text-end">100%</td></tr>`;
            };
            preencherTabela('tbody-mix-velocidade', dadosMixCache.mix_velocidade);
            preencherTabela('tbody-mix-pagamento', dadosMixCache.mix_pagamento);
            modalMix.show();
        }

        function abrirDetalheDashboard(chaveLista, titulo) {
            document.getElementById('tituloDetalheDashboard').textContent = titulo;
            const listaEl = document.getElementById('listaDetalheDashboard');
            listaEl.innerHTML = '';
            const itens = dashboardDataCache[chaveLista] || [];
            if (itens.length === 0) { listaEl.innerHTML = '<div class="text-center p-4 text-muted">Nenhuma venda encontrada.</div>'; } 
            else {
                itens.forEach(item => {
                    let badgeClass = 'bg-secondary';
                    if (item.status.includes('INSTALADA')) badgeClass = 'bg-success';
                    else if (item.status.includes('CANCELADA')) badgeClass = 'bg-danger';
                    else if (item.status.includes('AGENDADO')) badgeClass = 'bg-info text-dark';
                    const dataFormatada = item.data_iso ? new Date(item.data_iso).toLocaleDateString('pt-BR') : '-';
                    listaEl.innerHTML += `<a href="#" class="list-group-item list-group-item-action py-3"><div class="d-flex w-100 justify-content-between align-items-center"><div><h6 class="mb-1 fw-bold text-primary">#${item.id} - ${item.cliente}</h6><small class="text-muted">Vendedor: ${item.vendedor} | Data: ${dataFormatada}</small></div><span class="badge ${badgeClass}">${item.status}</span></div></a>`;
                });
            }
            modalDetalhe.show();
        }

        function exportarExcelDiretoria() {
            if(!confirm("Deseja baixar a base completa de vendas em Excel (todas as vendas ativas, com Data Criação e Data Instalação)?")) return;
            const btn = document.getElementById('btn-exportar-excel');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Gerando...'; btn.disabled = true;
            fetch(`${apiUrl}/api/crm/vendas/exportar-excel/?base_completa=1`, { method: 'GET', headers: { 'Authorization': 'Bearer ' + localStorage.getItem('accessToken') } })
            .then(response => {
                if (response.status === 403) throw new Error("Acesso negado. Apenas Diretoria, Admin ou BackOffice.");
                if (!response.ok) throw new Error("Erro ao gerar arquivo.");
                const cd = response.headers.get('Content-Disposition');
                const m = cd && /filename="([^"]+)"/.exec(cd);
                const filename = (m && m[1]) ? m[1] : `Base_Vendas_Completa_${new Date().toISOString().slice(0,10)}.xlsx`;
                return response.blob().then(blob => ({ blob, filename }));
            })
            .then(({ blob, filename }) => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
            })
            .catch(err => { alert(err.message); })
            .finally(() => { btn.innerHTML = originalText; btn.disabled = false; });
        }

        function preencherFormularioCliente(cliente, lock = false) { 
            document.getElementById('input-cpf').value = cliente.cpf_cnpj; 
            
            const preencherCampoInteligente = (id, valor) => {
                const el = document.getElementById(id);
                if (!el) return;
                el.value = valor || '';
                // Telefones nunca ficam readOnly
                if (id === 'input-telefone' || id === 'input-telefone2') {
                    el.readOnly = false;
                    return;
                }
                if (lock) {
                    if (valor && String(valor).trim() !== '') {
                        el.readOnly = true;
                    } else {
                        el.readOnly = false; 
                    }
                } else {
                    el.readOnly = false;
                }
            };

            preencherCampoInteligente('input-nome', cliente.nome_razao_social);
            preencherCampoInteligente('input-email', cliente.email);
            preencherCampoInteligente('input-telefone', cliente.telefone1);
            preencherCampoInteligente('input-telefone2', cliente.telefone2);
            preencherCampoInteligente('input-nome-mae', cliente.nome_mae);
            preencherCampoInteligente('input-data-nascimento', cliente.data_nascimento);
            
            verificarRegraCNPJ(cliente.cpf_cnpj);
        }

        // ===============================================
        // Lógica de Busca e Preenchimento de Representante
        // ===============================================
        async function buscarRepresentante(cpf) { 
            const inputNome = document.getElementById('input-nome-rep');
            
            // 1. Feedback visual (Trava e mostra que está processando)
            inputNome.value = "BUSCANDO...";
            inputNome.readOnly = true;
            inputNome.style.backgroundColor = "#e9ecef"; // Cinza

            try { 
                const res = await apiFetch(`/crm/clientes/?search=${cpf}`); 
                let encontrado = false;

                if(res && res.length > 0) { 
                    // Busca exata para garantir segurança
                    const rep = res.find(cli => cli.cpf_cnpj.replace(/\D/g, '') === cpf.replace(/\D/g, '')); 
                    
                    if (rep) {
                        // Cenario 1: CPF Existe -> Preenche e Mantém Travado
                        inputNome.value = rep.nome_razao_social;
                        inputNome.readOnly = true;
                        inputNome.style.backgroundColor = "#e9ecef";
                        encontrado = true;
                    } 
                } 

                if (!encontrado) {
                    // Cenario 2: CPF Não Existe -> Limpa, Destrava e Foca
                    inputNome.value = ""; 
                    inputNome.readOnly = false; 
                    inputNome.style.backgroundColor = "#ffffff"; 
                    inputNome.focus(); 
                }

            } catch(e) {
                // Em caso de erro, libera
                console.error("Erro ao buscar representante:", e);
                inputNome.value = "";
                inputNome.readOnly = false;
                inputNome.style.backgroundColor = "#ffffff";
            } 
        }

        async function carregarAuxiliares() {
            // debug removido
            try {
                const [planos, formas, statusEst, statusTrat] = await Promise.all([
                    apiFetch('/crm/planos/?page_size=1000'),
                    apiFetch('/crm/formas-pagamento/?page_size=1000'),
                    apiFetch('/crm/status/?tipo=Esteira&page_size=1000'),
                    apiFetch('/crm/status/?tipo=Tratamento&page_size=1000')
                ]);
                // debug removido

                const planosArr = planos?.results || planos;
                const formasArr = formas?.results || formas;
                const statusEstArr = statusEst?.results || statusEst;
                const statusTratArr = statusTrat?.results || statusTrat;

                const selPlano = document.getElementById('select-plano');
                selPlano.innerHTML = '<option value="">Selecione...</option>';
                if(planosArr && Array.isArray(planosArr)) planosArr.forEach(p => selPlano.innerHTML += `<option value="${p.id}">${p.nome} - R$${p.valor}</option>`);
                // debug removido

                const selPag = document.getElementById('select-pagamento');
                selPag.innerHTML = '<option value="">Selecione...</option>';
                if(formasArr && Array.isArray(formasArr)) formasArr.forEach(f => selPag.innerHTML += `<option value="${f.id}">${f.nome}</option>`);
                // debug removido

                const selEst = document.getElementById('select-status-esteira');
                selEst.innerHTML = '<option value="">Selecione...</option>';
                if(statusEstArr && Array.isArray(statusEstArr)) statusEstArr.forEach(s => selEst.innerHTML += `<option value="${s.id}">${s.nome}</option>`);
                // debug removido

                const selTrat = document.getElementById('select-status-tratamento');
                selTrat.innerHTML = '<option value="">Selecione...</option>';
                if(statusTratArr && Array.isArray(statusTratArr)) statusTratArr.forEach(s => selTrat.innerHTML += `<option value="${s.id}">${s.nome}</option>`);
                // debug removido
            } catch(e) {
                console.error('[ERRO carregarAuxiliares]', e);
            }
        }

        async function editarVenda(id) {
            try {
                await carregarAuxiliares();
                const venda = await apiFetch(`/crm/vendas/${id}/`);
                // debug removido
                document.getElementById('titulo-modal-venda').textContent = `Editar Venda #${id}`;
                document.getElementById('id-venda-edicao').value = id;
                document.getElementById('input-forma-entrada').value = venda.forma_entrada || 'SEM_APP';
                document.getElementById('input-tem-fixo').value = venda.tem_fixo ? 'true' : 'false';


                // Exibe todos os campos apenas dentro do modal de edição, sem afetar abas globais
                const modal = document.getElementById('modal-nova-venda');
                if (modal) {
                    const dadosVenda = modal.querySelector('form h6:nth-of-type(2)').nextElementSibling;
                    const endereco = modal.querySelector('form h6:nth-of-type(3)').nextElementSibling;
                    const h6Dados = modal.querySelector('form h6:nth-of-type(2)');
                    const h6Endereco = modal.querySelector('form h6:nth-of-type(3)');
                    if (dadosVenda) dadosVenda.style.display = 'flex';
                    if (endereco) endereco.style.display = 'flex';
                    if (h6Dados) h6Dados.style.display = 'block';
                    if (h6Endereco) h6Endereco.style.display = 'block';
                    const divNomeMae = modal.querySelector('#div-nome-mae');
                    const divDataNasc = modal.querySelector('#div-data-nascimento');
                    const divEmail = modal.querySelector('#div-email');
                    if(divNomeMae) divNomeMae.style.display = 'block';
                    if(divDataNasc) divDataNasc.style.display = 'block';
                    if(divEmail) divEmail.style.display = 'block';
                }

                // Preenche campos
                document.getElementById('input-cpf').value = venda.cliente_cpf_cnpj || '';
                document.getElementById('input-nome').value = venda.cliente_nome_razao_social || '';
                document.getElementById('input-email').value = venda.cliente_email || '';
                document.getElementById('input-nome-mae').value = venda.nome_mae || '';
                document.getElementById('input-data-nascimento').value = venda.data_nascimento || '';
                document.getElementById('input-telefone').value = venda.telefone1 || '';
                document.getElementById('input-telefone2').value = venda.telefone2 || '';
                verificarRegraCNPJ(venda.cliente_cpf_cnpj);
                document.getElementById('input-cpf-rep').value = venda.cpf_representante_legal || '';
                document.getElementById('input-nome-rep').value = venda.nome_representante_legal || '';


                // Preenche selects somente após as opções estarem disponíveis
                function preencherSelectQuandoPronto(selectId, valor) {
                    const tentativasMax = 20;
                    let tentativas = 0;
                    function tentar() {
                        const select = document.getElementById(selectId);
                        if (select && select.options.length > 1) {
                            select.value = valor || '';
                        } else if (tentativas < tentativasMax) {
                            tentativas++;
                            setTimeout(tentar, 50);
                        }
                    }
                    tentar();
                }
                preencherSelectQuandoPronto('select-plano', venda.plano?.id || venda.plano || '');
                preencherSelectQuandoPronto('select-pagamento', venda.forma_pagamento?.id || venda.forma_pagamento || '');
                preencherSelectQuandoPronto('select-status-esteira', venda.status_esteira?.id || venda.status_esteira || '');
                preencherSelectQuandoPronto('select-status-tratamento', venda.status_tratamento?.id || venda.status_tratamento || '');
                preencherSelectQuandoPronto('select-vendedor-modal', venda.vendedor?.id || venda.vendedor || '');

                // Gerada O.S automática (edição)
                const divGeradaOs = document.getElementById('container-gerada-os-auto');
                const vendedorTemPermissao = venda.vendedor_detalhes?.autorizar_venda_automatica || vendedoresCache.find(x => String(x.id) === String(venda.vendedor?.id || venda.vendedor))?.autorizar_venda_automatica;
                const inputGeradaOs = document.getElementById('input-gerada-os-automatica');
                if (divGeradaOs && inputGeradaOs) {
                    divGeradaOs.classList.toggle('d-none', !vendedorTemPermissao);
                    const isSim = venda.gerada_os_automatica === true || venda.gerada_os_automatica === 'true';
                    inputGeradaOs.value = isSim ? 'true' : 'false';
                    if (vendedorTemPermissao) {
                        document.getElementById('gerada-os-sim').checked = isSim;
                        document.getElementById('gerada-os-nao').checked = !isSim;
                    }
                }

                let obs = venda.observacoes;
                if (obs === undefined || obs === null || obs === 'NONE' || obs === 'None') obs = '';
                document.getElementById('input-observacoes').value = obs;
                document.getElementById('nova-cep').value = venda.cep || '';
                document.getElementById('nova-logradouro').value = venda.logradouro || '';
                document.getElementById('nova-numero').value = venda.numero_residencia || '';
                document.getElementById('nova-complemento').value = venda.complemento || '';
                document.getElementById('nova-bairro').value = venda.bairro || '';
                document.getElementById('nova-cidade').value = venda.cidade || '';
                document.getElementById('nova-estado').value = venda.estado || '';
                document.getElementById('nova-referencia').value = venda.ponto_referencia || '';

                // Remove d-none dos containers de status/vendedor se perfil permitir
                const areaStatus = document.getElementById('container-status-esteira');
                const areaVendedor = document.getElementById('container-vendedor-modal');
                const areaTrat = document.getElementById('container-status-gestao');
                
                if(['Admin', 'Diretoria', 'BackOffice'].includes(userProfile)) {
                    areaStatus.classList.remove('d-none');
                    areaVendedor.classList.remove('d-none'); 
                    areaTrat.classList.remove('d-none');
                } else {
                    areaStatus.classList.add('d-none'); 
                    areaVendedor.classList.add('d-none'); 
                    areaTrat.classList.add('d-none');
                }

                // Adiciona debug simples nos selects
                // debug dos selects removido
                
                document.getElementById('feedback-whatsapp').innerHTML = '';
                document.getElementById('input-telefone').classList.remove('is-valid', 'is-invalid');
                document.getElementById('btn-salvar-venda').disabled = false;
                
                alternarBloqueioCampos(false); 
                
                // Garante que todos os campos obrigatórios fiquem visíveis ao editar
                document.querySelector('form h6:nth-of-type(2)').nextElementSibling.style.display = 'flex'; // Dados da Venda
                document.querySelector('form h6:nth-of-type(3)').nextElementSibling.style.display = 'flex'; // Endereço
                document.querySelector('form h6:nth-of-type(2)').style.display = 'block';
                document.querySelector('form h6:nth-of-type(3)').style.display = 'block';
                // Campos opcionais
                const divNomeMae = document.getElementById('div-nome-mae');
                const divDataNasc = document.getElementById('div-data-nascimento');
                const divEmail = document.getElementById('div-email');
                if(divNomeMae) divNomeMae.style.display = 'block';
                if(divDataNasc) divDataNasc.style.display = 'block';
                if(divEmail) divEmail.style.display = 'block';
                modalNovaVenda.show();
            } catch (e) { console.error(e); alert("Erro ao carregar dados para edição."); }
        }

        async function salvarVenda(e) {
            e.preventDefault();
            
            // Validar que os telefones não sejam iguais
            if (!validarTelefonesDiferentes()) {
                alert("Atenção: O Telefone 2 não pode ser igual ao Telefone 1. Por favor, corrija antes de salvar.");
                return;
            }
            
            const form = e.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            const idEdicao = document.getElementById('id-venda-edicao').value;
            const method = idEdicao ? 'PUT' : 'POST';
            const url = idEdicao ? `/crm/vendas/${idEdicao}/` : '/crm/vendas/';
            
            // CORREÇÃO: Converter checkbox de reemissão para boolean
            const checkboxReemissao = document.getElementById('checkbox-reemissao');
            if (checkboxReemissao) {
                data.reemissao = checkboxReemissao.checked;
            } else {
                data.reemissao = false;
            }
            
            // Converter tem_fixo para boolean
            data.tem_fixo = data.tem_fixo === 'true' || data.tem_fixo === true;
            // Converter gerada_os_automatica para boolean
            data.gerada_os_automatica = data.gerada_os_automatica === 'true' || data.gerada_os_automatica === true;
            
            if (origemCadastroAtual === 'SEM_APP') {
                if(!data.plano || !data.forma_pagamento || !data.cep || !data.logradouro) {
                    alert("Por favor, preencha todos os campos obrigatórios.");
                    return;
                }
            }

            if (data.data_nascimento === "") data.data_nascimento = null;
            if (data.plano === "") data.plano = null;
            if (data.forma_pagamento === "") data.forma_pagamento = null;

            try {
                await apiFetch(url, { method: method, body: JSON.stringify(data) });
                modalNovaVenda.hide(); form.reset(); document.getElementById('id-venda-edicao').value = '';
                document.getElementById('titulo-modal-venda').innerHTML = 'Registrar Venda';
                aplicarFiltros(); 
                alert(idEdicao ? 'Venda atualizada!' : 'Venda registrada!');
            } catch (error) { 
                let msg = "Erro ao salvar.";
                if (error && typeof error === 'object') {
                    const detalhes = [];
                    for (const [key, value] of Object.entries(error)) detalhes.push(`${key}: ${Array.isArray(value)?value.join(', '):value}`);
                    if (detalhes.length) msg = "Verifique os erros:\n\n" + detalhes.join('\n');
                    else if (error.detail) msg = error.detail;
                }
                alert(msg);
            }
        }

        async function excluirVenda(id) { if(!confirm('Tem certeza?')) return; try { await apiFetch(`/crm/vendas/${id}/`, { method: 'DELETE' }); carregarVendas(); } catch(e) { alert('Erro ao excluir.'); } }
        
        // Funções para Reemissão
        async function abrirModalReemissao(id) {
            vendaReemissaoId = id;
            document.getElementById('form-reemissao').reset();
            document.getElementById('reemissao-os-feedback').textContent = '';
            document.getElementById('reemissao-os').classList.remove('is-invalid');
            modalReemissao.show();
        }
        
        function cancelarReemissao() {
            modalReemissao.hide();
            vendaReemissaoId = null;
        }
        
        async function salvarReemissao() {
            const os = document.getElementById('reemissao-os').value.trim();
            const data = document.getElementById('reemissao-data').value;
            const turno = document.getElementById('reemissao-turno').value;
            const observacao = document.getElementById('reemissao-observacao').value || '';
            
            if (!os || !data || !turno) {
                alert("Preencha todos os campos obrigatórios.");
                return;
            }
            
            // Validar O.S. única
            try {
                const res = await apiFetch(`/crm/vendas/?ordem_servico=${os}`);
                const lista = Array.isArray(res) ? res : (res.results || []);
                if (lista.some(v => v.id !== vendaReemissaoId)) {
                    document.getElementById('reemissao-os').classList.add('is-invalid');
                    document.getElementById('reemissao-os-feedback').textContent = 'O.S. já existe!';
                    return;
                }
            } catch (e) {
                alert("Erro ao validar O.S.");
                return;
            }
            
            try {
                // Duplicar venda (criar nova venda)
                const resultado = await apiFetch('/crm/duplicar-venda/', {
                    method: 'POST',
                    body: JSON.stringify({
                        id_venda: vendaReemissaoId,
                        nova_os: os,
                        nova_data_agendamento: data,
                        novo_turno: turno,
                        nova_observacao: observacao
                    })
                });
                
                modalReemissao.hide();
                aplicarFiltros();
                alert('Reemissão criada com sucesso! Uma nova venda foi criada com status AGENDADO e aparecerá na esteira.');
            } catch (error) {
                alert('Erro ao criar reemissão: ' + (error.detail || error.message || error));
            }
        }
        
        function logout() { localStorage.removeItem('accessToken'); window.location.href = '/'; }
        
        function validarTelefonesDiferentes() {
            const telefone1Input = document.getElementById('input-telefone');
            const telefone2Input = document.getElementById('input-telefone2');
            const feedbackTel2 = document.getElementById('feedback-telefone2');
            
            if (!telefone1Input || !telefone2Input || !feedbackTel2) return;
            
            const tel1 = telefone1Input.value.replace(/\D/g, '');
            const tel2 = telefone2Input.value.replace(/\D/g, '');
            
            // Só valida se ambos tiverem conteúdo
            if (tel1.length >= 10 && tel2.length >= 10) {
                if (tel1 === tel2) {
                    telefone2Input.classList.add('is-invalid');
                    telefone2Input.classList.remove('is-valid');
                    feedbackTel2.innerHTML = '<span class="text-danger fw-bold small"><i class="bi bi-exclamation-triangle"></i> Telefone 2 não pode ser igual ao Telefone 1!</span>';
                    return false;
                } else {
                    telefone2Input.classList.remove('is-invalid');
                    telefone2Input.classList.add('is-valid');
                    feedbackTel2.innerHTML = '<span class="text-success small"><i class="bi bi-check-circle"></i> Telefone válido</span>';
                    return true;
                }
            } else {
                // Limpa validação se não houver dados suficientes
                telefone2Input.classList.remove('is-invalid', 'is-valid');
                feedbackTel2.innerHTML = '';
                return true;
            }
        }
        
        async function verificarEmail(input) {
            const email = input.value.trim();
            const feedbackDiv = document.getElementById('feedback-email');
            
            // Validação básica de formato
            if (!email || email.length < 5 || !email.includes('@')) {
                if (feedbackDiv) feedbackDiv.innerHTML = '';
                input.classList.remove('is-valid', 'is-invalid');
                return;
            }
            
            // Mostra loading enquanto valida
            if (feedbackDiv) {
                feedbackDiv.innerHTML = '<span class="text-warning spinner-border spinner-border-sm"></span> <span class="text-warning small">Verificando e-mail...</span>';
            }
            
            try {
                const data = await apiFetch(`/crm/verificar-email/${encodeURIComponent(email)}/`, { method: 'GET' });
                
                if (data && data.valido) {
                    input.classList.add('is-valid');
                    input.classList.remove('is-invalid');
                    if (feedbackDiv) {
                        feedbackDiv.innerHTML = '<span class="text-success fw-bold small"><i class="bi bi-check-circle"></i> E-mail válido!</span>';
                    }
                } else {
                    input.classList.add('is-invalid');
                    input.classList.remove('is-valid');
                    const mensagem = data?.mensagem || 'E-mail inválido';
                    if (feedbackDiv) {
                        feedbackDiv.innerHTML = `<span class="text-danger fw-bold small"><i class="bi bi-x-circle"></i> ${mensagem}</span>`;
                    }
                }
            } catch (error) {
                console.error('Erro ao verificar e-mail:', error);
                // Em caso de erro de rede, não bloqueia o usuário
                input.classList.remove('is-valid', 'is-invalid');
                if (feedbackDiv) {
                    feedbackDiv.innerHTML = '<span class="text-warning small">Não foi possível verificar (offline).</span>';
                }
            }
        }
        
        function validarTelefone(input, feedbackId, isWhatsApp) {
            const telefone = input.value.replace(/\D/g, '');
            const feedbackDiv = document.getElementById(feedbackId);
            
            // Validação básica: deve ter 11 dígitos
            if (telefone.length !== 11) {
                input.classList.add('is-invalid');
                input.classList.remove('is-valid');
                if(feedbackDiv) {
                    feedbackDiv.innerHTML = '<span class="text-danger fw-bold small"><i class="bi bi-x-circle"></i> O telefone deve ter 11 dígitos (DDD + número).</span>';
                }
                return false;
            }
            
            // Extrai DDD (2 primeiros dígitos)
            const ddd = telefone.substring(0, 2);
            
            // DDDs válidos no Brasil (lista oficial)
            const dddValidos = [11, 12, 13, 14, 15, 16, 17, 18, 19, 21, 22, 24, 27, 28, 31, 32, 33, 34, 35, 37, 38, 41, 42, 43, 44, 45, 46, 47, 48, 49, 51, 52, 53, 54, 61, 62, 63, 64, 65, 66, 67, 68, 69, 71, 73, 74, 75, 79, 81, 82, 83, 84, 85, 86, 87, 88, 89, 91, 92, 93, 94, 95, 96, 97, 98, 99];
            const dddNum = parseInt(ddd);
            
            if (!dddValidos.includes(dddNum)) {
                input.classList.add('is-invalid');
                input.classList.remove('is-valid');
                if(feedbackDiv) {
                    feedbackDiv.innerHTML = '<span class="text-danger fw-bold small"><i class="bi bi-x-circle"></i> DDD inválido. Informe um DDD válido do Brasil (não aceita código 55).</span>';
                }
                return false;
            }
            
            // Formata o telefone se ainda não estiver formatado
            const telefoneFormatado = `(${ddd}) ${telefone.substring(2, 7)}-${telefone.substring(7)}`;
            if (input.value !== telefoneFormatado) {
                input.value = telefoneFormatado;
            }
            
            // Se for WhatsApp, verifica também
            if (isWhatsApp) {
                verificarWhatsApp(input);
            } else {
                input.classList.add('is-valid');
                input.classList.remove('is-invalid');
                if(feedbackDiv) {
                    feedbackDiv.innerHTML = '<span class="text-success fw-bold small"><i class="bi bi-check-circle"></i> Telefone válido!</span>';
                }
            }
            
            return true;
        }
        
        async function verificarWhatsApp(input) {
            const telefone = input.value.replace(/\D/g, ''); 
            const feedbackDiv = document.getElementById('feedback-whatsapp');
            const btnSalvar = document.getElementById('btn-salvar-venda');
            
            if (telefone.length < 10) return;
            
            input.classList.remove('is-valid', 'is-invalid');
            if(feedbackDiv) feedbackDiv.innerHTML = '<span class="text-warning spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> <span class="text-warning small">Verificando WhatsApp...</span>';
            if(btnSalvar) btnSalvar.disabled = true; 
            
            try {
                const data = await apiFetch(`/crm/verificar-zap/${telefone}/`, { method: 'GET' });
                
                if (data && (data.whatsapp_valido || data.exists || data.possui_whatsapp)) {
                    // Se tem aviso, significa que não conseguiu verificar mas permite salvar
                    if (data.aviso) {
                        input.classList.remove('is-valid', 'is-invalid');
                        if(feedbackDiv) feedbackDiv.innerHTML = '<span class="text-warning fw-bold small"><i class="bi bi-exclamation-triangle"></i> Não foi possível verificar WhatsApp (timeout). Você pode salvar.</span>';
                    } else {
                        input.classList.add('is-valid'); input.classList.remove('is-invalid');
                        if(feedbackDiv) feedbackDiv.innerHTML = '<span class="text-success fw-bold small"><i class="bi bi-whatsapp"></i> WhatsApp Confirmado!</span>';
                    }
                    if(btnSalvar) btnSalvar.disabled = false; 
                } else {
                    // Número não encontrado no WhatsApp - mostrar aviso mas PERMITIR salvar
                    input.classList.remove('is-valid', 'is-invalid');
                    if(feedbackDiv) feedbackDiv.innerHTML = '<span class="text-warning fw-bold small"><i class="bi bi-exclamation-triangle"></i> WhatsApp não confirmado. Verifique o número, mas você pode salvar.</span>';
                    if(btnSalvar) btnSalvar.disabled = false;
                }
            } catch (error) {
                console.error("Erro verificação WhatsApp:", error);
                input.classList.remove('is-valid', 'is-invalid');
                if(feedbackDiv) feedbackDiv.innerHTML = '<span class="text-warning small">Não foi possível verificar (API Offline).</span>';
                if(btnSalvar) btnSalvar.disabled = false;
            }
        }
    </script>
</body>
</html>