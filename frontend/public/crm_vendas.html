{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM de Vendas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        /* Estilos do código original para garantir funcionalidade, com adição do tema escuro e responsividade */
        :root {
            --cor-fundo-primaria: #121212;
            --cor-fundo-secundaria: #1e1e1e;
            --cor-texto-primaria: #e0e0e0;
            --cor-texto-secundaria: #a0a0a0;
            --cor-destaque: #007bff;
            --cor-borda: #444; /* Borda um pouco mais clara para contraste */
        }

        body {
            background-color: var(--cor-fundo-primaria);
            color: var(--cor-texto-primaria);
        }

        .card, .modal-content {
            background-color: var(--cor-fundo-secundaria);
            color: var(--cor-texto-primaria);
            border: 1px solid var(--cor-borda);
        }

        .card-header, .modal-header {
            border-bottom: 1px solid var(--cor-borda);
        }

        .modal-header .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%);
        }

        h1, h2, h3, h4, h5, h6 {
            color: var(--cor-texto-primaria);
        }

        .table {
            --bs-table-bg: var(--cor-fundo-secundaria);
            --bs-table-color: var(--cor-texto-primaria);
            --bs-table-border-color: var(--cor-borda);
            --bs-table-hover-bg: #2a2a2a;
        }

        .form-control, .form-select {
            background-color: var(--cor-fundo-primaria);
            color: var(--cor-texto-primaria);
            border: 1px solid var(--cor-borda);
        }

        .form-control:focus, .form-select:focus {
            background-color: var(--cor-fundo-primaria);
            color: var(--cor-texto-primaria);
            border-color: var(--cor-destaque);
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        
        .form-control:-webkit-autofill {
            -webkit-box-shadow: 0 0 0 30px var(--cor-fundo-primaria) inset !important;
            -webkit-text-fill-color: var(--cor-texto-primaria) !important;
        }

        .bg-light {
            background-color: #2a2a2a !important; /* Um pouco mais claro para destacar a área de filtros */
            border-color: var(--cor-borda) !important;
        }

        .main-header {
            background-color: #fff;
            padding: 1rem 2rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: sticky; top: 0; z-index: 1020;
        }
        .header-container { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo { max-height: 40px; }
        .main-nav ul { list-style: none; display: flex; gap: 1.5rem; align-items: center; margin-bottom: 0; }
        .main-nav a, #welcome-user { text-decoration: none; color: #1a1a1a; font-weight: 500; }
        .main-nav a:hover { color: #888; }
        
        .hidden { display: none; }
        .search-results {
            position: absolute; width: 100%; background-color: var(--cor-fundo-secundaria);
            border: 1px solid var(--cor-borda); border-top: none; z-index: 1055;
            max-height: 200px; overflow-y: auto;
        }
        .search-results-item { padding: 10px; cursor: pointer; border-bottom: 1px solid var(--cor-borda); }
        .search-results-item:hover { background-color: var(--cor-destaque); }
        .uppercase-input { text-transform: uppercase; }

        .status-counters { display: flex; flex-wrap: wrap; gap: 15px; padding: 15px; background-color: #2a2a2a; border-radius: 8px; margin-bottom: 1rem; }
        .status-box { background-color: var(--cor-fundo-secundaria); padding: 10px 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); text-align: center; flex: 1 1 120px; }
        .status-box .count { font-size: 1.5rem; font-weight: bold; }
        .status-box .label { font-size: 0.85rem; color: var(--cor-texto-secundaria); text-transform: uppercase; }

        .total-row { font-weight: bold; background-color: #343a40; }
        .team-header { background-color: #343a40; color: white; padding: 8px 12px; border-radius: 5px; }

        /* --- Media Queries para Responsividade --- */
        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                gap: 1rem;
            }
            /* Ajusta o cabeçalho do card para empilhar em telas pequenas */
            .card-header > .d-flex {
                flex-direction: column;
                align-items: stretch !important;
            }
            .card-header .p-3 {
                padding-top: 0 !important;
                width: 100%;
            }
            #btn-nova-venda {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="header-container">
            <a href="/">
                <img src="{% static 'logo.png' %}" alt="Record PAP Logo" class="logo">
            </a>
            <nav class="main-nav">
                <ul>
                    <li><a href="/area-interna/">Área Interna</a></li>
                    <li><span class="navbar-text me-3" id="welcome-user"></span></li>
                    <li><button class="btn btn-danger btn-sm" id="logoutButton">Sair</button></li>
                </ul>
            </nav>
        </div>
    </header>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid" style="max-width: 1200px;">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#submenuNavbar" aria-controls="submenuNavbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="submenuNavbar">
                <ul class="navbar-nav">
                    <li class="nav-item" id="nav-presenca"><a class="nav-link" href="/presenca/">Controle de Presença</a></li>
                    <li class="nav-item dropdown" id="nav-vendas">
                        <a class="nav-link dropdown-toggle active" href="#" id="navbarVendas" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Vendas
                        </a>
                        <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="navbarVendas">
                            <li><a class="dropdown-item active" href="/crm-vendas/">Visão Geral & Performance</a></li>
                            <li><a class="dropdown-item" href="/auditoria/">Auditoria</a></li>
                            <li><a class="dropdown-item" href="/esteira/">Esteira</a></li>
                            <li><a class="dropdown-item" href="/comissionamento/">Comissionamento</a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown" id="nav-importacoes">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarImportacoes" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Importações
                        </a>
                        <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="navbarImportacoes">
                            <li><a class="dropdown-item" href="/salvar-osab/">Salvar OSAB</a></li>
                            <li><a class="dropdown-item" href="/salvar-churn/">Salvar Churn</a></li>
                            <li><a class="dropdown-item" href="/salvar-ciclo-pagamento/">Salvar Ciclo de Pagamento</a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown" id="nav-cadastros">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarCadastros" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Cadastros
                        </a>
                        <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="navbarCadastros">
                            <li><a class="dropdown-item" href="/governanca/">Governança</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>


    <main class="container mt-4">
        <div class="card shadow-sm">
             <div class="card-header p-0">
                <div class="d-flex justify-content-between align-items-center w-100">
                    <ul class="nav nav-tabs card-header-tabs" id="main-tabs" role="tablist" style="border-bottom: 0;">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="visao-geral-tab" data-bs-toggle="tab" data-bs-target="#visao-geral-pane" type="button" role="tab" aria-controls="visao-geral-pane" aria-selected="true">Visão Geral de Vendas</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="performance-tab" data-bs-toggle="tab" data-bs-target="#performance-pane" type="button" role="tab" aria-controls="performance-pane" aria-selected="false">Performance de Vendas</button>
                        </li>
                    </ul>
                    <div class="p-3">
                        <button id="btn-nova-venda" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#novaVendaModal">
                            + Nova Venda
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="tab-content" id="myTabContent">
                    <div class="tab-pane fade show active" id="visao-geral-pane" role="tabpanel" aria-labelledby="visao-geral-tab">
                        <ul class="nav nav-tabs mb-3" id="vendas-tabs-filter" role="tablist"></ul>
                        <div id="filtros-container" class="row g-3 align-items-center mb-3 p-3 bg-light border rounded"></div>
                        <div id="status-counters-container" class="status-counters"></div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>#ID</th>
                                        <th>Cliente</th>
                                        <th>Plano</th>
                                        <th class="coluna-vendedor">Vendedor</th>
                                        <th>Status</th>
                                        <th>Data</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tabela-vendas"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="performance-pane" role="tabpanel" aria-labelledby="performance-tab">
                        <div id="performance-content">
                             <div class="text-center p-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Carregando...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="modal fade" id="novaVendaModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="novaVendaModalLabel">Cadastrar Nova Venda</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="etapa-forma-entrada">
                        <h5>Qual a forma de entrada da Venda?</h5>
                        <select class="form-select" id="forma_entrada">
                            <option value="" selected disabled>Selecione...</option>
                            <option value="APP">VENDA NO APP</option>
                            <option value="SEM_APP">VENDA SEM APP</option>
                        </select>
                    </div>

                    <form id="form-nova-venda" class="hidden">
                        <hr>
                        <h5>Dados do Cliente</h5>
                        <div class="row mb-3">
                            <div class="col-md-6 position-relative">
                                <label for="cliente_cpf_cnpj" class="form-label">CPF/CNPJ*</label>
                                <input type="text" class="form-control uppercase-input" id="cliente_cpf_cnpj" required autocomplete="off">
                                <div id="cpf-search-results" class="search-results rounded-bottom shadow-sm hidden"></div>
                            </div>
                            <div class="col-md-6">
                                <label for="cliente_nome" class="form-label">Nome / Razão Social*</label>
                                <input type="text" class="form-control uppercase-input" id="cliente_nome" required>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-12">
                                <label for="cliente_email" class="form-label">E-mail</label>
                                <input type="email" class="form-control" id="cliente_email">
                            </div>
                        </div>
                        <div id="campo-representante-legal" class="row mb-3 hidden">
                                <div class="col-md-6">
                                <label for="cpf_representante_legal" class="form-label">CPF do Representante Legal*</label>
                                <input type="text" class="form-control uppercase-input" id="cpf_representante_legal">
                            </div>
                        </div>
                        <div id="campos-venda-sem-app" class="hidden">
                            <h5>Contatos (Venda Sem App)</h5>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="telefone1" class="form-label">Telefone 1*</label>
                                    <input type="tel" class="form-control" id="telefone1">
                                </div>
                                <div class="col-md-6">
                                    <label for="telefone2" class="form-label">Telefone 2</label>
                                    <input type="tel" class="form-control" id="telefone2">
                                </div>
                            </div>
                        </div>

                        <h5>Endereço de Instalação</h5>
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="cep" class="form-label">CEP</label>
                                <input type="text" class="form-control" id="cep">
                            </div>
                            <div class="col-md-7">
                                <label for="logradouro" class="form-label">Logradouro</label>
                                <input type="text" class="form-control uppercase-input" id="logradouro">
                            </div>
                            <div class="col-md-2">
                                <label for="estado" class="form-label">UF</label>
                                <input type="text" class="form-control uppercase-input" id="estado" readonly>
                            </div>
                        </div>
                        <div class="row mb-3">
                                <div class="col-md-4">
                                <label for="numero" class="form-label">Número (Fachada)*</label>
                                <input type="text" class="form-control uppercase-input" id="numero" required>
                            </div>
                                <div class="col-md-4">
                                <label for="complemento" class="form-label">Complemento</label>
                                <input type="text" class="form-control uppercase-input" id="complemento">
                            </div>
                            <div class="col-md-4">
                                <label for="bairro" class="form-label">Bairro</label>
                                <input type="text" class="form-control uppercase-input" id="bairro">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label for="cidade" class="form-label">Cidade</label>
                                <input type="text" class="form-control uppercase-input" id="cidade">
                            </div>
                        </div>

                        <div class="row mb-3">
                             <div class="col-md-12">
                                <label for="ponto_referencia" class="form-label">Ponto de Referência*</label>
                                <input type="text" class="form-control uppercase-input" id="ponto_referencia" required>
                            </div>
                        </div>
                        <div class="row mb-3">
                             <div class="col-md-12">
                                <label for="observacoes" class="form-label">Observações</label>
                                <textarea class="form-control" id="observacoes" rows="2"></textarea>
                            </div>
                        </div>

                        <hr>
                        <h5>Dados da Venda</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="forma-pagamento" class="form-label">Forma de Pagamento*</label>
                                <select class="form-select" id="forma-pagamento" required onchange="atualizarPrecoExibido()"></select>
                            </div>
                            <div class="col-md-6">
                                <label for="plano" class="form-label">Plano*</label>
                                <select class="form-select" id="plano" required onchange="atualizarPrecoExibido()"></select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="btn-salvar-venda" form="form-nova-venda" disabled>Salvar Venda</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="avisoClienteExistenteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Atenção: Cliente já Cadastrado</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Este cliente já possui <strong id="vendas-count">0</strong> venda(s) registrada(s).</p>
                    <p>Esta nova venda terá uma auditoria mais detalhada. Deseja continuar?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" id="btn-outro-cpf">Informar Outro CPF</button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Sim, Continuar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal-editar-venda" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Venda #<span id="editar-venda-id"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="form-editar-venda">
                        <input type="hidden" id="edit-venda-id-hidden">

                        <div class="row bg-light p-3 mb-4 rounded border">
                            <div class="col-md-6">
                                <label for="edit-cliente-nome" class="form-label fw-bold">Cliente</label>
                                <input type="text" class="form-control" id="edit-cliente-nome">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">CPF/CNPJ</label>
                                <p id="edit-cliente-cpf-cnpj" class="form-control-plaintext ps-2">Carregando...</p>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-lg-3 col-md-6 mb-4">
                                <h6>Dados da Venda</h6>
                                <div class="mb-3">
                                    <label for="edit-plano" class="form-label">Plano</label>
                                    <select id="edit-plano" class="form-select"></select>
                                </div>
                                <div class="mb-3">
                                    <label for="edit-forma-pagamento" class="form-label">Forma de Pagamento</label>
                                    <select id="edit-forma-pagamento" class="form-select"></select>
                                </div>
                                <div class="mb-3">
                                    <label for="edit-vendedor" class="form-label">Vendedor</label>
                                    <select id="edit-vendedor" class="form-select"></select>
                                </div>
                                <hr>
                                <h6>Status</h6>
                                <div class="mb-3">
                                    <label for="edit-status-tratamento" class="form-label">Status Tratamento</label>
                                    <select id="edit-status-tratamento" class="form-select"></select>
                                </div>
                                <div class="mb-3">
                                    <label for="edit-status-esteira" class="form-label">Status Esteira</label>
                                    <select id="edit-status-esteira" class="form-select"></select>
                                </div>
                                <div class="mb-3">
                                    <label for="edit-status-comissionamento" class="form-label">Status Comissionamento</label>
                                    <select id="edit-status-comissionamento" class="form-select"></select>
                                </div>
                            </div>

                            <div class="col-lg-3 col-md-6 mb-4">
                                <h6>Contato</h6>
                                 <div class="mb-3">
                                    <label for="edit-telefone1" class="form-label">Telefone 1</label>
                                    <input type="tel" class="form-control" id="edit-telefone1">
                                </div>
                                <div class="mb-3">
                                    <label for="edit-telefone2" class="form-label">Telefone 2</label>
                                    <input type="tel" class="form-control" id="edit-telefone2">
                                </div>
                                <hr>
                                <h6>Agendamento e OS</h6>
                                <div class="mb-3">
                                    <label for="edit-ordem-servico" class="form-label">Ordem de Serviço (O.S)</label>
                                    <input type="text" class="form-control" id="edit-ordem-servico">
                                </div>
                                <div class="mb-3">
                                    <label for="edit-data-pedido" class="form-label">Data do Pedido</label>
                                    <input type="datetime-local" class="form-control" id="edit-data-pedido">
                                </div>
                                <div class="mb-3">
                                    <label for="edit-data-agendamento" class="form-label">Data de Agendamento</label>
                                    <input type="date" class="form-control" id="edit-data-agendamento">
                                </div>
                                <div class="mb-3">
                                    <label for="edit-periodo-agendamento" class="form-label">Período</label>
                                    <select class="form-select" id="edit-periodo-agendamento">
                                        <option value="">Nenhum</option>
                                        <option value="MANHA">Manhã</option>
                                        <option value="TARDE">Tarde</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-lg-3 col-md-6 mb-4">
                                <h6>Endereço de Instalação</h6>
                                <div class="mb-3">
                                    <label for="edit-cep" class="form-label">CEP</label>
                                    <input type="text" class="form-control" id="edit-cep">
                                </div>
                                <div class="mb-3">
                                    <label for="edit-logradouro" class="form-label">Logradouro</label>
                                    <input type="text" class="form-control" id="edit-logradouro">
                                </div>
                                <div class="row mb-3">
                                    <div class="col-8"><label for="edit-bairro" class="form-label">Bairro</label><input type="text" class="form-control" id="edit-bairro"></div>
                                    <div class="col-4"><label for="edit-numero" class="form-label">Número</label><input type="text" class="form-control" id="edit-numero"></div>
                                </div>
                                <div class="mb-3">
                                    <label for="edit-complemento" class="form-label">Complemento</label>
                                    <input type="text" class="form-control" id="edit-complemento">
                                </div>
                                <div class="row">
                                    <div class="col-8"><label for="edit-cidade" class="form-label">Cidade</label><input type="text" class="form-control" id="edit-cidade"></div>
                                    <div class="col-4"><label for="edit-estado" class="form-label">UF</label><input type="text" class="form-control" id="edit-estado"></div>
                                </div>
                            </div>

                            <div class="col-lg-3 col-md-6 mb-4">
                                <h6>Dados Complementares</h6>
                                <div class="mb-3">
                                    <label for="edit-ponto-referencia" class="form-label">Ponto de Referência*</label>
                                    <input type="text" class="form-control" id="edit-ponto-referencia" required>
                                </div>
                                <div class="mb-3">
                                    <label for="edit-observacoes" class="form-label">Observações</label>
                                    <textarea class="form-control" id="edit-observacoes" rows="8"></textarea>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarEdicaoVenda()">Salvar Alterações</button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'js/auth.js' %}"></script>
    <script>
        let listaPlanos = [];
        let listaFormasPagamento = [];
        const VALOR_DESCONTO = 10.00;
        let currentUser = { id: null, profile: null, isSuperuser: false, username: '' };

        function jwt_decode(token) {
            try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return null; }
        }

        document.addEventListener('DOMContentLoaded', function() {
            verificarAutenticacao();
            const token = localStorage.getItem('accessToken');
            if (!token) { window.location.href = '/'; return; }
            const decodedToken = jwt_decode(token);
            if (!decodedToken) { logout(); return; }
            currentUser = {
                id: decodedToken.user_id,
                profile: decodedToken.perfil,
                isSuperuser: decodedToken.is_superuser,
                username: decodedToken.username
            };
            const perfisPermitidos = ['Admin', 'Vendedor', 'Supervisor', 'Gerente', 'BackOffice', 'Diretoria'];
            if (!currentUser.profile || !perfisPermitidos.includes(currentUser.profile)) {
                alert('Você não tem permissão para acessar esta página.');
                window.location.href = '/area-interna/';
                return;
            }
            if (currentUser.username) { document.getElementById('welcome-user').textContent = `Bem-vindo, ${currentUser.username}!`; }
            document.getElementById('logoutButton').addEventListener('click', logout);
            document.getElementById('edit-cep').addEventListener('blur', buscarCepEdit);
            
            setupInterfaceVisaoGeral();
            carregarDadosIniciaisVisaoGeral();
            setupFormularioInteligente();

            const performanceTab = document.getElementById('performance-tab');
            let performanceLoaded = false;
            performanceTab.addEventListener('shown.bs.tab', function (event) {
                if (!performanceLoaded) {
                    carregarPerformanceVendas();
                    performanceLoaded = true;
                }
            });
        });
        
        // ===============================================
        //  SEÇÃO: PERFORMANCE DE VENDAS (ATUALIZADA)
        // ===============================================
        
        async function carregarPerformanceVendas() {
            const container = document.getElementById('performance-content');
            container.innerHTML = `<div class="text-center p-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div></div>`;
            try {
                const response = await apiClient.get('/api/crm/relatorios/performance-vendas/');
                if (!Array.isArray(response.data)) {
                    throw new Error("A resposta da API não está no formato esperado.");
                }
                renderizarTabelasPerformance(response.data);
            } catch (error) {
                console.error('Erro ao carregar performance de vendas:', error);
                let errorMessage = "Não foi possível carregar os dados de performance. Tente novamente mais tarde.";
                if (error.response) {
                    console.error("Dados do erro:", error.response.data);
                    errorMessage += ` (Erro no servidor: ${error.response.status})`;
                } else if (error.request) {
                    errorMessage = "Não foi possível conectar ao servidor. Verifique sua conexão.";
                } else {
                    errorMessage = `Erro ao processar os dados: ${error.message}`;
                }
                container.innerHTML = `<div class="alert alert-danger">${errorMessage}</div>`;
            }
        }

        function renderizarTabelasPerformance(data) {
            const container = document.getElementById('performance-content');
            container.innerHTML = '';
            
            if (!data || data.length === 0) {
                 container.innerHTML = `<div class="alert alert-info">Nenhum dado de performance encontrado para sua equipe.</div>`;
                 return;
            }

            const today = new Date();
            const dia = String(today.getDate()).padStart(2, '0');
            const mes = String(today.getMonth() + 1).padStart(2, '0');
            
            let dailyHtml = '';
            data.forEach(team => {
                dailyHtml += `
                    <h5 class="mt-4 mb-3 team-header">Equipe: ${team.supervisor_name}</h5>
                    <div class="table-responsive">
                    <table class="table table-bordered table-striped table-sm">
                        <thead class="table-dark">
                            <tr><th>Vendedor</th><th>Vendas</th></tr>
                        </thead>
                        <tbody>
                            ${team.members.map(m => `<tr><td>${m.name.toUpperCase()}</td><td>${m.daily}</td></tr>`).join('')}
                            <tr class="total-row"><td>TOTAL EQUIPE</td><td>${team.totals.daily}</td></tr>
                        </tbody>
                    </table></div>`;
            });

            let monthlyHtml = '';
            data.forEach(team => {
                monthlyHtml += `
                    <h5 class="mt-4 mb-3 team-header">Equipe: ${team.supervisor_name}</h5>
                    <div class="table-responsive">
                    <table class="table table-bordered table-striped table-sm text-center">
                        <thead class="table-dark">
                            <tr>
                                <th class="text-start">Vendedor</th>
                                <th>Vendas</th><th>Instalados</th><th>Aprov. (%)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${team.members.map(m => `
                                <tr>
                                    <td class="text-start">${m.name.toUpperCase()}</td>
                                    <td>${m.monthly.total}</td>
                                    <td>${m.monthly.instalados}</td>
                                    <td>${m.monthly.aproveitamento}</td>
                                </tr>`).join('')}
                            <tr class="total-row">
                                <td class="text-start">TOTAL EQUIPE</td>
                                <td>${team.totals.monthly.total}</td>
                                <td>${team.totals.monthly.instalados}</td>
                                <td>${team.totals.monthly.aproveitamento}</td>
                            </tr>
                        </tbody>
                    </table></div>`;
            });
            
            let weeklyHtml = '';
            data.forEach(team => {
                weeklyHtml += `
                    <h5 class="mt-4 mb-3 team-header">Equipe: ${team.supervisor_name}</h5>
                    <div class="table-responsive">
                    <table class="table table-bordered table-striped table-sm text-center">
                        <thead class="table-dark">
                            <tr>
                                <th class="text-start">Vendedor</th>
                                <th>Seg</th><th>Ter</th><th>Qua</th><th>Qui</th><th>Sex</th><th>Sáb</th><th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${team.members.map(m => `
                                <tr>
                                    <td class="text-start">${m.name.toUpperCase()}</td>
                                    <td>${m.weekly_breakdown.seg}</td>
                                    <td>${m.weekly_breakdown.ter}</td>
                                    <td>${m.weekly_breakdown.qua}</td>
                                    <td>${m.weekly_breakdown.qui}</td>
                                    <td>${m.weekly_breakdown.sex}</td>
                                    <td>${m.weekly_breakdown.sab}</td>
                                    <td class="fw-bold">${m.weekly_total}</td>
                                </tr>`).join('')}
                            <tr class="total-row">
                                <td class="text-start">TOTAL EQUIPE</td>
                                <td>${team.totals.weekly_breakdown.seg}</td>
                                <td>${team.totals.weekly_breakdown.ter}</td>
                                <td>${team.totals.weekly_breakdown.qua}</td>
                                <td>${team.totals.weekly_breakdown.qui}</td>
                                <td>${team.totals.weekly_breakdown.sex}</td>
                                <td>${team.totals.weekly_breakdown.sab}</td>
                                <td class="fw-bold">${team.totals.weekly_total}</td>
                            </tr>
                        </tbody>
                    </table></div>`;
            });

            container.innerHTML = `
                <div class="row">
                    <div class="col-lg-6 mb-4 mb-lg-0">
                        <h4>Resultado Diário: ${dia}/${mes}</h4>
                        ${dailyHtml}
                    </div>
                    <div class="col-lg-6">
                        <h4>Resultado do Mês</h4>
                        ${monthlyHtml}
                    </div>
                </div>
                <hr class="my-4">
                <div class="row">
                    <div class="col-12">
                        <h4>Resultado da Semana</h4>
                        ${weeklyHtml}
                    </div>
                </div>
            `;
        }


        // ===============================================
        //  SEÇÃO: VISÃO GERAL (FUNÇÕES ORIGINAIS)
        // ===============================================

        function determinarStatusExibicao(venda) {
            const comissionamento = venda.status_comissionamento;
            const esteira = venda.status_esteira;
            const tratamento = venda.status_tratamento;
            let statusInfo = { texto: 'N/A', cor: 'bg-secondary' };
            if (comissionamento && comissionamento.estado === 'Fechado') {
                statusInfo.texto = comissionamento.nome;
                statusInfo.cor = 'bg-success';
                return statusInfo;
            }
            if (esteira && esteira.estado === 'Fechado') {
                statusInfo.texto = esteira.nome;
                if (esteira.nome.toLowerCase().includes('cancelada')) {
                    statusInfo.cor = 'bg-danger';
                } else {
                    statusInfo.cor = 'bg-primary';
                }
                if (comissionamento) {
                    statusInfo.texto += ` (${comissionamento.nome} Comiss.)`;
                    statusInfo.cor = 'bg-info text-dark';
                }
                return statusInfo;
            }
            if (esteira) {
                statusInfo.texto = esteira.nome;
                statusInfo.cor = 'bg-warning text-dark';
                return statusInfo;
            }
            if (tratamento) {
                statusInfo.texto = tratamento.nome;
                statusInfo.cor = 'bg-light text-dark';
                return statusInfo;
            }
            return statusInfo;
        }

        function getFiltrosAtuais() {
            const view = document.querySelector('#vendas-tabs-filter .nav-link.active')?.dataset.view || 'minhas_vendas';
            const dataInicio = document.getElementById('filtro-data-inicio')?.value;
            const dataFim = document.getElementById('filtro-data-fim')?.value;
            const consultorId = document.getElementById('filtro-consultor')?.value;
            const ordemServico = document.getElementById('filtro-os')?.value;
            return { view, dataInicio, dataFim, consultorId, ordemServico };
        }

        function construirQueryString() {
            const filtros = getFiltrosAtuais();
            const params = new URLSearchParams();
            params.append('view', filtros.view);
            if (filtros.dataInicio) params.append('data_inicio', filtros.dataInicio);
            if (filtros.dataFim) params.append('data_fim', filtros.dataFim);
            if (filtros.consultorId) params.append('consultor_id', filtros.consultorId);
            if (filtros.ordemServico) params.append('ordem_servico', filtros.ordemServico);
            return params.toString();
        }

        async function carregarDadosIniciaisVisaoGeral() {
            await Promise.all([ carregarPlanos(), carregarFormasPagamento() ]);
            await popularFiltroConsultor();
            atualizarTudoVisaoGeral();
        }

        function atualizarTudoVisaoGeral() {
            carregarVendas();
            carregarContadores();
        }

        async function carregarVendas() {
            const tabelaBody = document.getElementById('tabela-vendas');
            tabelaBody.innerHTML = `<tr><td colspan="7" class="text-center">Carregando...</td></tr>`;
            try {
                const queryString = construirQueryString();
                const response = await apiClient.get(`/api/crm/vendas/?${queryString}`);
                const vendas = response.data;
                tabelaBody.innerHTML = '';
                const mostrarColunaVendedor = ['Supervisor', 'BackOffice', 'Admin', 'Diretoria'].includes(currentUser.profile) || currentUser.isSuperuser;
                document.querySelector('.coluna-vendedor').style.display = mostrarColunaVendedor ? 'table-cell' : 'none';

                if (!vendas || vendas.length === 0) {
                    const colspan = mostrarColunaVendedor ? 7 : 6;
                    tabelaBody.innerHTML = `<tr><td colspan="${colspan}" class="text-center">Nenhuma venda encontrada para os filtros selecionados.</td></tr>`;
                } else {
                    vendas.forEach(venda => {
                        const tr = document.createElement('tr');
                        tr.id = `venda-row-${venda.id}`;
                        const dataFormatada = new Date(venda.data_criacao).toLocaleDateString('pt-BR');
                        const planoNome = venda.plano ? venda.plano.nome : 'Não informado';
                        const colunaVendedorHtml = mostrarColunaVendedor ? `<td>${venda.vendedor.username}</td>` : '';
                        const statusInfo = determinarStatusExibicao(venda);
                        tr.innerHTML = `
                            <td>${venda.id}</td>
                            <td>${venda.cliente.nome_razao_social}</td>
                            <td>${planoNome}</td>
                            ${colunaVendedorHtml}
                            <td><span class="badge ${statusInfo.cor}">${statusInfo.texto}</span></td>
                            <td>${dataFormatada}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-warning" onclick="editarVenda(${venda.id})" title="Editar Venda"><i class="bi bi-pencil-square"></i></button>
                                <button class="btn btn-sm btn-outline-danger" onclick="excluirVenda(${venda.id})" title="Excluir Venda"><i class="bi bi-trash"></i></button>
                            </td>
                        `;
                        tabelaBody.appendChild(tr);
                    });
                }
            } catch (error) {
                console.error('Falha ao carregar vendas:', error);
                const colspan = document.querySelector('.coluna-vendedor').style.display === 'table-cell' ? 7 : 6;
                tabelaBody.innerHTML = `<tr><td colspan="${colspan}" class="text-center text-danger">Erro ao carregar vendas.</td></tr>`;
            }
        }
        
        async function carregarContadores() {
            const container = document.getElementById('status-counters-container');
            container.innerHTML = 'Carregando contadores...';

            try {
                const queryString = construirQueryString();
                const response = await apiClient.get(`/api/crm/vendas/status-counts/?${queryString}`);
                const data = response.data;
                
                container.innerHTML = '';
                
                if (Object.keys(data).length === 0) {
                    container.innerHTML = '<p class="text-muted">Nenhum status para exibir.</p>';
                    return;
                }

                for (const status in data) {
                    const count = data[status];
                    const statusBox = `
                        <div class="status-box">
                            <div class="count">${count}</div>
                            <div class="label">${status}</div>
                        </div>
                    `;
                    container.innerHTML += statusBox;
                }
            } catch (error) {
                console.error("Erro ao carregar contadores:", error);
                container.innerHTML = '<p class="text-danger">Erro ao carregar contadores.</p>';
            }
        }

        function setupInterfaceVisaoGeral() {
            const { profile, isSuperuser } = currentUser;
            const isGestao = ['Admin', 'Diretoria', 'BackOffice'].includes(profile) || isSuperuser;
            const isSupervisor = profile === 'Supervisor';
            
            const tabsContainer = document.getElementById('vendas-tabs-filter');
            const filtrosContainer = document.getElementById('filtros-container');

            tabsContainer.innerHTML = '';
            if (isGestao) {
                tabsContainer.innerHTML = `
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" data-bs-toggle="tab" data-view="geral" type="button">Visão Geral</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-view="minhas_vendas" type="button">Minhas Vendas</button>
                    </li>`;
            } else if (isSupervisor) {
                 tabsContainer.innerHTML = `
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" data-bs-toggle="tab" data-view="equipe" type="button">Vendas da Equipe</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-view="minhas_vendas" type="button">Minhas Vendas</button>
                    </li>`;
            } else {
                tabsContainer.innerHTML = `
                         <li class="nav-item" role="presentation">
                            <button class="nav-link active" data-bs-toggle="tab" data-view="minhas_vendas" type="button">Minhas Vendas</button>
                        </li>`;
            }
            
            const triggerTabList = document.querySelectorAll('#vendas-tabs-filter .nav-link');
            triggerTabList.forEach(triggerEl => {
                triggerEl.addEventListener('shown.bs.tab', event => {
                    atualizarTudoVisaoGeral();
                });
            });

            filtrosContainer.innerHTML = '';
            let filtrosHTML = '';
            
            if (isGestao || isSupervisor) {
                 filtrosHTML += `
                    <div class="col-lg-3 col-md-6">
                        <label for="filtro-consultor" class="form-label">Consultor</label>
                        <select id="filtro-consultor" class="form-select form-select-sm">
                            <option value="">-- Todos --</option>
                        </select>
                    </div>`;
            }

            if (isGestao) {
                 filtrosHTML += `
                    <div class="col-lg-3 col-md-6">
                        <label for="filtro-data-inicio" class="form-label">Data Início</label>
                        <input type="date" id="filtro-data-inicio" class="form-control form-control-sm">
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label for="filtro-data-fim" class="form-label">Data Fim</label>
                        <input type="date" id="filtro-data-fim" class="form-control form-control-sm">
                    </div>`;
            }
            
            filtrosHTML += `
                <div class="col-lg-2 col-md-6">
                    <label for="filtro-os" class="form-label">O.S</label>
                    <input type="text" id="filtro-os" class="form-control form-control-sm" placeholder="Número...">
                </div>`;

            filtrosHTML += `
                <div class="col-lg-1 col-md-12 d-flex align-items-end">
                     <button id="btn-aplicar-filtros" class="btn btn-sm btn-secondary w-100">Aplicar</button>
                </div>
            `;
            
            filtrosContainer.innerHTML = filtrosHTML;
            if (!isGestao && !isSupervisor) {
                filtrosContainer.classList.add('hidden');
            }
            
            document.getElementById('btn-aplicar-filtros').addEventListener('click', atualizarTudoVisaoGeral);
        }
        
        async function popularFiltroConsultor() {
            const selectConsultor = document.getElementById('filtro-consultor');
            if (!selectConsultor) return;

            try {
                const response = await apiClient.get('/api/usuarios/');
                let usuarios = response.data;
                
                if (currentUser.profile === 'Supervisor') {
                    const lideradosIds = usuarios.find(u => u.id === currentUser.id)?.liderados || [];
                    usuarios = usuarios.filter(u => lideradosIds.includes(u.id) || u.id === currentUser.id);
                }

                usuarios.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.username;
                    selectConsultor.appendChild(option);
                });
            } catch(error) {
                console.error("Erro ao popular filtro de consultor:", error);
                selectConsultor.innerHTML = '<option value="">Erro ao carregar</option>';
            }
        }

        async function carregarPlanos() {
            try {
                const response = await apiClient.get('/api/crm/planos/');
                listaPlanos = response.data;
                const selectPlano = document.getElementById('plano');
                selectPlano.innerHTML = '<option value="">Selecione um plano</option>';
                listaPlanos.forEach(plano => {
                    selectPlano.innerHTML += `<option value="${plano.id}" data-valor-base="${plano.valor}">${plano.nome} - R$ ${plano.valor}</option>`;
                });
            } catch (error) {
                console.error("Erro ao carregar planos:", error);
                document.getElementById('plano').innerHTML = '<option value="">Erro ao carregar planos</option>';
            }
        }

        async function carregarFormasPagamento() {
            try {
                const response = await apiClient.get('/api/crm/formas-pagamento/');
                listaFormasPagamento = response.data;
                const selectForma = document.getElementById('forma-pagamento');
                selectForma.innerHTML = '<option value="">Selecione a forma de pagamento</option>';
                listaFormasPagamento.forEach(forma => {
                    selectForma.innerHTML += `<option value="${forma.id}" data-aplica-desconto="${forma.aplica_desconto}">${forma.nome}</option>`;
                });
            } catch (error) {
                console.error("Erro ao carregar formas de pagamento:", error);
                document.getElementById('forma-pagamento').innerHTML = '<option value="">Erro ao carregar opções</option>';
            }
        }

        function atualizarPrecoExibido() {
            const planoSelect = document.getElementById('plano');
            const formaPagamentoSelect = document.getElementById('forma-pagamento');
            const planoId = planoSelect.value;
            const formaPagamentoOption = formaPagamentoSelect.options[formaPagamentoSelect.selectedIndex];

            if (!planoId || !formaPagamentoOption || !formaPagamentoOption.value) {
                planoSelect.querySelectorAll('option').forEach(option => {
                    if(option.value && option.dataset.valorBase) {
                        const plano = listaPlanos.find(p => p.id == option.value);
                        option.textContent = `${plano.nome} - R$ ${plano.valor}`;
                    }
                });
                return;
            }

            const aplicaDesconto = formaPagamentoOption.dataset.aplicaDesconto === 'true';

            planoSelect.querySelectorAll('option').forEach(option => {
                if(option.value && option.dataset.valorBase) {
                    const plano = listaPlanos.find(p => p.id == option.value);
                    const valorBase = parseFloat(option.dataset.valorBase);
                    let valorFinal = valorBase;

                    if (aplicaDesconto) {
                        valorFinal = valorBase - VALOR_DESCONTO;
                    }
                    option.textContent = `${plano.nome} - R$ ${valorFinal.toFixed(2)}`;
                }
            });
        }

        function setupFormularioInteligente() {
            const modal = document.getElementById('novaVendaModal');
            const selectFormaEntrada = document.getElementById('forma_entrada');
            const formCompleto = document.getElementById('form-nova-venda');
            const camposVendaSemApp = document.getElementById('campos-venda-sem-app');
            const inputCpfCnpj = document.getElementById('cliente_cpf_cnpj');
            const searchResultsDiv = document.getElementById('cpf-search-results');
            const campoRepresentante = document.getElementById('campo-representante-legal');
            const inputRepresentante = document.getElementById('cpf_representante_legal');
            const btnSalvar = document.getElementById('btn-salvar-venda');
            let debounceTimer;

            selectFormaEntrada.addEventListener('change', function() {
                const valor = this.value;
                if (valor) {
                    formCompleto.classList.remove('hidden');
                    btnSalvar.disabled = false;
                    if (valor === 'SEM_APP') {
                        camposVendaSemApp.classList.remove('hidden');
                        document.getElementById('telefone1').required = true;
                    } else {
                        camposVendaSemApp.classList.add('hidden');
                        document.getElementById('telefone1').required = false;
                    }
                }
            });

            inputCpfCnpj.addEventListener('keyup', (e) => {
                if (['ArrowUp', 'ArrowDown', 'Enter', 'Tab'].includes(e.key)) return;
                clearTimeout(debounceTimer);
                const query = inputCpfCnpj.value.replace(/\D/g, '');

                if (query.length > 11) {
                    campoRepresentante.classList.remove('hidden');
                    inputRepresentante.required = true;
                } else {
                    campoRepresentante.classList.add('hidden');
                    inputRepresentante.required = false;
                }

                if (query.length < 3) { searchResultsDiv.classList.add('hidden'); return; }
                debounceTimer = setTimeout(() => buscarClientes(query), 300);
            });

            document.addEventListener('click', (e) => {
                if (!inputCpfCnpj.contains(e.target)) { searchResultsDiv.classList.add('hidden'); }
            });

            modal.addEventListener('hidden.bs.modal', function () {
                formCompleto.classList.add('hidden');
                selectFormaEntrada.value = '';
                btnSalvar.disabled = true;
                formCompleto.reset();
                camposVendaSemApp.classList.add('hidden');
                campoRepresentante.classList.add('hidden');
                searchResultsDiv.classList.add('hidden');
                atualizarPrecoExibido();
            });
        }

        async function buscarClientes(query) {
            const searchResultsDiv = document.getElementById('cpf-search-results');
            try {
                const response = await apiClient.get(`/api/crm/clientes/?search=${query}`);
                const clientes = response.data;
                searchResultsDiv.innerHTML = '';
                if (clientes.length > 0) {
                    searchResultsDiv.classList.remove('hidden');
                    clientes.forEach(cliente => {
                        const item = document.createElement('div');
                        item.className = 'search-results-item';
                        item.innerHTML = `<strong>${cliente.cpf_cnpj}</strong> - ${cliente.nome_razao_social}`;
                        item.onclick = () => selecionarCliente(cliente);
                        searchResultsDiv.appendChild(item);
                    });
                } else {
                    searchResultsDiv.classList.add('hidden');
                }
            } catch (error) {
                console.error("Erro ao buscar clientes:", error);
                searchResultsDiv.classList.add('hidden');
            }
        }

        function selecionarCliente(cliente) {
            document.getElementById('cliente_cpf_cnpj').value = cliente.cpf_cnpj;
            document.getElementById('cliente_nome').value = cliente.nome_razao_social;
            document.getElementById('cliente_email').value = cliente.email || '';
            document.getElementById('cpf-search-results').classList.add('hidden');
            document.getElementById('cliente_cpf_cnpj').dispatchEvent(new Event('keyup'));

            if (cliente.vendas_count > 0) {
                mostrarAvisoClienteExistente(cliente.vendas_count);
            }
        }

        function mostrarAvisoClienteExistente(vendasCount) {
            const avisoModalEl = document.getElementById('avisoClienteExistenteModal');
            const avisoModal = new bootstrap.Modal(avisoModalEl);
            document.getElementById('vendas-count').textContent = vendasCount;
            document.getElementById('btn-outro-cpf').onclick = () => {
                document.getElementById('cliente_cpf_cnpj').value = '';
                document.getElementById('cliente_nome').value = '';
                document.getElementById('cliente_email').value = '';
                avisoModal.hide();
                document.getElementById('cliente_cpf_cnpj').focus();
            };
            avisoModal.show();
        }

        document.getElementById('cep').addEventListener('blur', async function(e) {
            const cep = e.target.value.replace(/\D/g, '');
            if (cep.length !== 8) return;
            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                if (!response.ok) return;
                const data = await response.json();
                if (!data.erro) {
                    document.getElementById('logradouro').value = data.logradouro.toUpperCase();
                    document.getElementById('bairro').value = data.bairro.toUpperCase();
                    document.getElementById('cidade').value = data.localidade.toUpperCase();
                    document.getElementById('estado').value = data.uf.toUpperCase();
                    document.getElementById('numero').focus();
                }
            } catch (error) {
                console.error('Erro ao buscar CEP:', error);
            }
        });

        document.getElementById('form-nova-venda').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const vendaData = {
                forma_entrada: document.getElementById('forma_entrada').value,
                cliente_cpf_cnpj: document.getElementById('cliente_cpf_cnpj').value,
                cliente_nome_razao_social: document.getElementById('cliente_nome').value,
                cliente_email: document.getElementById('cliente_email').value,
                cpf_representante_legal: document.getElementById('cpf_representante_legal').value,
                telefone1: document.getElementById('telefone1').value,
                telefone2: document.getElementById('telefone2').value,
                cep: document.getElementById('cep').value,
                logradouro: document.getElementById('logradouro').value,
                numero_residencia: document.getElementById('numero').value,
                complemento: document.getElementById('complemento').value,
                bairro: document.getElementById('bairro').value,
                cidade: document.getElementById('cidade').value,
                estado: document.getElementById('estado').value,
                forma_pagamento: parseInt(document.getElementById('forma-pagamento').value),
                plano: parseInt(document.getElementById('plano').value),
                ponto_referencia: document.getElementById('ponto_referencia').value,
                observacoes: document.getElementById('observacoes').value
            };

            try {
                await apiClient.post('/api/crm/vendas/', vendaData);
                alert('Venda cadastrada com sucesso!');
                const modalElement = document.getElementById('novaVendaModal');
                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                if (modalInstance) { modalInstance.hide(); }
                atualizarTudoVisaoGeral();
            } catch (error) {
                const errorDetail = error.response ? JSON.stringify(error.response.data) : 'Verifique os dados e tente novamente.';
                console.error('Erro ao criar venda:', error.response);
                alert(`Erro ao cadastrar venda. Detalhe: ${errorDetail}`);
            }
        });

        async function editarVenda(vendaId) {
            const modalElement = document.getElementById('modal-editar-venda');
            const modal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);

            document.getElementById('form-editar-venda').reset();
            document.getElementById('edit-cliente-cpf-cnpj').textContent = 'Carregando...';
            document.getElementById('editar-venda-id').textContent = vendaId;
            document.getElementById('edit-venda-id-hidden').value = vendaId;

            try {
                const vendaRes = await apiClient.get(`/api/crm/vendas/${vendaId}/`);
                const venda = vendaRes.data;

                const [planosRes, formasPagamentoRes, statusTratamentoRes, statusEsteiraRes, statusComissaoRes, usuariosRes] = await Promise.all([
                    apiClient.get('/api/crm/planos/'),
                    apiClient.get('/api/crm/formas-pagamento/'),
                    apiClient.get('/api/crm/status/?tipo=Tratamento'),
                    apiClient.get('/api/crm/status/?tipo=Esteira'),
                    apiClient.get('/api/crm/status/?tipo=Comissionamento'),
                    apiClient.get('/api/usuarios/')
                ]);

                populateSelect('edit-plano', planosRes.data, venda.plano);
                populateSelect('edit-forma-pagamento', formasPagamentoRes.data, venda.forma_pagamento);
                populateSelect('edit-vendedor', usuariosRes.data.map(u => ({ id: u.id, nome: u.username })), venda.vendedor);
                populateSelect('edit-status-tratamento', statusTratamentoRes.data, venda.status_tratamento, true);
                populateSelect('edit-status-esteira', statusEsteiraRes.data, venda.status_esteira, true);
                populateSelect('edit-status-comissionamento', statusComissaoRes.data, venda.status_comissionamento, true);

                document.getElementById('edit-cliente-nome').value = venda.cliente_nome_razao_social || '';
                document.getElementById('edit-cliente-cpf-cnpj').textContent = venda.cliente_cpf_cnpj || 'Não informado';
                document.getElementById('edit-telefone1').value = venda.telefone1 || '';
                document.getElementById('edit-telefone2').value = venda.telefone2 || '';
                document.getElementById('edit-ponto-referencia').value = venda.ponto_referencia || '';
                document.getElementById('edit-observacoes').value = venda.observacoes || '';
                document.getElementById('edit-ordem-servico').value = venda.ordem_servico || '';
                document.getElementById('edit-data-agendamento').value = venda.data_agendamento || '';
                document.getElementById('edit-periodo-agendamento').value = venda.periodo_agendamento || '';
                document.getElementById('edit-cep').value = venda.cep || '';
                document.getElementById('edit-logradouro').value = venda.logradouro || '';
                document.getElementById('edit-numero').value = venda.numero_residencia || '';
                document.getElementById('edit-complemento').value = venda.complemento || '';
                document.getElementById('edit-bairro').value = venda.bairro || '';
                document.getElementById('edit-cidade').value = venda.cidade || '';
                document.getElementById('edit-estado').value = venda.estado || '';

                if (venda.data_pedido) {
                    const dataPedido = new Date(venda.data_pedido);
                    dataPedido.setMinutes(dataPedido.getMinutes() - dataPedido.getTimezoneOffset());
                    document.getElementById('edit-data-pedido').value = dataPedido.toISOString().slice(0, 16);
                } else {
                    document.getElementById('edit-data-pedido').value = '';
                }

                modal.show();

            } catch (error) {
                console.error(`Erro ao carregar dados para edição da venda ${vendaId}:`, error);
                alert('Falha ao carregar os dados da venda para edição. Verifique o console para mais detalhes.');
            }
        }

        function populateSelect(selectId, options, selectedValue, includeEmpty = false) {
            const select = document.getElementById(selectId);
            select.innerHTML = '';
            if (includeEmpty) {
                select.innerHTML += '<option value="">Nenhum</option>';
            }
            options.forEach(option => {
                const isSelected = option.id == selectedValue ? 'selected' : '';
                select.innerHTML += `<option value="${option.id}" ${isSelected}>${option.nome || option.username}</option>`;
            });
        }

        async function salvarEdicaoVenda() {
            const vendaId = document.getElementById('edit-venda-id-hidden').value;
            const telefone1 = document.getElementById('edit-telefone1').value;
            const telefone2 = document.getElementById('edit-telefone2').value;
            const phoneRegex = new RegExp('^\\(?[1-9]{2}\\)? ?(9[1-9][0-9]{3}|[2-5][0-9]{3})\\-?[0-9]{4}$');

            if (telefone1 && !phoneRegex.test(telefone1)) {
                alert('Formato do "Telefone 1" é inválido. Use (XX) 9XXXX-XXXX ou (XX) XXXX-XXXX.');
                return;
            }
            if (telefone2 && !phoneRegex.test(telefone2)) {
                alert('Formato do "Telefone 2" é inválido. Use (XX) 9XXXX-XXXX ou (XX) XXXX-XXXX.');
                return;
            }

            const body = {
                cliente_nome_razao_social: document.getElementById('edit-cliente-nome').value,
                plano: document.getElementById('edit-plano').value,
                forma_pagamento: document.getElementById('edit-forma-pagamento').value,
                vendedor: document.getElementById('edit-vendedor').value,
                telefone1: telefone1,
                telefone2: telefone2,
                status_tratamento: document.getElementById('edit-status-tratamento').value || null,
                status_esteira: document.getElementById('edit-status-esteira').value || null,
                status_comissionamento: document.getElementById('edit-status-comissionamento').value || null,
                ordem_servico: document.getElementById('edit-ordem-servico').value,
                data_pedido: document.getElementById('edit-data-pedido').value ? new Date(document.getElementById('edit-data-pedido').value).toISOString() : null,
                data_agendamento: document.getElementById('edit-data-agendamento').value || null,
                periodo_agendamento: document.getElementById('edit-periodo-agendamento').value || null,
                cep: document.getElementById('edit-cep').value,
                logradouro: document.getElementById('edit-logradouro').value,
                numero_residencia: document.getElementById('edit-numero').value,
                complemento: document.getElementById('edit-complemento').value,
                bairro: document.getElementById('edit-bairro').value,
                cidade: document.getElementById('edit-cidade').value,
                estado: document.getElementById('edit-estado').value,
                ponto_referencia: document.getElementById('edit-ponto-referencia').value,
                observacoes: document.getElementById('edit-observacoes').value,
            };

            try {
                await apiClient.patch(`/api/crm/vendas/${vendaId}/`, body);
                const modalElement = document.getElementById('modal-editar-venda');
                const modal = bootstrap.Modal.getInstance(modalElement);
                modal.hide();
                alert('Venda atualizada com sucesso!');
                atualizarTudoVisaoGeral();

            } catch (error) {
                console.error(`Erro ao salvar a venda ${vendaId}:`, error.response?.data);
                const errorDetail = error.response ? JSON.stringify(error.response.data) : 'Erro desconhecido';
                alert(`Falha ao salvar as alterações. Detalhe: ${errorDetail}`);
            }
        }

    async function excluirVenda(vendaId) {
        if (confirm(`Tem certeza que deseja excluir a venda #${vendaId}? Esta ação não pode ser desfeita.`)) {
            try {
                await apiClient.delete(`/api/crm/vendas/${vendaId}/`);
                alert('Venda excluída com sucesso!');
                atualizarTudoVisaoGeral(); 
            } catch (error) {
                console.error("Falha detalhada ao excluir venda:", error); 
                const detail = error?.response?.data?.detail;
                const message = detail || 'Não foi possível conectar ao servidor. Tente novamente.';
                alert(`Erro ao excluir a venda. (Detalhe: ${message})`);
            }
        }
    }

        async function buscarCepEdit(e) {
            const cep = e.target.value.replace(/\D/g, '');
            if (cep.length !== 8) return;
            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                if (!response.ok) throw new Error('Erro na API');
                const data = await response.json();
                if (!data.erro) {
                    document.getElementById('edit-logradouro').value = data.logradouro.toUpperCase();
                    document.getElementById('edit-bairro').value = data.bairro.toUpperCase();
                    document.getElementById('edit-cidade').value = data.localidade.toUpperCase();
                    document.getElementById('edit-estado').value = data.uf.toUpperCase();
                    document.getElementById('edit-numero').focus();
                } else {
                    alert('CEP não encontrado.');
                }
            } catch (error) {
                alert('Não foi possível consultar o CEP.');
            }
        }
    </script>
</body>
</html>