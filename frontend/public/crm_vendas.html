{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM de Vendas - Record PAP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{% static 'css/custom_styles.css' %}?v=2.1">
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
    <style>
        /* Garante visual maiúsculo */
        input[type="text"], textarea { text-transform: uppercase; }
        
        .filter-bar { background: #fff; padding: 15px; border-radius: 12px; border: 1px solid var(--cor-borda); display: flex; gap: 10px; flex-wrap: wrap; align-items: end; }
        .filter-item { flex: 1; min-width: 140px; }
        .status-badge { font-size: 0.8rem; padding: 4px 8px; border-radius: 12px; font-weight: 600; letter-spacing: 0.5px; }
        
        .btn-origem { height: 120px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: bold; transition: transform 0.2s; }
        .btn-origem:hover { transform: scale(1.03); }
        .btn-origem i { font-size: 2.5rem; margin-bottom: 10px; }

        /* Autocomplete */
        #sugestoes-cliente {
            position: absolute; background: white; width: 100%; border: 1px solid #ddd; border-radius: 0 0 8px 8px;
            z-index: 1055; max-height: 200px; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none;
        }
        .sugestao-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .sugestao-item:hover { background-color: #f8f9fa; color: var(--cor-primaria); }

        .nav-tabs .nav-link { color: var(--cor-texto-suave); font-weight: 600; border: none; border-bottom: 3px solid transparent; }
        .nav-tabs .nav-link.active { color: var(--cor-primaria); border-bottom: 3px solid var(--cor-primaria); background: transparent; }
        
        .dash-card { border-radius: 12px; border: none; color: white; padding: 20px; height: 100%; position: relative; overflow: hidden; transition: transform 0.2s; cursor: pointer; }
        .dash-card:hover { transform: translateY(-3px); }
        .dash-card h3 { font-size: 2.5rem; font-weight: bold; margin: 0; }
        .dash-card p { font-size: 0.9rem; opacity: 0.9; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .dash-card .icon-bg { position: absolute; right: -10px; bottom: -10px; font-size: 5rem; opacity: 0.2; transform: rotate(-15deg); }
        .bg-gradient-primary { background: linear-gradient(45deg, #4e73df, #224abe); }
        .bg-gradient-success { background: linear-gradient(45deg, #1cc88a, #13855c); }
        .bg-gradient-info { background: linear-gradient(45deg, #36b9cc, #258391); }
        .bg-gradient-warning { background: linear-gradient(45deg, #f6c23e, #dda20a); color: #fff; }
        
        @media (max-width: 576px) { .header-controls { flex-direction: column; align-items: flex-start; gap: 10px; } .header-controls button { width: 100%; } }
    </style>
</head>
<body>

    <header class="main-header">
        <div class="header-container">
            <a href="/"><img src="{% static 'logo.png' %}" alt="Record PAP Logo" class="logo"></a>
            <button class="menu-toggle" id="menu-toggle"><div class="bar"></div><div class="bar"></div><div class="bar"></div></button>
            <nav class="main-nav" id="main-nav">
                <ul>
                    <li><a href="/crm-vendas/" style="color: var(--cor-primaria);">Nova Venda</a></li>
                    <li><a href="/area-interna/">Voltar</a></li>
                    <li><button onclick="logout()" class="nav-button logout-button">Sair</button></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="area-interna-section">
        <div class="system-container" style="max-width: 1400px;">
            
            <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3 header-controls">
                <div>
                    <h1 style="font-size: 1.8rem; margin: 0;">Vendas</h1>
                    <p class="text-muted mb-0">Gerencie vendas e acompanhe o status.</p>
                </div>
                <button class="btn btn-primary shadow-sm fw-bold" onclick="abrirModalOrigem()">
                    <i class="bi bi-plus-lg"></i> Nova Venda
                </button>
            </div>

            <ul class="nav nav-tabs mb-3" id="abas-navegacao">
                <li class="nav-item"><a class="nav-link active" onclick="alterarAba('minhas_vendas', this)">Minhas Vendas</a></li>
                <li class="nav-item d-none" id="aba-equipe"><a class="nav-link" onclick="alterarAba('equipe', this)">Visão de Equipe</a></li>
                <li class="nav-item"><a class="nav-link" onclick="alterarAba('dashboard', this)">Dashboard</a></li>
            </ul>

            <div id="conteudo-lista">
                <div class="filter-bar mb-4 shadow-sm" id="barra-filtros">
                    <div class="filter-item"><label class="form-label small fw-bold text-muted">Início</label><input type="date" id="filtro-inicio" class="form-control form-control-sm"></div>
                    <div class="filter-item"><label class="form-label small fw-bold text-muted">Fim</label><input type="date" id="filtro-fim" class="form-control form-control-sm"></div>
                    <div class="filter-item d-none" id="container-filtro-vendedor">
                        <label class="form-label small fw-bold text-muted">Vendedor</label>
                        <select id="filtro-vendedor" class="form-select form-select-sm"><option value="">Todos</option></select>
                    </div>
                    <div class="filter-item" style="flex: 0 0 auto;"><button onclick="carregarVendas()" class="btn btn-sm btn-primary w-100"><i class="bi bi-filter"></i> Filtrar</button></div>
                </div>

                <div id="aviso-filtro-bloqueado" class="alert alert-light border mb-3 d-none text-center text-muted">
                    <i class="bi bi-calendar-check"></i> Exibindo vendas do mês atual.
                </div>

                <div class="card border-0 shadow-none">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Data</th>
                                    <th>Cliente</th>
                                    <th>Vendedor</th>
                                    <th>Plano</th>
                                    <th>Status Esteira</th>
                                    <th>Motivo Pendência</th> <th class="text-end">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="tabela-vendas-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="conteudo-dashboard" style="display: none;">
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="dash-card bg-gradient-primary" onclick="abrirDetalheDashboard('TOTAL_REGISTRADAS', 'Vendas Registradas')">
                            <div class="icon-bg"><i class="bi bi-cart-check"></i></div>
                            <p>Vendas Registradas (Mês)</p>
                            <h3 id="dash-total">0</h3>
                            <small id="dash-meta-info" class="text-white-50"></small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="dash-card bg-gradient-info" onclick="abrirDetalheDashboard('TOTAL_INSTALADAS', 'Vendas Instaladas')">
                            <div class="icon-bg"><i class="bi bi-check-circle"></i></div>
                            <p>Vendas Instaladas (Mês)</p>
                            <h3 id="dash-instaladas">0</h3>
                            <small id="dash-aproveitamento" class="text-white-50 fw-bold"></small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="dash-card bg-gradient-success" style="cursor: default; transform: none;">
                            <div class="icon-bg"><i class="bi bi-cash-coin"></i></div>
                            <p>Comissão Estimada</p>
                            <h3 id="dash-comissao">R$ 0,00</h3>
                            <small class="text-white-50">Baseada nas instalações</small>
                        </div>
                    </div>
                </div>
                
                <h5 class="mt-5 mb-3 text-muted">Detalhe por Status</h5>
                <div class="row g-3" id="dash-status-container"></div>
            </div>
        </div>
    </main>

    <div class="modal fade" id="modalDetalheDashboard" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold" id="tituloDetalheDashboard">Detalhes</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="list-group list-group-flush" id="listaDetalheDashboard"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal-origem-venda" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header border-0 pb-0"><h5 class="modal-title fw-bold">Origem da Venda</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body text-center pt-4 pb-5"><p class="text-muted mb-4">Como essa venda foi realizada?</p><div class="row g-3"><div class="col-6"><button onclick="selecionarOrigem('APP')" class="btn btn-outline-primary w-100 btn-origem shadow-sm"><i class="bi bi-phone"></i>Via APP</button></div><div class="col-6"><button onclick="selecionarOrigem('SEM_APP')" class="btn btn-outline-secondary w-100 btn-origem shadow-sm"><i class="bi bi-journal-x"></i>Sem APP</button></div></div></div></div></div></div>
    
    <div class="modal fade" id="modal-aviso-cliente" tabindex="-1" style="z-index: 1060;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-warning">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title fw-bold"><i class="bi bi-exclamation-triangle-fill"></i> Atenção: Cliente Recorrente</h5>
                    <button type="button" class="btn-close" onclick="fecharModalAviso()"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-light border text-center mb-3">
                        <h4 class="fw-bold text-warning" id="aviso-qtd-vendas" style="font-size: 2.5rem;">0</h4>
                        <span class="text-muted text-uppercase small fw-bold">Vendas Ativas Encontradas</span>
                    </div>

                    <p class="text-center mb-3">
                        O cliente <strong id="aviso-nome-cliente"></strong> já possui histórico em nossa base.
                    </p>

                    <div class="alert alert-danger" role="alert">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-shield-lock-fill fs-3 me-3"></i>
                            <div>
                                <strong>Aviso de Segurança:</strong><br>
                                Esta venda passará por uma <u>auditoria mais apurada</u> devido à duplicidade de CPF/CNPJ.
                            </div>
                        </div>
                        <hr>
                        <p class="mb-0 fw-bold text-center small text-uppercase">
                            <i class="bi bi-exclamation-circle"></i> Essa venda poderá gerar uma recompra ou uma venda indevida!
                        </p>
                    </div>

                    <p class="small text-muted text-center mt-3">Deseja continuar com este CPF ou informar um novo?</p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-outline-secondary px-4" onclick="fecharModalAviso()">Informar Outro CPF</button>
                    <button type="button" class="btn btn-warning px-4 fw-bold" onclick="confirmarClienteExistente()">Sim, Continuar Venda</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal-nova-venda" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold" id="titulo-modal-venda">Registrar Venda <span id="badge-origem" class="badge bg-secondary ms-2"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="form-nova-venda">
                        <input type="hidden" name="forma_entrada" id="input-forma-entrada">
                        <input type="hidden" id="id-venda-edicao"> 
                        
                        <h6 class="text-primary border-bottom pb-2 mb-3">Dados do Cliente</h6>
                        <div class="row g-3">
                            <div class="col-12 col-md-6 position-relative">
                                <label>CPF/CNPJ <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="input-cpf" name="cliente_cpf_cnpj" required placeholder="Digite para buscar..." autocomplete="off">
                                <div id="sugestoes-cliente"></div>
                            </div>
                            <div class="col-12 col-md-6"><label>Nome Completo <span class="text-danger">*</span></label><input type="text" class="form-control" id="input-nome" name="cliente_nome_razao_social" required oninput="this.value = this.value.toUpperCase()"></div>
                            <div class="col-12 col-md-6"><label>Nome da Mãe</label><input type="text" class="form-control" id="input-nome-mae" name="nome_mae" oninput="this.value = this.value.toUpperCase()"></div>
                            <div class="col-12 col-md-6"><label>Data Nascimento</label><input type="date" class="form-control" id="input-data-nascimento" name="data_nascimento"></div>
                            <div class="col-12 col-md-6"><label>Email</label><input type="email" class="form-control" id="input-email" name="cliente_email"></div>
                            
                            <div class="col-12 col-md-6">
                                <div class="row g-2">
                                    <div class="col-6">
                                        <label>Telefone 1 (WhatsApp) <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="input-telefone" name="telefone1" required onblur="verificarWhatsApp(this)">
                                        <div id="feedback-whatsapp" class="form-text mt-1" style="font-size: 0.8rem; min-height: 1.2em;"></div>
                                    </div>
                                    <div class="col-6">
                                        <label>Telefone 2 <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="input-telefone2" name="telefone2" required>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <div id="area-representante" class="row g-3 mt-2" style="display: none; background-color: #f8f9fa; padding: 10px; border-radius: 8px; border: 1px solid #e9ecef;">
                            <div class="col-12"><h6 class="text-secondary border-bottom pb-2 mb-0" style="font-size: 0.9rem;">Representante Legal (Obrigatório para CNPJ)</h6></div>
                            <div class="col-12 col-md-6"><label>CPF do Representante <span class="text-danger">*</span></label><input type="text" class="form-control" id="input-cpf-rep" name="cpf_representante_legal"></div>
                            <div class="col-12 col-md-6"><label>Nome do Representante</label><input type="text" class="form-control" id="input-nome-rep" name="nome_representante_legal" readonly style="background-color: #e9ecef;" oninput="this.value = this.value.toUpperCase()"></div>
                        </div>

                        <h6 class="text-primary border-bottom pb-2 mb-3 mt-4">Dados da Venda</h6>
                        <div class="row g-3">
                            <div class="col-12 col-md-6"><label>Plano <span class="text-danger">*</span></label><select class="form-select" name="plano" id="select-plano" required></select></div>
                            <div class="col-12 col-md-6"><label>Forma de Pagamento <span class="text-danger">*</span></label><select class="form-select" name="forma_pagamento" id="select-pagamento" required></select></div>
                            
                            <div class="col-12 col-md-6 d-none" id="container-status-esteira">
                                <label class="fw-bold text-success">Status Atual (Esteira)</label>
                                <select class="form-select border-success" name="status_esteira" id="select-status-esteira"></select>
                            </div>

                            <div class="col-12 col-md-6 d-none" id="container-vendedor-modal">
                                <label class="fw-bold text-secondary">Vendedor (Responsável)</label>
                                <select class="form-select" name="vendedor" id="select-vendedor-modal"></select>
                            </div>

                            <div class="col-12"><label>Observações</label><textarea class="form-control" name="observacoes" id="input-observacoes" rows="2" oninput="this.value = this.value.toUpperCase()"></textarea></div>
                        </div>

                        <h6 class="text-primary border-bottom pb-2 mb-3 mt-4">Endereço de Instalação</h6>
                        <div class="row g-3">
                            <div class="col-12 col-md-4"><label>CEP</label><input type="text" class="form-control" name="cep" id="nova-cep"></div>
                            <div class="col-12 col-md-8"><label>Logradouro</label><input type="text" class="form-control" name="logradouro" id="nova-logradouro" oninput="this.value = this.value.toUpperCase()"></div>
                            <div class="col-6 col-md-2"><label>Número</label><input type="text" class="form-control" name="numero_residencia" id="nova-numero" oninput="this.value = this.value.toUpperCase()"></div>
                            <div class="col-6 col-md-3"><label>Complemento</label><input type="text" class="form-control" name="complemento" id="nova-complemento" oninput="this.value = this.value.toUpperCase()"></div>
                            <div class="col-6 col-md-3"><label>Bairro</label><input type="text" class="form-control" name="bairro" id="nova-bairro" oninput="this.value = this.value.toUpperCase()"></div>
                            <div class="col-6 col-md-2"><label>Cidade</label><input type="text" class="form-control" name="cidade" id="nova-cidade" oninput="this.value = this.value.toUpperCase()"></div>
                            <div class="col-6 col-md-2"><label>UF</label><input type="text" class="form-control" name="estado" id="nova-estado" maxlength="2" style="text-transform: uppercase;"></div>
                            <div class="col-12"><label>Ponto de Referência <span class="text-danger">*</span></label><input type="text" class="form-control" name="ponto_referencia" id="nova-referencia" required oninput="this.value = this.value.toUpperCase()"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" form="form-nova-venda" id="btn-salvar-venda" class="btn btn-primary">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="{% static 'js/auth.js' %}?v=2.1"></script>
    <script src="{% static 'js/menu.js' %}?v=2.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const apiUrl = '';
        async function apiFetch(endpoint, options = {}) {
            const headers = { 'Content-Type': 'application/json', ...options.headers };
            const token = localStorage.getItem('accessToken');
            if (token) headers['Authorization'] = `Bearer ${token}`;
            try {
                const response = await fetch(`${apiUrl}/api${endpoint}`, { ...options, headers });
                if (response.status === 401) { localStorage.removeItem('accessToken'); window.location.href = '/'; return null; }
                if (!response.ok) { const errorText = await response.text(); try { return Promise.reject(JSON.parse(errorText)); } catch(e) { throw new Error(errorText); } }
                return response.status === 204 ? null : await response.json();
            } catch (e) { throw e; }
        }

        const token = localStorage.getItem('accessToken');
        if(!token) window.location.href = '/';

        let modalOrigem, modalNovaVenda, modalAviso, modalDetalhe;
        let clienteTemp = null, debounceTimer, debounceRepTimer, viewAtual = 'minhas_vendas', userProfile = null, dashboardDataCache = {};

        document.addEventListener('DOMContentLoaded', async () => {
            modalOrigem = new bootstrap.Modal(document.getElementById('modal-origem-venda'));
            modalNovaVenda = new bootstrap.Modal(document.getElementById('modal-nova-venda'));
            modalAviso = new bootstrap.Modal(document.getElementById('modal-aviso-cliente'));
            modalDetalhe = new bootstrap.Modal(document.getElementById('modalDetalheDashboard'));
            
            const hoje = new Date();
            document.getElementById('filtro-inicio').valueAsDate = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
            document.getElementById('filtro-fim').valueAsDate = hoje;

            configurarPerfil();
            await carregarAuxiliares();
            
            // Carrega lista de vendedores (para filtro e modal) se for gestão
            if(['Supervisor', 'Diretoria', 'BackOffice', 'Admin'].includes(userProfile)) { carregarVendedores(); }
            
            carregarVendas(); 

            document.getElementById('form-nova-venda').addEventListener('submit', salvarVenda);
            document.getElementById('nova-cep').addEventListener('blur', buscarCepNovaVenda);
            document.getElementById('input-cpf').addEventListener('input', function(e) { clearTimeout(debounceTimer); verificarRegraCNPJ(e.target.value); if(e.target.value.length > 2) debounceTimer = setTimeout(() => buscarCliente(e.target.value), 500); else document.getElementById('sugestoes-cliente').style.display = 'none'; });
            document.getElementById('input-cpf-rep').addEventListener('input', function(e) { clearTimeout(debounceRepTimer); if(e.target.value.replace(/\D/g, '').length >= 11) debounceRepTimer = setTimeout(() => buscarRepresentante(e.target.value.replace(/\D/g, '')), 600); });
            document.querySelectorAll('.uppercase-input, input[type="text"]:not(#input-email)').forEach(input => { input.addEventListener('input', function() { this.value = this.value.toUpperCase(); }); });
        });

        // --- CARREGAR VENDEDORES (FILTRO E MODAL) ---
        async function carregarVendedores() {
            try {
                const vendedores = await apiFetch('/crm/lista-vendedores/');
                const selectFiltro = document.getElementById('filtro-vendedor');
                const selectModal = document.getElementById('select-vendedor-modal'); // Novo campo no modal
                
                selectFiltro.innerHTML = '<option value="">Todos</option>';
                selectModal.innerHTML = '<option value="">Selecione...</option>';

                if(vendedores) {
                    vendedores.forEach(v => {
                        const opt = `<option value="${v.id}">${v.username}</option>`;
                        selectFiltro.innerHTML += opt;
                        selectModal.innerHTML += opt; // Preenche modal também
                    });
                }
            } catch(e) { console.error('Erro ao carregar vendedores', e); }
        }
        // --------------------------------------------

        // --- FUNÇÃO DE CARREGAMENTO DE VENDAS (RECRIADA) ---
        async function carregarVendas() {
            const tbody = document.getElementById('tabela-vendas-body');
            tbody.innerHTML = '<tr><td colspan="8" class="text-center">Carregando...</td></tr>';

            // Pegar valores dos filtros
            const inicio = document.getElementById('filtro-inicio').value;
            const fim = document.getElementById('filtro-fim').value;
            const vendedor = document.getElementById('filtro-vendedor').value;
            
            // Montar URL com os parâmetros para ativar a lógica nova do Backend
            let url = `/crm/vendas/?view=${viewAtual}`;
            if(inicio) url += `&data_inicio=${inicio}`;
            if(fim) url += `&data_fim=${fim}`;
            
            // Se estiver na visão de equipe/geral e tiver selecionado um vendedor
            if(viewAtual === 'geral' && vendedor) url += `&consultor_id=${vendedor}`;

            try {
                const vendas = await apiFetch(url);
                tbody.innerHTML = '';

                if (!vendas || vendas.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Nenhuma venda encontrada no período.</td></tr>';
                    return;
                }

                vendas.forEach(v => {
                    // Lógica de Cores dos Status
                    let badgeClass = 'bg-secondary';
                    const statusNome = v.status_esteira ? v.status_esteira.nome : (v.status_esteira_nome || 'Aguardando');
                    
                    if (statusNome === 'INSTALADA' || statusNome === 'Instalada') badgeClass = 'bg-success';
                    else if (statusNome.toUpperCase().includes('CANCELADA')) badgeClass = 'bg-danger';
                    else if (statusNome.toUpperCase().includes('AGENDADO')) badgeClass = 'bg-info text-dark';
                    else if (statusNome.toUpperCase().includes('PENDÊNCIA')) badgeClass = 'bg-warning text-dark';

                    // Formatação de Dados (Proteção contra nulos)
                    const dataFormatada = v.data_criacao ? new Date(v.data_criacao).toLocaleDateString('pt-BR') : '-';
                    // Tenta pegar nome do objeto aninhado ou campo direto
                    const clienteNome = v.cliente ? (v.cliente.nome_razao_social || v.cliente.nome || v.cliente_nome) : (v.cliente_nome_razao_social || 'N/A');
                    const vendedorNome = v.vendedor ? (v.vendedor.username || v.vendedor.nome) : (v.vendedor_nome || 'N/A');
                    const planoNome = v.plano ? (v.plano.nome) : (v.plano_nome || 'N/A');
                    
                    // Lógica para extrair motivo da pendência
                    const motivoPendencia = v.motivo_pendencia ? (v.motivo_pendencia.nome || v.motivo_pendencia) : '-';

                    const row = `
                        <tr>
                            <td>#${v.id}</td>
                            <td>${dataFormatada}</td>
                            <td>${clienteNome}</td>
                            <td>${vendedorNome}</td> 
                            <td>${planoNome}</td>
                            <td><span class="badge ${badgeClass}">${statusNome}</span></td>
                            <td class="text-danger small fw-bold">${motivoPendencia}</td>
                            <td class="text-end">
                                <button onclick="editarVenda(${v.id})" class="btn btn-sm btn-outline-primary me-1" title="Editar"><i class="bi bi-pencil"></i></button>
                                <button onclick="excluirVenda(${v.id})" class="btn btn-sm btn-outline-danger" title="Excluir"><i class="bi bi-trash"></i></button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

            } catch (error) {
                console.error(error);
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Erro ao carregar vendas. Verifique o console.</td></tr>';
            }
        }
        // -----------------------------------------------------

        function verificarRegraCNPJ(valor) {
            if(!valor) return;
            const clean = valor.replace(/\D/g, '');
            const area = document.getElementById('area-representante');
            const input = document.getElementById('input-cpf-rep');
            if (clean.length > 11) { area.style.display = 'flex'; input.setAttribute('required', 'required'); }
            else { area.style.display = 'none'; input.removeAttribute('required'); }
        }

        function abrirModalOrigem() {
            document.getElementById('form-nova-venda').reset();
            document.getElementById('id-venda-edicao').value = '';
            document.getElementById('titulo-modal-venda').innerHTML = 'Registrar Venda <span id="badge-origem" class="badge bg-secondary ms-2"></span>';
            document.getElementById('feedback-whatsapp').innerHTML = ''; // Limpa msg anterior
            document.getElementById('input-telefone').classList.remove('is-valid', 'is-invalid'); // Limpa status visual
            document.getElementById('btn-salvar-venda').disabled = false; // Garante que o botão inicia ativo

            // Esconde campos de gestão no cadastro
            document.getElementById('container-status-esteira').classList.add('d-none'); 
            document.getElementById('container-vendedor-modal').classList.add('d-none'); 

            ['input-nome', 'input-email', 'input-telefone', 'input-telefone2', 'input-nome-mae', 'input-data-nascimento'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.readOnly = false;
            });
            const areaRep = document.getElementById('area-representante');
            if(areaRep) areaRep.style.display = 'none';

            modalOrigem.show();
        }

        function selecionarOrigem(tipo) {
            document.getElementById('input-forma-entrada').value = tipo;
            const badge = document.getElementById('badge-origem');
            if(badge) {
                badge.textContent = (tipo === 'APP') ? 'Via APP' : 'Sem APP';
                badge.className = (tipo === 'APP') ? 'badge bg-primary ms-2' : 'badge bg-secondary ms-2';
            }
            modalOrigem.hide();
            modalNovaVenda.show();
        }

        function configurarPerfil() {
            try {
                const payload = jwt_decode(token);
                userProfile = payload.user_role || payload.perfil || 'Vendedor'; 
                const perfisGestao = ['Supervisor', 'Diretoria', 'BackOffice', 'Admin'];
                if (perfisGestao.includes(userProfile)) document.getElementById('aba-equipe').classList.remove('d-none');
                if (!['Diretoria', 'Admin'].includes(userProfile)) { document.getElementById('barra-filtros').style.display = 'none'; document.getElementById('aviso-filtro-bloqueado').classList.remove('d-none'); }
            } catch(e) {}
        }

        function alterarAba(tipo, elemento) {
            document.querySelectorAll('.nav-tabs .nav-link').forEach(l => l.classList.remove('active'));
            elemento.classList.add('active');
            const divLista = document.getElementById('conteudo-lista');
            const divDash = document.getElementById('conteudo-dashboard');

            if (tipo === 'dashboard') { 
                divLista.style.display = 'none'; 
                divDash.style.display = 'block'; 
                carregarDashboard(); 
            } else {
                divDash.style.display = 'none'; 
                divLista.style.display = 'block';
                viewAtual = (tipo === 'minhas_vendas') ? 'minhas_vendas' : 'geral';
                document.getElementById('container-filtro-vendedor').classList.toggle('d-none', viewAtual === 'minhas_vendas');
                if (viewAtual === 'geral') carregarVendedores();
                carregarVendas();
            }
        }

        async function carregarDashboard() {
            try {
                const d = await apiFetch('/crm/dashboard-resumo/');
                dashboardDataCache = d.detalhes_listas || {};

                document.getElementById('dash-total').textContent = d.total_vendas;
                document.getElementById('dash-meta-info').innerHTML = `Meta: ${d.meta} | Atingido: <strong>${d.percentual_meta}%</strong>`;
                document.getElementById('dash-instaladas').textContent = d.total_instaladas || 0;
                document.getElementById('dash-aproveitamento').textContent = `Aproveitamento: ${d.percentual_aproveitamento}%`;
                document.getElementById('dash-comissao').textContent = d.comissao_estimada.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
                
                const container = document.getElementById('dash-status-container');
                container.innerHTML = '';
                for (const [status, count] of Object.entries(d.status_detalhado)) {
                    container.innerHTML += `<div class="col-6 col-md-3"><div class="p-3 border rounded bg-white shadow-sm text-center" onclick="abrirDetalheDashboard('${status}', '${status}')" style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'"><h5 class="fw-bold text-secondary">${count}</h5><small class="text-muted fw-bold text-uppercase">${status}</small></div></div>`;
                }
            } catch(e) {}
        }

        function abrirDetalheDashboard(chaveLista, titulo) {
            document.getElementById('tituloDetalheDashboard').textContent = titulo;
            const listaEl = document.getElementById('listaDetalheDashboard');
            listaEl.innerHTML = '';
            const itens = dashboardDataCache[chaveLista] || [];

            if (itens.length === 0) { listaEl.innerHTML = '<div class="text-center p-4 text-muted">Nenhuma venda encontrada.</div>'; } 
            else {
                itens.forEach(item => {
                    let badgeClass = 'bg-secondary';
                    if (item.status.includes('INSTALADA')) badgeClass = 'bg-success';
                    else if (item.status.includes('CANCELADA')) badgeClass = 'bg-danger';
                    else if (item.status.includes('AGENDADO')) badgeClass = 'bg-info text-dark';
                    const dataFormatada = item.data_iso ? new Date(item.data_iso).toLocaleDateString('pt-BR') : '-';
                    listaEl.innerHTML += `<a href="#" class="list-group-item list-group-item-action py-3"><div class="d-flex w-100 justify-content-between align-items-center"><div><h6 class="mb-1 fw-bold text-primary">#${item.id} - ${item.cliente}</h6><small class="text-muted">Vendedor: ${item.vendedor} | Data: ${dataFormatada}</small></div><span class="badge ${badgeClass}">${item.status}</span></div></a>`;
                });
            }
            modalDetalhe.show();
        }

        async function buscarCliente(termo) { try { const res = await apiFetch(`/crm/clientes/?search=${termo}`); const lista = document.getElementById('sugestoes-cliente'); lista.innerHTML = ''; if(res && res.length > 0) { res.forEach(cli => { const item = document.createElement('div'); item.className = 'sugestao-item'; item.innerHTML = `<strong>${cli.nome_razao_social}</strong><br><small>${cli.cpf_cnpj}</small>`; item.onclick = () => selecionarCliente(cli); lista.appendChild(item); }); lista.style.display = 'block'; } else { lista.style.display = 'none'; } } catch(e) {} }
        function selecionarCliente(cliente) { document.getElementById('sugestoes-cliente').style.display = 'none'; if(cliente.vendas_count > 0) { clienteTemp = cliente; document.getElementById('aviso-nome-cliente').textContent = cliente.nome_razao_social; document.getElementById('aviso-qtd-vendas').textContent = cliente.vendas_count; modalAviso.show(); } else { preencherFormularioCliente(cliente); } }
        function confirmarClienteExistente() { try { if(clienteTemp) { preencherFormularioCliente(clienteTemp); clienteTemp = null; } } catch(e) {} modalAviso.hide(); }
        function fecharModalAviso() { modalAviso.hide(); document.getElementById('input-cpf').value = ''; }
        function preencherFormularioCliente(cliente) { document.getElementById('input-cpf').value = cliente.cpf_cnpj; document.getElementById('input-nome').value = cliente.nome_razao_social; document.getElementById('input-email').value = cliente.email || ''; if(cliente.telefone1) document.getElementById('input-telefone').value = cliente.telefone1; if(cliente.telefone2) document.getElementById('input-telefone2').value = cliente.telefone2; if(cliente.nome_mae) document.getElementById('input-nome-mae').value = cliente.nome_mae; if(cliente.data_nascimento) document.getElementById('input-data-nascimento').value = cliente.data_nascimento; verificarRegraCNPJ(cliente.cpf_cnpj); }
        async function buscarRepresentante(cpf) { try { const res = await apiFetch(`/crm/clientes/?search=${cpf}`); if(res && res.length > 0) { const rep = res.find(cli => cli.cpf_cnpj.replace(/\D/g, '') === cpf.replace(/\D/g, '')); if (rep) document.getElementById('input-nome-rep').value = rep.nome_razao_social; } } catch(e){} }
        async function buscarCepNovaVenda(e) { const cep = e.target.value.replace(/\D/g, ''); if (cep.length === 8) { try { const res = await fetch(`https://viacep.com.br/ws/${cep}/json/`); const d = await res.json(); if(!d.erro) { document.getElementById('nova-logradouro').value = d.logradouro.toUpperCase(); document.getElementById('nova-bairro').value = d.bairro.toUpperCase(); document.getElementById('nova-cidade').value = d.localidade.toUpperCase(); document.getElementById('nova-estado').value = d.uf.toUpperCase(); } } catch(e){ } } }
        async function carregarAuxiliares() { 
            try { 
                // --- CORREÇÃO AQUI: Filtra apenas status de Esteira para evitar o erro 'pk inválido' ---
                const [planos, formas, status] = await Promise.all([
                    apiFetch('/crm/planos/'), 
                    apiFetch('/crm/formas-pagamento/'), 
                    apiFetch('/crm/status/?tipo=Esteira') 
                ]); 
                
                const selPlano = document.getElementById('select-plano'); selPlano.innerHTML = '<option value="">Selecione...</option>'; if(planos) planos.forEach(p => selPlano.innerHTML += `<option value="${p.id}">${p.nome} - R$${p.valor}</option>`); 
                const selPag = document.getElementById('select-pagamento'); selPag.innerHTML = '<option value="">Selecione...</option>'; if(formas) formas.forEach(f => selPag.innerHTML += `<option value="${f.id}">${f.nome}</option>`); 
                const selStatus = document.getElementById('select-status-esteira'); selStatus.innerHTML = '<option value="">Selecione...</option>'; if(status) status.forEach(s => selStatus.innerHTML += `<option value="${s.id}">${s.nome}</option>`); 
            } catch(e) {} 
        }

        async function editarVenda(id) {
            try {
                const venda = await apiFetch(`/crm/vendas/${id}/`);
                document.getElementById('titulo-modal-venda').textContent = `Editar Venda #${id}`;
                document.getElementById('id-venda-edicao').value = id;
                
                // Preenche campos hidden (importante!)
                document.getElementById('input-forma-entrada').value = venda.forma_entrada || '';

                document.getElementById('input-cpf').value = venda.cliente_cpf_cnpj || '';
                document.getElementById('input-nome').value = venda.cliente_nome_razao_social || '';
                document.getElementById('input-email').value = venda.cliente_email || '';
                document.getElementById('input-nome-mae').value = venda.nome_mae || '';
                document.getElementById('input-data-nascimento').value = venda.data_nascimento || '';
                document.getElementById('input-telefone').value = venda.telefone1 || '';
                document.getElementById('input-telefone2').value = venda.telefone2 || '';
                verificarRegraCNPJ(venda.cliente_cpf_cnpj);
                document.getElementById('input-cpf-rep').value = venda.cpf_representante_legal || '';
                document.getElementById('input-nome-rep').value = venda.nome_representante_legal || '';
                document.getElementById('select-plano').value = venda.plano || '';
                document.getElementById('select-pagamento').value = venda.forma_pagamento || '';
                document.getElementById('input-observacoes').value = venda.observacoes || '';
                document.getElementById('nova-cep').value = venda.cep || '';
                document.getElementById('nova-logradouro').value = venda.logradouro || '';
                document.getElementById('nova-numero').value = venda.numero_residencia || '';
                document.getElementById('nova-complemento').value = venda.complemento || '';
                document.getElementById('nova-bairro').value = venda.bairro || '';
                document.getElementById('nova-cidade').value = venda.cidade || '';
                document.getElementById('nova-estado').value = venda.estado || '';
                document.getElementById('nova-referencia').value = venda.ponto_referencia || '';

                // Mostra campos de gestão
                const areaStatus = document.getElementById('container-status-esteira');
                const areaVendedor = document.getElementById('container-vendedor-modal');
                if(['Admin', 'Diretoria', 'BackOffice'].includes(userProfile)) {
                    areaStatus.classList.remove('d-none');
                    areaVendedor.classList.remove('d-none'); // MOSTRA VENDEDOR
                    document.getElementById('select-status-esteira').value = venda.status_esteira || '';
                    document.getElementById('select-vendedor-modal').value = venda.vendedor || ''; // PREENCHE VENDEDOR
                } else {
                    areaStatus.classList.add('d-none');
                    areaVendedor.classList.add('d-none');
                }
                
                // Limpa avisos de whatsapp ao abrir edição
                document.getElementById('feedback-whatsapp').innerHTML = '';
                document.getElementById('input-telefone').classList.remove('is-valid', 'is-invalid');
                document.getElementById('btn-salvar-venda').disabled = false;

                modalNovaVenda.show();
            } catch (e) { 
                console.error(e);
                alert("Erro ao carregar dados para edição."); 
            }
        }

        async function salvarVenda(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            const idEdicao = document.getElementById('id-venda-edicao').value;
            const method = idEdicao ? 'PUT' : 'POST';
            const url = idEdicao ? `/crm/vendas/${idEdicao}/` : '/crm/vendas/';

            try {
                await apiFetch(url, { method: method, body: JSON.stringify(data) });
                modalNovaVenda.hide(); form.reset(); document.getElementById('id-venda-edicao').value = '';
                document.getElementById('titulo-modal-venda').innerHTML = 'Registrar Venda <span id="badge-origem" class="badge bg-secondary ms-2"></span>';
                carregarVendas();
                alert(idEdicao ? 'Venda atualizada!' : 'Venda registrada!');
            } catch (error) { 
                let msg = "Erro ao salvar.";
                if (error && typeof error === 'object') {
                    const detalhes = [];
                    for (const [key, value] of Object.entries(error)) detalhes.push(`${key}: ${Array.isArray(value)?value.join(', '):value}`);
                    if (detalhes.length) msg = "Verifique os erros:\n\n" + detalhes.join('\n');
                    else if (error.detail) msg = error.detail;
                }
                alert(msg);
            }
        }

        async function excluirVenda(id) { if(!confirm('Tem certeza?')) return; try { await apiFetch(`/crm/vendas/${id}/`, { method: 'DELETE' }); carregarVendas(); } catch(e) { alert('Erro ao excluir.'); } }
        function logout() { localStorage.removeItem('accessToken'); window.location.href = '/'; }
        
        // --- FUNÇÃO NOVA: VERIFICA WHATSAPP (Bloqueia Salvar) ---
        async function verificarWhatsApp(input) {
            const telefone = input.value.replace(/\D/g, ''); 
            const feedbackDiv = document.getElementById('feedback-whatsapp');
            const btnSalvar = document.getElementById('btn-salvar-venda');

            if (telefone.length < 10) return;

            // Feedback Visual: Verificando...
            input.classList.remove('is-valid', 'is-invalid');
            if(feedbackDiv) feedbackDiv.innerHTML = '<span class="text-warning spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> <span class="text-warning small">Verificando WhatsApp...</span>';
            if(btnSalvar) btnSalvar.disabled = true; // Bloqueia

            try {
                // Usa apiFetch existente
                const data = await apiFetch(`/crm/verificar-zap/${telefone}/`, { method: 'GET' });

                if (data && data.possui_whatsapp) {
                    // Sucesso
                    input.classList.add('is-valid');
                    input.classList.remove('is-invalid');
                    if(feedbackDiv) feedbackDiv.innerHTML = '<span class="text-success fw-bold small"><i class="bi bi-whatsapp"></i> WhatsApp Confirmado!</span>';
                    if(btnSalvar) btnSalvar.disabled = false; // Libera
                } else {
                    // Falha (Não é ZAP)
                    input.classList.add('is-invalid');
                    input.classList.remove('is-valid');
                    if(feedbackDiv) feedbackDiv.innerHTML = '<span class="text-danger fw-bold small"><i class="bi bi-x-circle"></i> Este número NÃO possui WhatsApp.</span>';
                    // Mantém Bloqueado
                    if(btnSalvar) btnSalvar.disabled = true;
                    alert("Atenção: O número informado não possui WhatsApp válido. Verifique se digitou corretamente.");
                }
            } catch (error) {
                console.error("Erro verificação WhatsApp:", error);
                // Em caso de erro na API (Servidor fora), liberamos para não travar a operação
                input.classList.remove('is-valid', 'is-invalid');
                if(feedbackDiv) feedbackDiv.innerHTML = '<span class="text-warning small">Não foi possível verificar (API Offline).</span>';
                if(btnSalvar) btnSalvar.disabled = false;
            }
        }
    </script>
</body>
</html>