{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance de Vendas - Record PAP</title>
    <link rel="shortcut icon" href="{% static 'logo.png' %}" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{% static 'css/custom_styles.css' %}?v=2.8">
    
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        body { background-color: #f8f9fc; }
        
        /* Estilos de Tabela Excel */
        .table-excel { font-size: 0.85rem; border-collapse: separate; border-spacing: 0; width: 100%; }
        .table-excel thead th {
            background-color: #eaecf4; color: #4e73df;
            border: 1px solid #d1d3e2;
            text-transform: uppercase; font-weight: 700;
            padding: 8px; text-align: center; vertical-align: middle;
            position: sticky; top: 0; z-index: 2;
        }
        .table-excel tbody td {
            border: 1px solid #e3e6f0;
            padding: 6px; text-align: center; vertical-align: middle;
            font-weight: 500;
        }
        /* Estilo do Rodapé (Total) */
        .table-excel tfoot td {
            background-color: #2c3e50; color: white;
            font-weight: bold; border: 1px solid #2c3e50;
            padding: 8px; text-align: center; vertical-align: middle;
            position: sticky; bottom: 0; z-index: 2;
        }
        
        .table-excel tbody tr:hover { background-color: #f8f9fc; }
        
        /* Cores de Células Condicionais */
        .bg-green-soft { background-color: #d1e7dd !important; color: #0f5132; }
        .bg-red-soft { background-color: #f8d7da !important; color: #842029; opacity: 0.8; }
        .bg-header-group { background-color: #4e73df !important; color: white !important; }
        
        /* Área oculta para gerar a imagem */
        #capture-area {
            position: absolute; left: -9999px; top: -9999px; width: 1200px; background: white; padding: 20px;
        }
        
        /* Abas Estilizadas */
        .nav-pills .nav-link { 
            color: #5a5c69; font-weight: 600; border-radius: 20px; padding: 8px 20px; margin-right: 5px;
        }
        .nav-pills .nav-link.active { background-color: #4e73df; color: white; box-shadow: 0 2px 5px rgba(78,115,223,0.3); }

        .loading-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.8); z-index: 10;
            display: flex; justify-content: center; align-items: center;
        }
    </style>
</head>
<body>

    <header class="main-header">
        <div class="header-container">
            <a href="/"><img src="{% static 'logo.png' %}" alt="Logo" class="logo"></a>
            <nav class="main-nav"><ul><li><a href="/area-interna/">Voltar</a></li></ul></nav>
        </div>
    </header>

    <main class="container-fluid px-4 py-4">
        
        <div class="d-flex justify-content-between align-items-center mb-4 bg-white p-3 rounded shadow-sm">
            <div><h4 class="fw-bold text-dark mb-0"><i class="bi bi-bar-chart-line-fill text-primary"></i> Painel de Performance</h4></div>
            
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-sm btn-outline-secondary" onclick="abrirModalGrupos()"><i class="bi bi-gear"></i> Grupos WPP</button>
                <button class="btn btn-sm btn-success" onclick="abrirModalEnvio()"><i class="bi bi-whatsapp"></i> Enviar Imagem</button>
                
                <div class="vr mx-2"></div>
                
                <label class="fw-bold text-muted small mb-0">Canal:</label>
                <select id="filtro-canal" class="form-select form-select-sm" style="width: 150px;" onchange="carregarDados()">
                    <option value="">Todos</option>
                    <option value="PAP">PAP</option>
                    <option value="DIGITAL">Digital</option>
                    <option value="RECEPTIVO">Receptivo</option>
                    <option value="PARCEIRO">Parceiro</option>
                </select>
                <button class="btn btn-sm btn-primary rounded-circle" onclick="carregarDados()" title="Atualizar">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
        </div>

        <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
            <li class="nav-item"><button class="nav-link active" id="tab-hoje" data-bs-toggle="pill" data-bs-target="#content-hoje">Hoje</button></li>
            <li class="nav-item"><button class="nav-link" id="tab-semana" data-bs-toggle="pill" data-bs-target="#content-semana">Semanal</button></li>
            <li class="nav-item"><button class="nav-link" id="tab-mes" data-bs-toggle="pill" data-bs-target="#content-mes">Mensal</button></li>
        </ul>

        <div class="tab-content" id="pills-tabContent">
            <div class="tab-pane fade show active" id="content-hoje">
                <div class="card border-0 shadow"><div class="card-body p-0 table-responsive">
                    <table class="table-excel">
                        <thead>
                            <tr>
                                <th class="text-start ps-3">Vendedor</th>
                                <th>Canal</th>
                                <th>Vendas Hoje (O.S.)</th>
                                <th>Vendas Cartão (CC)</th>
                                <th>% CC / Total</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-hoje"></tbody>
                        <tfoot id="tfoot-hoje"></tfoot>
                    </table>
                </div></div>
            </div>

            <div class="tab-pane fade" id="content-semana">
                <div class="card border-0 shadow"><div class="card-body p-0 table-responsive">
                    <table class="table-excel">
                        <thead>
                            <tr>
                                <th class="text-start ps-3">Vendedor</th>
                                <th>Seg</th><th>Ter</th><th>Qua</th><th>Qui</th><th>Sex</th><th>Sáb</th>
                                <th class="bg-header-group">Total Semana</th>
                                <th>Total CC</th>
                                <th>% CC</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-semana"></tbody>
                        <tfoot id="tfoot-semana"></tfoot>
                    </table>
                </div></div>
            </div>

            <div class="tab-pane fade" id="content-mes">
                <div class="card border-0 shadow"><div class="card-body p-0 table-responsive">
                    <table class="table-excel">
                        <thead>
                            <tr>
                                <th class="text-start ps-3">Vendedor</th>
                                <th class="bg-header-group">Total Vendas</th>
                                <th class="bg-success text-white">Instaladas</th>
                                <th>Total CC</th>
                                <th>Instaladas CC</th>
                                <th>% CC Total</th>
                                <th>% CC Inst</th>
                                <th class="bg-info text-white">Aprov.</th>
                                <th>Pende</th>
                                <th>Agend</th>
                                <th>Canc</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-mes"></tbody>
                        <tfoot id="tfoot-mes"></tfoot>
                    </table>
                </div></div>
            </div>
        </div>
    </main>

    <div class="modal fade" id="modalEnvio" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Enviar no WhatsApp</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="mb-3"><label class="fw-bold">1. Escolha os Grupos:</label><div class="border rounded p-2 bg-white" style="max-height: 200px; overflow-y: auto;" id="container-grupos-envio"></div></div><div class="mb-3"><label class="fw-bold">2. Escolha o Período:</label><div class="btn-group w-100" role="group"><input type="radio" class="btn-check" name="periodo-envio" id="radio-hoje" value="hoje" checked><label class="btn btn-outline-primary" for="radio-hoje">Hoje</label><input type="radio" class="btn-check" name="periodo-envio" id="radio-semana" value="semana"><label class="btn btn-outline-primary" for="radio-semana">Semana</label><input type="radio" class="btn-check" name="periodo-envio" id="radio-mes" value="mes"><label class="btn btn-outline-primary" for="radio-mes">Mensal</label></div></div></div><div class="modal-footer"><button class="btn btn-success w-100" onclick="confirmarEnvioZap()" id="btn-disparar">Enviar Agora</button></div></div></div></div>
    
    <div class="modal fade" id="modalGrupos" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Configurar Grupos</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><ul class="list-group" id="lista-grupos-config"></ul></div></div></div></div>

    <div id="capture-area"><h3 class="text-center mb-3 fw-bold" id="capture-title">Relatório</h3><p id="capture-subtitle"></p><table class="table-excel" id="capture-table"></table></div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const token = localStorage.getItem('accessToken');
        if (!token) window.location.href = '/';

        let dadosGlobais = {};

        function cellClass(value) { return value > 0 ? 'bg-green-soft fw-bold' : 'bg-red-soft opacity-50'; }
        function pctClass(value) { return value >= 20 ? 'text-success fw-bold' : (value==0?'text-muted':'text-dark'); }

        async function carregarDados() {
            const canal = document.getElementById('filtro-canal').value;
            try {
                const response = await axios.get(`/api/crm/performance-painel/?canal=${canal}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = response.data;
                dadosGlobais = data;
                renderHoje(data.hoje);
                renderSemana(data.semana);
                renderMes(data.mes);
            } catch (error) { console.error("Erro:", error); }
        }

        // --- RENDER HOJE ---
        function renderHoje(lista) {
            let html = ''; 
            let tV=0, tC=0; // Totais

            lista.forEach(i => { 
                tV += i.total; 
                tC += i.cc;
                
                const rowStyle = i.total === 0 ? 'color: #c0392b; background-color: #fff5f5;' : '';
                const cellStyle = i.total > 0 ? 'bg-green-soft fw-bold' : 'bg-red-soft opacity-50';
                
                html += `<tr>
                    <td class="text-start ps-3 fw-bold" style="${rowStyle}">${i.vendedor}</td>
                    <td>${i.canal||'-'}</td>
                    <td class="${cellStyle}">${i.total}</td>
                    <td class="${cellClass(i.cc)}">${i.cc}</td>
                    <td class="${pctClass(i.pct_cc)}">${i.pct_cc}%</td>
                </tr>`; 
            });
            document.getElementById('tbody-hoje').innerHTML = html || '<tr><td colspan="5">Sem dados</td></tr>';

            // Rodapé com Totais
            const pctT = tV > 0 ? ((tC/tV)*100).toFixed(2) : 0;
            const footerHtml = `
                <tr>
                    <td class="text-start ps-3">TOTAL GERAL</td>
                    <td>-</td>
                    <td>${tV}</td>
                    <td>${tC}</td>
                    <td>${pctT}%</td>
                </tr>`;
            document.getElementById('tfoot-hoje').innerHTML = footerHtml;
        }

        // --- RENDER SEMANA ---
        function renderSemana(lista) {
            let html = ''; 
            let tS=0, tC=0; 
            let d = [0,0,0,0,0,0]; // Totais dos dias

            lista.forEach(i => { 
                tS += i.total; 
                tC += i.cc; 
                for(let k=0; k<6; k++) d[k] += i.dias[k]; // Soma dias

                const rowStyle = i.total === 0 ? 'color: #c0392b; background-color: #fff5f5;' : '';
                
                html += `<tr>
                    <td class="text-start ps-3 fw-bold" style="${rowStyle}">${i.vendedor}</td>
                    <td class="${cellClass(i.dias[0])}">${i.dias[0]}</td>
                    <td class="${cellClass(i.dias[1])}">${i.dias[1]}</td>
                    <td class="${cellClass(i.dias[2])}">${i.dias[2]}</td>
                    <td class="${cellClass(i.dias[3])}">${i.dias[3]}</td>
                    <td class="${cellClass(i.dias[4])}">${i.dias[4]}</td>
                    <td class="${cellClass(i.dias[5])}">${i.dias[5]}</td>
                    <td class="bg-primary bg-opacity-10 fw-bold border border-primary">${i.total}</td>
                    <td>${i.cc}</td>
                    <td class="${pctClass(i.pct_cc)}">${i.pct_cc}%</td>
                </tr>`; 
            });
            document.getElementById('tbody-semana').innerHTML = html || '<tr><td colspan="10">Sem dados</td></tr>';

            // Rodapé
            const pctT = tS > 0 ? ((tC/tS)*100).toFixed(2) : 0;
            const footerHtml = `
                <tr>
                    <td class="text-start ps-3">TOTAL GERAL</td>
                    <td>${d[0]}</td><td>${d[1]}</td><td>${d[2]}</td><td>${d[3]}</td><td>${d[4]}</td><td>${d[5]}</td>
                    <td style="background-color: #4e73df; color: white;">${tS}</td>
                    <td>${tC}</td>
                    <td>${pctT}%</td>
                </tr>`;
            document.getElementById('tfoot-semana').innerHTML = footerHtml;
        }

        // --- RENDER MÊS ---
        function renderMes(lista) {
            let html = ''; 
            let tT=0, tI=0, tC=0, tCI=0, tP=0, tA=0, tCa=0;

            lista.forEach(i => { 
                tT += i.total; tI += i.instaladas; tC += i.cc_total; tCI += i.cc_inst; 
                tP += i.pend; tA += i.agend; tCa += i.canc;

                const rowStyle = i.total === 0 ? 'color: #c0392b; background-color: #fff5f5;' : '';
                
                html += `<tr>
                    <td class="text-start ps-3 fw-bold" style="${rowStyle}">${i.vendedor}</td>
                    <td class="bg-primary bg-opacity-10 fw-bold border border-primary">${i.total}</td>
                    <td class="${cellClass(i.instaladas)}">${i.instaladas}</td>
                    <td>${i.cc_total}</td>
                    <td>${i.cc_inst}</td>
                    <td class="${pctClass(i.pct_cc_total)}">${i.pct_cc_total}%</td>
                    <td class="${pctClass(i.pct_cc_inst)}">${i.pct_cc_inst}%</td>
                    <td class="${i.aproveitamento>=50?'bg-success text-white':'bg-warning text-dark'} fw-bold">${i.aproveitamento}%</td>
                    <td>${i.pend}</td>
                    <td>${i.agend}</td>
                    <td>${i.canc}</td>
                </tr>`; 
            });
            document.getElementById('tbody-mes').innerHTML = html || '<tr><td colspan="11">Sem dados</td></tr>';

            // Rodapé
            const pC = tT > 0 ? ((tC/tT)*100).toFixed(2) : 0;
            const pCI = tI > 0 ? ((tCI/tI)*100).toFixed(2) : 0;
            const pAp = tT > 0 ? ((tI/tT)*100).toFixed(2) : 0;

            const footerHtml = `
                <tr>
                    <td class="text-start ps-3">TOTAL GERAL</td>
                    <td style="background-color: #4e73df; color: white;">${tT}</td>
                    <td style="background-color: #198754; color: white;">${tI}</td>
                    <td>${tC}</td>
                    <td>${tCI}</td>
                    <td>${pC}%</td>
                    <td>${pCI}%</td>
                    <td style="background-color: #0dcaf0; color: black;">${pAp}%</td>
                    <td>${tP}</td>
                    <td>${tA}</td>
                    <td>${tCa}</td>
                </tr>`;
            document.getElementById('tfoot-mes').innerHTML = footerHtml;
        }

        // Funções de Modal e Envio (Simplificadas)
        const modalEnvio = new bootstrap.Modal(document.getElementById('modalEnvio'));
        const modalGrupos = new bootstrap.Modal(document.getElementById('modalGrupos'));
        function abrirModalEnvio() { carregarSelectGrupos(); modalEnvio.show(); }
        function abrirModalGrupos() { carregarGrupos(); modalGrupos.show(); }
        
        async function carregarSelectGrupos() {
            const container = document.getElementById('container-grupos-envio');
            container.innerHTML = '<div class="spinner-border spinner-border-sm"></div>';
            try {
                const res = await axios.get('/api/crm/grupos-disparo/', { headers: { 'Authorization': `Bearer ${token}` }});
                container.innerHTML = '';
                res.data.forEach(g => {
                    container.innerHTML += `<div class="form-check"><input class="form-check-input grupo-chk" type="checkbox" value="${g.chat_id}"><label class="form-check-label">${g.nome}</label></div>`;
                });
            } catch { container.innerHTML = 'Erro ao carregar'; }
        }
        
        async function carregarGrupos() {
             const ul = document.getElementById('lista-grupos-config');
             ul.innerHTML = 'Carregando...';
             try {
                const res = await axios.get('/api/crm/grupos-disparo/', { headers: { 'Authorization': `Bearer ${token}` }});
                ul.innerHTML = '';
                res.data.forEach(g => { ul.innerHTML += `<li class="list-group-item">${g.nome} (${g.chat_id})</li>`; });
             } catch { ul.innerHTML = 'Erro'; }
        }

        async function confirmarEnvioZap() {
            alert('Função de envio configurada no backend!');
        }

        document.addEventListener('DOMContentLoaded', () => { carregarDados(); });
    </script>
</body>
</html>