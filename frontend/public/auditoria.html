{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditoria de Vendas - Record PAP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{% static 'css/custom_styles.css' %}?v=3.0">
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
    <style>
        /* --- ESTILO DE CARDS FLUTUANTES NA TABELA --- */
        table.table {
            border-collapse: separate !important; 
            border-spacing: 0 16px !important;    
        }
        
        /* Reset das células */
        .table > :not(caption) > * > * {
            background-color: transparent; 
            border-bottom-width: 0;
            box-shadow: none;
            vertical-align: middle;
        }

        /* Estilo do cabeçalho */
        .table thead th {
            border: none;
            font-size: 0.85rem;
            text-transform: uppercase;
            color: #6c757d;
            font-weight: 600;
            letter-spacing: 0.5px;
            padding-bottom: 0;
        }

        /* Select limpo */
        .status-select { 
            min-width: 160px; 
            font-size: 0.9rem; 
            border: 1px solid #dee2e6;
            background-color: #f8f9fa;
        } 

        /* Estilos do Script de Auditoria */
        .script-section { background-color: #f8f9fa; border-left: 5px solid var(--cor-primaria, #0d6efd); padding: 15px; margin-bottom: 20px; border-radius: 4px; }
        .script-title { color: var(--cor-primaria, #0d6efd); font-weight: bold; margin-bottom: 10px; text-transform: uppercase; font-size: 0.9rem; }
        .script-text { font-size: 1.1rem; line-height: 1.6; color: #333; }
        .dado-sistema { color: #0d6efd; font-weight: bold; background-color: #e7f1ff; padding: 2px 6px; border-radius: 4px; border: 1px dashed #0d6efd; }
        #aprovacao-mensagem { white-space: pre-wrap; font-family: monospace; font-size: 0.9rem; }

        /* Esconde barra de rolagem horizontal padrão se não for necessária */
        .table-responsive::-webkit-scrollbar { height: 6px; }
        .table-responsive::-webkit-scrollbar-thumb { background-color: #ccc; border-radius: 4px; }
        
        /* --- NOVOS ESTILOS PARA A TRAVA DE AUDITORIA --- */
        .locked-row { opacity: 0.7; background-color: #f8f9fa !important; }
        .auditor-badge { 
            font-size: 0.75rem; 
            background: #ffeeba; 
            color: #856404; 
            padding: 2px 6px; 
            border-radius: 4px; 
            border: 1px solid #ffeeba; 
            display: inline-flex; 
            align-items: center; 
            gap: 4px; 
        }

        @media (max-width: 576px) {
            .header-controls { flex-direction: column; align-items: flex-start; gap: 10px; }
            .header-controls button { width: 100%; }
            .btn-action-responsive { width: 100%; margin-bottom: 10px; }
        }
    </style>
</head>
<body>

    <header class="main-header">
        <div class="header-container">
            <a href="/"><img src="{% static 'logo.png' %}" alt="Record PAP Logo" class="logo"></a>
            <button class="menu-toggle" id="menu-toggle"><div class="bar"></div><div class="bar"></div><div class="bar"></div></button>
            <nav class="main-nav" id="main-nav">
                <ul>
                    <li><a href="/area-interna/">Voltar</a></li>
                    <li><button onclick="logout()" class="nav-button logout-button">Sair</button></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="area-interna-section">
        <div class="system-container" style="max-width: 1600px;">
            <div class="d-flex justify-content-between align-items-center mb-4 header-controls">
                <div>
                    <h1 style="font-size: 1.8rem; margin: 0;">Auditoria</h1>
                    <p class="text-muted mb-0">Validação e qualidade das vendas.</p>
                </div>
                <button onclick="carregarVendas()" class="btn btn-outline-primary fw-bold shadow-sm">
                    <i class="bi bi-arrow-clockwise"></i> Atualizar Lista
                </button>
            </div>

            <div class="card border-0 shadow-none" style="background: transparent;">
                <div class="table-responsive" style="overflow-y: visible; overflow-x: auto; padding: 4px;">
                    <table class="table mb-0">
                        <thead>
                            <tr>
                                <th class="ps-3">ID</th>
                                <th>Data</th>
                                <th>Cliente</th>
                                <th>Vendedor</th>
                                <th>Status Tratamento</th>
                                <th>Auditor</th>
                                <th>Resp. Alteração</th>
                                <th class="text-end pe-3">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-auditoria-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <div class="modal fade" id="modal-detalhes" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalhes da Venda</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="form-edit-venda">
                        <input type="hidden" id="edit-id">
                        <h6 class="text-primary border-bottom pb-2 mb-3"><i class="bi bi-info-circle"></i> Dados da Venda</h6>
                        <div class="row g-3 mb-3 bg-light p-2 rounded">
                            <div class="col-md-3"><label class="form-label small fw-bold text-muted">Vendedor</label><input type="text" class="form-control form-control-sm" id="view-vendedor" readonly disabled></div>
                            <div class="col-md-3"><label class="form-label small fw-bold text-muted">Data Venda</label><input type="text" class="form-control form-control-sm" id="view-data" readonly disabled></div>
                            <div class="col-md-3"><label class="form-label small fw-bold text-muted">Forma Entrada</label><input type="text" class="form-control form-control-sm" id="view-entrada" readonly disabled></div>
                            <div class="col-md-3"><label class="form-label small fw-bold text-muted">Status Atual</label><input type="text" class="form-control form-control-sm" id="view-status" readonly disabled></div>
                            <div class="col-md-6"><label class="form-label small fw-bold text-muted">Plano</label><input type="text" class="form-control form-control-sm" id="view-plano" readonly disabled></div>
                            <div class="col-md-6"><label class="form-label small fw-bold text-muted">Forma de Pagamento</label><input type="text" class="form-control form-control-sm" id="view-pagamento" readonly disabled></div>
                        </div>
                        <h6 class="text-primary border-bottom pb-2 mb-3 mt-4"><i class="bi bi-person"></i> Dados do Cliente</h6>
                        <div class="row g-3">
                            <div class="col-md-6"><label class="form-label fw-bold">Nome Cliente</label><input type="text" class="form-control" id="edit-cliente" readonly></div>
                            <div class="col-md-6"><label class="form-label fw-bold">CPF/CNPJ</label><input type="text" class="form-control" id="edit-cpf" readonly></div>
                            <div class="col-md-6"><label class="form-label">Nome da Mãe</label><input type="text" class="form-control" id="edit-nome-mae"></div>
                            <div class="col-md-6"><label class="form-label">Data de Nascimento</label><input type="date" class="form-control" id="edit-nasc"></div>
                            <div class="col-md-8"><label class="form-label">Nome Rep. Legal</label><input type="text" class="form-control" id="edit-nome-rep"></div>
                            <div class="col-md-4"><label class="form-label">CPF Rep. Legal</label><input type="text" class="form-control" id="edit-cpf-rep"></div>
                            <div class="col-md-6"><label class="form-label">Telefone 1</label><input type="text" class="form-control" id="edit-tel1"></div>
                            <div class="col-md-6"><label class="form-label">Telefone 2</label><input type="text" class="form-control" id="edit-tel2"></div>
                        </div>
                        <h6 class="text-primary border-bottom pb-2 mb-3 mt-4"><i class="bi bi-geo-alt"></i> Endereço</h6>
                        <div class="row g-3">
                            <div class="col-md-3"><label class="form-label">CEP</label><input type="text" class="form-control" id="edit-cep"></div>
                            <div class="col-md-7"><label class="form-label">Logradouro</label><input type="text" class="form-control" id="edit-logradouro"></div>
                            <div class="col-md-2"><label class="form-label">Número</label><input type="text" class="form-control" id="edit-numero"></div>
                            <div class="col-md-4"><label class="form-label">Complemento</label><input type="text" class="form-control" id="edit-complemento"></div>
                            <div class="col-md-4"><label class="form-label">Bairro</label><input type="text" class="form-control" id="edit-bairro"></div>
                            <div class="col-md-3"><label class="form-label">Cidade</label><input type="text" class="form-control" id="edit-cidade"></div>
                            <div class="col-md-1"><label class="form-label">UF</label><input type="text" class="form-control" id="edit-estado"></div>
                            <div class="col-12"><label class="form-label">Ponto de Referência</label><input type="text" class="form-control" id="edit-referencia"></div>
                            <div class="col-12"><hr></div>
                            <div class="col-12"><label class="form-label fw-bold">Observações</label><textarea class="form-control" id="edit-obs" rows="3"></textarea></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" id="btn-salvar-detalhes" onclick="salvarAlteracoes()">Salvar Dados</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal-script-auditoria" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-headset"></i> Roteiro de Auditoria - Venda #<span id="script-id-venda"></span></h5>
                    <button type="button" class="btn-close btn-close-white" onclick="fecharScriptSemSalvar()"></button>
                </div>
                <div class="modal-body bg-light">
                    <div class="container py-3">
                        
                        <div class="script-section shadow-sm bg-white">
                            <div class="script-title">1. Introdução</div>
                            <p class="script-text">
                                "Bom (dia/tarde), tudo bem? Aqui é <strong><span id="script-user-logado" class="text-primary"></span></strong> da Nio Fibra. 
                                Estou ligando para confirmar os dados do seu pedido e passar algumas informações importantes. 
                                Posso prosseguir com a auditoria?"
                            </p>
                        </div>

                        <div class="script-section shadow-sm bg-white">
                            <div class="script-title">2. Confirmação de Identidade</div>
                            <p class="script-text">"Poderia, por gentileza, confirmar seu nome completo?"</p>
                            <div class="dado-sistema mb-2"><i class="bi bi-person"></i> Sistema: <span id="script-cliente-nome"></span></div>
                            
                            <p class="script-text mt-3">"Poderia me informar os três primeiros números do seu CPF?"</p>
                            <div class="dado-sistema mb-2"><i class="bi bi-card-heading"></i> Sistema: <span id="script-cliente-cpf"></span></div>

                            <p class="script-text mt-3">"Poderia confirmar o nome da sua mãe e sua data de nascimento?"</p>
                            <div class="row">
                                <div class="col-md-6"><div class="dado-sistema"><i class="bi bi-person-standing-dress"></i> Mãe: <span id="script-cliente-mae"></span></div></div>
                                <div class="col-md-6">
                                    <div class="dado-sistema">
                                        <i class="bi bi-calendar"></i> Nasc: <span id="script-cliente-nasc"></span>
                                        <span id="script-cliente-idade" class="ms-2 text-muted small" style="font-style: italic;"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="script-section shadow-sm bg-white">
                            <div class="script-title">3. Contato e WhatsApp</div>
                            <p class="script-text">"Qual é o seu número de telefone no WhatsApp?"</p>
                            <div class="dado-sistema mb-3"><i class="bi bi-whatsapp"></i> Sistema: <span id="script-cliente-tel1"></span></div>
                            
                            <div class="alert alert-info border-info">
                                <i class="bi bi-info-circle-fill"></i> <strong>Aviso Importante:</strong><br>
                                "Lembrando que é nesse número que você receberá a confirmação do pedido. Para confirmar a instalação, 
                                preciso que após receber a mensagem da Nio no seu WhatsApp você digite 'SIM'. 
                                No WhatsApp da Nio, você poderá acompanhar a instalação em tempo real e até mesmo reagendar. Ficou claro?"
                            </div>

                            <p class="script-text mt-2">"Poderia me informar um segundo telefone de contato e seu e-mail?"</p>
                            <div class="dado-sistema"><i class="bi bi-phone"></i> Tel 2: <span id="script-cliente-tel2"></span></div>
                            <div class="dado-sistema mt-1"><i class="bi bi-envelope"></i> Email: <span id="script-cliente-email"></span></div>
                        </div>

                        <div class="script-section shadow-sm bg-white">
                            <div class="script-title">4. Endereço de Instalação</div>
                            <p class="script-text">"Agora, vamos confirmar o seu endereço de instalação. Poderia confirmar Nome da Rua, Número e CEP?"</p>
                            <div class="dado-sistema"><i class="bi bi-geo-alt-fill"></i> <span id="script-endereco-completo"></span></div>
                        </div>

                        <div class="script-section shadow-sm bg-white">
                            <div class="script-title">5. Plano e Pagamento</div>
                            <p class="script-text">
                                "O plano que você contratou foi o <span class="dado-sistema" id="script-plano-nome"></span> 
                                com o valor de <span class="dado-sistema" id="script-plano-valor"></span> 
                                e a forma de pagamento foi <span class="dado-sistema" id="script-forma-pag"></span>."
                            </p>
                            <p class="script-text mt-2">"A fidelidade do plano é de 12 meses. Você está ciente do valor contratado, do plano e da fidelidade mencionada?"</p>
                            <div class="alert alert-warning border-warning mt-2" id="script-alerta-cartao" style="display: none;">
                                <i class="bi bi-credit-card"></i> <strong>Se Cartão de Crédito:</strong> "É importante verificar se você possui limite disponível."
                            </div>
                        </div>

                        <div class="script-section shadow-sm bg-white">
                            <div class="script-title">6. Agendamento & Observações</div>
                            <p class="script-text">"Poderia me informar qual o melhor dia da semana e horário (manhã ou tarde) para agendarmos a instalação?"</p>
                            
                            <div class="row g-3 p-3 bg-light border rounded mb-3">
                                <div class="col-12 text-primary fw-bold small text-uppercase">Agendamento Preferencial (Vendedor)</div>
                                <div class="col-md-6">
                                    <strong>Data:</strong> <span id="script-agendamento-data-display">-</span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Turno:</strong> <span id="script-agendamento-turno-display">-</span>
                                </div>
                            </div>

                            <div class="mb-3 p-3 bg-white border rounded">
                                <label class="form-label fw-bold text-primary"><i class="bi bi-pencil-square"></i> Observações da Auditoria (Obrigatório se tiver divergência)</label>
                                <textarea class="form-control" id="script-obs-venda" rows="3" placeholder="Anote aqui qualquer detalhe da auditoria..."></textarea>
                            </div>
                        </div>

                        <div class="script-section shadow-sm bg-white">
                            <div class="script-title">7. Encerramento</div>
                            <p class="script-text">
                                "Para finalizar, gostaria de informar que temos o aplicativo Nio. Nele, você pode acompanhar a internet, 
                                solicitar fatura e pedir suporte. Qualquer dúvida, você pode entrar em contato conosco pelo WhatsApp.
                                Agradeço sua atenção e tenha um ótimo dia!"
                            </p>
                        </div>

                    </div>
                </div>
                <div class="modal-footer bg-light justify-content-between flex-wrap">
                    <button type="button" class="btn btn-danger btn-lg fw-bold btn-action-responsive" onclick="abrirModalReprovacao()">
                        <i class="bi bi-x-circle"></i> REPROVAR
                    </button>
                    
                    <div class="d-flex gap-2 flex-wrap justify-content-end w-sm-100">
                        <button type="button" class="btn btn-secondary btn-lg btn-action-responsive" onclick="fecharScriptSemSalvar()">Sair (Liberar)</button>
                        
                        <button type="button" class="btn btn-success btn-lg fw-bold btn-action-responsive" onclick="finalizarComoAuditada()">
                            <i class="bi bi-check-circle"></i> APROVAR (Auditada)
                        </button>

                        <button type="button" class="btn btn-primary btn-lg fw-bold btn-action-responsive" onclick="prepararAgendamento()">
                            <i class="bi bi-calendar-plus"></i> APROVAR E CADASTRAR
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal-agendamento" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content border-primary">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-calendar-check"></i> Dados do Agendamento (Esteira)</h5>
                    <button type="button" class="btn-close btn-close-white" onclick="cancelarAgendamento()"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info small">Você está aprovando e movendo para a esteira (<strong>CADASTRADA</strong>). Preencha os dados da O.S.</div>
                    <form id="form-agendamento">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Número da O.S. <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="agenda-os" required placeholder="Digite a O.S. da Operadora">
                            <div id="os-feedback" class="invalid-feedback">Esta O.S. já existe no sistema!</div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Data Agendada <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="agenda-data" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Turno <span class="text-danger">*</span></label>
                                <select class="form-select" id="agenda-turno" required>
                                    <option value="">Selecione...</option>
                                    <option value="MANHA">Manhã</option>
                                    <option value="TARDE">Tarde</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="cancelarAgendamento()">Voltar</button>
                    <button type="button" class="btn btn-primary" id="btn-salvar-agendamento" onclick="salvarAgendamento()">Confirmar e Enviar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal-reprovacao" tabindex="-1" style="z-index: 1060;">
        <div class="modal-dialog">
            <div class="modal-content border-danger">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="bi bi-exclamation-triangle-fill"></i> Reprovar Venda</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Selecione o motivo da reprovação ou pendência:</p>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Novo Status</label>
                        <select class="form-select" id="repro-status">
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Observação Obrigatória</label>
                        <textarea class="form-control" id="repro-obs" rows="4" placeholder="Descreva o motivo para o vendedor..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" onclick="confirmarReprovacao()">Confirmar Reprovação</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal-aprovacao" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Venda Aprovada!</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Copie a mensagem abaixo para enviar no grupo:</p>
                    <textarea id="aprovacao-mensagem" class="form-control mb-3" rows="12" readonly></textarea>
                    <button class="btn btn-outline-success w-100" onclick="copiarMensagem()"><i class="bi bi-whatsapp"></i> Copiar Mensagem</button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="{% static 'js/auth.js' %}?v=3.1"></script>
    <script src="{% static 'js/menu.js' %}?v=1.3"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const token = localStorage.getItem('accessToken');
        if(!token) window.location.href = '/';

        const decodedToken = jwt_decode(token);
        const userProfile = decodedToken ? (decodedToken.user_role || decodedToken.perfil) : null;
        const currentUserId = decodedToken ? decodedToken.user_id : null; 
        const isSupervisor = ['Diretoria', 'Admin', 'Supervisor', 'BackOffice'].includes(userProfile);

        let vendas = [];
        let globalStatusOptions = [];
        let tempVendaId = null;
        let vendaEmAuditoria = null; 

        const modalDetalhes = new bootstrap.Modal(document.getElementById('modal-detalhes'));
        const modalScript = new bootstrap.Modal(document.getElementById('modal-script-auditoria'));
        const modalAgendamento = new bootstrap.Modal(document.getElementById('modal-agendamento'));
        const aprovacaoModal = new bootstrap.Modal(document.getElementById('modal-aprovacao'));
        const modalReprovacao = new bootstrap.Modal(document.getElementById('modal-reprovacao'));

        document.addEventListener('DOMContentLoaded', () => {
            carregarVendas();
            document.getElementById('edit-cep').addEventListener('blur', buscarCepEdit);
        });

        function mostrarErroDetalhado(error, contexto = 'atualizar') {
            console.error(`Erro ao ${contexto}:`, error);
            alert(`Erro ao ${contexto}. Verifique o console.`);
        }

        function calcularIdade(dataNascimento) {
            if (!dataNascimento) return '';
            const hoje = new Date();
            const parts = dataNascimento.split('-');
            const nascimento = new Date(parts[0], parts[1] - 1, parts[2]);
            let anos = hoje.getFullYear() - nascimento.getFullYear();
            let meses = hoje.getMonth() - nascimento.getMonth();
            let dias = hoje.getDate() - nascimento.getDate();
            if (meses < 0 || (meses === 0 && dias < 0)) { anos--; meses += 12; }
            if (dias < 0) { meses--; if (meses < 0) meses = 11; }
            return `(${anos} anos e ${meses} meses)`;
        }

        async function carregarVendas(silent = false) {
            const tbody = document.getElementById('tabela-auditoria-body');
            if (!silent) tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4"><div class="spinner-border text-primary"></div></td></tr>';
            
            try {
                const timestamp = new Date().getTime();
                const statusRes = await apiClient.get('/api/crm/status/?tipo=Tratamento');
                globalStatusOptions = statusRes.data;
                const res = await apiClient.get(`/api/crm/vendas/?flow=auditoria&_t=${timestamp}`);
                
                vendas = res.data.filter(v => {
                    if (!v.status_tratamento || !v.status_tratamento.estado) return true; 
                    return v.status_tratamento.estado.toUpperCase() !== 'FECHADO';
                });

                if(vendas.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-muted">Nenhuma venda pendente.</td></tr>';
                } else {
                    tbody.innerHTML = '';
                    vendas.forEach(v => {
                        const dataFmt = new Date(v.data_criacao).toLocaleDateString('pt-BR');
                        const statusNome = v.status_tratamento ? v.status_tratamento.nome : '-';
                        const alteradoPor = v.alterado_por || '-';
                        
                        const auditorId = v.auditor_atual_id; 
                        const auditorNome = v.auditor_atual_nome;
                        const estaTravado = auditorId !== null;
                        const travadoPorMim = auditorId === currentUserId;
                        
                        // CORREÇÃO DO NOME DO VENDEDOR (EVITAR UNDEFINED)
                        let nomeVendedor = 'N/A';
                        if (v.vendedor_nome) nomeVendedor = v.vendedor_nome;
                        else if (v.vendedor && v.vendedor.username) nomeVendedor = v.vendedor.username;
                        else if (v.vendedor && v.vendedor.first_name) nomeVendedor = v.vendedor.first_name;

                        let classeLinha = '';
                        let auditorHtml = '-';
                        let botoesHtml = '';

                        if (estaTravado) {
                            if (travadoPorMim) {
                                auditorHtml = `<span class="auditor-badge bg-success text-white"><i class="bi bi-person-fill"></i> VOCÊ</span>`;
                                botoesHtml = `<button class="btn btn-sm btn-primary rounded-pill px-3" onclick="tentarAuditoria(${v.id})">Continuar <i class="bi bi-arrow-right"></i></button>`;
                            } else {
                                classeLinha = 'locked-row';
                                auditorHtml = `<span class="auditor-badge"><i class="bi bi-lock-fill"></i> ${auditorNome}</span>`;
                                if (isSupervisor) {
                                    botoesHtml = `<button class="btn btn-sm btn-outline-danger" onclick="liberarVenda(${v.id})" title="Forçar Liberação"><i class="bi bi-unlock-fill"></i></button>`;
                                } else {
                                    botoesHtml = `<span class="text-muted small"><i class="bi bi-lock"></i> Em uso</span>`;
                                }
                            }
                        } else {
                            botoesHtml = `
                                <button class="btn btn-sm btn-dark me-1 rounded-circle p-2" onclick="tentarAuditoria(${v.id})" title="Iniciar Auditoria"><i class="bi bi-headset"></i></button>
                                <button class="btn btn-sm btn-outline-secondary me-1 rounded-circle p-2" onclick="abrirDetalhes(${v.id})" title="Editar"><i class="bi bi-pencil"></i></button>
                            `;
                        }

                        const corFundo = (v.status_tratamento && v.status_tratamento.cor) ? v.status_tratamento.cor : 'transparent';
                        const rowStyle = `background: #fff; border: 1px solid rgba(0,0,0,0.1); box-shadow: -4px 4px 0px ${corFundo}; border-radius: 10px;`;

                        const tr = document.createElement('tr');
                        tr.style.cssText = rowStyle;
                        if(classeLinha) tr.classList.add(classeLinha);

                        tr.innerHTML = `
                            <td class="fw-bold text-primary ps-4">#${v.id}</td>
                            <td>${dataFmt}</td>
                            <td><div class="fw-bold">${v.cliente.nome_razao_social || 'S/ Nome'}</div><div class="small text-muted">${v.cliente.cpf_cnpj || ''}</div></td>
                            <td>${nomeVendedor}</td>
                            <td><span class="badge bg-light text-dark border">${statusNome}</span></td>
                            <td>${auditorHtml}</td>
                            <td><small class="text-muted fw-bold">${alteradoPor}</small></td>
                            <td class="text-end pe-4">${botoesHtml}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            } catch (e) {
                if(!silent) tbody.innerHTML = '<tr><td colspan="8" class="text-danger text-center">Erro ao carregar vendas.</td></tr>';
            }
        }

        async function tentarAuditoria(id) {
            try {
                await apiClient.post(`/api/crm/vendas/${id}/alocar-auditoria/`, {});
                iniciarAuditoriaScript(id);
                carregarVendas(true);
            } catch (e) {
                if (e.message && e.message.includes('409')) { alert('Esta venda acabou de ser pega por outro auditor!'); } 
                else { alert('Erro ao tentar acessar a venda. Tente novamente.'); }
                carregarVendas(true);
            }
        }

        async function liberarVenda(id) {
            if(!confirm("Tem certeza que deseja forçar a liberação desta venda?")) return;
            try {
                await apiClient.post(`/api/crm/vendas/${id}/liberar-auditoria/`, {});
                carregarVendas(true);
            } catch (e) { alert('Erro ao liberar venda.'); }
        }

        function iniciarAuditoriaScript(id) {
            const v = vendas.find(x => x.id === id);
            if(!v) return;
            vendaEmAuditoria = v;

            const payload = jwt_decode(token);
            document.getElementById('script-user-logado').textContent = (payload.user_name || 'Consultor').toUpperCase();
            document.getElementById('script-id-venda').textContent = v.id;
            document.getElementById('script-cliente-nome').textContent = v.cliente.nome_razao_social || 'NÃO INFORMADO';
            document.getElementById('script-cliente-cpf').textContent = v.cliente.cpf_cnpj || 'NÃO INFORMADO';
            document.getElementById('script-obs-venda').value = v.observacoes || '';
            
            // Dados Agendamento (Display apenas)
            document.getElementById('script-agendamento-data-display').textContent = v.data_agendamento ? new Date(v.data_agendamento).toLocaleDateString('pt-BR') : 'Não agendado';
            document.getElementById('script-agendamento-turno-display').textContent = v.periodo_agendamento || 'Não agendado';

            // Demais campos
            const dtNasc = v.data_nascimento || '';
            document.getElementById('script-cliente-nasc').textContent = dtNasc ? new Date(dtNasc).toLocaleDateString('pt-BR') : 'N/A';
            document.getElementById('script-cliente-idade').textContent = calcularIdade(dtNasc);
            document.getElementById('script-cliente-mae').textContent = v.nome_mae || 'N/A';
            document.getElementById('script-cliente-tel1').textContent = v.telefone1 || '-';
            document.getElementById('script-cliente-tel2').textContent = v.telefone2 || 'Não informado';
            document.getElementById('script-cliente-email').textContent = v.cliente.email || 'Não informado';
            
            const end = `${v.logradouro || ''}, ${v.numero_residencia || ''} ${v.complemento ? '- ' + v.complemento : ''} - ${v.bairro || ''} - CEP: ${v.cep || ''}`;
            document.getElementById('script-endereco-completo').textContent = end;
            document.getElementById('script-plano-nome').textContent = v.plano ? v.plano.nome : '-';
            let valorDisplay = v.plano ? parseFloat(v.plano.valor) : 0.0;
            const formaPag = v.forma_pagamento ? v.forma_pagamento.nome.toUpperCase() : '';
            if(formaPag.includes('CARTÃO') || formaPag.includes('CREDITO')) {
                valorDisplay -= 10.0;
                document.getElementById('script-alerta-cartao').style.display = 'block';
            } else {
                document.getElementById('script-alerta-cartao').style.display = 'none';
            }
            document.getElementById('script-plano-valor').textContent = valorDisplay.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
            document.getElementById('script-forma-pag').textContent = v.forma_pagamento ? v.forma_pagamento.nome : '-';

            modalScript.show();
        }

        function fecharScriptSemSalvar() {
            if(vendaEmAuditoria) {
                apiClient.post(`/api/crm/vendas/${vendaEmAuditoria.id}/liberar-auditoria/`, {})
                    .then(() => carregarVendas(true)).catch(() => {});
            }
            modalScript.hide();
        }

        // --- FLUXO 1: APROVAR (SOMENTE AUDITADA) ---
        async function finalizarComoAuditada() {
            if(!vendaEmAuditoria) return;
            const statusAuditada = globalStatusOptions.find(s => s.nome.toUpperCase() === 'AUDITADA');
            if(!statusAuditada) { alert("Status 'AUDITADA' não encontrado!"); return; }

            const obsNova = document.getElementById('script-obs-venda').value;

            try {
                await apiClient.patch(`/api/crm/vendas/${vendaEmAuditoria.id}/`, {
                    status_tratamento: statusAuditada.id,
                    observacoes: obsNova
                });
                await apiClient.post(`/api/crm/vendas/${vendaEmAuditoria.id}/liberar-auditoria/`, {});
                
                modalScript.hide();
                carregarVendas(true);
                gerarAprovacao(vendaEmAuditoria.id); 
            } catch(e) { mostrarErroDetalhado(e, 'salvar auditoria'); }
        }

        // --- FLUXO 2: APROVAR E CADASTRAR (ABRE MODAL OS) ---
        function prepararAgendamento() {
            if(!vendaEmAuditoria) return;
            modalScript.hide();
            document.getElementById('form-agendamento').reset();
            document.getElementById('agenda-os').classList.remove('is-invalid');
            
            if(vendaEmAuditoria.data_agendamento) document.getElementById('agenda-data').value = vendaEmAuditoria.data_agendamento;
            if(vendaEmAuditoria.periodo_agendamento) document.getElementById('agenda-turno').value = vendaEmAuditoria.periodo_agendamento;
            
            tempVendaId = vendaEmAuditoria.id; 
            modalAgendamento.show();
        }

        // --- SALVAR DO MODAL DE AGENDAMENTO (UNIFICADO) ---
        async function salvarAgendamento() {
            const btn = document.getElementById('btn-salvar-agendamento');
            const os = document.getElementById('agenda-os').value.trim();
            const data = document.getElementById('agenda-data').value;
            const turno = document.getElementById('agenda-turno').value;
            const idAlvo = vendaEmAuditoria ? vendaEmAuditoria.id : tempVendaId;

            if (!os || !data || !turno) { alert("Preencha todos os campos."); return; }
            btn.disabled = true; btn.innerHTML = 'Salvando...';

            const statusCadastrada = globalStatusOptions.find(s => s.nome.toUpperCase() === 'CADASTRADA');
            if(!statusCadastrada) { alert("Status 'CADASTRADA' não encontrado!"); btn.disabled=false; return; }

            try {
                const res = await apiClient.get(`/api/crm/vendas/?ordem_servico=${os}`);
                const duplicada = res.data.some(v => v.id !== idAlvo);
                if (duplicada) {
                    document.getElementById('agenda-os').classList.add('is-invalid');
                    btn.disabled = false; btn.innerHTML = 'Confirmar e Enviar'; return; 
                } 
                document.getElementById('agenda-os').classList.remove('is-invalid');

                const body = { 
                    status_tratamento: statusCadastrada.id, 
                    ordem_servico: os, 
                    data_agendamento: data, 
                    periodo_agendamento: turno 
                };
                
                if(vendaEmAuditoria) {
                    body.observacoes = document.getElementById('script-obs-venda').value;
                }

                await apiClient.patch(`/api/crm/vendas/${idAlvo}/`, body);
                
                if(vendaEmAuditoria) {
                    await apiClient.post(`/api/crm/vendas/${idAlvo}/liberar-auditoria/`, {});
                }

                modalAgendamento.hide();
                carregarVendas(true);
                
                if(vendaEmAuditoria) {
                    vendaEmAuditoria.ordem_servico = os;
                    vendaEmAuditoria.data_agendamento = data;
                    vendaEmAuditoria.periodo_agendamento = turno;
                    gerarAprovacao(idAlvo);
                } else {
                    alert("Agendamento salvo com sucesso!");
                }
            } catch (e) { mostrarErroDetalhado(e, 'salvar agendamento'); } 
            finally { btn.disabled = false; btn.innerHTML = 'Confirmar e Enviar'; }
        }

        function cancelarAgendamento() { 
            modalAgendamento.hide(); 
            if(vendaEmAuditoria) { modalScript.show(); } else { carregarVendas(true); }
        }

        // --- REPROVAÇÃO ---
        function abrirModalReprovacao() {
            const statusNegativos = globalStatusOptions.filter(s => {
                const nome = s.nome.toUpperCase();
                return !['AUDITADA', 'FECHADO', 'CADASTRADA', 'APROVADA'].includes(nome);
            });
            const select = document.getElementById('repro-status');
            select.innerHTML = '<option value="">Selecione o motivo...</option>';
            statusNegativos.forEach(s => select.innerHTML += `<option value="${s.id}">${s.nome}</option>`);
            document.getElementById('repro-obs').value = '';
            modalReprovacao.show();
        }

        async function confirmarReprovacao() {
            const statusId = document.getElementById('repro-status').value;
            const obs = document.getElementById('repro-obs').value;
            if(!statusId || !obs) { alert("Selecione status e preencha a observação."); return; }

            const btn = document.querySelector('#modal-reprovacao .btn-danger');
            btn.disabled = true; btn.innerText = "Salvando...";

            try {
                await apiClient.patch(`/api/crm/vendas/${vendaEmAuditoria.id}/`, {
                    status_tratamento: statusId,
                    observacoes: obs 
                });
                await apiClient.post(`/api/crm/vendas/${vendaEmAuditoria.id}/liberar-auditoria/`, {});
                modalReprovacao.hide();
                modalScript.hide(); 
                carregarVendas(true);
                alert("Venda reprovada com sucesso.");
            } catch (e) { alert("Erro ao reprovar venda."); } 
            finally { btn.disabled = false; btn.innerText = "Confirmar Reprovação"; }
        }

        // --- EXTRAS E FUNÇÕES QUE FALTAVAM ---
        function gerarAprovacao(id) {
            const v = vendas.find(x => x.id === id) || vendaEmAuditoria; 
            if(!v) return;
            let dacc = (v.forma_pagamento && v.forma_pagamento.nome.toUpperCase().includes('DÉBITO')) ? 'SIM' : 'NÃO';
            let agendamentoStr = 'A confirmar';
            if(v.data_agendamento) {
                const parts = v.data_agendamento.split('-');
                agendamentoStr = `${parts[2]}/${parts[1]}/${parts[0]} - ${v.periodo_agendamento}`;
            }
            
            // Tratamento robusto do vendedor para o ZAP
            let vendedor = 'N/A';
            if (v.vendedor_nome) vendedor = v.vendedor_nome;
            else if (v.vendedor && v.vendedor.username) vendedor = v.vendedor.username;

            const os = v.ordem_servico || 'Em processamento';

            const msg = `✅ APROVADO! Venda #${v.id}
Cliente: ${v.cliente.nome_razao_social}
CPF: ${v.cliente.cpf_cnpj}
Plano: ${v.plano ? v.plano.nome : '-'}
OS: ${os}
Agendamento: ${agendamentoStr}
Vendedor: ${vendedor}
DACC: ${dacc}`;

            document.getElementById('aprovacao-mensagem').value = msg;
            aprovacaoModal.show();
        }

        // FUNÇÃO QUE ESTAVA FALTANDO/INCOMPLETA: Abrir Detalhes com dados reais
        function abrirDetalhes(id) {
            const v = vendas.find(x => x.id === id);
            if(!v) return;
            document.getElementById('edit-id').value = v.id;
            
            // Dados informativos (apenas leitura)
            let vendedorShow = 'N/A';
            if (v.vendedor_nome) vendedorShow = v.vendedor_nome;
            else if (v.vendedor && v.vendedor.username) vendedorShow = v.vendedor.username;
            
            document.getElementById('view-vendedor').value = vendedorShow;
            document.getElementById('view-data').value = new Date(v.data_criacao).toLocaleDateString('pt-BR');
            document.getElementById('view-entrada').value = v.forma_entrada || '-';
            document.getElementById('view-status').value = v.status_tratamento ? v.status_tratamento.nome : '-';
            document.getElementById('view-plano').value = v.plano ? v.plano.nome : '-';
            document.getElementById('view-pagamento').value = v.forma_pagamento ? v.forma_pagamento.nome : '-';

            // Dados Editáveis (Cliente e Endereço) - Carregados do objeto venda
            document.getElementById('edit-cliente').value = v.cliente.nome_razao_social || '';
            document.getElementById('edit-cpf').value = v.cliente.cpf_cnpj || '';
            document.getElementById('edit-nome-mae').value = v.nome_mae || '';
            document.getElementById('edit-nasc').value = v.data_nascimento || '';
            document.getElementById('edit-nome-rep').value = v.nome_representante_legal || '';
            document.getElementById('edit-cpf-rep').value = v.cpf_representante_legal || '';
            document.getElementById('edit-tel1').value = v.telefone1 || '';
            document.getElementById('edit-tel2').value = v.telefone2 || '';
            
            document.getElementById('edit-cep').value = v.cep || '';
            document.getElementById('edit-logradouro').value = v.logradouro || '';
            document.getElementById('edit-numero').value = v.numero_residencia || '';
            document.getElementById('edit-complemento').value = v.complemento || '';
            document.getElementById('edit-bairro').value = v.bairro || '';
            document.getElementById('edit-cidade').value = v.cidade || '';
            document.getElementById('edit-estado').value = v.estado || '';
            document.getElementById('edit-referencia').value = v.ponto_referencia || '';
            document.getElementById('edit-obs').value = v.observacoes || '';

            modalDetalhes.show();
        }

        // FUNÇÃO QUE ESTAVA FALTANDO: Salvar alterações do modal de edição
        async function salvarAlteracoes() {
            const id = document.getElementById('edit-id').value;
            if(!id) return;
            
            const btn = document.getElementById('btn-salvar-detalhes');
            btn.disabled = true; btn.innerHTML = 'Salvando...';

            const payload = {
                nome_mae: document.getElementById('edit-nome-mae').value,
                data_nascimento: document.getElementById('edit-nasc').value,
                nome_representante_legal: document.getElementById('edit-nome-rep').value,
                cpf_representante_legal: document.getElementById('edit-cpf-rep').value,
                telefone1: document.getElementById('edit-tel1').value,
                telefone2: document.getElementById('edit-tel2').value,
                cep: document.getElementById('edit-cep').value,
                logradouro: document.getElementById('edit-logradouro').value,
                numero_residencia: document.getElementById('edit-numero').value,
                complemento: document.getElementById('edit-complemento').value,
                bairro: document.getElementById('edit-bairro').value,
                cidade: document.getElementById('edit-cidade').value,
                estado: document.getElementById('edit-estado').value,
                ponto_referencia: document.getElementById('edit-referencia').value,
                observacoes: document.getElementById('edit-obs').value
            };

            try {
                await apiClient.patch(`/api/crm/vendas/${id}/`, payload);
                alert("Dados atualizados com sucesso!");
                modalDetalhes.hide();
                carregarVendas(true);
            } catch(e) {
                mostrarErroDetalhado(e, "salvar alterações");
            } finally {
                btn.disabled = false; btn.innerHTML = 'Salvar Dados';
            }
        }

        // FUNÇÃO QUE ESTAVA FALTANDO: Buscar CEP
        async function buscarCepEdit(e) {
            const cep = e.target.value.replace(/\D/g, '');
            if(cep.length !== 8) return;
            
            try {
                const res = await axios.get(`https://viacep.com.br/ws/${cep}/json/`);
                if(!res.data.erro) {
                    document.getElementById('edit-logradouro').value = res.data.logradouro;
                    document.getElementById('edit-bairro').value = res.data.bairro;
                    document.getElementById('edit-cidade').value = res.data.localidade;
                    document.getElementById('edit-estado').value = res.data.uf;
                    document.getElementById('edit-numero').focus();
                } else {
                    alert('CEP não encontrado.');
                }
            } catch(error) {
                console.error('Erro CEP:', error);
            }
        }

        function copiarMensagem() { 
            const txt = document.getElementById('aprovacao-mensagem');
            txt.select();
            navigator.clipboard.writeText(txt.value).then(() => { alert('Copiado!'); });
        }
        
        function logout() { localStorage.removeItem('accessToken'); window.location.href = '/'; }
    </script>
</body>
</html>