{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditoria de Vendas - Record PAP</title>
    <link rel="shortcut icon" href="{% static 'logo.png' %}" type="image/x-icon">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <link rel="stylesheet" href="{% static 'css/custom_styles.css' %}?v=3.3">
    
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
    
    <style>
        /* Estilos Específicos da Auditoria */
        .script-section { 
            background-color: #fff; 
            border-left: 5px solid var(--cor-primaria, #0d6efd); 
            padding: 25px; 
            margin-bottom: 25px; 
            border-radius: 6px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .script-title { 
            color: var(--cor-primaria, #0d6efd); 
            font-weight: 800; 
            margin-bottom: 15px; 
            text-transform: uppercase; 
            font-size: 0.95rem; 
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .script-text { 
            font-size: 1.15rem; 
            line-height: 1.6; 
            color: #212529; 
            margin-bottom: 15px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .script-highlight {
            background-color: #e8f0fe;
            padding: 2px 6px;
            border-radius: 4px;
            color: #0d6efd;
            font-weight: bold;
        }
        
        /* Badges e Tabela */
        .auditor-badge { 
            font-size: 0.75rem; 
            background: #e9ecef; 
            color: #495057; 
            padding: 4px 10px; 
            border-radius: 4px; 
            border: 1px solid #dee2e6; 
            display: inline-flex; 
            align-items: center; 
            gap: 5px; 
            font-weight: 600;
        }
        .locked-row { opacity: 0.9; background-color: #fffbf0 !important; }
        
        /* Inputs no script */
        .form-control-script {
            border: 1px solid #ced4da;
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        .form-control-script:focus {
            background-color: #fff;
            border-color: var(--cor-primaria, #0d6efd);
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
        }
        .input-readonly-look {
            background-color: #e9ecef !important;
            border: none;
        }

        /* Botões */
        .btn-auditar {
            background-color: #212529; 
            color: white;
            border-radius: 50px; 
            padding: 6px 16px;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border: none;
            transition: transform 0.2s, box-shadow 0.2s;
            text-decoration: none;
        }
        .btn-auditar:hover { 
            background-color: #000; 
            transform: translateY(-1px); 
            color: #fff; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        
        /* Overlay */
        .loading-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 9999; text-align: center; padding-top: 20%;
        }
    </style>
</head>
<body>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Carregando...</span>
        </div>
    </div>

    <header class="main-header">
        <div class="header-container">
            <a href="/"><img src="{% static 'logo.png' %}" alt="Record PAP Logo" class="logo"></a>
            <button class="menu-toggle" id="menu-toggle"><div class="bar"></div><div class="bar"></div><div class="bar"></div></button>
            <nav class="main-nav" id="main-nav">
                <ul>
                    <li><a href="/area-interna/">Voltar</a></li>
                    <li><button onclick="logout()" class="nav-button logout-button">Sair</button></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="area-interna-section">
        <div class="system-container" style="max-width: 1600px;">
            
            <div class="d-flex justify-content-between align-items-center mb-4 header-controls">
                <div>
                    <h1 style="font-size: 1.8rem; margin: 0;">Auditoria de Vendas</h1>
                    <p class="text-muted mb-0">Validação de dados e qualidade (Script Editável).</p>
                </div>
                <button class="btn btn-outline-primary fw-bold shadow-sm" onclick="carregarVendasPendentes()">
                    <i class="bi bi-arrow-clockwise"></i> Atualizar Lista
                </button>
            </div>

            <div class="card border-0 shadow-none" style="background: transparent;">
                <div class="table-responsive" style="overflow-y: visible; overflow-x: auto; padding: 4px;">
                    <table class="table table-hover mb-0 bg-white rounded shadow-sm align-middle">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-3">ID</th>
                                <th>Data Venda</th>
                                <th>Cliente / CPF</th>
                                <th>Vendedor</th>
                                <th>Produto</th>
                                <th>Status Tratamento</th>
                                <th>Auditor</th>
                                <th class="text-end pe-4">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="listaVendasBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <div class="modal fade" id="modalAuditoria" tabindex="-1" data-bs-backdrop="static" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-headset me-2"></i>Roteiro de Auditoria - Venda #<span id="script-id-venda"></span></h5>
                    <button type="button" class="btn-close btn-close-white" onclick="fecharScriptSemSalvar()"></button>
                </div>
                <div class="modal-body bg-light">
                    <input type="hidden" id="auditoria_id_venda">
                    
                    <div class="container py-4" style="max-width: 1100px;">
                        
                        <div class="script-section">
                            <div class="script-title">1. Introdução</div>
                            <p class="script-text">
                                "Bom (dia/tarde), tudo bem? Aqui é <strong><span id="script-user-logado" class="text-primary text-uppercase"></span></strong> da Nio Fibra. 
                                Estou ligando para confirmar os dados do seu pedido e passar algumas informações importantes. 
                                Posso prosseguir com a auditoria?"
                            </p>
                        </div>

                        <div class="script-section">
                            <div class="script-title">2. Confirmação de Identidade</div>
                            
                            <p class="script-text mb-1">"Poderia, por gentileza, confirmar seu nome completo?"</p>
                            <div class="mb-3">
                                <input type="text" class="form-control form-control-script uppercase-input fs-5 text-primary" id="audit-cliente-nome">
                            </div>

                            <p class="script-text mb-1">"Poderia me informar os três primeiros números do seu CPF?"</p>
                            <div class="mb-3">
                                 <input type="text" class="form-control form-control-script" id="audit-cliente-cpf" maxlength="18" onkeyup="mascaraCPF(this)">
                            </div>

                            <p class="script-text mb-1">"Poderia confirmar o nome da sua mãe e sua data de nascimento?"</p>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="small text-muted">Mãe</label>
                                    <input type="text" class="form-control form-control-script uppercase-input" id="audit-nome-mae">
                                </div>
                                <div class="col-md-3">
                                    <label class="small text-muted">Data Nasc.</label>
                                    <input type="date" class="form-control form-control-script" id="audit-data-nasc" onchange="calcularIdadeAuto()">
                                </div>
                                <div class="col-md-3">
                                    <label class="small text-muted">Idade</label>
                                    <input type="text" class="form-control bg-white" id="audit-idade-calc" readonly>
                                </div>
                            </div>
                        </div>

                        <div class="script-section">
                            <div class="script-title">3. Contato e WhatsApp</div>
                            <p class="script-text mb-2">"Qual é o seu número de telefone no WhatsApp?"</p>
                            
                            <div class="mb-3" style="max-width: 400px;">
                                <div class="input-group">
                                    <span class="input-group-text bg-success text-white"><i class="bi bi-whatsapp"></i></span>
                                    <input type="text" class="form-control form-control-script fs-5" id="audit-tel1" maxlength="15" onkeyup="mascaraTelefone(this)">
                                </div>
                            </div>

                            <div class="alert alert-warning border-warning my-4">
                                <div class="d-flex">
                                    <div class="me-3 fs-3"><i class="bi bi-exclamation-triangle-fill text-warning"></i></div>
                                    <div>
                                        <h6 class="fw-bold">Aviso Importante (Ler Obrigatóriamente):</h6>
                                        <p class="mb-0 fst-italic fs-5">
                                            "Lembrando que é nesse número que você receberá a confirmação do pedido. 
                                            Para confirmar a instalação, preciso que após receber a mensagem da Nio no seu WhatsApp você digite <strong>'SIM'</strong>. 
                                            No WhatsApp da Nio, você poderá acompanhar a instalação em tempo real e até mesmo reagendar. Ficou claro?"
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <p class="script-text mb-2">"Poderia me informar um segundo telefone de contato e seu e-mail?"</p>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="small text-muted">Tel 2</label>
                                    <input type="text" class="form-control form-control-script" id="audit-tel2" maxlength="15" onkeyup="mascaraTelefone(this)">
                                </div>
                                <div class="col-md-8">
                                    <label class="small text-muted">E-mail</label>
                                    <input type="email" class="form-control form-control-script" id="audit-email">
                                </div>
                            </div>
                        </div>

                        <div class="script-section">
                            <div class="script-title">4. Endereço de Instalação</div>
                            <p class="script-text mb-3">"Agora, vamos confirmar o seu endereço de instalação. Poderia confirmar Nome da Rua, Número e CEP?"</p>
                            
                            <div class="row g-2">
                                <div class="col-md-2">
                                    <div class="form-floating">
                                        <input type="text" class="form-control form-control-script" id="audit-cep" maxlength="9" onkeyup="mascaraCEP(this)">
                                        <label>CEP</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="text" class="form-control form-control-script uppercase-input" id="audit-logradouro">
                                        <label>Rua / Logradouro</label>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-floating">
                                        <input type="text" class="form-control form-control-script" id="audit-numero">
                                        <label>Número</label>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-floating">
                                        <input type="text" class="form-control form-control-script uppercase-input" id="audit-uf">
                                        <label>UF</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-floating">
                                        <input type="text" class="form-control form-control-script uppercase-input" id="audit-complemento">
                                        <label>Complemento</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-floating">
                                        <input type="text" class="form-control form-control-script uppercase-input" id="audit-bairro">
                                        <label>Bairro</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-floating">
                                        <input type="text" class="form-control form-control-script uppercase-input" id="audit-cidade">
                                        <label>Cidade</label>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="form-floating">
                                        <input type="text" class="form-control form-control-script uppercase-input" id="audit-ref">
                                        <label>Ponto de Referência</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="script-section">
                            <div class="script-title">5. Plano e Pagamento</div>
                            
                            <div class="p-3 bg-primary-subtle border border-primary rounded mb-3">
                                <p class="script-text mb-0">
                                    "O plano que você contratou foi o <strong class="text-primary text-uppercase" id="txt-plano-nome">...</strong> 
                                    com o valor de <strong class="text-success" id="txt-plano-valor">R$ ...</strong> 
                                    e a forma de pagamento foi <strong class="text-dark text-uppercase" id="txt-pagamento-nome">...</strong>."
                                </p>
                            </div>

                            <p class="script-text mb-3">"A fidelidade do plano é de 12 meses. Você está ciente do valor contratado, do plano e da fidelidade mencionada?"</p>

                            <div class="row g-3 p-3 bg-light rounded border">
                                <div class="col-12 text-muted fw-bold small text-uppercase mb-1">Dados do Sistema (Corrija se necessário):</div>
                                <div class="col-md-6">
                                    <label class="form-label small">Plano Selecionado</label>
                                    <select class="form-select form-control-script" id="audit-plano" onchange="atualizarTextoPlano()"></select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small">Forma de Pagamento</label>
                                    <select class="form-select form-control-script" id="audit-pagamento" onchange="atualizarTextoPlano()"></select>
                                </div>
                            </div>
                        </div>

                        <div class="script-section">
                            <div class="script-title">6. Agendamento & Observações</div>
                            <p class="script-text mb-3">"Poderia me informar qual o melhor dia da semana e horário (manhã ou tarde) para agendarmos a instalação?"</p>
                            
                            <div class="card bg-light border-0 mb-3">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-3 text-muted text-uppercase small fw-bold">Agendamento Preferencial (Vendedor)</h6>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">Data</label>
                                            <input type="date" class="form-control" id="audit-data-agendamento">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">Turno</label>
                                            <select class="form-select" id="audit-turno-agendamento">
                                                <option value="">Não agendado</option>
                                                <option value="MANHA">Manhã</option>
                                                <option value="TARDE">Tarde</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-2">
                                <label class="form-label fw-bold text-danger">Observações da Auditoria (Obrigatório se houver divergência)</label>
                                <textarea class="form-control uppercase-input" id="script-obs-venda" rows="3" placeholder="Anote aqui qualquer divergência, correção ou detalhe importante..."></textarea>
                            </div>
                        </div>

                        <div class="script-section">
                            <div class="script-title">7. Encerramento</div>
                            <p class="script-text">
                                "Para finalizar, gostaria de informar que temos o aplicativo Nio. Nele, você pode acompanhar a internet, 
                                solicitar fatura e pedir suporte. Qualquer dúvida, você pode entrar em contato conosco pelo WhatsApp.
                                Agradeço sua atenção e tenha um ótimo dia!"
                            </p>
                        </div>

                    </div>
                </div>
                
                <div class="modal-footer bg-light justify-content-between flex-wrap shadow-lg">
                    <button type="button" class="btn btn-danger btn-lg fw-bold" onclick="abrirModalReprovacao()">
                        <i class="bi bi-x-circle-fill"></i> REPROVAR / PENDENCIAR
                    </button>
                    
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-secondary btn-lg" onclick="fecharScriptSemSalvar()">
                            Sair (Liberar)
                        </button>
                        
                        <button type="button" class="btn btn-success btn-lg fw-bold" onclick="finalizarComoAuditada()">
                            <i class="bi bi-check-circle-fill"></i> APROVAR (Só Auditar)
                        </button>

                        <button type="button" class="btn btn-primary btn-lg fw-bold" onclick="prepararAgendamento()">
                            <i class="bi bi-calendar-plus-fill"></i> APROVAR E CADASTRAR
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal-reprovacao" tabindex="-1" style="z-index: 1060;">
        <div class="modal-dialog">
            <div class="modal-content border-danger">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Reprovar / Pendenciar Venda</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Selecione o motivo de reprovação ou pendência:</p>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Novo Status</label>
                        <select class="form-select" id="repro-status">
                            <option value="">Carregando...</option>
                        </select>
                    </div>

                    <div id="div-campos-aguardando-pagamento" style="display: none;" class="p-3 mb-3 bg-light border rounded">
                        <div class="text-danger small fw-bold text-uppercase mb-2">Preencha os dados do pedido criado:</div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Número da O.S. <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="repro-os" placeholder="Ex: 12345">
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <label class="form-label fw-bold">Data Agendada <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="repro-data">
                            </div>
                            <div class="col-6">
                                <label class="form-label fw-bold">Turno <span class="text-danger">*</span></label>
                                <select class="form-select" id="repro-turno">
                                    <option value="">Selecione...</option>
                                    <option value="MANHA">Manhã</option>
                                    <option value="TARDE">Tarde</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Observação Obrigatória</label>
                        <textarea class="form-control uppercase-input" id="repro-obs" rows="4"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" onclick="confirmarReprovacao()">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal-aprovacao" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Venda Aprovada!</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Copie a mensagem abaixo para enviar no grupo:</p>
                    <textarea id="aprovacao-mensagem" class="form-control mb-3" rows="12" readonly></textarea>
                    <button id="btn-copiar" class="btn btn-outline-success w-100" onclick="copiarMensagem()">
                        <i class="bi bi-whatsapp"></i> Copiar Mensagem
                    </button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal-agendamento" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content border-primary">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Dados do Agendamento (Esteira)</h5>
                    <button type="button" class="btn-close btn-close-white" onclick="cancelarAgendamento()"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info small">Você está aprovando e movendo para a esteira (<strong>CADASTRADA</strong>). Preencha a O.S.</div>
                    <form id="form-agendamento">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Número da O.S. <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="agenda-os" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Data Agendada <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="agenda-data-final" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Turno <span class="text-danger">*</span></label>
                                <select class="form-select" id="agenda-turno-final" required>
                                    <option value="">Selecione...</option>
                                    <option value="MANHA">Manhã</option>
                                    <option value="TARDE">Tarde</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="cancelarAgendamento()">Voltar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarAgendamentoFinal()">Confirmar e Enviar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'js/auth.js' %}?v=3.1"></script>
    <script src="{% static 'js/menu.js' %}?v=1.3"></script>
    
    <script>
        // Configurações Globais
        const API_BASE = '/api/crm/vendas';
        const API_AUX = '/api/crm';
        
        let vendas = [];
        let vendaEmAuditoria = null;
        let globalStatusOptions = [];
        let planosOptions = [];
        let formasPagamentoOptions = [];

        // Inicialização dos Modais
        const modalAuditoria = new bootstrap.Modal(document.getElementById('modalAuditoria'));
        const modalReprovacao = new bootstrap.Modal(document.getElementById('modal-reprovacao'));
        const modalAprovacao = new bootstrap.Modal(document.getElementById('modal-aprovacao'));
        const modalAgendamento = new bootstrap.Modal(document.getElementById('modal-agendamento'));

        $(document).ready(function() {
            if (!localStorage.getItem('accessToken')) {
                window.location.href = '/';
                return;
            }

            $(document).on('input', '.uppercase-input', function() {
                this.value = this.value.toUpperCase();
            });

            // Monitorar mudança no dropdown de reprovação para mostrar campos extras
            $('#repro-status').change(function() {
                const text = $(this).find('option:selected').text().toUpperCase();
                if(text.includes('AGUARDANDO PAGAMENTO')) {
                    $('#div-campos-aguardando-pagamento').slideDown();
                } else {
                    $('#div-campos-aguardando-pagamento').slideUp();
                    $('#repro-os').val('');
                    // Se ocultar, podemos optar por limpar ou manter os dados. 
                    // Como já copiamos do principal ao abrir, talvez seja melhor manter ou limpar. 
                    // Vou limpar para evitar envio acidental se mudar de status.
                    // Mas vou restaurar os valores originais da auditoria caso o usuário volte atrás?
                    // Por simplicidade, vou limpar apenas o OS que é exclusivo daqui.
                    // Data e Turno vou manter preenchidos caso ele volte para Aguardando Pagamento.
                }
            });

            carregarAuxiliares().then(() => {
                carregarVendasPendentes();
            });
            
            iniciarMonitoramentoInatividade();
        });

        // --- MÁSCARAS ---
        function mascaraCPF(i) {
            let v = i.value;
            if(v.length > 14) { 
                v = v.replace(/\D/g, "").replace(/^(\d{2})(\d)/, "$1.$2").replace(/^(\d{2})\.(\d{3})(\d)/, "$1.$2.$3").replace(/\.(\d{3})(\d)/, ".$1/$2").replace(/(\d{4})(\d)/, "$1-$2");
            } else { 
                v = v.replace(/\D/g, "").replace(/(\d{3})(\d)/, "$1.$2").replace(/(\d{3})(\d)/, "$1.$2").replace(/(\d{3})(\d{1,2})$/, "$1-$2");
            }
            i.value = v;
        }

        function mascaraTelefone(i) {
            let v = i.value.replace(/\D/g, "").replace(/^(\d{2})(\d)/g, "($1) $2").replace(/(\d)(\d{4})$/, "$1-$2");
            i.value = v;
        }

        function mascaraCEP(i) {
            let v = i.value.replace(/\D/g, "").replace(/^(\d{5})(\d)/, "$1-$2");
            i.value = v;
        }

        function aplicarMascarasManuais() {
            const els = ['audit-cliente-cpf', 'audit-tel1', 'audit-tel2', 'audit-cep'];
            els.forEach(id => {
                const el = document.getElementById(id);
                if(el && el.value) {
                    if(id.includes('cpf')) mascaraCPF(el);
                    else if(id.includes('tel')) mascaraTelefone(el);
                    else if(id.includes('cep')) mascaraCEP(el);
                }
            });
        }

        function iniciarMonitoramentoInatividade() {
            let tempoInativo = 0;
            const TEMPO_LIMITE = 15 * 60; 
            function resetar() { tempoInativo = 0; }
            document.onmousemove = resetar;
            document.onclick = resetar;
            document.onkeypress = resetar;
            setInterval(() => {
                tempoInativo++;
                if (tempoInativo >= TEMPO_LIMITE) logout();
            }, 1000);
        }

        async function carregarAuxiliares() {
            try {
                const [statusRes, planosRes, pagRes] = await Promise.all([
                    apiClient.get(`${API_AUX}/status/?tipo=Tratamento`),
                    apiClient.get(`${API_AUX}/planos/`),
                    apiClient.get(`${API_AUX}/formas-pagamento/`)
                ]);
                globalStatusOptions = statusRes.data;
                planosOptions = planosRes.data;
                formasPagamentoOptions = pagRes.data;

                const selPlano = $('#audit-plano');
                const selPag = $('#audit-pagamento');
                selPlano.empty().append('<option value="">Selecione...</option>');
                selPag.empty().append('<option value="">Selecione...</option>');
                
                planosOptions.forEach(p => selPlano.append(`<option value="${p.id}">${p.nome}</option>`));
                formasPagamentoOptions.forEach(f => selPag.append(`<option value="${f.id}">${f.nome}</option>`));
            } catch(e) { console.error("Erro auxiliares", e); }
        }

        // --- ATUALIZA TEXTO DO PLANO ---
        function atualizarTextoPlano() {
            const planoId = $('#audit-plano').val();
            const pagId = $('#audit-pagamento').val();
            
            const plano = planosOptions.find(p => p.id == planoId);
            const pag = formasPagamentoOptions.find(f => f.id == pagId);
            
            if (plano) {
                $('#txt-plano-nome').text(plano.nome.toUpperCase());
                $('#txt-plano-valor').text('R$ ' + parseFloat(plano.valor).toFixed(2).replace('.', ','));
            } else {
                $('#txt-plano-nome').text('...');
                $('#txt-plano-valor').text('R$ ...');
            }
            
            if (pag) {
                $('#txt-pagamento-nome').text(pag.nome.toUpperCase());
            } else {
                $('#txt-pagamento-nome').text('...');
            }
        }

        function carregarVendasPendentes() {
            $('#loadingOverlay').show();
            apiClient.get(`${API_BASE}/pendentes_auditoria/`)
            .then(response => {
                const tbody = $('#listaVendasBody');
                tbody.empty();
                const lista = response.data.results || response.data;

                if (!lista || lista.length === 0) {
                    tbody.append('<tr><td colspan="8" class="text-center text-muted py-4">Nenhuma venda pendente.</td></tr>');
                    return;
                }

                lista.forEach(v => {
                    let nomeCliente = 'N/A';
                    let cpfCliente = '-';
                    
                    if (v.cliente && typeof v.cliente === 'object') {
                        nomeCliente = v.cliente.nome_razao_social || 'N/A';
                        cpfCliente = v.cliente.cpf_cnpj || '-';
                    } else {
                         nomeCliente = v.cliente_nome_razao_social || v.cliente_nome || 'N/A';
                         cpfCliente = v.cliente_cpf_cnpj || v.cliente_cpf || '-';
                    }

                    let nomeVendedor = v.vendedor_nome || (v.vendedor ? v.vendedor.username : 'N/A');
                    let produto = (v.plano && v.plano.nome) ? v.plano.nome : (v.plano_nome || '-');
                    let statusNome = (v.status_tratamento && v.status_tratamento.nome) ? v.status_tratamento.nome : (v.status_tratamento || '-');
                    let dataFormatada = v.data_criacao ? new Date(v.data_criacao).toLocaleDateString('pt-BR') : '-';

                    let token = localStorage.getItem('accessToken');
                    let myId = token ? parseInt(jwt_decode(token).user_id) : null;
                    const nomeAuditor = v.auditor_atual_nome || `ID: ${v.auditor_atual}`;
                    
                    let auditorInfo = '-';
                    let btnHtml = '';
                    let classeLinha = '';

                    if (v.auditor_atual && v.auditor_atual !== myId) {
                        classeLinha = 'locked-row';
                        auditorInfo = `
                            <div class="d-flex align-items-center gap-2">
                                <span class="auditor-badge text-truncate" style="max-width: 100px;" title="${nomeAuditor}">
                                    <i class="bi bi-lock-fill"></i> ${nomeAuditor}
                                </span>
                                <button class="btn btn-sm btn-outline-danger border-0" onclick="forcarLiberacao(${v.id})" title="Desbloquear (Admin)">
                                    <i class="bi bi-unlock"></i>
                                </button>
                            </div>`;
                        btnHtml = `<span class="badge bg-secondary">Em uso</span>`;
                    } else if (v.auditor_atual === myId) {
                        auditorInfo = `<span class="auditor-badge bg-success text-white">VOCÊ</span>`;
                        btnHtml = `<button class="btn btn-auditar" onclick="retomarAuditoria(${v.id})"><i class="bi bi-play-circle"></i> Continuar</button>`;
                    } else {
                        btnHtml = `<button class="btn btn-auditar" onclick="tentarAuditoria(${v.id})"><i class="bi bi-headset"></i> Auditar</button>`;
                    }

                    tbody.append(`
                        <tr class="${classeLinha}">
                            <td class="fw-bold text-primary">#${v.id}</td>
                            <td>${dataFormatada}</td>
                            <td>
                                <div class="fw-bold text-dark">${nomeCliente}</div>
                                <div class="small text-muted" style="font-size: 0.8rem;">${cpfCliente}</div>
                            </td>
                            <td>${nomeVendedor}</td>
                            <td>${produto}</td>
                            <td><span class="badge bg-warning text-dark">${statusNome}</span></td>
                            <td>${auditorInfo}</td>
                            <td class="text-end">${btnHtml}</td>
                        </tr>
                    `);
                });
            })
            .catch(e => { console.error(e); alert('Erro ao carregar vendas.'); })
            .finally(() => $('#loadingOverlay').hide());
        }

        function tentarAuditoria(id) {
            if(!confirm(`Iniciar auditoria da Venda #${id}?`)) return;
            alocarVenda(id);
        }

        function retomarAuditoria(id) {
            carregarDadosNoScript(id);
        }

        function alocarVenda(id) {
            $('#loadingOverlay').show();
            apiClient.post(`${API_BASE}/${id}/alocar-auditoria/`, {})
            .then(() => carregarDadosNoScript(id))
            .catch(err => { 
                $('#loadingOverlay').hide();
                if(err.response && err.response.status === 409) {
                    alert('Venda já alocada por outro auditor.');
                    carregarVendasPendentes();
                } else {
                    alert('Erro ao alocar venda.');
                }
            });
        }

        function forcarLiberacao(id) {
            if(!confirm("Forçar desbloqueio? (Apenas Admin/Supervisor)")) return;
            $('#loadingOverlay').show();
            apiClient.post(`${API_BASE}/${id}/liberar-auditoria/`, {})
            .then(() => { alert("Liberada."); carregarVendasPendentes(); })
            .catch(() => { $('#loadingOverlay').hide(); alert("Sem permissão."); });
        }

        // --- CARREGAR DADOS NO MODAL (SCRIPT) ---
        function carregarDadosNoScript(id) {
            apiClient.get(`${API_BASE}/${id}/`)
            .then(res => {
                const v = res.data;
                vendaEmAuditoria = v;

                $('#loadingOverlay').hide();
                $('#auditoria_id_venda').val(v.id);
                $('#script-id-venda').text(v.id);
                
                try {
                    const tokenDecoded = jwt_decode(localStorage.getItem('accessToken'));
                    $('#script-user-logado').text(tokenDecoded.user_name || tokenDecoded.username || 'Consultor');
                } catch(e) {}

                const nomeCli = (v.cliente && v.cliente.nome_razao_social) ? v.cliente.nome_razao_social : (v.cliente_nome_razao_social || '');
                const cpfCli = (v.cliente && v.cliente.cpf_cnpj) ? v.cliente.cpf_cnpj : (v.cliente_cpf_cnpj || '');
                const emailCli = (v.cliente && v.cliente.email) ? v.cliente.email : (v.cliente_email || '');

                $('#audit-cliente-nome').val(nomeCli);
                $('#audit-cliente-cpf').val(cpfCli);
                $('#audit-email').val(emailCli);

                $('#audit-nome-mae').val(v.nome_mae || '');
                $('#audit-data-nasc').val(v.data_nascimento || '');
                $('#audit-tel1').val(v.telefone1 || '');
                $('#audit-tel2').val(v.telefone2 || '');
                
                $('#audit-cep').val(v.cep || '');
                $('#audit-logradouro').val(v.logradouro || '');
                $('#audit-numero').val(v.numero_residencia || '');
                $('#audit-complemento').val(v.complemento || '');
                $('#audit-bairro').val(v.bairro || '');
                $('#audit-cidade').val(v.cidade || '');
                $('#audit-uf').val(v.estado || '');
                $('#audit-ref').val(v.ponto_referencia || '');

                const planoId = (v.plano && v.plano.id) ? v.plano.id : v.plano;
                const pagId = (v.forma_pagamento && v.forma_pagamento.id) ? v.forma_pagamento.id : v.forma_pagamento;
                
                if(planoId) $('#audit-plano').val(planoId);
                if(pagId) $('#audit-pagamento').val(pagId);

                // Preencher campos de agendamento (também usado no modal reprovação se tiver)
                $('#audit-data-agendamento').val(v.data_agendamento || '');
                $('#audit-turno-agendamento').val(v.periodo_agendamento || '');
                $('#script-obs-venda').val(v.observacoes || '');

                calcularIdadeAuto();
                atualizarTextoPlano(); 
                aplicarMascarasManuais(); 
                modalAuditoria.show();
            })
            .catch(e => {
                console.error(e);
                $('#loadingOverlay').hide();
                alert('Erro ao abrir venda.');
            });
        }

        function calcularIdadeAuto() {
            const dn = $('#audit-data-nasc').val();
            if(!dn) { $('#audit-idade-calc').val(''); return; }
            const nasc = new Date(dn);
            const hoje = new Date();
            let idade = hoje.getFullYear() - nasc.getFullYear();
            if (hoje.getMonth() < nasc.getMonth() || (hoje.getMonth() === nasc.getMonth() && hoje.getDate() < nasc.getDate())) idade--;
            $('#audit-idade-calc').val(idade + ' anos');
        }

        function coletarDadosAuditoria() {
            return {
                cliente_nome: $('#audit-cliente-nome').val(),
                cliente_cpf: $('#audit-cliente-cpf').val(),
                cliente_email: $('#audit-email').val(),
                nome_mae: $('#audit-nome-mae').val(),
                data_nascimento: $('#audit-data-nasc').val(),
                telefone1: $('#audit-tel1').val(),
                telefone2: $('#audit-tel2').val(),
                cep: $('#audit-cep').val(),
                logradouro: $('#audit-logradouro').val(),
                numero: $('#audit-numero').val(),
                complemento: $('#audit-complemento').val(),
                bairro: $('#audit-bairro').val(),
                cidade: $('#audit-cidade').val(),
                estado: $('#audit-uf').val(),
                referencia: $('#audit-ref').val(),
                plano: $('#audit-plano').val(),
                forma_pagamento: $('#audit-pagamento').val(),
                data_agendamento: $('#audit-data-agendamento').val(),
                periodo_agendamento: $('#audit-turno-agendamento').val()
            };
        }

        function finalizarComoAuditada() {
            if(!confirm("Aprovar venda como AUDITADA?")) return;
            enviarFinalizacao('AUDITADA', $('#script-obs-venda').val(), coletarDadosAuditoria());
        }

        async function abrirModalReprovacao() {
            const sel = $('#repro-status');
            
            if (globalStatusOptions.length === 0) {
                 try {
                    const statusRes = await apiClient.get(`${API_AUX}/status/?tipo=Tratamento`);
                    globalStatusOptions = statusRes.data;
                 } catch(e) { console.log("Tentativa de recarga falhou", e); }
            }

            sel.empty().append('<option value="">Selecione...</option>');
            
            if (globalStatusOptions.length > 0) {
                const repros = globalStatusOptions.filter(s => {
                    const nm = s.nome.toUpperCase();
                    return !nm.includes('AUDITADA') && !nm.includes('APROVAD') && !nm.includes('CADASTRAD');
                });
                repros.forEach(s => sel.append(`<option value="${s.id}">${s.nome}</option>`));
            } else {
                sel.append('<option disabled>Nenhum status carregado</option>');
            }
            
            // Reseta campos extras e O.S. (não existe na Seção 6)
            $('#div-campos-aguardando-pagamento').hide();
            $('#repro-os').val('');
            
            // COPIA VALORES DA SEÇÃO 6 PARA O MODAL
            $('#repro-data').val($('#audit-data-agendamento').val());
            $('#repro-turno').val($('#audit-turno-agendamento').val());

            $('#repro-obs').val($('#script-obs-venda').val()); 
            modalReprovacao.show();
        }

        function confirmarReprovacao() {
            const stId = $('#repro-status').val();
            const obs = $('#repro-obs').val();
            const stText = $('#repro-status option:selected').text().toUpperCase();
            
            if(!stId || !obs) { alert('Selecione o status e informe o motivo.'); return; }

            // Lógica Especial para AGUARDANDO PAGAMENTO
            if (stText.includes('AGUARDANDO PAGAMENTO')) {
                const os = $('#repro-os').val();
                const dt = $('#repro-data').val();
                const tr = $('#repro-turno').val();

                if (!os || !dt || !tr) {
                    alert('Para este status, é obrigatório informar O.S, Data e Turno.');
                    return;
                }

                $('#loadingOverlay').show();
                
                // 1. Salva dados de agendamento via PATCH antes de finalizar
                apiClient.patch(`${API_BASE}/${vendaEmAuditoria.id}/`, {
                    ordem_servico: os,
                    data_agendamento: dt,
                    periodo_agendamento: tr
                })
                .then(() => {
                    // 2. Finaliza auditoria com o status
                    const dados = coletarDadosAuditoria();
                    // Atualiza dados locais tbm para garantir envio correto no zap
                    dados.data_agendamento = dt;
                    dados.periodo_agendamento = tr;
                    
                    return enviarFinalizacao(stId, obs, dados, true);
                })
                .catch(e => {
                    console.error(e);
                    alert('Erro ao salvar dados de agendamento: ' + e.message);
                    $('#loadingOverlay').hide();
                });

            } else {
                // Fluxo Normal de Reprovação
                $('#loadingOverlay').show();
                enviarFinalizacao(stId, obs, coletarDadosAuditoria(), true); 
            }
        }

        function prepararAgendamento() {
            const dados = coletarDadosAuditoria();
            if(!dados.plano || !dados.forma_pagamento) { alert('Selecione Plano e Pagamento.'); return; }
            
            modalAuditoria.hide();
            $('#agenda-os').val(vendaEmAuditoria.ordem_servico || '');
            if(dados.data_agendamento) $('#agenda-data-final').val(dados.data_agendamento);
            if(dados.periodo_agendamento) $('#agenda-turno-final').val(dados.periodo_agendamento);
            modalAgendamento.show();
        }

        function salvarAgendamentoFinal() {
            const os = $('#agenda-os').val();
            const dt = $('#agenda-data-final').val();
            const tr = $('#agenda-turno-final').val();
            if(!os || !dt || !tr) { alert('Preencha todos os campos.'); return; }

            $('#loadingOverlay').show();
            
            // Busca AGENDADO na esteira (em vez de CADASTRADA)
            apiClient.get(`${API_AUX}/status/?tipo=Esteira`)
            .then(res => {
                const st = res.data.find(s => s.nome.toUpperCase() === 'AGENDADO');
                if(!st) throw new Error("Status AGENDADO não encontrado.");
                return apiClient.patch(`${API_BASE}/${vendaEmAuditoria.id}/`, {
                    ordem_servico: os, data_agendamento: dt, periodo_agendamento: tr, status_esteira: st.id
                });
            })
            .then(() => {
                const dados = coletarDadosAuditoria();
                dados.data_agendamento = dt; 
                dados.periodo_agendamento = tr;
                // Envia CADASTRADA como status de Tratamento
                return enviarFinalizacao('CADASTRADA', $('#script-obs-venda').val(), dados, false, true);
            })
            .catch(e => {
                console.error(e);
                alert('Erro ao cadastrar: ' + e.message);
                $('#loadingOverlay').hide();
            });
        }

        function enviarFinalizacao(statusParam, obs, dadosEdicao, fechaModalRepro=false, abreZapAprovacao=false) {
            const payload = { status: statusParam, observacoes: obs, dados_atualizados: dadosEdicao };
            
            return apiClient.post(`${API_BASE}/${vendaEmAuditoria.id}/finalizar_auditoria/`, payload)
            .then(() => {
                alert('Salvo com sucesso!');
                if(fechaModalRepro) modalReprovacao.hide();
                modalAgendamento.hide();
                modalAuditoria.hide();
                if(abreZapAprovacao) gerarAprovacaoMsg(dadosEdicao);
                else carregarVendasPendentes();
            })
            .catch(e => { console.error(e); alert('Erro ao finalizar.'); })
            .finally(() => { if(!abreZapAprovacao) $('#loadingOverlay').hide(); });
        }

        function fecharScriptSemSalvar() {
            if(confirm("Sair sem salvar?")) {
                apiClient.post(`${API_BASE}/${vendaEmAuditoria.id}/liberar-auditoria/`, {})
                .finally(() => { modalAuditoria.hide(); carregarVendasPendentes(); });
            }
        }

        function cancelarAgendamento() {
            modalAgendamento.hide();
            modalAuditoria.show();
        }

        function gerarAprovacaoMsg(dados) {
            $('#loadingOverlay').hide();
            let txt = `✅ *VENDA APROVADA - RECORD PAP*\n\n*Cliente:* ${dados.cliente_nome}\n*CPF:* ${dados.cliente_cpf}\n*Plano:* ${$('#audit-plano option:selected').text()}\n*End:* ${dados.logradouro}, ${dados.numero}\n`;
            if($('#agenda-os').val()) txt += `*OS:* ${$('#agenda-os').val()}\n`;
            if(dados.data_agendamento) txt += `*Agendamento:* ${dados.data_agendamento.split('-').reverse().join('/')} - ${dados.periodo_agendamento}\n`;
            
            try { txt += `\n*Auditor:* ${jwt_decode(localStorage.getItem('accessToken')).username}`; } catch(e){}
            
            $('#aprovacao-mensagem').val(txt);
            modalAprovacao.show();
            document.getElementById('modal-aprovacao').addEventListener('hidden.bs.modal', () => carregarVendasPendentes(), {once:true});
        }

        function copiarMensagem() {
            const copyText = document.getElementById("aprovacao-mensagem");
            copyText.select();
            navigator.clipboard.writeText(copyText.value).then(() => alert("Copiado!"));
        }

        function logout() { localStorage.removeItem('accessToken'); window.location.href = '/'; }
    </script>
</body>
</html>