{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditoria de Vendas - Record PAP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{% static 'css/custom_styles.css' %}?v=1.4">
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
    <style>
        .status-select { min-width: 160px; font-size: 0.9rem; border-radius: 6px; }
        #aprovacao-mensagem { white-space: pre-wrap; font-family: monospace; font-size: 0.9rem; }
        .table-responsive { border-radius: 8px; overflow: hidden; }
        .form-control:disabled, .form-control[readonly] { background-color: #f8f9fa; opacity: 1; }
        
        @media (max-width: 576px) {
            .header-controls { flex-direction: column; align-items: flex-start; gap: 10px; }
            .header-controls button { width: 100%; }
        }
    </style>
</head>
<body>

    <header class="main-header">
        <div class="header-container">
            <a href="/"><img src="{% static 'logo.png' %}" alt="Record PAP Logo" class="logo"></a>
            <button class="menu-toggle" id="menu-toggle"><div class="bar"></div><div class="bar"></div><div class="bar"></div></button>
            <nav class="main-nav" id="main-nav">
                <ul>
                    <li><a href="/area-interna/">Voltar</a></li>
                    <li><button onclick="logout()" class="nav-button logout-button">Sair</button></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="area-interna-section">
        <div class="system-container" style="max-width: 1600px;">
            
            <div class="d-flex justify-content-between align-items-center mb-4 header-controls">
                <div>
                    <h1 style="font-size: 1.8rem; margin: 0;">Auditoria</h1>
                    <p class="text-muted mb-0">Validação e qualidade das vendas.</p>
                </div>
            </div>

            <div class="card border-0 shadow-none">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Data</th>
                                <th>Cliente</th>
                                <th>Vendedor</th>
                                <th>Status Tratamento</th>
                                <th class="text-end">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-auditoria-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <div class="modal fade" id="modal-detalhes" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalhes da Venda</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="form-edit-venda">
                        <input type="hidden" id="edit-id">
                        
                        <h6 class="text-primary border-bottom pb-2 mb-3"><i class="bi bi-info-circle"></i> Dados da Venda</h6>
                        <div class="row g-3 mb-3 bg-light p-2 rounded">
                            <div class="col-md-3">
                                <label class="form-label small fw-bold text-muted">Vendedor</label>
                                <input type="text" class="form-control form-control-sm" id="view-vendedor" readonly disabled>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small fw-bold text-muted">Data Venda</label>
                                <input type="text" class="form-control form-control-sm" id="view-data" readonly disabled>
                            </div>
                             <div class="col-md-3">
                                <label class="form-label small fw-bold text-muted">Forma Entrada</label>
                                <input type="text" class="form-control form-control-sm" id="view-entrada" readonly disabled>
                            </div>
                             <div class="col-md-3">
                                <label class="form-label small fw-bold text-muted">Status Atual</label>
                                <input type="text" class="form-control form-control-sm" id="view-status" readonly disabled>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">Plano</label>
                                <input type="text" class="form-control form-control-sm" id="view-plano" readonly disabled>
                            </div>
                             <div class="col-md-6">
                                <label class="form-label small fw-bold text-muted">Forma de Pagamento</label>
                                <input type="text" class="form-control form-control-sm" id="view-pagamento" readonly disabled>
                            </div>
                        </div>

                        <h6 class="text-primary border-bottom pb-2 mb-3 mt-4"><i class="bi bi-person"></i> Dados do Cliente</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Nome Cliente (Razão Social)</label>
                                <input type="text" class="form-control" id="edit-cliente" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">CPF/CNPJ</label>
                                <input type="text" class="form-control" id="edit-cpf" readonly>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Nome da Mãe</label>
                                <input type="text" class="form-control" id="edit-nome-mae">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Data de Nascimento</label>
                                <input type="date" class="form-control" id="edit-nasc">
                            </div>
                            
                            <div class="col-md-8">
                                <label class="form-label">Nome Representante Legal</label>
                                <input type="text" class="form-control" id="edit-nome-rep">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">CPF Rep. Legal</label>
                                <input type="text" class="form-control" id="edit-cpf-rep">
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Telefone 1</label>
                                <input type="text" class="form-control" id="edit-tel1">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Telefone 2</label>
                                <input type="text" class="form-control" id="edit-tel2">
                            </div>
                        </div>

                        <h6 class="text-primary border-bottom pb-2 mb-3 mt-4"><i class="bi bi-geo-alt"></i> Endereço & Instalação</h6>
                        <div class="row g-3">
                            <div class="col-md-3"><label class="form-label">CEP</label><input type="text" class="form-control" id="edit-cep"></div>
                            <div class="col-md-7"><label class="form-label">Logradouro</label><input type="text" class="form-control" id="edit-logradouro"></div>
                            <div class="col-md-2"><label class="form-label">Número</label><input type="text" class="form-control" id="edit-numero"></div>
                            
                            <div class="col-md-4"><label class="form-label">Complemento</label><input type="text" class="form-control" id="edit-complemento"></div>
                            <div class="col-md-4"><label class="form-label">Bairro</label><input type="text" class="form-control" id="edit-bairro"></div>
                            <div class="col-md-3"><label class="form-label">Cidade</label><input type="text" class="form-control" id="edit-cidade"></div>
                            <div class="col-md-1"><label class="form-label">UF</label><input type="text" class="form-control" id="edit-estado"></div>
                            
                            <div class="col-12"><label class="form-label">Ponto de Referência</label><input type="text" class="form-control" id="edit-referencia"></div>
                            
                            <div class="col-12"><hr></div>
                            <div class="col-12"><label class="form-label fw-bold">Observações</label><textarea class="form-control" id="edit-obs" rows="3"></textarea></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" id="btn-salvar-detalhes" onclick="salvarAlteracoes()">Salvar Dados</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal-agendamento" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content border-primary">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-calendar-check"></i> Dados do Agendamento</h5>
                    <button type="button" class="btn-close btn-close-white" onclick="cancelarAgendamento()"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info small">
                        Você alterou o status para <strong>CADASTRADA</strong>. Preencha os dados da O.S. para confirmar.
                    </div>
                    <form id="form-agendamento">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Número da O.S. <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="agenda-os" required placeholder="Digite a O.S.">
                            <div id="os-feedback" class="invalid-feedback">Esta O.S. já existe no sistema!</div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Data Agendada <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="agenda-data" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Turno <span class="text-danger">*</span></label>
                                <select class="form-select" id="agenda-turno" required>
                                    <option value="">Selecione...</option>
                                    <option value="MANHA">Manhã</option>
                                    <option value="TARDE">Tarde</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="cancelarAgendamento()">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btn-salvar-agendamento" onclick="salvarAgendamento()">Confirmar e Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal-aprovacao" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Aprovação de Venda</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Copie a mensagem abaixo para enviar no grupo:</p>
                    <textarea id="aprovacao-mensagem" class="form-control mb-3" rows="6" readonly></textarea>
                    <button class="btn btn-outline-success w-100" onclick="copiarMensagem()"><i class="bi bi-whatsapp"></i> Copiar Mensagem</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="{% static 'js/auth.js' %}?v=1.3"></script>
    <script src="{% static 'js/menu.js' %}?v=1.3"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const token = localStorage.getItem('accessToken');
        if(!token) window.location.href = '/';

        // --- SEGURANÇA ---
        const decodedToken = jwt_decode(token);
        const userProfile = decodedToken ? (decodedToken.user_role || decodedToken.perfil) : null;
        const allowedProfiles = ['Diretoria', 'BackOffice', 'Admin'];

        if (!allowedProfiles.includes(userProfile)) {
            alert('Acesso negado. Apenas BackOffice e Diretoria podem acessar a Auditoria.');
            window.location.href = '/area-interna/';
        }

        let vendas = [];
        let tempVendaId = null;
        let tempStatusId = null;
        let tempSelectElement = null;
        let updateInterval;

        const modalDetalhes = new bootstrap.Modal(document.getElementById('modal-detalhes'));
        const modalAgendamento = new bootstrap.Modal(document.getElementById('modal-agendamento'));
        const aprovacaoModal = new bootstrap.Modal(document.getElementById('modal-aprovacao'));

        document.addEventListener('DOMContentLoaded', () => {
            carregarVendas();
            document.getElementById('edit-cep').addEventListener('blur', buscarCepEdit);

            // --- ATUALIZAÇÃO AUTOMÁTICA ---
            updateInterval = setInterval(() => {
                const isModalOpen = document.querySelector('.modal.show');
                const isSelectFocused = document.activeElement && document.activeElement.tagName === 'SELECT';
                
                // Só atualiza se não tiver modal aberto E o usuário não estiver mexendo num select
                if (!isModalOpen && !isSelectFocused) {
                    carregarVendas(true); 
                }
            }, 5000);
        });

        // --- HELPER PARA EXIBIR ERROS DETALHADOS ---
        function mostrarErroDetalhado(error, contexto = 'atualizar') {
            console.error(`Erro ao ${contexto}:`, error);
            let mensagem = `Erro ao ${contexto}.`;
            if (error.response) {
                mensagem += `\nStatus: ${error.response.status} (${error.response.statusText})`;
                if (error.response.data) {
                    if (error.response.data.detail) {
                        mensagem += `\nDetalhe: ${error.response.data.detail}`;
                    } else if (typeof error.response.data === 'object') {
                        mensagem += `\n${JSON.stringify(error.response.data, null, 2).replace(/["{}]/g, '')}`;
                    } else {
                        mensagem += `\nResposta: ${String(error.response.data).substring(0, 100)}...`;
                    }
                }
            }
            alert(mensagem);
        }

        async function carregarVendas(silent = false) {
            const tbody = document.getElementById('tabela-auditoria-body');
            
            // Só mostra loading se NÃO for silencioso (primeira carga)
            if (!silent) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4"><div class="spinner-border text-primary"></div></td></tr>';
            }
            
            try {
                const statusRes = await apiClient.get('/api/crm/status/?tipo=Tratamento');
                const statusOptions = statusRes.data;

                const res = await apiClient.get('/api/crm/vendas/?flow=auditoria');
                vendas = res.data;

                // Se não for silent, limpa. Se for silent, só substitui.
                if(vendas.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">Nenhuma venda para auditoria.</td></tr>';
                } else {
                    // Limpa antes de recriar para evitar duplicação visual rápida
                    tbody.innerHTML = '';
                    vendas.forEach(v => {
                        const dataFmt = new Date(v.data_criacao).toLocaleDateString('pt-BR');
                        
                        let selectStatus = `<select class="form-select form-select-sm status-select" onchange="atualizarStatus(${v.id}, this)">`;
                        selectStatus += `<option value="">Selecione...</option>`;
                        statusOptions.forEach(s => {
                            const selected = (v.status_tratamento && v.status_tratamento.id === s.id) ? 'selected' : '';
                            selectStatus += `<option value="${s.id}" ${selected}>${s.nome}</option>`;
                        });
                        selectStatus += `</select>`;

                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td class="fw-bold text-primary">#${v.id}</td>
                            <td>${dataFmt}</td>
                            <td><div class="fw-bold">${v.cliente.nome_razao_social}</div><div class="small text-muted">${v.cliente.cpf_cnpj}</div></td>
                            <td>${v.vendedor.username}</td>
                            <td>${selectStatus}</td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-secondary me-1" onclick="abrirDetalhes(${v.id})" title="Editar Dados"><i class="bi bi-pencil"></i></button>
                                <button class="btn btn-sm btn-success" onclick="gerarAprovacao(${v.id})" title="Aprovar"><i class="bi bi-check-lg"></i></button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            } catch (e) {
                if (!silent) tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Erro ao carregar vendas. Tente novamente.</td></tr>';
                console.error(e);
            }
        }

        async function atualizarStatus(id, selectElem) {
            const statusId = selectElem.value;
            const statusTexto = selectElem.options[selectElem.selectedIndex].text.toUpperCase();

            if (statusTexto === 'CADASTRADA') {
                tempVendaId = id;
                tempStatusId = statusId;
                tempSelectElement = selectElem;
                
                document.getElementById('form-agendamento').reset();
                document.getElementById('agenda-os').classList.remove('is-invalid');
                modalAgendamento.show();
            } else {
                salvarStatusNoBanco(id, statusId);
            }
        }

        async function salvarAgendamento() {
            const btn = document.getElementById('btn-salvar-agendamento');
            const os = document.getElementById('agenda-os').value.trim();
            const data = document.getElementById('agenda-data').value;
            const turno = document.getElementById('agenda-turno').value;

            if (!os || !data || !turno) {
                alert("Por favor, preencha todos os campos.");
                return;
            }

            btn.disabled = true;
            btn.innerHTML = 'Salvando...';

            try {
                const res = await apiClient.get(`/api/crm/vendas/?ordem_servico=${os}`);
                const duplicada = res.data.some(v => v.id !== tempVendaId);
                
                if (duplicada) {
                    document.getElementById('agenda-os').classList.add('is-invalid');
                    btn.disabled = false;
                    btn.innerHTML = 'Confirmar e Salvar';
                    return; 
                } else {
                    document.getElementById('agenda-os').classList.remove('is-invalid');
                }

                const dadosExtras = {
                    ordem_servico: os,
                    data_agendamento: data,
                    periodo_agendamento: turno
                };

                await salvarStatusNoBanco(tempVendaId, tempStatusId, dadosExtras);
                modalAgendamento.hide();

            } catch (e) {
                mostrarErroDetalhado(e, 'validar O.S.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Confirmar e Salvar';
            }
        }

        function cancelarAgendamento() {
            modalAgendamento.hide();
            carregarVendas(true); 
        }

        async function salvarStatusNoBanco(id, statusId, extras = {}) {
            try {
                const payload = { status_tratamento: statusId, ...extras };
                await apiClient.patch(`/api/crm/vendas/${id}/`, payload);
                
                if(Object.keys(extras).length > 0) {
                    carregarVendas(true);
                }
            } catch(e) { 
                mostrarErroDetalhado(e, 'atualizar status'); 
                carregarVendas(true); 
            }
        }

        // Função atualizada para preencher todos os novos campos
        function abrirDetalhes(id) {
            const v = vendas.find(x => x.id === id);
            if(!v) return;
            
            // ID Oculto
            document.getElementById('edit-id').value = v.id;

            // --- BLOCO 1: INFORMATIVOS (READONLY) ---
            document.getElementById('view-vendedor').value = v.vendedor ? v.vendedor.username : '-';
            document.getElementById('view-data').value = new Date(v.data_criacao).toLocaleDateString('pt-BR');
            document.getElementById('view-entrada').value = v.forma_entrada || '-';
            document.getElementById('view-status').value = v.status_tratamento ? v.status_tratamento.nome : '-';
            
            const nomePlano = v.plano ? v.plano.nome : 'Sem Plano';
            const valorPlano = v.plano ? `R$ ${v.plano.valor}` : '';
            document.getElementById('view-plano').value = `${nomePlano} - ${valorPlano}`;
            
            document.getElementById('view-pagamento').value = v.forma_pagamento ? v.forma_pagamento.nome : '-';

            // --- BLOCO 2: DADOS CLIENTE ---
            document.getElementById('edit-cliente').value = v.cliente.nome_razao_social;
            document.getElementById('edit-cpf').value = v.cliente.cpf_cnpj;
            
            document.getElementById('edit-nome-mae').value = v.nome_mae || '';
            document.getElementById('edit-nasc').value = v.data_nascimento || ''; // Formato esperado YYYY-MM-DD já vem da API
            
            document.getElementById('edit-nome-rep').value = v.nome_representante_legal || '';
            document.getElementById('edit-cpf-rep').value = v.cpf_representante_legal || '';

            document.getElementById('edit-tel1').value = v.telefone1 || '';
            document.getElementById('edit-tel2').value = v.telefone2 || '';

            // --- BLOCO 3: ENDEREÇO ---
            document.getElementById('edit-cep').value = v.cep || '';
            document.getElementById('edit-logradouro').value = v.logradouro || '';
            document.getElementById('edit-numero').value = v.numero_residencia || '';
            document.getElementById('edit-complemento').value = v.complemento || ''; // Novo campo
            document.getElementById('edit-bairro').value = v.bairro || '';
            document.getElementById('edit-cidade').value = v.cidade || '';
            document.getElementById('edit-estado').value = v.estado || '';
            document.getElementById('edit-referencia').value = v.ponto_referencia || '';
            document.getElementById('edit-obs').value = v.observacoes || '';
            
            modalDetalhes.show();
        }

        // Função atualizada para salvar os novos campos editáveis
        async function salvarAlteracoes() {
            const btn = document.getElementById('btn-salvar-detalhes');
            const id = document.getElementById('edit-id').value;
            
            btn.disabled = true;
            btn.innerHTML = 'Salvando...';

            // Monta o objeto com TODOS os campos editáveis
            const body = {
                // Contato
                telefone1: document.getElementById('edit-tel1').value,
                telefone2: document.getElementById('edit-tel2').value,
                
                // Dados Pessoais Extras
                nome_mae: document.getElementById('edit-nome-mae').value,
                data_nascimento: document.getElementById('edit-nasc').value || null, // null se estiver vazio para evitar erro de data
                nome_representante_legal: document.getElementById('edit-nome-rep').value,
                cpf_representante_legal: document.getElementById('edit-cpf-rep').value,

                // Endereço Completo
                cep: document.getElementById('edit-cep').value,
                logradouro: document.getElementById('edit-logradouro').value,
                numero_residencia: document.getElementById('edit-numero').value,
                complemento: document.getElementById('edit-complemento').value,
                bairro: document.getElementById('edit-bairro').value,
                cidade: document.getElementById('edit-cidade').value,
                estado: document.getElementById('edit-estado').value,
                ponto_referencia: document.getElementById('edit-referencia').value,
                
                // Obs
                observacoes: document.getElementById('edit-obs').value
            };
            
            try { 
                await apiClient.patch(`/api/crm/vendas/${id}/`, body); 
                modalDetalhes.hide(); 
                carregarVendas(true); // Recarrega a lista para atualizar os dados em memória
                alert('Dados salvos com sucesso!'); 
            } catch(e){ 
                mostrarErroDetalhado(e, 'salvar alterações');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Salvar Dados';
            }
        }
        
        async function buscarCepEdit(e) {
            const cep = e.target.value.replace(/\D/g, '');
            if (cep.length === 8) {
                document.body.style.cursor = 'wait';
                try {
                    const res = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                    const d = await res.json();
                    if(!d.erro) {
                        document.getElementById('edit-logradouro').value = d.logradouro.toUpperCase();
                        document.getElementById('edit-bairro').value = d.bairro.toUpperCase();
                        document.getElementById('edit-cidade').value = d.localidade.toUpperCase();
                        document.getElementById('edit-estado').value = d.uf.toUpperCase();
                    }
                } catch(e){}
                document.body.style.cursor = 'default';
            }
        }

        function gerarAprovacao(id) {
            const v = vendas.find(x=>x.id===id);
            let msg = `*VENDA APROVADA* ✅\n\nCliente: ${v.cliente.nome_razao_social}\nCPF/CNPJ: ${v.cliente.cpf_cnpj}\nPlano: ${v.plano?.nome}\nValor: R$ ${v.plano?.valor}\nVendedor: ${v.vendedor.username}`;
            if(v.observacoes) msg += `\nObs: ${v.observacoes}`;
            
            document.getElementById('aprovacao-mensagem').value = msg;
            aprovacaoModal.show();
        }
        
        function copiarMensagem() { 
            const txt = document.getElementById('aprovacao-mensagem');
            txt.select();
            navigator.clipboard.writeText(txt.value).then(() => {
                alert('Copiado para a área de transferência!'); 
            });
        }

        function logout() { localStorage.removeItem('accessToken'); window.location.href = '/'; }
    </script>
</body>
</html>