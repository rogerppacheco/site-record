{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Presença - Record PAP</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{% static 'css/custom_styles.css' %}?v=1.4">
    
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>

    <style>
        /* Layout de Cards */
        .presence-card {
            border: 1px solid #e9ecef;
            border-radius: 10px;
            background: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.2s;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .presence-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        /* Barra de Status (Topo) */
        .card-status-bar {
            height: 6px;
            width: 100%;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
        }
        .status-pendente { background-color: #dee2e6; }
        .status-presente { background-color: var(--cor-sucesso); }
        .status-ausente { background-color: var(--cor-perigo); }
        .status-justificado { background-color: var(--cor-aviso); }

        /* Avatar */
        .avatar-circle {
            width: 45px; height: 45px;
            background-color: #f8f9fa;
            color: #6c757d;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 1.1rem;
            border: 1px solid #e9ecef;
            flex-shrink: 0;
        }
        
        /* Auditoria */
        .audit-info {
            font-size: 0.75rem;
            color: #6c757d;
            background-color: #fdfdfd;
            border-top: 1px solid #f0f0f0;
            margin-top: auto; /* Empurra para o final do card */
            padding: 10px 15px;
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
            line-height: 1.4;
        }
        .audit-line { margin-bottom: 3px; }

        .nav-tabs .nav-link { color: #666; font-weight: 600; cursor: pointer; }
        .nav-tabs .nav-link.active { color: var(--cor-primaria); border-bottom: 3px solid var(--cor-primaria); }

        @media (max-width: 576px) {
            .header-controls { flex-direction: column; align-items: stretch; gap: 10px; }
        }
        
        /* Regras para dispositivos móveis e telas menores */
        @media (max-width: 768px) {
            /* Torna os cards menores e mais condensados em dispositivos móveis */
            .presence-card {
                padding: 10px 10px 5px 10px !important; 
                margin: 0 !important;
                min-height: 120px; 
            }

            /* Ajusta o padding da área principal para evitar proximidade da borda */
            .area-interna-section .system-container {
                padding-left: 10px;
                padding-right: 10px;
            }

            /* Reduz o tamanho dos botões de ação e centraliza */
            .presence-card button.btn-sm {
                padding: 0.2rem 0.5rem; /* Botões menores */
                font-size: 0.8rem;
                flex-grow: 1; 
            }

            /* Ajusta o container dos botões para serem menores */
            .presence-card .d-flex.gap-2.mt-3.px-3.pb-3 {
                padding-left: 0 !important;
                padding-right: 0 !important;
                padding-bottom: 5px !important;
            }
            .presence-card .d-flex.gap-2.mt-2.px-3.pb-2 {
                padding-left: 0 !important;
                padding-right: 0 !important;
                padding-bottom: 5px !important;
            }

            /* Reduz o avatar */
            .avatar-circle {
                width: 35px; 
                height: 35px;
                font-size: 0.9rem;
            }
            
            /* Ajusta o título */
            .presence-card h6 {
                font-size: 0.9rem !important;
            }
            .presence-card small {
                font-size: 0.75rem !important;
            }

            /* Ajusta o container principal do cabeçalho */
            .header-controls { 
                gap: 5px !important; 
                margin-bottom: 15px !important;
                padding: 5px;
            }
            
            /* Reduz o tamanho do input de data */
            #container-filtro-data input.form-control {
                font-size: 0.8rem;
                padding: 0.2rem 0.5rem;
            }
        }
    </style>
</head>
<body>

    <header class="main-header">
        <div class="header-container">
            <a href="/"><img src="{% static 'logo.png' %}" alt="Logo" class="logo"></a>
            <button class="menu-toggle" id="menu-toggle"><div class="bar"></div><div class="bar"></div><div class="bar"></div></button>
            <nav class="main-nav" id="main-nav">
                <ul>
                    <li><a href="/area-interna/">Voltar</a></li>
                    <li><button onclick="logout()" class="nav-button logout-button">Sair</button></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="area-interna-section">
        <div class="system-container" style="max-width: 1400px;">
            
            <div class="d-flex justify-content-between align-items-center mb-4 header-controls">
                <div>
                    <h1 style="font-size: 1.8rem; margin: 0;">Controle de Presença</h1>
                    <p class="text-muted mb-0">Gerencie a presença diária da equipe.</p>
                </div>
                
                <div id="container-filtro-data" class="d-flex gap-2">
                    <input type="date" id="data-presenca" class="form-control" onchange="carregarDadosIniciais()">
                    <button class="btn btn-outline-secondary" onclick="carregarDadosIniciais()"><i class="bi bi-arrow-clockwise"></i></button>
                </div>
                <div id="display-data-hoje" class="d-none fw-bold text-primary align-self-center">
                    <i class="bi bi-calendar-event"></i> <span id="texto-data-fixa"></span>
                </div>
            </div>

            <ul class="nav nav-tabs mb-4" id="tab-container">
                <li class="nav-item">
                    <a class="nav-link active" onclick="switchTab('minha-equipe', this)">Minha Equipe</a>
                </li>
                <li class="nav-item" id="tab-todos">
                    <a class="nav-link" onclick="switchTab('todos-usuarios', this)">Todos os Usuários</a>
                </li>
            </ul>
            
            <div id="grid-colaboradores" class="row g-3">
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary"></div>
                    <p class="mt-2 text-muted">Carregando equipe...</p>
                </div>
            </div>

        </div>
    </main>

    <div class="modal fade" id="modal-ausencia" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="modal-title">Registrar Ausência</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Motivo</label>
                        <select class="form-select" id="select-motivo"></select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Observação</label>
                        <textarea class="form-control" id="obs-motivo" rows="2" placeholder="Detalhes opcionais..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="btn-confirmar-ausencia">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="{% static 'js/auth.js' %}?v=1.3"></script>
    <script src="{% static 'js/menu.js' %}?v=1.3"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const token = localStorage.getItem('accessToken');
        if(!token) window.location.href = '/';

        // --- SEGURANÇA E PERFIL ---
        const decoded = jwt_decode(token);
        const userRole = decoded.user_role || decoded.perfil || 'Vendedor';
        const isSuperuser = decoded.is_superuser || false;

        // Permissão: Bloqueia Vendedores
        if (userRole === 'Vendedor' && !isSuperuser) {
            alert('Acesso restrito a gestores.');
            window.location.href = '/area-interna/';
        }
        
        // Endpoints (Usando apiClient do auth.js)
        const API_MOTIVOS = '/api/presenca/motivos/';
        const API_REGISTROS = '/api/presenca/registros/';

        let motivosDisponiveis = [];
        let activeTab = 'minha-equipe';
        let modalAusencia;

        document.addEventListener('DOMContentLoaded', () => {
            modalAusencia = new bootstrap.Modal(document.getElementById('modal-ausencia'));

            // Configurar Data
            const hoje = new Date();
            const inputData = document.getElementById('data-presenca');
            inputData.valueAsDate = hoje;

            // Regra de Visibilidade da Data
            const isDiretoriaOrAdmin = (userRole === 'Diretoria' || userRole === 'Admin' || isSuperuser || userRole === 'BackOffice');

            if (!isDiretoriaOrAdmin) {
                // Supervisor: Esconde data e aba Todos
                document.getElementById('container-filtro-data').classList.remove('d-flex');
                document.getElementById('container-filtro-data').style.display = 'none';
                document.getElementById('display-data-hoje').classList.remove('d-none');
                document.getElementById('texto-data-fixa').textContent = hoje.toLocaleDateString('pt-BR');
                
                document.getElementById('tab-todos').style.display = 'none';
            } else {
                // Diretoria: Define aba ativa como 'todos-usuarios'
                activeTab = 'todos-usuarios';
                document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
                document.querySelector('#tab-todos .nav-link').classList.add('active');
            }

            carregarMotivos();
            carregarDadosIniciais();
        });

        window.switchTab = function(tabName, element) {
            activeTab = tabName;
            document.querySelectorAll('.nav-link').forEach(btn => btn.classList.remove('active'));
            element.classList.add('active');
            carregarDadosIniciais();
        }

        async function carregarMotivos() {
            try {
                const res = await apiClient.get('/api/presenca/motivos/');
                motivosDisponiveis = res.data;
            } catch(e){}
        }

        async function carregarDadosIniciais() {
            const data = document.getElementById('data-presenca').value;
            const grid = document.getElementById('grid-colaboradores');
            grid.innerHTML = '<div class="col-12 text-center py-5"><div class="spinner-border text-primary"></div><p class="mt-2">Carregando...</p></div>';

            const equipeEndpoint = (activeTab === 'todos-usuarios')
                ? '/api/presenca/todos-usuarios/?participa_controle_presenca=true'
                : '/api/presenca/minha-equipe/?participa_controle_presenca=true';

            try {
                const [equipeRes, presencasRes] = await Promise.all([
                    apiClient.get(equipeEndpoint),
                    apiClient.get(`${API_REGISTROS}?data=${data}`)
                ]);
                
                const equipe = equipeRes.data;
                const presencasDoDia = presencasRes.data;

                if(equipe) renderizarCards(equipe, presencasDoDia || []);
                else grid.innerHTML = '<div class="col-12 text-center text-danger py-4">Erro ao carregar equipe.</div>';

            } catch(e) {
                console.error(e);
                grid.innerHTML = '<div class="col-12 text-center text-danger py-4">Erro de conexão.</div>';
            }
        }

        function renderizarCards(lista, presencasDoDia) {
            const grid = document.getElementById('grid-colaboradores');
            grid.innerHTML = '';
            
            const presencasMap = presencasDoDia.reduce((map, p) => { map[p.colaborador] = p; return map; }, {});

            if (lista.length === 0) {
                grid.innerHTML = '<div class="col-12 text-center text-muted py-5">Nenhum colaborador encontrado.</div>';
                return;
            }

            lista.forEach(p => {
                const registro = presencasMap[p.id];
                
                let barClass = 'status-pendente';
                let statusText = 'Pendente';
                let statusColor = 'text-muted';
                let cardBorder = '#ced4da';
                
                if (registro) {
                    if (registro.status) {
                        barClass = 'status-presente';
                        statusText = 'Presente';
                        statusColor = 'text-success';
                        cardBorder = 'var(--cor-sucesso)';
                    } else {
                        const desc = registro.motivo_nome || 'Motivo não informado';
                        statusText = `Ausente: ${desc}`;
                        statusColor = 'text-danger';
                        barClass = registro.motivo_ausencia?.gera_desconto ? 'status-ausente' : 'status-justificado';
                        cardBorder = registro.motivo_ausencia?.gera_desconto ? 'var(--cor-perigo)' : 'var(--cor-aviso)';
                    }
                }

                const iniciais = p.first_name ? (p.first_name[0] + (p.last_name ? p.last_name[0] : '')).toUpperCase() : '??';
                const cardCol = document.createElement('div');
                
                // --- CORREÇÃO DO GRID ---
                // Agora usa col-sm-6 (2 cards em tela pequena), col-lg-4 (3 cards), col-xl-3 (4 cards)
                cardCol.className = 'col-12 col-sm-6 col-lg-4 col-xl-3';

                // Auditoria
                let auditHtml = '';
                if (registro) {
                    const opts = { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
                    
                    let lines = [];
                    if (registro.criado_em) {
                        const dtCriado = new Date(registro.criado_em).toLocaleString('pt-BR', opts);
                        const userCriado = (registro.lancado_por_nome || 'Sistema').toUpperCase();
                        lines.push(`<div class="audit-line">Lançado por: <strong>${userCriado}</strong> em ${dtCriado}</div>`);
                    }
                    if (registro.editado_em && registro.editado_por_nome) {
                        const dtEdit = new Date(registro.editado_em).toLocaleString('pt-BR', opts);
                        const userEdit = registro.editado_por_nome.toUpperCase();
                        lines.push(`<div class="audit-line">Editado por: <strong>${userEdit}</strong> em ${dtEdit}</div>`);
                    }
                    
                    if (lines.length > 0) {
                        auditHtml = `<div class="audit-info">${lines.join('')}</div>`;
                    }
                }

                // Botões
                let buttonsHtml = '';
                if (!registro) {
                    buttonsHtml = `
                        <div class="d-flex gap-2 mt-3 px-3 pb-3">
                            <button class="btn btn-sm btn-success flex-grow-1" onclick="salvarStatus(${p.id}, '${p.first_name}', true)">Presente</button>
                            <button class="btn btn-sm btn-danger flex-grow-1" onclick="abrirModalAusencia(${p.id}, '${p.first_name}')">Ausência</button>
                        </div>
                    `;
                } else {
                    buttonsHtml = `
                        <div class="d-flex justify-content-end mt-2 px-3 pb-2">
                            <button class="btn btn-sm btn-outline-secondary py-0 px-2" style="font-size: 0.8rem;" onclick="resetarCard(${p.id}, '${p.first_name}')">Alterar</button>
                        </div>
                    `;
                }

                cardCol.innerHTML = `
                    <div class="presence-card" id="card-${p.id}" style="border-left: 5px solid ${cardBorder};">
                        <div class="p-3 flex-grow-1">
                            <div class="d-flex align-items-center gap-3 mb-2">
                                <div class="avatar-circle flex-shrink-0">${iniciais}</div>
                                <div class="overflow-hidden flex-grow-1">
                                    <h6 class="mb-0 text-truncate fw-bold text-dark" title="${p.nome_completo}">${p.nome_completo}</h6>
                                    <small class="fw-bold ${statusColor}">${statusText}</small>
                                </div>
                            </div>
                            
                            <div id="acoes-${p.id}">
                                ${buttonsHtml}
                            </div>
                        </div>
                        ${auditHtml}
                    </div>
                `;
                grid.appendChild(cardCol);
            });
        }

        // Habilita botões novamente para edição
        window.resetarCard = function(id, nome) {
            const divAcoes = document.getElementById(`acoes-${id}`);
            divAcoes.innerHTML = `
                <div class="d-flex gap-2 mt-2 px-3 pb-3 border-top pt-3">
                    <button class="btn btn-sm btn-success flex-grow-1" onclick="salvarStatus(${id}, '${nome}', true)">Presente</button>
                    <button class="btn btn-sm btn-danger flex-grow-1" onclick="abrirModalAusencia(${id}, '${nome}')">Ausência</button>
                </div>
            `;
        }

        async function salvarStatus(vendedorId, nome, presente, detalhes = {}) {
            const data = document.getElementById('data-presenca').value;
            const body = {
                colaborador: vendedorId,
                data: data,
                status: presente,
                motivo: !presente ? detalhes.motivoId : null,
                observacao: !presente ? detalhes.observacao : ""
            };

            try {
                // O apiClient precisa ser definido ou importado (assumindo que está em auth.js)
                await apiClient.post(API_REGISTROS, body); 
                carregarDadosIniciais(); 
            } catch (e) { alert('Erro ao salvar.'); console.error(e); }
        }

        window.abrirModalAusencia = function(id, nome) {
            document.getElementById('modal-title').textContent = `Registrar Ausência: ${nome}`;
            const select = document.getElementById('select-motivo');
            select.innerHTML = '<option value="">Selecione...</option>';
            motivosDisponiveis.forEach(m => select.add(new Option(m.motivo, m.id)));
            document.getElementById('obs-motivo').value = '';
            
            document.getElementById('btn-confirmar-ausencia').onclick = function() {
                const motivoId = select.value;
                if (!motivoId) { alert('Selecione o motivo.'); return; }
                const obs = document.getElementById('obs-motivo').value;
                salvarStatus(id, nome, false, { motivoId: motivoId, observacao: obs });
                modalAusencia.hide();
            };
            modalAusencia.show();
        }

        window.logout = function() { localStorage.removeItem('accessToken'); window.location.href='/'; }
    </script>
</body>
</html>