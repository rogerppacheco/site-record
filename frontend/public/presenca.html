{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lançamento de Presença - Record PAP</title>
    
    <link rel="stylesheet" href="{% static 'css/custom_styles.css' %}">
</head>
<body>
    <header class="main-header">
        <div class="header-container">
            <a href="/"><img src="{% static 'logo.png' %}" alt="Record PAP Logo" class="logo"></a>
            <nav class="main-nav">
                <ul id="main-menu">
                    <li><a href="/area-interna/">Área Interna</a></li>
                    <li><button onclick="logout()" class="nav-button logout-button">Sair</button></li>
                </ul>
            </nav>
            <button class="menu-toggle" id="menu-toggle" aria-label="Abrir menu">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </button>
        </div>
    </header>

    <main>
        <div class="main-content">
            <h1>Lançamento de Presença</h1>

            <div class="date-search-container" id="date-search-container">
                <input type="date" id="data-pesquisa">
                <button id="btn-pesquisar" class="btn-pesquisar">Pesquisar</button>
            </div>

            <div class="tab-container" id="tab-container">
                <button class="tab-button active" onclick="switchTab('minha-equipe', this)">Minha Equipe</button>
                <button class="tab-button" onclick="switchTab('todos-usuarios', this)">Todos os Usuários</button>
            </div>
            
            <p id="data-hoje"></p>
            
            <div id="lista-vendedores">
                <p>Carregando equipe...</p>
            </div>
        </div>
    </main>

    <div id="modal-motivo" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title">Motivo da Ausência</h3>
            <div class="form-group">
                <label for="select-motivo">Motivo:</label>
                <select id="select-motivo"></select>
            </div>
            <div class="form-group">
                <label for="obs-motivo">Observação (opcional):</label>
                <textarea id="obs-motivo" rows="3" placeholder="Detalhes adicionais..."></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn btn-cancelar" onclick="fecharModal()">Cancelar</button>
                <button id="btn-confirmar-ausencia" class="btn btn-confirmar">Confirmar Ausência</button>
            </div>
        </div>
    </div>

    <footer>
        <p>Record PAP - Internet Fibra Ótica</p>
        <p>Contato: (31) 99458-8810 | E-mail: <a href="mailto:suporte@recordpap.com.br">suporte@recordpap.com.br</a></p>
        <p><a href="#">Política de Privacidade</a> | <a href="#">Termos de Uso</a></p>
    </footer>

    <script src="{% static 'js/auth.js' %}"></script>
    <script>
        const apiUrl = '';

        const token = localStorage.getItem('accessToken');

        function jwt_decode(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                return null;
            }
        }

        const decodedToken = jwt_decode(token);
        const userProfile = decodedToken ? (decodedToken.perfil || 'Admin') : null;
        const isSuperuser = decodedToken ? decodedToken.is_superuser : false;

        let motivosDisponiveis = [];
        let activeTab = 'minha-equipe';

        function switchTab(tabName, element) {
            activeTab = tabName;
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            element.classList.add('active');
            carregarDadosIniciais();
        }

        async function apiFetch(endpoint, options = {}) {
            const headers = { 'Content-Type': 'application/json', ...options.headers };
            const token = localStorage.getItem('accessToken'); 
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            const response = await fetch(`${apiUrl}/api${endpoint}`, { ...options, headers });
            
            const novoToken = response.headers.get('X-Access-Token'); 
            if (novoToken) {
                localStorage.setItem('accessToken', novoToken);
                console.log('Novo token de acesso foi atualizado!');
            }

            if (response.status === 401) {
                alert('Sua sessão expirou. Por favor, faça login novamente.');
                logout();
                throw new Error('Não autorizado');
            }
            if (!response.ok) {
                const errorData = await response.json();
                let errorMessage = "Ocorreu um erro.";
                if (errorData.detail) {
                    errorMessage = errorData.detail;
                } else {
                    errorMessage = JSON.stringify(errorData).replace(/["{}[\]]/g, ' ');
                }
                throw new Error(errorMessage);
            }
            if (response.status === 204) return null;
            return response.json();
        }

        function logout() {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            localStorage.removeItem('userProfile');
            window.location.href = '/';
        }

        async function carregarDadosIniciais() {
            const dataInput = document.getElementById('data-pesquisa');
            const dataSelecionada = dataInput.value;

            if (!dataSelecionada) {
                alert('Por favor, selecione uma data.');
                return;
            };

            const dataDisplay = document.getElementById('data-hoje');
            const [ano, mes, dia] = dataSelecionada.split('-');
            dataDisplay.textContent = `Exibindo data: ${dia}/${mes}/${ano}`;

            const listaDiv = document.getElementById('lista-vendedores');
            listaDiv.innerHTML = '<p>Carregando dados...</p>';

            // --- INÍCIO DA ALTERAÇÃO ---
            // Adicionamos o parâmetro '&participa_controle_presenca=true' para filtrar os usuários
            const equipeEndpoint = (userProfile === 'Diretoria' || userProfile === 'Admin' || isSuperuser) && activeTab === 'todos-usuarios'
                ? '/presenca/todos-usuarios/?participa_controle_presenca=true'
                : '/presenca/minha-equipe/?participa_controle_presenca=true';
            // --- FIM DA ALTERAÇÃO ---

            try {
                const [motivos, equipe, presencasDoDia] = await Promise.all([
                    apiFetch('/presenca/motivos/'),
                    apiFetch(equipeEndpoint),
                    apiFetch(`/presenca/presencas/?data=${dataSelecionada}`)
                ]);

                motivosDisponiveis = motivos;
                renderizarEquipe(equipe, presencasDoDia);

            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                listaDiv.innerHTML = `<p style="color: var(--cor-erro);">Erro ao carregar dados. Verifique a conexão e tente novamente.</p>`;
            }
        }

        function renderizarEquipe(equipe, presencasDoDia) {
            const listaDiv = document.getElementById('lista-vendedores');
            listaDiv.innerHTML = '';
            const presencasMap = presencasDoDia.reduce((map, p) => {
                map[p.colaborador] = p;
                return map;
            }, {});
            if (equipe.length === 0) {
                listaDiv.innerHTML = activeTab === 'minha-equipe'
                    ? '<p>Você não possui vendedores associados à sua equipe.</p>'
                    : '<p>Nenhum usuário encontrado.</p>';
                return;
            }
            equipe.forEach(vendedor => {
                const nomeCompleto = vendedor.nome_completo;
                const registro = presencasMap[vendedor.id];
                const vendedorDiv = document.createElement('div');
                vendedorDiv.id = `vendedor-${vendedor.id}`;
                vendedorDiv.className = 'colaborador-item';
                vendedorDiv.dataset.presenceId = registro ? registro.id : '';
                let conteudoInterno;
                if (registro) {
                    const statusText = registro.status ? 'Presente' : 'Ausente';
                    const motivoText = !registro.status && registro.motivo_nome ? `(${registro.motivo_nome})` : '';
                    
                    const dataLancamento = new Date(registro.criado_em).toLocaleString('pt-BR');
                    const lancadoPor = registro.lancado_por_nome || 'Sistema';

                    let editadoPorInfo = '';
                    if (registro.editado_por_nome) {
                        const dataEdicao = new Date(registro.editado_em).toLocaleString('pt-BR');
                        editadoPorInfo = `<p class="status-info"><strong>Editado por:</strong> ${registro.editado_por_nome} em ${dataEdicao}</p>`;
                    }

                    vendedorDiv.classList.add(registro.status ? 'presente' : 'ausente');
                    let editButton = '';
                    if (userProfile === 'Diretoria' || userProfile === 'Admin' || isSuperuser) {
                        editButton = `<button class="btn btn-editar" onclick="ativarModoEdicao(${vendedor.id}, '${nomeCompleto}')">Editar</button>`;
                    }
                    
                    conteudoInterno = `
                        <div class="colaborador-info">
                            <h3>${nomeCompleto}</h3>
                            <p class="status-info"><strong>Status:</strong> ${statusText} ${motivoText}</p>
                            <p class="status-info"><strong>Lançado por:</strong> ${lancadoPor} em ${dataLancamento}</p>
                            ${editadoPorInfo}
                        </div>
                        <div class="colaborador-actions">${editButton}</div>`;

                } else {
                    conteudoInterno = `<div class="colaborador-info"><h3>${nomeCompleto}</h3></div><div class="colaborador-actions"><button class="btn btn-presente" onclick="salvarStatus(${vendedor.id}, '${nomeCompleto}', true)">Presente</button><button class="btn btn-ausente" onclick="abrirModalAusencia(${vendedor.id}, '${nomeCompleto}')">Ausente</button></div>`;
                }
                vendedorDiv.innerHTML = conteudoInterno;
                listaDiv.appendChild(vendedorDiv);
            });
        }

        function ativarModoEdicao(vendedorId, nomeCompleto) {
            const vendedorDiv = document.getElementById(`vendedor-${vendedorId}`);
            vendedorDiv.classList.remove('presente', 'ausente');
            vendedorDiv.innerHTML = `<div class="colaborador-info"><h3>${nomeCompleto}</h3></div><div class="colaborador-actions"><button class="btn btn-presente" onclick="salvarStatus(${vendedorId}, '${nomeCompleto}', true)">Presente</button><button class="btn btn-ausente" onclick="abrirModalAusencia(${vendedorId}, '${nomeCompleto}')">Ausente</button></div>`;
        }

        async function salvarStatus(vendedorId, nomeVendedor, presente, detalhesAusencia = {}) {
            const data = document.getElementById('data-pesquisa').value;
            const card = document.getElementById(`vendedor-${vendedorId}`);
            const presenceId = card.dataset.presenceId;
            const isUpdating = !!presenceId;
            const method = isUpdating ? 'PUT' : 'POST';
            const endpoint = isUpdating ? `/presenca/presencas/${presenceId}/`: '/presenca/presencas/';
            const body = {
                colaborador: vendedorId,
                data: data,
                status: presente,
                motivo: presente === false ? detalhesAusencia.motivoId : null,
                observacao: presente === false ? (detalhesAusencia.observacao || "") : ""
            };
            try {
                await apiFetch(endpoint, { method, body: JSON.stringify(body) });
                carregarDadosIniciais();
            } catch (error) {
                console.error('Erro ao salvar presença:', error);
                alert(`Erro ao salvar: ${error.message}.`);
            }
        }

        const modal = document.getElementById('modal-motivo');
        window.abrirModalAusencia = (vendedorId, nomeVendedor) => {
            document.getElementById('modal-title').textContent = `Motivo da Ausência de ${nomeVendedor}`;
            const selectMotivo = document.getElementById('select-motivo');
            selectMotivo.innerHTML = '<option value="">Selecione um motivo...</option>';
            motivosDisponiveis.forEach(m => selectMotivo.add(new Option(m.motivo, m.id)));
            document.getElementById('obs-motivo').value = '';
            modal.classList.add('active'); // Usa a classe para a transição
            document.getElementById('btn-confirmar-ausencia').onclick = () => {
                const motivoId = document.getElementById('select-motivo').value;
                if (!motivoId) { return alert('Por favor, selecione um motivo da lista.'); }
                const observacao = document.getElementById('obs-motivo').value;
                salvarStatus(vendedorId, nomeVendedor, false, { motivoId, observacao });
                fecharModal();
            };
        }

        window.fecharModal = () => { modal.classList.remove('active'); }
        window.onclick = function(event) {
            if (event.target == modal) {
                fecharModal();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (!token) {
                window.location.href = '/';
                return;
            }
            
            const dateSearchContainer = document.getElementById('date-search-container');
            const tabContainer = document.getElementById('tab-container');

            // Lógica para o menu mobile
            const menuToggle = document.getElementById('menu-toggle');
            const mainMenu = document.getElementById('main-menu');
            if (menuToggle && mainMenu) {
                menuToggle.addEventListener('click', () => mainMenu.classList.toggle('active'));
            }

            // Lógica para mostrar/esconder o campo de data e abas
            if (userProfile === 'Diretoria' || userProfile === 'Admin' || isSuperuser) {
                dateSearchContainer.style.display = 'flex';
                tabContainer.style.display = 'flex';
            } else {
                dateSearchContainer.style.display = 'flex';
                tabContainer.style.display = 'flex';
                const todosUsuariosTab = tabContainer.querySelector('.tab-button:last-child');
                if (todosUsuariosTab) {
                    todosUsuariosTab.style.display = 'none';
                }
            }

            const dataInput = document.getElementById('data-pesquisa');
            const hoje = new Date();
            const dia = String(hoje.getDate()).padStart(2, '0');
            const mes = String(hoje.getMonth() + 1).padStart(2, '0');
            const ano = hoje.getFullYear();
            dataInput.value = `${ano}-${mes}-${dia}`;

            const btnPesquisar = document.getElementById('btn-pesquisar');
            btnPesquisar.addEventListener('click', carregarDadosIniciais);

            carregarDadosIniciais();
        });
    </script>
</body>
</html>