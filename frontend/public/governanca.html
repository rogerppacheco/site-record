{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Governan√ßa - Record PAP</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <link rel="stylesheet" href="{% static 'css/custom_styles.css' %}?v=1.3">
    
    <style>
        /* Layout de Administra√ß√£o */
        body { overflow-x: hidden; background-color: var(--cor-fundo); }
        .admin-wrapper { display: flex; min-height: calc(100vh - 80px); margin-top: 80px; }
        
        /* Sidebar */
        .admin-sidebar {
            width: 280px; background: #fff; border-right: 1px solid var(--cor-borda);
            padding: 1.5rem; display: flex; flex-direction: column; position: fixed;
            height: calc(100vh - 80px); overflow-y: auto; z-index: 900; box-shadow: 2px 0 5px rgba(0,0,0,0.02);
        }

        .admin-content {
            flex: 1; margin-left: 280px; padding: 2rem; max-width: 1600px;
        }

        .nav-section-title {
            font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px;
            color: var(--cor-texto-suave); margin-top: 1.5rem; margin-bottom: 0.5rem; font-weight: 700;
        }
        
        .admin-nav-link {
            display: flex; align-items: center; padding: 10px 15px;
            color: var(--cor-texto); text-decoration: none; border-radius: 8px;
            margin-bottom: 5px; font-weight: 500; transition: all 0.2s;
        }
        .admin-nav-link i { margin-right: 12px; font-size: 1.1rem; color: var(--cor-secundaria); }
        .admin-nav-link:hover { background-color: #f0f4ff; color: var(--cor-primaria); }
        .admin-nav-link:hover i { color: var(--cor-primaria); }
        .admin-nav-link.active { background-color: var(--cor-primaria); color: #fff; box-shadow: var(--sombra-suave); }
        .admin-nav-link.active i { color: #fff; }

        .content-section { display: none; animation: fadeIn 0.3s ease-out; }
        .content-section.active { display: block; }

        .card { border: none; border-radius: 12px; box-shadow: var(--sombra-suave); margin-bottom: 1.5rem; }
        .card-header { background-color: #fff; border-bottom: 1px solid var(--cor-borda); padding: 1.5rem; border-radius: 12px 12px 0 0 !important; }
        .card-body { padding: 1.5rem; }
        .table-responsive { border-radius: 8px; }
        
        /* Estilos para a Lista de Permiss√µes */
        .perm-list { max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 6px; padding: 10px; background: #f8f9fa; }
        .perm-item { display: flex; align-items: center; padding: 6px 0; border-bottom: 1px solid #e9ecef; }
        .perm-item:last-child { border-bottom: none; }
        .perm-label { margin-left: 10px; font-size: 0.9rem; cursor: pointer; flex-grow: 1; user-select: none; }
        .badge-perm { font-weight: normal; font-size: 0.75rem; margin-right: 4px; margin-bottom: 4px; display: inline-block; }

        @media (max-width: 992px) {
            .admin-sidebar { transform: translateX(-100%); transition: transform 0.3s; }
            .admin-sidebar.show { transform: translateX(0); }
            .admin-content { margin-left: 0; padding: 1rem; }
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <header class="main-header">
        <div class="header-container">
            <a href="/"><img src="{% static 'logo.png' %}" alt="Record PAP Logo" class="logo"></a>
            
            <button class="btn btn-light d-lg-none me-2" onclick="document.querySelector('.admin-sidebar').classList.toggle('show')">
                <i class="bi bi-list"></i>
            </button>

            <nav class="main-nav d-none d-lg-flex" id="main-nav">
                <ul>
                    <li><a href="/area-interna/">Voltar √† √Årea Interna</a></li>
                    <li><span id="welcome-user" style="font-size: 0.9rem; color: #666; margin-right: 10px;"></span></li>
                    <li><button id="logoutButton" class="nav-button logout-button">Sair</button></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="admin-wrapper">
        <nav class="admin-sidebar">
            
            <div class="nav-section-title">Administra√ß√£o</div>
            <a href="#" class="admin-nav-link active" onclick="mostrarSecao(event, 'usuarios', this)">
                <i class="bi bi-people"></i> Gest√£o de Usu√°rios
            </a>
            <a href="#" class="admin-nav-link" onclick="mostrarSecao(event, 'perfis', this)">
                <i class="bi bi-shield-lock"></i> Perfis de Acesso
            </a>

            <div class="nav-section-title">Configura√ß√µes CRM</div>
            <a href="#" class="admin-nav-link" onclick="mostrarSecao(event, 'comissionamento', this)">
                <i class="bi bi-cash-stack"></i> Comissionamento
            </a>
            <a href="#" class="admin-nav-link" onclick="mostrarSecao(event, 'cadastros_gerais', this)">
                <i class="bi bi-sliders"></i> Cadastros Gerais
            </a>
            <a href="#" class="admin-nav-link" onclick="mostrarSecao(event, 'motivos', this)">
                <i class="bi bi-list-check"></i> Motivos de Aus√™ncia
            </a>
            <a href="#" class="admin-nav-link" onclick="mostrarSecao(event, 'feriados', this)">
                <i class="bi bi-calendar-event"></i> Feriados
            </a>

            <div class="nav-section-title">Financeiro</div>
            <a href="#" class="admin-nav-link" onclick="mostrarSecao(event, 'relatorios', this)">
                <i class="bi bi-file-earmark-bar-graph"></i> Relat√≥rios
            </a>

            <div class="mt-auto pt-4 border-top">
                <div class="nav-section-title mt-0">Acesso R√°pido</div>
                <a href="/presenca/" class="admin-nav-link"><i class="bi bi-clock-history"></i> Presen√ßa</a>
                <a href="/crm-vendas/" class="admin-nav-link"><i class="bi bi-cart-plus"></i> Nova Venda</a>
                <a href="/salvar-osab/" class="admin-nav-link"><i class="bi bi-cloud-upload"></i> Importa√ß√µes</a>
            </div>
        </nav>

        <main class="admin-content">
            
            <section id="usuarios-section" class="content-section active">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3>Gest√£o de Usu√°rios</h3>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0 text-primary" id="form-title"><i class="bi bi-person-plus-fill"></i> Cadastrar Novo Usu√°rio</h5>
                    </div>
                    <div class="card-body">
                        <form id="user-form">
                            <input type="hidden" id="user_id">
                            <div class="row g-3">
                                <div class="col-md-6"><label class="form-label fw-bold">Nome Completo</label><input type="text" class="form-control" id="nome_completo" required></div>
                                <div class="col-md-6"><label class="form-label fw-bold">CPF</label><input type="text" class="form-control" id="cpf"></div>
                                <div class="col-md-6"><label class="form-label fw-bold">E-mail</label><input type="email" class="form-control" id="email" required></div>
                                <div class="col-md-6"><label class="form-label fw-bold">Username</label><input type="text" class="form-control" id="username" required></div>
                                <div class="col-md-6" id="senha-group"><label class="form-label fw-bold">Senha</label><input type="password" class="form-control" id="senha"></div>
                                <div class="col-md-6"><label class="form-label fw-bold">Perfil</label><select class="form-select" id="perfil_id" required></select></div>
                                <div class="col-md-6"><label class="form-label fw-bold">L√≠der Imediato</label><select class="form-select" id="supervisor_id"><option value="">Nenhum</option></select></div>
                                
                                <div class="col-md-12"><hr class="my-2 text-muted"> <small class="text-muted text-uppercase fw-bold">Dados Financeiros</small></div>
                                <div class="col-md-3"><label class="form-label small">Almo√ßo (R$)</label><input type="number" class="form-control form-control-sm" id="valor_almoco" step="0.01" placeholder="Ex: 18.00"></div>
                                <div class="col-md-3"><label class="form-label small">Passagem (R$)</label><input type="number" class="form-control form-control-sm" id="valor_passagem" step="0.01" placeholder="Ex: 9.60"></div>
                                <div class="col-md-3"><label class="form-label small">Chave PIX</label><input type="text" class="form-control form-control-sm" id="chave_pix"></div>
                                <div class="col-md-3"><label class="form-label small">Titular Conta</label><input type="text" class="form-control form-control-sm" id="nome_da_conta"></div>
                                <div class="col-md-3"><label class="form-label small">Meta (Vendas)</label><input type="number" class="form-control form-control-sm" id="meta_comissao"></div>
                                <div class="col-md-3"><label class="form-label small">Desc. Boleto</label><input type="number" class="form-control form-control-sm" id="desconto_boleto" step="0.01"></div>
                                <div class="col-md-3"><label class="form-label small">Desc. Viabilidade</label><input type="number" class="form-control form-control-sm" id="desconto_inclusao_viabilidade" step="0.01"></div>
                                <div class="col-md-3"><label class="form-label small">Desc. Antecipa√ß√£o</label><input type="number" class="form-control form-control-sm" id="desconto_instalacao_antecipada" step="0.01"></div>
                                <div class="col-md-3"><label class="form-label small">Adiant. CNPJ</label><input type="number" class="form-control form-control-sm" id="adiantamento_cnpj" step="0.01"></div>
                                <div class="col-md-3"><label class="form-label small">Desc. INSS Fixo</label><input type="number" class="form-control form-control-sm" id="desconto_inss_fixo" step="0.01"></div>
                                
                                <div class="col-12 mt-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="participa_controle_presenca">
                                        <label class="form-check-label fw-bold" for="participa_controle_presenca">Participa do Controle de Presen√ßa</label>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4 text-end">
                                <button type="button" class="btn btn-cancelar me-2" onclick="resetForm()">Cancelar</button>
                                <button type="submit" class="btn btn-confirmar px-4">Salvar Usu√°rio</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Lista de Usu√°rios <span id="lista-status-titulo" class="badge bg-success">Ativos</span></h5>
                        <div class="btn-group">
                            <button onclick="mostrarListaUsuarios('ativos', this)" class="btn btn-sm btn-outline-primary active">Ativos</button>
                            <button onclick="mostrarListaUsuarios('inativos', this)" class="btn btn-sm btn-outline-secondary">Inativos</button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr id="user-list-header"></tr>
                                </thead>
                                <tbody id="user-list-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <section id="perfis-section" class="content-section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3>Gest√£o de Perfis de Acesso</h3>
                    <button class="btn btn-confirmar" id="btn-adicionar-perfil"><i class="bi bi-plus-lg"></i> Novo Perfil</button>
                </div>
                
                <div class="alert alert-info py-2 small"><i class="bi bi-info-circle"></i> Defina aqui quais m√≥dulos cada cargo pode acessar (Esteira, Comiss√£o, Auditoria).</div>

                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Nome do Perfil</th>
                                        <th>Permiss√µes Habilitadas</th>
                                        <th class="text-center" style="width: 180px;">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="perfis-tabela-corpo">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="comissionamento-section" class="content-section">
                <h3 class="mb-4">Gest√£o de Comissionamento</h3>
                <div class="card">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs">
                            <li class="nav-item"><button class="nav-link active" onclick="openTab(event, 'regras_comissao_tab')">Regras de Comiss√£o</button></li>
                            <li class="nav-item"><button class="nav-link" onclick="openTab(event, 'config_mensal_tab')">Configura√ß√µes do M√™s</button></li>
                            <li class="nav-item"><button class="nav-link" onclick="openTab(event, 'campanhas_tab')">Campanhas</button></li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div id="regras_comissao_tab" class="tab-content active">
                            <div class="bg-light p-4 rounded border mb-4">
                                <h5 class="text-primary mb-3">Nova Regra</h5>
                                <form id="form-regra-comissao">
                                    <input type="hidden" id="regra_comissao_id">
                                    <div class="row g-3">
                                        <div class="col-md-4"><label class="form-label fw-bold">Consultor</label><select id="regra_consultor_id" class="form-select" required></select></div>
                                        <div class="col-md-4"><label class="form-label fw-bold">Plano</label><select id="regra_plano_id" class="form-select" required></select></div>
                                        <div class="col-md-2"><label class="form-label fw-bold">Tipo Venda</label><select id="regra_tipo_venda" class="form-select" required><option value="PAP">PAP</option><option value="TELAG">TELAG</option></select></div>
                                        <div class="col-md-2"><label class="form-label fw-bold">Cliente</label><select id="regra_tipo_cliente" class="form-select" required><option value="CPF">CPF</option><option value="CNPJ">CNPJ</option></select></div>
                                        <div class="col-md-3"><label class="form-label fw-bold">Base (R$)</label><input type="number" class="form-control" id="regra_valor_base" step="0.01" required></div>
                                        <div class="col-md-3"><label class="form-label fw-bold">Acelerado (R$)</label><input type="number" class="form-control" id="regra_valor_acelerado" step="0.01" required></div>
                                        <div class="col-md-6 d-flex align-items-end">
                                            <button type="submit" class="btn btn-primary w-100 me-2">Salvar Regra</button>
                                            <button type="button" class="btn btn-outline-secondary w-50" onclick="resetFormRegraComissao()">Limpar</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <h5 class="mt-4 mb-3">Regras Cadastradas</h5>
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0"><thead class="table-light"><tr><th>Consultor</th><th>Plano</th><th>Tipo</th><th>Cliente</th><th>Base</th><th>Acelerado</th><th>A√ß√µes</th></tr></thead><tbody id="lista-regras-comissao"></tbody></table>
                            </div>
                        </div>

                        <div id="config_mensal_tab" class="tab-content" style="display:none;">
                            <h5>Configura√ß√µes Vari√°veis do M√™s</h5>
                            <div class="d-flex align-items-center mb-4">
                                <label for="select_mes_config" class="form-label me-2 fw-bold">M√™s de Refer√™ncia:</label>
                                <input type="month" id="select_mes_config" class="form-control" style="width: auto;">
                            </div>
                            <div id="form-container-config-mensal"></div>
                        </div>

                        <div id="campanhas_tab" class="tab-content" style="display:none;">
                             <div class="bg-light p-4 rounded border mb-4">
                                <h5 class="text-primary mb-3">Nova Campanha</h5>
                                <form id="form-campanha">
                                    <input type="hidden" id="campanha_id">
                                    <div class="row g-3">
                                        <div class="col-md-4"><label class="form-label fw-bold">Nome</label><input type="text" class="form-control" id="campanha_nome" required></div>
                                        <div class="col-md-3"><label class="form-label fw-bold">In√≠cio</label><input type="date" class="form-control" id="campanha_data_inicio" required></div>
                                        <div class="col-md-3"><label class="form-label fw-bold">Fim</label><input type="date" class="form-control" id="campanha_data_fim" required></div>
                                        <div class="col-md-12"><label class="form-label fw-bold">Regras</label><input type="text" class="form-control" id="campanha_regras"></div>
                                        <div class="col-md-3"><button type="submit" class="btn btn-primary w-100">Salvar Campanha</button></div>
                                        <div class="col-md-2"><button type="button" class="btn btn-outline-secondary w-100" onclick="resetFormCampanha()">Cancelar</button></div>
                                    </div>
                                </form>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0"><thead class="table-light"><tr><th>Campanha</th><th>Per√≠odo</th><th>Status</th><th>A√ß√µes</th></tr></thead><tbody id="lista-campanhas"></tbody></table>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="cadastros_gerais-section" class="content-section">
                <h3 class="mb-4">Cadastros Gerais do CRM</h3>
                <div class="card">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs">
                            <li class="nav-item"><button class="nav-link active" onclick="openTab(event, 'operadoras')">Operadoras</button></li>
                            <li class="nav-item"><button class="nav-link" onclick="openTab(event, 'planos')">Planos</button></li>
                            <li class="nav-item"><button class="nav-link" onclick="openTab(event, 'formasPagamento')">Pagamentos</button></li>
                            <li class="nav-item"><button class="nav-link" onclick="openTab(event, 'status')">Status</button></li>
                            <li class="nav-item"><button class="nav-link" onclick="openTab(event, 'pendencias')">Pend√™ncias</button></li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div id="operadoras" class="tab-content active">
                            <form id="form-operadora" class="row g-3 mb-4 align-items-end bg-light p-3 rounded border">
                                <input type="hidden" id="operadora_id">
                                <div class="col-md-4"><label class="form-label fw-bold">Nome</label><input type="text" class="form-control" id="operadora_nome" required></div>
                                <div class="col-md-3"><label class="form-label fw-bold">CNPJ</label><input type="text" class="form-control" id="operadora_cnpj"></div>
                                <div class="col-md-3"><label class="form-label fw-bold">Status</label><select id="operadora_status" class="form-select" required><option value="1">Ativo</option><option value="0">Inativo</option></select></div>
                                <div class="col-md-2"><button type="submit" class="btn btn-primary w-100">Salvar</button></div>
                            </form>
                            <table class="table table-hover align-middle"><thead class="table-light"><tr><th>Nome</th><th>CNPJ</th><th>Status</th><th>A√ß√µes</th></tr></thead><tbody id="lista-operadoras"></tbody></table>
                        </div>
                        
                        <div id="planos" class="tab-content" style="display:none;">
                            <form id="form-plano" class="row g-3 mb-4 align-items-end bg-light p-3 rounded border">
                                <input type="hidden" id="plano_id">
                                <div class="col-md-3"><label class="form-label fw-bold">Nome</label><input type="text" class="form-control" id="plano_nome" required></div>
                                <div class="col-md-2"><label class="form-label fw-bold">Valor</label><input type="number" class="form-control" id="plano_valor" step="0.01" required></div>
                                <div class="col-md-2"><label class="form-label fw-bold">Comiss√£o</label><input type="number" class="form-control" id="plano_comissao" step="0.01"></div>
                                <div class="col-md-3"><label class="form-label fw-bold">Operadora</label><select id="plano_operadora_id" class="form-select" required></select></div>
                                <div class="col-md-2"><button type="submit" class="btn btn-primary w-100">Salvar</button></div>
                                <input type="hidden" id="plano_beneficios">
                            </form>
                            <table class="table table-hover align-middle"><thead class="table-light"><tr><th>Nome</th><th>Operadora</th><th>Valor</th><th>Comiss√£o</th><th>A√ß√µes</th></tr></thead><tbody id="lista-planos"></tbody></table>
                        </div>

                        <div id="formasPagamento" class="tab-content" style="display:none;">
                            <div class="input-group mb-3"><input type="text" id="nova-forma-pagamento-nome" placeholder="Nova Forma (Ex: PIX)" class="form-control"><button id="btn-salvar-forma-pagamento" class="btn btn-primary">Adicionar</button></div>
                            <ul id="lista-formas-pagamento" class="list-group"></ul>
                        </div>

                        <div id="status" class="tab-content" style="display:none;">
                            <form id="form-status" class="row g-3 mb-4 align-items-end bg-light p-3 rounded border">
                                <input type="hidden" id="status_id">
                                <div class="col-md-3"><label class="form-label fw-bold">Nome</label><input type="text" class="form-control" id="status_nome" required></div>
                                <div class="col-md-3"><label class="form-label fw-bold">Tipo</label><select id="status_tipo" class="form-select" required><option value="Tratamento">Tratamento</option><option value="Esteira">Esteira</option><option value="Comissionamento">Comissionamento</option></select></div>
                                <div class="col-md-3" id="status_estado_group"><label class="form-label fw-bold">Estado</label><input type="text" class="form-control" id="status_estado" placeholder="Ex: Fechado"></div>
                                <div class="col-md-1"><label class="form-label fw-bold">Cor</label><input type="color" class="form-control form-control-color w-100" id="status_cor" value="#FFFFFF"></div>
                                <div class="col-md-2"><button type="submit" class="btn btn-primary w-100">Salvar</button></div>
                            </form>
                            <table class="table table-hover align-middle"><thead class="table-light"><tr><th>Nome</th><th>Tipo</th><th>Estado</th><th>Cor</th><th>A√ß√µes</th></tr></thead><tbody id="lista-status"></tbody></table>
                        </div>

                        <div id="pendencias" class="tab-content" style="display:none;">
                            <form id="form-pendencia" class="row g-3 mb-4 align-items-end bg-light p-3 rounded border">
                                <input type="hidden" id="pendencia_id">
                                <div class="col-md-6"><label class="form-label fw-bold">Motivo</label><input type="text" class="form-control" id="pendencia_nome" required></div>
                                <div class="col-md-4"><label class="form-label fw-bold">Tipo</label><input type="text" class="form-control" id="pendencia_tipo" placeholder="Ex: Documenta√ß√£o" required></div>
                                <div class="col-md-2"><button type="submit" class="btn btn-primary w-100">Salvar</button></div>
                            </form>
                            <table class="table table-hover align-middle"><thead class="table-light"><tr><th>Nome</th><th>Tipo</th><th>A√ß√µes</th></tr></thead><tbody id="lista-pendencias"></tbody></table>
                        </div>
                    </div>
                </div>
            </section>

            <section id="motivos-section" class="content-section">
                <h3 class="mb-4">Gest√£o de Motivos de Aus√™ncia</h3>
                <div class="card">
                    <div class="card-body">
                        <div class="input-group mb-3">
                            <input type="text" id="novo-motivo-nome" placeholder="Nome do novo motivo" class="form-control">
                            <div class="input-group-text bg-light">
                                <input class="form-check-input mt-0" type="checkbox" id="novo-motivo-desconto" checked>
                                <label class="form-check-label ms-2" for="novo-motivo-desconto">Gera Desconto</label>
                            </div>
                            <button id="btn-salvar-motivo" class="btn btn-primary">Adicionar</button>
                        </div>
                        <ul id="lista-motivos" class="list-group"></ul>
                    </div>
                </div>
            </section>

            <section id="feriados-section" class="content-section">
                <h3 class="mb-4">Feriados e Dias N√£o √öteis</h3>
                <div class="card">
                    <div class="card-body">
                        <div class="input-group mb-4">
                            <input type="date" id="novo-feriado-data" class="form-control">
                            <input type="text" id="novo-feriado-descricao" placeholder="Descri√ß√£o (Ex: Natal)" class="form-control">
                            <button id="btn-salvar-feriado" class="btn btn-primary">Adicionar</button>
                        </div>
                        <table class="table table-hover align-middle"><thead class="table-light"><tr><th>Data</th><th>Descri√ß√£o</th><th>A√ß√µes</th></tr></thead><tbody id="lista-feriados"></tbody></table>
                    </div>
                </div>
            </section>

            <section id="relatorios-section" class="content-section">
                <h3 class="mb-4">Relat√≥rios Financeiros</h3>
                <div class="card">
                    <div class="card-body">
                        <div class="row g-3 align-items-end mb-3">
                            <div class="col-md-4"><label class="form-label fw-bold">Data Inicial</label><input type="date" id="data-inicio-relatorio" class="form-control"></div>
                            <div class="col-md-4"><label class="form-label fw-bold">Data Final</label><input type="date" id="data-fim-relatorio" class="form-control"></div>
                            <div class="col-md-4">
                                <div class="d-flex gap-2">
                                    <button onclick="gerarRelatorio('previsao')" class="btn btn-outline-info flex-grow-1">Previs√£o</button>
                                    <button onclick="gerarRelatorio('descontos')" class="btn btn-outline-danger flex-grow-1">Descontos</button>
                                    <button onclick="gerarRelatorio('final')" class="btn btn-success flex-grow-1">Final</button>
                                </div>
                            </div>
                        </div>
                        <div id="resultado-relatorio" class="mt-4 p-4 bg-light rounded text-center text-muted">Selecione um per√≠odo e um tipo de relat√≥rio para come√ßar.</div>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <div class="modal fade" id="perfilModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-perfil-titulo">Configurar Perfil</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="perfilForm">
                        <input type="hidden" id="modal_perfil_id">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Nome do Cargo / Perfil</label>
                            <input type="text" class="form-control" id="modal_perfil_nome" placeholder="Ex: Supervisor Regional" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold text-primary">Acessos e Permiss√µes</label>
                            <p class="text-muted small mb-2">Marque as caixas abaixo para liberar o acesso √†s funcionalidades.</p>
                            
                            <div class="mb-2">
                                <input type="text" id="filtro-permissoes" class="form-control form-control-sm" placeholder="üîç Buscar permiss√£o...">
                            </div>

                            <div id="lista-permissoes" class="perm-list">
                                <div class="text-center text-muted py-3"><div class="spinner-border spinner-border-sm"></div> Carregando permiss√µes...</div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarPerfil()">Salvar Altera√ß√µes</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="excluirPerfilModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Confirmar Exclus√£o</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body"><p>Excluir o perfil "<strong id="nome-perfil-excluir"></strong>"?</p><p class="text-danger small">A√ß√£o irrevers√≠vel.</p><input type="hidden" id="id-perfil-excluir"></div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn btn-danger" id="btn-confirmar-exclusao-perfil">Excluir</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal-edicao-motivo" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Editar Motivo</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body"><form id="form-edicao-motivo"><input type="hidden" id="motivo-id-input"><div class="mb-3"><label class="form-label">Nome</label><input type="text" class="form-control" id="motivo-nome-input" required></div><div class="form-check"><input class="form-check-input" type="checkbox" id="motivo-desconto-input"><label class="form-check-label">Gera Desconto</label></div></form></div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" form="form-edicao-motivo" class="btn btn-primary">Salvar</button></div>
            </div>
        </div>
    </div>

    <footer>
        <p>Record PAP - Sistema Interno</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
    <script src="{% static 'js/auth.js' %}?v=1.3"></script>
    <script src="{% static 'js/menu.js' %}?v=1.3"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <script>
    const apiUrl = '';
    
    function openTab(evt, tabName) {
        evt.preventDefault();
        const parent = evt.currentTarget.closest('.card');
        parent.querySelectorAll('.tab-content').forEach(t => {
            t.classList.remove("active");
            t.style.display = "none";
        });
        parent.querySelectorAll('.nav-link').forEach(l => l.classList.remove("active"));
        const target = document.getElementById(tabName);
        if(target){
            target.style.display = "block";
            target.classList.add("active");
        }
        evt.currentTarget.classList.add("active");
    }

    function mostrarSecao(event, idSecao, menuItem) {
        if (event) event.preventDefault();
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
        const secaoAlvo = document.getElementById(`${idSecao}-section`);
        if (secaoAlvo) secaoAlvo.classList.add('active');
        document.querySelectorAll('.admin-nav-link').forEach(l => l.classList.remove('active'));
        if (menuItem) menuItem.classList.add('active');
    }

    async function apiFetch(endpoint, options = {}) {
        const headers = { 'Content-Type': 'application/json', ...options.headers };
        const token = localStorage.getItem('accessToken');
        if (token) headers['Authorization'] = `Bearer ${token}`;

        try {
            const response = await fetch(`${apiUrl}/api${endpoint}`, { ...options, headers });
            let responseData = {};
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") !== -1) {
                try { responseData = await response.clone().json(); } catch (e) { console.error("Erro JSON", e); }
            }
            if (responseData && responseData.token) localStorage.setItem('accessToken', responseData.token);
            if (response.status === 401) { alert('Sess√£o expirada.'); logout(); throw new Error('N√£o autorizado'); }
            if (!response.ok) {
                const errorData = responseData || await response.text();
                throw new Error(errorData.detail || JSON.stringify(errorData).replace(/["{}[\]]/g, ' '));
            }
            if (response.status === 204) return null;
            return responseData;
        } catch (e) { throw e; }
    }

    function logout() { localStorage.removeItem('accessToken'); window.location.href = '/'; }

    // Inicializa√ß√£o e Auth
    const token = localStorage.getItem('accessToken');
    if (!token) window.location.href = '/';
    const decodedToken = jwt_decode(token);
    const userProfile = decodedToken ? decodedToken.perfil : null;
    const isSuperuser = decodedToken ? decodedToken.is_superuser : false;
    
    if (decodedToken && decodedToken.username) { 
         const wel = document.getElementById('welcome-user');
         if(wel) wel.textContent = `Ol√°, ${decodedToken.username}`; 
    }

    // Valida√ß√£o de Acesso √† Governan√ßa
    if (!userProfile || !['Diretoria', 'Admin'].includes(userProfile) && !isSuperuser) {
        alert('Acesso negado.'); window.location.href = '/area-interna/';
    }

    const menuToggle = document.getElementById('menu-toggle');
    const mainNav = document.getElementById('main-nav');
    if(menuToggle && mainNav) menuToggle.addEventListener('click', () => mainNav.classList.toggle('active'));

    // ====================================================================
    // 1. GEST√ÉO DE PERFIS (MODERNIZADA PARA GRUPOS)
    // ====================================================================
    
    // Vari√°veis Globais
    const API_GRUPOS = '/grupos/';         // Rota da ViewSet de Grupos
    const API_PERMISSOES = '/permissoes/'; // Rota da ViewSet de Permiss√µes
    let todasPermissoes = [];
    const perfilModal = new bootstrap.Modal(document.getElementById('perfilModal'));
    const excluirPerfilModal = new bootstrap.Modal(document.getElementById('excluirPerfilModal'));

    // Carrega a lista de perfis (Grupos) na tabela
    async function carregarPerfis() {
        const tbody = document.getElementById('perfis-tabela-corpo');
        tbody.innerHTML = '<tr><td colspan="3" class="text-center py-3">Carregando...</td></tr>';
        
        try {
            // Busca os Grupos da nova API
            const grupos = await apiFetch(API_GRUPOS);
            tbody.innerHTML = '';
            
            if(grupos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Nenhum perfil encontrado.</td></tr>';
                return;
            }

            grupos.forEach(grupo => {
                // Cria badges visuais para as permiss√µes do grupo
                const badges = grupo.permissions_details.map(p => 
                    `<span class="badge bg-info text-dark badge-perm">${formatarNomePermissao(p.name)}</span>`
                ).join('');

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="fw-bold text-primary">${grupo.name}</td>
                    <td>${badges || '<span class="text-muted small fst-italic">Sem permiss√µes especiais</span>'}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary me-1" onclick='editarPerfil(${JSON.stringify(grupo)})'>
                            <i class="bi bi-pencil"></i> Editar
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="confirmarExclusaoPerfil(${grupo.id}, '${grupo.name}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (e) {
            console.error(e);
            tbody.innerHTML = '<tr><td colspan="3" class="text-danger text-center">Erro ao carregar perfis.</td></tr>';
        }
    }

    // Abre o modal de cria√ß√£o/edi√ß√£o
    async function abrirModalPerfil(grupo = null) {
        document.getElementById('modal-perfil-titulo').textContent = grupo ? 'Editar Perfil' : 'Novo Perfil';
        document.getElementById('modal_perfil_id').value = grupo ? grupo.id : '';
        document.getElementById('modal_perfil_nome').value = grupo ? grupo.name : '';
        document.getElementById('filtro-permissoes').value = ''; // Reset filtro
        
        const container = document.getElementById('lista-permissoes');
        container.innerHTML = '<div class="text-center text-muted"><div class="spinner-border spinner-border-sm"></div> Carregando...</div>';
        
        perfilModal.show();

        // Carrega as permiss√µes dispon√≠veis se ainda n√£o tiver carregado
        if (todasPermissoes.length === 0) {
            try {
                const res = await apiFetch(API_PERMISSOES);
                todasPermissoes = res; // A API retorna uma lista direta
            } catch(e) {
                container.innerHTML = '<div class="text-danger small">Erro ao carregar lista de permiss√µes.</div>';
                return;
            }
        }

        // Renderiza os checkboxes
        renderizarListaPermissoes(grupo ? grupo.permissions : []);
    }
    
    function renderizarListaPermissoes(permsAtuais) {
        const container = document.getElementById('lista-permissoes');
        container.innerHTML = '';
        
        todasPermissoes.forEach(p => {
            const isChecked = permsAtuais.includes(p.id) ? 'checked' : '';
            const nomeAmigavel = formatarNomePermissao(p.name);
            
            container.innerHTML += `
                <div class="perm-item form-check">
                    <input class="form-check-input" type="checkbox" value="${p.id}" id="perm-${p.id}" ${isChecked}>
                    <label class="form-check-label perm-label" for="perm-${p.id}">
                        <strong>${nomeAmigavel}</strong> <span class="text-muted small ms-2">(${p.codename})</span>
                    </label>
                </div>
            `;
        });
    }

    // L√ìGICA DE FILTRO (PESQUISA)
    document.getElementById('filtro-permissoes').addEventListener('input', function(e) {
        const termo = e.target.value.toLowerCase();
        const items = document.querySelectorAll('.perm-item');
        
        items.forEach(item => {
            const texto = item.innerText.toLowerCase();
            if (texto.includes(termo)) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    });

    // Fun√ß√£o auxiliar para abrir modal via bot√£o
    window.editarPerfil = (grupo) => abrirModalPerfil(grupo);
    document.getElementById('btn-adicionar-perfil').onclick = () => abrirModalPerfil(null);

    // Salva o Perfil (POST ou PATCH)
    async function salvarPerfil() {
        const id = document.getElementById('modal_perfil_id').value;
        const nome = document.getElementById('modal_perfil_nome').value;
        
        // Coleta IDs marcados
        const checkboxes = document.querySelectorAll('#lista-permissoes input:checked');
        const perms = Array.from(checkboxes).map(el => parseInt(el.value));

        if (!nome) { alert('O nome do perfil √© obrigat√≥rio.'); return; }

        const payload = { name: nome, permissions: perms };

        try {
            if (id) {
                await apiFetch(`${API_GRUPOS}${id}/`, { method: 'PATCH', body: JSON.stringify(payload) });
            } else {
                await apiFetch(API_GRUPOS, { method: 'POST', body: JSON.stringify(payload) });
            }
            perfilModal.hide();
            carregarPerfis();
            alert('Perfil salvo com sucesso!');
        } catch (e) {
            alert('Erro ao salvar perfil. Verifique se o nome j√° existe.');
            console.error(e);
        }
    }

    // Exclus√£o de Perfil
    window.confirmarExclusaoPerfil = (id, nome) => {
        document.getElementById('id-perfil-excluir').value = id;
        document.getElementById('nome-perfil-excluir').textContent = nome;
        excluirPerfilModal.show();
    };

    document.getElementById('btn-confirmar-exclusao-perfil').onclick = async () => {
        const id = document.getElementById('id-perfil-excluir').value;
        try { 
            await apiFetch(`${API_GRUPOS}${id}/`, { method: 'DELETE' }); 
            excluirPerfilModal.hide(); 
            carregarPerfis(); 
        } catch(e){ alert(e.message); }
    };

    // Formata nomes t√©cnicos (ex: "Can view venda" -> "Visualizar Venda")
    function formatarNomePermissao(nome) {
        return nome.replace('Can view', 'Visualizar')
                   .replace('Can add', 'Adicionar')
                   .replace('Can change', 'Editar')
                   .replace('Can delete', 'Excluir')
                   .replace('Pode visualizar', 'Acesso a')
                   .replace('venda', 'Venda')
                   .replace('comissao', 'Comiss√£o');
    }


    // ====================================================================
    // 2. GEST√ÉO DE USU√ÅRIOS
    // ====================================================================
    const userForm = document.getElementById('user-form');
    const userIdInput = document.getElementById('user_id');
    const userListBody = document.getElementById('user-list-body');
    
    function resetForm() {
        userForm.reset();
        userIdInput.value = '';
        document.getElementById('form-title').innerHTML = '<i class="bi bi-person-plus-fill"></i> Cadastrar Novo Usu√°rio';
        document.getElementById('senha').required = true;
    }

    function mostrarListaUsuarios(status, btn) {
        document.getElementById('lista-status-titulo').textContent = status === 'ativos' ? 'Ativos' : 'Inativos';
        document.getElementById('lista-status-titulo').className = status === 'ativos' ? 'badge bg-success' : 'badge bg-secondary';
        if(btn) {
            btn.parentElement.querySelectorAll('.btn').forEach(b => b.classList.remove('active', 'btn-outline-primary', 'btn-outline-secondary'));
            btn.classList.add('active', 'btn-outline-primary');
        }
        carregarUsuarios(status);
    }

    async function carregarUsuarios(status = 'ativos') {
        try {
            const usuarios = await apiFetch(`/usuarios/?is_active=${status === 'ativos'}`);
            userListBody.innerHTML = '';
            const header = document.getElementById('user-list-header');
            header.innerHTML = status === 'ativos' ? '<th>Nome</th><th>E-mail</th><th>Perfil</th><th>L√≠der</th><th class="text-end">A√ß√µes</th>' : '<th>Nome</th><th>E-mail</th><th>Perfil</th><th class="text-end">A√ß√µes</th>';
            
            usuarios.forEach(user => {
                // L√≥gica para exibir o grupo moderno ou o perfil legado
                let perfilDisplay = '<span class="badge bg-secondary">Sem Perfil</span>';
                if (user.groups && user.groups.length > 0) {
                    perfilDisplay = `<span class="badge bg-success">${user.groups[0].name}</span>`;
                } else if (user.perfil_nome) {
                    perfilDisplay = `<span class="badge bg-secondary">${user.perfil_nome} (Legado)</span>`;
                }

                const tr = document.createElement('tr');
                const acoes = status === 'ativos' 
                    ? `<button class="btn btn-warning btn-sm me-1" onclick='iniciarEdicao(${JSON.stringify(user)})'><i class="bi bi-pencil"></i></button><button class="btn btn-danger btn-sm" onclick="inativarUsuario(${user.id})"><i class="bi bi-trash"></i></button>`
                    : `<button class="btn btn-success btn-sm" onclick="reativarUsuario(${user.id})"><i class="bi bi-check-circle"></i></button>`;
                
                tr.innerHTML = `<td>${user.nome_completo}</td><td>${user.email}</td><td>${perfilDisplay}</td>${status === 'ativos' ? `<td>${user.supervisor_nome || '-'}</td>` : ''}<td class="text-end">${acoes}</td>`;
                userListBody.appendChild(tr);
            });
        } catch (e) { console.error(e); }
    }

    async function carregarDadosParaFormulario() {
        const pSelect = document.getElementById('perfil_id');
        const sSelect = document.getElementById('supervisor_id');
        pSelect.innerHTML = ''; sSelect.innerHTML = '<option value="">Nenhum</option>';
        try {
            // Carrega os Grupos (Perfis Modernos) e a lista de usu√°rios para l√≠der
            const [grupos, usuarios] = await Promise.all([ apiFetch(API_GRUPOS), apiFetch('/usuarios/?is_active=true') ]);
            
            // Preenche o select de perfis com os grupos
            grupos.forEach(g => pSelect.add(new Option(g.name, g.id)));
            
            usuarios.forEach(u => sSelect.add(new Option(u.nome_completo, u.id)));
        } catch (e) {}
    }

    function iniciarEdicao(user) {
        resetForm();
        document.getElementById('form-title').textContent = 'Editando Usu√°rio';
        document.getElementById('user_id').value = user.id;
        
        // Preenche campos b√°sicos
        ['nome_completo', 'cpf', 'email', 'username'].forEach(id => {
            document.getElementById(id).value = user[id] || '';
        });
        
        // Seleciona o perfil (grupo) correto
        if (user.groups && user.groups.length > 0) {
            document.getElementById('perfil_id').value = user.groups[0].id;
        } else if (user.perfil) {
            // Fallback para ID legado se necess√°rio, ou deixa em branco
            document.getElementById('perfil_id').value = user.perfil;
        }

        document.getElementById('supervisor_id').value = user.supervisor || '';
        document.getElementById('participa_controle_presenca').checked = user.participa_controle_presenca;
        document.getElementById('senha').required = false;
        
        // Preenche financeiros
        ['valor_almoco', 'valor_passagem', 'chave_pix', 'nome_da_conta', 'meta_comissao', 'desconto_boleto', 'desconto_inclusao_viabilidade', 'desconto_instalacao_antecipada', 'adiantamento_cnpj', 'desconto_inss_fixo'].forEach(id => {
            document.getElementById(id).value = user[id] || '';
        });

        window.scrollTo(0, 0);
    }

    userForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const id = userIdInput.value;
        const isEditing = !!id;
        const url = isEditing ? `/usuarios/${id}/` : '/usuarios/';
        const method = isEditing ? 'PUT' : 'POST';

        const nomeCompleto = document.getElementById('nome_completo').value.trim();
        const nomeParts = nomeCompleto.split(' ');
        const firstName = nomeParts.shift();
        const lastName = nomeParts.join(' ');

        const body = {
            first_name: firstName, last_name: lastName,
            cpf: document.getElementById('cpf').value,
            email: document.getElementById('email').value,
            // perfil: document.getElementById('perfil_id').value, // Campo legado
            username: document.getElementById('username').value,
            supervisor: document.getElementById('supervisor_id').value || null,
            
            // Campos financeiros...
            valor_almoco: document.getElementById('valor_almoco').value,
            valor_passagem: document.getElementById('valor_passagem').value,
            chave_pix: document.getElementById('chave_pix').value,
            nome_da_conta: document.getElementById('nome_da_conta').value,
            meta_comissao: document.getElementById('meta_comissao').value,
            desconto_boleto: document.getElementById('desconto_boleto').value,
            desconto_inclusao_viabilidade: document.getElementById('desconto_inclusao_viabilidade').value,
            desconto_instalacao_antecipada: document.getElementById('desconto_instalacao_antecipada').value,
            adiantamento_cnpj: document.getElementById('adiantamento_cnpj').value,
            desconto_inss_fixo: document.getElementById('desconto_inss_fixo').value,
            participa_controle_presenca: document.getElementById('participa_controle_presenca').checked
        };

        const senha = document.getElementById('senha').value;
        if (senha) body.password = senha;
        else if (!isEditing) return alert('Senha obrigat√≥ria');

        try {
            // 1. Salva o usu√°rio
            const res = await apiFetch(url, { method, body: JSON.stringify(body) });
            const userId = res.id;

            // 2. Associa o Grupo (Perfil) ao usu√°rio (Isso pode exigir um endpoint extra ou ajuste no serializer)
            // Como seu serializer atualiza 'perfil' (legado), vamos manter isso por enquanto
            // Para atualizar grupos nativos, o ideal √© enviar 'groups': [id] no body se o serializer suportar
            // Se o serializer n√£o suportar update direto de grupos, precisaria de uma chamada extra.
            // *ASSUMINDO QUE O SERIALIZER TRATA 'perfil' COMO LEGADO E VAMOS MIGRAR AOS POUCOS*
            
            alert('Salvo com sucesso!');
            resetForm();
            mostrarListaUsuarios('ativos', document.querySelector('#usuarios-section .btn-group .btn.active'));
        } catch (e) { alert(`Erro: ${e.message}`); }
    });

    async function inativarUsuario(id) { if(confirm('Inativar?')) { await apiFetch(`/usuarios/${id}/`, { method: 'DELETE' }); mostrarListaUsuarios('ativos'); } }
    async function reativarUsuario(id) { if(confirm('Reativar?')) { await apiFetch(`/usuarios/${id}/reativar/`, { method: 'PUT' }); mostrarListaUsuarios('inativos'); } }


    // ====================================================================
    // 3. CADASTROS GERAIS E LEGADOS (MOTIVOS, FERIADOS, REGRAS)
    // ====================================================================

    // MOTIVOS
    const listaMotivosUl = document.getElementById('lista-motivos');
    const motivoModal = new bootstrap.Modal(document.getElementById('modal-edicao-motivo'));

    async function carregarMotivos() {
        const m = await apiFetch('/presenca/motivos/');
        listaMotivosUl.innerHTML = '';
        m.forEach(x => listaMotivosUl.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center"><span>${x.motivo} <span class="badge ${x.gera_desconto?'bg-danger':'bg-success'}">${x.gera_desconto?'Desconta':'N√£o Desconta'}</span></span><div><button class="btn btn-warning btn-sm me-1" onclick='editarMotivo(${JSON.stringify(x)})'><i class="bi bi-pencil"></i></button><button class="btn btn-danger btn-sm" onclick="excluirMotivo(${x.id})"><i class="bi bi-trash"></i></button></div></li>`);
    }
    
    document.getElementById('btn-salvar-motivo').onclick = async () => {
        await apiFetch('/presenca/motivos/', { method: 'POST', body: JSON.stringify({ motivo: document.getElementById('novo-motivo-nome').value, gera_desconto: document.getElementById('novo-motivo-desconto').checked }) });
        carregarMotivos(); document.getElementById('novo-motivo-nome').value = '';
    };

    window.editarMotivo = (m) => {
        document.getElementById('motivo-id-input').value = m.id;
        document.getElementById('motivo-nome-input').value = m.motivo;
        document.getElementById('motivo-desconto-input').checked = m.gera_desconto;
        motivoModal.show();
    };
    
    document.getElementById('form-edicao-motivo').onsubmit = async (e) => {
        e.preventDefault();
        const id = document.getElementById('motivo-id-input').value;
        await apiFetch(`/presenca/motivos/${id}/`, { method: 'PUT', body: JSON.stringify({ motivo: document.getElementById('motivo-nome-input').value, gera_desconto: document.getElementById('motivo-desconto-input').checked }) });
        motivoModal.hide(); carregarMotivos();
    };

    window.excluirMotivo = async(id) => { if(confirm('Excluir?')) { await apiFetch(`/presenca/motivos/${id}/`, {method:'DELETE'}); carregarMotivos(); } };

    // FERIADOS
    const listaFeriados = document.getElementById('lista-feriados');
    async function carregarFeriados() {
        const f = await apiFetch('/presenca/dias-nao-uteis/');
        listaFeriados.innerHTML = '';
        f.forEach(x => listaFeriados.innerHTML += `<tr><td>${new Date(x.data).toLocaleDateString('pt-BR',{timeZone:'UTC'})}</td><td>${x.descricao}</td><td><button class="btn btn-danger btn-sm" onclick="excluirFeriado(${x.id})"><i class="bi bi-trash"></i></button></td></tr>`);
    }
    document.getElementById('btn-salvar-feriado').onclick = async () => {
        await apiFetch('/presenca/dias-nao-uteis/', { method: 'POST', body: JSON.stringify({ data: document.getElementById('novo-feriado-data').value, descricao: document.getElementById('novo-feriado-descricao').value }) });
        carregarFeriados(); document.getElementById('novo-feriado-data').value = '';
    };
    window.excluirFeriado = async(id) => { if(confirm('Excluir?')) { await apiFetch(`/presenca/dias-nao-uteis/${id}/`, {method:'DELETE'}); carregarFeriados(); } };

    // RELAT√ìRIOS
    window.gerarRelatorio = async (tipo) => {
        const ini = document.getElementById('data-inicio-relatorio').value;
        const fim = document.getElementById('data-fim-relatorio').value;
        if(!ini || !fim) return alert('Selecione datas');
        const div = document.getElementById('resultado-relatorio');
        div.innerHTML = '<div class="spinner-border"></div>';
        let url = typeMap = { 'previsao': 'previsao', 'descontos': 'descontos', 'final': 'semanal' }[tipo];
        
        try {
            const res = await apiFetch(`/relatorios/${url}?dataInicio=${ini}&dataFim=${fim}`);
            let html = `<div class="alert alert-success">Registros: ${res.dados.length}</div><button id="btn-exportar-csv" class="btn btn-secondary mb-3">CSV</button><div class="table-responsive"><table id="tabela-relatorio-dados" class="table table-sm table-bordered"><thead><tr><th>Nome</th><th>Valor</th></tr></thead><tbody>`;
            res.dados.forEach(d => html += `<tr><td>${d.nome_completo}</td><td>${d.valor_final || d.previsao_periodo || d.valor_desconto}</td></tr>`);
            html += `</tbody></table></div>`;
            div.innerHTML = html;
            document.getElementById('btn-exportar-csv').onclick = () => exportarTabelaParaCSV('tabela-relatorio-dados', `relatorio.csv`);
        } catch(e) { div.innerHTML = `<div class="alert alert-danger">${e.message}</div>`; }
    };

    function exportarTabelaParaCSV(id, nome) {
        const table = document.getElementById(id);
        let csv = [];
        for(let row of table.rows) {
            let cols = [];
            for(let cell of row.cells) cols.push(`"${cell.innerText}"`);
            csv.push(cols.join(","));
        }
        const blob = new Blob([csv.join("\n")], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = nome; a.click();
    }

    // CRM CONFIGS
    async function carregarOperadoras() { 
        const l = document.getElementById('lista-operadoras'); l.innerHTML='';
        const d = await apiFetch('/crm/operadoras/');
        d.forEach(o => l.innerHTML += `<tr><td>${o.nome}</td><td>${o.cnpj||''}</td><td>${o.status?'Ativo':'Inativo'}</td><td><button class="btn btn-warning btn-sm" onclick='editarOperadora(${JSON.stringify(o)})'><i class="bi bi-pencil"></i></button><button class="btn btn-danger btn-sm" onclick="deletarOperadora(${o.id})"><i class="bi bi-trash"></i></button></td></tr>`);
    }
    document.getElementById('form-operadora').onsubmit = async(e) => { e.preventDefault(); const id = document.getElementById('operadora_id').value; await apiFetch(id?`/crm/operadoras/${id}/`:'/crm/operadoras/', {method:id?'PUT':'POST', body:JSON.stringify({nome:document.getElementById('operadora_nome').value, cnpj:document.getElementById('operadora_cnpj').value, status: document.getElementById('operadora_status').value=='1'})}); document.getElementById('form-operadora').reset(); carregarOperadoras(); };
    window.editarOperadora = (o) => { document.getElementById('operadora_id').value=o.id; document.getElementById('operadora_nome').value=o.nome; document.getElementById('operadora_cnpj').value=o.cnpj; document.getElementById('operadora_status').value=o.status?'1':'0'; };
    window.deletarOperadora = async(id) => { if(confirm('Excluir?')) { await apiFetch(`/crm/operadoras/${id}/`,{method:'DELETE'}); carregarOperadoras(); }};

    async function carregarPlanos() { 
        const l = document.getElementById('lista-planos'); l.innerHTML='';
        const [plans, ops] = await Promise.all([apiFetch('/crm/planos/'), apiFetch('/crm/operadoras/')]);
        const sel = document.getElementById('plano_operadora_id'); sel.innerHTML='<option value="">Selecione</option>';
        ops.forEach(o => sel.add(new Option(o.nome, o.id)));
        plans.forEach(p => l.innerHTML += `<tr><td>${p.nome}</td><td>${p.operadora_nome}</td><td>${p.valor}</td><td>${p.comissao_base}</td><td><button class="btn btn-warning btn-sm" onclick='editarPlano(${JSON.stringify(p)})'><i class="bi bi-pencil"></i></button><button class="btn btn-danger btn-sm" onclick="deletarPlano(${p.id})"><i class="bi bi-trash"></i></button></td></tr>`);
    }
    document.getElementById('form-plano').onsubmit = async(e) => { e.preventDefault(); const id = document.getElementById('plano_id').value; await apiFetch(id?`/crm/planos/${id}/`:'/crm/planos/', {method:id?'PUT':'POST', body:JSON.stringify({nome:document.getElementById('plano_nome').value, valor: parseFloat(document.getElementById('plano_valor').value), comissao_base: parseFloat(document.getElementById('plano_comissao').value), operadora: document.getElementById('plano_operadora_id').value, beneficios: document.getElementById('plano_beneficios').value, status:true})}); document.getElementById('form-plano').reset(); carregarPlanos(); };
    window.editarPlano = (p) => { document.getElementById('plano_id').value=p.id; document.getElementById('plano_nome').value=p.nome; document.getElementById('plano_valor').value=p.valor; document.getElementById('plano_comissao').value=p.comissao_base; document.getElementById('plano_operadora_id').value=p.operadora; };
    window.deletarPlano = async(id) => { if(confirm('Excluir?')) { await apiFetch(`/crm/planos/${id}/`,{method:'DELETE'}); carregarPlanos(); }};

    async function carregarFormasPagamento() { const l=document.getElementById('lista-formas-pagamento'); l.innerHTML=''; (await apiFetch('/crm/formas-pagamento/')).forEach(f=>l.innerHTML+=`<li class="list-group-item d-flex justify-content-between"><span>${f.nome}</span><div><button class="btn btn-sm btn-warning me-1" onclick="editarFP(${f.id}, '${f.nome}')"><i class="bi bi-pencil"></i></button><button class="btn btn-sm btn-danger" onclick="delFP(${f.id})"><i class="bi bi-trash"></i></button></div></li>`); }
    document.getElementById('btn-salvar-forma-pagamento').onclick = async()=>{ await apiFetch('/crm/formas-pagamento/',{method:'POST', body:JSON.stringify({nome:document.getElementById('nova-forma-pagamento-nome').value, status:true})}); carregarFormasPagamento(); document.getElementById('nova-forma-pagamento-nome').value=''; };
    window.editarFP = async(id, old)=>{ const n=prompt('Nome:', old); if(n) { await apiFetch(`/crm/formas-pagamento/${id}/`,{method:'PUT', body:JSON.stringify({nome:n, status:true})}); carregarFormasPagamento(); }};
    window.delFP = async(id)=>{ if(confirm('Excluir?')) { await apiFetch(`/crm/formas-pagamento/${id}/`,{method:'DELETE'}); carregarFormasPagamento(); }};

    async function carregarStatus() { const l=document.getElementById('lista-status'); l.innerHTML=''; (await apiFetch('/crm/status/')).forEach(s=>l.innerHTML+=`<tr><td><span style="display:inline-block;width:10px;height:10px;background:${s.cor};border-radius:50%"></span> ${s.nome}</td><td>${s.tipo}</td><td>${s.estado||''}</td><td>${s.cor}</td><td><button class="btn btn-warning btn-sm" onclick='editStatus(${JSON.stringify(s)})'><i class="bi bi-pencil"></i></button><button class="btn btn-danger btn-sm" onclick="delStatus(${s.id})"><i class="bi bi-trash"></i></button></td></tr>`); }
    document.getElementById('form-status').onsubmit = async(e)=>{ e.preventDefault(); const id=document.getElementById('status_id').value; const b={nome:document.getElementById('status_nome').value, tipo:document.getElementById('status_tipo').value, estado:document.getElementById('status_estado').value, cor:document.getElementById('status_cor').value}; await apiFetch(id?`/crm/status/${id}/`:'/crm/status/',{method:id?'PUT':'POST', body:JSON.stringify(b)}); document.getElementById('form-status').reset(); carregarStatus(); };
    window.editStatus=(s)=>{ document.getElementById('status_id').value=s.id; document.getElementById('status_nome').value=s.nome; document.getElementById('status_tipo').value=s.tipo; document.getElementById('status_estado').value=s.estado; document.getElementById('status_cor').value=s.cor; };
    window.delStatus=async(id)=>{ if(confirm('Excluir?')) { await apiFetch(`/crm/status/${id}/`,{method:'DELETE'}); carregarStatus(); }};

    async function carregarMotivosPendencia() { const l=document.getElementById('lista-pendencias'); l.innerHTML=''; (await apiFetch('/crm/motivos-pendencia/')).forEach(p=>l.innerHTML+=`<tr><td>${p.nome}</td><td>${p.tipo_pendencia}</td><td><button class="btn btn-warning btn-sm" onclick='editPend(${JSON.stringify(p)})'><i class="bi bi-pencil"></i></button><button class="btn btn-danger btn-sm" onclick="delPend(${p.id})"><i class="bi bi-trash"></i></button></td></tr>`); }
    document.getElementById('form-pendencia').onsubmit = async(e)=>{ e.preventDefault(); const id=document.getElementById('pendencia_id').value; await apiFetch(id?`/crm/motivos-pendencia/${id}/`:'/crm/motivos-pendencia/',{method:id?'PUT':'POST', body:JSON.stringify({nome:document.getElementById('pendencia_nome').value, tipo_pendencia:document.getElementById('pendencia_tipo').value})}); document.getElementById('form-pendencia').reset(); carregarMotivosPendencia(); };
    window.editPend=(p)=>{ document.getElementById('pendencia_id').value=p.id; document.getElementById('pendencia_nome').value=p.nome; document.getElementById('pendencia_tipo').value=p.tipo_pendencia; };
    window.delPend=async(id)=>{ if(confirm('Excluir?')) { await apiFetch(`/crm/motivos-pendencia/${id}/`,{method:'DELETE'}); carregarMotivosPendencia(); }};

    async function carregarDadosParaRegrasComissao() { try { const [p, u] = await Promise.all([apiFetch('/crm/planos/'), apiFetch('/usuarios/?is_active=true')]); const sp=document.getElementById('regra_plano_id'); const sc=document.getElementById('regra_consultor_id'); sp.innerHTML=sc.innerHTML='<option value="">Selecione</option>'; p.forEach(x=>sp.add(new Option(x.nome, x.id))); u.forEach(x=>sc.add(new Option(x.nome_completo, x.id))); } catch(e){} }
    async function carregarRegrasComissao() { const l=document.getElementById('lista-regras-comissao'); l.innerHTML=''; (await apiFetch('/crm/regras-comissao/')).forEach(r=>l.innerHTML+=`<tr><td>${r.consultor_nome}</td><td>${r.plano_nome}</td><td>${r.tipo_venda}</td><td>${r.tipo_cliente}</td><td>${r.valor_base}</td><td>${r.valor_acelerado}</td><td><button class="btn btn-warning btn-sm" onclick='editRegra(${JSON.stringify(r)})'><i class="bi bi-pencil"></i></button><button class="btn btn-danger btn-sm" onclick="delRegra(${r.id})"><i class="bi bi-trash"></i></button></td></tr>`); }
    document.getElementById('form-regra-comissao').onsubmit = async(e)=>{ e.preventDefault(); const id=document.getElementById('regra_comissao_id').value; const b={consultor:document.getElementById('regra_consultor_id').value, plano:document.getElementById('regra_plano_id').value, tipo_venda:document.getElementById('regra_tipo_venda').value, tipo_cliente:document.getElementById('regra_tipo_cliente').value, valor_base:document.getElementById('regra_valor_base').value, valor_acelerado:document.getElementById('regra_valor_acelerado').value}; await apiFetch(id?`/crm/regras-comissao/${id}/`:'/crm/regras-comissao/',{method:id?'PUT':'POST', body:JSON.stringify(b)}); document.getElementById('form-regra-comissao').reset(); carregarRegrasComissao(); };
    window.editRegra=(r)=>{ document.getElementById('regra_comissao_id').value=r.id; document.getElementById('regra_consultor_id').value=r.consultor; document.getElementById('regra_plano_id').value=r.plano; document.getElementById('regra_tipo_venda').value=r.tipo_venda; document.getElementById('regra_tipo_cliente').value=r.tipo_cliente; document.getElementById('regra_valor_base').value=r.valor_base; document.getElementById('regra_valor_acelerado').value=r.valor_acelerado; };
    window.delRegra=async(id)=>{ if(confirm('Excluir?')) { await apiFetch(`/crm/regras-comissao/${id}/`,{method:'DELETE'}); carregarRegrasComissao(); }};

    async function carregarCampanhas() { const l=document.getElementById('lista-campanhas'); l.innerHTML=''; try{ (await apiFetch('/crm/campanhas/')).forEach(c=>l.innerHTML+=`<tr><td>${c.nome}</td><td>${c.data_inicio} a ${c.data_fim}</td><td>${c.status?'Ativa':'Inativa'}</td><td><button class="btn btn-sm btn-danger" onclick="delCamp(${c.id})"><i class="bi bi-trash"></i></button></td></tr>`); }catch(e){} }
    document.getElementById('form-campanha').onsubmit=async(e)=>{ e.preventDefault(); await apiFetch('/crm/campanhas/',{method:'POST',body:JSON.stringify({nome:document.getElementById('campanha_nome').value, data_inicio:document.getElementById('campanha_data_inicio').value, data_fim:document.getElementById('campanha_data_fim').value, regras:document.getElementById('campanha_regras').value})}); carregarCampanhas(); document.getElementById('form-campanha').reset(); };
    window.delCamp=async(id)=>{ await apiFetch(`/crm/campanhas/${id}/`,{method:'DELETE'}); carregarCampanhas(); };

    // Inicializa√ß√£o
    document.addEventListener('DOMContentLoaded', () => {
        carregarDadosParaFormulario();
        carregarPerfis();
        carregarMotivos();
        carregarFeriados();
        carregarOperadoras();
        carregarPlanos();
        carregarFormasPagamento();
        carregarStatus();
        carregarMotivosPendencia();
        carregarDadosParaRegrasComissao();
        carregarRegrasComissao();
        carregarCampanhas();
        
        const primeiroLink = document.querySelector('.admin-nav-link');
        if(primeiroLink) mostrarSecao(null, 'usuarios', primeiroLink);
    });
    </script>

</body>
</html>