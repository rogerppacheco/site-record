{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Governança - Record PAP</title>
    
    <link rel="icon" type="image/png" href="{% static 'logo.png' %}">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{% static 'css/custom_styles.css' %}?v=1.3">
    
    <style>
        /* Layout de Administração */
        body { overflow-x: hidden; background-color: var(--cor-fundo); }
        
        /* Header Fixo no Topo */
        .main-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            height: 80px;
        }

        .admin-wrapper { 
            display: flex; 
            min-height: 100vh; 
            padding-top: 80px; 
        }
        
        /* Sidebar Melhorada */
        .admin-sidebar {
            width: 280px; 
            background: #fff; 
            border-right: 1px solid var(--cor-borda);
            padding: 1.5rem; 
            display: flex; 
            flex-direction: column; 
            position: fixed; 
            top: 80px; 
            left: 0; 
            bottom: 0; 
            overflow-y: auto; 
            z-index: 900; 
            box-shadow: 2px 0 5px rgba(0,0,0,0.02);
        }

        .admin-sidebar::-webkit-scrollbar { width: 6px; }
        .admin-sidebar::-webkit-scrollbar-track { background: #f1f1f1; }
        .admin-sidebar::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
        .admin-sidebar::-webkit-scrollbar-thumb:hover { background: #bbb; }

        .admin-content {
            flex: 1; 
            margin-left: 280px; 
            padding: 2rem; 
            max-width: 1600px;
            width: calc(100% - 280px); 
        }

        .nav-section-title {
            font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px;
            color: var(--cor-texto-suave); margin-top: 1.5rem; margin-bottom: 0.5rem; font-weight: 700;
        }
        
        .admin-nav-link {
            display: flex; align-items: center; padding: 10px 15px;
            color: var(--cor-texto); text-decoration: none; border-radius: 8px;
            margin-bottom: 5px; font-weight: 500; transition: all 0.2s;
        }
        .admin-nav-link i { margin-right: 12px; font-size: 1.1rem; color: var(--cor-secundaria); }
        .admin-nav-link:hover { background-color: #f0f4ff; color: var(--cor-primaria); }
        .admin-nav-link:hover i { color: var(--cor-primaria); }
        .admin-nav-link.active { background-color: var(--cor-primaria); color: #fff; box-shadow: var(--sombra-suave); }
        .admin-nav-link.active i { color: #fff; }

        /* Estilo para links do submenu */
        .hover-link:hover { 
            color: var(--cor-primaria) !important; 
            background-color: #e9ecef; 
            border-radius: 4px; 
            padding-left: 10px !important; 
            transition: all 0.2s; 
        }

        .content-section { display: none; animation: fadeIn 0.3s ease-out; }
        .content-section.active { display: block; }

        .card { border: none; border-radius: 12px; box-shadow: var(--sombra-suave); margin-bottom: 1.5rem; }
        .card-header { background-color: #fff; border-bottom: 1px solid var(--cor-borda); padding: 1.5rem; border-radius: 12px 12px 0 0 !important; }
        .card-body { padding: 1.5rem; }
        .table-responsive { border-radius: 8px; }
        
        .perm-list { max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 6px; padding: 10px; background: #f8f9fa; }
        .perm-item { display: flex; align-items: center; padding: 6px 0; border-bottom: 1px solid #e9ecef; }
        .perm-item:last-child { border-bottom: none; }
        .perm-label { margin-left: 10px; font-size: 0.9rem; cursor: pointer; flex-grow: 1; user-select: none; }
        .badge-perm { font-weight: normal; font-size: 0.75rem; margin-right: 4px; margin-bottom: 4px; display: inline-block; }

        .btn-xs { padding: 0.25rem 0.5rem; font-size: 0.75rem; line-height: 1.5; border-radius: 0.2rem; }

        #iframe-calendario { width: 100%; height: 750px; border: none; display: block; }
        
        /* Estilos específicos para a nova tabela de faixas */
        .input-meta, .input-premio {
            border: 1px solid #ced4da !important;
            padding: 0.2rem 0.5rem !important;
        }

        @media (max-width: 992px) {
            .admin-sidebar { 
                transform: translateX(-100%); 
                transition: transform 0.3s;
                top: 80px; 
                height: calc(100vh - 80px);
            }
            .admin-sidebar.show { transform: translateX(0); }
            .admin-content { margin-left: 0; padding: 1rem; width: 100%; }
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <header class="main-header">
        <div class="header-container">
            <a href="/"><img src="{% static 'logo.png' %}" alt="Record PAP Logo" class="logo"></a>
            
            <button class="btn btn-light d-lg-none me-2" onclick="document.querySelector('.admin-sidebar').classList.toggle('show')">
                <i class="bi bi-list"></i>
            </button>

            <nav class="main-nav d-none d-lg-flex" id="main-nav">
                <ul>
                    <li><a href="/area-interna/">Voltar à Área Interna</a></li>
                    <li><span id="welcome-user" style="font-size: 0.9rem; color: #666; margin-right: 10px;"></span></li>
                    <li><button id="logoutButton" class="nav-button logout-button">Sair</button></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="admin-wrapper">
        <nav class="admin-sidebar">
            <div class="nav-section-title">Administração</div>
            <a href="#" class="admin-nav-link active" onclick="mostrarSecao(event, 'usuarios', this)">
                <i class="bi bi-people"></i> Gestão de Usuários
            </a>
            <a href="#" class="admin-nav-link" onclick="mostrarSecao(event, 'perfis', this)">
                <i class="bi bi-shield-lock"></i> Perfis de Acesso
            </a>

            <div class="nav-section-title">Configurações CRM</div>
            <a href="#" class="admin-nav-link" onclick="mostrarSecao(event, 'comissionamento', this)">
                <i class="bi bi-cash-stack"></i> Comissionamento
            </a>
            <a href="#" class="admin-nav-link" onclick="mostrarSecao(event, 'cadastros_gerais', this)">
                <i class="bi bi-sliders"></i> Cadastros Gerais
            </a>
            <a href="#" class="admin-nav-link" onclick="mostrarSecao(event, 'motivos', this)">
                <i class="bi bi-list-check"></i> Motivos de Ausência
            </a>
            <a href="#" class="admin-nav-link" onclick="mostrarSecao(event, 'feriados', this)">
                <i class="bi bi-calendar-event"></i> Feriados / Sazonalidade
            </a>

            <div class="nav-section-title">Financeiro</div>
            <a href="#" class="admin-nav-link" onclick="mostrarSecao(event, 'relatorios', this)">
                <i class="bi bi-file-earmark-bar-graph"></i> Relatórios
            </a>
            <a href="/painel-performance/" class="admin-nav-link">
                <i class="bi bi-speedometer2"></i> Painel de Performance
            </a>

            <div class="mt-auto pt-4 border-top">
                <div class="nav-section-title mt-0">Acesso Rápido</div>
                <a href="/presenca/" class="admin-nav-link"><i class="bi bi-clock-history"></i> Presença</a>
                <a href="/crm-vendas/" class="admin-nav-link"><i class="bi bi-cart-plus"></i> Nova Venda</a>
            </div>
        </nav>

        <main class="admin-content">
            
            <section id="usuarios-section" class="content-section active">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3>Gestão de Usuários</h3>
                    <button class="btn btn-confirmar" onclick="abrirModalUsuario()"><i class="bi bi-person-plus-fill"></i> Novo Usuário</button>
                </div>

                <div class="card mt-4">
                    <div class="card-header bg-white py-3">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                            <h5 class="mb-0">Lista de Usuários <span id="lista-status-titulo" class="badge bg-success">Ativos</span></h5>
                            
                            <div class="d-flex gap-2">
                                <input type="text" id="busca-usuario" class="form-control form-control-sm" placeholder="Pesquisar usuário..." style="width: 200px;">
                                
                                <div class="btn-group">
                                    <button onclick="mostrarListaUsuarios('ativos', this)" class="btn btn-sm btn-outline-primary active">Ativos</button>
                                    <button onclick="mostrarListaUsuarios('inativos', this)" class="btn btn-sm btn-outline-secondary">Inativos</button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="acoes-massa" class="mt-3 p-2 bg-light rounded border d-none align-items-center justify-content-between">
                            <span class="small fw-bold text-muted"><span id="count-selecionados">0</span> selecionados</span>
                            <div class="d-flex gap-2">
                                <select id="novo-perfil-massa" class="form-select form-select-sm" style="width: 200px;">
                                    <option value="">Alterar Perfil para...</option>
                                </select>
                                <button onclick="aplicarMudancaPerfilEmMassa()" class="btn btn-sm btn-primary">Aplicar</button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0" id="tabela-usuarios">
                                <thead class="table-light">
                                    <tr id="user-list-header">
                                        <th style="width: 40px;"><input type="checkbox" id="check-all" onclick="toggleTodos(this)"></th>
                                        <th>Nome</th>
                                        <th>E-mail</th>
                                        <th>Perfil</th>
                                        <th>Canal</th> <th>Líder</th>
                                        <th class="text-end">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="user-list-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <section id="perfis-section" class="content-section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3>Gestão de Perfis de Acesso</h3>
                    <button class="btn btn-confirmar" id="btn-adicionar-perfil"><i class="bi bi-plus-lg"></i> Novo Perfil</button>
                </div>
                
                <div class="alert alert-info py-2 small"><i class="bi bi-info-circle"></i> Defina aqui quais módulos cada cargo pode acessar.</div>

                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Nome do Perfil</th>
                                        <th>Permissões Habilitadas</th>
                                        <th class="text-center" style="width: 180px;">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="perfis-tabela-corpo"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="comissionamento-section" class="content-section">
                <h3 class="mb-4">Gestão de Comissionamento</h3>
                <div class="card">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs">
                            <li class="nav-item"><button class="nav-link active" onclick="openTab(event, 'regras_comissao_tab')">Regras de Comissão</button></li>
                            <li class="nav-item"><button class="nav-link" onclick="openTab(event, 'recebimento_operadora_tab')">Recebimento Operadora</button></li>
                            <li class="nav-item"><button class="nav-link" onclick="openTab(event, 'config_mensal_tab')">Configurações do Mês</button></li>
                            <li class="nav-item"><button class="nav-link" onclick="openTab(event, 'campanhas_tab')">Campanhas</button></li>
                            <li class="nav-item"><button class="nav-link" onclick="openTab(event, 'adiantamentos_descontos_tab')">Adiantamentos e Descontos</button></li>
                        </ul>
                    </div>
                    <div class="card-body">
                        
                        <div id="regras_comissao_tab" class="tab-content active">
                            <div class="bg-light p-4 rounded border mb-4">
                                <h5 class="text-primary mb-3">Nova Regra (Pagamento ao Vendedor)</h5>
                                <form id="form-regra-comissao">
                                    <input type="hidden" id="regra_comissao_id">
                                    <div class="row g-3">
                                        <div class="col-md-4"><label class="form-label fw-bold">Consultor</label><select id="regra_consultor_id" class="form-select" required></select></div>
                                        <div class="col-md-4"><label class="form-label fw-bold">Plano</label><select id="regra_plano_id" class="form-select" required></select></div>
                                        <div class="col-md-2"><label class="form-label fw-bold">Tipo Venda</label><select id="regra_tipo_venda" class="form-select" required><option value="PAP">PAP</option><option value="TELAG">TELAG</option></select></div>
                                        <div class="col-md-2"><label class="form-label fw-bold">Cliente</label><select id="regra_tipo_cliente" class="form-select" required><option value="CPF">CPF</option><option value="CNPJ">CNPJ</option></select></div>
                                        <div class="col-md-3"><label class="form-label fw-bold">Base (R$)</label><input type="number" class="form-control" id="regra_valor_base" step="0.01" required></div>
                                        <div class="col-md-3"><label class="form-label fw-bold">Acelerado (R$)</label><input type="number" class="form-control" id="regra_valor_acelerado" step="0.01" required></div>
                                        <div class="col-md-6 d-flex align-items-end">
                                            <button type="submit" class="btn btn-primary w-100 me-2">Salvar Regra</button>
                                            <button type="button" class="btn btn-outline-secondary w-50" onclick="resetFormRegraComissao()">Limpar</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center mb-3 mt-4">
                                <h5 class="mb-0">Regras Cadastradas</h5>
                                <div class="d-flex gap-2">
                                    <div class="input-group input-group-sm" style="width: 250px;">
                                        <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                                        <input type="text" id="filtro-regras" class="form-control" placeholder="Buscar regra..." onkeyup="filtrarRegras(this.value)">
                                    </div>
                                    <button class="btn btn-sm btn-outline-success" onclick="exportarRegras()" title="Baixar todas as regras"><i class="bi bi-file-earmark-excel"></i> Exportar</button>
                                    <button class="btn btn-sm btn-success" onclick="triggerImportRegras()" title="Importar regras via Excel"><i class="bi bi-cloud-upload"></i> Importar</button>
                                    <input type="file" id="input-import-regras" hidden accept=".xlsx, .xls" onchange="uploadRegras(this)">
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0"><thead class="table-light"><tr><th>Consultor</th><th>Plano</th><th>Tipo</th><th>Cliente</th><th>Base</th><th>Acelerado</th><th>Ações</th></tr></thead><tbody id="lista-regras-comissao"></tbody></table>
                            </div>
                        </div>

                        <div id="recebimento_operadora_tab" class="tab-content" style="display:none;">
                            <div class="bg-light p-4 rounded border mb-4">
                                <h5 class="text-success mb-3"><i class="bi bi-bank"></i> Configuração de Recebimento (Operadora -> Empresa)</h5>
                                <form id="form-comissao-operadora">
                                    <input type="hidden" id="co_id">
                                    <div class="row g-3 align-items-end">
                                        <div class="col-md-4">
                                            <label class="form-label fw-bold">Plano Vendido</label>
                                            <select id="co_plano_id" class="form-select" required></select>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label fw-bold">Comissão Base (R$)</label>
                                            <input type="number" class="form-control" id="co_valor_base" step="0.01" required placeholder="0,00">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label fw-bold text-success">Bônus Transição (R$)</label>
                                            <input type="number" class="form-control border-success" id="co_bonus" step="0.01" value="0" placeholder="0,00">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label small text-muted">Validade Bônus (Fim)</label>
                                            <input type="date" class="form-control" id="co_data_fim">
                                        </div>
                                        <div class="col-md-2">
                                            <button type="submit" class="btn btn-success w-100">Salvar Config</button>
                                        </div>
                                    </div>
                                </form>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Plano</th>
                                            <th>Recebimento Base</th>
                                            <th class="text-success">Bônus Transição</th>
                                            <th>Validade Bônus</th>
                                            <th class="fw-bold">Total Recebido</th>
                                            <th class="text-end">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lista-comissoes-operadora"></tbody>
                                </table>
                            </div>
                        </div>

                        <div id="config_mensal_tab" class="tab-content" style="display:none;">
                            <h5>Configurações Variáveis do Mês</h5>
                            <div class="d-flex align-items-center mb-4">
                                <label for="select_mes_config" class="form-label me-2 fw-bold">Mês de Referência:</label>
                                <input type="month" id="select_mes_config" class="form-control" style="width: auto;">
                            </div>
                            <div id="form-container-config-mensal"></div>
                        </div>

                        <div id="campanhas_tab" class="tab-content" style="display:none;">
                            <div class="bg-light p-4 rounded border mb-4">
                                <h5 class="text-primary mb-3"><i class="bi bi-cash-coin"></i> Nova Campanha (Financeira)</h5>
                                <form id="form-campanha">
                                    <input type="hidden" id="campanha_id">
                                    
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">Nome da Campanha</label>
                                            <input type="text" class="form-control" id="campanha_nome" required placeholder="Ex: Arrancada Fibra 1GB">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label fw-bold">Início</label>
                                            <input type="date" class="form-control" id="campanha_data_inicio" required>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label fw-bold">Fim</label>
                                            <input type="date" class="form-control" id="campanha_data_fim" required>
                                        </div>

                                        <div class="col-12 mt-2">
                                            <div class="card bg-white border p-3">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <label class="form-label fw-bold text-primary mb-0"><i class="bi bi-list-ol"></i> Faixas de Premiação (Escalonamento)</label>
                                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="adicionarFaixaCampanha()">
                                                        <i class="bi bi-plus-lg"></i> Adicionar Faixa
                                                    </button>
                                                </div>
                                                
                                                <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                                                    <table class="table table-sm table-bordered mb-0">
                                                        <thead class="table-light small">
                                                            <tr>
                                                                <th style="width: 40%;">Meta (Qtd Vendas)</th>
                                                                <th style="width: 40%;">Prêmio (R$)</th>
                                                                <th style="width: 20%;">Ação</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="tbody-faixas-campanha">
                                                            </tbody>
                                                    </table>
                                                </div>
                                                <div class="form-text small text-muted mt-1">
                                                    * O sistema pagará o prêmio da <strong>maior meta</strong> atingida pelo vendedor.
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 d-none">
                                            <label class="form-label fw-bold text-primary">Meta (Qtd Vendas)</label>
                                            <input type="number" class="form-control" id="campanha_meta_vendas" min="1">
                                        </div>
                                        <div class="col-md-3 d-none">
                                            <label class="form-label fw-bold text-success">Prêmio em Dinheiro (R$)</label>
                                            <input type="number" class="form-control" id="campanha_valor_premio" step="0.01" placeholder="0,00">
                                        </div>
                                        
                                        <div class="col-md-3">
                                            <label class="form-label fw-bold">Critério (O que conta?)</label>
                                            <select class="form-select" id="campanha_tipo_meta">
                                                <option value="LIQUIDA" selected>Vendas Instaladas (Líquida)</option>
                                                <option value="BRUTA">Vendas Abertas (Bruta)</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label fw-bold">Status</label>
                                            <select class="form-select" id="campanha_ativo">
                                                <option value="true">Ativa</option>
                                                <option value="false">Inativa</option>
                                            </select>
                                        </div>

                                        <div class="col-12">
                                            <div class="card p-3 border-warning bg-white">
                                                <h6 class="text-warning fw-bold mb-3"><i class="bi bi-filter-circle"></i> Regras de Elegibilidade (Segure Ctrl para selecionar vários)</h6>
                                                <div class="row g-3">
                                                    <div class="col-md-4">
                                                        <label class="form-label small fw-bold">1. Planos Válidos</label>
                                                        <select class="form-select" id="campanha_planos" multiple style="height: 120px;"></select>
                                                        <div class="form-text small">Deixe vazio para aceitar TODOS.</div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <label class="form-label small fw-bold">2. Formas de Pagamento Válidas</label>
                                                        <select class="form-select" id="campanha_pagamentos" multiple style="height: 120px;"></select>
                                                        <div class="form-text small">Deixe vazio para aceitar TODAS.</div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <label class="form-label small fw-bold">3. Canal Permitido</label>
                                                        <select class="form-select" id="campanha_canal_alvo">
                                                            <option value="TODOS">Todos os Canais</option>
                                                            <option value="PAP">Apenas PAP</option>
                                                            <option value="DIGITAL">Apenas Digital</option>
                                                            <option value="RECEPTIVO">Apenas Receptivo</option>
                                                            <option value="PARCEIRO">Apenas Parceiro</option>
                                                        </select>
                                                        <label class="form-label small fw-bold mt-2">Observações Extras</label>
                                                        <input type="text" class="form-control form-control-sm" id="campanha_regras" placeholder="Opcional">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-12 d-flex justify-content-end gap-2 pt-2">
                                            <button type="button" class="btn btn-outline-secondary" onclick="resetFormCampanha()">Cancelar</button>
                                            <button type="submit" class="btn btn-success px-4">Salvar Campanha</button>
                                        </div>
                                    </div>
                                </form>
                            </div>

                            <div class="card border-0 shadow-sm">
                                <div class="card-body p-0 table-responsive">
                                    <table class="table table-hover align-middle mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Nome</th>
                                                <th>Período</th>
                                                <th>Faixas de Premiação</th>
                                                <th>Regras</th>
                                                <th>Status</th>
                                                <th class="text-end">Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody id="lista-campanhas"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div id="adiantamentos_descontos_tab" class="tab-content" style="display:none;">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="card border-primary mb-3 shadow-sm">
                                        <div class="card-header bg-primary text-white py-2">
                                            <h6 class="mb-0"><i class="bi bi-cash-stack"></i> Novo Adiantamento</h6>
                                        </div>
                                        <div class="card-body">
                                            <form id="form-adiantamento">
                                                <div class="mb-2">
                                                    <label class="form-label small fw-bold">Colaborador</label>
                                                    <select id="ad_usuario" class="form-select form-select-sm" required></select>
                                                </div>
                                                <div class="mb-2">
                                                    <label class="form-label small fw-bold">Tipo</label>
                                                    <select id="ad_tipo" class="form-select form-select-sm" onchange="toggleCamposAdiantamento()">
                                                        <option value="ADIANTAMENTO_CNPJ">Adiantamento CNPJ</option>
                                                        <option value="ADIANTAMENTO_COMISSAO">Adiantamento de Comissão</option>
                                                    </select>
                                                </div>
                                                <div class="row g-2 mb-2">
                                                    <div class="col-6">
                                                        <label class="form-label small fw-bold">Data</label>
                                                        <input type="date" id="ad_data" class="form-control form-control-sm" required>
                                                    </div>
                                                    <div class="col-6">
                                                        <label class="form-label small fw-bold">Valor (R$)</label>
                                                        <input type="number" class="form-control form-control-sm" id="ad_valor" step="0.01" required>
                                                    </div>
                                                </div>
                                                
                                                <div id="box-qtd-vendas" class="mb-2 bg-light p-2 rounded border">
                                                    <label class="form-label small fw-bold text-primary">Qtd. Vendas Adiantadas</label>
                                                    <input type="number" id="ad_qtd" class="form-control form-control-sm">
                                                </div>

                                                <div class="mb-3">
                                                    <label class="form-label small fw-bold">Observação</label>
                                                    <textarea id="ad_obs" class="form-control form-control-sm" rows="2"></textarea>
                                                </div>
                                                <button type="submit" class="btn btn-primary btn-sm w-100">Registrar Adiantamento</button>
                                            </form>
                                        </div>
                                    </div>

                                    <div class="card border-danger shadow-sm">
                                        <div class="card-header bg-danger text-white py-2">
                                            <h6 class="mb-0"><i class="bi bi-dash-circle"></i> Novo Desconto</h6>
                                        </div>
                                        <div class="card-body">
                                            <form id="form-desconto">
                                                <div class="mb-2">
                                                    <label class="form-label small fw-bold">Colaborador</label>
                                                    <select id="desc_usuario" class="form-select form-select-sm" required></select>
                                                </div>
                                                <div class="mb-2">
                                                    <label class="form-label small fw-bold">Motivo do Desconto</label>
                                                    <input type="text" id="desc_motivo" class="form-control form-control-sm" placeholder="Ex: Equipamento perdido" required>
                                                </div>
                                                <div class="row g-2 mb-3">
                                                    <div class="col-6">
                                                        <label class="form-label small fw-bold">Data</label>
                                                        <input type="date" id="desc_data" class="form-control form-control-sm" required>
                                                    </div>
                                                    <div class="col-6">
                                                        <label class="form-label small fw-bold">Valor (R$)</label>
                                                        <input type="number" class="form-control form-control-sm" id="desc_valor" step="0.01" required>
                                                    </div>
                                                </div>
                                                <button type="submit" class="btn btn-danger btn-sm w-100">Registrar Desconto</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-8">
                                    <div class="card h-100 shadow-sm">
                                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0 fw-bold">Histórico de Lançamentos</h6>
                                            <div class="input-group input-group-sm" style="width: 200px;">
                                                <input type="month" id="filtro-mes-lancamentos" class="form-control" onchange="carregarLancamentosFinanceiros()">
                                            </div>
                                        </div>
                                        <div class="card-body p-0 table-responsive">
                                            <table class="table table-hover table-striped mb-0 small align-middle">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Data</th>
                                                        <th>Colaborador</th>
                                                        <th>Tipo / Descrição</th>
                                                        <th class="text-end">Valor</th>
                                                        <th class="text-end">Ações</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="lista-lancamentos-fin"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </section>

            <section id="cadastros_gerais-section" class="content-section">
                <h3 class="mb-4">Cadastros Gerais do CRM</h3>
                <div class="card">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs">
                            <li class="nav-item"><button class="nav-link active" onclick="openTab(event, 'operadoras')">Operadoras</button></li>
                            <li class="nav-item"><button class="nav-link" onclick="openTab(event, 'planos')">Planos</button></li>
                            <li class="nav-item"><button class="nav-link" onclick="openTab(event, 'formasPagamento')">Pagamentos</button></li>
                            <li class="nav-item"><button class="nav-link" onclick="openTab(event, 'status')">Status</button></li>
                            <li class="nav-item"><button class="nav-link" onclick="openTab(event, 'pendencias')">Pendências</button></li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div id="operadoras" class="tab-content active">
                            <form id="form-operadora" class="row g-3 mb-4 align-items-end bg-light p-3 rounded border">
                                <input type="hidden" id="operadora_id">
                                <div class="col-md-4"><label class="form-label fw-bold">Nome</label><input type="text" class="form-control" id="operadora_nome" required></div>
                                <div class="col-md-3"><label class="form-label fw-bold">CNPJ</label><input type="text" class="form-control" id="operadora_cnpj"></div>
                                <div class="col-md-3"><label class="form-label fw-bold">Status</label><select id="operadora_status" class="form-select" required><option value="1">Ativo</option><option value="0">Inativo</option></select></div>
                                <div class="col-md-2"><button type="submit" class="btn btn-primary w-100">Salvar</button></div>
                            </form>
                            <table class="table table-hover align-middle"><thead class="table-light"><tr><th>Nome</th><th>CNPJ</th><th>Status</th><th>Ações</th></tr></thead><tbody id="lista-operadoras"></tbody></table>
                        </div>
                        
                        <div id="planos" class="tab-content" style="display:none;">
                            <form id="form-plano" class="row g-3 mb-4 align-items-end bg-light p-3 rounded border">
                                <input type="hidden" id="plano_id">
                                <div class="col-md-3"><label class="form-label fw-bold">Nome</label><input type="text" class="form-control" id="plano_nome" required></div>
                                <div class="col-md-2"><label class="form-label fw-bold">Valor</label><input type="number" class="form-control" id="plano_valor" step="0.01" required></div>
                                <div class="col-md-2"><label class="form-label fw-bold">Comissão</label><input type="number" class="form-control" id="plano_comissao" step="0.01"></div>
                                <div class="col-md-3"><label class="form-label fw-bold">Operadora</label><select id="plano_operadora_id" class="form-select" required></select></div>
                                <div class="col-md-2"><button type="submit" class="btn btn-primary w-100">Salvar</button></div>
                                <input type="hidden" id="plano_beneficios">
                            </form>
                            <table class="table table-hover align-middle"><thead class="table-light"><tr><th>Nome</th><th>Operadora</th><th>Valor</th><th>Comissão</th><th>Ações</th></tr></thead><tbody id="lista-planos"></tbody></table>
                        </div>

                        <div id="formasPagamento" class="tab-content" style="display:none;">
                            <div class="input-group mb-3"><input type="text" id="nova-forma-pagamento-nome" placeholder="Nova Forma (Ex: PIX)" class="form-control"><button id="btn-salvar-forma-pagamento" class="btn btn-primary">Adicionar</button></div>
                            <ul id="lista-formas-pagamento" class="list-group"></ul>
                        </div>

                        <div id="status" class="tab-content" style="display:none;">
                            <form id="form-status" class="row g-3 mb-4 align-items-end bg-light p-3 rounded border">
                                <input type="hidden" id="status_id">
                                <div class="col-md-3"><label class="form-label fw-bold">Nome</label><input type="text" class="form-control" id="status_nome" required></div>
                                <div class="col-md-3"><label class="form-label fw-bold">Tipo</label><select id="status_tipo" class="form-select" required><option value="Tratamento">Tratamento</option><option value="Esteira">Esteira</option><option value="Comissionamento">Comissionamento</option></select></div>
                                <div class="col-md-3" id="status_estado_group"><label class="form-label fw-bold">Estado</label><input type="text" class="form-control" id="status_estado" placeholder="Ex: Fechado"></div>
                                <div class="col-md-1"><label class="form-label fw-bold">Cor</label><input type="color" class="form-control form-control-color w-100" id="status_cor" value="#FFFFFF"></div>
                                <div class="col-md-2"><button type="submit" class="btn btn-primary w-100">Salvar</button></div>
                            </form>
                            <table class="table table-hover align-middle"><thead class="table-light"><tr><th>Nome</th><th>Tipo</th><th>Estado</th><th>Cor</th><th>Ações</th></tr></thead><tbody id="lista-status"></tbody></table>
                        </div>

                        <div id="pendencias" class="tab-content" style="display:none;">
                            <form id="form-pendencia" class="row g-3 mb-4 align-items-end bg-light p-3 rounded border">
                                <input type="hidden" id="pendencia_id">
                                <div class="col-md-6"><label class="form-label fw-bold">Motivo</label><input type="text" class="form-control" id="pendencia_nome" required></div>
                                <div class="col-md-4"><label class="form-label fw-bold">Tipo</label><input type="text" class="form-control" id="pendencia_tipo" placeholder="Ex: Documentação" required></div>
                                <div class="col-md-2"><button type="submit" class="btn btn-primary w-100">Salvar</button></div>
                            </form>
                            <table class="table table-hover align-middle"><thead class="table-light"><tr><th>Nome</th><th>Tipo</th><th>Ações</th></tr></thead><tbody id="lista-pendencias"></tbody></table>
                        </div>
                    </div>
                </div>
            </section>

            <section id="motivos-section" class="content-section">
                <h3 class="mb-4">Gestão de Motivos de Ausência</h3>
                <div class="card">
                    <div class="card-body">
                        <div class="input-group mb-3">
                            <input type="text" id="novo-motivo-nome" placeholder="Nome do novo motivo" class="form-control">
                            <div class="input-group-text bg-light">
                                <input class="form-check-input mt-0" type="checkbox" id="novo-motivo-desconto" checked>
                                <label class="form-check-label ms-2" for="novo-motivo-desconto">Gera Desconto</label>
                            </div>
                            <button id="btn-salvar-motivo" class="btn btn-primary">Adicionar</button>
                        </div>
                        <ul id="lista-motivos" class="list-group"></ul>
                    </div>
                </div>
            </section>

            <section id="feriados-section" class="content-section">
                <h3 class="mb-4">Sazonalidade e Feriados</h3>
                <div class="card">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs">
                            <li class="nav-item">
                                <button class="nav-link active" onclick="openTab(event, 'tab-lista-feriados')">Lista de Feriados</button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" onclick="openTab(event, 'tab-calendario-fiscal')">Calendário de Pesos</button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div id="tab-lista-feriados" class="tab-content active">
                            <div class="input-group mb-4">
                                <input type="date" id="novo-feriado-data" class="form-control">
                                <input type="text" id="novo-feriado-descricao" placeholder="Descrição (Ex: Natal)" class="form-control">
                                <button id="btn-salvar-feriado" class="btn btn-primary">Adicionar</button>
                            </div>
                            <table class="table table-hover align-middle"><thead class="table-light"><tr><th>Data</th><th>Descrição</th><th>Ações</th></tr></thead><tbody id="lista-feriados"></tbody></table>
                        </div>

                        <div id="tab-calendario-fiscal" class="tab-content" style="display:none;">
                            <iframe src="/calendario/?modo=iframe" id="iframe-calendario"></iframe>
                        </div>
                    </div>
                </div>
            </section>

            <section id="relatorios-section" class="content-section">
                <h3 class="mb-4">Relatórios Gerenciais</h3>
                
                <div class="card">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" id="relatoriosTabs" role="tablist">
                            <li class="nav-item">
                                <button class="nav-link active" id="tab-rel-financeiro" data-bs-toggle="tab" data-bs-target="#content-rel-financeiro" type="button">
                                    <i class="bi bi-cash-coin"></i> Financeiro (Presença)
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link" id="tab-rel-campanhas" data-bs-toggle="tab" data-bs-target="#content-rel-campanhas" type="button" onclick="carregarOpcoesCampanhasRelatorio()">
                                    <i class="bi bi-trophy"></i> Resultado de Campanhas
                                </button>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="card-body">
                        <div class="tab-content">
                            
                            <div class="tab-pane fade show active" id="content-rel-financeiro">
                                <div class="card p-3 mb-4 bg-light border">
                                    <div class="row g-3 align-items-end">
                                        <div class="col-md-3">
                                            <label class="form-label fw-bold">Data Início</label>
                                            <input type="date" id="finDataInicio" class="form-control">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label fw-bold">Data Fim</label>
                                            <input type="date" id="finDataFim" class="form-control">
                                        </div>
                                        <div class="col-md-3">
                                            <button class="btn btn-primary w-100" onclick="carregarRelatorioFinanceiro()">
                                                <i class="bi bi-search"></i> Pesquisar
                                            </button>
                                        </div>
                                        <div class="col-md-3">
                                            <button class="btn btn-success w-100" onclick="baixarExcelFinanceiro()">
                                                <i class="bi bi-file-earmark-excel"></i> Baixar Excel
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="card mb-4" id="cardPrevisao" style="display:none;">
                                    <div class="card-header bg-info text-white">
                                        <h5 class="mb-0"><i class="bi bi-calendar-check"></i> Previsão (Cenário Ideal)</h5>
                                    </div>
                                    <div class="card-body p-0 table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light"><tr><th>Nome</th><th>Dias Úteis</th><th>Valor Diário</th><th>Valor Total Previsto</th></tr></thead>
                                            <tbody id="tbodyPrevisao"></tbody>
                                        </table>
                                    </div>
                                </div>

                                <div class="card mb-4" id="cardDescontos" style="display:none;">
                                    <div class="card-header bg-danger text-white">
                                        <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Descontos e Pagamento Final</h5>
                                    </div>
                                    <div class="card-body p-0 table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light"><tr><th>Nome</th><th>Dias Úteis</th><th>Qtd Faltas</th><th>Valor Diário</th><th>Valor Desconto</th><th>Total a Receber</th></tr></thead>
                                            <tbody id="tbodyDescontos"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="content-rel-campanhas">
                                <div class="row mb-4 align-items-end">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Selecione a Campanha:</label>
                                        <div class="input-group">
                                            <select class="form-select" id="select-rel-campanha" required>
                                                <option value="">Carregando campanhas...</option>
                                            </select>
                                            <button class="btn btn-primary" onclick="carregarResultadoCampanha()">
                                                <i class="bi bi-search"></i> Ver Resultado
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div id="resultado-campanha-container" style="display:none;">
                                    <div class="alert alert-info d-flex justify-content-between align-items-center mb-3">
                                        <div>
                                            <strong id="campanha-titulo-resumo">Nome da Campanha</strong><br>
                                            <span class="small" id="campanha-periodo-resumo">Período: 01/01 a 31/01</span> | 
                                            <span class="badge bg-light text-dark border" id="campanha-tipo-resumo">Tipo</span>
                                        </div>
                                        <div class="text-end">
                                            <h3 class="m-0 text-success fw-bold" id="campanha-total-premios">R$ 0,00</h3>
                                            <small class="text-muted">Total em Prêmios</small>
                                        </div>
                                    </div>

                                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-white rounded shadow-sm border">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="check-all-relatorio" onclick="toggleSelecaoRelatorio(this)">
                                            <label class="form-check-label small fw-bold" for="check-all-relatorio">SELECIONAR TODOS</label>
                                        </div>
                                        <div>
                                            <button class="btn btn-success btn-sm" onclick="enviarResultadoWhatsappSelecionados()">
                                                <i class="bi bi-whatsapp"></i> Enviar Resultado para <span id="count-wpp">0</span> Vendedores
                                            </button>
                                        </div>
                                    </div>
                                    <div class="table-responsive border rounded">
                                        <table class="table table-hover align-middle mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="width: 40px;">#</th> 
                                                    <th class="text-center" style="width: 50px;">Rank</th>
                                                    <th>Vendedor</th>
                                                    <th class="text-center">Vendas Válidas</th>
                                                    <th class="text-center">Meta</th>
                                                    <th>Progresso</th>
                                                    <th class="text-end">Prêmio (R$)</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tbody-resultado-campanha">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold" id="userModalTitle">Novo Usuário</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <ul class="nav nav-tabs nav-fill" id="userModalTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active fw-bold" id="dados-tab" data-bs-toggle="tab" data-bs-target="#dados-content" type="button" role="tab">
                                <i class="bi bi-person-vcard"></i> Dados Pessoais
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link fw-bold" id="financeiro-tab" data-bs-toggle="tab" data-bs-target="#financeiro-content" type="button" role="tab">
                                <i class="bi bi-cash-coin"></i> Financeiro
                            </button>
                        </li>
                    </ul>
                    
                    <form id="user-form">
                        <input type="hidden" id="user_id">
                        <div class="tab-content p-4">
                            <div class="tab-pane fade show active" id="dados-content" role="tabpanel">
                                <div class="row g-3">
                                    <div class="col-12"><label class="form-label fw-bold">Nome Completo</label><input type="text" class="form-control" id="nome_completo" required></div>
                                    <div class="col-md-6"><label class="form-label fw-bold">CPF</label><input type="text" class="form-control" id="cpf"></div>
                                    <div class="col-md-6"><label class="form-label fw-bold">E-mail</label><input type="email" class="form-control" id="email" required></div>
                                    
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">WhatsApp</label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-white text-muted" id="icon-whatsapp-status">
                                                <i class="bi bi-whatsapp"></i>
                                            </span>
                                            <input type="text" class="form-control" id="tel_whatsapp" placeholder="Ex: 31999999999" onblur="verificarWhatsAppRealTime(this)">
                                        </div>
                                        <div class="form-text small" id="msg-whatsapp-status">Digite apenas números com DDD.</div>
                                    </div>
                                    
                                    <div class="col-md-6"><label class="form-label fw-bold">Username (Login)</label><input type="text" class="form-control" id="usuario_login" required></div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Senha</label>
                                        <input type="password" class="form-control" id="senha" name="senha" placeholder="Deixe em branco para manter" autocomplete="new-password">
                                    </div>
                                    <div class="col-md-6"><label class="form-label fw-bold">Perfil de Acesso</label><select class="form-select" id="perfil_id" required></select></div>
                                    <div class="col-md-6"><label class="form-label fw-bold">Líder Imediato</label><select class="form-select" id="supervisor_id"><option value="">Nenhum</option></select></div>
                                    
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Canal de Venda</label>
                                        <select class="form-select" id="user_canal">
                                            <option value="PAP">PAP</option>
                                            <option value="DIGITAL">Digital</option>
                                            <option value="RECEPTIVO">Receptivo</option>
                                            <option value="PARCEIRO">Parceiro</option>
                                        </select>
                                    </div>

                                    <div class="col-12 mt-3 pt-3 border-top">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="participa_controle_presenca">
                                            <label class="form-check-label fw-bold" for="participa_controle_presenca">Participa do Controle de Presença?</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="financeiro-content" role="tabpanel">
                                <div class="row g-3">
                                    <div class="col-md-6"><label class="form-label small fw-bold">Meta de Vendas</label><input type="number" class="form-control" id="meta_comissao"></div>
                                    <div class="col-md-6"><label class="form-label small fw-bold">Chave PIX</label><input type="text" class="form-control" id="chave_pix"></div>
                                    <div class="col-md-6"><label class="form-label small fw-bold">Titular da Conta</label><input type="text" class="form-control" id="nome_da_conta"></div>
                                    <div class="col-md-3"><label class="form-label small">Almoço (R$)</label><input type="number" class="form-control" id="valor_almoco" step="0.01"></div>
                                    <div class="col-md-3"><label class="form-label small">Passagem (R$)</label><input type="number" class="form-control" id="valor_passagem" step="0.01"></div>
                                    
                                    <div class="col-12"><hr class="text-muted"> <h6 class="text-secondary small text-uppercase fw-bold">Descontos Configurados</h6></div>
                                    <div class="col-md-4"><label class="form-label small">Desc. Boleto</label><input type="number" class="form-control form-control-sm" id="desconto_boleto" step="0.01"></div>
                                    <div class="col-md-4"><label class="form-label small">Desc. Viabilidade</label><input type="number" class="form-control form-control-sm" id="desconto_inclusao_viabilidade" step="0.01"></div>
                                    <div class="col-md-4"><label class="form-label small">Desc. Antecipação</label><input type="number" class="form-control form-control-sm" id="desconto_instalacao_antecipada" step="0.01"></div>
                                    <div class="col-md-6"><label class="form-label small">Adiantamento CNPJ</label><input type="number" class="form-control form-control-sm" id="adiantamento_cnpj" step="0.01"></div>
                                    <div class="col-md-6"><label class="form-label small">Desc. INSS Fixo</label><input type="number" class="form-control form-control-sm" id="desconto_inss_fixo" step="0.01"></div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer bg-light">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary px-4">Salvar Usuário</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="perfilModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-perfil-titulo">Configurar Perfil</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="perfilForm">
                        <input type="hidden" id="modal_perfil_id">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Nome do Cargo / Perfil</label>
                            <input type="text" class="form-control" id="modal_perfil_nome" placeholder="Ex: Supervisor Regional" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold text-primary">Acessos e Permissões</label>
                            <p class="text-muted small mb-2">Marque as caixas abaixo para liberar o acesso às funcionalidades.</p>
                            
                            <div class="mb-2">
                                <input type="text" id="filtro-permissoes" class="form-control form-control-sm" placeholder="🔍 Buscar permissão...">
                            </div>

                            <div id="lista-permissoes" class="perm-list">
                                <div class="text-center text-muted py-3"><div class="spinner-border spinner-border-sm"></div> Carregando permissões...</div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarPerfil()">Salvar Alterações</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="excluirPerfilModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Confirmar Exclusão</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body"><p>Excluir o perfil "<strong id="nome-perfil-excluir"></strong>"?</p><p class="text-danger small">Ação irreversível.</p><input type="hidden" id="id-perfil-excluir"></div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn btn-danger" id="btn-confirmar-exclusao-perfil">Excluir</button></div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="modal-edicao-motivo" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Editar Motivo</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body"><form id="form-edicao-motivo"><input type="hidden" id="motivo-id-input"><div class="mb-3"><label class="form-label">Nome</label><input type="text" class="form-control" id="motivo-nome-input" required></div><div class="form-check"><input class="form-check-input" type="checkbox" id="motivo-desconto-input"><label class="form-check-label">Gera Desconto</label></div></form></div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" form="form-edicao-motivo" class="btn btn-primary">Salvar</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalFaltas" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title fs-6">Detalhe das Faltas</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-2 fw-bold" id="modalNomeColab"></p>
                    <ul id="listaFaltas" class="list-group list-group-flush small"></ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
    <script src="{% static 'js/auth.js' %}?v=1.5"></script>
    <script src="{% static 'js/menu.js' %}?v=1.5"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <script>
    const apiUrl = '';

    // --- FUNÇÃO AUXILIAR DE FORMATAÇÃO (Obrigatória) ---
    function fmtMoeda(valor) {
        if (valor === null || valor === undefined || valor === '') return 'R$ 0,00';
        return parseFloat(valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }
    
    // --- UI HELPERS ---
    function openTab(evt, tabName) {
        evt.preventDefault();
        const parent = evt.currentTarget.closest('.card');
        parent.querySelectorAll('.tab-content').forEach(t => { t.classList.remove("active"); t.style.display = "none"; });
        parent.querySelectorAll('.nav-link').forEach(l => l.classList.remove("active"));
        const target = document.getElementById(tabName);
        if(target){ target.style.display = "block"; target.classList.add("active"); }
        evt.currentTarget.classList.add("active");
    }

    function mostrarSecao(event, idSecao, menuItem) {
        if (event) event.preventDefault();
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
        const secaoAlvo = document.getElementById(`${idSecao}-section`);
        if (secaoAlvo) secaoAlvo.classList.add('active');
        document.querySelectorAll('.admin-nav-link').forEach(l => l.classList.remove('active'));
        if (menuItem) menuItem.classList.add('active');
    }

    // --- API FETCH CORRIGIDO (RESOLVE O ERRO 404 e PREFIXO /api) ---
    async function apiFetch(endpoint, options = {}) {
        const headers = { 'Content-Type': 'application/json', ...options.headers };
        const token = localStorage.getItem('accessToken');
        if (token) headers['Authorization'] = `Bearer ${token}`;

        try {
            let finalEndpoint = endpoint;
            if (!endpoint.startsWith('/api')) {
                const cleanEndpoint = endpoint.startsWith('/') ? endpoint : `/${endpoint}`;
                finalEndpoint = `/api${cleanEndpoint}`;
            }
            
            const fetchUrl = `${apiUrl}${finalEndpoint}`; 

            const response = await fetch(fetchUrl, { ...options, headers });

            if (options.isBlob) {
                if (!response.ok) throw new Error('Erro no download.');
                return await response.blob();
            }

            if (options.body instanceof FormData) delete headers['Content-Type'];

            let responseData = {};
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") !== -1) {
                try { responseData = await response.clone().json(); } catch (e) { }
            }
            if (response.status === 401) { alert('Sessão expirada.'); logout(); throw new Error('Não autorizado'); }
            if (!response.ok) {
                const errorData = responseData || await response.text();
                throw new Error(errorData.detail || errorData.error || (typeof errorData === 'string' ? errorData : JSON.stringify(errorData).replace(/["{}[\]]/g, ' ')));
            }
            if (response.status === 204) return null;
            return responseData;
        } catch (e) { throw e; }
    }
    
    // Helper para o Relatório Financeiro (GET simples)
    async function fetchDados(url, options = {}) {
        return apiFetch(url, options); 
    }

    function logout() { localStorage.removeItem('accessToken'); window.location.href = '/'; }

    // --- AUTH CHECK ---
    const token = localStorage.getItem('accessToken');
    if (!token) window.location.href = '/';
    const decodedToken = jwt_decode(token);
    const userProfile = decodedToken ? decodedToken.perfil : null;
    const isSuperuser = decodedToken ? decodedToken.is_superuser : false;
    
    if (decodedToken && decodedToken.username) { 
         const wel = document.getElementById('welcome-user');
         if(wel) wel.textContent = `Olá, ${decodedToken.username}`; 
    }

    if (!userProfile || !['Diretoria', 'Admin'].includes(userProfile) && !isSuperuser) {
        alert('Acesso negado.'); window.location.href = '/area-interna/';
    }

    const menuToggle = document.getElementById('menu-toggle');
    const mainNav = document.getElementById('main-nav');
    if(menuToggle && mainNav) menuToggle.addEventListener('click', () => mainNav.classList.toggle('active'));

    // ====================================================================
    // VARIÁVEIS GLOBAIS
    // ====================================================================
    const API_GRUPOS = '/grupos/';
    const API_PERMISSOES = '/permissoes/';
    let todosUsuariosCache = []; 
    let todasPermissoes = [];
    const perfilModal = new bootstrap.Modal(document.getElementById('perfilModal'));
    const excluirPerfilModal = new bootstrap.Modal(document.getElementById('excluirPerfilModal'));
    const userModal = new bootstrap.Modal(document.getElementById('userModal'));
    const userForm = document.getElementById('user-form');

    // ====================================================================
    // 1. GESTÃO DE PERFIS
    // ====================================================================
    async function carregarPerfis() {
        const tbody = document.getElementById('perfis-tabela-corpo');
        tbody.innerHTML = '<tr><td colspan="3" class="text-center py-3">Carregando...</td></tr>';
        try {
            const grupos = await apiFetch(API_GRUPOS);
            tbody.innerHTML = '';
            const selectMassa = document.getElementById('novo-perfil-massa');
            selectMassa.innerHTML = '<option value="">Alterar Perfil para...</option>';

            if(grupos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Nenhum perfil encontrado.</td></tr>';
                return;
            }

            grupos.forEach(grupo => {
                const badges = grupo.permissions_details.map(p => `<span class="badge bg-info text-dark badge-perm">${formatarNomePermissao(p.name)}</span>`).join('');
                selectMassa.add(new Option(grupo.name, grupo.id));
                tbody.innerHTML += `<tr><td class="fw-bold text-primary">${grupo.name}</td><td>${badges || '<span class="text-muted small fst-italic">Sem permissões especiais</span>'}</td><td class="text-end"><button class="btn btn-xs btn-outline-primary me-1" onclick='editarPerfil(${JSON.stringify(grupo)})' title="Editar"><i class="bi bi-pencil"></i></button><button class="btn btn-xs btn-outline-danger" onclick="confirmarExclusaoPerfil(${grupo.id}, '${grupo.name}')" title="Excluir"><i class="bi bi-trash"></i></button></td></tr>`;
            });
        } catch (e) { console.error(e); tbody.innerHTML = '<tr><td colspan="3" class="text-danger text-center">Erro ao carregar perfis.</td></tr>'; }
    }

    async function abrirModalPerfil(grupo = null) {
        document.getElementById('modal-perfil-titulo').textContent = grupo ? 'Editar Perfil' : 'Novo Perfil';
        document.getElementById('modal_perfil_id').value = grupo ? grupo.id : '';
        document.getElementById('modal_perfil_nome').value = grupo ? grupo.name : '';
        document.getElementById('filtro-permissoes').value = '';
        const container = document.getElementById('lista-permissoes');
        container.innerHTML = '<div class="text-center text-muted"><div class="spinner-border spinner-border-sm"></div> Carregando...</div>';
        perfilModal.show();
        if (todasPermissoes.length === 0) { try { const res = await apiFetch(API_PERMISSOES); todasPermissoes = res; } catch(e) { container.innerHTML = '<div class="text-danger small">Erro ao carregar lista.</div>'; return; } }
        renderizarListaPermissoes(grupo ? grupo.permissions : []);
    }
    
    function renderizarListaPermissoes(permsAtuais) {
        const container = document.getElementById('lista-permissoes');
        container.innerHTML = '';
        todasPermissoes.forEach(p => {
            const isChecked = permsAtuais.includes(p.id) ? 'checked' : '';
            const nomeAmigavel = formatarNomePermissao(p.name);
            container.innerHTML += `<div class="perm-item form-check"><input class="form-check-input" type="checkbox" value="${p.id}" id="perm-${p.id}" ${isChecked}><label class="form-check-label perm-label" for="perm-${p.id}"><strong>${nomeAmigavel}</strong> <span class="text-muted small ms-2">(${p.codename})</span></label></div>`;
        });
    }

    document.getElementById('filtro-permissoes').addEventListener('input', function(e) {
        const termo = e.target.value.toLowerCase();
        document.querySelectorAll('.perm-item').forEach(item => { item.style.display = item.innerText.toLowerCase().includes(termo) ? 'flex' : 'none'; });
    });

    window.editarPerfil = (grupo) => abrirModalPerfil(grupo);
    document.getElementById('btn-adicionar-perfil').onclick = () => abrirModalPerfil(null);

    async function salvarPerfil() {
        const id = document.getElementById('modal_perfil_id').value;
        const nome = document.getElementById('modal_perfil_nome').value;
        const checkboxes = document.querySelectorAll('#lista-permissoes input:checked');
        const perms = Array.from(checkboxes).map(el => parseInt(el.value));
        if (!nome) { alert('O nome do perfil é obrigatório.'); return; }
        const payload = { name: nome, permissions: perms };
        try {
            if (id) await apiFetch(`${API_GRUPOS}${id}/`, { method: 'PATCH', body: JSON.stringify(payload) });
            else await apiFetch(API_GRUPOS, { method: 'POST', body: JSON.stringify(payload) });
            perfilModal.hide(); carregarPerfis(); alert('Perfil salvo com sucesso!');
        } catch (e) { alert('Erro ao salvar perfil.'); }
    }

    window.confirmarExclusaoPerfil = (id, nome) => { document.getElementById('id-perfil-excluir').value = id; document.getElementById('nome-perfil-excluir').textContent = nome; excluirPerfilModal.show(); };
    document.getElementById('btn-confirmar-exclusao-perfil').onclick = async () => { const id = document.getElementById('id-perfil-excluir').value; try { await apiFetch(`${API_GRUPOS}${id}/`, { method: 'DELETE' }); excluirPerfilModal.hide(); carregarPerfis(); } catch(e){ alert(e.message); } };
    function formatarNomePermissao(nome) { return nome.replace('Can view', 'Visualizar').replace('Can add', 'Adicionar').replace('Can change', 'Editar').replace('Can delete', 'Excluir').replace('Pode visualizar', 'Acesso a').replace('venda', 'Venda').replace('comissao', 'Comissão'); }

    // ====================================================================
    // 2. GESTÃO DE USUÁRIOS
    // ====================================================================
    function mostrarListaUsuarios(status, btn) {
        document.getElementById('lista-status-titulo').textContent = status === 'ativos' ? 'Ativos' : 'Inativos';
        document.getElementById('lista-status-titulo').className = status === 'ativos' ? 'badge bg-success' : 'badge bg-secondary';
        if(btn) { btn.parentElement.querySelectorAll('.btn').forEach(b => b.classList.remove('active', 'btn-outline-primary', 'btn-outline-secondary')); btn.classList.add('active', 'btn-outline-primary'); }
        carregarUsuarios(status);
    }

    // --- FUNÇÃO DEBUGADA ---
    async function carregarUsuarios(status = 'ativos') { 
        try { 
            const endpoint = `/usuarios/?is_active=${status === 'ativos'}`;
            const resposta = await apiFetch(endpoint); 
            
            let usuarios = [];
            
            if (Array.isArray(resposta)) {
                usuarios = resposta;
            } else if (resposta && resposta.results) {
                usuarios = resposta.results; 
            } 
            
            todosUsuariosCache = usuarios || []; 
            renderizarTabelaUsuarios(todosUsuariosCache, status);
            
        } catch (e) { 
            console.error("❌ ERRO NO CARREGAMENTO:", e);
            const userListBody = document.getElementById('user-list-body');
            if(userListBody) {
                userListBody.innerHTML = `<tr><td colspan="7" class="text-center text-danger p-4"><strong>Erro ao carregar dados:</strong> <br> ${e.message}</td></tr>`;
            }
        }
    }

    function renderizarTabelaUsuarios(lista, status) {
        const userListBody = document.getElementById('user-list-body'); 
        userListBody.innerHTML = '';
        const isAtivos = status === 'ativos';
        const headerRow = document.getElementById('user-list-header');
        
        headerRow.innerHTML = isAtivos 
            ? `<th style="width: 40px;"><input type="checkbox" id="check-all" onclick="toggleTodos(this)"></th><th>Nome</th><th>E-mail</th><th>Perfil</th><th>Canal</th><th>Líder</th><th class="text-end">Ações</th>` 
            : `<th>Nome</th><th>E-mail</th><th>Perfil</th><th>Canal</th><th class="text-end">Ações</th>`;
        
        if (!lista || lista.length === 0) { 
            userListBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Nenhum usuário encontrado.</td></tr>'; 
            return; 
        }

        lista.forEach(user => {
            let perfilDisplay = '<span class="badge bg-secondary">Sem Perfil</span>';
            if (user.groups && user.groups.length > 0) perfilDisplay = `<span class="badge bg-success">${user.groups[0].name}</span>`;
            else if (user.perfil_nome) perfilDisplay = `<span class="badge bg-warning text-dark">${user.perfil_nome} (Legado)</span>`;
            
            const checkHtml = isAtivos ? `<td><input type="checkbox" class="user-check" value="${user.id}" onclick="atualizarContador()"></td>` : '';
            const liderHtml = isAtivos ? `<td>${user.supervisor_nome || '-'}</td>` : '';
            const canalHtml = `<td>${user.canal || '-'}</td>`;
            
            const acoes = isAtivos 
                ? `<button class="btn btn-xs btn-outline-warning me-1" onclick="editarUsuarioPeloId(${user.id})" title="Editar"><i class="bi bi-pencil"></i></button><button class="btn btn-xs btn-outline-danger" onclick="inativarUsuario(${user.id})" title="Inativar"><i class="bi bi-trash"></i></button>` 
                : `<button class="btn btn-xs btn-outline-success" onclick="reativarUsuario(${user.id})" title="Reativar"><i class="bi bi-check-circle"></i></button>`;
            
            userListBody.innerHTML += `<tr>${checkHtml}<td>${user.nome_completo}</td><td>${user.email}</td><td>${perfilDisplay}</td>${canalHtml}${liderHtml}<td class="text-end">${acoes}</td></tr>`;
        });
        
        atualizarContador();
    }

    // Função auxiliar para buscar o usuário no cache pelo ID
    function editarUsuarioPeloId(id) {
        const user = todosUsuariosCache.find(u => u.id === id);
        if (user) {
            abrirModalUsuario(user);
        }
    }

    document.getElementById('busca-usuario').addEventListener('input', (e) => { const termo = e.target.value.toLowerCase(); const filtrados = todosUsuariosCache.filter(u => u.nome_completo.toLowerCase().includes(termo) || u.email.toLowerCase().includes(termo) || u.username.toLowerCase().includes(termo)); const statusAtual = document.getElementById('lista-status-titulo').textContent === 'Ativos' ? 'ativos' : 'inativos'; renderizarTabelaUsuarios(filtrados, statusAtual); });
    window.toggleTodos = (source) => { document.querySelectorAll('.user-check').forEach(c => c.checked = source.checked); atualizarContador(); }
    window.atualizarContador = () => { const count = document.querySelectorAll('.user-check:checked').length; document.getElementById('count-selecionados').textContent = count; const barraAcoes = document.getElementById('acoes-massa'); if (count > 0) { barraAcoes.classList.remove('d-none'); barraAcoes.classList.add('d-flex'); } else { barraAcoes.classList.add('d-none'); barraAcoes.classList.remove('d-flex'); } }
    window.aplicarMudancaPerfilEmMassa = async () => { const novoPerfilId = document.getElementById('novo-perfil-massa').value; if (!novoPerfilId) return alert('Selecione um perfil para aplicar.'); const checkboxes = document.querySelectorAll('.user-check:checked'); if (checkboxes.length === 0) return; if (!confirm(`Deseja alterar o perfil de ${checkboxes.length} usuários?`)) return; const ids = Array.from(checkboxes).map(c => c.value); let sucessos = 0; for (const userId of ids) { try { await apiFetch(`/usuarios/${userId}/`, { method: 'PATCH', body: JSON.stringify({ groups: [parseInt(novoPerfilId)] }) }); sucessos++; } catch (e) { console.error(e); } } alert(`${sucessos} atualizados.`); carregarUsuarios('ativos'); document.getElementById('check-all').checked = false; }

    async function abrirModalUsuario(user = null) {
        document.getElementById('user-form').reset();
        new bootstrap.Tab(document.getElementById('dados-tab')).show(); 
        const userIdInput = document.getElementById('user_id');
        userIdInput.value = user ? user.id : '';
        document.getElementById('userModalTitle').textContent = user ? 'Editar Usuário' : 'Novo Usuário';
        document.getElementById('senha').required = !user; 
        await carregarDadosParaFormulario();

        if (user) {
            document.getElementById('nome_completo').value = user.nome_completo || '';
            document.getElementById('cpf').value = user.cpf || '';
            document.getElementById('email').value = user.email || '';
            document.getElementById('tel_whatsapp').value = user.tel_whatsapp || '';
            document.getElementById('usuario_login').value = user.username || '';
            if (user.groups && user.groups.length > 0) document.getElementById('perfil_id').value = user.groups[0].id;
            else if (user.perfil) document.getElementById('perfil_id').value = user.perfil;
            document.getElementById('supervisor_id').value = user.supervisor || '';
            document.getElementById('user_canal').value = user.canal || 'PAP';
            document.getElementById('participa_controle_presenca').checked = user.participa_controle_presenca;
            ['valor_almoco', 'valor_passagem', 'chave_pix', 'nome_da_conta', 'meta_comissao', 'desconto_boleto', 'desconto_inclusao_viabilidade', 'desconto_instalacao_antecipada', 'adiantamento_cnpj', 'desconto_inss_fixo'].forEach(id => { document.getElementById(id).value = user[id] || ''; });
        }
        userModal.show();
    }

    async function carregarDadosParaFormulario() {
        const pSelect = document.getElementById('perfil_id');
        const sSelect = document.getElementById('supervisor_id');
        pSelect.innerHTML = ''; sSelect.innerHTML = '<option value="">Nenhum</option>';
        try {
            const [grupos, usuarios] = await Promise.all([ apiFetch(API_GRUPOS), apiFetch('/usuarios/?is_active=true') ]);
            grupos.forEach(g => pSelect.add(new Option(g.name, g.id)));
            usuarios.forEach(u => sSelect.add(new Option(u.nome_completo, u.id)));
        } catch (e) {}
    }

    userForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const id = document.getElementById('user_id').value;
        const url = id ? `/usuarios/${id}/` : '/usuarios/';
        const method = id ? 'PUT' : 'POST';
        const nomeCompleto = document.getElementById('nome_completo').value.trim();
        const parts = nomeCompleto.split(' ');
        const body = {
            first_name: parts.shift(), last_name: parts.join(' '),
            cpf: document.getElementById('cpf').value,
            email: document.getElementById('email').value,
            tel_whatsapp: document.getElementById('tel_whatsapp').value,
            username: document.getElementById('usuario_login').value,
            supervisor: document.getElementById('supervisor_id').value || null,
            canal: document.getElementById('user_canal').value, // CAMPO CANAL
            groups: document.getElementById('perfil_id').value ? [parseInt(document.getElementById('perfil_id').value)] : [],
            valor_almoco: document.getElementById('valor_almoco').value,
            valor_passagem: document.getElementById('valor_passagem').value,
            chave_pix: document.getElementById('chave_pix').value,
            nome_da_conta: document.getElementById('nome_da_conta').value,
            meta_comissao: document.getElementById('meta_comissao').value,
            desconto_boleto: document.getElementById('desconto_boleto').value,
            desconto_inclusao_viabilidade: document.getElementById('desconto_inclusao_viabilidade').value,
            desconto_instalacao_antecipada: document.getElementById('desconto_instalacao_antecipada').value,
            adiantamento_cnpj: document.getElementById('adiantamento_cnpj').value,
            desconto_inss_fixo: document.getElementById('desconto_inss_fixo').value,
            participa_controle_presenca: document.getElementById('participa_controle_presenca').checked
        };
        if (document.getElementById('senha').value) body.password = document.getElementById('senha').value;
        try { await apiFetch(url, { method, body: JSON.stringify(body) }); alert('Salvo!'); userModal.hide(); mostrarListaUsuarios('ativos', null); } catch (e) { alert(`Erro: ${e.message}`); }
    });

    async function inativarUsuario(id) { if(confirm('Inativar?')) { await apiFetch(`/usuarios/${id}/`, { method: 'DELETE' }); mostrarListaUsuarios('ativos'); } }
    async function reativarUsuario(id) { if(confirm('Reativar?')) { await apiFetch(`/usuarios/${id}/reativar/`, { method: 'PUT' }); mostrarListaUsuarios('inativos'); } }

    // ====================================================================
    // 3. CADASTROS GERAIS CRM
    // ====================================================================
    
    // --- OPERADORAS ---
    async function carregarOperadoras() {
        const lista = await apiFetch('/crm/operadoras/');
        const tbody = document.getElementById('lista-operadoras');
        tbody.innerHTML = '';
        lista.forEach(o => {
            const st = o.ativo ? '<span class="badge bg-success">Ativo</span>' : '<span class="badge bg-danger">Inativo</span>';
            tbody.innerHTML += `
                <tr>
                    <td>${o.nome}</td><td>${o.cnpj || '-'}</td><td>${st}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-warning" onclick='editarOperadora(${JSON.stringify(o)})'><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="excluirOperadora(${o.id})"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>`;
        });
        // Atualiza select em planos
        const selPlanos = document.getElementById('plano_operadora_id');
        if(selPlanos) {
            selPlanos.innerHTML = '<option value="">Selecione...</option>';
            lista.filter(x=>x.ativo).forEach(o => selPlanos.add(new Option(o.nome, o.id)));
        }
    }
    
    document.getElementById('form-operadora').onsubmit = async(e) => {
        e.preventDefault();
        const id = document.getElementById('operadora_id').value;
        const body = {
            nome: document.getElementById('operadora_nome').value,
            cnpj: document.getElementById('operadora_cnpj').value,
            ativo: document.getElementById('operadora_status').value == '1'
        };
        try {
            if(id) await apiFetch(`/crm/operadoras/${id}/`, {method:'PUT', body: JSON.stringify(body)});
            else await apiFetch('/crm/operadoras/', {method:'POST', body: JSON.stringify(body)});
            document.getElementById('form-operadora').reset(); document.getElementById('operadora_id').value='';
            carregarOperadoras();
        } catch(e){ alert(e.message); }
    };
    window.editarOperadora = (o) => { document.getElementById('operadora_id').value=o.id; document.getElementById('operadora_nome').value=o.nome; document.getElementById('operadora_cnpj').value=o.cnpj; document.getElementById('operadora_status').value = o.ativo ? '1' : '0'; };
    window.excluirOperadora = async (id) => { if(confirm('Excluir?')) { await apiFetch(`/crm/operadoras/${id}/`, {method:'DELETE'}); carregarOperadoras(); } };

    // --- PLANOS ---
    async function carregarPlanos() {
        const lista = await apiFetch('/crm/planos/');
        const tbody = document.getElementById('lista-planos');
        tbody.innerHTML = '';
        lista.forEach(p => {
            // CORREÇÃO: Tratamento para comissão indefinida
            const comissao = p.comissao !== undefined ? fmtMoeda(p.comissao) : 'R$ 0,00';
            
            tbody.innerHTML += `<tr><td>${p.nome}</td><td>${p.operadora_nome || '-'}</td><td>${fmtMoeda(p.valor)}</td><td>${comissao}</td><td><button class="btn btn-sm btn-outline-warning" onclick='editarPlano(${JSON.stringify(p)})'><i class="bi bi-pencil"></i></button><button class="btn btn-sm btn-outline-danger" onclick="excluirPlano(${p.id})"><i class="bi bi-trash"></i></button></td></tr>`;
        });
    }
    document.getElementById('form-plano').onsubmit = async(e) => {
        e.preventDefault();
        const id = document.getElementById('plano_id').value;
        const body = {
            nome: document.getElementById('plano_nome').value,
            valor: document.getElementById('plano_valor').value,
            comissao: document.getElementById('plano_comissao').value,
            operadora: document.getElementById('plano_operadora_id').value,
            ativo: true
        };
        try {
            if(id) await apiFetch(`/crm/planos/${id}/`, {method:'PUT', body: JSON.stringify(body)});
            else await apiFetch('/crm/planos/', {method:'POST', body: JSON.stringify(body)});
            document.getElementById('form-plano').reset(); document.getElementById('plano_id').value='';
            carregarPlanos();
        } catch(e){ alert(e.message); }
    };
    window.editarPlano = (p) => { 
        document.getElementById('plano_id').value = p.id; 
        document.getElementById('plano_nome').value = p.nome;
        document.getElementById('plano_valor').value = p.valor;
        document.getElementById('plano_comissao').value = p.comissao;
        document.getElementById('plano_operadora_id').value = p.operadora;
    };
    window.excluirPlano = async (id) => { if(confirm('Excluir?')) { await apiFetch(`/crm/planos/${id}/`, {method:'DELETE'}); carregarPlanos(); } };

    // --- FORMAS PAGAMENTO ---
    async function carregarFormasPagamento() {
        const lista = await apiFetch('/crm/formas-pagamento/');
        const ul = document.getElementById('lista-formas-pagamento');
        ul.innerHTML = '';
        lista.forEach(f => {
            ul.innerHTML += `<li class="list-group-item d-flex justify-content-between">${f.nome} <button class="btn btn-sm btn-danger" onclick="excluirFormaPagamento(${f.id})"><i class="bi bi-trash"></i></button></li>`;
        });
    }
    document.getElementById('btn-salvar-forma-pagamento').onclick = async () => {
        const nome = document.getElementById('nova-forma-pagamento-nome').value;
        if(!nome) return;
        await apiFetch('/crm/formas-pagamento/', {method:'POST', body:JSON.stringify({nome, ativo:true})});
        document.getElementById('nova-forma-pagamento-nome').value='';
        carregarFormasPagamento();
    };
    window.excluirFormaPagamento = async(id)=>{ if(confirm('Excluir?')) { await apiFetch(`/crm/formas-pagamento/${id}/`, {method:'DELETE'}); carregarFormasPagamento(); } };

    // --- STATUS ---
    async function carregarStatus() {
        const lista = await apiFetch('/crm/status/');
        const tbody = document.getElementById('lista-status');
        tbody.innerHTML = '';
        lista.forEach(s => {
            tbody.innerHTML += `<tr><td>${s.nome}</td><td>${s.tipo}</td><td>${s.estado||'-'}</td><td><span class="badge" style="background:${s.cor};color:#000">${s.cor}</span></td><td><button class="btn btn-sm btn-danger" onclick="excluirStatus(${s.id})"><i class="bi bi-trash"></i></button></td></tr>`;
        });
    }
    document.getElementById('form-status').onsubmit = async(e) => {
        e.preventDefault();
        const body = {
            nome: document.getElementById('status_nome').value,
            tipo: document.getElementById('status_tipo').value,
            estado: document.getElementById('status_estado').value,
            cor: document.getElementById('status_cor').value
        };
        await apiFetch('/crm/status/', {method:'POST', body: JSON.stringify(body)});
        document.getElementById('form-status').reset();
        carregarStatus();
    };
    window.excluirStatus = async(id)=>{ if(confirm('Excluir?')) { await apiFetch(`/crm/status/${id}/`, {method:'DELETE'}); carregarStatus(); } };

    // --- PENDÊNCIAS ---
    async function carregarMotivosPendencia() {
        const lista = await apiFetch('/crm/motivos-pendencia/');
        const tbody = document.getElementById('lista-pendencias');
        tbody.innerHTML = '';
        lista.forEach(p => {
            tbody.innerHTML += `<tr><td>${p.nome}</td><td>${p.tipo_pendencia}</td><td><button class="btn btn-sm btn-danger" onclick="excluirPendencia(${p.id})"><i class="bi bi-trash"></i></button></td></tr>`;
        });
    }
    document.getElementById('form-pendencia').onsubmit = async(e) => {
        e.preventDefault();
        const body = {
            nome: document.getElementById('pendencia_nome').value,
            tipo_pendencia: document.getElementById('pendencia_tipo').value
        };
        await apiFetch('/crm/motivos-pendencia/', {method:'POST', body: JSON.stringify(body)});
        document.getElementById('form-pendencia').reset();
        carregarMotivosPendencia();
    };
    window.excluirPendencia = async(id)=>{ if(confirm('Excluir?')) { await apiFetch(`/crm/motivos-pendencia/${id}/`, {method:'DELETE'}); carregarMotivosPendencia(); } };

    // --- REGRAS COMISSÃO ---
    async function carregarDadosParaRegrasComissao() {
        const [planos, users] = await Promise.all([apiFetch('/crm/planos/'), apiFetch('/usuarios/?is_active=true')]);
        const selPlanos = document.getElementById('regra_plano_id');
        const selUsers = document.getElementById('regra_consultor_id');
        selPlanos.innerHTML = '<option value="">Selecione...</option>';
        selUsers.innerHTML = '<option value="">Todos</option>';
        planos.forEach(p => selPlanos.add(new Option(p.nome, p.id)));
        users.forEach(u => selUsers.add(new Option(u.nome_completo, u.id)));
    }
    async function carregarRegrasComissao() {
        const lista = await apiFetch('/crm/regras-comissao/');
        const tbody = document.getElementById('lista-regras-comissao');
        tbody.innerHTML = '';
        lista.forEach(r => {
            tbody.innerHTML += `<tr>
                <td>${r.consultor_nome||'TODOS'}</td>
                <td>${r.plano_nome}</td>
                <td>${r.tipo_venda}</td>
                <td>${r.tipo_cliente}</td>
                <td>${r.valor_base}</td>
                <td>${r.valor_acelerado}</td>
                <td>
                    <button class="btn btn-sm btn-warning me-1" onclick='editarRegra(${JSON.stringify(r)})'><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-sm btn-danger" onclick="excluirRegra(${r.id})"><i class="bi bi-trash"></i></button>
                </td>
            </tr>`;
        });
    }
    document.getElementById('form-regra-comissao').onsubmit = async(e) => {
        e.preventDefault();
        const id = document.getElementById('regra_comissao_id').value;
        const body = {
            consultor: document.getElementById('regra_consultor_id').value || null,
            plano: document.getElementById('regra_plano_id').value,
            tipo_venda: document.getElementById('regra_tipo_venda').value,
            tipo_cliente: document.getElementById('regra_tipo_cliente').value,
            valor_base: document.getElementById('regra_valor_base').value,
            valor_acelerado: document.getElementById('regra_valor_acelerado').value
        };
        
        if (id) {
            await apiFetch(`/crm/regras-comissao/${id}/`, {method:'PUT', body: JSON.stringify(body)});
        } else {
            await apiFetch('/crm/regras-comissao/', {method:'POST', body: JSON.stringify(body)});
        }
        
        carregarRegrasComissao();
        resetFormRegraComissao();
    };

    function resetFormRegraComissao() { 
        document.getElementById('form-regra-comissao').reset(); 
        document.getElementById('regra_comissao_id').value = '';
    }

    window.editarRegra = (r) => {
        document.getElementById('regra_comissao_id').value = r.id;
        document.getElementById('regra_consultor_id').value = r.consultor || "";
        document.getElementById('regra_plano_id').value = r.plano;
        document.getElementById('regra_tipo_venda').value = r.tipo_venda;
        document.getElementById('regra_tipo_cliente').value = r.tipo_cliente;
        document.getElementById('regra_valor_base').value = r.valor_base;
        document.getElementById('regra_valor_acelerado').value = r.valor_acelerado;
        document.getElementById('form-regra-comissao').scrollIntoView({ behavior: 'smooth' });
    };

    window.excluirRegra = async(id) => { if(confirm('Excluir?')) { await apiFetch(`/crm/regras-comissao/${id}/`, {method:'DELETE'}); carregarRegrasComissao(); } };

    // ====================================================================
    // GESTÃO DE CAMPANHAS (ATUALIZADO COM FAIXAS)
    // ====================================================================
    
    // 1. Função para adicionar linha na tabela visual
    function adicionarFaixaCampanha(meta = '', valor = '') {
        const tbody = document.getElementById('tbody-faixas-campanha');
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>
                <input type="number" class="form-control form-control-sm input-meta" 
                       value="${meta}" placeholder="Ex: 15" required min="1">
            </td>
            <td>
                <input type="number" class="form-control form-control-sm input-premio" 
                       value="${valor}" placeholder="Ex: 150.00" required step="0.01">
            </td>
            <td class="text-center">
                <button type="button" class="btn btn-xs btn-outline-danger" onclick="this.closest('tr').remove()">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    }
    
    // Carrega Planos e Pagamentos nos selects múltiplos
    async function carregarDadosAuxiliaresCampanha() {
        try {
            const [planos, pagamentos] = await Promise.all([
                apiFetch('/crm/planos/'),
                apiFetch('/crm/formas-pagamento/')
            ]);

            const selPlanos = document.getElementById('campanha_planos');
            const selPags = document.getElementById('campanha_pagamentos');

            selPlanos.innerHTML = '';
            selPags.innerHTML = '';

            planos.filter(p => p.ativo).forEach(p => {
                selPlanos.add(new Option(p.nome, p.id));
            });

            pagamentos.filter(fp => fp.ativo).forEach(fp => {
                selPags.add(new Option(fp.nome, fp.id));
            });

        } catch (e) { console.error("Erro ao carregar auxiliares campanha", e); }
    }

    // 2. Carregar Campanhas (Listagem)
    async function carregarCampanhas() {
        const lista = await apiFetch('/crm/campanhas/');
        const tbody = document.getElementById('lista-campanhas');
        tbody.innerHTML = '';
        
        if(lista.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-3">Nenhuma campanha cadastrada.</td></tr>';
            return;
        }

        lista.forEach(c => {
            const dInicio = c.data_inicio ? new Date(c.data_inicio).toLocaleDateString('pt-BR', {timeZone: 'UTC'}) : '?';
            const dFim = c.data_fim ? new Date(c.data_fim).toLocaleDateString('pt-BR', {timeZone: 'UTC'}) : '?';
            
            const statusBadge = c.ativo 
                ? '<span class="badge bg-success">Ativa</span>' 
                : '<span class="badge bg-secondary">Encerrada</span>';
            
            // Lógica para mostrar resumo das faixas (com ordenação para o resumo)
            let resumoMetas = '';
            // Usa 'regras_meta' se existir, que é o campo que o backend deve retornar agora
            if (c.regras_meta && c.regras_meta.length > 0) {
                // Ordena e lista todas as regras
                const regrasOrd = c.regras_meta.sort((a,b) => b.meta - a.meta);
                regrasOrd.forEach(r => {
                    resumoMetas += `<div class="small">Meta <b>${r.meta}</b>: <span class="text-success">R$ ${parseFloat(r.valor_premio).toFixed(2)}</span></div>`;
                });
            } else {
                // Mantém compatibilidade com meta única para campanhas antigas
                resumoMetas = `<div class="fw-bold">Meta: ${c.meta_vendas}</div>
                               <div class="text-success small">R$ ${parseFloat(c.valor_premio).toFixed(2)}</div>`;
            }

            const regrasTexto = `
                <div style="font-size:0.75rem">
                    Canal: <b>${c.canal_alvo}</b><br>
                    Tipo: <b>${c.tipo_meta}</b>
                </div>`;

            tbody.innerHTML += `
                <tr>
                    <td class="fw-bold">${c.nome}</td>
                    <td class="small">${dInicio} <br> ${dFim}</td>
                    <td>${resumoMetas}</td>
                    <td>${regrasTexto}</td>
                    <td>${statusBadge}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary me-1" onclick='editarCampanha(${JSON.stringify(c)})'><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="excluirCampanha(${c.id})"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>`;
        });
    }

    // 3. Salvar Campanha (Form Submit)
    document.getElementById('form-campanha').onsubmit = async(e) => {
        e.preventDefault();
        
        const getMultiValues = (id) => Array.from(document.getElementById(id).selectedOptions).map(opt => parseInt(opt.value));
        
        // Coleta as faixas da tabela
        const faixas = [];
        let maxMeta = 0;
        let maxPremio = 0;

        document.querySelectorAll('#tbody-faixas-campanha tr').forEach(tr => {
            const m_el = tr.querySelector('.input-meta');
            const p_el = tr.querySelector('.input-premio');

            const m = m_el ? parseInt(m_el.value) : null;
            const p = p_el ? parseFloat(p_el.value) : null;
            
            if (m && p) {
                if (m <= 0 || p < 0) {
                    throw new Error("Meta deve ser maior que 0 e Prêmio não pode ser negativo.");
                }
                faixas.push({ meta: m, valor_premio: p });
                if (m > maxMeta) maxMeta = m;
                if (p > maxPremio) maxPremio = p;
            }
        });

        if (faixas.length === 0) {
            alert("Adicione pelo menos uma faixa de premiação (Meta e Valor).");
            return;
        }

        const id = document.getElementById('campanha_id').value;
        const body = {
            nome: document.getElementById('campanha_nome').value,
            data_inicio: document.getElementById('campanha_data_inicio').value,
            data_fim: document.getElementById('campanha_data_fim').value,
            tipo_meta: document.getElementById('campanha_tipo_meta').value,
            canal_alvo: document.getElementById('campanha_canal_alvo').value,
            regras: document.getElementById('campanha_regras').value,
            ativo: document.getElementById('campanha_ativo').value === 'true',
            
            // NOVO: Envia a lista de faixas para o backend (esperando que o backend as salve na tabela RegraCampanha)
            regras_meta: faixas,
            
            // Campos de meta única (mandamos o valor máximo para compatibilidade e resumo na listagem)
            meta_vendas: maxMeta, 
            valor_premio: maxPremio,
            
            planos_elegiveis: getMultiValues('campanha_planos'),
            formas_pagamento_elegiveis: getMultiValues('campanha_pagamentos')
        };

        try {
            if(id) await apiFetch(`/crm/campanhas/${id}/`, {method:'PUT', body: JSON.stringify(body)});
            else await apiFetch('/crm/campanhas/', {method:'POST', body: JSON.stringify(body)});
            
            alert('Campanha salva com sucesso!');
            resetFormCampanha();
            carregarCampanhas();
        } catch(e) {
            alert('Erro ao salvar: ' + e.message);
        }
    };

    // 4. Editar Campanha (Preencher formulário e tabela)
    window.editarCampanha = (c) => {
        document.getElementById('campanha_id').value = c.id;
        document.getElementById('campanha_nome').value = c.nome;
        document.getElementById('campanha_data_inicio').value = c.data_inicio;
        document.getElementById('campanha_data_fim').value = c.data_fim;
        document.getElementById('campanha_tipo_meta').value = c.tipo_meta || 'LIQUIDA';
        document.getElementById('campanha_canal_alvo').value = c.canal_alvo || 'TODOS';
        document.getElementById('campanha_regras').value = c.regras || '';
        document.getElementById('campanha_ativo').value = c.ativo ? 'true' : 'false';

        // Preenche Multiselects
        const setMultiValues = (elementId, values) => {
            const select = document.getElementById(elementId);
            Array.from(select.options).forEach(opt => {
                opt.selected = values.includes(parseInt(opt.value));
            });
        };
        setMultiValues('campanha_planos', c.planos_elegiveis || []);
        setMultiValues('campanha_pagamentos', c.formas_pagamento_elegiveis || []);
        
        // Preenche Tabela de Faixas
        const tbody = document.getElementById('tbody-faixas-campanha');
        tbody.innerHTML = '';
        
        if (c.regras_meta && c.regras_meta.length > 0) {
            // Se tiver regras escalonadas, carrega elas
            c.regras_meta.forEach(r => adicionarFaixaCampanha(r.meta, r.valor_premio));
        } else if (c.meta_vendas > 0 || c.valor_premio > 0) {
            // Se for campanha antiga (legado), carrega a meta única (mantida para evitar perda de dados)
            adicionarFaixaCampanha(c.meta_vendas, c.valor_premio);
        } else {
            // Se for nova vazia, adiciona uma linha em branco
            adicionarFaixaCampanha();
        }
        
        document.getElementById('form-campanha').scrollIntoView({ behavior: 'smooth' });
    };

    // 5. Resetar Formulário
    window.resetFormCampanha = () => {
        document.getElementById('form-campanha').reset();
        document.getElementById('campanha_id').value = '';
        document.getElementById('tbody-faixas-campanha').innerHTML = ''; // Limpa tabela
        adicionarFaixaCampanha(); // Adiciona uma linha vazia (para começar)
        
        ['campanha_planos', 'campanha_pagamentos'].forEach(id => {
            const sel = document.getElementById(id);
            if(sel) Array.from(sel.options).forEach(opt => opt.selected = false);
        });
    };
    
    window.excluirCampanha = async(id) => { 
        if(confirm('Tem certeza que deseja excluir esta campanha? Os dados históricos podem ser perdidos.')) { 
            try {
                await apiFetch(`/crm/campanhas/${id}/`, {method:'DELETE'}); 
                carregarCampanhas(); 
            } catch(e) {
                alert('Erro ao excluir: ' + e.message);
            }
        } 
    };

    // ====================================================================
    // RELATÓRIOS: RESULTADO DE CAMPANHAS (ATUALIZADO)
    // ====================================================================
    
    async function carregarOpcoesCampanhasRelatorio() {
        const select = document.getElementById('select-rel-campanha');
        if (select.options.length > 1) return;

        select.innerHTML = '<option value="">Carregando...</option>';
        
        try {
            const campanhas = await apiFetch('/crm/campanhas/');
            select.innerHTML = '<option value="">Selecione uma campanha...</option>';
            
            if (campanhas.length === 0) {
                select.innerHTML = '<option value="">Nenhuma campanha encontrada.</option>';
                return;
            }

            campanhas.forEach(c => {
                const status = c.ativo ? '[Ativa]' : '[Encerrada]';
                select.add(new Option(`${status} ${c.nome}`, c.id));
            });
        } catch (e) {
            select.innerHTML = '<option value="">Erro ao carregar</option>';
            console.error(e);
        }
    }

    // Cache para guardar a lista completa do resultado
    let resultadoCampanhaCache = [];

    async function carregarResultadoCampanha() {
        const idCampanha = document.getElementById('select-rel-campanha').value;
        if (!idCampanha) return alert("Por favor, selecione uma campanha.");

        const container = document.getElementById('resultado-campanha-container');
        const tbody = document.getElementById('tbody-resultado-campanha');
        
        container.style.display = 'none';
        // Colspan ajustado para 7 devido à nova coluna de checkbox
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4"><div class="spinner-border text-primary"></div><br>Calculando resultados...</td></tr>'; 
        container.style.display = 'block';

        try {
            // Este endpoint agora retorna o resultado da campanha com o campo proxima_faixa e vendedor_id
            const dados = await apiFetch(`/crm/campanhas/${idCampanha}/resultado/`); 
            resultadoCampanhaCache = dados.ranking; // Salva o ranking no cache
            
            document.getElementById('campanha-titulo-resumo').innerText = dados.campanha;
            document.getElementById('campanha-periodo-resumo').innerText = `Período: ${dados.periodo}`;
            document.getElementById('campanha-tipo-resumo').innerText = dados.tipo;

            tbody.innerHTML = '';
            let totalPremios = 0;

            if (dados.ranking.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-3">Nenhuma venda contabilizada com os critérios desta campanha.</td></tr>';
            } else {
                dados.ranking.forEach(r => {
                    // Garante que o prêmio é um número para cálculo
                    const premioReceber = parseFloat(r.premio_receber);
                    totalPremios += premioReceber;
                    
                    const corBarra = premioReceber > 0 ? 'bg-success' : 'bg-warning';
                    const iconeMeta = premioReceber > 0 ? '<i class="bi bi-check-circle-fill text-success"></i>' : '';
                    const classePremio = premioReceber > 0 ? 'text-success fw-bold' : 'text-muted';

                    const metaExibida = r.meta_atingida_para_premio || r.meta; 
                    const premioFormatado = premioReceber.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});

                    // Determina a mensagem de "próxima faixa"
                    let msgProximaFaixa = '';
                    if (r.proxima_faixa) {
                        const valorProximaFaixa = parseFloat(r.proxima_faixa.valor_premio).toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
                        msgProximaFaixa = `<br><span class="small text-muted fst-italic">Próx: ${r.proxima_faixa.meta} vendas (${valorProximaFaixa})</span>`;
                    } else if (premioReceber > 0) {
                        msgProximaFaixa = '<br><span class="small text-muted fst-italic">Meta máxima atingida.</span>';
                    }

                    tbody.innerHTML += `
                        <tr>
                            <td><input type="checkbox" class="form-check-input check-vendedor-rel" value="${r.vendedor_id}" data-meta="${metaExibida}" data-premio="${premioReceber}"></td>
                            <td class="text-center fw-bold text-secondary">${r.ranking}º</td>
                            <td class="fw-bold">${r.vendedor}</td>
                            <td class="text-center fs-5">${r.vendas_validas}</td>
                            <td class="text-center text-muted small">Meta: ${metaExibida}</td>
                            <td style="width: 30%;">
                                <div class="d-flex align-items-center">
                                    <div class="progress flex-grow-1" style="height: 10px;">
                                        <div class="progress-bar ${corBarra}" role="progressbar" style="width: ${Math.min(r.percentual, 100)}%"></div>
                                    </div>
                                    <span class="ms-2 small fw-bold">${r.percentual}%</span>
                                    <span class="ms-2">${iconeMeta}</span>
                                </div>
                                <span style="font-size: 0.75rem;">${msgProximaFaixa}</span>
                            </td>
                            <td class="text-end ${classePremio}">${premioFormatado}</td>
                        </tr>
                    `;
                });
            }
            
            document.getElementById('campanha-total-premios').innerText = totalPremios.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
            document.getElementById('check-all-relatorio').checked = false; // Desmarca ao recarregar
            atualizarContadorWpp(); // Chama para inicializar o contador
        } catch (e) {
            alert("Erro ao carregar resultado: " + e.message);
            container.style.display = 'none';
        }
    }


    // Função para selecionar/deselecionar todos
    function toggleSelecaoRelatorio(source) {
        document.querySelectorAll('.check-vendedor-rel').forEach(c => c.checked = source.checked);
        atualizarContadorWpp();
    }

    // Adiciona listener para atualizar o contador quando um único checkbox é alterado
    document.addEventListener('change', (e) => {
        if (e.target.classList.contains('check-vendedor-rel')) {
            atualizarContadorWpp();
        }
    });

    // Função para atualizar o contador de vendedores selecionados
    function atualizarContadorWpp() {
        const count = document.querySelectorAll('.check-vendedor-rel:checked').length;
        document.getElementById('count-wpp').innerText = count;
        // Marca o "SELECIONAR TODOS" se todos estiverem marcados
        const totalVendedores = resultadoCampanhaCache.length;
        document.getElementById('check-all-relatorio').checked = (count > 0 && count === totalVendedores);
    }

    // Função para enviar os dados para o novo endpoint de WhatsApp
    async function enviarResultadoWhatsappSelecionados() {
        const checks = document.querySelectorAll('.check-vendedor-rel:checked');
        if (checks.length === 0) {
            alert("Selecione pelo menos um vendedor.");
            return;
        }

        const campanhaSelect = document.getElementById('select-rel-campanha');
        const campanhaId = campanhaSelect.value;
        
        // --- VERIFICAÇÃO DE ID DA CAMPANHA ---
        if (!campanhaId || campanhaId === "") {
            alert("Por favor, selecione uma Campanha válida no dropdown.");
            return;
        }
        // ------------------------------------

        const vendedorIds = Array.from(checks).map(c => parseInt(c.value));

        if (!confirm(`Confirmar envio do resultado da Campanha para ${vendedorIds.length} vendedores via WhatsApp?`)) {
            return;
        }
        
        // Filtra dados detalhados para enviar apenas os selecionados
        const dadosEnvio = resultadoCampanhaCache
            .filter(r => vendedorIds.includes(r.vendedor_id))
            .map(r => ({
                vendedor_id: r.vendedor_id,
                vendas_validas: r.vendas_validas,
                premio_receber: String(r.premio_receber),
                
                // --- ADICIONE ESTA LINHA ---
                meta_alcancada: r.meta_alcancada, // Manda o valor correto (ex: 20)
                // ---------------------------
                
                meta_atingida: r.meta, // Mantém compatibilidade
                proxima_faixa: r.proxima_faixa || null
            }));

        try {
            alert("Iniciando envio... Isso pode levar alguns segundos.");
            // NOVO ENDPOINT DE ENVIO DE RESULTADO
            const res = await apiFetch(`/crm/campanhas/enviar-resultado-whatsapp/`, {
                method: 'POST',
                body: JSON.stringify({
                    campanha_id: parseInt(campanhaId),
                    vendedores_dados: dadosEnvio
                })
            });

            alert(res.mensagem);
        } catch (e) {
            alert("Erro ao enviar resultados: " + (e.message || e));
        }
    }

    
    // --- RECEBIMENTO OPERADORA ---
    async function carregarComissoesOperadora() {
        const tbody = document.getElementById('lista-comissoes-operadora');
        const selPlano = document.getElementById('co_plano_id');
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">Carregando...</td></tr>';
        
        try {
            const planos = await apiFetch('/crm/planos/');
            selPlano.innerHTML = '<option value="">Selecione um Plano...</option>';
            if(planos) planos.forEach(p => selPlano.add(new Option(p.nome, p.id)));

            const lista = await apiFetch('/crm/comissoes-operadora/');
            tbody.innerHTML = '';
            
            if(lista.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhum registro encontrado.</td></tr>';
                return;
            }

            lista.forEach(co => {
                const total = parseFloat(co.valor_base || 0) + parseFloat(co.bonus_transicao || 0);
                let dtFim = '-';
                if (co.data_fim_bonus) {
                    const d = new Date(co.data_fim_bonus);
                    if (!isNaN(d.getTime())) {
                         dtFim = d.toLocaleDateString('pt-BR', {timeZone: 'UTC'});
                    }
                }
                
                tbody.innerHTML += `
                    <tr>
                        <td class="fw-bold">${co.plano_nome || 'Plano ID ' + co.plano}</td>
                        <td>${fmtMoeda(co.valor_base)}</td>
                        <td class="text-success fw-bold">${fmtMoeda(co.bonus_transicao)}</td>
                        <td>${dtFim}</td>
                        <td class="fw-bold text-primary">${fmtMoeda(total)}</td>
                        <td class="text-end">
                            <button class="btn btn-warning btn-sm" onclick='editarComissaoOp(${JSON.stringify(co)})'><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-danger btn-sm" onclick="deletarComissaoOp(${co.id})"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>
                `;
            });

        } catch (error) {
            console.error(error);
            tbody.innerHTML = '<tr><td colspan="6" class="text-danger text-center">Erro ao carregar dados. Verifique se o módulo backend está ativo.</td></tr>';
        }
    }

    document.getElementById('form-comissao-operadora').onsubmit = async (e) => {
        e.preventDefault();
        const id = document.getElementById('co_id').value;
        const payload = {
            plano: document.getElementById('co_plano_id').value,
            valor_base: document.getElementById('co_valor_base').value,
            bonus_transicao: document.getElementById('co_bonus').value,
            data_fim_bonus: document.getElementById('co_data_fim').value || null
        };

        try {
            if(id) await apiFetch(`/crm/comissoes-operadora/${id}/`, { method: 'PUT', body: JSON.stringify(payload) });
            else await apiFetch('/crm/comissoes-operadora/', { method: 'POST', body: JSON.stringify(payload) });
            
            document.getElementById('form-comissao-operadora').reset();
            document.getElementById('co_id').value = '';
            carregarComissoesOperadora();
            alert('Salvo com sucesso!');
        } catch(err) {
            alert('Erro ao salvar: ' + (err.detail || err));
        }
    };

    window.editarComissaoOp = (co) => {
        document.getElementById('co_id').value = co.id;
        document.getElementById('co_plano_id').value = co.plano;
        document.getElementById('co_valor_base').value = co.valor_base;
        document.getElementById('co_bonus').value = co.bonus_transicao;
        document.getElementById('co_data_fim').value = co.data_fim_bonus || '';
        openTab({ preventDefault: () => {} }, 'recebimento_operadora_tab');
        document.querySelector("button[onclick*='recebimento_operadora_tab']").classList.add('active');
        document.querySelector("button[onclick*='regras_comissao_tab']").classList.remove('active');
        document.getElementById('regras_comissao_tab').style.display = 'none';
        document.getElementById('form-comissao-operadora').scrollIntoView({ behavior: 'smooth' });
    };

    window.deletarComissaoOp = async (id) => {
        if(!confirm('Excluir este registro?')) return;
        try {
            await apiFetch(`/crm/comissoes-operadora/${id}/`, { method: 'DELETE' });
            carregarComissoesOperadora();
        } catch(e) { alert('Erro ao excluir.'); }
    };
    
    // ====================================================================
    // GESTÃO DE ADIANTAMENTOS E DESCONTOS
    // ====================================================================

    async function carregarUsuariosSelectsFinanceiro() {
        try {
            // Busca apenas usuários ativos
            const users = await apiFetch('/usuarios/?is_active=true');
            const selAd = document.getElementById('ad_usuario');
            const selDesc = document.getElementById('desc_usuario');
            
            selAd.innerHTML = '<option value="">Selecione...</option>';
            selDesc.innerHTML = '<option value="">Selecione...</option>';
            
            users.forEach(u => {
                // --- ALTERAÇÃO AQUI: Usando u.username (Login) ---
                const opt = new Option(u.username, u.id);
                selAd.add(opt.cloneNode(true));
                selDesc.add(opt);
            });
        } catch (e) { console.error("Erro ao carregar selects:", e); }
    }

    window.toggleCamposAdiantamento = () => {
        const tipo = document.getElementById('ad_tipo').value;
        const boxQtd = document.getElementById('box-qtd-vendas');
        if (tipo === 'ADIANTAMENTO_CNPJ') {
            boxQtd.style.display = 'block';
        } else {
            boxQtd.style.display = 'none';
            document.getElementById('ad_qtd').value = '';
        }
    };

    document.getElementById('form-adiantamento').onsubmit = async (e) => {
        e.preventDefault();
        const payload = {
            usuario: document.getElementById('ad_usuario').value,
            tipo: document.getElementById('ad_tipo').value,
            data: document.getElementById('ad_data').value,
            valor: document.getElementById('ad_valor').value,
            quantidade_vendas: document.getElementById('ad_qtd').value || 0,
            descricao: document.getElementById('ad_obs').value || 'Sem observação'
        };
        await salvarLancamento(payload, 'form-adiantamento');
    };

    document.getElementById('form-desconto').onsubmit = async (e) => {
        e.preventDefault();
        const payload = {
            usuario: document.getElementById('desc_usuario').value,
            tipo: 'DESCONTO',
            data: document.getElementById('desc_data').value,
            valor: document.getElementById('desc_valor').value,
            descricao: document.getElementById('desc_motivo').value
        };
        await salvarLancamento(payload, 'form-desconto');
    };

    async function salvarLancamento(payload, formId) {
        try {
            await apiFetch('/crm/lancamentos-financeiros/', {
                method: 'POST',
                body: JSON.stringify(payload)
            });
            alert('Lançamento registrado com sucesso!');
            document.getElementById(formId).reset();
            toggleCamposAdiantamento();
            carregarLancamentosFinanceiros();
        } catch (e) {
            alert('Erro ao salvar: ' + e.message);
        }
    }

    async function carregarLancamentosFinanceiros() {
        let mes = document.getElementById('filtro-mes-lancamentos').value;
        // Se não tiver mês selecionado, pega o atual
        if (!mes) {
            const hoje = new Date();
            mes = `${hoje.getFullYear()}-${String(hoje.getMonth()+1).padStart(2, '0')}`;
            document.getElementById('filtro-mes-lancamentos').value = mes;
        }

        const tbody = document.getElementById('lista-lancamentos-fin');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">Carregando...</td></tr>';

        try {
            const todos = await apiFetch('/crm/lancamentos-financeiros/');
            // Filtra apenas os lançamentos que começam com o ano-mês selecionado
            const filtrados = todos.filter(l => l.data && l.data.startsWith(mes));
            tbody.innerHTML = '';

            if (filtrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Nenhum lançamento neste mês.</td></tr>';
                return;
            }

            filtrados.forEach(l => {
                const dataFmt = new Date(l.data).toLocaleDateString('pt-BR', {timeZone:'UTC'});
                let classeValor = l.tipo === 'DESCONTO' ? 'text-danger' : 'text-primary';
                let detalhe = l.descricao || '';
                
                if(l.tipo === 'ADIANTAMENTO_CNPJ') detalhe = `(CNPJ - ${l.quantidade_vendas} vendas) ${l.descricao}`;
                if(l.tipo === 'ADIANTAMENTO_COMISSAO') detalhe = `(Comissão) ${l.descricao}`;

                // --- CORREÇÃO E MUDANÇA PARA LOGIN (USERNAME) ---
                let nomeExibicao = 'Não identificado';

                // 1. Tenta achar o usuário na lista carregada em memória (todosUsuariosCache)
                if (l.usuario) {
                    // Nota: todosUsuariosCache é preenchido pela função carregarUsuarios() ao abrir a página
                    const u = todosUsuariosCache.find(user => user.id === l.usuario);
                    
                    if (u && u.username) {
                        nomeExibicao = u.username; // Prioridade: Login do Cache
                    } else if (l.usuario_nome) {
                        // Se não achar no cache (ex: usuário inativo), usa o nome que veio do banco de dados
                        // O backend envia 'usuario_nome' (que hoje é o nome completo), mas é melhor que "Não identificado"
                        nomeExibicao = l.usuario_nome; 
                    }
                }
                // -----------------------------------------------

                tbody.innerHTML += `
                    <tr>
                        <td>${dataFmt}</td>
                        <td class="fw-bold">${nomeExibicao}</td>
                        <td>
                            <span class="badge bg-light text-dark border">${l.tipo.replace('_', ' ')}</span><br>
                            <span class="small text-muted">${detalhe}</span>
                        </td>
                        <td class="text-end fw-bold ${classeValor}">
                             R$ ${parseFloat(l.valor).toFixed(2)}
                        </td>
                        <td class="text-end">
                            <button class="btn btn-xs btn-outline-danger" onclick="excluirLancamento(${l.id})"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>
                `;
            });

        } catch (e) {
            console.error(e);
            tbody.innerHTML = '<tr><td colspan="5" class="text-danger text-center">Erro ao carregar histórico.</td></tr>';
        }
    }

    window.excluirLancamento = async (id) => {
        if(confirm('Tem certeza que deseja excluir este lançamento financeiro?')) {
            try {
                await apiFetch(`/crm/lancamentos-financeiros/${id}/`, { method: 'DELETE' });
                carregarLancamentosFinanceiros();
            } catch(e) { alert('Erro ao excluir.'); }
        }
    };

    // Inicialização
    document.addEventListener('DOMContentLoaded', () => {
        carregarDadosParaFormulario();
        carregarPerfis();
        carregarUsuarios('ativos'); 

        carregarMotivos();
        carregarFeriados();
        
        carregarOperadoras();
        carregarPlanos();
        carregarFormasPagamento();
        carregarStatus();
        carregarMotivosPendencia();
        carregarDadosParaRegrasComissao();
        carregarRegrasComissao();
        
        carregarDadosAuxiliaresCampanha();
        carregarCampanhas();
        adicionarFaixaCampanha(); // Adiciona a primeira linha de faixa ao carregar
        
        carregarComissoesOperadora(); 
        
        carregarUsuariosSelectsFinanceiro();
        carregarLancamentosFinanceiros();

        const primeiroLink = document.querySelector('.admin-nav-link');
        if(primeiroLink) mostrarSecao(null, 'usuarios', primeiroLink);
    });

    async function carregarMotivos() {
        const ul = document.getElementById('lista-motivos');
        ul.innerHTML = '<div class="text-center p-2 text-muted">Carregando...</div>';
        try {
            const resposta = await apiFetch('/presenca/motivos/');
            const lista = Array.isArray(resposta) ? resposta : (resposta.results || []);
            ul.innerHTML = '';
            if (lista.length === 0) {
                ul.innerHTML = '<li class="list-group-item text-muted text-center">Nenhum motivo cadastrado.</li>';
                return;
            }
            lista.forEach(m => {
                const nomeMotivo = m.nome || m.motivo || m.descricao || "Sem Nome";
                const badge = m.gera_desconto 
                    ? '<span class="badge bg-danger">Gera Desconto</span>' 
                    : '<span class="badge bg-success">Abona (Sem Desconto)</span>';
                ul.innerHTML += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span><strong>${nomeMotivo}</strong> &nbsp; ${badge}</span>
                        <button class="btn btn-sm btn-outline-danger" onclick="excluirMotivo(${m.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </li>`;
            });
        } catch (e) {
            console.error("Erro ao carregar motivos:", e);
            ul.innerHTML = '<li class="list-group-item text-danger text-center">Erro ao carregar motivos.</li>';
        }
    }

    const btnSalvarMotivo = document.getElementById('btn-salvar-motivo');
    if(btnSalvarMotivo) {
        btnSalvarMotivo.onclick = async () => {
            const nomeInput = document.getElementById('novo-motivo-nome');
            const descInput = document.getElementById('novo-motivo-desconto');
            if (!nomeInput.value) return alert('Digite o nome do motivo.');
            try {
                await apiFetch('/presenca/motivos/', {
                    method: 'POST',
                    body: JSON.stringify({ nome: nomeInput.value, gera_desconto: descInput.checked })
                });
                nomeInput.value = '';
                carregarMotivos();
            } catch (e) { alert('Erro ao salvar motivo: ' + e.message); }
        };
    }

    window.excluirMotivo = async (id) => {
        if(confirm('Tem certeza que deseja excluir este motivo?')) {
            try { await apiFetch(`/presenca/motivos/${id}/`, { method: 'DELETE' }); carregarMotivos(); } catch(e){ alert('Erro ao excluir: ' + e.message); }
        }
    };

    async function carregarFeriados() {
        const tbody = document.getElementById('lista-feriados');
        tbody.innerHTML = '<tr><td colspan="3" class="text-center">Carregando...</td></tr>';
        try {
            const lista = await apiFetch('/presenca/dias-nao-uteis/');
            tbody.innerHTML = '';
            if(lista.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Nenhum feriado cadastrado.</td></tr>';
                 return;
            }
            lista.forEach(f => {
                const dataFmt = f.data.split('-').reverse().join('/');
                tbody.innerHTML += `<tr><td>${dataFmt}</td><td>${f.descricao || '-'}</td><td><button class="btn btn-sm btn-outline-danger" onclick="excluirFeriado(${f.id})"><i class="bi bi-trash"></i></button></td></tr>`;
            });
        } catch (e) { 
            console.error(e); 
            tbody.innerHTML = '<tr><td colspan="3" class="text-danger text-center">Erro ao carregar feriados.</td></tr>'; 
        }
    }

    const btnSalvarFeriado = document.getElementById('btn-salvar-feriado');
    if(btnSalvarFeriado) {
        btnSalvarFeriado.onclick = async () => {
            const dataInput = document.getElementById('novo-feriado-data');
            const descInput = document.getElementById('novo-feriado-descricao');
            if(!dataInput.value) return alert('Selecione a data.');
            try {
                await apiFetch('/presenca/dias-nao-uteis/', {
                    method: 'POST',
                    body: JSON.stringify({ data: dataInput.value, descricao: descInput.value })
                });
                dataInput.value = ''; descInput.value = '';
                carregarFeriados();
            } catch(e) { alert('Erro ao salvar: ' + e.message); }
        };
    }
    window.excluirFeriado = async(id) => { if(confirm('Excluir esta data?')) { try { await apiFetch(`/presenca/dias-nao-uteis/${id}/`, { method: 'DELETE' }); carregarFeriados(); } catch(e){ alert('Erro ao excluir.'); } } };

    async function carregarRelatorioFinanceiro() {
        const elInicio = document.getElementById('finDataInicio');
        const elFim = document.getElementById('finDataFim');

        let ini = elInicio.value;
        let fim = elFim.value;
        
        // CORREÇÃO 1: Definir datas padrão se estiverem vazias para evitar erro ao carregar a página
        if (!ini || !fim) {
            const hoje = new Date();
            const primeiroDia = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
            const ultimoDia = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);

            if (!ini) ini = primeiroDia.toISOString().split('T')[0];
            if (!fim) fim = ultimoDia.toISOString().split('T')[0];

            // Atualiza visualmente os inputs
            elInicio.value = ini;
            elFim.value = fim;
        }
        
        const tPrev = document.getElementById('tbodyPrevisao');
        const tDesc = document.getElementById('tbodyDescontos');
        const cardPrev = document.getElementById('cardPrevisao');
        const cardDesc = document.getElementById('cardDescontos');
        
        tPrev.innerHTML = '<tr><td colspan="4" class="text-center">Calculando...</td></tr>';
        tDesc.innerHTML = '<tr><td colspan="6" class="text-center">Calculando...</td></tr>';
        
        cardPrev.style.display = 'block';
        cardDesc.style.display = 'block';

        try {
            // CORREÇÃO 2: Alterado de 'data_inicio'/'data_fim' para 'inicio'/'fim'
            const url = `/presenca/relatorio-financeiro/?inicio=${ini}&fim=${fim}`;
            const dados = await apiFetch(url);
            
            tPrev.innerHTML = '';
            tDesc.innerHTML = '';
            
            if(dados.previsao && dados.previsao.length > 0) {
                dados.previsao.forEach(p => {
                    // Usa username se disponível, ou o nome
                    const nomeExibicao = p.colaborador_username || p.nome || p.colaborador;
                    
                    tPrev.innerHTML += `
                        <tr>
                            <td>${nomeExibicao}</td>
                            <td>${p.dias_uteis}</td>
                            <td>R$ ${parseFloat(p.valor_diario).toFixed(2)}</td>
                            <td class="fw-bold text-primary">R$ ${parseFloat(p.total_receber || p.total_previsto).toFixed(2)}</td>
                        </tr>`;
                });
            } else {
                tPrev.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Sem dados de previsão.</td></tr>';
            }

            if(dados.descontos && dados.descontos.length > 0) {
                dados.descontos.forEach(d => {
                    const corValor = d.total_receber < 0 ? 'text-danger' : 'text-success';
                    const nomeExibicao = d.colaborador_username || d.nome || d.colaborador;

                    tDesc.innerHTML += `
                        <tr>
                            <td>${nomeExibicao}</td>
                            <td>${d.dias_uteis}</td>
                            <td>${d.qtd_faltas}</td>
                            <td>R$ ${parseFloat(d.valor_diario).toFixed(2)}</td>
                            <td class="text-danger fw-bold">R$ ${parseFloat(d.valor_desconto).toFixed(2)}</td>
                            <td class="fw-bold ${corValor}">R$ ${parseFloat(d.total_receber).toFixed(2)}</td>
                        </tr>`;
                });
            } else {
                tDesc.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhum dado processado.</td></tr>';
            }
        } catch(e) { 
            console.error(e); 
            tPrev.innerHTML = '<tr><td colspan="4" class="text-danger text-center">Erro ao gerar relatório.</td></tr>';
            tDesc.innerHTML = `<tr><td colspan="6" class="text-danger text-center">${e.message || 'Erro desconhecido'}</td></tr>`;
        }
    }

    async function baixarExcelFinanceiro() {
        const ini = document.getElementById('finDataInicio').value;
        const fim = document.getElementById('finDataFim').value;
        
        if(!ini || !fim) return alert('Selecione o período.');
        
        try {
            // CORREÇÃO 3: Alterado de 'data_inicio'/'data_fim' para 'inicio'/'fim' também aqui
            const blob = await apiFetch(`/presenca/relatorio-financeiro/excel/?inicio=${ini}&fim=${fim}`, { isBlob: true });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Relatorio_Financeiro_${ini}_a_${fim}.xlsx`;
            document.body.appendChild(a);
            a.click();
            a.remove();
        } catch(e) { alert('Erro ao baixar excel: ' + e.message); }
    }

    </script>
</body>
</html>