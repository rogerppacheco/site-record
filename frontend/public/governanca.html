{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Governança - Record PAP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{% static 'css/custom_styles.css' %}">
    <style>
        .content-section { display: none; }
        .content-section.active { display: block; }
        .btn .bi { margin-right: 5px; }
        /* A classe .form-grid foi removida em favor do grid do Bootstrap */
    </style>
</head>
<body data-bs-theme="dark">

    <header class="main-header">
        <div class="header-container">
            <img src="{% static 'logo.png' %}" alt="Record PAP Logo" class="logo" onclick="window.location.href='/'" style="cursor: pointer;">
            <nav class="main-nav">
                <ul>
                    <li><a href="/area-interna/">Área Interna</a></li>
                    <li><span class="navbar-text me-3" id="welcome-user"></span></li>
                    <li><button onclick="logout()" class="btn btn-danger">Sair</button></li>
                </ul>
            </nav>
        </div>
    </header>

    <nav class="navbar navbar-expand-lg submenu-nav navbar-dark bg-body-tertiary">
        <div class="container-fluid" style="max-width: 1200px;">
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav">
                    <li class="nav-item" id="nav-presenca"><a class="nav-link" href="/presenca/">Controle de Presença</a></li>
                    
                    <li class="nav-item dropdown" id="nav-vendas">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarVendas" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Vendas
                        </a>
                        <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="navbarVendas">
                            <li><a class="dropdown-item" href="/crm-vendas/">Cadastrar Venda</a></li>
                            <li><a class="dropdown-item" href="/auditoria/">Auditoria</a></li>
                            <li><a class="dropdown-item" href="/esteira/">Esteira</a></li>
                            <li><a class="dropdown-item" href="/comissionamento/">Comissionamento</a></li>
                        </ul>
                    </li>

                    <li class="nav-item dropdown" id="nav-importacoes">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarImportacoes" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Importações
                        </a>
                        <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="navbarImportacoes">
                            <li><a class="dropdown-item" href="/salvar-osab/">Salvar OSAB</a></li>
                            <li><a class="dropdown-item" href="/salvar-churn/">Salvar Churn</a></li>
                            <li><a class="dropdown-item" href="/salvar-ciclo-pagamento/">Salvar Ciclo de Pagamento</a></li>
                        </ul>
                    </li>

                    <li class="nav-item dropdown" id="nav-cadastros">
                        <a class="nav-link dropdown-toggle active" href="#" id="navbarCadastros" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Cadastros
                        </a>
                        <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="navbarCadastros">
                            <li><a class="dropdown-item" href="#" onclick="mostrarSecao(event, 'usuarios', this)">Gestão de Usuários</a></li>
                            <li><a class="dropdown-item" href="#" onclick="mostrarSecao(event, 'perfis', this)">Gestão de Perfis</a></li>
                            <li><a class="dropdown-item" href="#" onclick="mostrarSecao(event, 'comissionamento', this)">Gestão de Comissionamento</a></li>
                            <li><a class="dropdown-item" href="#" onclick="mostrarSecao(event, 'cadastros_gerais', this)">Cadastros Gerais</a></li>
                            <li><a class="dropdown-item" href="#" onclick="mostrarSecao(event, 'motivos', this)">Gestão de Motivos</a></li>
                            <li><a class="dropdown-item" href="#" onclick="mostrarSecao(event, 'feriados', this)">Gestão de Feriados</a></li>
                            <li><a class="dropdown-item" href="#" onclick="mostrarSecao(event, 'relatorios', this)">Relatórios</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

<div class="main-container container my-4">
    <main class="content-area">
        <section id="usuarios-section" class="content-section">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h2 class="mb-0" id="form-title">Cadastrar Novo Usuário</h2>
                </div>
                <div class="card-body">
                    <form id="user-form">
                        <input type="hidden" id="user_id">
                        <div class="row">
                            <div class="col-md-6 mb-3"><label for="nome_completo" class="form-label">Nome Completo</label><input type="text" class="form-control" id="nome_completo" required></div>
                            <div class="col-md-6 mb-3"><label for="cpf" class="form-label">CPF</label><input type="text" class="form-control" id="cpf"></div>
                            <div class="col-md-6 mb-3"><label for="email" class="form-label">E-mail</label><input type="email" class="form-control" id="email" required></div>
                            <div class="col-md-6 mb-3"><label for="username" class="form-label">Username</label><input type="text" class="form-control" id="username" required></div>
                            <div class="col-md-6 mb-3" id="senha-group"><label for="senha" class="form-label">Senha</label><input type="password" class="form-control" id="senha"></div>
                            <div class="col-md-6 mb-3"><label for="perfil_id" class="form-label">Perfil</label><select class="form-select" id="perfil_id" required></select></div>
                            <div class="col-md-6 mb-3"><label for="supervisor_id" class="form-label">Líder Imediato</label><select class="form-select" id="supervisor_id"><option value="">Nenhum</option></select></div>
                            <div class="col-md-6 mb-3"><label for="valor_almoco" class="form-label">Auxílio Almoço (diário)</label><input type="number" class="form-control" id="valor_almoco" step="0.01" placeholder="Ex: 18.00"></div>
                            <div class="col-md-6 mb-3"><label for="valor_passagem" class="form-label">Auxílio Passagem (diário)</label><input type="number" class="form-control" id="valor_passagem" step="0.01" placeholder="Ex: 9.60"></div>
                            <div class="col-md-6 mb-3"><label for="chave_pix" class="form-label">Chave PIX</label><input type="text" class="form-control" id="chave_pix" placeholder="Chave PIX do usuário"></div>
                            <div class="col-md-6 mb-3"><label for="nome_da_conta" class="form-label">Nome da Conta (PIX)</label><input type="text" class="form-control" id="nome_da_conta" placeholder="Nome do titular da conta PIX"></div>
                            <div class="col-md-6 mb-3"><label for="meta_comissao" class="form-label">Meta de Comissão (Vendas/Mês)</label><input type="number" class="form-control" id="meta_comissao" placeholder="Ex: 20"></div>
                            <div class="col-md-6 mb-3"><label for="desconto_boleto" class="form-label">Desconto por Boleto (R$)</label><input type="number" class="form-control" id="desconto_boleto" step="0.01" placeholder="Ex: 5.00"></div>
                            <div class="col-md-6 mb-3"><label for="desconto_inclusao_viabilidade" class="form-label">Desconto Inclusão Viab. (R$)</label><input type="number" class="form-control" id="desconto_inclusao_viabilidade" step="0.01"></div>
                            <div class="col-md-6 mb-3"><label for="desconto_instalacao_antecipada" class="form-label">Desconto Inst. Antecipada (R$)</label><input type="number" class="form-control" id="desconto_instalacao_antecipada" step="0.01"></div>
                            <div class="col-md-6 mb-3"><label for="adiantamento_cnpj" class="form-label">Adiantamento por Venda CNPJ (R$)</label><input type="number" class="form-control" id="adiantamento_cnpj" step="0.01"></div>
                            <div class="col-md-6 mb-3"><label for="desconto_inss_fixo" class="form-label">Desconto Fixo INSS (R$)</label><input type="number" class="form-control" id="desconto_inss_fixo" step="0.01"></div>
                        </div>
                        <button type="submit" class="btn btn-primary mt-3"><i class="bi bi-save"></i> Salvar</button>
                        <button type="button" class="btn btn-outline-light mt-3" onclick="resetForm()">Cancelar</button>
                    </form>
                </div>
            </div>
            
            <div class="card shadow-sm mt-4">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Usuários <span id="lista-status-titulo">Ativos</span></h5>
                        <div class="btn-group">
                            <button onclick="mostrarListaUsuarios('ativos', this)" class="btn btn-sm btn-secondary active">Ativos</button>
                            <button onclick="mostrarListaUsuarios('inativos', this)" class="btn btn-sm btn-secondary">Inativos</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-dark">
                                <tr id="user-list-header"></tr>
                            </thead>
                            <tbody id="user-list-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="perfis-section" class="content-section">
            <div class="card shadow-sm">
                 <div class="card-header d-flex justify-content-between align-items-center">
                    <h2 class="mb-0">Gestão de Perfis</h2>
                    <button class="btn btn-primary" id="btn-adicionar-perfil">
                        <i class="bi bi-plus-circle"></i> Adicionar Novo Perfil
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th>Nome do Perfil</th>
                                    <th>Descrição</th>
                                    <th class="text-center" style="width: 320px;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="perfis-tabela-corpo">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="comissionamento-section" class="content-section">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h2 class="mb-0">Gestão de Comissionamento</h2>
                </div>
                <div class="card-body">
                    <nav class="nav nav-tabs">
                        <button class="nav-link active" onclick="openTab(event, 'regras_comissao_tab')">Regras de Comissão</button>
                        <button class="nav-link" onclick="openTab(event, 'config_mensal_tab')">Configurações do Mês</button>
                        <button class="nav-link" onclick="openTab(event, 'campanhas_tab')">Campanhas e Prêmios</button>
                    </nav>

                    <div id="regras_comissao_tab" class="tab-content active pt-3">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Cadastrar/Editar Regra</h5>
                                <form id="form-regra-comissao">
                                    <input type="hidden" id="regra_comissao_id">
                                    <div class="row">
                                        <div class="col-md-4 mb-3"><label class="form-label">Consultor</label><select id="regra_consultor_id" class="form-select" required></select></div>
                                        <div class="col-md-4 mb-3"><label class="form-label">Plano</label><select id="regra_plano_id" class="form-select" required></select></div>
                                        <div class="col-md-4 mb-3"><label class="form-label">Tipo de Venda</label><select id="regra_tipo_venda" class="form-select" required><option value="PAP">PAP</option><option value="TELAG">TELAG</option></select></div>
                                        <div class="col-md-4 mb-3"><label class="form-label">Tipo de Cliente</label><select id="regra_tipo_cliente" class="form-select" required><option value="CPF">CPF</option><option value="CNPJ">CNPJ</option></select></div>
                                        <div class="col-md-4 mb-3"><label class="form-label">Valor Base (R$)</label><input type="number" class="form-control" id="regra_valor_base" step="0.01" required></div>
                                        <div class="col-md-4 mb-3"><label class="form-label">Valor Acelerado (R$)</label><input type="number" class="form-control" id="regra_valor_acelerado" step="0.01" required></div>
                                    </div>
                                    <button type="submit" class="btn btn-primary mt-3">Salvar</button>
                                    <button type="button" class="btn btn-outline-light mt-3" onclick="resetFormRegraComissao()">Cancelar</button>
                                </form>
                            </div>
                        </div>
                        <h5 class="mt-4">Regras Cadastradas</h5>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-dark"><tr><th>Consultor</th><th>Plano</th><th>Tipo Venda</th><th>Tipo Cliente</th><th>Valor Base</th><th>Valor Acelerado</th><th>Ações</th></tr></thead>
                                <tbody id="lista-regras-comissao"></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="config_mensal_tab" class="tab-content pt-3">
                        <h5>Configurações Variáveis do Mês</h5>
                        <div class="d-flex align-items-center mb-4">
                            <label for="select_mes_config" class="form-label me-2">Mês:</label>
                            <input type="month" id="select_mes_config" class="form-control" style="width: auto;">
                        </div>
                        <div id="form-container-config-mensal"></div>
                    </div>

                    <div id="campanhas_tab" class="tab-content pt-3">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Cadastrar/Editar Campanha</h5>
                                <form id="form-campanha">
                                    <input type="hidden" id="campanha_id">
                                    <div class="row">
                                        <div class="col-md-4 mb-3"><label class="form-label">Nome da Campanha</label><input type="text" class="form-control" id="campanha_nome" required></div>
                                        <div class="col-md-4 mb-3"><label class="form-label">Data de Início</label><input type="date" class="form-control" id="campanha_data_inicio" required></div>
                                        <div class="col-md-4 mb-3"><label class="form-label">Data de Fim</label><input type="date" class="form-control" id="campanha_data_fim" required></div>
                                        <div class="col-12 mb-3"><label class="form-label">Regras (Descrição)</label><input type="text" class="form-control" id="campanha_regras"></div>
                                    </div>
                                    <button type="submit" class="btn btn-primary mt-3">Salvar</button>
                                    <button type="button" class="btn btn-outline-light mt-3" onclick="resetFormCampanha()">Cancelar</button>
                                </form>
                            </div>
                        </div>
                        <h5 class="mt-4">Campanhas Ativas</h5>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-dark"><tr><th>Campanha</th><th>Período</th><th>Status</th><th>Ações</th></tr></thead>
                                <tbody id="lista-campanhas"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="cadastros_gerais-section" class="content-section">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h2 class="mb-0">Cadastros Gerais do CRM</h2>
                </div>
                <div class="card-body">
                    <nav class="nav nav-tabs">
                        <button class="nav-link active" onclick="openTab(event, 'operadoras')">Operadoras</button>
                        <button class="nav-link" onclick="openTab(event, 'planos')">Planos</button>
                        <button class="nav-link" onclick="openTab(event, 'formasPagamento')">Formas de Pagamento</button>
                        <button class="nav-link" onclick="openTab(event, 'status')">Status</button>
                        <button class="nav-link" onclick="openTab(event, 'pendencias')">Motivos de Pendência</button>
                    </nav>

                    <div id="operadoras" class="tab-content active pt-3">
                         <div class="card">
                             <div class="card-body">
                                <h5 class="card-title">Cadastrar/Editar Operadora</h5>
                                <form id="form-operadora">
                                    <input type="hidden" id="operadora_id">
                                    <div class="row">
                                        <div class="col-md-4 mb-3"><label class="form-label">Nome</label><input type="text" class="form-control" id="operadora_nome" required></div>
                                        <div class="col-md-4 mb-3"><label class="form-label">CNPJ</label><input type="text" class="form-control" id="operadora_cnpj"></div>
                                        <div class="col-md-4 mb-3"><label class="form-label">Status</label><select id="operadora_status" class="form-select" required><option value="1">Ativo</option><option value="0">Inativo</option></select></div>
                                    </div>
                                    <button type="submit" class="btn btn-primary mt-3">Salvar</button>
                                    <button type="button" class="btn btn-outline-light mt-3" onclick="resetFormOperadora()">Cancelar</button>
                                </form>
                             </div>
                         </div>
                        <h5 class="mt-4">Operadoras Cadastradas</h5>
                        <div class="table-responsive">
                             <table class="table table-hover align-middle">
                                <thead class="table-dark"><tr><th>Nome</th><th>CNPJ</th><th>Status</th><th>Ações</th></tr></thead>
                                <tbody id="lista-operadoras"></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="planos" class="tab-content pt-3">
                         <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Cadastrar/Editar Plano</h5>
                                <form id="form-plano">
                                    <input type="hidden" id="plano_id">
                                    <div class="row">
                                        <div class="col-md-6 mb-3"><label class="form-label">Nome</label><input type="text" class="form-control" id="plano_nome" required></div>
                                        <div class="col-md-3 mb-3"><label class="form-label">Valor (R$)</label><input type="number" class="form-control" id="plano_valor" step="0.01" required></div>
                                        <div class="col-md-3 mb-3"><label class="form-label">Comissão Base (R$)</label><input type="number" class="form-control" id="plano_comissao" step="0.01"></div>
                                        <div class="col-md-6 mb-3"><label class="form-label">Operadora</label><select id="plano_operadora_id" class="form-select" required><option value="">Selecione...</option></select></div>
                                        <div class="col-md-6 mb-3"><label class="form-label">Benefícios</label><input type="text" class="form-control" id="plano_beneficios"></div>
                                    </div>
                                    <button type="submit" class="btn btn-primary mt-3">Salvar</button>
                                    <button type="button" class="btn btn-outline-light mt-3" onclick="resetFormPlano()">Cancelar</button>
                                </form>
                            </div>
                        </div>
                        <h5 class="mt-4">Planos Cadastrados</h5>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-dark"><tr><th>Nome</th><th>Operadora</th><th>Valor</th><th>Comissão</th><th>Ações</th></tr></thead>
                                <tbody id="lista-planos"></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="formasPagamento" class="tab-content pt-3">
                        <h5>Gestão de Formas de Pagamento</h5>
                        <div class="input-group mb-3">
                            <input type="text" id="nova-forma-pagamento-nome" placeholder="Nome (Ex: PIX, Boleto)" class="form-control">
                            <button id="btn-salvar-forma-pagamento" class="btn btn-primary">Adicionar</button>
                        </div>
                        <ul id="lista-formas-pagamento" class="list-group"></ul>
                    </div>

                    <div id="status" class="tab-content pt-3">
                        <div class="card">
                             <div class="card-body">
                                <h5 class="card-title">Cadastrar/Editar Status</h5>
                                <form id="form-status">
                                    <input type="hidden" id="status_id">
                                    <div class="row">
                                        <div class="col-md-6 mb-3"><label class="form-label">Nome</label><input type="text" class="form-control" id="status_nome" required></div>
                                        <div class="col-md-6 mb-3"><label class="form-label">Tipo</label><select id="status_tipo" class="form-select" required><option value="Tratamento">Tratamento</option><option value="Esteira">Esteira</option><option value="Comissionamento">Comissionamento</option></select></div>
                                        <div class="col-md-6 mb-3" id="status_estado_group"><label class="form-label">Estado</label><input type="text" class="form-control" id="status_estado" placeholder="Ex: Na fila de tratamento"></div>
                                        <div class="col-md-6 mb-3"><label class="form-label">Cor</label><input type="color" class="form-control form-control-color" id="status_cor" value="#FFFFFF"></div>
                                    </div>
                                    <button type="submit" class="btn btn-primary mt-3">Salvar</button>
                                    <button type="button" class="btn btn-outline-light mt-3" onclick="resetFormStatus()">Cancelar</button>
                                </form>
                             </div>
                        </div>
                        <h5 class="mt-4">Status Cadastrados</h5>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-dark"><tr><th>Nome</th><th>Tipo</th><th>Estado</th><th>Cor</th><th>Ações</th></tr></thead>
                                <tbody id="lista-status"></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="pendencias" class="tab-content pt-3">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Cadastrar/Editar Motivo de Pendência</h5>
                                <form id="form-pendencia">
                                    <input type="hidden" id="pendencia_id">
                                    <div class="row">
                                        <div class="col-md-6 mb-3"><label class="form-label">Nome</label><input type="text" class="form-control" id="pendencia_nome" required></div>
                                        <div class="col-md-6 mb-3"><label class="form-label">Tipo</label><input type="text" class="form-control" id="pendencia_tipo" placeholder="Ex: Documentação" required></div>
                                    </div>
                                    <button type="submit" class="btn btn-primary mt-3">Salvar</button>
                                    <button type="button" class="btn btn-outline-light mt-3" onclick="resetFormPendencia()">Cancelar</button>
                                </form>
                            </div>
                        </div>
                        <h5 class="mt-4">Motivos Cadastrados</h5>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-dark"><tr><th>Nome</th><th>Tipo</th><th>Ações</th></tr></thead>
                                <tbody id="lista-pendencias"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="motivos-section" class="content-section">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h2 class="mb-0">Gestão de Motivos de Ausência</h2>
                </div>
                <div class="card-body">
                    <div class="input-group mb-3">
                        <input type="text" id="novo-motivo-nome" placeholder="Nome do novo motivo" class="form-control">
                        <div class="input-group-text">
                            <input class="form-check-input mt-0" type="checkbox" id="novo-motivo-desconto" checked>
                            <label class="form-check-label ms-2" for="novo-motivo-desconto">Gera Desconto</label>
                        </div>
                        <button id="btn-salvar-motivo" class="btn btn-primary">Adicionar</button>
                    </div>
                    <ul id="lista-motivos" class="list-group"></ul>
                </div>
            </div>
        </section>

        <section id="feriados-section" class="content-section">
             <div class="card shadow-sm">
                <div class="card-header">
                    <h2 class="mb-0">Gestão de Feriados e Dias Não Úteis</h2>
                </div>
                <div class="card-body">
                    <div class="input-group mb-4">
                        <input type="date" id="novo-feriado-data" class="form-control">
                        <input type="text" id="novo-feriado-descricao" placeholder="Descrição (Ex: Natal)" class="form-control">
                        <button id="btn-salvar-feriado" class="btn btn-primary">Adicionar</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-dark"><tr><th>Data</th><th>Descrição</th><th>Ações</th></tr></thead>
                            <tbody id="lista-feriados"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="relatorios-section" class="content-section">
             <div class="card shadow-sm">
                <div class="card-header">
                     <h2 class="mb-0">Relatórios Financeiros</h2>
                </div>
                <div class="card-body">
                    <div class="row g-3 align-items-end mb-3">
                        <div class="col-md">
                            <label for="data-inicio-relatorio" class="form-label">Data Inicial:</label>
                            <input type="date" id="data-inicio-relatorio" class="form-control">
                        </div>
                        <div class="col-md">
                            <label for="data-fim-relatorio" class="form-label">Data Final:</label>
                            <input type="date" id="data-fim-relatorio" class="form-control">
                        </div>
                    </div>
                    <div class="mt-3">
                        <button onclick="gerarRelatorio('previsao')" class="btn btn-info">Gerar Previsão</button>
                        <button onclick="gerarRelatorio('descontos')" class="btn btn-danger">Gerar Descontos</button>
                        <button onclick="gerarRelatorio('final')" class="btn btn-success">Gerar Relatório Final</button>
                    </div>
                    <div id="resultado-relatorio" class="mt-4">
                        <p class="text-muted">Selecione um período e um tipo de relatório para começar.</p>
                    </div>
                </div>
            </div>
        </section>
    </main>
</div>

<div class="modal fade" id="perfilModal" tabindex="-1" aria-labelledby="perfilModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="perfilModalLabel">Adicionar Perfil</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="perfilForm">
                    <input type="hidden" id="modal_perfil_id">
                    <div class="mb-3">
                        <label for="modal_perfil_nome" class="form-label">Nome do Perfil</label>
                        <input type="text" class="form-control" id="modal_perfil_nome" required>
                    </div>
                    <div class="mb-3">
                        <label for="modal_perfil_descricao" class="form-label">Descrição</label>
                        <textarea class="form-control" id="modal_perfil_descricao" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btn-salvar-perfil-modal">Salvar</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="excluirPerfilModal" tabindex="-1" aria-labelledby="excluirPerfilModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="excluirPerfilModalLabel">Confirmar Exclusão</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir o perfil "<strong id="nome-perfil-excluir"></strong>"?</p>
                <p class="text-danger">Esta ação não pode ser desfeita.</p>
                <input type="hidden" id="id-perfil-excluir">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btn-confirmar-exclusao-perfil">Excluir</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modal-edicao-motivo" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Motivo de Ausência</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                 <form id="form-edicao-motivo">
                    <input type="hidden" id="motivo-id-input">
                    <div class="mb-3">
                        <label for="motivo-nome-input" class="form-label">Nome do Motivo</label>
                        <input type="text" class="form-control" id="motivo-nome-input" required>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="motivo-desconto-input">
                        <label class="form-check-label" for="motivo-desconto-input">Gera Desconto</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" form="form-edicao-motivo" class="btn btn-primary">Salvar Alterações</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modal-permissoes" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                 <h5 class="modal-title" id="modal-permissoes-titulo">Permissões do Perfil</h5>
                 <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="permissoes-container" class="table-responsive"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btn-salvar-permissoes">Salvar</button>
            </div>
        </div>
    </div>
</div>

<footer>
    <p>Record PAP - Internet Fibra Ótica</p>
    <p>Contato: (31) 99458-8810 | E-mail: <a href="mailto:suporte@recordpap.com.br">suporte@recordpap.com.br</a></p>
    <p><a href="politica-de-privacidade.html">Política de Privacidade</a> | <a href="#">Termos de Uso</a></p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="{% static 'js/auth.js' %}"></script>
<script>

const apiUrl = '';

async function apiFetch(endpoint, options = {}) {
    const headers = {
        'Content-Type': 'application/json',
        ...options.headers,
    };
    
    const token = localStorage.getItem('accessToken');
    if (token) {
        headers['Authorization'] = `Bearer ${token}`;
    }

    const response = await fetch(`${apiUrl}/api${endpoint}`, { ...options, headers });

    let responseData = {};
    const contentType = response.headers.get("content-type");
    if (contentType && contentType.indexOf("application/json") !== -1) {
            try {
                responseData = await response.clone().json(); 
            } catch (e) {
                console.error("Não foi possível parsear o corpo da resposta como JSON.", e);
            }
    }

    if (responseData && responseData.token) {
        localStorage.setItem('accessToken', responseData.token);
        console.log('Token de acesso atualizado a partir do corpo da resposta!');
    }

    if (response.status === 401) {
        alert('Sua sessão expirou ou o token é inválido. Por favor, faça login novamente.');
        logout();
        throw new Error('Não autorizado');
    }
    if (!response.ok) {
        const errorData = responseData || await response.text();
        const errorMessage = errorData.detail || JSON.stringify(errorData).replace(/["{}[\]]/g, ' ');
        throw new Error(errorMessage);
    }
    if (response.status === 204) {
        return null;
    }
    
    return responseData;
}

if (!localStorage.getItem('accessToken')) {
        alert('Acesso negado. Faça o login para continuar.');
        window.location.href = '/';
}
const token = localStorage.getItem('accessToken');
const decodedToken = jwt_decode(token);
const userProfile = decodedToken ? decodedToken.perfil : null;
const isSuperuser = decodedToken ? decodedToken.is_superuser : false;

if (!userProfile || !['Diretoria', 'Admin'].includes(userProfile) && !isSuperuser) {
        alert('Acesso negado. Você não tem permissão para ver esta página.');
        window.location.href = '/area-interna/';
}

// --- LÓGICA GERAL DA PÁGINA ---

function mostrarSecao(event, idSecao, menuItem) {
    if (event) {
        event.stopPropagation();
    }
    document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
    });
    
    const secaoAlvo = document.getElementById(`${idSecao}-section`);
    if (secaoAlvo) {
        secaoAlvo.classList.add('active');
    }
    document.querySelectorAll('#nav-cadastros .dropdown-item').forEach(item => {
        item.classList.remove('active');
    });
    if (menuItem) {
        menuItem.classList.add('active');
    }
}


function openTab(evt, tabName) {
    const parentSection = evt.currentTarget.closest('.card-body');
    parentSection.querySelectorAll('.tab-content').forEach(tabcontent => {
        tabcontent.classList.remove("active");
        tabcontent.style.display = "none";
    });
    parentSection.querySelectorAll('.nav-tabs .nav-link').forEach(tablink => {
        tablink.classList.remove("active");
    });
    const targetTab = document.getElementById(tabName);
    if(targetTab){
        targetTab.style.display = "block";
        targetTab.classList.add("active");
    }
    evt.currentTarget.classList.add("active");
}

// --- LÓGICA DE GESTÃO DE USUÁRIOS (INTACTA) ---
const userForm = document.getElementById('user-form');
const formTitle = document.getElementById('form-title');
const userIdInput = document.getElementById('user_id');
const userListBody = document.getElementById('user-list-body');
const userListHeader = document.getElementById('user-list-header');
const listaStatusTitulo = document.getElementById('lista-status-titulo');
const selectPerfil = document.getElementById('perfil_id');
const selectSupervisor = document.getElementById('supervisor_id');

function resetForm() {
    userForm.reset();
    userIdInput.value = '';
    formTitle.textContent = 'Cadastrar Novo Usuário';
    document.getElementById('senha').placeholder = 'Senha Provisória';
    document.getElementById('senha').required = true;
}

function mostrarListaUsuarios(status, tabElement) {
    if (tabElement) {
        document.querySelectorAll('#usuarios-section .btn-group .btn').forEach(btn => btn.classList.remove('active'));
        tabElement.classList.add('active');
    }
    listaStatusTitulo.textContent = status === 'ativos' ? 'Ativos' : 'Inativos';
    carregarUsuarios(status);
}

async function carregarUsuarios(status = 'ativos') {
    try {
        const usuarios = await apiFetch(`/usuarios/?is_active=${status === 'ativos'}`);
        userListBody.innerHTML = '';
        if (status === 'ativos') {
            userListHeader.innerHTML = '<th>Nome</th><th>E-mail</th><th>Perfil</th><th>Líder Imediato</th><th class="text-end">Ações</th>';
            usuarios.forEach(user => {
                const supervisorDisplay = user.supervisor_nome || 'N/A';
                userListBody.innerHTML += `<tr><td>${user.nome_completo}</td><td>${user.email}</td><td>${user.perfil_nome}</td><td>${supervisorDisplay}</td><td class="text-end"><button class="btn btn-warning btn-sm" title="Editar" onclick='iniciarEdicao(${JSON.stringify(user)})'><i class="bi bi-pencil-square"></i></button> <button class="btn btn-danger btn-sm" title="Inativar" onclick="inativarUsuario(${user.id})"><i class="bi bi-trash"></i></button></td></tr>`;
            });
        } else {
            userListHeader.innerHTML = '<th>Nome</th><th>E-mail</th><th>Perfil</th><th class="text-end">Ações</th>';
            usuarios.forEach(user => {
                userListBody.innerHTML += `<tr><td>${user.nome_completo}</td><td>${user.email}</td><td>${user.perfil_nome}</td><td class="text-end"><button class="btn btn-success btn-sm" title="Reativar" onclick="reativarUsuario(${user.id})"><i class="bi bi-check-circle"></i></button></td></tr>`;
            });
        }
    } catch (error) { console.error("Erro ao carregar usuários:", error); }
}

async function carregarDadosParaFormulario() {
    selectPerfil.innerHTML = '';
    selectSupervisor.innerHTML = '<option value="">Nenhum</option>';
    try {
        const [perfis, usuarios] = await Promise.all([
            apiFetch('/perfis/'),
            apiFetch('/usuarios/?is_active=true')
        ]);
        
        perfis.forEach(perfil => selectPerfil.add(new Option(perfil.nome, perfil.id)));
        
        usuarios.forEach(usuario => {
            selectSupervisor.add(new Option(usuario.nome_completo, usuario.id));
        });

    } catch (error) { 
        console.error('Erro ao carregar dados para o formulário:', error); 
    }
}

function iniciarEdicao(user) {
    resetForm();
    formTitle.textContent = 'Editando Usuário';
    userIdInput.value = user.id;
    document.getElementById('nome_completo').value = user.nome_completo;
    document.getElementById('cpf').value = user.cpf || '';
    document.getElementById('email').value = user.email;
    document.getElementById('username').value = user.username;

    selectPerfil.value = user.perfil;
    selectSupervisor.value = user.supervisor || '';

    document.getElementById('valor_almoco').value = user.valor_almoco;
    document.getElementById('valor_passagem').value = user.valor_passagem;
    document.getElementById('chave_pix').value = user.chave_pix || '';
    document.getElementById('nome_da_conta').value = user.nome_da_conta || '';

    document.getElementById('meta_comissao').value = user.meta_comissao;
    document.getElementById('desconto_boleto').value = user.desconto_boleto;
    document.getElementById('desconto_inclusao_viabilidade').value = user.desconto_inclusao_viabilidade;
    document.getElementById('desconto_instalacao_antecipada').value = user.desconto_instalacao_antecipada;
    document.getElementById('adiantamento_cnpj').value = user.adiantamento_cnpj;
    document.getElementById('desconto_inss_fixo').value = user.desconto_inss_fixo;

    document.getElementById('senha').placeholder = 'Deixe em branco para não alterar';
    document.getElementById('senha').required = false;
    window.scrollTo(0, 0);
}

userForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    const id = userIdInput.value;
    const isEditing = !!id;
    const url = isEditing ? `/usuarios/${id}/` : '/usuarios/';
    const method = isEditing ? 'PUT' : 'POST';
    const nomeCompleto = document.getElementById('nome_completo').value.trim();
    const nomeParts = nomeCompleto.split(' ');
    const firstName = nomeParts.shift();
    const lastName = nomeParts.join(' ');

    const body = {
        first_name: firstName,
        last_name: lastName,
        cpf: document.getElementById('cpf').value,
        email: document.getElementById('email').value,
        perfil: selectPerfil.value,
        username: document.getElementById('username').value,
        supervisor: selectSupervisor.value || null,
        valor_almoco: document.getElementById('valor_almoco').value,
        valor_passagem: document.getElementById('valor_passagem').value,
        chave_pix: document.getElementById('chave_pix').value,
        nome_da_conta: document.getElementById('nome_da_conta').value,
        meta_comissao: document.getElementById('meta_comissao').value,
        desconto_boleto: document.getElementById('desconto_boleto').value,
        desconto_inclusao_viabilidade: document.getElementById('desconto_inclusao_viabilidade').value,
        desconto_instalacao_antecipada: document.getElementById('desconto_instalacao_antecipada').value,
        adiantamento_cnpj: document.getElementById('adiantamento_cnpj').value,
        desconto_inss_fixo: document.getElementById('desconto_inss_fixo').value
    };

    const senha = document.getElementById('senha').value;
    if (isEditing) {
        if (senha && senha.trim() !== '') {
            body.password = senha;
        }
    } else {
        body.password = senha;
        if (!body.password) { return alert('A senha é obrigatória para novos usuários.'); }
    }
    try {
        const result = await apiFetch(url, {
            method: method,
            body: JSON.stringify(body)
        });
        alert(`Usuário ${isEditing ? 'atualizado' : 'cadastrado'} com sucesso!`);
        resetForm();
        mostrarListaUsuarios('ativos', document.querySelector('#usuarios-section .btn-group .btn.active'));
        carregarDadosParaFormulario();
    } catch (error) {
        console.error('Detalhes do erro ao salvar usuário:', error);
        alert(`Erro: ${error.message}`);
    }
});

async function inativarUsuario(id) {
    if (!confirm('Tem certeza que deseja INATIVAR este usuário?')) return;
    try {
        await apiFetch(`/usuarios/${id}/`, { method: 'DELETE' });
        alert('Usuário inativado com sucesso.');
        mostrarListaUsuarios('ativos', document.querySelector('#usuarios-section .btn-group .btn.active'));
    } catch(error) {
        console.error('Detalhes do erro ao inativar usuário:', error);
        alert(`Erro: ${error.message}`);
    }
}

async function reativarUsuario(id) {
    if (!confirm('Tem certeza que deseja REATIVAR este usuário?')) return;
    try {
        await apiFetch(`/usuarios/${id}/reativar/`, { method: 'PUT' });
        alert('Usuário reativado com sucesso.');
        carregarUsuarios('inativos');
    } catch(error) {
        console.error('Detalhes do erro ao reativar usuário:', error);
        alert(`Erro: ${error.message}`);
    }
}


// --- LÓGICA DE GESTÃO DE PERFIS ---
const perfisTabelaCorpo = document.getElementById('perfis-tabela-corpo');
const perfilModalEl = document.getElementById('perfilModal');
const perfilModal = new bootstrap.Modal(perfilModalEl);
const excluirPerfilModalEl = document.getElementById('excluirPerfilModal');
const excluirPerfilModal = new bootstrap.Modal(excluirPerfilModalEl);

async function carregarPerfis() {
    try {
        const perfis = await apiFetch('/perfis/');
        perfisTabelaCorpo.innerHTML = '';
        perfis.forEach(perfil => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${perfil.nome}</td>
                <td>${perfil.descricao || '<em class="text-muted">Sem descrição</em>'}</td>
                <td class="text-center">
                    <div class="btn-group" role="group">
                        <button class="btn btn-secondary btn-sm btn-permissoes" data-id="${perfil.id}" data-nome="${perfil.nome}" title="Gerenciar Permissões">
                            <i class="bi bi-shield-lock"></i> Permissões
                        </button>
                        <button class="btn btn-warning btn-sm btn-editar-perfil" data-id="${perfil.id}" data-nome="${perfil.nome}" data-descricao="${perfil.descricao || ''}" title="Editar Perfil">
                            <i class="bi bi-pencil-square"></i> Editar
                        </button>
                        <button class="btn btn-danger btn-sm btn-excluir-perfil" data-id="${perfil.id}" data-nome="${perfil.nome}" title="Excluir Perfil">
                            <i class="bi bi-trash"></i> Excluir
                        </button>
                    </div>
                </td>
            `;
            perfisTabelaCorpo.appendChild(tr);
        });
    } catch (error) {
        console.error('Erro ao carregar perfis:', error);
        perfisTabelaCorpo.innerHTML = '<tr><td colspan="3" class="text-center text-danger">Falha ao carregar perfis.</td></tr>';
    }
}

document.getElementById('btn-adicionar-perfil').addEventListener('click', () => {
    document.getElementById('perfilForm').reset();
    document.getElementById('modal_perfil_id').value = '';
    document.getElementById('perfilModalLabel').textContent = 'Adicionar Novo Perfil';
    perfilModal.show();
});

perfisTabelaCorpo.addEventListener('click', (event) => {
    const target = event.target.closest('button');
    if (!target) return;

    const id = target.dataset.id;
    const nome = target.dataset.nome;

    if (target.classList.contains('btn-editar-perfil')) {
        const descricao = target.dataset.descricao;
        document.getElementById('perfilForm').reset();
        document.getElementById('modal_perfil_id').value = id;
        document.getElementById('modal_perfil_nome').value = nome;
        document.getElementById('modal_perfil_descricao').value = descricao;
        document.getElementById('perfilModalLabel').textContent = 'Editar Perfil';
        perfilModal.show();
    } else if (target.classList.contains('btn-excluir-perfil')) {
        document.getElementById('id-perfil-excluir').value = id;
        document.getElementById('nome-perfil-excluir').textContent = nome;
        excluirPerfilModal.show();
    } else if (target.classList.contains('btn-permissoes')) {
        abrirModalPermissoes(id, nome);
    }
});

document.getElementById('btn-salvar-perfil-modal').addEventListener('click', async () => {
    const id = document.getElementById('modal_perfil_id').value;
    const nome = document.getElementById('modal_perfil_nome').value.trim();
    const descricao = document.getElementById('modal_perfil_descricao').value.trim();

    if (!nome) {
        alert('O nome do perfil é obrigatório.');
        return;
    }

    const url = id ? `/perfis/${id}/` : '/perfis/';
    const method = id ? 'PUT' : 'POST';
    const body = JSON.stringify({ nome, descricao });

    try {
        await apiFetch(url, { method, body });
        alert(`Perfil ${id ? 'atualizado' : 'criado'} com sucesso!`);
        perfilModal.hide();
        await carregarPerfis();
        await carregarDadosParaFormulario(); 
    } catch (error) {
        console.error('Erro ao salvar perfil:', error);
        alert(`Erro: ${error.message}`);
    }
});

document.getElementById('btn-confirmar-exclusao-perfil').addEventListener('click', async () => {
    const id = document.getElementById('id-perfil-excluir').value;
    if (!id) return;
    
    try {
        await apiFetch(`/perfis/${id}/`, { method: 'DELETE' });
        alert('Perfil excluído com sucesso!');
        excluirPerfilModal.hide();
        await carregarPerfis();
        await carregarDadosParaFormulario(); 
    } catch (error) {
        console.error('Erro ao excluir perfil:', error);
        alert(`Erro: ${error.message}`);
    }
});


// --- LÓGICA DE GESTÃO DE MOTIVOS DE AUSÊNCIA ---
const listaMotivosUl = document.getElementById('lista-motivos');
const motivoModalEl = document.getElementById('modal-edicao-motivo');
const motivoModal = new bootstrap.Modal(motivoModalEl);

async function carregarMotivos() {
    try {
        const motivos = await apiFetch('/presenca/motivos/');
        listaMotivosUl.innerHTML = '';
        motivos.forEach(motivo => {
            const statusDesconto = motivo.gera_desconto ? '<span class="badge bg-danger">Gera Desconto</span>' : '<span class="badge bg-success">Não Gera Desconto</span>';
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.innerHTML = `<span>${motivo.motivo} ${statusDesconto}</span>
                            <div class="generic-list-actions">
                                <button class="btn btn-warning btn-sm" onclick='editarMotivo(${JSON.stringify(motivo)})'><i class="bi bi-pencil"></i></button>
                                <button class="btn btn-danger btn-sm" onclick="excluirMotivo(${motivo.id})"><i class="bi bi-trash"></i></button>
                            </div>`;
            listaMotivosUl.appendChild(li);
        });
    } catch (error) { console.error('Erro ao carregar motivos:', error); }
}

document.getElementById('btn-salvar-motivo').addEventListener('click', async () => {
    const motivo = document.getElementById('novo-motivo-nome').value.trim();
    const gera_desconto = document.getElementById('novo-motivo-desconto').checked;
    if (!motivo) return alert('Por favor, digite um nome para o motivo.');
    try {
        await apiFetch('/presenca/motivos/', {
            method: 'POST',
            body: JSON.stringify({ motivo, gera_desconto })
        });
        document.getElementById('novo-motivo-nome').value = '';
        document.getElementById('novo-motivo-desconto').checked = true;
        carregarMotivos();
    } catch (error) {
        console.error('Detalhes do erro ao salvar motivo:', error);
        alert(`Erro: ${error.message}`);
    }
});

function editarMotivo(motivo) {
    document.getElementById('motivo-id-input').value = motivo.id;
    document.getElementById('motivo-nome-input').value = motivo.motivo;
    document.getElementById('motivo-desconto-input').checked = motivo.gera_desconto;
    motivoModal.show();
}

async function excluirMotivo(id) {
    if (!confirm('Tem certeza que deseja excluir este motivo?')) return;
    try {
        await apiFetch(`/presenca/motivos/${id}/`, { method: 'DELETE' });
        carregarMotivos();
    } catch (error) {
        console.error('Detalhes do erro ao excluir motivo:', error);
        alert(`Erro: ${error.message}`);
    }
}

document.getElementById('form-edicao-motivo').addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('motivo-id-input').value;
    const motivo = document.getElementById('motivo-nome-input').value.trim();
    const gera_desconto = document.getElementById('motivo-desconto-input').checked;

    if (!motivo) return alert('O nome do motivo é obrigatório.');

    try {
        await apiFetch(`/presenca/motivos/${id}/`, {
            method: 'PUT',
            body: JSON.stringify({ motivo, gera_desconto })
        });
        motivoModal.hide();
        await carregarMotivos();
    } catch (error) {
        console.error('Erro ao salvar edição do motivo:', error);
        alert(`Erro: ${error.message}`);
    }
});

// --- LÓGICA DE GESTÃO DE FERIADOS ---
const listaFeriadosTbody = document.getElementById('lista-feriados');
async function carregarFeriados() {
    try {
        const feriados = await apiFetch('/presenca/dias-nao-uteis/');
        listaFeriadosTbody.innerHTML = '';
        feriados.forEach(feriado => {
            const dataFormatada = new Date(feriado.data).toLocaleDateString('pt-BR', { timeZone: 'UTC' });
            const row = `<tr><td>${dataFormatada}</td><td>${feriado.descricao}</td><td><button class="btn btn-danger btn-sm" onclick="excluirFeriado(${feriado.id})"><i class="bi bi-trash"></i></button></td></tr>`;
            listaFeriadosTbody.innerHTML += row;
        });
    } catch (error) { console.error('Erro ao carregar feriados:', error); }
}

document.getElementById('btn-salvar-feriado').addEventListener('click', async () => {
    const data = document.getElementById('novo-feriado-data').value;
    const descricao = document.getElementById('novo-feriado-descricao').value.trim();
    if (!data || !descricao) return alert('A data e a descrição são obrigatórias.');
    try {
        await apiFetch('/presenca/dias-nao-uteis/', {
            method: 'POST',
            body: JSON.stringify({ data, descricao })
        });
        document.getElementById('novo-feriado-data').value = '';
        document.getElementById('novo-feriado-descricao').value = '';
        carregarFeriados();
    } catch (error) {
        console.error('Detalhes do erro ao salvar feriado:', error);
        alert(`Erro: ${error.message}`);
    }
});

async function excluirFeriado(id) {
    if (!confirm('Tem certeza que deseja excluir este dia?')) return;
    try {
        await apiFetch(`/presenca/dias-nao-uteis/${id}/`, { method: 'DELETE' });
        carregarFeriados();
    } catch (error) {
        console.error('Detalhes do erro ao excluir feriado:', error);
        alert(`Erro: ${error.message}`);
    }
}

// --- LÓGICA DE RELATÓRIOS ---
async function gerarRelatorio(tipo) {
    const dataInicio = document.getElementById('data-inicio-relatorio').value;
    const dataFim = document.getElementById('data-fim-relatorio').value;
    if (!dataInicio || !dataFim) { return alert('Por favor, selecione a data inicial e final.'); }

    const container = document.getElementById('resultado-relatorio');
    container.innerHTML = '<div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>';

    let url = '';
    switch (tipo) {
        case 'previsao': url = `/relatorios/previsao?dataInicio=${dataInicio}&dataFim=${dataFim}`; break;
        case 'descontos': url = `/relatorios/descontos?dataInicio=${dataInicio}&dataFim=${dataFim}`; break;
        case 'final': url = `/relatorios/semanal?dataInicio=${dataInicio}&dataFim=${dataFim}`; break;
        default: container.innerHTML = '<p class="text-danger">Tipo de relatório inválido.</p>'; return;
    }

    try {
        const relatorio = await apiFetch(url);
        renderizarTabelaRelatorio(tipo, relatorio);
    } catch(error) {
        container.innerHTML = `<p class="text-danger">${error.message}</p>`;
    }
}

function renderizarTabelaRelatorio(tipo, relatorio) {
    const container = document.getElementById('resultado-relatorio');
    const inicioFormatado = new Date(relatorio.periodo.inicio + 'T03:00:00Z').toLocaleDateString('pt-BR');
    const fimFormatado = new Date(relatorio.periodo.fim + 'T03:00:00Z').toLocaleDateString('pt-BR');
    let html = `<h5>Relatório de ${inicioFormatado} a ${fimFormatado}</h5>`;

    if (!relatorio.dados || relatorio.dados.length === 0) {
        container.innerHTML = `${html}<p class="text-center text-muted mt-3">Nenhum dado encontrado para este período.</p>`;
        return;
    }

    html += '<div class="table-responsive"><table class="table table-bordered table-sm">';
    switch (tipo) {
        case 'previsao':
            html += `<thead class="table-light"><tr><th>Vendedor</th><th>Auxílio Diário</th><th>Previsão para o Período</th></tr></thead><tbody>`;
            relatorio.dados.forEach(item => {
                html += `<tr><td>${item.nome_completo}</td><td>R$ ${Number(item.auxilio_diario).toFixed(2).replace('.',',')}</td><td><strong>R$ ${Number(item.previsao_periodo).toFixed(2).replace('.',',')}</strong></td></tr>`;
            });
            break;
        case 'descontos':
            html += `<thead class="table-light"><tr><th>Vendedor</th><th>Data da Falta</th><th>Motivo</th><th>Valor a Descontar</th></tr></thead><tbody>`;
            relatorio.dados.forEach(item => {
                const dataFalta = new Date(item.data).toLocaleDateString('pt-BR', { timeZone: 'UTC' });
                html += `<tr><td>${item.nome_completo}</td><td>${dataFalta}</td><td>${item.motivo}</td><td class="text-danger">R$ ${Number(item.valor_desconto).toFixed(2).replace('.',',')}</td></tr>`;
            });
            break;
        case 'final':
            html += `<thead class="table-light"><tr><th>Vendedor</th><th>Dias Trabalhados</th><th>Faltas c/ Desconto</th><th>A Receber</th><th>A Descontar</th><th>Valor Final</th></tr></thead><tbody>`;
            relatorio.dados.forEach(item => {
                html += `<tr><td>${item.nome_completo}</td><td>${item.dias_trabalhados}</td><td>${item.dias_falta_com_desconto}</td><td>R$ ${Number(item.total_a_receber).toFixed(2).replace('.',',')}</td><td class="text-danger">R$ ${Number(item.total_a_descontar).toFixed(2).replace('.',',')}</td><td><strong>R$ ${Number(item.valor_final).toFixed(2).replace('.',',')}</strong></td></tr>`;
            });
            break;
    }
    html += `</tbody></table></div>`;
    container.innerHTML = html;
}

// --- LÓGICA DE PERMISSÕES ---
const modalPermissoesEl = document.getElementById('modal-permissoes');
const modalPermissoes = new bootstrap.Modal(modalPermissoesEl);
const permissoesContainer = document.getElementById('permissoes-container');
const modalPermissoesTitulo = document.getElementById('modal-permissoes-titulo');
const btnSalvarPermissoes = document.getElementById('btn-salvar-permissoes');
let perfilIdAtual = null;

async function abrirModalPermissoes(perfilId, perfilNome) {
    perfilIdAtual = perfilId;
    modalPermissoesTitulo.textContent = `Permissões do Perfil: ${perfilNome}`;
    permissoesContainer.innerHTML = '<div class="spinner-border" role="status"><span class="visually-hidden">Carregando...</span></div>';
    modalPermissoes.show();

    try {
        const recursosDisponiveis = await apiFetch('/recursos/');
        const permissoesSalvas = await apiFetch(`/perfis/${perfilId}/permissoes/`);
        const permissoesAtivas = new Set(permissoesSalvas);

        let tabelaHtml = `<table class="table table-bordered table-sm" id="permissoes-table">
                            <thead class="table-light">
                                <tr>
                                    <th>Recurso</th>
                                    <th class="text-center">Visualizar</th>
                                    <th class="text-center">Adicionar</th>
                                    <th class="text-center">Modificar</th>
                                    <th class="text-center">Excluir</th>
                                </tr>
                            </thead>
                            <tbody>`;
        recursosDisponiveis.forEach(recurso => {
            tabelaHtml += `<tr><td>${recurso.replace(/_/g, ' ')}</td>`;
            ['view', 'add', 'change', 'delete'].forEach(acao => {
                const codenameCompleto = `can_${acao}_${recurso}`;
                const isChecked = permissoesAtivas.has(codenameCompleto);
                tabelaHtml += `<td class="text-center"><input class="form-check-input" type="checkbox" data-recurso="${recurso}" data-acao="${acao}" ${isChecked ? 'checked' : ''}></td>`;
            });
            tabelaHtml += `</tr>`;
        });
        tabelaHtml += `</tbody></table>`;
        permissoesContainer.innerHTML = tabelaHtml;
    } catch (error) {
        console.error("Erro ao carregar ou processar permissões:", error);
        permissoesContainer.innerHTML = `<p class="text-danger">Ocorreu um erro ao processar as permissões.</p>`;
    }
}

btnSalvarPermissoes.addEventListener('click', async () => {
    if (!perfilIdAtual) return;
    const checkboxes = permissoesContainer.querySelectorAll('input[type="checkbox"]');
    const permissoesPayload = Array.from(checkboxes).map(cb => ({
        recurso: cb.dataset.recurso,
        acao: cb.dataset.acao,
        ativo: cb.checked
    }));

    try {
        await apiFetch(`/perfis/${perfilIdAtual}/permissoes/`, {
            method: 'PUT',
            body: JSON.stringify({ permissoes: permissoesPayload })
        });
        alert('Permissões salvas com sucesso!');
        modalPermissoes.hide();
    } catch (error) {
        console.error("Erro ao salvar permissões:", error);
        alert(`Erro ao salvar: ${error.message}`);
    }
});

// --- LÓGICA PARA CADASTROS GERAIS (CRM) ---
const formOperadora = document.getElementById('form-operadora');
const listaOperadoras = document.getElementById('lista-operadoras');
const operadoraIdInput = document.getElementById('operadora_id');
const operadoraNomeInput = document.getElementById('operadora_nome');
const operadoraCnpjInput = document.getElementById('operadora_cnpj');
const operadoraStatusSelect = document.getElementById('operadora_status');

async function carregarOperadoras() {
    try {
        const operadoras = await apiFetch('/crm/operadoras/');
        listaOperadoras.innerHTML = '';
        operadoras.forEach(op => {
            const tr = document.createElement('tr');
            const statusBadge = op.status ? '<span class="badge bg-success">Ativo</span>' : '<span class="badge bg-danger">Inativo</span>';
            tr.innerHTML = `
                <td>${op.nome}</td>
                <td>${op.cnpj || 'N/A'}</td>
                <td>${statusBadge}</td>
                <td class="actions-cell">
                    <button class="btn btn-warning btn-sm" onclick='editarOperadora(${JSON.stringify(op)})'><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-danger btn-sm" onclick="deletarOperadora(${op.id})"><i class="bi bi-trash"></i></button>
                </td>
            `;
            listaOperadoras.appendChild(tr);
        });
    } catch (error) { console.error('Erro ao carregar operadoras:', error); }
}

function resetFormOperadora() {
    formOperadora.reset();
    operadoraIdInput.value = '';
}

formOperadora.addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = operadoraIdInput.value;
    const url = id ? `/crm/operadoras/${id}/` : '/crm/operadoras/';
    const method = id ? 'PUT' : 'POST';
    const body = JSON.stringify({
        nome: operadoraNomeInput.value,
        cnpj: operadoraCnpjInput.value,
        status: operadoraStatusSelect.value === '1'
    });
    try {
        await apiFetch(url, { method, body });
        alert(`Operadora ${id ? 'atualizada' : 'criada'} com sucesso!`);
        resetFormOperadora();
        carregarOperadoras();
    } catch (error) { alert(`Erro: ${error.message}`); }
});

function editarOperadora(operadora) {
    operadoraIdInput.value = operadora.id;
    operadoraNomeInput.value = operadora.nome;
    operadoraCnpjInput.value = operadora.cnpj;
    operadoraStatusSelect.value = operadora.status ? '1' : '0';
    window.scrollTo(0, 0);
}

async function deletarOperadora(id) {
    if (!confirm('Tem certeza?')) return;
    try {
        await apiFetch(`/crm/operadoras/${id}/`, { method: 'DELETE' });
        alert('Operadora excluída!');
        carregarOperadoras();
    } catch (error) { alert(`Erro: ${error.message}`); }
}

const formPlano = document.getElementById('form-plano');
const listaPlanos = document.getElementById('lista-planos');
const planoIdInput = document.getElementById('plano_id');
const planoNomeInput = document.getElementById('plano_nome');
const planoValorInput = document.getElementById('plano_valor');
const planoComissaoInput = document.getElementById('plano_comissao');
const planoOperadoraSelect = document.getElementById('plano_operadora_id');
const planoBeneficiosInput = document.getElementById('plano_beneficios');

async function carregarPlanos() {
    try {
        const [planos, operadoras] = await Promise.all([
            apiFetch('/crm/planos/'),
            apiFetch('/crm/operadoras/')
        ]);
        listaPlanos.innerHTML = '';
        planos.forEach(plano => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${plano.nome}</td>
                <td>${plano.operadora_nome}</td>
                <td>R$ ${Number(plano.valor).toFixed(2)}</td>
                <td>R$ ${Number(plano.comissao_base).toFixed(2)}</td>
                <td class="actions-cell">
                    <button class="btn btn-warning btn-sm" onclick='editarPlano(${JSON.stringify(plano)})'><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-danger btn-sm" onclick="deletarPlano(${plano.id})"><i class="bi bi-trash"></i></button>
                </td>
            `;
            listaPlanos.appendChild(tr);
        });
        planoOperadoraSelect.innerHTML = '<option value="">Selecione...</option>';
        operadoras.forEach(op => {
            planoOperadoraSelect.add(new Option(op.nome, op.id));
        });
    } catch (error) { console.error('Erro ao carregar planos:', error); }
}

function resetFormPlano() {
    formPlano.reset();
    planoIdInput.value = '';
}

formPlano.addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = planoIdInput.value;
    const url = id ? `/crm/planos/${id}/` : '/crm/planos/';
    const method = id ? 'PUT' : 'POST';
    const body = JSON.stringify({
        nome: planoNomeInput.value,
        valor: parseFloat(planoValorInput.value),
        comissao_base: parseFloat(planoComissaoInput.value) || 0,
        operadora: planoOperadoraSelect.value,
        beneficios: planoBeneficiosInput.value,
        status: true
    });
    try {
        await apiFetch(url, { method, body });
        alert(`Plano ${id ? 'atualizado' : 'criado'} com sucesso!`);
        resetFormPlano();
        carregarPlanos();
    } catch (error) { alert(`Erro: ${error.message}`); }
});

function editarPlano(plano) {
    planoIdInput.value = plano.id;
    planoNomeInput.value = plano.nome;
    planoValorInput.value = plano.valor;
    planoComissaoInput.value = plano.comissao_base;
    planoOperadoraSelect.value = plano.operadora;
    planoBeneficiosInput.value = plano.beneficios || '';
    document.querySelector('button[onclick*="planos"]').click();
    window.scrollTo(0, 0);
}

async function deletarPlano(id) {
    if (!confirm('Tem certeza?')) return;
    try {
        await apiFetch(`/crm/planos/${id}/`, { method: 'DELETE' });
        alert('Plano excluído!');
        carregarPlanos();
    } catch (error) { alert(`Erro: ${error.message}`); }
}

const listaFormasPagamentoUl = document.getElementById('lista-formas-pagamento');
async function carregarFormasPagamento() {
    try {
        const formas = await apiFetch('/crm/formas-pagamento/');
        listaFormasPagamentoUl.innerHTML = '';
        formas.forEach(forma => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.innerHTML = `<span>${forma.nome}</span>
                            <div class="generic-list-actions">
                                <button class="btn btn-warning btn-sm" onclick="editarFormaPagamento(${forma.id}, '${forma.nome.replace(/'/g, "\\'")}')"><i class="bi bi-pencil"></i></button>
                                <button class="btn btn-danger btn-sm" onclick="excluirFormaPagamento(${forma.id})"><i class="bi bi-trash"></i></button>
                            </div>`;
            listaFormasPagamentoUl.appendChild(li);
        });
    } catch (error) { console.error('Erro ao carregar formas de pagamento:', error); }
}
document.getElementById('btn-salvar-forma-pagamento').addEventListener('click', async () => {
    const nome = document.getElementById('nova-forma-pagamento-nome').value.trim();
    if (!nome) return alert('Por favor, digite um nome.');
    try {
        await apiFetch('/crm/formas-pagamento/', {
            method: 'POST',
            body: JSON.stringify({ nome: nome, status: true })
        });
        document.getElementById('nova-forma-pagamento-nome').value = '';
        carregarFormasPagamento();
    } catch (error) { alert(`Erro: ${error.message}`); }
});
async function editarFormaPagamento(id, nomeAtual) {
    const novoNome = prompt('Digite o novo nome:', nomeAtual);
    if (novoNome && novoNome.trim() !== '') {
        try {
            await apiFetch(`/crm/formas-pagamento/${id}/`, {
                method: 'PUT',
                body: JSON.stringify({ nome: novoNome.trim(), status: true })
            });
            carregarFormasPagamento();
        } catch (error) { alert(`Erro: ${error.message}`); }
    }
}
async function excluirFormaPagamento(id) {
    if (!confirm('Tem certeza?')) return;
    try {
        await apiFetch(`/crm/formas-pagamento/${id}/`, { method: 'DELETE' });
        carregarFormasPagamento();
    } catch (error) { alert(`Erro: ${error.message}`); }
}

const formStatus = document.getElementById('form-status');
const listaStatusBody = document.getElementById('lista-status');
const statusIdInput = document.getElementById('status_id');
const statusNomeInput = document.getElementById('status_nome');
const statusTipoSelect = document.getElementById('status_tipo');
const statusEstadoInput = document.getElementById('status_estado');
const statusCorInput = document.getElementById('status_cor');
const statusEstadoGroup = document.getElementById('status_estado_group');

statusTipoSelect.addEventListener('change', () => {
    statusEstadoGroup.style.display = statusTipoSelect.value === 'Comissionamento' ? 'none' : 'block';
});

function resetFormStatus() {
    formStatus.reset();
    statusIdInput.value = '';
    statusEstadoGroup.style.display = 'block';
}

async function carregarStatus() {
    try {
        const statusList = await apiFetch('/crm/status/');
        listaStatusBody.innerHTML = '';
        statusList.forEach(s => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><span style="display: inline-block; width: 12px; height: 12px; background-color: ${s.cor}; border-radius: 50%; margin-right: 8px;"></span> ${s.nome}</td>
                <td>${s.tipo}</td>
                <td>${s.estado || 'N/A'}</td>
                <td>${s.cor}</td>
                <td class="actions-cell">
                    <button class="btn btn-warning btn-sm" onclick='editarStatus(${JSON.stringify(s)})'><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-danger btn-sm" onclick="excluirStatus(${s.id})"><i class="bi bi-trash"></i></button>
                </td>
            `;
            listaStatusBody.appendChild(tr);
        });
    } catch (error) { console.error('Erro ao carregar status:', error); }
}

formStatus.addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = statusIdInput.value;
    const url = id ? `/crm/status/${id}/` : '/crm/status/';
    const method = id ? 'PUT' : 'POST';
    const body = {
        nome: statusNomeInput.value,
        tipo: statusTipoSelect.value,
        estado: statusTipoSelect.value === 'Comissionamento' ? null : statusEstadoInput.value,
        cor: statusCorInput.value
    };
    try {
        await apiFetch(url, { method, body: JSON.stringify(body) });
        alert(`Status ${id ? 'atualizado' : 'criado'}!`);
        resetFormStatus();
        carregarStatus();
    } catch (error) { alert(`Erro: ${error.message}`); }
});

function editarStatus(status) {
    statusIdInput.value = status.id;
    statusNomeInput.value = status.nome;
    statusTipoSelect.value = status.tipo;
    statusEstadoInput.value = status.estado || '';
    statusCorInput.value = status.cor;
    statusTipoSelect.dispatchEvent(new Event('change'));
    window.scrollTo(0, 0);
}

async function excluirStatus(id) {
    if (!confirm('Tem certeza?')) return;
    try {
        await apiFetch(`/crm/status/${id}/`, { method: 'DELETE' });
        alert('Status excluído!');
        carregarStatus();
    } catch (error) { alert(`Erro: ${error.message}`); }
}

const formPendencia = document.getElementById('form-pendencia');
const listaPendenciasBody = document.getElementById('lista-pendencias');
const pendenciaIdInput = document.getElementById('pendencia_id');
const pendenciaNomeInput = document.getElementById('pendencia_nome');
const pendenciaTipoInput = document.getElementById('pendencia_tipo');

function resetFormPendencia() {
    formPendencia.reset();
    pendenciaIdInput.value = '';
}

async function carregarMotivosPendencia() {
    try {
        const pendencias = await apiFetch('/crm/motivos-pendencia/');
        listaPendenciasBody.innerHTML = '';
        pendencias.forEach(p => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${p.nome}</td>
                <td>${p.tipo_pendencia}</td>
                <td class="actions-cell">
                    <button class="btn btn-warning btn-sm" onclick='editarMotivoPendencia(${JSON.stringify(p)})'><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-danger btn-sm" onclick="excluirMotivoPendencia(${p.id})"><i class="bi bi-trash"></i></button>
                </td>
            `;
            listaPendenciasBody.appendChild(tr);
        });
    } catch (error) { console.error('Erro ao carregar motivos de pendência:', error); }
}

formPendencia.addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = pendenciaIdInput.value;
    const url = id ? `/crm/motivos-pendencia/${id}/` : '/crm/motivos-pendencia/';
    const method = id ? 'PUT' : 'POST';
    const body = { nome: pendenciaNomeInput.value, tipo_pendencia: pendenciaTipoInput.value };
    try {
        await apiFetch(url, { method, body: JSON.stringify(body) });
        alert(`Motivo ${id ? 'atualizado' : 'criado'}!`);
        resetFormPendencia();
        carregarMotivosPendencia();
    } catch (error) { alert(`Erro: ${error.message}`); }
});

function editarMotivoPendencia(pendencia) {
    pendenciaIdInput.value = pendencia.id;
    pendenciaNomeInput.value = pendencia.nome;
    pendenciaTipoInput.value = pendencia.tipo_pendencia;
    window.scrollTo(0, 0);
}

async function excluirMotivoPendencia(id) {
    if (!confirm('Tem certeza?')) return;
    try {
        await apiFetch(`/crm/motivos-pendencia/${id}/`, { method: 'DELETE' });
        alert('Motivo excluído!');
        carregarMotivosPendencia();
    } catch (error) { alert(`Erro: ${error.message}`); }
}

const formRegraComissao = document.getElementById('form-regra-comissao');
const regraComissaoIdInput = document.getElementById('regra_comissao_id');
const regraConsultorSelect = document.getElementById('regra_consultor_id');
const regraPlanoSelect = document.getElementById('regra_plano_id');
const listaRegrasComissaoBody = document.getElementById('lista-regras-comissao');

async function carregarDadosParaRegrasComissao() {
    try {
        const [planos, consultores] = await Promise.all([
            apiFetch('/crm/planos/'),
            apiFetch('/usuarios/?is_active=true')
        ]);
        regraPlanoSelect.innerHTML = '<option value="">Selecione...</option>';
        planos.forEach(plano => regraPlanoSelect.add(new Option(plano.nome, plano.id)));
        regraConsultorSelect.innerHTML = '<option value="">Selecione...</option>';
        if (Array.isArray(consultores)) {
            consultores.forEach(user => {
                if (user && user.id && user.nome_completo) {
                    regraConsultorSelect.add(new Option(user.nome_completo, user.id));
                }
            });
        }
    } catch (error) { console.error('Erro ao carregar dados para as regras:', error); }
}

function resetFormRegraComissao() {
    formRegraComissao.reset();
    regraComissaoIdInput.value = '';
}

async function carregarRegrasComissao() {
    try {
        const regras = await apiFetch('/crm/regras-comissao/');
        listaRegrasComissaoBody.innerHTML = '';
        regras.forEach(regra => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${regra.consultor_nome}</td>
                <td>${regra.plano_nome}</td>
                <td>${regra.tipo_venda}</td>
                <td>${regra.tipo_cliente}</td>
                <td>R$ ${regra.valor_base}</td>
                <td>R$ ${regra.valor_acelerado}</td>
                <td class="actions-cell">
                    <button class="btn btn-warning btn-sm" onclick='editarRegraComissao(${JSON.stringify(regra)})'><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-danger btn-sm" onclick="excluirRegraComissao(${regra.id})"><i class="bi bi-trash"></i></button>
                </td>
            `;
            listaRegrasComissaoBody.appendChild(tr);
        });
    } catch (error) { console.error('Erro ao carregar regras de comissão:', error); }
}

function editarRegraComissao(regra) {
    regraComissaoIdInput.value = regra.id;
    document.getElementById('regra_consultor_id').value = regra.consultor;
    document.getElementById('regra_plano_id').value = regra.plano;
    document.getElementById('regra_tipo_venda').value = regra.tipo_venda;
    document.getElementById('regra_tipo_cliente').value = regra.tipo_cliente;
    document.getElementById('regra_valor_base').value = regra.valor_base;
    document.getElementById('regra_valor_acelerado').value = regra.valor_acelerado;
    window.scrollTo(0, 0);
}

async function excluirRegraComissao(id) {
    if (!confirm('Tem certeza?')) return;
    try {
        await apiFetch(`/crm/regras-comissao/${id}/`, { method: 'DELETE' });
        alert('Regra excluída!');
        await carregarRegrasComissao();
    } catch (error) { alert(`Erro: ${error.message}`); }
}

formRegraComissao.addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = regraComissaoIdInput.value;
    const url = id ? `/crm/regras-comissao/${id}/` : '/crm/regras-comissao/';
    const method = id ? 'PUT' : 'POST';
    const body = {
        consultor: document.getElementById('regra_consultor_id').value,
        plano: document.getElementById('regra_plano_id').value,
        tipo_venda: document.getElementById('regra_tipo_venda').value,
        tipo_cliente: document.getElementById('regra_tipo_cliente').value,
        valor_base: document.getElementById('regra_valor_base').value,
        valor_acelerado: document.getElementById('regra_valor_acelerado').value,
    };
    try {
        await apiFetch(url, { method, body: JSON.stringify(body) });
        alert(`Regra ${id ? 'atualizada' : 'salva'}!`);
        resetFormRegraComissao();
        await carregarRegrasComissao();
    } catch (error) { alert(`Erro: ${error.message}`); }
});

// --- FUNÇÃO DE LOGOUT ---
function logout() {
    localStorage.removeItem('accessToken');
    localStorage.removeItem('refreshToken');
    localStorage.removeItem('userProfile');
    window.location.href = '/';
}

// --- INICIALIZAÇÃO DA PÁGINA ---
document.addEventListener('DOMContentLoaded', () => {
    carregarDadosParaFormulario();
    carregarPerfis();
    carregarMotivos();
    carregarFeriados();
    carregarOperadoras();
    carregarPlanos();
    carregarFormasPagamento();
    carregarStatus();
    carregarMotivosPendencia();
    carregarDadosParaRegrasComissao();
    carregarRegrasComissao();
    
    const primeiroLink = document.querySelector('#nav-cadastros .dropdown-item');
    if (primeiroLink) {
        mostrarSecao(null, 'usuarios', primeiroLink);
    }
});
</script>

</body>
</html>